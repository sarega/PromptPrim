import"./main-CPbb61xa.js";import{c as Gn,j as l,R as ae,a as E,b as Vn}from"./vendor-react-DYP_L7Xo.js";import{s as c,g as Le,d as re,a as x,c as en,b as X,e as he,S as ie,f as ce,u as mt,t as pt,h as T,i as H,n as gt,j as de,k as ne,l as W,D as Wn,m as Jn,o as Yn,p as Be,q as Xn,r as Qn,v as ft,w as tn,x as Zn,y as je,z as es,A as ts,B as ns,C as qe,E as ss,M as nn,F as ht,G as os,H as as,I as wt,J as rs,K as is,L as ls,N as yt,O as sn,P as cs,Q as ds,R as us,T as ms,U as ps,V as gs,W as fs,X as hs,Y as ws,Z as ys,_ as bs,$ as vs,a0 as xs,a1 as Ss,a2 as Is,a3 as Es,a4 as ks,a5 as js,a6 as As,a7 as Cs,a8 as Ps,a9 as Ns,aa as Ms,ab as Lt,ac as Ls,ad as _s,ae as Ts}from"./core.theme-B5LETkhY.js";import{E as on,M as Fs,m as bt,N as an,u as $s,i as Bs,a as Rs,b as Us,c as Ds,T as Os,C as qs,d as Hs}from"./vendor-tiptap-CPme1Ba3.js";import{i as zs,P as Ks,d as Gs}from"./vendor-CCcEUMUj.js";import{S as Vs}from"./vendor-sortable-j3KvE6KT.js";const Pe={temperature:{label:"Temperature",provider:"all",type:"range",min:0,max:2,step:.01,default:1,tooltip:"Controls randomness. Higher is more creative."},top_p:{label:"Top P",provider:"all",type:"range",min:0,max:1,step:.01,default:1,tooltip:"Controls diversity via nucleus sampling."},top_k:{label:"Top K",provider:"all",type:"range",min:0,max:100,step:1,default:0,tooltip:"Limits sampling to the K most likely tokens."},max_tokens:{label:"Max Tokens",provider:"all",type:"range",min:1,max:32768,step:1,default:4096,tooltip:"The maximum number of tokens to generate."},frequency_penalty:{label:"Frequency Penalty",provider:"all",type:"range",min:-2,max:2,step:.01,default:0,tooltip:"Reduces the likelihood of repeating the same lines."},presence_penalty:{label:"Presence Penalty",provider:"all",type:"range",min:-2,max:2,step:.01,default:0,tooltip:"Reduces the likelihood of repeating existing topics."},seed:{label:"Seed",provider:"all",type:"number",default:-1,tooltip:"Use -1 for random output, or a specific number for deterministic output."},stop_sequences:{label:"Stop Sequences",provider:"all",type:"text",default:"",tooltip:"Comma-separated list of sequences to stop generation."},logit_bias:{label:"Logit Bias",provider:"openrouter",type:"textarea",default:"",tooltip:'Advanced: Enter "token:bias" pairs (e.g., "123:-1, 456:1.5").'},mirostat:{label:"Mirostat",provider:"ollama",type:"select",options:[0,1,2],default:0,tooltip:"Enables Mirostat sampling (0 = disabled, 1 = v1, 2 = v2)."},mirostat_tau:{label:"Mirostat Tau",provider:"ollama",type:"range",min:0,max:10,step:.1,default:5,tooltip:"Controls the balance between coherence and diversity for Mirostat."},mirostat_eta:{label:"Mirostat Eta",provider:"ollama",type:"range",min:0,max:1,step:.01,default:.1,tooltip:"Controls the learning rate for Mirostat."},repeat_penalty:{label:"Repeat Penalty",provider:"ollama",type:"range",min:0,max:2,step:.01,default:1.1,tooltip:"Strongly penalizes repeating tokens. A higher value reduces repetition more."}};function Ws(e,t,n){const o=n===void 0||n===""||n===null||n===t.default,s=o?"Default":n,a=o?"param-value":"param-value custom";let r="";const i=n==null||n===""?t.default:n;switch(t.type){case"range":r=`
                <input type="range" class="param-slider" data-control="slider"
                       min="${t.min}" max="${t.max}" 
                       step="${t.step}" value="${i}">
                <input type="number" class="param-input" data-control="input"
                       min="${t.min}" max="${t.max}" 
                       step="${t.step}" value="${i}">
                <button type="button" class="btn-link param-reset-btn" data-action="reset">Reset</button>
            `;break;case"number":r=`<input type="number" class="param-input-full" data-control="input" value="${i}" placeholder="${t.default}">`;break;case"text":r=`<input type="text" class="param-input-full" data-control="input" value="${i}" placeholder="${t.default}">`;break;case"textarea":r=`<textarea class="param-input-full" data-control="input" rows="3">${i}</textarea>`;break;case"select":r=`<select class="param-input-full" data-control="input">${t.options.map(u=>`<option value="${u}" ${u==i?"selected":""}>${u}</option>`).join("")}</select>`;break}return`
        <div class="param-wrapper" data-param-name="${e}">
            <div class="param-row" data-action="toggle">
                <span class="param-label" title="${t.tooltip}">${t.label}</span>
                <span class="${a}">${s}</span>
            </div>
            <div class="param-control hidden">
                ${r}
            </div>
        </div>
    `}function rn(e,t,n){if(!e)return null;let o="<h4>Core Parameters</h4>",s='<div id="ollama-section"><h4>Advanced (Ollama only)</h4>',a=!1;for(const u in Pe){const m=Pe[u],f=t?t[u]:void 0;if(m.provider==="all"||m.provider===n){const g=Ws(u,m,f);m.provider==="ollama"?(s+=g,a=!0):o+=g}}console.log("Generated Core HTML:",o),console.log("Generated Ollama HTML:",s),s+="</div>",e.innerHTML=o+s;const r=e.querySelector("#ollama-section");r&&(r.style.display=n==="ollama"&&a?"block":"none");const i=u=>{const m=u.target.closest("[data-action]");if(!m)return;const f=m.closest(".param-wrapper");if(f){if(m.dataset.action==="toggle"){const g=f.querySelector(".param-control"),p=g.classList.contains("hidden");e.querySelectorAll(".param-control:not(.hidden)").forEach(h=>h.classList.add("hidden")),p&&g.classList.remove("hidden")}else if(m.dataset.action==="reset"){const g=f.dataset.paramName,p=Pe[g];f.querySelector(".param-value").textContent="Default",f.querySelector(".param-value").classList.remove("custom"),f.querySelectorAll("input, select, textarea").forEach(h=>h.value=p.default)}}},d=u=>{const m=u.target.closest("[data-control]");if(!m)return;const f=m.closest(".param-wrapper");if(!f)return;const g=f.querySelector(".param-value"),p=f.querySelector(".param-slider"),h=f.querySelector(".param-input");p&&h&&(m.dataset.control==="slider"?h.value=u.target.value:p.value=u.target.value),g.textContent=u.target.value,g.classList.add("custom")};return e.addEventListener("click",i),e.addEventListener("input",d),{getValues:()=>{const u={};return e.querySelectorAll(".param-wrapper").forEach(m=>{const f=m.dataset.paramName;if(m.querySelector(".param-value.custom")){const g=m.querySelector('[data-control="input"], .param-input-full');if(g){const p=Pe[f];u[f]=p.type==="range"||p.type==="number"?parseFloat(g.value):g.value}}}),u},destroy:()=>{e.removeEventListener("click",i),e.removeEventListener("input",d),e.innerHTML=""}}}const Ne={},ue={mount(e,t,n){if(!n)return;const o=n.id;if(!o){console.error("ReactBridge Error: Target element must have an ID.");return}let s=Ne[o];s||(s=Gn.createRoot(n),Ne[o]=s),s.render(l.jsx(ae.StrictMode,{children:l.jsx(e,{...t,unmount:()=>this.unmount(n)})}))},unmount(e){if(!e||!e.id)return;const t=Ne[e.id];t&&(t.unmount(),delete Ne[e.id])}},tt="summary-modal-container";let ln=null;function Js(e){const t=document.createElement("div");return t.className="item summary-log-item",t.dataset.logId=e.id,e.id===ln&&t.classList.add("active"),t.innerHTML=`<span class="item-name"><span class="item-icon">ðŸ’¡</span> ${e.summary}</span>`,t.title=`Created: ${new Date(e.timestamp).toLocaleString()}`,t}function Ys(e){const t=document.getElementById("summary-editor-actions"),n=document.getElementById("summarize-conversation-btn");!t||!n||(t.classList.remove("hidden"),n.classList.add("hidden"),t.querySelector("#summary-editor-delete-btn").style.display="inline-flex",t.querySelector("#summary-editor-load-btn").style.display="inline-flex",t.querySelector("#summary-editor-save-btn").textContent="Save Changes")}function cn(e){ln=e;const n=c.getProject().summaryLogs.find(o=>o.id===e);document.getElementById("summary-editor-title").value=n?n.summary:"",document.getElementById("summary-editor-content").value=n?n.content:"",n?Ys():(document.getElementById("summary-editor-actions").classList.add("hidden"),document.getElementById("summarize-conversation-btn").classList.remove("hidden")),dn()}function dn(){const e=document.getElementById("summary-log-list-modal");if(!e)return;const t=c.getProject();e.innerHTML="";const n=t.summaryLogs||[];if(n.length===0){e.innerHTML='<p class="no-items-message">No summaries yet.</p>';return}const o=n.reduce((s,a)=>{const r=a.sourceSessionId,i=t.chatSessions.find(d=>d.id===r);return s[r]||(s[r]={name:i?i.name:"Unknown Session",logs:[]}),s[r].logs.push(a),s},{});Object.values(o).forEach(s=>{const a=s.logs.sort((i,d)=>d.timestamp-i.timestamp),r=document.createElement("details");r.open=!0,r.innerHTML=`<summary>For: ${s.name}</summary>`,a.forEach(i=>r.appendChild(Js(i))),e.appendChild(r)})}function Xs(){let e=document.getElementById(tt);return e||(e=document.createElement("div"),e.id=tt,document.body.appendChild(e)),e}function Qs(){const e=document.getElementById(tt);e&&(ue.unmount(e),e.remove())}function _t(){console.log("ðŸ“ showSummarizationCenter called");const e=c.getProject(),t=e.chatSessions.find(s=>s.id===e.activeSessionId);if(!t)return;const n=Xs(),o={summaryLogs:e.summaryLogs||[],allModels:Le(),promptTemplates:{...re,...e.globalSettings.summarizationPromptPresets},currentSessionName:t.name,systemUtilityModel:e.globalSettings.systemUtilityAgent?.model,activeTemplate:e.globalSettings.activeSummarizationPreset,defaultPresets:re,onApplySettings:s=>{io(s),nt()},unmount:nt};ue.mount(uo,o,n),n.style.display="block"}function nt(){console.log("ðŸ“ hideSummarizationCenter called"),Qs()}function Zs(){console.log("âœ… Summary UI Initialized (Listeners are in app.js)")}async function un({modelId:e,promptTemplate:t}){const n=c.getProject(),o=n.chatSessions.find(u=>u.id===n.activeSessionId);if(!o)throw new Error("Active session not found.");if(!e)throw x("Please select a model for summarization in the Settings tab.","Error"),new Error("Model for summarization not selected.");const s={...n.globalSettings.systemUtilityAgent,model:e},a=o.history.filter(u=>u.role==="user"||u.role==="assistant");if(a.length<2)throw x("Not enough new messages to summarize.","Info"),new Error("Not enough messages.");const r=a.map(u=>`${u.speaker||u.role}: ${Array.isArray(u.content)?u.content.find(m=>m.type==="text")?.text||"[multimodal content]":u.content}`).join(`
`),i=t.replace(/\$\{previousSummary\}/g,"This is a full-history summary from the beginning.").replace(/\$\{newMessages\}/g,r),d=await en(s,[{role:"user",content:i}]);if(!d||typeof d.content!="string")throw new Error("Received an invalid or empty response from the AI summarizer.");return{title:`Summary of "${o.name}" at ${new Date().toLocaleTimeString()}`,content:d.content}}function eo({title:e,content:t}){const n=c.getProject(),o=n.chatSessions.find(a=>a.id===n.activeSessionId);if(!n||!o||!e||!t)return;const s={id:`sum_${Date.now()}`,summary:e,content:t,timestamp:Date.now(),sourceSessionId:o.id};n.summaryLogs||(n.summaryLogs=[]),n.summaryLogs.push(s),c.updateAndPersistState(),x("New summary log saved!","Success"),c.bus.publish("summary:listChanged",{newlyCreatedId:s.id})}function to({logId:e,title:t,content:n}){if(!e||!t||!n)return;const s=c.getProject().summaryLogs.find(a=>a.id===e);s&&(s.summary=t,s.content=n,c.updateAndPersistState(),x("Changes saved!","Success"),dn())}function no({logId:e}){if(!confirm("Are you sure you want to delete this summary log?"))return;const t=c.getProject();t.summaryLogs=t.summaryLogs.filter(n=>n.id!==e),t.chatSessions.forEach(n=>{n.summaryState?.activeSummaryId===e&&(n.summaryState.activeSummaryId=null)}),c.updateAndPersistState(),x("Log deleted.","Success"),cn(null)}function so({logId:e}){const t=c.getProject(),n=t.chatSessions.find(a=>a.id===t.activeSessionId),o=t.summaryLogs.find(a=>a.id===e);if(!n||!o)return;n.summaryState={activeSummaryId:o.id};const s={role:"system",content:`[System: Context loaded from summary: "${o.summary}"]`,isSummary:!0};n.history.push(s),c.updateAndPersistState(),c.bus.publish("ui:renderMessages"),nt(),x("Summary loaded into context!","Success")}async function oo({saveAs:e,presetName:t,content:n}){const o=n.trim();if(!o){x("Preset content cannot be empty.","Error");return}let s=t;const a=c.getProject(),r=re.hasOwnProperty(s);if(e||r||!s){const i=prompt("Enter a name for this new preset:",r?`${s} (Copy)`:"My Custom Preset");if(!i||!i.trim())return;s=i.trim()}a.globalSettings.summarizationPromptPresets[s]&&s!==t&&!confirm(`A preset named '${s}' already exists. Overwrite?`)||(a.globalSettings.summarizationPromptPresets[s]=o,a.globalSettings.activeSummarizationPreset=s,c.setProject(a),await c.updateAndPersistState(),c.bus.publish("summary:presetsChanged",{newSelectedName:s}),x(`Preset '${s}' saved!`,"Success"))}async function ao({presetName:e}){if(re.hasOwnProperty(e)||e==="custom")return;const t=prompt(`Enter new name for "${e}":`,e);if(!t||!t.trim()||t.trim()===e)return;const n=c.getProject(),o=t.trim();if(n.globalSettings.summarizationPromptPresets[o]){x(`A preset named '${o}' already exists.`,"Error");return}n.globalSettings.summarizationPromptPresets[o]=n.globalSettings.summarizationPromptPresets[e],delete n.globalSettings.summarizationPromptPresets[e],n.globalSettings.activeSummarizationPreset=o,c.setProject(n),await c.updateAndPersistState(),c.bus.publish("summary:presetsChanged"),x(`Preset renamed to '${o}'!`,"Success")}async function ro({presetName:e}){if(!re.hasOwnProperty(e)&&confirm(`Delete user preset "${e}"?`)){const t=c.getProject();delete t.globalSettings.summarizationPromptPresets[e],t.globalSettings.activeSummarizationPreset===e&&(t.globalSettings.activeSummarizationPreset="Standard"),c.setProject(t),await c.updateAndPersistState(),c.bus.publish("summary:presetsChanged"),x(`Preset '${e}' deleted.`,"Success")}}function io({model:e,templateName:t}){const n=c.getProject();!n||!n.globalSettings||(e&&n.globalSettings.systemUtilityAgent&&(n.globalSettings.systemUtilityAgent.model=e),n.globalSettings.activeSummarizationPreset=t,c.setProject(n),c.updateAndPersistState(),x("Settings Applied!","Success"))}const lo=E.memo(({selectedLog:e,currentSessionName:t,isGenerating:n,onGenerate:o,editorTitle:s,setEditorTitle:a,editorContent:r,setEditorContent:i})=>l.jsxs(l.Fragment,{children:[l.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[l.jsx("h4",{children:e?"Edit Summary":`Generate new summary for "${t}"`}),!e&&l.jsx("button",{className:`btn ${n?"is-loading":""}`,onClick:o,disabled:n,children:"âœ¨ Generate New Summary"})]}),l.jsxs("div",{className:"form-group",style:{flexGrow:1,display:"flex",flexDirection:"column"},children:[l.jsx("label",{children:"Summary Title"}),l.jsx("input",{type:"text",value:s,onChange:d=>a(d.target.value),placeholder:"A concise title..."}),l.jsx("label",{style:{marginTop:"10px"},children:"Summary Content (Editable)"}),l.jsx("textarea",{style:{flexGrow:1,resize:"none"},value:r,onChange:d=>i(d.target.value)})]})]})),co=E.memo(({selectedModel:e,setSelectedModel:t,allModels:n=[],selectedTemplateName:o,handleTemplateChange:s,promptTemplates:a={},templateContent:r,setTemplateContent:i,defaultPresets:d={},handleActionClick:u})=>{const m=(p,h)=>Object.prototype.hasOwnProperty.call(p||{},h),f=Object.keys(a).filter(p=>m(d,p)).sort(),g=Object.keys(a).filter(p=>!m(d,p)).sort();return l.jsxs(l.Fragment,{children:[l.jsx("h4",{children:"Settings"}),l.jsxs("div",{className:"form-group",children:[l.jsx("label",{children:"Summarization Model"}),l.jsxs("select",{value:e,onChange:p=>t(p.target.value),children:[l.jsx("option",{value:"",children:"-- Select a Model --"}),n.map(p=>l.jsx("option",{value:p.id,children:p.name},p.id))]})]}),l.jsxs("div",{className:"form-group",style:{flexGrow:1,display:"flex",flexDirection:"column"},children:[l.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center",marginBottom:"10px"},children:[l.jsx("label",{style:{flexGrow:1,marginBottom:0},children:"Summarization Prompt Template"}),l.jsxs("div",{className:"dropdown align-right",children:[l.jsx("button",{className:"btn btn-small btn-secondary",onClick:p=>p.currentTarget.parentElement.classList.toggle("open"),children:"Actions â–¾"}),l.jsx("div",{className:"dropdown-content",children:o&&!m(d,o)?l.jsxs(l.Fragment,{children:[l.jsx("a",{href:"#",onClick:p=>{p.preventDefault(),u("settings:saveSummaryPreset",{saveAs:!1,presetName:o,content:r})},children:"Save Changes"}),l.jsx("a",{href:"#",onClick:p=>{p.preventDefault(),u("settings:renameSummaryPreset",{presetName:o})},children:"Rename..."}),l.jsx("a",{href:"#",onClick:p=>{p.preventDefault(),u("settings:saveSummaryPreset",{saveAs:!0,content:r})},children:"Save as New Preset..."}),l.jsx("div",{className:"dropdown-divider"}),l.jsx("a",{href:"#",className:"is-destructive",onClick:p=>{p.preventDefault(),u("settings:deleteSummaryPreset",{presetName:o})},children:"Delete Preset"})]}):l.jsx("a",{href:"#",onClick:p=>{p.preventDefault(),u("settings:saveSummaryPreset",{saveAs:!0,content:r})},children:"Save as New Preset..."})})]})]}),l.jsxs("select",{value:o,onChange:s,children:[l.jsx("optgroup",{label:"Factory Presets (Read-only)",children:f.map(p=>l.jsx("option",{value:p,children:p},p))}),g.length>0&&l.jsx("optgroup",{label:"User Presets",children:g.map(p=>l.jsx("option",{value:p,children:p},p))})]}),l.jsx("textarea",{style:{flexGrow:1,resize:"none",marginTop:"10px"},value:r,onChange:p=>i(p.target.value)})]})]})});function uo({unmount:e,summaryLogs:t=[],allModels:n=[],promptTemplates:o={},currentSessionName:s="",systemUtilityModel:a="",activeTemplate:r="Standard",defaultPresets:i={},onApplySettings:d=()=>{}}){const[u,m]=E.useState("logs"),[f,g]=E.useState(null),[p,h]=E.useState(""),[k,j]=E.useState(""),[w,y]=E.useState(""),[b,_]=E.useState(a||""),[S,M]=E.useState(o),[A,v]=E.useState(r||"Standard"),[C,N]=E.useState(o[r||"Standard"]||""),[$,O]=E.useState(!1);E.useEffect(()=>{f?(j(f.summary),y(f.content)):(j(""),y(""))},[f]),E.useEffect(()=>{const B=()=>{const L=c.getProject(),F={...re,...L.globalSettings.summarizationPromptPresets},U=L.globalSettings.activeSummarizationPreset||"Standard";M(F),v(U)},D=({newlyCreatedId:L})=>{if(L){const F=c.getProject().summaryLogs.find(U=>U.id===L);F&&g(F)}},P=c.bus.subscribe("summary:presetsChanged",B),I=c.bus.subscribe("summary:listChanged",D);return()=>{P(),I()}},[]),E.useEffect(()=>{N(S[A]||"")},[A,S]);const Q=E.useMemo(()=>p?t.filter(B=>B.summary.toLowerCase().includes(p.toLowerCase())):t,[p,t]),ye=B=>{g(B),m("logs")},be=async()=>{O(!0),g(null);try{const B=await un({modelId:b,promptTemplate:C});j(B.title),y(B.content),g({id:"new_log",summary:B.title,content:B.content})}catch(B){console.error("Summary generation failed:",B)}finally{O(!1)}},se=(B,D)=>{c.bus.publish(B,D)},z=B=>{v(B.target.value)};return l.jsx("div",{id:"summarization-modal",className:"modal-overlay","data-owner":"summary",style:{display:"flex"},children:l.jsxs("div",{className:"modal-box is-resizable",children:[l.jsxs("div",{className:"modal-header",children:[l.jsx("h3",{children:"Conversation Summary Center"}),l.jsx("button",{className:"btn-icon",title:"Settings",onClick:()=>m(u==="logs"?"settings":"logs"),children:l.jsx("span",{className:"material-symbols-outlined",children:u==="settings"?"article":"settings"})}),l.jsx("button",{className:"modal-close-btn",onClick:e,children:"Ã—"})]}),l.jsxs("div",{className:"modal-body",children:[l.jsxs("div",{className:"log-list-column",children:[l.jsx("input",{type:"text",placeholder:"Search summaries...",value:p,onChange:B=>h(B.target.value),style:{marginBottom:"15px"}}),l.jsx("div",{id:"summary-log-list-modal",className:"item-list",children:Q.map(B=>l.jsx("div",{className:`item summary-log-item ${f?.id===B.id?"active":""}`,onClick:()=>ye(B),children:l.jsxs("span",{className:"item-name",children:[l.jsx("span",{className:"item-icon",children:"ðŸ’¡"})," ",B.summary]})},B.id))})]}),l.jsx("div",{className:"log-editor-column",children:u==="logs"?l.jsx(lo,{selectedLog:f,currentSessionName:s,isGenerating:$,onGenerate:be,editorTitle:k,setEditorTitle:j,editorContent:w,setEditorContent:y}):l.jsx(co,{selectedModel:b,setSelectedModel:_,allModels:n,selectedTemplateName:A,handleTemplateChange:z,promptTemplates:S,templateContent:C,setTemplateContent:N,defaultPresets:i,handleActionClick:se})})]}),l.jsxs("div",{className:"modal-actions",children:[l.jsx("button",{className:"btn btn-secondary",onClick:e,children:"Close"}),u==="logs"&&f&&l.jsxs(l.Fragment,{children:[f.id!=="new_log"&&l.jsx("button",{className:"btn btn-danger",onClick:()=>se("summary:deleteLog",{logId:f.id}),children:"Delete Log"}),f.id!=="new_log"&&l.jsx("button",{className:"btn",onClick:()=>se("summary:loadToContext",{logId:f.id}),children:"Load to Context"}),l.jsx("button",{className:"btn",onClick:()=>se(f.id==="new_log"?"summary:saveNewLog":"summary:saveEdit",{logId:f.id,title:k,content:w}),children:f.id==="new_log"?"Save New Log":"Save Changes"})]}),u==="settings"&&l.jsx("button",{className:"btn",onClick:()=>d({model:b,templateName:A}),children:"Apply Settings"})]})]})})}const mo="https://api.kie.ai/api/v1/jobs/createTask",mn="https://api.kie.ai/api/v1/jobs/recordInfo",po="https://kieai.redpandaai.co/api/file-stream-upload";async function st(e,t="user-uploads",n=null){const o=X();if(!o)throw new Error("Kie.ai API Key is missing. Please check your Settings.");if(!(e instanceof File))throw new Error("Invalid file object provided to uploadFileStream.");const s=new FormData;s.append("file",e),t&&s.append("uploadPath",t),n&&s.append("fileName",n);const a={Authorization:`Bearer ${o}`},r=await fetch(po,{method:"POST",headers:a,body:s});let i;try{i=await r.json()}catch{throw new Error("Failed to parse upload response.")}if(!r.ok||!i||!i.success){const m=i?.msg||i?.message||`HTTP ${r.status} during file upload`;throw new Error(m)}const d=i.data||{},u=d.fileUrl||d.downloadUrl;if(!u)throw new Error("Upload succeeded but no file URL was returned by the API.");return u}const vt=5;function pn({durationSec:e=5,resolution:t="720p"}={}){let n=1;t==="1080p"?n=1.8:t==="4k"&&(n=3);const o=Math.max(180,e*18*n);return Math.ceil(o/vt)}async function ot(e){const t=await e.text();try{return JSON.parse(t)}catch{throw console.error("Non-JSON API Response (HTML/Error Page):",t),new Error(`Invalid API Response: Server returned non-JSON data (Status ${e.status}). Check API Key/Endpoint.`)}}async function Tt(e,t,n=()=>{},o={}){const{taskContext:s={}}=o,a=X();if(!a)throw new Error("Kie.ai API Key is missing. Please check your Settings.");const r={Authorization:`Bearer ${a}`,"Content-Type":"application/json"},i={model:e,input:t};n("Submitting task...");let d=await fetch(mo,{method:"POST",headers:r,body:JSON.stringify(i)});const u=await ot(d);if(!d.ok||u.code!==200)throw new Error(`Submission Failed (${d.status}): ${u.msg||u.message||"Check parameters."}`);const m=u.data?.taskId;if(!m)throw new Error("Invalid response: Task ID is missing.");n(`Task submitted: ${m}. Waiting...`),c.bus.publish("kieai:progress",{taskId:m,status:"submitted",progress:0,message:"Queued"});let f=0;const g=pn({durationSec:Number(s.durationSec)||Number(t.duration)||5,resolution:String(s.resolution||t.resolution)||"720p"});for(;f<g;){const p=Math.min(vt*Math.max(1,Math.ceil(f/6)+1),15);await new Promise(y=>setTimeout(y,p*1e3)),f++;const h=`${mn}?taskId=${encodeURIComponent(m)}`;let k;try{k=await fetch(h,{headers:r})}catch{c.bus.publish("kieai:progress",{taskId:m,status:"network-retry",progress:null,attempt:f,max:g,message:"Network hiccup, retrying..."});continue}const j=await ot(k);if(!k.ok||j.code!==200)throw new Error(`Polling API Error (${k.status}): ${j.msg||"Check Key/Balance."}`);const w=j.data?.state;if(w==="success"){c.bus.publish("kieai:progress",{taskId:m,status:"success",progress:100,attempt:f,max:g,message:"Done"});let y={};try{y=JSON.parse(j.data.resultJson)}catch(b){console.warn("Could not parse resultJson",b)}return{url:y.resultUrls?.[0],resultJson:y,taskId:m}}else{if(w==="fail")throw new Error(`Kie.ai Task Failed: ${j.data.failMsg||"Generation failed."}`);{const y=Number(j.data?.percent??j.data?.progress??NaN),b=isFinite(y)?Math.max(0,Math.min(100,y)):Math.round(f/g*95);c.bus.publish("kieai:progress",{taskId:m,status:w,progress:b,attempt:f,max:g,message:`Status: ${w}`}),n(`Status: ${w} (${f}/${g})`)}}}throw new Error("Kie.ai Polling Timed Out.")}async function go(e,t={},n=()=>{}){const o=X();if(!o)throw new Error("Kie.ai API Key is missing. Please check your Settings.");const s={Authorization:`Bearer ${o}`,"Content-Type":"application/json"};let a=0;const r=pn({durationSec:Number(t.durationSec)||5,resolution:String(t.resolution||"720p")});for(c.bus.publish("kieai:progress",{taskId:e,status:"resuming",progress:null,attempt:0,max:r,message:"Resuming task..."});a<r;){await new Promise(f=>setTimeout(f,vt*1e3)),a++;const i=`${mn}?taskId=${encodeURIComponent(e)}`;let d;try{d=await fetch(i,{headers:s})}catch{c.bus.publish("kieai:progress",{taskId:e,status:"network-retry",progress:null,attempt:a,max:r,message:"Network hiccup, retrying..."});continue}const u=await ot(d);if(!d.ok||u.code!==200)throw new Error(`Polling API Error (${d.status}): ${u.msg||"Check Key/Balance."}`);const m=u.data?.state;if(m==="success"){c.bus.publish("kieai:progress",{taskId:e,status:"success",progress:100,attempt:a,max:r,message:"Done"});let f={};try{f=JSON.parse(u.data.resultJson)}catch(g){console.warn("Could not parse resultJson",g)}return{url:f.resultUrls?.[0],resultJson:f,taskId:e}}if(m==="fail")throw new Error(u.data?.failMsg||"Generation failed");c.bus.publish("kieai:progress",{taskId:e,status:m,progress:null,attempt:a,max:r,message:`Status: ${m}`})}throw new Error("Resume polling timed out")}const fo="https://api.kie.ai/api/v1/generate",ho="https://api.kie.ai/api/v1/generate/record-info",wo="https://api.kie.ai/api/v1/wav/generate",yo="https://api.kie.ai/api/v1/wav/record-info",bo="https://api.kie.ai/api/v1/vocal-removal/generate",vo="https://api.kie.ai/api/v1/vocal-removal/record-info",xo="https://api.kie.ai/api/v1/midi/generate",So="https://api.kie.ai/api/v1/midi/record-info";async function le(e){const t=await e.text();try{return JSON.parse(t)}catch{throw new Error(`Invalid JSON from API (status ${e.status})`)}}async function Io(e,t=()=>{},n={}){const o=X();if(!o)throw new Error("Kie.ai API Key is missing. Please check your Settings.");const s={Authorization:`Bearer ${o}`,"Content-Type":"application/json"};t("Submitting music task...");let a;try{a=await fetch(fo,{method:"POST",headers:s,body:JSON.stringify(e)})}catch{throw new Error("Network error during submission")}const r=await le(a);if(!a.ok||r.code!==200){const f=r?.msg||r?.message||`HTTP ${a.status}`;throw new Error(`Music submission failed: ${f}`)}const i=r.data?.taskId;if(!i)throw new Error("Invalid submission response: missing taskId");t(`Task submitted: ${i}. Waiting...`),c.bus.publish("kieai:progress",{taskId:i,status:"submitted",progress:0,message:"Queued"});const d=1e4,u=60;let m=0;for(;m<u;){await new Promise(h=>setTimeout(h,d)),m++;let f;try{f=await fetch(`${ho}?taskId=${encodeURIComponent(i)}`,{method:"GET",headers:s})}catch{c.bus.publish("kieai:progress",{taskId:i,status:"network-retry",progress:null,attempt:m,max:u,message:"Network hiccup, retrying..."});continue}const g=await le(f);if(!f.ok||g.code!==200){const h=g?.msg||g?.message||`HTTP ${f.status}`;throw new Error(`Music polling error: ${h}`)}const p=g.data?.status;if(p==="SUCCESS"||p==="FIRST_SUCCESS"||p==="TEXT_SUCCESS"){c.bus.publish("kieai:progress",{taskId:i,status:"success",progress:100,attempt:m,max:u,message:"Done"});const k=(g.data?.response?.sunoData||[])[0]||{},j=k.audioUrl||k.streamAudioUrl||null;return{taskId:i,audioUrl:j,streamAudioUrl:k.streamAudioUrl||null,title:k.title,prompt:k.prompt,audioId:k.id}}if(p==="CREATE_TASK_FAILED"||p==="GENERATE_AUDIO_FAILED"||p==="CALLBACK_EXCEPTION"||p==="SENSITIVE_WORD_ERROR"){const h=g.data?.errorMessage||`Music generation failed (status: ${p})`;throw new Error(h)}c.bus.publish("kieai:progress",{taskId:i,status:p||"pending",progress:null,attempt:m,max:u,message:p||"Pending"})}throw new Error("Music generation timed out")}async function Eo(e,t,n="https://example.com/callback"){const o=X();if(!o)throw new Error("Kie.ai API Key is missing.");const s={Authorization:`Bearer ${o}`,"Content-Type":"application/json"},r=await fetch(wo,{method:"POST",headers:s,body:JSON.stringify({taskId:e,audioId:t,callBackUrl:n})}),i=await le(r);if(!r.ok||i.code!==200){const d=i?.msg||i?.message||`HTTP ${r.status}`;throw new Error(`WAV conversion submission failed: ${d}`)}return i.data?.taskId}async function ko(e,t=60,n=1e4){const o=X();if(!o)throw new Error("Kie.ai API Key is missing.");const s={Authorization:`Bearer ${o}`};let a=0;for(;a<t;){await new Promise(u=>setTimeout(u,n)),a++;const r=await fetch(`${yo}?taskId=${encodeURIComponent(e)}`,{method:"GET",headers:s}),i=await le(r);if(!r.ok||i.code!==200){const u=i?.msg||i?.message||`HTTP ${r.status}`;throw new Error(`WAV polling failed: ${u}`)}const d=i.data?.successFlag;if(d==="SUCCESS"||d===1||d==="1"){const u=i.data?.response?.audioWavUrl;if(!u)throw new Error("WAV conversion completed but URL missing");return u}if(typeof d=="string"&&d.startsWith("GENERATE_AUDIO_FAILED")||typeof d=="number"&&d>1)throw new Error("WAV conversion failed")}throw new Error("WAV conversion timed out")}async function jo(e,t,n="split_stem",o="https://example.com/callback"){const s=X();if(!s)throw new Error("Kie.ai API Key is missing.");const a={Authorization:`Bearer ${s}`,"Content-Type":"application/json"},i=await fetch(bo,{method:"POST",headers:a,body:JSON.stringify({taskId:e,audioId:t,type:n,callBackUrl:o})}),d=await le(i);if(!i.ok||d.code!==200){const u=d?.msg||d?.message||`HTTP ${i.status}`;throw new Error(`Vocal separation submission failed: ${u}`)}return d.data?.taskId}async function Ao(e,t=60,n=1e4){const o=X();if(!o)throw new Error("Kie.ai API Key is missing.");const s={Authorization:`Bearer ${o}`};let a=0;for(;a<t;){await new Promise(u=>setTimeout(u,n)),a++;const r=await fetch(`${vo}?taskId=${encodeURIComponent(e)}`,{method:"GET",headers:s}),i=await le(r);if(!r.ok||i.code!==200){const u=i?.msg||i?.message||`HTTP ${r.status}`;throw new Error(`Vocal separation polling failed: ${u}`)}const d=i.data?.successFlag;if(d==="SUCCESS"||d===1||d==="1")return i.data;if(typeof d=="string"&&(d.startsWith("CREATE_TASK_FAILED")||d.startsWith("GENERATE_AUDIO_FAILED"))||typeof d=="number"&&d>1)throw new Error("Vocal separation failed")}throw new Error("Vocal separation timed out")}async function Co(e,t="https://example.com/callback"){const n=X();if(!n)throw new Error("Kie.ai API Key is missing.");const o={Authorization:`Bearer ${n}`,"Content-Type":"application/json"},a=await fetch(xo,{method:"POST",headers:o,body:JSON.stringify({taskId:e,callBackUrl:t})}),r=await le(a);if(!a.ok||r.code!==200){const i=r?.msg||r?.message||`HTTP ${a.status}`;throw new Error(`MIDI generation submission failed: ${i}`)}return r.data?.taskId}async function Po(e,t=60,n=1e4){const o=X();if(!o)throw new Error("Kie.ai API Key is missing.");const s={Authorization:`Bearer ${o}`};let a=0;for(;a<t;){await new Promise(u=>setTimeout(u,n)),a++;const r=await fetch(`${So}?taskId=${encodeURIComponent(e)}`,{method:"GET",headers:s}),i=await le(r);if(!r.ok||i.code!==200){const u=i?.msg||i?.message||`HTTP ${r.status}`;throw new Error(`MIDI polling failed: ${u}`)}const d=i.data?.successFlag;if(d==="SUCCESS"||d===1||d==="1")return i.data?.midiData;if(typeof d=="string"&&(d.startsWith("CREATE_TASK_FAILED")||d.startsWith("GENERATE_AUDIO_FAILED"))||typeof d=="number"&&d>1)throw new Error("MIDI generation failed")}throw new Error("MIDI generation timed out")}const Re=[{id:"video/wan-2-6-text-to-video",name:"Wan 2.6 T2V",type:"video",modelApiId:"wan/2-6-text-to-video"},{id:"video/wan-2-6-image-to-video",name:"Wan 2.6 I2V",type:"video",modelApiId:"wan/2-6-image-to-video"},{id:"video/wan-2-6-video-to-video",name:"Wan 2.6 V2V",type:"video",modelApiId:"wan/2-6-video-to-video"},{id:"video/wan2.5-text-to-video",name:"WAN 2.5 T2V",type:"video",modelApiId:"wan/2-5-text-to-video"},{id:"video/wan2.5-image-to-video",name:"WAN 2.5 I2V",type:"video",modelApiId:"wan/2-5-image-to-video"},{id:"video/v1-pro-text-to-video",name:"Seedance V1 Pro T2V",type:"video",modelApiId:"bytedance/v1-pro-text-to-video"},{id:"video/v1-lite-text-to-video",name:"Seedance V1 Lite T2V",type:"video",modelApiId:"bytedance/v1-lite-text-to-video"},{id:"video/v1-pro-image-to-video",name:"Seedance V1 Pro I2V",type:"video",modelApiId:"bytedance/v1-pro-image-to-video"},{id:"video/v1-lite-image-to-video",name:"Seedance V1 Lite I2V",type:"video",modelApiId:"bytedance/v1-lite-image-to-video"},{id:"image/seedream4.0-text-to-image",name:"Seedream 4.0 T2I",type:"image",modelApiId:"bytedance/seedream-v4-text-to-image"},{id:"image/seedream4.5-text-to-image",name:"Seedream 4.5 T2I",type:"image",modelApiId:"seedream/4.5-text-to-image"},{id:"image/seedream4-edit",name:"Seedream V4 Edit",type:"image",modelApiId:"bytedance/seedream-v4-edit"},{id:"image/seedream4.5-edit",name:"Seedream 4.5 Edit",type:"image",modelApiId:"seedream/4.5-edit"},{id:"audio/suno-v3_5-text-to-music",name:"Suno V3.5 T2M",type:"audio",modelApiId:"suno/v3_5-text-to-music"},{id:"audio/suno-v4-text-to-music",name:"Suno V4 T2M",type:"audio",modelApiId:"suno/v4-text-to-music"},{id:"audio/suno-v4_5-text-to-music",name:"Suno V4.5 T2M",type:"audio",modelApiId:"suno/v4_5-text-to-music"},{id:"audio/suno-v4_5plus-text-to-music",name:"Suno V4.5+ T2M",type:"audio",modelApiId:"suno/v4_5plus-text-to-music"},{id:"audio/suno-v5-text-to-music",name:"Suno V5 T2M",type:"audio",modelApiId:"suno/v5-text-to-music"}],xt={"wan/2-6-text-to-video":{defaults:{duration:5,resolution:"1080p"},limits:{duration:[5,10,15],resolution:["720p","1080p"]}},"wan/2-6-image-to-video":{defaults:{duration:5,resolution:"1080p"},limits:{duration:[5,10,15],resolution:["720p","1080p"]},requires:["image_urls"]},"wan/2-6-video-to-video":{defaults:{duration:5,resolution:"1080p"},limits:{duration:[5,10],resolution:["720p","1080p"]},requires:["video_urls"]},"wan/2-5-text-to-video":{defaults:{duration:5,resolution:"720p",aspect_ratio:"16:9"},limits:{duration:[5,10],resolution:["720p","1080p"]}},"wan/2-5-image-to-video":{defaults:{duration:5,resolution:"720p"},limits:{duration:[5,10],resolution:["720p","1080p"]},requires:["image_url"]},"bytedance/v1-pro-text-to-video":{defaults:{duration:5,resolution:"1080p",camera_fixed:!1,enable_safety_checker:!0},limits:{duration:[5,10],resolution:["720p","1080p"]}},"bytedance/v1-lite-text-to-video":{defaults:{duration:5,resolution:"720p",camera_fixed:!0,enable_safety_checker:!0},limits:{duration:[5,10],resolution:["720p"]}},"bytedance/v1-pro-image-to-video":{defaults:{duration:5,resolution:"720p",camera_fixed:!1,enable_safety_checker:!0,seed:-1},limits:{duration:[5,10],resolution:["480p","720p","1080p"]},requires:["image_url"]},"bytedance/v1-lite-image-to-video":{defaults:{duration:5,resolution:"720p",camera_fixed:!1,enable_safety_checker:!0,seed:-1},limits:{duration:[5,10],resolution:["480p","720p","1080p"]},requires:["image_url"]},"bytedance/seedream-v4-text-to-image":{defaults:{image_size:"square_hd",image_resolution:"1K"},limits:{image_size:["square","square_hd","portrait_4_3","portrait_3_2","portrait_16_9","landscape_4_3","landscape_3_2","landscape_16_9","landscape_21_9"],image_resolution:["1K","2K","4K"]}},"seedream/4.5-text-to-image":{defaults:{aspect_ratio:"1:1",quality:"basic"},limits:{aspect_ratio:["1:1","4:3","3:4","16:9","9:16","2:3","3:2","21:9"],quality:["basic","high"]}},"bytedance/seedream-v4-edit":{defaults:{image_size:"square_hd",image_resolution:"1K",max_images:1},limits:{image_size:["square","square_hd","portrait_4_3","portrait_3_2","portrait_16_9","landscape_4_3","landscape_3_2","landscape_16_9","landscape_21_9"],image_resolution:["1K","2K","4K"],max_images:[1,2,3,4,5,6]},requires:["image_urls"]},"seedream/4.5-edit":{defaults:{aspect_ratio:"1:1",quality:"basic",max_images:1},limits:{aspect_ratio:["1:1","4:3","3:4","16:9","9:16","2:3","3:2","21:9"],quality:["basic","high"],max_images:[1,2,3,4,5,6,7,8,9,10,11,12,13,14]},requires:["image_urls"]},"suno/v3_5-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V3_5"},limits:{}},"suno/v4-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V4"},limits:{}},"suno/v4_5-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V4_5"},limits:{}},"suno/v4_5plus-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V4_5PLUS"},limits:{}},"suno/v5-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V5"},limits:{}}};function gn(e){return xt[e]?.defaults??{}}function Ft(e){return xt[e]?.limits??{}}function No(){return Re}async function fn(e){const{modelId:t,prompt:n,duration:o,resolution:s,seed:a,image_url_input:r,negative_prompt:i,enable_prompt_expansion:d,camera_fixed:u,enable_safety_checker:m,enableSafetyChecker:f,image_size:g,image_resolution:p,max_images:h,aspect_ratio:k,quality:j,customMode:w,instrumental:y,model:b,style:_,title:S,negativeTags:M,callBackUrl:A}=e,v=Re.find($=>$.id===t),C=t?.toLowerCase().includes("suno")||t?.toLowerCase().startsWith("audio/")||v&&v.type==="audio",N=t?.toLowerCase().startsWith("image/")||v&&v.type==="image";if(!v&&!C){x(`Model ID ${t} not found in handler mapping.`,"Configuration Error");return}c.bus.publish("kieai:statusUpdate",{status:"loading",message:"Submitting task..."});try{if(C){let D;v?.modelApiId?D=(v.modelApiId.split("/")[1]||"v3_5").split("-")[0]:D="v3_5";const P=D.toUpperCase(),I={prompt:n,customMode:w||!1,instrumental:y||!1,model:b||P};_&&(I.style=_),S&&(I.title=S),M&&(I.negativeTags=M),A&&(I.callBackUrl=A),I.callBackUrl||(I.callBackUrl="https://example.com/callback");const L=await Io(I,F=>c.bus.publish("kieai:statusUpdate",{status:"loading",message:F}),{});c.bus.publish("kieai:statusUpdate",{status:"success",message:"Music generation complete!"}),c.bus.publish("kieai:newResult",{id:L.taskId,type:"audio",prompt:n,url:L.audioUrl,streamUrl:L.streamAudioUrl,title:L.title,audioId:L.audioId,wavUrl:null,midiData:null});return}if(N){const P=(xt[v.modelApiId]||{}).defaults||{},I={prompt:n};if(v.modelApiId==="bytedance/seedream-v4-text-to-image")I.image_size=g||P.image_size||"square_hd",I.image_resolution=p||P.image_resolution||"1K",I.max_images=Number(h||P.max_images||1);else if(v.modelApiId==="seedream/4.5-text-to-image")I.aspect_ratio=k||P.aspect_ratio||"1:1",I.quality=j||P.quality||"basic";else if(v.modelApiId==="bytedance/seedream-v4-edit"){let F=[];const U=e.image_urls||e.imageUrls||null,q=e.image_files||e.imageFiles||null;if(q&&(q instanceof FileList||Array.isArray(q))){const K=Array.from(q);if(K.length<1)throw new Error("Seedream V4 Edit requires at least 1 image.");if(K.length>10)throw new Error("Seedream V4 Edit supports up to 10 images.");for(const V of K){if(!(V instanceof File))continue;if(V.size>10*1024*1024)throw new Error("Each image must be <= 10MB.");if(!["image/jpeg","image/png","image/webp"].includes(V.type))throw new Error("Supported formats: JPEG, PNG, WEBP.");const Ve=await st(V,"seedream-edit");F.push(Ve)}}else Array.isArray(U)&&(F=U.filter(Boolean));if(!F.length)throw new Error("Seedream V4 Edit requires image_urls (or image_files).");I.image_urls=F,I.image_size=g||P.image_size||"square_hd",I.image_resolution=p||P.image_resolution||"1K",I.max_images=Number(h||P.max_images||1),a!=null&&a!==-1&&(I.seed=Number(a))}else if(v.modelApiId==="seedream/4.5-edit"){let F=[];const U=e.image_urls||e.imageUrls||null,q=e.image_files||e.imageFiles||null;if(q&&(q instanceof FileList||Array.isArray(q))){const K=Array.from(q);if(K.length<1)throw new Error("Seedream 4.5 Edit requires at least 1 image.");if(K.length>14)throw new Error("Seedream 4.5 Edit supports up to 14 images.");for(const V of K){if(!(V instanceof File))continue;if(V.size>10*1024*1024)throw new Error("Each image must be <= 10MB.");if(!["image/jpeg","image/png","image/webp"].includes(V.type))throw new Error("Supported formats: JPEG, PNG, WEBP.");const Ve=await st(V,"seedream-4.5-edit");F.push(Ve)}}else Array.isArray(U)&&(F=U.filter(Boolean));if(!F.length)throw new Error("Seedream 4.5 Edit requires image_urls (or image_files).");I.image_urls=F,I.aspect_ratio=k||P.aspect_ratio||"1:1",I.quality=j||P.quality||"basic",a!=null&&a!==-1&&(I.seed=Number(a))}else g&&(I.image_size=g),p&&(I.image_resolution=p),h!==void 0&&(I.max_images=Number(h)),k&&(I.aspect_ratio=k),j&&(I.quality=j);const L=await Tt(v.modelApiId,I,F=>c.bus.publish("kieai:statusUpdate",{status:"loading",message:F}),{taskContext:{}});return c.bus.publish("kieai:statusUpdate",{status:"success",message:"Image generation complete!"}),c.bus.publish("kieai:newResult",{id:L.taskId,type:"image",prompt:n,url:L.url,resultJson:L.resultJson}),L}const $=t.includes("wan2.5"),O=t.includes("wan-2-6"),Q=$||O,ye=!C&&t.includes("image-to-video"),be=!C&&t.includes("video-to-video"),se=t.includes("v1-pro")||t.includes("v1-lite"),z={prompt:n,resolution:String(s)||"720p",duration:String(o)||"5"};if(O||(z.seed=Number(a)||-1),!ye&&!be&&(z.aspect_ratio=e.aspect_ratio||"16:9"),ye){const D=r?.trim();if(!D||!D.startsWith("http"))throw new Error("I2V requires a valid public image URL.");O?z.image_urls=[D]:z.image_url=D}if(be){const D=e.video_url_input?.trim();if(!D||!D.startsWith("http"))throw new Error("V2V requires a valid public video URL.");z.video_urls=[D]}if($&&(i&&(z.negative_prompt=i),z.enable_prompt_expansion=d||!1),se){z.camera_fixed=u||!1;const D=m!==void 0?m:f!==void 0?f:void 0;z.enable_safety_checker=D!==void 0?D:!0}const B=await Tt(v.modelApiId,z,D=>c.bus.publish("kieai:statusUpdate",{status:"loading",message:D}),{taskContext:{durationSec:Number(o)||Number(e.duration)||5,resolution:String(s)||"720p"}});c.bus.publish("kieai:statusUpdate",{status:"success",message:"Generation Complete!"}),c.bus.publish("kieai:newResult",{id:B.taskId,type:"video",prompt:n,url:B.url})}catch($){const O=$.message||"An unknown network error occurred.";console.error("Kie.ai Generation Error (Task: N/A):",$),O.includes("Image required")||O.includes("valid public image URL")?x("Please paste a valid public image URL.","Input Missing"):x(`API Error: ${O}`,"Kie.ai Submission Failed")}finally{c.bus.publish("kieai:statusUpdate",{status:"ready",message:"Ready"})}}function hn(e){return`studio:${e}`}async function ve(e,t){const n={id:hn(e),projectId:e,type:"studio",updatedAt:Date.now(),...t};return he(ie,"readwrite","put",n)}async function Mo(e){try{return await he(ie,"readonly","get",hn(e))||null}catch(t){return console.warn("Failed to load studio session",t),null}}const Lo=ae.memo(({onFileDrop:e,imagePreviewUrl:t,removeImage:n})=>{const[o,s]=E.useState(!1),a=u=>{u.preventDefault(),s(!0)},r=u=>{u.preventDefault(),s(!1)},i=u=>{u.preventDefault(),s(!1),u.dataTransfer.files&&u.dataTransfer.files.length>0&&e(u.dataTransfer.files[0])},d=u=>{u.target.files&&u.target.files.length>0&&e(u.target.files[0])};return t?l.jsxs("div",{className:"tw-relative tw-p-2 tw-bg-slate-600 tw-rounded-lg tw-flex tw-justify-center",children:[l.jsx("img",{src:t,alt:"Upload Preview",className:"tw-max-h-40 tw-rounded-md tw-shadow-lg"}),l.jsx("button",{type:"button",onClick:n,className:"tw-absolute tw-top-0 tw-right-0 tw-bg-red-500 hover:tw-bg-red-600 tw-text-white tw-rounded-full tw-w-6 tw-h-6 tw-flex tw-items-center tw-justify-center tw-text-sm",children:"Ã—"})]}):l.jsxs("label",{htmlFor:"i2v-file-upload",onDragOver:a,onDragLeave:r,onDrop:i,className:`tw-border-2 tw-border-dashed tw-rounded-lg tw-p-6 tw-text-center tw-cursor-pointer tw-block tw-transition ${o?"tw-border-cyan-400 tw-bg-slate-600":"tw-border-slate-500 tw-bg-slate-700"}`,children:[l.jsx("input",{type:"file",id:"i2v-file-upload",className:"tw-hidden",accept:"image/*",onChange:d}),l.jsx("span",{className:"material-symbols-outlined tw-text-4xl tw-text-gray-400",children:"cloud_upload"}),l.jsx("p",{className:"tw-text-gray-400 tw-text-sm",children:"Drag & drop or click to upload image"})]})}),_o=ae.memo(({images:e,onImagesChange:t,maxImages:n=14})=>{const[o,s]=E.useState(!1),a=ae.useRef(null),r=p=>{p.preventDefault(),p.stopPropagation(),s(!0)},i=p=>{p.preventDefault(),p.stopPropagation(),s(!1)},d=p=>{p.preventDefault(),p.stopPropagation(),s(!1),p.dataTransfer.files&&p.dataTransfer.files.length>0&&m(Array.from(p.dataTransfer.files))},u=p=>{p.target.files&&p.target.files.length>0&&m(Array.from(p.target.files))},m=p=>{const h=p.filter(b=>b.type.startsWith("image/"));if(h.length===0){alert("Please select valid image files (JPEG, PNG, WEBP)");return}const k=e.length,j=n-k;if(j<=0){alert(`Maximum ${n} images allowed`);return}const w=h.slice(0,j);w.length<h.length&&alert(`Only adding ${w.length} images to stay within ${n} image limit`);const y=w.map(b=>({file:b,preview:URL.createObjectURL(b),id:`${Date.now()}-${Math.random()}`}));t([...e,...y])},f=p=>{const h=e.find(k=>k.id===p);h?.preview&&URL.revokeObjectURL(h.preview),t(e.filter(k=>k.id!==p))},g=()=>{e.forEach(p=>{p.preview&&URL.revokeObjectURL(p.preview)}),t([])};return l.jsxs("div",{className:"tw-space-y-3",children:[e.length>0&&l.jsxs("div",{className:"tw-flex tw-justify-between tw-items-center",children:[l.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-red-400",children:"image_urls *"}),l.jsx("button",{type:"button",onClick:g,className:"tw-text-xs tw-text-red-400 hover:tw-text-red-300 tw-bg-slate-600 hover:tw-bg-slate-500 tw-px-3 tw-py-1 tw-rounded",children:"Remove All"})]}),e.map(p=>l.jsxs("div",{className:"tw-bg-slate-600 tw-rounded-lg tw-p-4",children:[l.jsxs("div",{className:"tw-flex tw-items-start tw-justify-between tw-mb-2",children:[l.jsxs("div",{className:"tw-flex tw-items-center tw-gap-2 tw-text-gray-300",children:[l.jsx("span",{className:"material-symbols-outlined tw-text-lg",children:"image"}),l.jsxs("span",{className:"tw-text-sm",children:["File ",e.indexOf(p)+1]})]}),l.jsx("button",{type:"button",onClick:()=>f(p.id),className:"tw-text-xs tw-text-red-400 hover:tw-text-red-300 tw-bg-slate-700 hover:tw-bg-slate-600 tw-px-2 tw-py-1 tw-rounded",children:"Remove"})]}),l.jsx("div",{className:"tw-flex tw-justify-center tw-bg-slate-700 tw-rounded tw-p-2",children:l.jsx("img",{src:p.preview,alt:`Upload ${e.indexOf(p)+1}`,className:"tw-max-h-48 tw-rounded tw-object-contain"})})]},p.id)),e.length<n&&l.jsx("div",{onDragOver:r,onDragLeave:i,onDrop:d,className:`tw-border-2 tw-border-dashed tw-rounded-lg tw-transition ${o?"tw-border-cyan-400 tw-bg-slate-600":"tw-border-slate-500 tw-bg-slate-700"}`,children:l.jsxs("label",{htmlFor:"multi-image-upload",className:"tw-block tw-p-6 tw-text-center tw-cursor-pointer",children:[l.jsx("input",{ref:a,type:"file",id:"multi-image-upload",className:"tw-hidden",accept:"image/jpeg,image/png,image/webp",multiple:!0,onChange:u}),l.jsx("span",{className:"material-symbols-outlined tw-text-3xl tw-text-gray-400",children:"add_circle"}),l.jsxs("p",{className:"tw-text-gray-400 tw-text-sm tw-mt-2",children:["Add more files (",e.length,"/",n,")"]}),l.jsx("p",{className:"tw-text-gray-500 tw-text-xs tw-mt-1",children:"Upload an image file to use as input for the API"})]})})]})}),To=(e,t,n,o,s,a,r,i)=>{const d=e?.id||"",u=d.includes("wan2.5");d.includes("wan-2-6");const m=e?.type==="audio",f=e?.type==="image",g=f&&d.includes("edit"),p=!m&&d.includes("image-to-video"),h=!m&&d.includes("video-to-video"),k=d.includes("v1-pro")||d.includes("v1-lite"),w=d.includes("seedream4.5-edit")||d.includes("4.5-edit")?14:10;return l.jsxs(l.Fragment,{children:[m&&l.jsxs("div",{className:"form-group tw-flex tw-flex-col tw-gap-3",children:[l.jsxs("div",{className:"tw-flex tw-justify-between tw-items-center",children:[l.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Advanced Custom Mode"}),l.jsx("input",{type:"checkbox",checked:!!t.customMode,onChange:y=>n(b=>({...b,customMode:y.target.checked})),className:"tw-toggle"})]}),l.jsxs("div",{className:"tw-flex tw-justify-between tw-items-center",children:[l.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Instrumental Only"}),l.jsx("input",{type:"checkbox",checked:!!t.instrumental,onChange:y=>n(b=>({...b,instrumental:y.target.checked})),className:"tw-toggle"})]}),t.customMode&&l.jsxs(l.Fragment,{children:[l.jsxs("div",{children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Style (Custom Mode)"}),l.jsx("input",{type:"text",value:t.style||"",onChange:y=>n(b=>({...b,style:y.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"e.g., Jazz, Classical"})]}),l.jsxs("div",{children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Title (Custom Mode)"}),l.jsx("input",{type:"text",value:t.title||"",onChange:y=>n(b=>({...b,title:y.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"Song title"})]})]})]}),p&&!m&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Initial Frame Image (Public URL or Upload)"}),l.jsx("input",{type:"text",value:t.image_url_input||"",onChange:y=>n(b=>({...b,image_url_input:y.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white tw-mb-3",placeholder:"Paste Public Image URL here (e.g., https://example.com/pic.jpg)"}),l.jsx(Lo,{onFileDrop:s,imagePreviewUrl:o,removeImage:a})]}),h&&!m&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Input Video (Public URL)"}),l.jsx("input",{type:"text",value:t.video_url_input||"",onChange:y=>n(b=>({...b,video_url_input:y.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"Paste Public Video URL here (e.g., https://example.com/video.mp4)"}),l.jsx("p",{className:"tw-text-xs tw-text-gray-400 tw-mt-1",children:"Supported formats: MP4, MOV, MKV (max 10MB)"})]}),g&&l.jsxs("div",{className:"form-group",children:[l.jsx(_o,{images:r,onImagesChange:i,maxImages:w}),l.jsx("p",{className:"tw-text-xs tw-text-gray-400 tw-mt-2",children:"Supported formats: JPEG, PNG, WEBP (each file â‰¤ 10MB)"})]}),f&&(d.includes("seedream4.0")||d.includes("seedream-v4"))&&!d.includes("edit")&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Image Size"}),l.jsxs("select",{value:t.image_size||"square_hd",onChange:y=>n(b=>({...b,image_size:y.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",children:[l.jsx("option",{value:"square",children:"Square"}),l.jsx("option",{value:"square_hd",children:"Square HD"}),l.jsx("option",{value:"portrait_4_3",children:"Portrait 4:3"}),l.jsx("option",{value:"portrait_3_2",children:"Portrait 3:2"}),l.jsx("option",{value:"portrait_16_9",children:"Portrait 16:9"}),l.jsx("option",{value:"landscape_4_3",children:"Landscape 4:3"}),l.jsx("option",{value:"landscape_3_2",children:"Landscape 3:2"}),l.jsx("option",{value:"landscape_16_9",children:"Landscape 16:9"}),l.jsx("option",{value:"landscape_21_9",children:"Landscape 21:9"})]})]}),f&&d.includes("4.5")&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Aspect Ratio"}),l.jsxs("select",{value:t.aspect_ratio||"1:1",onChange:y=>n(b=>({...b,aspect_ratio:y.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",children:[l.jsx("option",{value:"1:1",children:"1:1 (Square)"}),l.jsx("option",{value:"4:3",children:"4:3 (Landscape)"}),l.jsx("option",{value:"3:4",children:"3:4 (Portrait)"}),l.jsx("option",{value:"16:9",children:"16:9 (Widescreen)"}),l.jsx("option",{value:"9:16",children:"9:16 (Vertical)"}),l.jsx("option",{value:"2:3",children:"2:3 (Portrait)"}),l.jsx("option",{value:"3:2",children:"3:2 (Landscape)"}),l.jsx("option",{value:"21:9",children:"21:9 (Ultra-wide)"})]})]}),f&&(d.includes("seedream4.0")||d.includes("seedream-v4"))&&!d.includes("edit")&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Image Resolution"}),l.jsxs("div",{className:"tw-flex tw-gap-2",children:[l.jsx("button",{type:"button",onClick:()=>n(y=>({...y,image_resolution:"1K"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${t.image_resolution==="1K"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"1K"}),l.jsx("button",{type:"button",onClick:()=>n(y=>({...y,image_resolution:"2K"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${t.image_resolution==="2K"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"2K"}),l.jsx("button",{type:"button",onClick:()=>n(y=>({...y,image_resolution:"4K"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${t.image_resolution==="4K"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"4K"})]})]}),f&&(d.includes("4.5")||d.includes("edit"))&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Quality"}),l.jsxs("div",{className:"tw-flex tw-gap-2",children:[l.jsx("button",{type:"button",onClick:()=>n(y=>({...y,quality:"basic"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${t.quality==="basic"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"Basic (2K)"}),l.jsx("button",{type:"button",onClick:()=>n(y=>({...y,quality:"high"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${t.quality==="high"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"High (4K)"})]})]}),u&&!m&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Negative Prompt (Optional)"}),l.jsx("textarea",{value:t.negative_prompt||"",onChange:y=>n(b=>({...b,negative_prompt:y.target.value})),rows:"2",className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"Content to avoid"})]}),u&&!m&&l.jsxs("div",{className:"form-group tw-flex tw-justify-between tw-items-center",children:[l.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Enable Prompt Expansion"}),l.jsx("input",{type:"checkbox",checked:!!t.enable_prompt_expansion,onChange:y=>n(b=>({...b,enable_prompt_expansion:y.target.checked})),className:"tw-toggle"})]}),k&&!m&&l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"form-group tw-flex tw-justify-between tw-items-center",children:[l.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Fixed Camera Position"}),l.jsx("input",{type:"checkbox",checked:!!t.camera_fixed,onChange:y=>n(b=>({...b,camera_fixed:y.target.checked})),className:"tw-toggle"})]}),l.jsxs("div",{className:"form-group tw-flex tw-justify-between tw-items-center",children:[l.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Enable Safety Checker"}),l.jsx("input",{type:"checkbox",checked:t.enable_safety_checker??!0,onChange:y=>n(b=>({...b,enable_safety_checker:y.target.checked})),className:"tw-toggle"})]})]})]})},Fo=({models:e,onSubmit:t,status:n})=>{const o=e.find(P=>P.id.includes("wan2.5-text-to-video"))?.id||e[0]?.id,[s,a]=E.useState(o),[r,i]=E.useState(""),[d,u]=E.useState({resolution:"1080p",duration:5,aspect_ratio:"1:1",seed:-1,enable_safety_checker:!0,image_url_input:"",video_url_input:"",quality:"basic",image_size:"square_hd",image_resolution:"1K",customMode:!1,instrumental:!1,style:"",title:"",negativeTags:"",callBackUrl:""}),[m,f]=E.useState({duration:[5,10],resolution:["480p","720p","1080p"]});E.useEffect(()=>{const P=c.bus.subscribe("studio:restoreForm",I=>{if(I){if(I.modelId){a(I.modelId);const L=Re.find(F=>F.id===I.modelId);L?.modelApiId&&f(Ft(L.modelApiId))}i(I.prompt||""),I.params&&u(L=>({...L,...I.params}))}});return()=>{P()}},[]);const[g,p]=E.useState(null),[h,k]=E.useState([]);E.useEffect(()=>()=>{h.forEach(P=>{P.preview&&URL.revokeObjectURL(P.preview)})},[h]);const j=E.useMemo(()=>e.find(P=>P.id===s)||e[0],[s,e]);if(!j)return l.jsx("p",{className:"tw-text-red-400 tw-p-4",children:"Error: Model data failed to load or initialize."});const w=j?.type==="audio",y=j?.type==="image",b=!w&&s.includes("image-to-video"),_=!w&&s.includes("video-to-video"),S=s.includes("wan2.5"),M=s.includes("wan-2-6"),A=s.includes("v1-pro")||s.includes("v1-lite"),v=n.status==="loading",C=E.useCallback(async P=>{const I=new FileReader;if(I.onload=async L=>{p(L.target.result);try{const F=await st(P,"images/user-uploads");u(U=>({...U,image_url_input:F}))}catch(F){let U="Upload failed: ";F?.response?.status===413?U+="File size exceeds 5MB limit":F?.response?.status===415?U+="Unsupported file type (JPEG/PNG only)":U+=F?.message||"Server connection failed",alert(U),p(null),u(q=>({...q,image_url_input:"",customMode:!1,instrumental:!1})),console.error("File upload error:",F)}},!P.type.startsWith("image/")){alert("Only image files are allowed (JPEG, PNG)");return}I.readAsDataURL(P)},[]),N=E.useCallback(()=>{p(null),u(P=>({...P,image_url_input:""}))},[]),$=P=>{if(P.preventDefault(),!r||v)return;if(w){t({modelId:s,prompt:r,...d});return}if(y){const{modelId:U,...q}=d;if(s.includes("edit")&&h.length>0){const V=new DataTransfer;h.forEach(Ge=>{V.items.add(Ge.file)}),q.image_files=V.files}t({modelId:s,prompt:r,...q});return}if(b&&(!d.image_url_input||!d.image_url_input.startsWith("http"))){alert("I2V requires a valid public image URL (e.g., https://example.com/pic.jpg).");return}if(_&&(!d.video_url_input||!d.video_url_input.startsWith("http"))){alert("V2V requires a valid public video URL (e.g., https://example.com/video.mp4).");return}const I={resolution:String(d.resolution)||"1080p",duration:String(d.duration)||"5",seed:Number(d.seed)||-1};b||(I.aspect_ratio=d.aspect_ratio||"16:9"),b&&(I.image_url=d.image_url_input);const{modelId:L,...F}=d;t({modelId:s,...F,prompt:r,...I})},O=P=>{const I=P.target.value,L=Re.find(K=>K.id===I);a(I),p(null),h.forEach(K=>{K.preview&&URL.revokeObjectURL(K.preview)}),k([]);const U=L?.type==="image"?"1:1":"16:9";u(K=>({...K,camera_fixed:!1,enable_safety_checker:!0,negative_prompt:"",enable_prompt_expansion:!1,image_url_input:"",video_url_input:"",image_files:null,customMode:!1,instrumental:!1,style:"",title:"",negativeTags:"",callBackUrl:"",resolution:"1080p",duration:5,aspect_ratio:U,seed:-1,quality:"basic",image_size:"square_hd",image_resolution:"1K",...L?.modelApiId?gn(L.modelApiId):{}}));const q=L?.modelApiId?Ft(L.modelApiId):{};f(q)},Q=E.useMemo(()=>To(j,d,u,g,C,N,h,k),[j,d,g,C,N,h]),ye=E.useMemo(()=>{if(w||y)return null;const P=m.resolution||(S?["720p","1080p"]:["480p","720p","1080p"]);return l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Resolution"}),l.jsx("div",{className:"tw-flex tw-gap-2",children:P.map(I=>l.jsx("button",{type:"button",onClick:()=>u(L=>({...L,resolution:I})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${d.resolution===I?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:I},I))})]})},[S,d.resolution,m.resolution,w,y]),be=E.useMemo(()=>{if(w||y)return null;const P=m.duration||[5,10];return l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Duration (seconds)"}),l.jsx("div",{className:"tw-flex tw-gap-2",children:P.map(I=>l.jsxs("button",{type:"button",onClick:()=>u(L=>({...L,duration:I})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${d.duration===I?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:[I,"s"]},I))})]})},[d.duration,m.duration,w,y]),se=E.useMemo(()=>{if(w||y||b||_)return null;const P=["16:9","21:9","4:3","1:1","3:4","9:16"];return l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Aspect Ratio"}),l.jsx("select",{value:d.aspect_ratio||"16:9",onChange:I=>u(L=>({...L,aspect_ratio:I.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",children:P.map(I=>l.jsx("option",{value:I,children:I},I))})]})},[d.aspect_ratio,w,y,b,_]),[z,B]=E.useState(!1),D=E.useMemo(()=>{const P={modelId:s,prompt:r};if(w){const L=(j?.modelApiId?.split("/")?.[1]||"").split("-")[0],F=L?L.toUpperCase():void 0,U={prompt:r,customMode:d.customMode||!1,instrumental:d.instrumental||!1,model:d.model||F};return d.style&&(U.style=d.style),d.title&&(U.title=d.title),d.negativeTags&&(U.negativeTags=d.negativeTags),d.callBackUrl&&(U.callBackUrl=d.callBackUrl),{...P,...U}}const I={resolution:String(d.resolution)||m.resolution?.[0]||"1080p",duration:String(d.duration)||"5"};return M||(I.seed=Number(d.seed)||-1),!b&&!_&&(I.aspect_ratio=d.aspect_ratio||"16:9"),b&&(I.image_url=d.image_url_input||""),_&&(I.video_url=d.video_url_input||""),S&&(d.negative_prompt&&(I.negative_prompt=d.negative_prompt),I.enable_prompt_expansion=!!d.enable_prompt_expansion),A&&(I.camera_fixed=!!d.camera_fixed,I.enable_safety_checker=d.enable_safety_checker!==void 0?!!d.enable_safety_checker:!0),{...P,...I}},[s,r,d,w,b,S,A,m.resolution,j?.modelApiId]);return l.jsxs("form",{onSubmit:$,className:"tw-bg-slate-700 tw-p-4 tw-rounded-lg tw-shadow-lg tw-flex tw-flex-col tw-gap-4",children:[l.jsx("h4",{className:"tw-text-white tw-font-bold tw-text-lg",children:"Generation Settings"}),l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Model Endpoint"}),l.jsx("select",{value:s,onChange:O,className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",children:e.map(P=>l.jsx("option",{value:P.id,children:P.name},P.id))})]}),l.jsx("textarea",{value:r,onChange:P=>i(P.target.value),placeholder:w?d.customMode&&!d.instrumental?"Enter the full song lyrics here...":"Describe the theme or mood for the song...":`Enter prompt for ${j.name}...`,rows:5,className:"tw-w-full tw-p-3 tw-rounded-md tw-bg-slate-600 tw-text-white tw-border tw-border-slate-500 focus:tw-border-cyan-400",required:!0}),Q,l.jsxs("div",{className:"tw-grid tw-grid-cols-2 tw-gap-4",children:[!b&&!_&&se,ye]}),!w&&!y&&l.jsxs("div",{className:"tw-grid tw-grid-cols-2 tw-gap-4",children:[be,!M&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Seed (-1 for Random)"}),l.jsx("input",{type:"number",value:d.seed,onChange:P=>u(I=>({...I,seed:parseInt(P.target.value,10)||-1})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"-1",min:"-1",max:"2147483647"})]})]}),l.jsx("button",{type:"submit",disabled:v,className:`btn tw-w-full tw-py-3 ${v?"is-loading":"tw-bg-cyan-500 hover:tw-bg-cyan-600"}`,children:v?n.message:"âœ¨ Run Generation"}),n.status==="error"&&l.jsxs("p",{className:"tw-text-red-400 tw-text-sm tw-mt-2 tw-text-center",children:["Error: ",n.message]}),l.jsx("div",{className:"tw-mt-4 tw-text-right",children:l.jsx("button",{type:"button",onClick:()=>B(P=>!P),className:"tw-text-cyan-400 tw-text-sm hover:tw-underline",children:z?"Hide JSON":"Show JSON"})}),z&&l.jsx("pre",{className:"tw-mt-2 tw-bg-slate-800 tw-rounded-md tw-text-gray-200 tw-text-xs tw-p-3 tw-overflow-x-auto",children:JSON.stringify(D,null,2)})]})},$o=({results:e,onDelete:t,onConvertWav:n,onGenerateMidi:o})=>l.jsxs("div",{className:"tw-mt-6",children:[l.jsxs("h4",{className:"tw-text-white tw-font-bold tw-text-lg tw-mb-3",children:["Results (",e.length,")"]}),l.jsxs("div",{className:"tw-flex tw-flex-col tw-gap-4 tw-p-2",children:[e.map(s=>l.jsxs("div",{className:"tw-bg-slate-700 tw-rounded-xl tw-overflow-hidden tw-shadow-xl",children:[s.type==="image"?l.jsx("img",{src:s.url,alt:s.prompt,className:"tw-w-full tw-h-auto tw-object-contain tw-max-h-[60vh]"}):s.type==="audio"?(()=>{const a=s.wavUrl||s.url||s.streamUrl;return a?l.jsx("audio",{controls:!0,src:a,className:"tw-w-full tw-h-auto tw-max-h-[60vh]"}):l.jsx("div",{className:"tw-p-3 tw-text-gray-400",children:"Audio unavailable"})})():l.jsx("video",{controls:!0,preload:"metadata",src:s.url,className:"tw-w-full tw-h-auto tw-object-contain tw-max-h-[60vh]"}),l.jsx("p",{className:"tw-text-xs tw-p-3 tw-text-gray-300 tw-leading-snug",children:s.type==="audio"&&s.title?s.title:s.prompt}),l.jsx("div",{className:"tw-flex tw-flex-wrap tw-justify-end tw-gap-3 tw-px-3 tw-py-2",children:s.type==="audio"?l.jsxs(l.Fragment,{children:[(()=>{const a=s.url||s.streamUrl;return typeof a=="string"&&a.length>0?l.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"MP3"}):null})(),s.wavUrl?l.jsx("a",{href:s.wavUrl,target:"_blank",rel:"noopener noreferrer",className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"WAV"}):l.jsx("button",{type:"button",onClick:()=>n&&n(s.id),className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"Convert to WAV"}),s.midiData?l.jsx("a",{href:`data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(s.midiData))}`,download:`midi-${s.id}.json`,className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"MIDI"}):l.jsx("button",{type:"button",onClick:()=>o&&o(s.id),className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"Generate MIDI"}),l.jsx("button",{type:"button",onClick:()=>t&&t(s.id),className:"tw-text-red-400 hover:tw-underline tw-text-sm",children:"Delete"})]}):l.jsxs(l.Fragment,{children:[l.jsx("a",{href:s.url,download:!0,className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"Download"}),l.jsx("button",{type:"button",onClick:()=>t&&t(s.id),className:"tw-text-red-400 hover:tw-underline tw-text-sm",children:"Delete"})]})})]},s.id)),e.length===0&&l.jsx("p",{className:"tw-text-gray-400 tw-text-center",children:"Start generating images or videos!"})]})]});function Bo({agentName:e,models:t,onGenerate:n}){const[o,s]=E.useState([]),[a,r]=E.useState({status:"ready",message:"Ready"}),[i,d]=E.useState({taskId:null,percent:0,label:"Idle",attempt:0,max:0}),u=ae.useRef(null),m=ae.useRef([]),f=E.useCallback(w=>{const{prompt:y,modelId:b,..._}=w;u.current={modelId:w.modelId,prompt:y,params:{..._}},n&&n(w)},[n]),g=E.useCallback(w=>{s(y=>{const b=y.filter(_=>_.id!==w);try{const S=c.getProject()?.id||"default";ve(S,{form:u.current,pendingTasks:m.current,results:b})}catch{}return b})},[]),p=E.useCallback(async w=>{const y=o.find(b=>b.id===w);if(!(!y||y.type!=="audio"))try{if(r({status:"loading",message:"Starting WAV conversion..."}),y.conversionPending)throw new Error("Conversion already in progress");const b=o.map(A=>A.id===w?{...A,conversionPending:!0}:A);s(b);const _=await Eo(y.id,y.audioId);r({status:"loading",message:"Processing audio..."});const S=await Promise.race([ko(_),new Promise((A,v)=>setTimeout(()=>v(new Error("Conversion timeout - try again later")),3e5))]),M=o.map(A=>A.id===w?{...A,wavUrl:S,conversionPending:!1}:A);s(M),r({status:"success",message:"WAV ready!"}),ve(c.getProject()?.id||"default",{form:u.current,pendingTasks:m.current,results:M}).catch(console.error)}catch(b){console.error("WAV conversion failed:",b);const _=b.response?.data?.error?.includes("Invalid audio")?"Invalid audio format - must be MP3":b.message.includes("timeout")?"Conversion timed out":"Conversion failed - please try again";r({status:"error",message:_,retryId:w});const S=o.map(M=>M.id===w?{...M,conversionPending:!1}:M);s(S)}},[o]),h=E.useCallback(async w=>{const y=o.find(b=>b.id===w);if(!(!y||y.type!=="audio")){r({status:"loading",message:"Separating vocals..."});try{const b=await jo(y.id,y.audioId,"split_stem"),_=await Ao(b);r({status:"loading",message:"Generating MIDI..."});const S=await Co(b),M=await Po(S),A=o.map(N=>N.id===w?{...N,midiData:M}:N);s(A),r({status:"success",message:"MIDI generation complete!"});const C=c.getProject()?.id||"default";ve(C,{form:u.current,pendingTasks:m.current,results:A}).catch(()=>{})}catch(b){r({status:"error",message:b.message||"MIDI generation failed"})}}},[o]);E.useEffect(()=>{const w=({status:A,message:v})=>r({status:A,message:v}),y=A=>{s(v=>{const C=[A,...v];m.current=m.current.filter(O=>O.taskId!==A.id);const $=c.getProject()?.id||"default";return ve($,{form:u.current,pendingTasks:m.current,results:C}).catch(()=>{}),C})},b=A=>{if(d(v=>({taskId:A.taskId||v.taskId,percent:typeof A.progress=="number"&&isFinite(A.progress)?A.progress:v.percent,label:A.message||A.status||v.label,attempt:A.attempt||v.attempt,max:A.max||v.max})),A.status==="submitted"){m.current=[{taskId:A.taskId,meta:{durationSec:u.current?.params?.duration||5,resolution:u.current?.params?.resolution||"720p"}},...m.current];const C=c.getProject()?.id||"default";ve(C,{form:u.current,pendingTasks:m.current,results:o}).catch(()=>{})}else if(A.status==="success"){m.current=m.current.filter(N=>N.taskId!==A.taskId);const C=c.getProject()?.id||"default";ve(C,{form:u.current,pendingTasks:m.current,results:o}).catch(()=>{})}},_=c.bus.subscribe("kieai:statusUpdate",w),S=c.bus.subscribe("kieai:newResult",y),M=c.bus.subscribe("kieai:progress",b);return()=>{_(),S(),M()}},[o,n]),E.useEffect(()=>{let w=!0;return(async()=>{try{const _=c.getProject()?.id||"default",S=await Mo(_);if(!w||!S)return;if(!((Array.isArray(S.results)||S.results===void 0)&&(typeof S.form=="object"||S.form===void 0)&&(Array.isArray(S.pendingTasks)||S.pendingTasks===void 0)))throw new Error("Invalid session format");if(batchUpdates(()=>{S.results?.length&&s(S.results.filter(A=>A?.id&&(A.type==="audio"||A.type==="video"||A.type==="image"))),S.form&&(u.current=S.form,c.bus.publish("studio:restoreForm",{...S.form,params:{...gn(S.form.modelId),...S.form.params}})),S.pendingTasks?.length&&(m.current=S.pendingTasks.filter(A=>A?.taskId&&A?.meta?.durationSec))}),m.current.length){const v=[...m.current],C=async()=>{for(;v.length>0&&w;){const N=v.shift();try{const $=await go(N.taskId,N.meta);w&&c.bus.publish("kieai:newResult",{id:$.taskId,type:"video",prompt:N.meta.prompt||"",url:$.url})}catch($){console.warn("Resume polling failed for task:",N.taskId,$),w&&r({status:"error",message:`Failed to resume task ${N.taskId.slice(0,6)}...`})}}};Array.from({length:3}).forEach(C)}}catch(b){console.error("Session load failed:",b),w&&(r({status:"error",message:"Corrupted session data - starting fresh"}),s([]),m.current=[])}})(),()=>{w=!1}},[]);const k=E.useCallback(()=>{const w=document.getElementById("switch-to-chat-btn");w&&w.click()},[]),j=E.useCallback(()=>{const w=document.getElementById("switch-to-composer-btn");w&&w.click()},[]);return l.jsxs("div",{className:"studio-content tw-flex tw-flex-col tw-h-full tw-p-6 tw-bg-slate-800 tw-text-white tw-overflow-y-auto",children:[l.jsxs("div",{className:"tw-flex tw-justify-between tw-items-center tw-mb-4",children:[l.jsx("h2",{className:"tw-text-2xl tw-font-extrabold tw-text-cyan-400",children:e}),l.jsxs("div",{className:"tw-flex tw-gap-2",children:[l.jsx("button",{type:"button",onClick:k,className:"tw-bg-slate-700 tw-text-gray-200 tw-rounded-md tw-px-3 tw-py-1 hover:tw-bg-slate-600",children:"â† Back to Chat"}),l.jsx("button",{type:"button",onClick:j,className:"tw-bg-slate-700 tw-text-gray-200 tw-rounded-md tw-px-3 tw-py-1 hover:tw-bg-slate-600",children:"â† Back to Composer"})]})]}),l.jsxs("div",{className:"tw-flex tw-gap-6 tw-flex-grow tw-overflow-hidden",children:[l.jsxs("div",{className:"tw-w-full lg:tw-w-1/3 tw-flex-shrink-0",children:[l.jsx(Fo,{models:t,onSubmit:f,status:a}),a.status!=="ready"&&l.jsxs("div",{className:"tw-mt-4 tw-bg-slate-700 tw-rounded-lg tw-p-3",children:[l.jsxs("div",{className:"tw-flex tw-justify-between tw-text-xs tw-text-gray-300",children:[l.jsx("span",{children:i.label}),l.jsxs("span",{children:[i.attempt,"/",i.max||"âˆž"]})]}),l.jsx("progress",{className:"tw-w-full tw-mt-2",max:"100",value:i.percent||5})]})]}),l.jsx("div",{className:"tw-w-full lg:tw-w-2/3",children:l.jsx($o,{results:o,onDelete:g,onConvertWav:p,onGenerateMidi:h})})]})]})}const at="kieai-studio-workspace",St="photo-studio-root";function Ro(){let e=document.getElementById(at);if(!e){e=document.createElement("div"),e.id=at,e.className="workspace hidden",document.querySelector(".main-view-container").appendChild(e);const t=document.createElement("div");t.id=St,e.appendChild(t)}return e}function Uo(e){const t=Ro();document.getElementById("chat-compose-workspace").classList.add("hidden"),t.classList.remove("hidden"),t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.right="0",t.style.bottom="0",t.style.zIndex="9999",t.style.overflowY="auto";const o=document.querySelector(".chat-input-wrapper");o&&o.classList.add("hidden");const a={agentName:e,models:No(),onGenerate:fn};ue.mount(Bo,a,document.getElementById(St))}function Me(){const e=document.getElementById(at),t=document.getElementById("chat-compose-workspace"),n=document.querySelector(".chat-input-wrapper");e&&(e.removeAttribute("style"),e.classList.add("hidden"),t.classList.remove("hidden"),n&&n.classList.remove("hidden"),ue.unmount(document.getElementById(St)))}function Do(){const e=document.getElementById("kieAiApiKey");if(e){const t=ce();e.value=t?.apiSettings?.kieAiApiKey||"",e.addEventListener("input",()=>{mt({kieAiApiKey:e.value})})}}const R={};function Oo(){R.appWrapper=document.querySelector(".app-wrapper"),R.toggleRightSidebarBtn=document.getElementById("toggle-right-sidebar-btn"),R.sessionsPanel=document.querySelector(".sessions-panel"),R.hamburgerBtn=document.getElementById("hamburger-btn"),R.closeSidebarBtn=document.querySelector('.sessions-panel .mobile-only[title="Close Sidebar"]'),R.mobileOverlay=document.getElementById("mobile-overlay"),R.composerPanel=document.querySelector(".composer-panel"),R.resizerRow=document.getElementById("resizer-row")}function wn(e,t){if(!e||!t)return;let n=0,o=0,s=0,a=!1;const r=u=>{u.preventDefault(),e.classList.add("active"),document.body.style.cursor="row-resize",t.classList.add("is-resizing"),t.classList.contains("collapsed")&&c.bus.publish("ui:requestComposerOpen"),n=u.clientY,o=t.getBoundingClientRect().height,document.addEventListener("mousemove",i),document.addEventListener("mouseup",d)},i=u=>{s=u.clientY,a||(window.requestAnimationFrame(()=>{const m=s-n;let f=o-m;const g=100;f<g&&(f=g),t.style.flexBasis=`${f}px`;const p=t.querySelector(".composer-editor");p&&(p.style.height=`${f-50}px`),a=!1}),a=!0)},d=()=>{e.classList.remove("active"),document.body.style.cursor="",t.classList.remove("is-resizing");const u=t.getBoundingClientRect().height;localStorage.setItem("promptPrimComposerHeight",u),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",d)};e.addEventListener("mousedown",r)}function qo(){if(!R.sessionsPanel)return;const e=t=>{t.stopPropagation(),t.preventDefault(),R.sessionsPanel.classList.remove("is-open"),R.mobileOverlay?.classList.remove("active")};R.hamburgerBtn?.addEventListener("click",t=>{window.innerWidth<=1024?(R.sessionsPanel.classList.add("is-open"),R.mobileOverlay?.classList.add("active")):R.appWrapper?.classList.toggle("sidebar-collapsed")}),R.mobileOverlay?.addEventListener("click",e,!0),R.closeSidebarBtn?.addEventListener("click",e,!0)}function Ho(){Oo(),R.resizerRow&&R.composerPanel&&wn(R.resizerRow,R.composerPanel),qo(),zo(),console.log("Core layout manager initialized.")}function zo(){!R.toggleRightSidebarBtn||!R.appWrapper||R.toggleRightSidebarBtn.addEventListener("click",()=>{R.appWrapper.classList.toggle("right-sidebar-collapsed"),R.appWrapper.classList.contains("right-sidebar-collapsed")||c.bus.publish("studio:rendered")})}function Ko(){document.addEventListener("keydown",e=>{const t=document.querySelector('.modal-overlay[style*="display: flex"]'),n=document.getElementById("settings-panel"),o=n?.classList.contains("visible");if(!(!t&&!o)){if(e.key==="Escape"){if(e.preventDefault(),t){const s=t.querySelector(".btn-secondary")||t.querySelector(".modal-actions .btn");s&&s.click()}else if(o){const s=n.querySelector(".close-settings-btn");s&&s.click()}}if(e.key==="Enter"&&!e.shiftKey){if(e.target.tagName==="TEXTAREA"||e.target.tagName==="BUTTON")return;if(t){e.preventDefault();const s=t.querySelector(".modal-actions .btn:not(.btn-secondary):not(.btn-danger)");if(s)s.click();else{const a=t.querySelector(".modal-actions .btn");a&&a.click()}}}}}),console.log("Global keyboard bindings initialized.")}function _e(e){const t=document.getElementById("project-title");if(t){const n=c.isUserDirty(),o=e||c.getProject()?.name||"Untitled";t.textContent=n?`${o} *`:o}}function Go(){const e=document.getElementById("save-project-modal"),t=document.getElementById("project-name-input"),n=c.getProject();t.value=n?`${n.name} - Copy`:"Untitled Project",e.style.display="flex",t.focus(),t.select()}function $t(){const e=document.getElementById("save-project-modal");e.style.display="none"}function Vo(e){e&&e.stopPropagation(),document.getElementById("custom-entity-selector-wrapper").classList.toggle("open")}function Wo(e){const t=e.indexOf("_"),n=e.substring(0,t),o=e.substring(t+1);c.bus.publish("entity:select",{type:n,name:o}),document.getElementById("custom-entity-selector-wrapper").classList.remove("open")}function Ee(){const e=c.getProject();if(!e||!e.globalSettings)return;const t=document.getElementById("entitySelector"),n=document.getElementById("custom-entity-selector-options"),o=document.getElementById("custom-entity-selector-icon"),s=document.getElementById("custom-entity-selector-text");t.innerHTML="",n.innerHTML="";const a=(d,u,m,f)=>{const g=`${d}_${u}`,p=document.createElement("div");p.className="custom-select-option",p.innerHTML=`<span class="item-icon">${m}</span> <span>${u}</span>`,p.addEventListener("click",()=>Wo(g)),f.appendChild(new Option(`${m} ${u}`,g)),n.appendChild(p)},r=e.agentPresets||{};if(Object.keys(r).length>0){const d=document.createElement("optgroup");d.label="Agent Presets",t.appendChild(d);const u=document.createElement("div");u.className="custom-select-group",u.textContent="Agent Presets",n.appendChild(u),Object.keys(r).forEach(m=>{a("agent",m,r[m].icon||"ðŸ¤–",d)})}const i=e.agentGroups||{};if(Object.keys(i).length>0){const d=document.createElement("optgroup");d.label="Agent Groups",t.appendChild(d);const u=document.createElement("div");u.className="custom-select-group",u.textContent="Agent Groups",n.appendChild(u),Object.keys(i).forEach(m=>{a("group",m,"ðŸ¤",d)})}if(e.activeEntity){const{type:d,name:u}=e.activeEntity;t.value=`${d}_${u}`,d==="agent"&&r[u]?(o.textContent=r[u].icon||"ðŸ¤–",s.textContent=u):d==="group"?(o.textContent="ðŸ¤",s.textContent=u):(o.textContent="â”",s.textContent="Select...")}}function Jo(){c.bus.subscribe("project:loaded",n=>{_e(n.projectData.name),Ee()}),c.bus.subscribe("project:nameChanged",n=>_e(n)),c.bus.subscribe("userDirty:changed",()=>_e()),c.bus.subscribe("entity:selected",Ee),c.bus.subscribe("agent:listChanged",Ee),c.bus.subscribe("group:listChanged",Ee),c.bus.subscribe("ui:showSaveAsModal",Go);const e=document.querySelector(".sidebar-bottom-row .dropdown");if(e){const n=e.querySelector("button");n&&n.addEventListener("click",pt),e.addEventListener("click",o=>{const s=o.target.closest("a");if(!s)return;const a=s.dataset.action;if(a){o.preventDefault();const r={newProject:{name:"project:new"},openProject:{name:"project:open"},saveProject:{name:"project:save",data:!1},saveProjectAs:{name:"project:save",data:!0},exportChat:{name:"project:exportChat"}};r[a]&&c.bus.publish(r[a].name,r[a].data),e.classList.remove("open")}})}const t=document.getElementById("save-project-modal");t&&t.addEventListener("click",n=>{if(n.target.matches(".btn:not(.btn-secondary)")){const o=document.getElementById("project-name-input").value.trim();o?(c.bus.publish("project:saveConfirm",{projectName:o}),$t()):x("Please enter a project name.")}else(n.target.matches(".btn-secondary")||n.target===t)&&$t()}),document.getElementById("load-project-input")?.addEventListener("change",n=>c.bus.publish("project:fileSelectedForOpen",n)),document.getElementById("custom-entity-selector-trigger")?.addEventListener("click",Vo),console.log("Project UI Initialized with definitive listeners.")}let Bt=!1,te=null,G=null,Y=null,ke=null;function Rt(e,t=0){const n=Number(e?.sortIndex);return Number.isFinite(n)?n:t}function We(e,t){const n=Rt(e)-Rt(t);return n!==0?n:(t?.updatedAt||0)-(e?.updatedAt||0)}function oe(){G&&(G.portal?.remove(),G.dropdown?.classList.remove("open","portal-open"),G=null,Ue())}function yn(){if(!G)return;const{button:e,portal:t}=G;if(!e?.isConnected||!t?.isConnected){oe();return}const n=e.getBoundingClientRect();t.style.left="0px",t.style.top="0px",t.style.visibility="hidden",t.style.display="block";const o=t.getBoundingClientRect(),s=8,a=n.bottom+6,r=n.top>=o.height+s,d=a+o.height>window.innerHeight-s&&r?Math.max(s,n.top-o.height-6):Math.min(window.innerHeight-o.height-s,a);let u=n.right-o.width;u<s&&(u=s),u+o.width>window.innerWidth-s&&(u=Math.max(s,window.innerWidth-o.width-s)),t.style.left=`${Math.round(u)}px`,t.style.top=`${Math.round(d)}px`,t.style.visibility="visible"}function Yo(e,t){const n=e.closest(".session-item[data-session-id]"),o=e.closest(".session-folder[data-folder-id]"),s=e.closest("#new-session-menu");n?.dataset.sessionId&&(t.dataset.sessionId=n.dataset.sessionId),o?.dataset.folderId&&(t.dataset.folderId=o.dataset.folderId),s&&(t.dataset.menuType="new-session")}function Xo(e){const t=e?.closest(".dropdown");if(!t)return;const n=t.querySelector(":scope > .dropdown-content");if(!n)return;oe();const o=document.createElement("div");o.className="dropdown-content dropdown-content-portal",o.innerHTML=n.innerHTML,Yo(t,o),document.body.appendChild(o),t.classList.add("open","portal-open"),G={dropdown:t,button:e,portal:o},yn(),Ue()}function Qo(e){const t=e?.closest(".dropdown");if(t){if(G?.dropdown===t){oe();return}Xo(e)}}function Zo(e){const t=e?.closest?.(".session-folder[data-folder-id]")||null;if(!t||t.open){Y&&(clearTimeout(Y),Y=null,ke=null);return}const n=t.dataset.folderId;!n||ke===n||(Y&&clearTimeout(Y),ke=n,Y=window.setTimeout(()=>{const o=document.querySelector(`.session-folder[data-folder-id="${n}"]`);o&&!o.open&&(o.open=!0),Y=null,ke=null},450))}function Ue(){document.querySelectorAll(".session-folder.has-open-menu").forEach(e=>e.classList.remove("has-open-menu")),document.querySelectorAll(".session-folder .dropdown.open").forEach(e=>{const t=e.closest(".session-folder");t&&t.classList.add("has-open-menu")})}function ea(e,t){return t.linkedEntity?.type==="agent"&&e.agentPresets?.[t.linkedEntity.name]?e.agentPresets[t.linkedEntity.name].icon||"ðŸ¤–":t.linkedEntity?.type==="group"?"ðŸ¤":"ðŸ’¬"}function bn(e){return e==="session_only"?"Session only":"Folder aware"}function Te(e,t){const n=H(t,e.folderId),o=ne(e.contextMode),a=W(e.ragSettings,{scopeSource:e.folderId?"folder":"session"}).scopeSource==="folder"?"Folder RAG":"Session RAG",r=document.createElement("div");r.className="item session-item",r.dataset.sessionId=e.id,r.draggable=!0,(e.pinned||e.isPinned)&&r.classList.add("pinned"),e.archived&&r.classList.add("archived");const i=e.name||"New Chat",d=bn(o),u=n?`Folder: ${n.name}`:"Main list",m=ea(t,e);return r.innerHTML=`
        <div class="item-header">
            <span class="item-name"><span class="item-icon">${m}</span> ${i}</span>
            <div class="item-actions">
                <div class="dropdown align-right">
                    <button class="btn-icon" data-action="toggle-menu" title="More options">&#8942;</button>
                    <div class="dropdown-content">
                        <a href="#" data-action="info">Session Info</a>
                        <a href="#" data-action="pin">${e.pinned||e.isPinned?"Unpin":"Pin"} Session</a>
                        <a href="#" data-action="rename">Rename</a>
                        <a href="#" data-action="move">Move to Folder...</a>
                        <a href="#" data-action="context-mode">Context Mode...</a>
                        <a href="#" data-action="clone">Clone Session</a>
                        <a href="#" data-action="archive">${e.archived?"Unarchive":"Archive"} Session</a>
                        <a href="#" data-action="download">Download Chat</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" data-action="delete" class="is-destructive">
                            <span class="material-symbols-outlined">delete</span> Delete Session
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="session-item-meta">${u} â€¢ ${d} â€¢ ${a}</div>
    `,r}function ta(e,t,n){const o=document.createElement("details");o.className="session-folder",o.dataset.folderId=e.id,o.dataset.sessionDropTarget="folder",o.open=!e.collapsed;const s=document.createElement("summary");s.className="session-folder-summary",s.innerHTML=`
        <span class="session-folder-title">
            <span class="session-folder-caret material-symbols-outlined">chevron_right</span>
            <span class="session-folder-icon-closed material-symbols-outlined">folder</span>
            <span class="session-folder-icon-open material-symbols-outlined">folder_open</span>
            <span>${e.name}</span>
            <span class="session-folder-count">${t.length}</span>
        </span>
        <div class="item-actions">
            <div class="dropdown align-right">
                <button class="btn-icon" data-action="toggle-menu" title="Folder options">&#8942;</button>
                <div class="dropdown-content">
                    <a href="#" data-action="folder:new-chat">New Chat in Folder</a>
                    <a href="#" data-action="folder:rename">Rename Folder</a>
                    <a href="#" data-action="folder:settings">Folder Context Budget...</a>
                    <div class="dropdown-divider"></div>
                    <a href="#" data-action="folder:delete" class="is-destructive">Delete Folder</a>
                </div>
            </div>
        </div>
    `,o.appendChild(s);const a=document.createElement("div");return a.className="item-list folder-session-list",a.dataset.sessionDropTarget="folder",a.dataset.folderId=e.id,t.length===0?a.innerHTML='<p class="no-items-message">Drop sessions here or create a new one.</p>':t.forEach(r=>{a.appendChild(Te(r,n))}),o.appendChild(a),o}function vn(e){document.querySelectorAll(".session-item").forEach(n=>{n.classList.toggle("active",n.dataset.sessionId===e)})}function na(e=""){return e?Math.max(1,Math.round(String(e).length/4)):0}function Z(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function sa(e,t){T(t);const n=e.linkedEntity||null,o=c.getStagedEntity(),s=t.activeEntity||null,a=H(t,e.folderId),r=ne(e.contextMode),i=W(e.ragSettings,{scopeSource:e.folderId?"folder":"session"}),d=a?de(a.ragSettings):null,u=i.scopeSource==="folder"&&d?d:i,m=Array.isArray(u.selectedFileIds)?[...new Set(u.selectedFileIds)]:[],f=Array.isArray(t.knowledgeFiles)?t.knowledgeFiles:[],g=new Map(f.map(C=>[C.id,C])),p=m.map(C=>g.get(C)).filter(Boolean),h=f.filter(C=>Number(C.chunkCount)>0),k=h.reduce((C,N)=>C+(Number(N.chunkCount)||0),0),j=Array.isArray(e.history)?e.history.length:0,w=(e.history||[]).map(C=>typeof C.content=="string"?C.content:Array.isArray(C.content)?C.content.filter(N=>N?.type==="text"&&N.text).map(N=>N.text).join(`
`):"").join(`
`),y=na(w),b=(e.history||[]).reduce((C,N)=>{const $=N?.stats||{};return C.prompt+=Number($.prompt_tokens||$.promptTokens||0),C.completion+=Number($.completion_tokens||$.completionTokens||0),C},{prompt:0,completion:0}),_=n?.type==="agent"?t.agentPresets?.[n.name]:null,S=n?.type==="group"?t.agentGroups?.[n.name]:null,M=Array.isArray(_?.activeMemories)?_.activeMemories:[],A=Array.isArray(S?.agents)?S.agents:[],v=bn(r);return`
        <div class="info-grid">
            <strong>Session Name:</strong><span>${Z(e.name||"Untitled")}</span>
            <strong>Session ID:</strong><span>${Z(e.id||"-")}</span>
            <strong>Created:</strong><span>${new Date(e.createdAt||Date.now()).toLocaleString("th-TH")}</span>
            <strong>Updated:</strong><span>${new Date(e.updatedAt||Date.now()).toLocaleString("th-TH")}</span>
            <strong>Folder:</strong><span>${Z(a?.name||"Main list")}</span>
            <strong>Context Mode:</strong><span>${Z(v)}</span>
            <strong>Linked Entity:</strong><span>${Z(n?`${n.type}:${n.name}`:"None")}</span>
            <strong>Active Entity:</strong><span>${Z(s?`${s.type}:${s.name}`:"None")}</span>
            <strong>Staged Entity:</strong><span>${Z(o?`${o.type}:${o.name} (pending confirm)`:"None")}</span>
            <strong>Messages:</strong><span>${j.toLocaleString()}</span>
            <strong>Approx History Tokens:</strong><span>~${y.toLocaleString()}</span>
            <strong>Usage Prompt Tokens:</strong><span>${b.prompt.toLocaleString()}</span>
            <strong>Usage Completion Tokens:</strong><span>${b.completion.toLocaleString()}</span>
        </div>
        <h4>Agent / Group Detail</h4>
        <pre>${Z(n?.type==="agent"?`Agent: ${n.name}
Model: ${_?.model||"N/A"}
Active Memories: ${M.length?M.join(", "):"None"}`:n?.type==="group"?`Group: ${n.name}
Moderator: ${S?.moderatorAgent||"N/A"}
Members: ${A.length?A.join(", "):"None"}`:"No linked entity")}</pre>
        <h4>RAG Detail</h4>
        <pre>${Z([`RAG Source: ${i.scopeSource==="folder"?"folder":"session"}`,`Scope: ${u.scopeMode==="selected"?"selected":"all"}`,`Top-K: ${Number(u.retrievalTopK||0)}`,`Token Budget: ${Number(u.maxContextTokens||0)}`,`Selected Docs: ${p.length}`,p.length?`Selected Names: ${p.map(C=>C.name).join(", ")}`:"Selected Names: None",`Indexed Files in Project: ${h.length}/${f.length}`,`Total Indexed Chunks: ${k}`,a?.contextPolicy?`Folder Shared Context: ${a.contextPolicy.autoSharedContext===!1?"Disabled":"Enabled"} | Budget ${a.contextPolicy.sharedContextBudgetTokens} tokens, max ${a.contextPolicy.maxSharedSessions} sessions`:"Folder Shared Context Budget: N/A",a?.ragSettings?`Folder Auto RAG: ${a.ragSettings.autoRetrieve===!1?"Disabled":"Enabled"}`:"Folder Auto RAG: N/A"].join(`
`))}</pre>
    `}function oa(){const e=document.getElementById("session-info-modal");e&&(e.style.display="none")}function xn(){const e=document.getElementById("folder-settings-modal");e&&(e.style.display="none")}function aa(e,t){const n=document.getElementById("folder-settings-file-list");if(!n)return;const o=Array.isArray(e?.knowledgeFiles)?e.knowledgeFiles:[],s=new Set(Array.isArray(t?.selectedFileIds)?t.selectedFileIds:[]);if(n.innerHTML="",o.length===0){n.innerHTML='<p class="no-items-message">No knowledge files uploaded yet.</p>';return}o.forEach(a=>{const r=document.createElement("label");r.className="folder-settings-file-item";const i=document.createElement("input");i.type="checkbox",i.dataset.fileId=a.id,i.checked=s.has(a.id);const d=document.createElement("span"),u=Number(a.chunkCount)||0;d.textContent=`${a.name} (${u} chunk${u===1?"":"s"})`,r.appendChild(i),r.appendChild(d),n.appendChild(r)})}function Sn(){const e=document.getElementById("folder-settings-auto-shared-context"),t=document.getElementById("folder-settings-auto-rag"),n=document.getElementById("folder-settings-shared-budget"),o=document.getElementById("folder-settings-max-sessions"),s=document.getElementById("folder-settings-rag-scope"),a=document.getElementById("folder-settings-rag-topk"),r=document.getElementById("folder-settings-rag-budget"),i=document.getElementById("folder-settings-file-list");if(!e||!t)return;const d=!!e.checked,u=!!t.checked,m=s?.value||"all",f=u&&m==="selected";[n,o].forEach(g=>{g&&(g.disabled=!d)}),[s,a,r].forEach(g=>{g&&(g.disabled=!u)}),i&&i.classList.toggle("is-disabled",!f)}function ra({folderId:e}={}){const t=c.getProject();if(!t)return;T(t);const n=H(t,e);if(!n){x("Folder not found.","Folder Settings");return}const o=gt(n.contextPolicy),s=de(n.ragSettings),a=document.getElementById("folder-settings-modal"),r=document.getElementById("folder-settings-id"),i=document.getElementById("folder-settings-name"),d=document.getElementById("folder-settings-auto-shared-context"),u=document.getElementById("folder-settings-shared-budget"),m=document.getElementById("folder-settings-max-sessions"),f=document.getElementById("folder-settings-auto-rag"),g=document.getElementById("folder-settings-rag-scope"),p=document.getElementById("folder-settings-rag-topk"),h=document.getElementById("folder-settings-rag-budget");!a||!r||!i||!d||!u||!m||!f||!g||!p||!h||(r.value=n.id,i.value=n.name||"",d.checked=o.autoSharedContext!==!1,u.value=String(o.sharedContextBudgetTokens),m.value=String(o.maxSharedSessions),f.checked=s.autoRetrieve!==!1,g.value=s.scopeMode,p.value=String(s.retrievalTopK),h.value=String(s.maxContextTokens),aa(t,s),Sn(),a.style.display="flex")}function ia(){const e=document.getElementById("folder-settings-id")?.value||"";if(!e)return;const t=document.getElementById("folder-settings-name")?.value?.trim()||"",n=!!document.getElementById("folder-settings-auto-shared-context")?.checked,o=Number(document.getElementById("folder-settings-shared-budget")?.value),s=Number(document.getElementById("folder-settings-max-sessions")?.value),a=!!document.getElementById("folder-settings-auto-rag")?.checked,r=document.getElementById("folder-settings-rag-scope")?.value||"all",i=Number(document.getElementById("folder-settings-rag-topk")?.value),d=Number(document.getElementById("folder-settings-rag-budget")?.value),u={autoSharedContext:n};Number.isFinite(o)&&(u.sharedContextBudgetTokens=o),Number.isFinite(s)&&(u.maxSharedSessions=s);const m={autoRetrieve:a,scopeMode:r==="selected"?"selected":"all"};Number.isFinite(i)&&(m.retrievalTopK=i),Number.isFinite(d)&&(m.maxContextTokens=d),m.selectedFileIds=Array.from(document.querySelectorAll('#folder-settings-file-list input[type="checkbox"][data-file-id]:checked')).map(f=>f.dataset.fileId).filter(Boolean),c.bus.publish("folder:updateSettings",{folderId:e,name:t,contextPolicy:u,ragSettings:m}),xn()}function In(){const e=document.getElementById("folder-name-modal");e&&(e.style.display="none")}function rt({mode:e="create",folderId:t="",defaultName:n=""}={}){const o=document.getElementById("folder-name-modal"),s=document.getElementById("folder-name-mode"),a=document.getElementById("folder-name-folder-id"),r=document.getElementById("folder-name-modal-title"),i=document.getElementById("folder-name-input");if(!o||!s||!a||!r||!i)return;const d=c.getProject();d&&(T(d),s.value=e==="rename"?"rename":"create",a.value=t||"",r.textContent=e==="rename"?"Rename Folder":"Create Folder",i.value=n||(e==="rename"?"":"New Folder"),o.style.display="flex",requestAnimationFrame(()=>i.focus()))}function la(){const e=document.getElementById("folder-name-mode")?.value||"create",t=document.getElementById("folder-name-folder-id")?.value||"",n=document.getElementById("folder-name-input")?.value?.trim()||"";n&&(e==="rename"?c.bus.publish("folder:rename",{folderId:t,name:n}):c.bus.publish("folder:new",{askName:!1,name:n}),In())}function En(){const e=document.getElementById("session-move-modal");e&&(e.style.display="none")}function ca({sessionId:e}={}){const t=c.getProject();if(!t)return;T(t);const n=(t.chatSessions||[]).find(d=>d.id===e);if(!n)return;const o=document.getElementById("session-move-modal"),s=document.getElementById("session-move-session-id"),a=document.getElementById("session-move-folder-select"),r=document.getElementById("session-move-modal-title");if(!o||!s||!a||!r)return;s.value=n.id,r.textContent=`Move "${n.name||"Untitled"}"`,a.innerHTML='<option value="">Main list (no folder)</option>',(t.chatFolders||[]).forEach(d=>{const u=document.createElement("option");u.value=d.id,u.textContent=d.name,a.appendChild(u)}),a.value=n.folderId||"";const i=document.getElementById("session-move-new-folder-name");i&&(i.value=""),o.style.display="flex"}function da(){const e=document.getElementById("session-move-session-id")?.value||"",t=document.getElementById("session-move-folder-select")?.value||null;e&&(c.bus.publish("session:move",{sessionId:e,folderId:t}),En())}function kn(){const e=document.getElementById("session-context-mode-modal");e&&(e.style.display="none")}function ua({sessionId:e}={}){const t=c.getProject();if(!t)return;T(t);const n=(t.chatSessions||[]).find(i=>i.id===e);if(!n)return;const o=document.getElementById("session-context-mode-modal"),s=document.getElementById("session-context-mode-session-id"),a=document.getElementById("session-context-mode-select"),r=document.getElementById("session-context-mode-title");!o||!s||!a||!r||(s.value=n.id,r.textContent=`Context Mode for "${n.name||"Untitled"}"`,a.value=ne(n.contextMode),!n.folderId&&a.value==="folder_aware"&&(a.value="session_only"),o.style.display="flex")}function ma(){const e=document.getElementById("session-context-mode-session-id")?.value||"",t=document.getElementById("session-context-mode-select")?.value||"folder_aware";if(e){if(t==="folder_aware"&&!(c.getProject()?.chatSessions||[]).find(s=>s.id===e)?.folderId){x("This session is not in a folder yet. Move it into a folder first.","Context Mode");return}c.bus.publish("session:contextMode",{sessionId:e,mode:t}),kn()}}function Je(e=!0,t=!0){document.querySelectorAll("[data-session-drop-target].is-drop-target").forEach(n=>n.classList.remove("is-drop-target")),document.querySelectorAll(".session-item.is-drop-before, .session-item.is-drop-after").forEach(n=>{n.classList.remove("is-drop-before"),n.classList.remove("is-drop-after")}),t&&document.querySelectorAll(".session-item.is-dragging").forEach(n=>n.classList.remove("is-dragging")),e&&(Y&&(clearTimeout(Y),Y=null),ke=null)}function Ut(e){const t=c.getProject();if(!t||!te)return null;const n=e.target.closest(".session-item[data-session-id]");if(n&&n.dataset.sessionId!==te){const r=(t.chatSessions||[]).find(u=>u.id===n.dataset.sessionId);if(!r||r.archived)return null;const i=n.getBoundingClientRect(),d=e.clientY<i.top+i.height/2?"before":"after";return{folderId:r.folderId||null,targetSessionId:r.id,position:d,dropElement:n}}const o=e.target.closest(".folder-session-list[data-folder-id]");if(o)return{folderId:o.dataset.folderId||null,targetSessionId:null,position:"after",dropElement:o};const s=e.target.closest(".session-folder[data-folder-id]");if(s)return{folderId:s.dataset.folderId||null,targetSessionId:null,position:"after",dropElement:s.querySelector(".folder-session-list")||s};const a=e.target.closest('#sessionListContainer[data-session-drop-target="root"]');return a?{folderId:null,targetSessionId:null,position:"after",dropElement:a}:null}function Se(){const e=c.getProject();if(!e)return;T(e),oe();const t=document.getElementById("pinnedSessionList"),n=document.getElementById("sessionListContainer"),o=document.getElementById("archivedSessionList"),s=document.getElementById("archivedSessionsSection");if(!t||!n||!o||!s)return;t.innerHTML="",n.innerHTML="",o.innerHTML="",n.dataset.sessionDropTarget="root",n.dataset.folderId="";const a=Array.isArray(e.chatSessions)?e.chatSessions:[],r=a.filter(g=>!g.archived),i=r.filter(g=>(g.pinned||g.isPinned)&&!g.folderId),d=r.filter(g=>!(g.pinned||g.isPinned)&&!g.folderId),u=a.filter(g=>g.archived);i.sort(We).forEach(g=>t.appendChild(Te(g,e))),(Array.isArray(e.chatFolders)?e.chatFolders:[]).forEach(g=>{const p=r.filter(h=>h.folderId===g.id).sort(We);n.appendChild(ta(g,p,e))}),d.sort(We).forEach(g=>{n.appendChild(Te(g,e))}),n.children.length===0&&(n.innerHTML='<p class="no-items-message">No sessions yet. Create your first chat.</p>'),u.sort((g,p)=>(p.updatedAt||0)-(g.updatedAt||0)).forEach(g=>o.appendChild(Te(g,e))),s.classList.toggle("hidden",u.length===0),vn(e.activeSessionId)}function pa({sessionId:e}={}){const t=c.getProject();if(!t)return;T(t);const n=e||t.activeSessionId,o=t.chatSessions?.find(r=>r.id===n);if(!o)return;const s=document.getElementById("session-info-modal"),a=document.getElementById("session-info-content");!s||!a||(a.innerHTML=sa(o,t),s.style.display="flex")}function Dt(e,t,n){if(e==="move"){ca({sessionId:t});return}if(e==="context-mode"){ua({sessionId:t});return}c.bus.publish(`session:${e}`,{sessionId:t,event:n})}function Ot(e,t){if(e==="folder:new-chat"){c.bus.publish("folder:newChat",{folderId:t});return}if(e==="folder:rename"){const n=c.getProject();if(!n)return;T(n);const o=H(n,t);rt({mode:"rename",folderId:t,defaultName:o?.name||""});return}if(e==="folder:settings"){c.bus.publish("folder:settings",{folderId:t});return}e==="folder:delete"&&c.bus.publish("folder:delete",{folderId:t})}function ga(){if(Bt)return;Bt=!0,c.bus.subscribe("project:loaded",Se),c.bus.subscribe("session:listChanged",Se),c.bus.subscribe("session:loaded",()=>vn(c.getProject()?.activeSessionId)),c.bus.subscribe("folder:settings",ra);const e=document.querySelector(".sessions-panel");e&&(e.addEventListener("click",r=>{const i=r.target,d=i.closest(".dropdown-content a[data-action]");if(d){r.preventDefault(),r.stopPropagation();const g=d.dataset.action,p=d.closest(".session-item[data-session-id]"),h=d.closest(".session-folder[data-folder-id]"),k=d.closest("#new-session-menu");p?Dt(g,p.dataset.sessionId,r):h?Ot(g,h.dataset.folderId):k&&(g==="new-chat"?c.bus.publish("session:new"):g==="new-folder"&&rt({mode:"create"})),d.closest(".dropdown.open")?.classList.remove("open","portal-open"),Ue();return}const u=i.closest('button[data-action="toggle-menu"]');if(u){r.preventDefault(),r.stopPropagation(),Qo(u);return}if(i.closest("#new-chat-btn")&&!i.closest("#new-session-menu")){c.bus.publish("session:new");return}const m=i.closest(".session-folder-summary");if(m){const g=m.closest(".session-folder[data-folder-id]");g?.dataset.folderId&&c.bus.publish("folder:activate",{folderId:g.dataset.folderId})}const f=i.closest(".session-item[data-session-id]");if(f){const g=f.dataset.sessionId;c.getProject().activeSessionId!==g&&me(g)}}),e.addEventListener("dragstart",r=>{const i=r.target.closest(".session-item[data-session-id]");i&&(te=i.dataset.sessionId,i.classList.add("is-dragging"),r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",te))}),e.addEventListener("dragend",()=>{te=null,Je()}),e.addEventListener("dragover",r=>{const i=Ut(r);!te||!i||(r.preventDefault(),Je(!1,!1),i.targetSessionId&&i.dropElement?.classList.contains("session-item")?i.dropElement.classList.add(i.position==="before"?"is-drop-before":"is-drop-after"):i.dropElement?.classList.add("is-drop-target"),Zo(r.target),r.dataTransfer.dropEffect="move")}),e.addEventListener("drop",r=>{const i=Ut(r);!te||!i||(r.preventDefault(),c.bus.publish("session:move",{sessionId:te,folderId:i.folderId,targetSessionId:i.targetSessionId,position:i.position}),te=null,Je())}),e.addEventListener("toggle",r=>{const i=r.target.closest(".session-folder[data-folder-id]");!i||r.target!==i||c.bus.publish("folder:collapse",{folderId:i.dataset.folderId,collapsed:!i.open})},!0)),document.addEventListener("click",r=>{const i=r.target.closest(".dropdown-content-portal a[data-action]");if(i){r.preventDefault(),r.stopPropagation();const d=i.closest(".dropdown-content-portal"),u=i.dataset.action,m=d?.dataset.sessionId||"",f=d?.dataset.folderId||"",g=d?.dataset.menuType||"";m?Dt(u,m,r):f?Ot(u,f):g==="new-session"&&(u==="new-chat"?c.bus.publish("session:new"):u==="new-folder"&&rt({mode:"create"})),oe();return}G&&!G.portal.contains(r.target)&&!G.button.contains(r.target)&&oe(),requestAnimationFrame(Ue)}),document.addEventListener("scroll",()=>{G&&oe()},!0),window.addEventListener("resize",()=>{G&&yn()});const t=document.getElementById("session-info-modal");t?.addEventListener("click",r=>{(r.target===t||r.target.closest(".modal-close-btn"))&&oa()});const n=document.getElementById("folder-settings-modal");n?.addEventListener("click",r=>{const i=r.target;if(i===n||i.closest(".modal-close-btn")){xn();return}i.closest("#folder-settings-save-btn")&&ia()}),n?.addEventListener("change",r=>{const i=r.target;(i?.id==="folder-settings-auto-shared-context"||i?.id==="folder-settings-auto-rag"||i?.id==="folder-settings-rag-scope")&&Sn()});const o=document.getElementById("folder-name-modal");o?.addEventListener("click",r=>{const i=r.target;if(i===o||i.closest(".modal-close-btn")){In();return}i.closest("#folder-name-save-btn")&&la()});const s=document.getElementById("session-move-modal");s?.addEventListener("click",r=>{const i=r.target;if(i===s||i.closest(".modal-close-btn")){En();return}if(i.closest("#session-move-save-btn")){da();return}if(i.closest("#session-move-create-folder-btn")){const u=(document.getElementById("session-move-new-folder-name")?.value||"").trim();if(!u){x("Please enter a folder name before creating.","Move Session");return}const m=kt({askName:!1,name:u});if(m?.id){const f=document.getElementById("session-move-folder-select");if(f){const p=document.createElement("option");p.value=m.id,p.textContent=m.name,f.insertBefore(p,f.children[1]||null),f.value=m.id}const g=document.getElementById("session-move-new-folder-name");g&&(g.value="")}}});const a=document.getElementById("session-context-mode-modal");a?.addEventListener("click",r=>{const i=r.target;if(i===a||i.closest(".modal-close-btn")){kn();return}i.closest("#session-context-mode-save-btn")&&ma()}),document.addEventListener("keydown",r=>{r.key==="Escape"&&G&&oe()}),console.log("âœ… Session UI initialized with folder support.")}const fa=(e="sid")=>`${e}_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,He=()=>c.getProject();function Ae(e,t){return!e||!t?null:e.chatSessions?.find(n=>n.id===t)||null}function ha(e,t=null){if(!e)return null;if(t&&H(e,t))return t;const n=Ae(e,e.activeSessionId);return n?.folderId&&H(e,n.folderId)?n.folderId:e.activeFolderId&&H(e,e.activeFolderId)?e.activeFolderId:null}function Ce(){c.bus.publish("session:listChanged"),c.bus.publish("studio:contentShouldRender")}function wa(e,t){return!e||!t||!t.type||!t.name?!1:t.type==="agent"?!!e.agentPresets?.[t.name]:t.type==="group"?!!e.agentGroups?.[t.name]:!1}function ya(e){const t=Object.keys(e?.agentPresets||{})[0];if(t)return{type:"agent",name:t};const n=Object.keys(e?.agentGroups||{})[0];return n?{type:"group",name:n}:null}function jn(e,t){const o=[t?.linkedEntity,e?.activeEntity,ya(e)].find(r=>wa(e,r));if(!o)return{entity:null,changed:!1};const s={type:o.type,name:o.name};let a=!1;return t&&(!t.linkedEntity||t.linkedEntity.type!==s.type||t.linkedEntity.name!==s.name)&&(t.linkedEntity={...s},a=!0),(!e.activeEntity||e.activeEntity.type!==s.type||e.activeEntity.name!==s.name)&&(e.activeEntity={...s},a=!0),{entity:s,changed:a}}function it(e,t=0){const n=Number(e?.sortIndex);return Number.isFinite(n)?n:t}function ba(e,t){const n=it(e)-it(t);return n!==0?n:(t?.updatedAt||0)-(e?.updatedAt||0)}function It(e,t,n=null){return(e?.chatSessions||[]).filter(o=>!o||o.archived||n&&o.id===n?!1:(o.folderId||null)===(t||null)).sort(ba)}function An(e,t){It(e,t).forEach((o,s)=>{o.sortIndex=s})}function Cn(e,t){const n=It(e,t);return n.length===0?0:Math.min(...n.map((s,a)=>it(s,a)))-1}function va(e,t,n,o=null,s="after"){const a=It(e,n,t.id);let r=a.length;if(o){const i=a.findIndex(d=>d.id===o);i>=0&&(r=s==="before"?i:i+1)}a.splice(r,0,t),a.forEach((i,d)=>{i.sortIndex=d})}function Et(e={}){const t=c.getProject();if(!t)return;T(t);const n=jn(t,{linkedEntity:t.activeEntity}).entity;if(!n){x("Cannot create chat session: no valid Agent/Group is available.","Error");return}const o=ha(t,e?.folderId||null),s=ne(e?.contextMode||Wn),a=W({...Jn,scopeSource:o?"folder":"session",...e?.ragSettings||{}}),r={id:`sid_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:"New Chat",history:[],composerContent:"",createdAt:Date.now(),updatedAt:Date.now(),pinned:!1,archived:!1,folderId:o,sortIndex:Cn(t,o),contextMode:s,linkedEntity:{...n},summaryState:{activeSummaryId:null,summarizedUntilIndex:-1},ragSettings:a,groupChatState:{isRunning:!1,awaitsUserInput:!1,turnQueue:[],currentJob:null,jobQueue:[],error:null}};t.chatSessions.unshift(r),t.activeSessionId=r.id,t.activeFolderId=o||null,c.setProject(t),me(r.id)}function me(e){const t=c.getProject();if(!t)return;if(T(t),!e){t.activeSessionId=null,t.activeFolderId=null,c.setProject(t),c.bus.publish("session:cleared");return}const n=t.chatSessions.find(s=>s.id===e);if(!n){console.warn(`Session with ID ${e} not found. Loading most recent as fallback.`);const s=[...t.chatSessions].filter(a=>!a.archived).sort((a,r)=>r.updatedAt-a.updatedAt)[0];me(s?s.id:null);return}const{entity:o}=jn(t,n);if(!o){x("Cannot load this session because it has no valid linked Agent/Group.","Error");return}n.contextMode=ne(n.contextMode),n.ragSettings=W(n.ragSettings,{scopeSource:n.folderId?"folder":"session"}),!n.folderId&&n.ragSettings.scopeSource==="folder"&&(n.ragSettings.scopeSource="session"),t.activeSessionId=e,t.activeFolderId=n.folderId||null,c.setProject(t),c.updateAndPersistState(),c.bus.publish("session:loaded",{session:n})}function xa({sessionId:e}){const t=c.getProject(),n=t?.chatSessions.find(s=>s.id===e);if(!n)return;const o=prompt("Enter new name:",n.name);o&&o.trim()&&o.trim()!==n.name&&(n.name=o.trim(),n.updatedAt=Date.now(),c.updateAndPersistState(),c.bus.publish("session:listChanged"),e===t.activeSessionId&&c.bus.publish("ui:updateChatTitle",{title:n.name}))}function kt(e={}){const t=c.getProject();if(!t)return null;T(t);const n=e?.name||Be(t.chatFolders,"New Folder"),s=e?.askName!==!1?prompt("Folder name:",n):n;if(!s||!s.trim())return null;const a=s.trim(),i=t.chatFolders.find(m=>m.name.toLowerCase()===a.toLowerCase())?Be(t.chatFolders,a):a,d=Date.now(),u={id:Xn(),name:i,color:"",createdAt:d,updatedAt:d,collapsed:!1,ragSettings:de(e?.ragSettings),contextPolicy:gt(e?.contextPolicy)};return t.chatFolders.unshift(u),t.activeFolderId=u.id,c.setProject(t),c.updateAndPersistState(),Ce(),u}function Sa({folderId:e,name:t}={}){const n=c.getProject();if(!n)return;T(n);const o=H(n,e);if(!o)return;const s=typeof t=="string"?t:prompt("Rename folder:",o.name);if(!s||!s.trim())return;const a=s.trim(),r=n.chatFolders.find(i=>i.id!==o.id&&i.name.toLowerCase()===a.toLowerCase());o.name=r?Be(n.chatFolders,a):a,o.updatedAt=Date.now(),c.setProject(n),c.updateAndPersistState(),Ce()}function Ia({folderId:e}){const t=c.getProject();if(!t)return;T(t);const n=H(t,e);!n||!confirm(`Delete folder "${n.name}"? Sessions will be moved to the main list.`)||(t.chatFolders=t.chatFolders.filter(s=>s.id!==e),t.chatSessions=t.chatSessions.map(s=>{if(s.folderId!==e)return s;const a=W(s.ragSettings,{scopeSource:"session"});return a.scopeSource="session",{...s,folderId:null,ragSettings:a}}),t.activeFolderId===e&&(t.activeFolderId=null),c.setProject(t),c.updateAndPersistState(),Ce())}function Ea({folderId:e,name:t,contextPolicy:n,ragSettings:o}={}){const s=c.getProject();if(!s)return;T(s);const a=H(s,e);if(a){if(typeof t=="string"&&t.trim()){const r=t.trim(),i=s.chatFolders.find(d=>d.id!==a.id&&d.name.toLowerCase()===r.toLowerCase());a.name=i?Be(s.chatFolders,r):r}n&&typeof n=="object"&&(a.contextPolicy=gt({...a.contextPolicy,...n})),o&&typeof o=="object"&&(a.ragSettings=de({...a.ragSettings,...o})),a.updatedAt=Date.now(),c.setProject(s),c.updateAndPersistState(),Ce()}}function ka({folderId:e}){const t=c.getProject();if(!t)return;T(t);const n=H(t,e);n&&(t.activeFolderId=n.id,c.setProject(t))}function ja({folderId:e,collapsed:t}){const n=c.getProject();if(!n)return;T(n);const o=H(n,e);o&&(o.collapsed=!!t,o.updatedAt=Date.now(),c.setProject(n))}function Aa({folderId:e}){Et({folderId:e})}function Fe({sessionId:e,folderId:t=null,targetSessionId:n=null,position:o="after"}={}){const s=c.getProject();if(!s)return;T(s);const a=Ae(s,e);if(!a)return;const r=a.folderId||null,i=t&&H(s,t)?t:null;a.folderId=i,a.updatedAt=Date.now(),i&&(a.pinned=!1),a.ragSettings=W(a.ragSettings,{scopeSource:i?a.ragSettings?.scopeSource:"session"}),!i&&a.ragSettings.scopeSource==="folder"&&(a.ragSettings.scopeSource="session"),s.activeSessionId===e&&(s.activeFolderId=i),va(s,a,i,n,o==="before"?"before":"after"),r!==i&&An(s,r),c.setProject(s),c.updateAndPersistState(),Ce()}function Ca({sessionId:e}){const t=c.getProject();if(!t)return;T(t);const n=Ae(t,e);if(!n)return;const o=t.chatFolders.map((d,u)=>`${u+1}. ${d.name}`).join(`
`),s=prompt([`Move "${n.name}" to:`,"0 = Main list (no folder)","n = Create new folder",o||"(No folders yet)"].join(`
`),n.folderId?String(t.chatFolders.findIndex(d=>d.id===n.folderId)+1):"0");if(s===null)return;const a=s.trim().toLowerCase();if(a==="n"){const d=kt({askName:!0});d&&Fe({sessionId:e,folderId:d.id});return}const r=Number.parseInt(a,10);if(!Number.isFinite(r)){x("Invalid folder selection.","Session Folder");return}if(r<=0){Fe({sessionId:e,folderId:null});return}const i=t.chatFolders[r-1];if(!i){x("Folder number not found.","Session Folder");return}Fe({sessionId:e,folderId:i.id})}function lt({sessionId:e,mode:t}){const n=c.getProject();if(!n)return;T(n);const o=Ae(n,e);if(!o)return;const s=ne(t);if(s==="folder_aware"&&!o.folderId){x("This session is not inside a folder yet. Move it into a folder first.","Context Mode");return}o.contextMode=s,o.updatedAt=Date.now(),c.setProject(n),c.updateAndPersistState(),c.bus.publish("session:listChanged")}function Pa({sessionId:e}){const t=c.getProject();if(!t)return;T(t);const n=Ae(t,e);if(!n)return;const s=ne(n.contextMode)==="session_only"?"2":"1",a=prompt([`Context mode for "${n.name}"`,"1 = Folder aware (recommended for sessions inside folder)","2 = Session only"].join(`
`),s);if(a===null)return;const r=a.trim();if(r==="1"){if(!n.folderId){x("This session is not inside a folder yet. Move it into a folder first.","Context Mode");return}lt({sessionId:e,mode:"folder_aware"})}else r==="2"?lt({sessionId:e,mode:"session_only"}):x("Invalid mode selection.","Context Mode")}async function Na({sessionId:e}){if(!confirm("Are you sure you want to delete this chat session? This cannot be undone."))return;const t=c.getProject();T(t);const n=t.chatSessions.findIndex(s=>s.id===e);if(n===-1)return;const o=t.chatSessions[n];if(t.chatSessions.splice(n,1),An(t,o?.folderId||null),await he(ie,"readwrite","delete",e),t.activeSessionId===e){const s=[...t.chatSessions].filter(a=>!a.archived).sort((a,r)=>r.updatedAt-a.updatedAt)[0];t.activeSessionId=s?s.id:null,t.activeFolderId=s?.folderId||null,me(t.activeSessionId)}else c.bus.publish("session:listChanged");c.updateAndPersistState()}function Ma(e,t){t?.stopPropagation();const n=He();T(n);const o=n?.chatSessions.find(s=>s.id===e);o&&(o.pinned=!o.pinned,o.updatedAt=Date.now(),c.updateAndPersistState(n),Se())}function La(e,t){t?.stopPropagation();const n=He();T(n);const o=n?.chatSessions.find(a=>a.id===e);if(!o){x("Error: Could not find session to clone.","Error");return}const s=JSON.parse(JSON.stringify(o));s.id=fa(),s.name=`${o.name} (Copy)`,s.createdAt=Date.now(),s.updatedAt=Date.now(),s.pinned=!1,s.archived=!1,s.sortIndex=Cn(n,s.folderId||null),s.contextMode=ne(s.contextMode),s.ragSettings=W(s.ragSettings,{scopeSource:s.folderId?s.ragSettings?.scopeSource:"session"}),!s.folderId&&s.ragSettings.scopeSource==="folder"&&(s.ragSettings.scopeSource="session"),n.chatSessions.unshift(s),n.activeSessionId=s.id,n.activeFolderId=s.folderId||null,c.updateAndPersistState(n),me(s.id)}function _a(e,t){t?.stopPropagation();const n=He();T(n);const o=n?.chatSessions.find(s=>s.id===e);if(o)if(o.archived=!o.archived,o.archived&&(o.pinned=!1),o.updatedAt=Date.now(),n.activeSessionId===e&&o.archived){const s=n.chatSessions.find(a=>!a.archived);n.activeSessionId=s?s.id:null,n.activeFolderId=s?.folderId||null,c.updateAndPersistState(n),me(n.activeSessionId)}else c.updateAndPersistState(n),Se()}async function Pn(e){const t=e||He()?.chatSessions;if(!t)return;const n=Qn();if(!n){console.error("[SaveAllSessions] Cannot save, DB not available.");return}const o=n.transaction(ie,"readwrite"),s=o.objectStore(ie);for(const a of t)s.put(a);return new Promise((a,r)=>{o.oncomplete=()=>a(),o.onerror=()=>r(o.error)})}function Ta(e){try{const t=c.getProject();if(!t)throw new Error("Project not found.");const n=e?.sessionId||t.activeSessionId;if(!n)throw new Error("No session is active or selected for download.");console.log(`Attempting to download session with ID: ${n}`);const o=t.chatSessions.find(m=>m.id===n);if(!o)throw new Error(`Session with ID ${n} could not be found.`);let s=`Chat Session: ${o.name||"Untitled Session"}
`;s+=`Exported on: ${new Date().toLocaleString()}
`,o.linkedEntity&&(s+=`Associated Entity: ${o.linkedEntity.name} (${o.linkedEntity.type})
`),s+=`============================================

`;const a=o.history||[];a.length===0?s+="[This session has no messages.]":a.forEach(m=>{const f=m.timestamp?Yn(m.timestamp):"No Timestamp",g=(m.speaker||m.role||"unknown").toUpperCase(),p=Array.isArray(m.content)?m.content.find(h=>h.type==="text")?.text||"[multimodal content]":m.content;s+=`[${f}] ${g}:
${p}

--------------------------------

`}),console.log(`Final text content length: ${s.length}`);const r=new Blob([s],{type:"text/plain;charset=utf-8"}),i=URL.createObjectURL(r),d=document.createElement("a"),u=(o.name||"untitled").replace(/[^a-z0-9]/gi,"_").toLowerCase();d.download=`session-export-${u}.txt`,d.href=i,document.body.appendChild(d),d.click(),setTimeout(()=>{document.body.removeChild(d),URL.revokeObjectURL(i),console.log("Download initiated and cleanup complete.")},100)}catch(t){console.error("Download Chat Session failed:",t),x(`Failed to download chat: ${t.message}`,"Error")}}function Fa({height:e}){const t=c.getProject(),n=t?.chatSessions.find(o=>o.id===t.activeSessionId);n&&e&&(n.composerHeight=e)}async function $a(){const e=c.getProject(),t=e?.chatSessions.find(n=>n.id===e.activeSessionId);if(!t){console.warn("[AutoSave] Could not find active session to save.");return}try{await he(ie,"readwrite","put",t)}catch(n){console.error(`[AutoSave] Failed to save active session (${t.id}):`,n)}}function Ba({sessionId:e,newName:t}){const n=c.getProject();if(!n)return;const o=n.chatSessions.find(s=>s.id===e);!o||o.name!=="New Chat"||(o.name=t,o.updatedAt=Date.now(),c.updateAndPersistState(),c.bus.publish("session:listChanged"),n.activeSessionId===e&&c.bus.publish("ui:updateChatTitle",{title:t}))}async function Ra(){const e=c.getProject();if(!e||!e.id)return console.warn("[AutoSave] Aborted: Project not available for saving."),!1;console.log("[AutoSave] Persisting essential data to IndexedDB...");try{return await Ke(),await $a(),console.log("[AutoSave] Essential project state successfully persisted."),!0}catch(t){return console.error("[AutoSave] Failed to persist project state:",t),!1}}function Ua(){let e;c.bus.subscribe("autosave:required",()=>{clearTimeout(e),e=setTimeout(async()=>{c.isAutoSaveDirty()&&await Ra()&&c.setAutoSaveDirty(!1)},2e3)})}function Da(){c.isUserDirty()?(c.setState("pendingActionAfterSave",()=>{document.getElementById("load-project-input").click()}),tn()):document.getElementById("load-project-input").click()}async function ct(){console.log("Proceeding with creating a new project...");try{const e=localStorage.getItem("lastActiveProjectId");e&&(await es(e),localStorage.removeItem("lastActiveProjectId"));const t=await fetch("/PromptPrim/default-project.prim");if(!t.ok)throw new Error(`Could not fetch default project file. Status: ${t.status}`);const n=await t.json(),o=ts();o&&o.systemAgentDefaults&&(n.globalSettings.systemUtilityAgent=o.systemAgentDefaults.utilityAgent,n.globalSettings.summarizationPromptPresets=o.systemAgentDefaults.summarizationPresets),n.globalSettings.summarizationPromptPresets={...re},n.id=`proj_${Date.now()}`,await ft(n.id),await ze(n,!0)}catch(e){console.error("Failed to proceed with creating a new project:",e),x("Could not create a new project. Please check the browser console for more details.","Error")}}function dt(){c.isUserDirty()?(c.setState("pendingActionAfterSave",ct),tn()):ct()}function Oa(e){const t=e.target.files[0];if(!t)return;console.log(`[OpenProject] File selected: ${t.name}. Reading file...`);const n=new FileReader;n.onload=async o=>{try{const s=o.target.result;console.log("[OpenProject] File read complete. Parsing JSON...");const a=JSON.parse(s);if(!a.id||!a.name)throw new Error("Invalid project file format.");console.log(`[OpenProject] JSON parsed successfully for project: ${a.name}. Loading data...`),await ze(a,!0)}catch(s){console.error("[OpenProject] Failed to load project:",s),x(`Error loading project: ${s.message}`,"Error")}},n.onerror=()=>{console.error("[OpenProject] FileReader error."),x("Failed to read the selected file.","Error")},n.readAsText(t),e.target.value=""}function qa(){try{const e=c.getState().pendingFileToOpen;if(!e)return;Ka(e),c.setState("pendingFileToOpen",null)}catch(e){console.error("Failed to proceed with opening project:",e),x("Could not open the project file.","Error")}}async function Nn(e=!1){const t=c.getProject();e||t.name==="Untitled Project"?c.bus.publish("ui:showSaveAsModal"):await Mn(t.name)}async function Mn(e){const t=e?.trim();if(!t)return x("Please enter a project name."),!1;const n=c.getProject();n.name=t,c.bus.publish("project:nameChanged",t),c.setUserDirty(!1);const o=JSON.parse(JSON.stringify(c.getProject())),s=Ln(o);try{const a=JSON.stringify(s,null,2),r=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(r),d=document.createElement("a");return d.download=`${t.replace(/[^a-z0-9\u0E00-\u0E7F]/gi,"_").toLowerCase()}.prim`,d.href=i,document.body.appendChild(d),d.click(),URL.revokeObjectURL(i),document.body.removeChild(d),c.bus.publish("ui:hideSaveAsModal"),c.setAutoSaveDirty(!1),await Wa(),c.getState().pendingActionAfterSave&&await za(),!0}catch(a){return console.error("Failed to save project:",a),x("Failed to save project file.","Error"),c.setUserDirty(!0),!1}}async function Ha(e){Zn();const t=c.getState().pendingActionAfterSave;switch(c.setState("pendingActionAfterSave",null),e){case"save":await Nn(!1);break;case"discard":typeof t=="function"&&await t();break}}async function za(){const e=c.getState().pendingActionAfterSave;c.setState("pendingActionAfterSave",null),e==="open"?await qa():e==="new"&&await ct()}async function Ka(e){const t=new FileReader;t.onload=async n=>{try{const o=JSON.parse(n.target.result);if(o&&o.id&&o.name&&o.agentPresets)await ze(o,!0),x(`Project '${o.name}' loaded successfully!`,"Project Loaded");else throw new Error("Invalid project file format.")}catch(o){x(`Error loading project: ${o.message}`,"Error"),console.error(o)}},t.readAsText(e)}async function Ga(e){if(!e)throw new Error("Cannot load last project: Project ID is missing.");await ft(e);const t=await he(ht,"readonly","get",nn);if(t&&t.data&&t.data.id===e){const n=t.data,o=await he(ie,"readonly","getAll"),s={...n,chatSessions:o||[]};await ze(s,!1),console.log("Successfully loaded the last active project from IndexedDB.")}else throw new Error("Project data in DB is invalid or mismatched with last known ID.")}async function ze(e,t=!1){let n=Ln(e);await ft(n.id),t&&(n.isDirtyForUser=!1),n.globalSettings&&(n.globalSettings.summarizationPromptPresets={...re,...n.globalSettings.summarizationPromptPresets||{}}),c.setProject(n),await Ja(),n.globalSettings.apiKey&&await je({apiKey:n.globalSettings.apiKey}),n=c.getProject(),(n.chatSessions||[]).filter(r=>!r.archived).length===0&&Et();const s=c.getProject();s.isDirtyForUser=!1,await Va(s);const a=s.chatSessions.find(r=>r.id===s.activeSessionId)||[...s.chatSessions].filter(r=>!r.archived).sort((r,i)=>i.updatedAt-r.updatedAt)[0];a&&me(a.id),c.bus.publish("project:loaded",{projectData:s}),c.bus.publish("userDirty:changed",!1),c.setAutoSaveDirty(!1),localStorage.setItem("lastActiveProjectId",s.id)}async function Va(e){await ss([ie,ht]),await Ke(e),await Pn(e.chatSessions),console.log("Database has been rewritten with new project data.")}async function Ke(e){const t=e||c.getProject();if(!t||!t.id){console.warn("Cannot persist metadata: project or project ID is missing.");return}const n={...t};delete n.chatSessions,await he(ht,"readwrite","put",{id:nn,data:n})}async function Wa(){const e=c.getProject();if(!e||!e.id)return!1;console.log("[AutoSave] Persisting project to IndexedDB...");try{return await Ke(),await Pn(),console.log("[AutoSave] Project state successfully persisted."),!0}catch(t){return console.error("[AutoSave] Failed to persist project state:",t),!1}}async function Ja(){const e=c.getProject();!e||!e.globalSettings||(c.bus.publish("ui:applyFontSettings"),console.log("Global settings loaded into state."))}function Ya(e){const t=c.getProject();t.globalSettings.fontFamilySelect=e,c.setProject(t),c.updateAndPersistState(),c.bus.publish("ui:applyFontSettings")}function Xa(){const e=c.getProject();if(!e.globalSettings)return;const t=e.globalSettings.systemUtilityAgent;t.model=document.getElementById("system-utility-model-select").value,t.systemPrompt=document.getElementById("system-utility-prompt").value;const n=c.getState().systemParameterEditor,o=n?n.getValues():{};Object.assign(t,o),c.setProject(e),c.updateAndPersistState(),x("System Agent settings saved!","Success")}function Ln(e){const n=ce()?.userName||"Unknown User";if(e.globalSettings.systemUtilityAgent=Object.assign({},ns,e.globalSettings.systemUtilityAgent),e.agentPresets)for(const r in e.agentPresets){const i=e.agentPresets[r],d=Object.assign({},qe,i);(!d.createdBy||d.createdBy==="Unknown User")&&(d.createdBy=n),d.createdAt||(d.createdAt=Date.now()),d.modifiedAt||(d.modifiedAt=d.createdAt),e.agentPresets[r]=d}if(e.isDirtyForUser===void 0&&(e.isDirtyForUser=!0),e.agentGroups)for(const r in e.agentGroups){const i=e.agentGroups[r];i&&!Array.isArray(i.agents)&&(i.agents=[])}if(Array.isArray(e.chatSessions)){const r=Object.keys(e.agentPresets||{})[0]||null,i=Object.keys(e.agentGroups||{})[0]||null,d=u=>u?.type==="agent"&&u?.name&&e.agentPresets?.[u.name]?{type:"agent",name:u.name}:u?.type==="group"&&u?.name&&e.agentGroups?.[u.name]?{type:"group",name:u.name}:r?{type:"agent",name:r}:i?{type:"group",name:i}:null;if(e.chatSessions=e.chatSessions.map(u=>{const m=u?.ragSettings||{},f=d(u?.linkedEntity);return{...u,linkedEntity:f,folderId:typeof u?.folderId=="string"&&u.folderId.trim()?u.folderId:null,contextMode:ne(u?.contextMode),ragSettings:W(m)}}),e.chatSessions.length>0){const u=e.chatSessions.find(m=>m.id===e.activeSessionId)||e.chatSessions[0];u?.linkedEntity&&(e.activeEntity={...u.linkedEntity})}}T(e),Array.isArray(e.knowledgeFiles)?e.knowledgeFiles=e.knowledgeFiles.map(r=>({id:r.id||`kf_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,name:r.name||"Untitled",type:r.type||"application/octet-stream",size:Number.isFinite(r.size)?r.size:0,uploadedAt:r.uploadedAt||Date.now(),source:r.source||"upload",status:r.status||"uploaded",textContent:typeof r.textContent=="string"?r.textContent:"",excerpt:typeof r.excerpt=="string"?r.excerpt:"",note:typeof r.note=="string"?r.note:"",lastModified:Number.isFinite(r.lastModified)?r.lastModified:0,chunkCount:Number.isFinite(r.chunkCount)?r.chunkCount:0,indexedAt:Number.isFinite(r.indexedAt)?r.indexedAt:null,embeddingModel:typeof r.embeddingModel=="string"?r.embeddingModel:""})):e.knowledgeFiles=[];const o=new Set(e.knowledgeFiles.map(r=>r.id));Array.isArray(e.chatSessions)&&(e.chatSessions=e.chatSessions.map(r=>({...r,ragSettings:{...r.ragSettings,selectedFileIds:(r.ragSettings?.selectedFileIds||[]).filter(i=>o.has(i))}}))),Array.isArray(e.chatFolders)&&(e.chatFolders=e.chatFolders.map(r=>({...r,ragSettings:{...r.ragSettings,selectedFileIds:(r.ragSettings?.selectedFileIds||[]).filter(i=>o.has(i))}})));const s={version:1,embeddingModel:"local-hash-v1",dimensions:128,updatedAt:Date.now(),chunks:[]};if(!e.knowledgeIndex||typeof e.knowledgeIndex!="object")e.knowledgeIndex={...s};else{const r=e.knowledgeIndex;e.knowledgeIndex={version:Number.isFinite(r.version)?r.version:s.version,embeddingModel:r.embeddingModel||s.embeddingModel,dimensions:Number.isFinite(r.dimensions)?r.dimensions:s.dimensions,updatedAt:Number.isFinite(r.updatedAt)?r.updatedAt:s.updatedAt,chunks:Array.isArray(r.chunks)?r.chunks.map((i,d)=>({id:i.id||`kc_${Date.now()}_${d}`,fileId:i.fileId||"",fileName:i.fileName||"Unknown",chunkIndex:Number.isFinite(i.chunkIndex)?i.chunkIndex:d,text:typeof i.text=="string"?i.text:"",charCount:Number.isFinite(i.charCount)?i.charCount:0,tokenEstimate:Number.isFinite(i.tokenEstimate)?i.tokenEstimate:0,vector:Array.isArray(i.vector)?i.vector:[],embeddingModel:i.embeddingModel||r.embeddingModel||s.embeddingModel,createdAt:Number.isFinite(i.createdAt)?i.createdAt:Date.now()})):[]}}const a=new Map;for(const r of e.knowledgeIndex.chunks)r.fileId&&a.set(r.fileId,(a.get(r.fileId)||0)+1);return e.knowledgeFiles=e.knowledgeFiles.map(r=>{const i=a.get(r.id)||0,d=r.status||"uploaded",u=d==="ready"?"indexed":d==="error"?"failed":d;return{...r,chunkCount:Number.isFinite(r.chunkCount)&&r.chunkCount>0?r.chunkCount:i,status:i>0&&!["failed","binary"].includes(u)?"indexed":u}}),e}async function Qa(e,t){c.setStagedEntity(null,!1);const n=c.getProject(),o=e==="agent"&&(t==="Visual Studio"||t.includes("KieAI")||t.includes("Veo")||t.includes("Flux")||t.includes("Wan")||t.includes("Seedance")),s=e==="agent"&&!!n.agentPresets?.[t]||e==="group"&&!!n.agentGroups?.[t];n.activeEntity={type:e,name:t};const a=n.chatSessions.find(r=>r.id===n.activeSessionId);a&&s&&(a.groupChatState&&(a.groupChatState.isRunning=!1),a.linkedEntity={...n.activeEntity},a.updatedAt=Date.now()),c.setProject(n),c.updateAndPersistState(),c.bus.publish("entity:selected",{type:e,name:t,isKieAI:o}),c.bus.publish("session:listChanged")}function Za({type:e,name:t}){const n={type:e,name:t},o=c.getStagedEntity(),s=c.getProject().activeEntity;if(o&&o.name===t&&o.type===e){c.bus.publish("entity:select",n);return}if(s&&s.name===t&&s.type===e){c.setStagedEntity(null);return}c.setStagedEntity(n)}async function er(){const e=document.getElementById("enhancer-prompt-input").value.trim();if(!e){x("Please describe the agent you want to create or enhance.","Error");return}const t=c.getProject().globalSettings.systemUtilityAgent;if(!t||!t.model){x("System Utility Model not configured in Settings.","Error");return}const n=document.getElementById("generate-agent-profile-btn");n&&n.classList.add("is-loading"),c.bus.publish("agent:enhancerStatus",{text:"Processing request...",color:"var(--text-dark)"});try{const o=!!c.getState().editingAgentName;let s="";o?s=`You are an expert in refining LLM system prompts. Your task is to modify an existing system prompt based on a user's new request. Do not replace the original prompt, but integrate the new instruction into it cohesively. Respond ONLY with the new, complete, and modified system prompt as a single block of text.

            EXISTING PROMPT:
            ---
            ${document.getElementById("agent-system-prompt").value}
            ---

            USER'S MODIFICATION REQUEST:
            ---
            ${e}
            ---

            NEW, MODIFIED SYSTEM PROMPT:`:s=`You are an expert in designing LLM agent profiles. Based on the user's request, create a complete agent profile.
            Your response MUST be ONLY a single, valid JSON object with these exact keys:
            - "agent_name": string
            - "agent_icon": string (a single emoji)
            - "system_prompt": string
            - "temperature": number (between 0 and 2)
            - "top_p": number (between 0 and 1)
            - "top_k": integer (0 or higher)
            - "max_tokens": integer (e.g., 4096)
            - "frequency_penalty": number (between -2 and 2)
            - "presence_penalty": number (between -2 and 2)
            - "seed": integer (-1 for random)

            User's Request: "${e}"`;const a=await os(t,[{role:"user",content:s}]);if(!a||typeof a.content!="string")throw new Error("Received an invalid or empty response from the AI.");if(o)c.bus.publish("agent:promptEnhanced",{newPrompt:a.content}),c.bus.publish("agent:enhancerStatus",{text:"Prompt enhanced successfully!",color:"var(--success-color)"});else{const r=a.content.match(/{.*}/s);if(!r)throw new Error("LLM did not return a valid JSON object.");const i=JSON.parse(r[0]);c.bus.publish("agent:profileGenerated",i),c.bus.publish("agent:enhancerStatus",{text:"Profile generated successfully!",color:"var(--success-color)"})}}catch(o){console.error("Agent Profile Generation/Enhancement Error:",o);const s=`Error: ${o.message}`;c.bus.publish("agent:enhancerStatus",{text:s,color:"var(--error-color)"}),x(s,"Profile Generation Failed")}finally{n&&n.classList.remove("is-loading"),setTimeout(()=>c.bus.publish("agent:enhancerStatus",{text:""}),5e3)}}function tr(){const e=c.getProject(),t=c.getState().editingAgentName,n=document.getElementById("agent-name-input").value.trim();if(!n){x("Please enter a name for the agent.","Error");return}if(t!==n&&e.agentPresets[n]){x(`An agent named '${n}' already exists.`,"Error");return}if(!document.getElementById("agent-model-select").value){x("You must select a model for the agent before saving.","Model Required");const u=document.getElementById("agent-model-search-wrapper");u&&(u.classList.add("has-warning"),setTimeout(()=>u.classList.remove("has-warning"),2e3));return}const s={icon:document.getElementById("agent-icon-button").textContent,description:document.getElementById("agent-description").value,model:document.getElementById("agent-model-select").value,systemPrompt:document.getElementById("agent-system-prompt").value,useMarkdown:document.getElementById("agent-use-markdown").checked,enableWebSearch:document.getElementById("agent-enable-web-search").checked,profilePicture:document.getElementById("agent-profile-picture-preview").src,tags:Array.from(document.querySelectorAll("#agent-tags-container .tag-pill")).map(u=>u.dataset.tag),activeMemories:Array.from(document.querySelectorAll("#agent-memory-list .item input:checked")).map(u=>u.closest(".item").dataset.memoryName)},a=c.getState().activeParameterEditor,r=a?a.getValues():{},i={...s,...r},d=t&&e.agentPresets[t]?{...e.agentPresets[t]}:{...qe,id:`agent_${Date.now()}`,createdBy:UserService.getCurrentUserProfile().userName,createdAt:Date.now()};d.modifiedAt=Date.now(),d.createdBy=document.getElementById("agent-created-by-input").value,Object.assign(d,i),t&&t!==n&&delete e.agentPresets[t],e.agentPresets[n]=d,(!t||e.activeEntity&&e.activeEntity.name===t)&&(e.activeEntity={type:"agent",name:n}),c.setProject(e),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender"),c.bus.publish("agent:editorShouldClose")}function nr(e){const t=c.getProject();if(!e||Object.keys(t.agentPresets).length<=1){x("Cannot delete the last agent.","Error");return}confirm(`Are you sure you want to delete the agent '${e}'? This action cannot be undone.`)&&(delete t.agentPresets[e],Object.values(t.agentGroups).forEach(n=>{n.agents=n.agents.filter(o=>o!==e),n.moderatorAgent===e&&(n.moderatorAgent=n.agents[0]||"")}),t.chatSessions.forEach(n=>{n.linkedEntity?.type==="agent"&&n.linkedEntity.name===e&&(n.linkedEntity={type:"agent",name:Object.keys(t.agentPresets)[0]})}),t.activeEntity.type==="agent"&&t.activeEntity.name===e&&(t.activeEntity={type:"agent",name:Object.keys(t.agentPresets)[0]}),c.setProject(t),c.updateAndPersistState(),c.bus.publish("agent:listChanged"),c.bus.publish("entity:selected",t.activeEntity))}async function sr(e){const t=c.getProject();t&&(t.globalSettings||(t.globalSettings={}),t.globalSettings.inlineAgentConfig=e,await Ke(t),c.updateAndPersistState(),x("Inline Agent configuration saved!","Success"),console.log("Saved Inline Agent Config:",e))}const ee=({label:e,placeholder:t,value:n,onChange:o})=>l.jsxs("div",{children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-400 tw-mb-2",children:e}),l.jsx("textarea",{rows:"3",placeholder:t||`Enter prompt for ${e}...`,className:"tw-w-full tw-bg-gray-100 dark:tw-bg-slate-700 tw-border tw-border-gray-300 dark:tw-border-slate-600 tw-rounded-md tw-p-2 tw-text-gray-800 dark:tw-text-gray-200 placeholder-gray-400 focus:tw-ring-blue-500 focus:tw-border-blue-500 tw-transition",value:n,onChange:o})]}),qt=({label:e,options:t})=>l.jsxs("div",{className:"tw-text-center",children:[l.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-400 tw-mb-2",children:e}),l.jsx("select",{className:"tw-bg-gray-200 hover:tw-bg-gray-300 dark:tw-bg-slate-600 dark:hover:tw-bg-slate-500 tw-text-gray-800 dark:tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded-lg tw-border tw-border-gray-300 dark:tw-border-slate-500",children:t.map(n=>l.jsx("option",{value:n,children:n},n))})]});function or({unmount:e,onSave:t,initialConfig:n={}}){const[o,s]=E.useState({system:n.system||"",continue:n.continue||"",revise:n.revise||"",expand:n.expand||"",shorten:n.shorten||"",rephrase:n.rephrase||"",styleTransfer:n.styleTransfer||"",translateTo:n.translateTo||"",userInstructions:n.userInstructions||""}),a=(i,d)=>{s(u=>({...u,[d]:i.target.value}))},r=()=>{typeof t=="function"&&t(o),e()};return Vn.createPortal(l.jsx("div",{className:"tw-fixed tw-inset-0 tw-z-[10000] tw-flex tw-items-center tw-justify-center tw-bg-gray-800 tw-bg-opacity-50 dark:tw-bg-opacity-70 tw-backdrop-blur-sm tw-p-4",children:l.jsxs("div",{className:"tw-bg-white dark:tw-bg-slate-800 tw-border tw-border-gray-200 dark:tw-border-slate-700 tw-rounded-xl tw-shadow-2xl tw-w-full tw-max-w-4xl tw-text-black dark:tw-text-white tw-flex tw-flex-col tw-max-h-[90vh]",children:[l.jsxs("div",{className:"tw-flex-shrink-0 tw-flex tw-items-center tw-justify-between tw-p-4 tw-border-b tw-border-gray-200 dark:tw-border-slate-700",children:[l.jsxs("h3",{className:"tw-text-lg tw-font-semibold tw-flex tw-items-center tw-gap-3",children:[l.jsx("span",{className:"material-symbols-outlined tw-text-blue-500 dark:tw-text-cyan-400",children:"smart_toy"}),"Configure Inline Agent"]}),l.jsx("button",{className:"tw-text-gray-400 hover:tw-text-gray-700 dark:hover:tw-text-white tw-transition-colors",onClick:e,children:"Ã—"})]}),l.jsxs("div",{className:"tw-flex-grow tw-p-6 tw-overflow-y-auto",children:[l.jsxs("div",{className:"tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-6",children:[l.jsxs("div",{className:"tw-flex tw-flex-col tw-gap-4",children:[l.jsx(ee,{label:"System Prompt",value:o.system,onChange:i=>a(i,"system")}),l.jsx(ee,{label:"Continue Prompt",value:o.continue,onChange:i=>a(i,"continue")}),l.jsx(ee,{label:"Revise Prompt",value:o.revise,onChange:i=>a(i,"revise")}),l.jsx(ee,{label:"Expand",value:o.expand,onChange:i=>a(i,"expand")}),l.jsx(ee,{label:"Shorten",value:o.shorten,onChange:i=>a(i,"shorten")})]}),l.jsxs("div",{className:"tw-flex tw-flex-col tw-gap-4",children:[l.jsx(ee,{label:"Rephrase",value:o.rephrase,onChange:i=>a(i,"rephrase")}),l.jsx(ee,{label:"Style Transfer",value:o.styleTransfer,onChange:i=>a(i,"styleTransfer")}),l.jsx(ee,{label:"Translate to",value:o.translateTo,onChange:i=>a(i,"translateTo")}),l.jsx(ee,{label:"User Instructions",placeholder:"Prefix instructions...",value:o.userInstructions,onChange:i=>a(i,"userInstructions")})]})]}),l.jsxs("div",{className:"tw-mt-6 tw-pt-5 tw-border-t tw-border-gray-200 dark:tw-border-slate-700 tw-flex tw-justify-center tw-gap-10 tw-items-center",children:[l.jsx(qt,{label:"Hotkey for LLM Request",options:["\\","/","|","F1"]}),l.jsx(qt,{label:"Hotkey for Confirm LLM",options:["=","END","INSERT",";"]}),"          "]})]}),l.jsxs("div",{className:"tw-flex-shrink-0 tw-flex tw-justify-end tw-gap-4 tw-p-4 tw-bg-gray-50 dark:tw-bg-slate-900/50 tw-rounded-b-xl tw-border-t tw-border-gray-200 dark:tw-border-slate-700",children:[l.jsx("button",{className:"tw-bg-white hover:tw-bg-gray-100 tw-text-gray-700 dark:tw-bg-slate-600 dark:hover:tw-bg-slate-500 dark:tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded-lg tw-border tw-border-gray-300 dark:tw-border-slate-500 tw-transition-colors",onClick:e,children:"Cancel"}),l.jsx("button",{className:"tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded-lg tw-transition-colors",onClick:r,children:"Save Configuration"})]})]})}),document.body)}const ar=on.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:e=>e.style.fontSize.replace(/['"]+/g,""),renderHTML:e=>e.fontSize?{style:`font-size: ${e.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:e=>({chain:t})=>t().setMark("textStyle",{fontSize:e+"px"}).run(),unsetFontSize:()=>({chain:e})=>e().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),rr=Fs.create({name:"pendingHighlight",addAttributes(){return{}},parseHTML(){return[{tag:"mark","data-pending":"true"}]},renderHTML({HTMLAttributes:e}){return["mark",bt(e,{"data-pending":"true"}),0]},addCommands(){return{setPendingHighlight:()=>({commands:e})=>e.setMark(this.name),togglePendingHighlight:()=>({commands:e})=>e.toggleMark(this.name),unsetPendingHighlight:()=>({commands:e})=>e.unsetMark(this.name)}}});function ir(){const e="Processing...",[t,n]=E.useState(0);return E.useEffect(()=>{const o=setInterval(()=>{n(s=>(s+1)%e.length)},150);return()=>clearInterval(o)},[e.length]),l.jsx("div",{className:"tw-fixed tw-inset-0 tw-z-[12000] tw-flex tw-items-center tw-justify-center tw-bg-slate-900/60 tw-backdrop-blur-sm",children:l.jsxs("div",{className:"tw-flex tw-items-center tw-gap-2 tw-bg-slate-800/80 tw-text-white tw-px-4 tw-py-2 tw-rounded-lg tw-shadow-xl",children:[l.jsx("div",{className:"tw-w-4 tw-h-4 tw-border-2 tw-border-white tw-border-t-transparent tw-rounded-full tw-animate-spin"}),l.jsx("div",{className:"tw-text-lg tw-font-semibold tw-flex",children:e.split("").map((o,s)=>l.jsxs("span",{className:`tw-transition-transform tw-duration-150 ${t===s?"tw-scale-125 tw-text-cyan-300":"tw-scale-100"}`,style:{display:"inline-block"},children:[o===" "?"Â ":o," "]},s))})]})})}const lr=on.create({name:"hotkey",addOptions(){return{shortcuts:[]}},addKeyboardShortcuts(){const e={};return this.options.shortcuts.forEach(({hotkey:t,command:n})=>{t&&n&&(e[t]=()=>(n({editor:this.editor}),!0))}),e}}),Ht={continue:`Instructions:
Continue the story below without repeating the story unless it is for literary effect. Include only the text you are adding. You should read what is before the tag and match the same style and tone, so the next text fits into the narrative properly.

Story: {{selection}}`,revise:`You will be doing a revision of text within the passage tags [passage][/passage]. You will include only text and not tags. Follow any instructions found in between [ ] inside of the passage.

[passage]{{selection}}[/passage]

Additional instructions for the revision if available (Ignore if not found):
{{instructions}}`,expand:`You are an expert prose editor...

<instructions>{#if instructions}{instructions}{#else}Expand the text further by fleshing out the details...{/if}</instructions>

Only return the expanded text, nothing else.

[passage]{{selection}}[/passage]`,shorten:`You are an expert prose editor...

{#if instructions}Shorten the prose to the following length: <instructions>{instructions}</instructions>{#else}Halve the length of the given prose.{/if}

Only return the condensed text, nothing else.

[passage]{{selection}}[/passage]`,rephrase:`You are an expert prose editor...

Rephrase it using the following instructions: <instructions>{instructions}</instructions>

Only return the rephrased text, nothing else.

[passage]{{selection}}[/passage]`,fromInstruction:`{{user_instructions}}

Read the story so far for context:
[STORY_CONTEXT]
{{story_context}}
[/STORY_CONTEXT]

Now, expand on the following scene beat:
[SCENE_BEAT]
{{selection}}
[/SCENE_BEAT]`};async function zt({action:e,editor:t,instructions:n=""}){if(!t)return;const{from:o,to:s,empty:a}=t.state.selection;let r=t.state.doc.textBetween(o,s," ");if(e==="continue"){if(o<=1){alert("Please type something first to continue.");return}r=t.state.doc.textBetween(0,o,`

`)}else if(a){alert("Please select text to revise.");return}let i=Ht[e].replace("{{selection}}",r).replace("{{instructions}}",n);console.log("Final Prompt:",i);const d=c.getProject(),u=d.activeEntity?.name,m=d.agentPresets[u];if(!m){alert("Please select an active agent first.");return}const f=m.systemPrompt,g=Ht[e];let p=g.replace("{{selection}}",r).replace("{{instructions}}",n);c.bus.publish("composer:promptConstructed",{systemPrompt:f,actionPrompt:g,userText:r}),c.bus.publish("composer:setLoading",{isLoading:!0});try{const j=(await en(m,[{role:"user",content:`${f}

${p}`}])).content.trim().split(`
`).filter(A=>A.trim()!=="").map(A=>`<p>${A}</p>`).join("");let w=t.state.tr;const y=o;e!=="continue"&&!a&&w.delete(o,s);const b=document.createElement("div");b.innerHTML=j;const _=zs.fromSchema(t.schema).parseSlice(b);w.replace(y,y,_);const S=w.selection.$head.pos,M=t.schema.marks.pendingHighlight.create();w.addMark(y,S,M),t.view.dispatch(w)}catch(h){console.error("Inline Agent Error:",h),alert(`An error occurred: ${h.message}`)}finally{c.bus.publish("composer:setLoading",{isLoading:!1})}}function cr({x:e,y:t,onSelectAction:n,hasPendingSuggestion:o}){const s=["Continue","Revise","Expand","Shorten","Rephrase","more..."],a=["Accept","Reject","Rerun"],r=(i,d)=>{i.stopPropagation(),n(d)};return l.jsxs("div",{className:"tw-fixed tw-bg-gray-200 dark:tw-bg-gray-700 tw-text-black dark:tw-text-white tw-rounded-md tw-shadow-lg tw-p-2 tw-flex tw-gap-4 tw-select-none",style:{top:t,left:e,zIndex:11e3},onClick:i=>i.stopPropagation(),children:[l.jsxs("div",{className:`tw-flex tw-flex-col ${o?"tw-opacity-40 tw-pointer-events-none":""}`,children:[l.jsx("div",{className:"tw-px-2 tw-py-1 tw-bg-blue-500 tw-text-white tw-font-bold tw-rounded-t-sm tw-text-sm",children:"Action"}),l.jsx("ul",{className:"tw-bg-white dark:tw-bg-gray-600 tw-p-1 tw-rounded-b-sm",children:s.map(i=>l.jsx("li",{className:"tw-px-3 tw-py-1 hover:tw-bg-blue-500 hover:tw-text-white tw-rounded tw-cursor-pointer tw-text-sm",onClick:d=>r(d,i),children:i},i))})]}),l.jsxs("div",{className:`tw-flex tw-flex-col ${o?"":"tw-opacity-40 tw-pointer-events-none"}`,children:[l.jsx("div",{className:"tw-px-2 tw-py-1 tw-bg-yellow-400 tw-text-black tw-font-bold tw-rounded-t-sm tw-text-sm",children:"Decisions"}),l.jsx("ul",{className:"tw-bg-white dark:tw-bg-gray-600 tw-p-1 tw-rounded-b-sm",children:a.map(i=>l.jsx("li",{className:"tw-px-3 tw-py-1 hover:tw-bg-blue-500 hover:tw-text-white tw-rounded tw-cursor-pointer tw-text-sm",onClick:d=>r(d,i),children:i},i))})]})]})}function dr({systemPrompt:e,actionPrompt:t,userText:n,isVisible:o,onClose:s}){return o?l.jsxs("div",{className:"tw-absolute tw-top-4 tw-right-4 tw-z-[12000] tw-w-80 tw-bg-slate-800 tw-text-white tw-rounded-lg tw-shadow-xl tw-border tw-border-slate-700 tw-flex tw-flex-col",children:[l.jsxs("div",{className:"tw-flex tw-items-center tw-justify-between tw-p-2 tw-bg-slate-700 tw-rounded-t-lg",children:[l.jsxs("h4",{className:"tw-text-sm tw-font-bold tw-flex tw-items-center tw-gap-2",children:[l.jsx("span",{className:"material-symbols-outlined tw-text-cyan-400",children:"bug_report"}),"Inline Agent Inspector"]}),l.jsx("button",{onClick:s,className:"tw-text-slate-400 hover:tw-text-white",children:"Ã—"})]}),l.jsxs("div",{className:"tw-p-3 tw-text-xs tw-overflow-y-auto tw-max-h-80",children:[l.jsxs("div",{className:"tw-mb-3",children:[l.jsx("p",{className:"tw-font-bold tw-text-yellow-400 tw-mb-1",children:"1. System Prompt:"}),l.jsx("pre",{className:"tw-whitespace-pre-wrap tw-bg-black/20 tw-p-2 tw-rounded-md tw-font-mono",children:e||"(Not available)"})]}),l.jsxs("div",{className:"tw-mb-3",children:[l.jsx("p",{className:"tw-font-bold tw-text-yellow-400 tw-mb-1",children:"2. Action Prompt (e.g., Continue):"}),l.jsx("pre",{className:"tw-whitespace-pre-wrap tw-bg-black/20 tw-p-2 tw-rounded-md tw-font-mono",children:t||"(Not available)"})]}),l.jsxs("div",{children:[l.jsx("p",{className:"tw-font-bold tw-text-yellow-400 tw-mb-1",children:"3. User Text (Selection/Context):"}),l.jsx("pre",{className:"tw-whitespace-pre-wrap tw-bg-black/20 tw-p-2 tw-rounded-md tw-font-mono",children:n||"(No text selected/available)"})]})]})]}):null}const ur=an.create({name:"instructionNode",group:"block",content:"block+",parseHTML(){return[{tag:'div[data-type="instruction-chunk"]'}]},renderHTML({HTMLAttributes:e}){return["div",bt(e,{"data-type":"instruction-chunk"}),0]},addCommands(){return{setInstructionNode:()=>({commands:e})=>e.insertContent({type:this.name,content:[{type:"paragraph"}]})}}}),mr=an.create({name:"suggestionNode",group:"block",content:"block+",addAttributes(){return{"data-status":{default:"pending"}}},parseHTML(){return[{tag:'div[data-type="suggestion-chunk"]',getAttrs:e=>({"data-status":e.getAttribute("data-status")||"pending"})}]},renderHTML({HTMLAttributes:e}){return["div",bt(e,{"data-type":"suggestion-chunk"}),0]},addProseMirrorPlugins(){return[new Ks({key:new Gs("suggestionAutoAccept"),appendTransaction:(e,t,n)=>{let o=n.tr,s=!1;return e.some(a=>a.docChanged)?(n.doc.nodesBetween(0,n.doc.content.size,(a,r)=>{if(a.type.name===this.name&&a.attrs["data-status"]==="pending"){const i=t.doc.nodeAt(r),d=!i||i.type.name!==this.name,u=!i||!i.content.eq(a.content);!d&&u&&(console.log("Change detected inside a pending suggestion. Accepting it."),o.setNodeMarkup(r,null,{...a.attrs,"data-status":"accepted"}),s=!0)}}),s?o:null):null}})]},addCommands(){return{setSuggestionNode:e=>({commands:t})=>t.insertContent({type:this.name,attrs:{"data-status":"pending"},content:e}),acceptSuggestion:()=>({state:e,dispatch:t})=>{const{selection:n}=e,o=n.$from.node(n.$from.depth);if(o&&o.type.name===this.name){const s=n.$from.start(n.$from.depth),a=s+o.nodeSize;return t(e.tr.replaceWith(s-1,a,o.content)),!0}return!1},rejectSuggestion:()=>({commands:e})=>e.deleteSelection()}}}),pr=({editor:e,onCollapse:t,onToggleMaximize:n,isMaximized:o,onExport:s,onToggleInspector:a})=>{if(!e)return null;const[r,i]=ae.useState(0),[d,u]=E.useState(!1),[m,f]=E.useState(!1);ae.useEffect(()=>{const h=()=>i(k=>k+1);return e.on("transaction",h),e.on("selectionUpdate",h),()=>{e.off("transaction",h),e.off("selectionUpdate",h)}},[e]);const g=h=>{const k=h.target.value;k?e.chain().focus().setFontSize(k).run():e.chain().focus().unsetFontSize().run()},p=e.getAttributes("textStyle").fontSize?.replace("px","")||"";return l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"composer-header tw-flex tw-items-center tw-justify-between tw-p-2 tw-border-b tw-border-gray-700 tw-flex-wrap tw-gap-y-2",children:[l.jsx("div",{className:"composer-title-area",children:l.jsxs("h3",{children:[l.jsx("span",{className:"material-symbols-outlined",children:"edit_square"})," Composer"]})}),l.jsxs("div",{className:"composer-tools-area tw-flex tw-flex-wrap",children:[l.jsxs("div",{className:"tw-flex tw-items-center tw-gap-x-1",children:[l.jsx("button",{onClick:()=>e.chain().focus().setParagraph().run(),className:e.isActive("paragraph")?"is-active":"",title:"Paragraph",children:"P"}),l.jsx("button",{onClick:()=>e.chain().focus().toggleHeading({level:1}).run(),className:e.isActive("heading",{level:1})?"is-active":"",title:"Heading 1",children:"H1"}),l.jsx("button",{onClick:()=>e.chain().focus().toggleHeading({level:2}).run(),className:e.isActive("heading",{level:2})?"is-active":"",title:"Heading 2",children:"H2"}),l.jsx("button",{onClick:()=>e.chain().focus().toggleHeading({level:1}).run(),className:e.isActive("heading",{level:3})?"is-active":"",title:"Heading 3",children:"H3"}),l.jsx("button",{onClick:()=>e.chain().focus().toggleHeading({level:2}).run(),className:e.isActive("heading",{level:4})?"is-active":"",title:"Heading 4",children:"H4"})]}),l.jsx("div",{className:"toolbar-divider"}),l.jsxs("div",{className:"tw-flex tw-items-center tw-gap-x-1",children:[l.jsxs("select",{onChange:g,value:p,className:"font-size-selector",children:[l.jsx("option",{value:"",children:"Default"}),l.jsx("option",{value:"12",children:"12px"}),l.jsx("option",{value:"14",children:"14px"}),l.jsx("option",{value:"16",children:"16px"}),l.jsx("option",{value:"18",children:"18px"}),l.jsx("option",{value:"20",children:"20px"}),l.jsx("option",{value:"24",children:"24px"}),l.jsx("option",{value:"32",children:"32px"})]}),l.jsx("button",{onClick:()=>e.chain().focus().toggleHighlight().run(),className:e.isActive("highlight")?"btn-icon small is-active":"btn-icon small",title:"Highlight Text",children:l.jsx("span",{className:"material-symbols-outlined",children:"ink_highlighter"})}),l.jsx("input",{type:"color",onInput:h=>e.chain().focus().setColor(h.target.value).run(),value:e.getAttributes("textStyle").color||"#000000",title:"Text Color"})]}),l.jsx("div",{className:"toolbar-divider"}),l.jsx("button",{onClick:()=>e.chain().focus().unsetColor().run(),title:"Reset Color",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_clear"})}),l.jsx("div",{className:"toolbar-divider"}),l.jsxs("div",{className:"tw-flex tw-items-center",children:[l.jsx("button",{onClick:()=>e.chain().focus().toggleBold().run(),className:e.isActive("bold")?"btn-icon small is-active":"btn-icon small",title:"Bold",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_bold"})}),l.jsx("button",{onClick:()=>e.chain().focus().toggleItalic().run(),className:e.isActive("italic")?"btn-icon small is-active":"btn-icon small",title:"Italic",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_italic"})}),l.jsx("button",{onClick:()=>e.chain().focus().toggleUnderline().run(),className:e.isActive("underline")?"btn-icon small is-active":"btn-icon small",title:"Underline",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_underlined"})}),l.jsx("button",{onClick:()=>e.chain().focus().toggleStrike().run(),className:e.isActive("strike")?"btn-icon small is-active":"btn-icon small",title:"Strikethrough",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_strikethrough"})})]}),l.jsx("div",{className:"toolbar-divider"}),l.jsx("button",{onClick:()=>e.chain().focus().setTextAlign("left").run(),className:e.isActive({textAlign:"left"})?"btn-icon small is-active":"btn-icon small",title:"Align Left",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_align_left"})}),l.jsx("button",{onClick:()=>e.chain().focus().setTextAlign("center").run(),className:e.isActive({textAlign:"center"})?"btn-icon small is-active":"btn-icon small",title:"Align Center",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_align_center"})}),l.jsx("button",{onClick:()=>e.chain().focus().setTextAlign("right").run(),className:e.isActive({textAlign:"right"})?"btn-icon small is-active":"btn-icon small",title:"Align Right",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_align_right"})}),l.jsx("div",{className:"toolbar-divider"}),l.jsx("button",{onClick:()=>e.chain().focus().toggleBlockquote().run(),className:e.isActive("blockquote")?"btn-icon small is-active":"btn-icon small",title:"Blockquote",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_quote"})}),l.jsx("button",{onClick:()=>e.chain().focus().toggleBulletList().run(),className:e.isActive("bulletList")?"btn-icon small is-active":"btn-icon small",title:"Bulleted List",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_list_bulleted"})}),l.jsx("button",{onClick:()=>e.chain().focus().toggleOrderedList().run(),className:e.isActive("orderedList")?"btn-icon small is-active":"btn-icon small",title:"Numbered List",children:l.jsx("span",{className:"material-symbols-outlined",children:"format_list_numbered"})})]}),l.jsxs("div",{className:"composer-actions tw-flex-shrink-0",children:[l.jsx("button",{className:"btn-icon",onClick:a,title:"Toggle Prompt Inspector",children:l.jsx("span",{className:"material-symbols-outlined",children:"bug_report"})}),l.jsx("button",{className:"btn-icon",onClick:t,title:"Collapse",children:l.jsx("span",{className:"material-symbols-outlined",children:"keyboard_arrow_down"})}),l.jsx("button",{className:"btn-icon",onClick:n,title:o?"Restore":"Maximize",children:l.jsx("span",{className:"material-symbols-outlined",children:o?"close_fullscreen":"fullscreen"})}),l.jsxs("div",{className:"dropdown align-right",children:[l.jsx("button",{className:"btn-icon",onClick:h=>h.currentTarget.parentElement.classList.toggle("open"),title:"More Actions",children:l.jsx("span",{className:"material-symbols-outlined",children:"more_vert"})}),l.jsxs("div",{className:"dropdown-content",children:[l.jsxs("a",{href:"#",onClick:h=>{h.preventDefault(),u(!0)},children:[l.jsx("span",{className:"material-symbols-outlined",children:"smart_toy"}),"Configure Inline Agent"]}),l.jsx("div",{className:"dropdown-divider"}),l.jsxs("a",{href:"#",onClick:h=>{h.preventDefault(),typeof s=="function"?s({html:e.getHTML(),text:e.getText(),editor:e}):console.warn("onExport is not a function")},children:[l.jsx("span",{className:"material-symbols-outlined",children:"save"}),"Export Content..."]})]})]})]})]}),d&&l.jsx(or,{unmount:()=>u(!1),onSave:sr,initialConfig:c.getProject()?.globalSettings?.inlineAgentConfig})]})};function gr({initialContent:e,onContentChange:t,onCollapse:n,onToggleMaximize:o,isMaximized:s,onExport:a,onReady:r}){const[i,d]=E.useState({visible:!1,x:0,y:0}),[u,m]=E.useState({isLoading:!1}),[f,g]=E.useState(!1),[p,h]=E.useState({isVisible:!1,systemPrompt:"",actionPrompt:"",userText:""}),[k,j]=E.useState(!1),w=S=>{S&&S.chain().focus().acceptSuggestion().run()},y=S=>{S&&S.chain().focus().rejectSuggestion().run()},b=$s({extensions:[Bs.configure({heading:{levels:[1,2,3,4]}}),Rs,Us.configure({placeholder:"à¸žà¸´à¸¡à¸žà¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸—à¸µà¹ˆà¸™à¸µà¹ˆ..."}),Ds.configure({types:["heading","paragraph"]}),Os,qs,ar,rr,ur,mr,lr.configure({shortcuts:[{hotkey:"\\",command:({editor:S})=>zt({action:"continue",editor:S})},{hotkey:"=",command:({editor:S})=>w(S)},{hotkey:"Mod-Shift-i",command:({editor:S})=>S.chain().focus().setInstructionNode().run()}]})],content:e||"",onUpdate:({editor:S})=>t(S.getHTML()),onTransaction:({editor:S})=>{g(S.isActive("suggestionNode",{"data-status":"pending"}))},onSelectionUpdate:({editor:S})=>{g(S.isActive("suggestionNode",{"data-status":"pending"}))},editorProps:{handleDOMEvents:{contextmenu:(S,M)=>(M.preventDefault(),d({visible:!0,x:M.clientX,y:M.clientY}),!0)}}});E.useEffect(()=>{const S=C=>h(N=>({...N,...C})),M=({isLoading:C})=>m({isLoading:C}),A=c.bus.subscribe("composer:promptConstructed",S),v=c.bus.subscribe("composer:setLoading",M);return()=>{A(),v()}},[]);const _=()=>{d({...i,visible:!1})};return E.useEffect(()=>(i.visible&&document.addEventListener("click",_,{once:!0}),()=>document.removeEventListener("click",_)),[i.visible]),E.useEffect(()=>{b&&e!==void 0&&b.getHTML()!==e&&b.commands.setContent(e||"",!1)},[e,b]),E.useEffect(()=>{b&&r&&r({appendContent:M=>{b&&(b.getText().trim().length>0&&b.chain().focus().insertContent("<hr>").run(),b.chain().focus().insertContent(M).run())}})},[b,r]),l.jsxs("div",{id:"composer-panel",className:"composer-panel tw-relative",children:[l.jsx(pr,{editor:b,onCollapse:n,onToggleMaximize:o,isMaximized:s,onExport:a,onToggleInspector:()=>h(S=>({...S,isVisible:!S.isVisible}))}),l.jsx(Hs,{editor:b,className:"composer-editor"}),u.isLoading&&l.jsx(ir,{}),i.visible&&l.jsx(cr,{x:i.x,y:i.y,hasPendingSuggestion:f,onSelectAction:S=>{const M=S.toLowerCase();["accept","reject","rerun"].includes(M)?(M==="accept"&&w(b),M==="reject"&&y(b)):zt({action:M.replace("...",""),editor:b}),_()}}),l.jsx(dr,{...p,onClose:()=>h(S=>({...S,isVisible:!1}))})]})}const fr=new Set(["black","#000","#000000","rgb(0,0,0)","rgba(0,0,0,1)","hsl(0,0%,0%)"]),hr=new Set(["transparent","rgba(0,0,0,0)","initial","inherit","unset","none"]);function wr(e=""){return String(e).trim().toLowerCase().replace(/\s+/g,"")}function _n(e="",{forExport:t=!1}={}){if(!e||typeof e!="string")return"";const n=document.createElement("div");return n.innerHTML=e,n.querySelectorAll("*").forEach(o=>{const s=o.getAttribute("style");if(s){const a=[];s.split(";").forEach(r=>{const[i,...d]=r.split(":"),u=d.join(":");if(!i||!u)return;const m=i.trim().toLowerCase(),f=u.trim(),g=wr(f);t&&(m==="color"||m==="background-color")||!t&&m==="color"&&fr.has(g)||!t&&m==="background-color"&&hr.has(g)||a.push(`${m}: ${f}`)}),a.length?o.setAttribute("style",a.join("; ")):o.removeAttribute("style")}t&&(o.removeAttribute("color"),o.removeAttribute("bgcolor"))}),n.innerHTML}function Tn(e=""){return _n(e,{forExport:!1})}function Kt(e="",t=""){if(String(t||"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim())return!0;if(!e||typeof e!="string")return!1;const o=document.createElement("div");return o.innerHTML=e,String(o.textContent||"").replace(/\u00A0/g," ").replace(/[\u200B-\u200D\uFEFF]/g,"").trim()?!0:!!o.querySelector("img,video,audio,iframe,canvas,svg,math,hr,table,pre,code,blockquote,ul,ol,li")}function yr(e){const t=c.getProject(),n=t?.chatSessions.find(s=>s.id===t.activeSessionId),o=Tn(e);n&&n.composerContent!==o&&(n.composerContent=o,c.updateAndPersistState())}function br(e){const t=document.createElement("div");t.innerHTML=_n(e||"",{forExport:!0});const n=new Set(["font-size","text-align"]);return t.querySelectorAll("*").forEach(o=>{const s=o.getAttribute("style");if(s){const a=[];s.split(";").forEach(r=>{const[i,d]=r.split(":");if(!i||!d)return;const u=i.trim().toLowerCase(),m=d.trim();n.has(u)&&m&&a.push(`${u}: ${m}`)}),a.length?o.setAttribute("style",a.join("; ")):o.removeAttribute("style")}if(o.classList&&o.classList.length>0){const a=[];o.classList.forEach(r=>{(r.startsWith("hljs")||r.startsWith("language-"))&&a.push(r)}),o.className=a.join(" ")}}),t.innerHTML}function Fn({html:e="",text:t=""}={}){try{const n=typeof e=="string"?e:"",o=typeof t=="string"?t:"",s=c.getProject(),a=s?.chatSessions.find(y=>y.id===s.activeSessionId),r=a?.name||"Untitled Composer",i=typeof a?.composerContent=="string"?a.composerContent:"";if(!Kt(n,o)){Kt(i,"")||x("Composer is empty. Nothing to export.","Export Composer");return}const d=n.trim(),u=new Date,m=`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}-${String(u.getDate()).padStart(2,"0")}_${String(u.getHours()).padStart(2,"0")}${String(u.getMinutes()).padStart(2,"0")}`,g=`${r.replace(/[^a-z0-9\u0E00-\u0E7F]/gi,"_").toLowerCase()}_${m}.html`,h=`<!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8">
    <title>Composer Export</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.65;
            padding: 24px;
            max-width: 860px;
            margin: auto;
            background: #ffffff;
            color: #111827;
        }
            .composer-export-content {
                background: #ffffff;
                color: #111827;
            }
            h1,h2,h3 { line-height: 1.25; margin: 1.2em 0 0.6em; }
            p { margin: 0.6em 0; }
            blockquote { margin: 1em 0; padding-left: 0.9rem; border-left: 3px solid #999; font-style: italic; opacity: .95; }
            ul,ol { padding-left: 1.2em; margin: 0.6em 0; }
            pre {
                background-color: #f6f8fa;
                padding: 16px;
                border-radius: 6px;
                overflow-x: auto;
            }
            code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
            mark { background-color: #ffeb3b; padding: 0 2px; border-radius: 2px; }
    </style>
        </head>
        <body>
        <article class="composer-export-content">${br(d)}</article>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script>
            <script>
            if (window.hljs && typeof window.hljs.highlightAll === 'function') {
                window.hljs.highlightAll();
            }
            <\/script>
        </body>
    </html>`,k=new Blob([h],{type:"text/html;charset=utf-8"}),j=URL.createObjectURL(k),w=document.createElement("a");w.href=j,w.download=g,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(j)}catch(n){console.error("exportComposerContent error:",n),x("Export failed. See console for details.","Error")}}const ge=document.getElementById("composer-panel"),vr=document.getElementById("resizer-row"),$e=document.querySelector(".main-content-wrapper"),Ye=document.querySelector(".main-chat-area");function xr(e,t){if(!ge)return;const n={initialContent:e,isMaximized:t,onContentChange:yr,onCollapse:()=>J("collapsed"),onToggleMaximize:()=>{const o=$e.classList.contains("composer-maximized");J(o?"normal":"maximized")},onExport:o=>{const s=typeof o?.html=="string"?o.html:"",a=typeof o?.text=="string"?o.text:"";Fn({html:s,text:a}),c.bus.publish("composer:export")},onReady:o=>{c.setState("composerApi",o)}};ue.mount(gr,n,ge),wn(vr,ge)}function Sr(){ue.unmount(ge),c.setState("composerApi",null)}function J(e){if(!ge||!$e||!Ye)return;$e.classList.remove("composer-maximized"),Ye.classList.remove("composer-is-active"),ge.classList.remove("collapsed");const t=c.getProject(),n=t?.chatSessions.find(a=>a.id===t.activeSessionId),o=n?.composerContent||"",s=Tn(o);switch(n&&o!==s&&(n.composerContent=s,c.updateAndPersistState()),e){case"collapsed":Sr(),ge.classList.add("collapsed");break;case"normal":case"maximized":Ye.classList.add("composer-is-active"),e==="maximized"&&$e.classList.add("composer-maximized"),xr(s,e==="maximized");break}localStorage.setItem("promptPrimComposerState",e),c.bus.publish("composer:visibilityChanged")}document.getElementById("mobile-composer-toggle");function Ir(e){const t=document.querySelector("#composer-editor .composer-content-area");t&&(t.innerHTML="")}const $n="agent-emoji-picker",Er="agent-emoji-picker-host",pe="emoji-picker-collapsed",kr="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js";let Ie=null;function jr(e,t){const o=c.getProject().activeEntity,s=c.getStagedEntity(),a=document.createElement("div");return a.className="item agent-item",a.dataset.agentName=e,o?.type==="agent"&&o.name===e?a.classList.add("active"):s?.type==="agent"&&s.name===e&&a.classList.add("staged"),a.innerHTML=`
    <div class="item-header">
        <span class="item-name"><span class="item-icon">${t.icon||"ðŸ¤–"}</span> ${e}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="agent:edit" title="Edit Agent">
                <span class="material-symbols-outlined">edit</span>
            </button>             
            <button class="btn-icon danger" data-action="agent:delete" title="Delete Agent">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,a}function Ar(e,t){if(!e)return;const n=e.querySelector(".agent-presets-section");n&&n.remove(),e.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section agent-presets-section" open>
            <summary class="section-header">
                <h3>ðŸ¤– Agent Presets</h3>
                <button class="btn-icon" data-action="agent:create" title="Create New Agent">+</button>
            </summary>
            <div class="section-box">
                <div id="agentPresetList" class="item-list"></div>
            </div>
        </details>`);const s=e.querySelector("#agentPresetList");if(s){if(!t||t.length===0){s.innerHTML='<p class="no-items-message">No agents found.</p>';return}t.forEach(a=>{s.appendChild(jr(a.name,a))})}}function Bn(e=[]){const t=document.getElementById("agent-tags-container"),n=document.getElementById("agent-tags-input");!t||!n||(t.querySelectorAll(".tag-pill").forEach(o=>o.remove()),(e||[]).forEach(o=>{const s=document.createElement("div");s.className="tag-pill",s.textContent=o,s.dataset.tag=o;const a=document.createElement("span");a.className="remove-tag",a.innerHTML="&times;",a.onclick=()=>s.remove(),s.appendChild(a),t.insertBefore(s,n)}))}function Cr(e=[]){const n=c.getProject().memories||[],o=document.getElementById("agent-memory-list");if(o){if(o.innerHTML="",n.length===0){o.innerHTML='<p class="no-items-message">Create memories first.</p>';return}n.forEach(s=>{const a=(e||[]).includes(s.name),r=document.createElement("div");r.className="item",r.dataset.memoryName=s.name,r.innerHTML=`<span class="item-name">${s.name}</span><label class="switch"><input type="checkbox" ${a?"checked":""}><span class="slider round"></span></label>`,o.appendChild(r)})}}function Pr(e){const t=document.querySelector('#agent-editor-modal .tab-content[data-tab-content="system"]');t&&t.classList.toggle("is-locked",e)}function Rn(){const e=document.getElementById("enhancer-model-name"),t=c.getProject();if(!e||!t)return;const n=t.globalSettings.systemUtilityAgent;if(n&&n.model){const o=[...c.getState().systemProviderModels||[],...c.getState().userProviderModels||[]];if(o.length===0){e.textContent=n.model;return}const s=o.find(a=>a.id===n.model);e.textContent=s?s.name:n.model}else e.textContent="N/A"}function jt(){return document.getElementById($n)}function Nr(){return window.customElements?.get("emoji-picker")?Promise.resolve(!0):Ie||(Ie=new Promise((e,t)=>{const n=document.createElement("script");n.type="module",n.src=kr,n.onload=()=>e(!0),n.onerror=()=>t(new Error("Could not load emoji picker library.")),document.body.appendChild(n)}).catch(e=>{throw Ie=null,e}),Ie)}function Mr(e){e&&(document.body.classList.contains("dark-mode")?(e.classList.add("dark"),e.classList.remove("light")):(e.classList.add("light"),e.classList.remove("dark")))}function Un(){jt()?.classList.add(pe)}async function Lr(e){await Nr();let t=jt();if(!t){const n=document.getElementById(Er);if(!n)return null;t=document.createElement("emoji-picker"),t.id=$n,t.className=`light ${pe}`,n.appendChild(t)}return t.dataset.listenerAttached!=="true"&&(t.addEventListener("emoji-click",n=>{const o=n?.detail?.emoji?.unicode;o&&(e.textContent=o,Un())}),t.dataset.listenerAttached="true"),t}function Gt(){const e=c.getState().activeParameterEditor;e&&typeof e.destroy=="function"&&(e.destroy(),c.setState("activeParameterEditor",null)),Un(),document.getElementById("agent-editor-modal").style.display="none",c.setState("editingAgentName",null)}function Vt(e=!1,t=null){const n=document.getElementById("agent-editor-modal");if(!n)return;c.setState("editingAgentName",e?t:null);const o=c.getProject(),s=e&&o.agentPresets[t]?o.agentPresets[t]:qe;n.querySelectorAll(".tab-btn, .tab-content").forEach(h=>h.classList.remove("active")),n.querySelector('.tab-btn[data-tab="config"]')?.classList.add("active"),n.querySelector('.tab-content[data-tab-content="config"]')?.classList.add("active");const a=n.querySelector('.tab-content[data-tab-content="system"]');a&&(a.dataset.rendered="false");const r=document.getElementById("agent-profile-picture-preview");r&&(r.src=s.profilePicture||"/PromptPrim/icon.png"),document.getElementById("agent-name-input").value=e?t:"New Agent",document.getElementById("agent-icon-button").textContent=s.icon||"ðŸ¤–",document.getElementById("agent-id-display").value=s.id||`agent_${Date.now()}`,document.getElementById("agent-description").value=s.description||"",as("agent-model-search-wrapper",s.model,Le()),document.getElementById("agent-system-prompt").value=s.systemPrompt,document.getElementById("agent-use-markdown").checked=s.useMarkdown,document.getElementById("agent-enable-web-search").checked=s.enableWebSearch;const i=document.getElementById("agent-params-container");if(i){const k=Le().find(y=>y.id===s.model),j=k?k.provider:"openrouter",w=rn(i,s,j);c.setState("activeParameterEditor",w)}const d=document.getElementById("agent-created-by-input");d&&(d.value=e?s.createdBy||"Unknown":ce().userName);const u=document.getElementById("agent-created-date");u&&(u.textContent=s.createdAt?new Date(s.createdAt).toLocaleString():"Not saved yet");const m=document.getElementById("agent-modified-date");m&&(m.textContent=s.modifiedAt?new Date(s.modifiedAt).toLocaleString():"Not saved yet"),Bn(s.tags),Cr(s.activeMemories),Pr(s.type==="third-party"),Rn();const f=document.getElementById("agent-model-warning"),g=document.getElementById("agent-model-warning-text"),p=document.getElementById("agent-model-search-wrapper");if(f&&g&&p){const k=Le().some(j=>j.id===s.model);e&&s.model&&!k?(g.innerHTML=`<strong>Model Not Found:</strong> The original model (<code>${s.model}</code>) could not be found. Please select a new model.`,f.classList.remove("hidden"),p.classList.add("has-warning")):(f.classList.add("hidden"),p.classList.remove("has-warning"))}n.style.display="flex"}function _r(){const e=document.getElementById("agent-editor-modal");if(!e)return;e.querySelector(".tab-buttons")?.addEventListener("click",i=>{const d=i.target.closest(".tab-btn");if(!d)return;const u=d.dataset.tab;e.querySelectorAll(".tab-btn, .tab-content").forEach(m=>m.classList.remove("active")),d.classList.add("active"),e.querySelector(`.tab-content[data-tab-content="${u}"]`)?.classList.add("active")}),e.addEventListener("click",i=>{const d=i.target;if(d.matches(".modal-actions .btn:not(.btn-secondary)"))c.bus.publish("agent:save");else if(d.closest("#generate-agent-profile-btn"))c.bus.publish("agent:generateProfile");else if(d.matches(".btn-secondary")||d.closest(".modal-close-btn"))Gt();else if(d.closest("#agent-id-copy-btn")){const u=document.getElementById("agent-id-display");navigator.clipboard.writeText(u.value)}});const n=document.getElementById("agent-tags-input");n?.addEventListener("keydown",i=>{if(i.key==="Enter"){i.preventDefault(),i.stopPropagation();const d=n.value.trim();if(d){const u=Array.from(document.querySelectorAll("#agent-tags-container .tag-pill")).map(m=>m.dataset.tag);u.includes(d)||Bn([...u,d]),n.value=""}}});const o=document.getElementById("agent-icon-button");o&&(o.addEventListener("click",async i=>{i.stopPropagation();let d=null;try{d=await Lr(o)}catch(m){console.error(m),x("Failed to load emoji picker. Please try again.","Error");return}if(!d)return;Mr(d),d.classList.contains(pe)?requestAnimationFrame(()=>{d.classList.remove(pe)}):d.classList.add(pe)}),document.addEventListener("click",i=>{const d=jt();d&&!d.classList.contains(pe)&&!d.contains(i.target)&&i.target!==o&&d.classList.add(pe)}));const s=document.getElementById("agent-profile-picture-upload"),a=document.getElementById("agent-profile-picture-preview");s&&a&&s.addEventListener("change",i=>{const d=i.target.files?.[0];if(!d)return;if(!d.type.startsWith("image/")){x("Please select an image file (e.g., PNG, JPG, WEBP).","Unsupported File");return}const u=2*1024*1024;if(d.size>u){x("The selected image is too large. Please select a file smaller than 2MB.","File Too Large");return}const m=new FileReader;m.onload=f=>{a.src=f.target?.result||""},m.readAsDataURL(d)}),c.bus.subscribe("agent:editorShouldClose",Gt);const r=()=>{e&&e.style.display==="flex"&&Rn()};c.bus.subscribe("models:loaded",r),c.bus.subscribe("user:modelsLoaded",r),c.bus.subscribe("agent:profileGenerated",i=>{if(!i)return;document.getElementById("agent-name-input").value=i.agent_name||"",document.getElementById("agent-icon-button").textContent=i.agent_icon||"ðŸ¤–",document.getElementById("agent-system-prompt").value=i.system_prompt||"";const d=c.getState().editingAgentName,u=c.getProject(),m=d?u.agentPresets[d]:qe,f={...m,temperature:i.temperature??m.temperature,topP:i.top_p??m.topP,topK:i.top_k??m.topK,max_tokens:i.max_tokens??m.max_tokens,frequency_penalty:i.frequency_penalty??m.frequency_penalty,presence_penalty:i.presence_penalty??m.presence_penalty,seed:i.seed??m.seed},g=document.getElementById("agent-params-container");if(g){const p=c.getState().activeParameterEditor;p&&p.destroy();const k=rn(g,f,"openrouter");c.setState("activeParameterEditor",k)}}),c.bus.subscribe("agent:promptEnhanced",({newPrompt:i})=>{const d=document.getElementById("agent-system-prompt");d&&(d.value=i)}),console.log("âœ… Agent UI Initialized with Full Profile Generation Logic.")}function Tr({unmount:e,groupData:t,allAgents:n,onSave:o}){const[s,a]=E.useState(""),[r,i]=E.useState([]),[d,u]=E.useState("manual"),[m,f]=E.useState(""),[g,p]=E.useState(""),[h,k]=E.useState(1),[j,w]=E.useState(0),y=E.useRef(null);E.useEffect(()=>{if(t){a(t.name||"");const v=(t.agents||[]).filter(C=>n&&n.hasOwnProperty(C));i(v),u(t.flowType||"manual"),f(t.moderatorAgent||""),k(t.maxTurns||1),w(t.timerInSeconds||0)}else a("New Group"),i([]),u("manual"),f(""),k(1),w(0)},[t,n]),E.useEffect(()=>{m&&!r.includes(m)&&f("")},[r,m]),E.useEffect(()=>{if(y.current){const v=Vs.create(y.current,{animation:150,handle:".agent-sortable-item",onEnd:C=>{const N=[...r],[$]=N.splice(C.oldIndex,1);N.splice(C.newIndex,0,$),i(N)}});return()=>v.destroy()}},[r]);const b=v=>{const C=r.includes(v);i(C?N=>N.filter($=>$!==v):N=>[...N,v])},_=()=>{o({name:s,members:r,flowType:d,moderator:m,maxTurns:h,timerInSeconds:j})},{selectedList:S,availableList:M}=E.useMemo(()=>{const v=g.toLowerCase(),C=Object.keys(n),N=new Set(r),$=r.filter(Q=>Q.toLowerCase().includes(v)),O=C.filter(Q=>!N.has(Q)&&Q.toLowerCase().includes(v)).sort();return{selectedList:$,availableList:O}},[g,n,r]),A=r.map(v=>l.jsx("option",{value:v,children:v},v));return l.jsx("div",{id:"agent-group-editor-modal",className:"modal-overlay",style:{display:"flex"},children:l.jsxs("div",{className:"modal-box is-resizable",children:[l.jsxs("div",{className:"modal-header",children:[l.jsx("h3",{id:"agent-group-modal-title",children:t?`Edit Group: ${s}`:"Create New Agent Group"}),l.jsx("button",{type:"button",className:"modal-close-btn",title:"Close",onClick:e,children:"Ã—"})]}),l.jsxs("div",{className:"modal-body",style:{display:"flex",flexDirection:"column"},children:[l.jsxs("div",{className:"form-group",children:[l.jsx("label",{htmlFor:"group-name-input",children:"Group Name"}),l.jsx("input",{type:"text",id:"group-name-input",value:s,onChange:v=>a(v.target.value)})]}),l.jsxs("div",{className:"form-group",children:[l.jsx("label",{htmlFor:"group-flow-select",children:"Conversation Flow"}),l.jsxs("select",{id:"group-flow-select",value:d,onChange:v=>u(v.target.value),children:[l.jsx("option",{value:"manual",children:"Manual Selection"}),l.jsx("option",{value:"round-robin",children:"Round Robin"}),l.jsx("option",{value:"auto-moderator",children:"Automated Moderator"})]})]}),d==="round-robin"&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{htmlFor:"group-max-turns-input",children:"Rounds (1-8)"}),l.jsx("input",{type:"number",id:"group-max-turns-input",value:h,onChange:v=>k(Math.max(1,Math.min(8,parseInt(v.target.value,10)))),min:"1",max:"8"})]}),d==="auto-moderator"&&l.jsxs("div",{className:"form-group",children:[l.jsx("label",{htmlFor:"group-timer-input",children:"Timer (0-180 seconds)"}),l.jsx("input",{type:"number",id:"group-timer-input",value:j,onChange:v=>w(parseInt(v.target.value,10)),min:"0",max:"180",step:"10"}),l.jsx("p",{className:"modal-warning",children:"à¹ƒà¸ªà¹ˆ 0 à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ Moderator à¸—à¸³à¸‡à¸²à¸™à¸£à¸­à¸šà¹€à¸”à¸µà¸¢à¸§à¹à¸¥à¹‰à¸§à¸«à¸¢à¸¸à¸” (à¹‚à¸«à¸¡à¸”à¸›à¸à¸•à¸´)"})]}),l.jsxs("div",{className:"form-group",children:[l.jsx("label",{htmlFor:"group-moderator-select",children:"Moderator Agent"}),l.jsxs("select",{id:"group-moderator-select",value:m,onChange:v=>f(v.target.value),disabled:r.length===0,children:[l.jsx("option",{value:"",children:"-- Select from members --"}),A]})]}),l.jsxs("div",{className:"form-group",style:{display:"flex",flexDirection:"column"},children:[l.jsxs("label",{children:["Group Members (",r.length," selected)"]}),l.jsx("input",{type:"text",placeholder:"Search agents...",value:g,onChange:v=>p(v.target.value),style:{marginBottom:"10px"}}),l.jsxs("div",{id:"group-member-list",children:[l.jsx("div",{ref:y,children:S.map(v=>l.jsxs("div",{className:"agent-sortable-item","data-id":v,children:[l.jsx("input",{type:"checkbox",id:`agent-cb-${v}`,checked:!0,onChange:()=>b(v)}),l.jsxs("label",{htmlFor:`agent-cb-${v}`,children:[n[v]?.icon||"ðŸ¤–"," ",v]})]},v))}),S.length>0&&M.length>0&&l.jsx("hr",{style:{margin:"10px 0"}}),l.jsx("div",{children:M.map(v=>l.jsxs("div",{className:"agent-sortable-item",children:[l.jsx("input",{type:"checkbox",id:`agent-cb-${v}`,checked:!1,onChange:()=>b(v)}),l.jsxs("label",{htmlFor:`agent-cb-${v}`,children:[n[v]?.icon||"ðŸ¤–"," ",v]})]},v))})]})]})]}),l.jsxs("div",{className:"modal-actions",children:[l.jsx("button",{className:"btn btn-secondary",onClick:e,children:"à¸¢à¸à¹€à¸¥à¸´à¸"}),l.jsx("button",{className:"btn",onClick:_,children:"à¸šà¸±à¸™à¸—à¸¶à¸ Group"})]})]})})}function Fr(){console.warn("saveAgentGroup is deprecated and should not be called from the new UI.");const e=c.getProject(),t=c.getState().editingGroupName,n=document.getElementById("group-name-input").value.trim();if(!n){x("Group name cannot be empty.","Error");return}if(n!==t&&e.agentGroups[n]){x(`A group named "${n}" already exists.`,"Error");return}const o=document.getElementById("group-moderator-select").value;if(!o){x("Please select a Moderator for the group.","Error");return}const s=window.groupSortable?window.groupSortable.toArray():[],a=document.querySelectorAll("#group-member-list .agent-sortable-item"),r=Array.from(a).filter(u=>u.querySelector('input[type="checkbox"]').checked).map(u=>u.dataset.agentName),i=s.filter(u=>r.includes(u));if(i.length===0){x("A group must have at least one member.","Error");return}const d={agents:i,moderatorAgent:o,flowType:document.getElementById("group-flow-select").value,maxTurns:parseInt(document.getElementById("group-max-turns-input").value,10),timerInSeconds:parseInt(document.getElementById("group-timer-input").value,10)};t&&t!==n&&(delete e.agentGroups[t],e.chatSessions.forEach(u=>{u.linkedEntity?.type==="group"&&u.linkedEntity.name===t&&(u.linkedEntity.name=n)})),e.agentGroups[n]=d,c.setProject(e),c.updateAndPersistState(),c.bus.publish("group:editorShouldClose"),x(`Group "${n}" saved successfully.`,"Success"),c.bus.publish("studio:contentShouldRender")}function $r({groupName:e}){if(!confirm(`Are you sure you want to delete the group "${e}"? This cannot be undone.`))return;const t=c.getProject();delete t.agentGroups[e],c.setProject(t),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender"),x(`Group "${e}" has been deleted.`,"Success")}function Br(e,t){const n=c.getProject(),o=e.name.trim();if(!o){x("Group name cannot be empty.","Error");return}if(o!==t&&n.agentGroups[o]){x(`A group named "${o}" already exists.`,"Error");return}t&&t!==o&&delete n.agentGroups[t],n.agentGroups[o]={agents:e.members,moderatorAgent:e.moderator,flowType:e.flowType,maxTurns:e.maxTurns,timerInSeconds:e.timerInSeconds},c.setProject(n),c.updateAndPersistState(),x(`Group "${o}" saved successfully.`,"Success"),c.bus.publish("studio:contentShouldRender")}const ut="group-editor-container";function Rr(e){const n=c.getProject().activeEntity,o=c.getStagedEntity(),s=document.createElement("div");return s.className="item group-item",s.dataset.groupName=e,n?.type==="group"&&n.name===e?s.classList.add("active"):o?.type==="group"&&o.name===e&&s.classList.add("staged"),s.innerHTML=`
     <div class="item-header">
        <span class="item-name"><span class="item-icon">ðŸ¤</span> ${e}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="group:edit" title="Edit Group">
                <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="btn-icon danger" data-action="group:delete" title="Delete Group">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,s}function Ur(e){if(!e)return;const t=c.getProject();if(!t||!t.agentGroups)return;e.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>ðŸ¤ Agent Groups</h3>
                <button class="btn-icon" data-action="group:create" title="Create New Group">+</button>
            </summary>
            <div class="section-box">
                <div id="agentGroupList" class="item-list"></div>
            </div>
        </details>
    `);const o=e.querySelector("#agentGroupList:last-of-type");if(!o)return;const s=t.agentGroups;for(const a in s)o.appendChild(Rr(a))}function Dr(){let e=document.getElementById(ut);return e||(e=document.createElement("div"),e.id=ut,document.body.appendChild(e)),e}function Or(){const e=document.getElementById(ut);e&&(ue.unmount(e),e.remove())}function Wt(e=!1,t=null){const n=c.getProject(),o=e?{name:t,...n.agentGroups[t]}:null,s=n.agentPresets||{},a=Dr(),i={groupData:o,allAgents:s,onSave:d=>{Br(d,t),Jt()},unmount:Jt};ue.mount(Tr,i,a)}function Jt(){console.log("ðŸ“ hideAgentGroupEditor called"),Or(),c.setState("editingGroupName",null)}function qr(){console.log("âœ… Group UI Initialized")}let Xe=null;function Hr(e,t,n){const o=document.createElement("div");o.className=`item memory-item ${t?"":"inactive"}`,o.dataset.name=e.name,o.dataset.memoryIndex=n;const a=wt([{label:"Edit...",action:"memory:edit",data:{index:n}},{label:"Delete",action:"memory:delete",data:{index:n},isDestructive:!0}]),r=document.createElement("div");r.className=`memory-toggle ${t?"active":""}`,r.title=`Click to ${t?"deactivate":"activate"}`,r.onclick=u=>{u.stopPropagation(),c.bus.publish("memory:toggle",{name:e.name})};const i=document.createElement("span");i.className="item-name",i.textContent=e.name;const d=document.createElement("div");return d.className="item-header",d.appendChild(r),d.appendChild(i),d.appendChild(a),o.appendChild(d),o}function zr(e){if(!e)return;const t=c.getProject();if(!t)return;const n=document.createElement("details");n.className="collapsible-section memory-section",n.open=!0;const o=document.createElement("summary");o.className="section-header",o.innerHTML="<h3>ðŸ§  Command Memories</h3>";const s=[{label:"New Memory...",action:"memory:create"},{label:"Export Package...",action:"memory:exportPackage"},{label:"Import Package...",action:"memory:importPackage"}];o.appendChild(wt(s)),n.appendChild(o);const a=document.createElement("div");a.className="section-box",n.appendChild(a);const r=t.agentPresets?.[t.activeEntity?.name];if(!r)a.innerHTML='<p class="no-items-message">Select an Agent to see memories.</p>';else{a.innerHTML=`
            <details id="active-memories-details" open><summary>Active Memories</summary><div id="activeMemoriesList" class="item-list"></div></details>
            <details id="inactiveMemoriesSection" open><summary>Inactive Memories</summary><div id="inactiveMemoriesList" class="item-list"></div></details>
        `;const i=a.querySelector("#activeMemoriesList"),d=a.querySelector("#inactiveMemoriesList"),u=r.activeMemories||[];(t.memories||[]).forEach((f,g)=>{const p=u.includes(f.name);(p?i:d).appendChild(Hr(f,p,g))}),Xe&&Xe.destroy(),Xe=new Sortable(i,{animation:150,onEnd:f=>{const g=c.getProject().agentPresets[c.getProject().activeEntity.name];if(!g)return;const p=f.item.dataset.name;g.activeMemories.splice(f.oldDraggableIndex,1),g.activeMemories.splice(f.newDraggableIndex,0,p),c.bus.publish("studio:contentShouldRender")}})}e.appendChild(n)}function Yt(e=null){const t=c.getProject(),n=document.getElementById("memory-editor-modal");if(!n)return;const o=t.memories||[];if(e!==null&&o[e]){const s=o[e];console.log("Editing memory at",e,s),n.querySelector("#memory-modal-title").textContent="Edit Memory",n.querySelector("#memory-name-input").value=s.name,n.querySelector("#memory-content-input").value=s.content,n.querySelector("#memory-edit-index").value=e}else console.log("Create new memory",e,o),n.querySelector("#memory-modal-title").textContent="Create New Memory",n.querySelector("#memory-name-input").value="",n.querySelector("#memory-content-input").value="",n.querySelector("#memory-edit-index").value="";n.style.display="flex"}function Xt(){document.getElementById("memory-editor-modal").style.display="none"}function Kr(){c.bus.subscribe("memory:editorShouldClose",Xt);const e=document.getElementById("memory-editor-modal");e&&e.addEventListener("click",t=>{const n=t.target;n.matches(".modal-actions .btn:not(.btn-secondary)")&&c.bus.publish("memory:save"),(n.matches(".btn-secondary")||n.closest(".modal-close-btn")||n===e)&&Xt()})}let Qt=0;function Gr(e=0){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`}function Vr(e){switch(e){case"uploaded":return"Uploaded";case"indexing":return"Indexing";case"indexed":return"Indexed";case"failed":return"Failed";case"ready":return"Ready";case"binary":return"Binary";case"error":return"Error";default:return"Uploaded"}}function Wr(e){const t=(e.type||"").toLowerCase();return t.includes("json")?"ðŸ§©":t.includes("csv")?"ðŸ“Š":t.includes("pdf")?"ðŸ“•":t.includes("word")||t.includes("doc")?"ðŸ“":t.startsWith("text/")?"ðŸ“„":"ðŸ“"}function Jr(e){T(e);const t=e.chatSessions?.find(i=>i.id===e.activeSessionId)||null,n=W(t?.ragSettings,{scopeSource:t?.folderId?"folder":"session"}),o=t?.folderId?H(e,t.folderId):null,s=o?de(o.ragSettings):null,a=n.scopeSource==="folder"&&o?"folder":"session";return{session:t,folder:o,scopeSource:a,settings:a==="folder"&&s?s:n,sessionSettings:n,folderSettings:s}}function Yr(e,t){const n=Jr(e),{session:o,folder:s,scopeSource:a,settings:r}=n,i=document.createElement("div");i.className="knowledge-rag-controls";const d=r.selectedFileIds.filter(j=>t.some(w=>w.id===j)).length;if(o&&s){const j=document.createElement("label");j.className="knowledge-control",j.innerHTML="<span>RAG Source</span>";const w=document.createElement("select");w.innerHTML=`
            <option value="session">Session</option>
            <option value="folder">Folder</option>
        `,w.value=a,w.addEventListener("change",()=>{c.bus.publish("knowledge:setScopeSource",{scopeSource:w.value})}),j.appendChild(w),i.appendChild(j)}const u=document.createElement("label");u.className="knowledge-control",u.innerHTML="<span>Scope</span>";const m=document.createElement("select");m.innerHTML=`
        <option value="all">All files</option>
        <option value="selected">Selected files only</option>
    `,m.value=r.scopeMode,m.addEventListener("change",()=>{c.bus.publish("knowledge:updateSessionRagSettings",{scopeMode:m.value})}),u.appendChild(m);const f=document.createElement("label");f.className="knowledge-control",f.innerHTML="<span>Top-K</span>";const g=document.createElement("input");g.type="number",g.min="1",g.max="12",g.value=r.retrievalTopK,g.addEventListener("change",()=>{c.bus.publish("knowledge:updateSessionRagSettings",{retrievalTopK:Number(g.value)})}),f.appendChild(g);const p=document.createElement("label");p.className="knowledge-control",p.innerHTML="<span>Token Budget</span>";const h=document.createElement("input");h.type="number",h.min="200",h.max="10000",h.step="100",h.value=r.maxContextTokens,h.addEventListener("change",()=>{c.bus.publish("knowledge:updateSessionRagSettings",{maxContextTokens:Number(h.value)})}),p.appendChild(h);const k=document.createElement("div");return k.className="knowledge-scope-info",a==="folder"&&s?k.textContent=`Selected files: ${d} (using folder "${s.name}")`:k.textContent=`Selected files: ${d} (using current session)`,i.append(u,f,p,k),{controls:i,settings:r,scopeSource:a}}function Xr(e){const t=Array.isArray(e?.knowledgeIndex?.chunks)?e.knowledgeIndex.chunks:[],n=new Map;return t.forEach(o=>{o?.fileId&&(n.has(o.fileId)||n.set(o.fileId,[]),n.get(o.fileId).push(o))}),n.forEach(o=>{o.sort((s,a)=>{const r=Number.isFinite(s?.chunkIndex)?s.chunkIndex:0,i=Number.isFinite(a?.chunkIndex)?a.chunkIndex:0;return r-i})}),n}function Qr(e,{isSelected:t=!1,isFocused:n=!1,focusedChunk:o=null}={}){const s=document.createElement("div");s.className="item knowledge-item",t&&s.classList.add("selected-for-rag"),n&&s.classList.add("source-focused"),s.dataset.fileId=e.id;const a=document.createElement("div");a.className="item-header";const r=document.createElement("span");r.className="item-name",r.textContent=`${Wr(e)} ${e.name}`;const i=document.createElement("div");if(i.className="item-actions",e.textContent){const g=document.createElement("button");g.className=`btn-icon ${t?"is-active":""}`,g.title=t?"Remove from selected scope":"Add to selected scope",g.dataset.action="knowledge:toggleSelection",g.innerHTML=`<span class="material-symbols-outlined">${t?"check_circle":"radio_button_unchecked"}</span>`,i.appendChild(g);const p=document.createElement("button");p.className="btn-icon",p.title="Re-index file",p.dataset.action="knowledge:reindex",p.innerHTML='<span class="material-symbols-outlined">refresh</span>',i.appendChild(p)}const d=document.createElement("button");d.className="btn-icon danger",d.title="Delete file",d.dataset.action="knowledge:delete",d.innerHTML='<span class="material-symbols-outlined">delete</span>',i.appendChild(d),a.append(r,i);const u=document.createElement("div");u.className="knowledge-file-meta";const m=Number.isFinite(e.chunkCount)?`${e.chunkCount} chunk(s)`:"0 chunk(s)";u.textContent=`${Gr(e.size||0)} â€¢ ${Vr(e.status)} â€¢ ${m} â€¢ ${new Date(e.uploadedAt).toLocaleString("th-TH")}`;const f=document.createElement("div");if(f.className="knowledge-file-excerpt",f.textContent=e.excerpt||"No preview available.",s.append(a,u,f),o){const g=document.createElement("div");g.className="knowledge-focus-preview";const p=document.createElement("div");p.className="knowledge-focus-preview-header";const h=document.createElement("span");h.className="knowledge-focus-preview-title";const k=Number.isFinite(o.chunkIndex)?o.chunkIndex+1:1;h.textContent=`Focused source: #chunk${k}`;const j=document.createElement("button");j.type="button",j.className="btn-icon knowledge-focus-clear",j.title="Clear focused source",j.dataset.action="knowledge:clearFocus",j.innerHTML='<span class="material-symbols-outlined">close</span>';const w=document.createElement("div");w.className="knowledge-focus-preview-text",w.textContent=o.text||"No text available for this chunk.",p.append(h,j),g.append(p,w),s.appendChild(g)}if(e.note){const g=document.createElement("div");g.className="knowledge-file-note",g.textContent=e.note,s.appendChild(g)}return s}function Zr(e){if(!e)return;const t=c.getProject();if(!t)return;T(t);const n=document.createElement("details");n.className="collapsible-section knowledge-files-section",n.open=!0;const o=document.createElement("summary");o.className="section-header",o.innerHTML="<h3>ðŸ“š Knowledge Files</h3>";const s=wt([{label:"Upload Files...",action:"knowledge:upload"},{label:"Re-index All",action:"knowledge:reindexAll"},{label:"Clear All",action:"knowledge:clearAll",isDestructive:!0}]);o.appendChild(s);const a=document.createElement("div");a.className="section-box";const r=Array.isArray(t.knowledgeFiles)?t.knowledgeFiles:[],i=Xr(t),d=c.getState().knowledgeFocus||null,{controls:u,settings:m}=Yr(t,r),f=document.createElement("div");f.className="item-list";const g=new Set(m.selectedFileIds||[]);r.length===0?f.innerHTML='<p class="no-items-message">No knowledge files yet.</p>':r.forEach(h=>{const k=i.get(h.id)||[],j=!!(d?.fileId&&d.fileId===h.id),w=j&&(k.find(y=>y.chunkIndex===d.chunkIndex)||k[0])||null;f.appendChild(Qr(h,{isSelected:g.has(h.id),isFocused:j,focusedChunk:w}))}),a.append(u,f),n.append(o,a),e.appendChild(n);const p=Number(d?.requestedAt)||0;if(d?.fileId&&p>Qt){const h=Array.from(f.querySelectorAll(".knowledge-item")).find(k=>k.dataset.fileId===d.fileId);h&&(Qt=p,requestAnimationFrame(()=>{h.scrollIntoView({behavior:"smooth",block:"center"})}))}}function ei(){const e=c.getProject();if(!e||!e.agentPresets)return[];const t=document.getElementById("asset-search-input")?.value.toLowerCase()||"",n=document.getElementById("asset-sort-select")?.value||"modified-desc";let o=Object.entries(e.agentPresets).map(([s,a])=>({name:s,...a}));return t&&(o=o.filter(s=>[s.name,s.id,s.description,s.model,...s.tags||[]].join(" ").toLowerCase().includes(t))),o.sort((s,a)=>{switch(n){case"modified-desc":return a.modifiedAt-s.modifiedAt;case"modified-asc":return s.modifiedAt-a.modifiedAt;case"created-desc":return a.createdAt-s.createdAt;case"created-asc":return s.createdAt-a.createdAt;case"name-asc":return s.name.localeCompare(a.name);case"name-desc":return a.name.localeCompare(s.name);default:return 0}}),o}function ti(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=o=>{try{const s=JSON.parse(o.target.result);if(typeof s!="object"||s===null||Array.isArray(s))throw new Error("Invalid file format. Expected a JSON object of agents.");const a=c.getProject();let r=0,i=0;for(const d in s)a.agentPresets[d]?confirm(`Agent "${d}" already exists. Overwrite?`)&&(a.agentPresets[d]=s[d],i++):(a.agentPresets[d]=s[d],r++);c.setProject(a),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender"),x(`Import complete! Added: ${r}, Overwritten: ${i}.`,"Success")}catch(s){console.error("Failed to import agents:",s),x(`Error importing agents: ${s.message}`,"Error")}},n.readAsText(t),e.target.value=""}function xe(){const e=document.querySelector("#studio-panel .studio-assets-container");if(!e)return;e.innerHTML="";const t=ei();Ar(e,t),Ur(e),zr(e),Zr(e)}function ni(){const e=document.getElementById("studio-panel");if(!e||e.dataset.listenerAttached==="true")return;e.dataset.listenerAttached="true",e.addEventListener("click",s=>{const a=s.target,r=a.closest(".memory-toggle");if(r){s.stopPropagation();const u=r.closest(".item[data-name]");u&&c.bus.publish("memory:toggle",{name:u.dataset.name});return}const i=a.closest("[data-action]");if(i){s.preventDefault(),s.stopPropagation();const u=i.dataset.action;let f={...a.closest(".item")?.dataset};if(i.dataset.data)try{const g=JSON.parse(i.dataset.data);Object.assign(f,g)}catch(g){console.error("Failed to parse data attribute JSON",g)}u==="toggle-menu"?pt(s):(c.bus.publish(u,f),i.closest(".dropdown.open")?.classList.remove("open"));return}const d=a.closest(".item");if(d){s.preventDefault();const{agentName:u,groupName:m}=d.dataset;u?c.bus.publish("studio:itemClicked",{type:"agent",name:u}):m&&c.bus.publish("studio:itemClicked",{type:"group",name:m});return}});const t=document.getElementById("asset-search-input"),n=document.getElementById("asset-sort-select");t?.addEventListener("input",xe),n?.addEventListener("change",xe),document.getElementById("import-agents-input")?.addEventListener("change",ti),c.bus.subscribe("project:loaded",xe),c.bus.subscribe("studio:contentShouldRender",xe),c.bus.subscribe("entity:selected",xe),c.bus.subscribe("entity:staged",xe),console.log("âœ… Studio UI Initialized with definitive, robust event listeners.")}function si({name:e}){const t=c.getProject(),n=t.activeEntity?.name;if(!n)return;const o=t.agentPresets[n];if(!o)return;o.activeMemories||(o.activeMemories=[]),o.activeMemories.includes(e)?o.activeMemories=o.activeMemories.filter(a=>a!==e):o.activeMemories.push(e),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender")}function oi(){const e=c.getProject(),t=document.getElementById("memory-name-input").value.trim(),n=document.getElementById("memory-content-input").value,o=document.getElementById("memory-edit-index").value;if(!t){x("Memory name cannot be empty.","Error");return}if(o!==""){const s=e.memories[o].name;e.memories[o]={name:t,content:n},Object.values(e.agentPresets).forEach(a=>{if(a.activeMemories){const r=a.activeMemories.indexOf(s);r>-1&&(a.activeMemories[r]=t)}})}else{if(e.memories.some(s=>s.name===t)){x(`A memory named "${t}" already exists.`,"Error");return}e.memories.push({name:t,content:n})}c.setProject(e),c.updateAndPersistState(),c.bus.publish("memory:editorShouldClose"),c.bus.publish("studio:contentShouldRender"),x(`Memory "${t}" saved successfully.`,"Success")}function ai({index:e}){if(!confirm("Are you sure you want to permanently delete this memory? This cannot be undone."))return;const t=c.getProject();if(!t.memories[e])return;const n=t.memories[e].name;t.memories.splice(e,1),Object.values(t.agentPresets).forEach(o=>{o.activeMemories&&(o.activeMemories=o.activeMemories.filter(s=>s!==n))}),c.setProject(t),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender")}function ri(){const t={memories:c.getProject().memories},n=JSON.stringify(t,null,2),o=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(o),a=document.createElement("a");a.href=s,a.download=`promptprim_memories_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}function ii(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=o=>{try{const s=JSON.parse(o.target.result);if(s&&Array.isArray(s.memories)){const a=c.getProject(),r=new Set(a.memories.map(d=>d.name)),i=s.memories.filter(d=>!r.has(d.name));a.memories.push(...i),c.setProject(a),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender"),x("Memory package imported successfully!","Success")}else throw new Error("Invalid memory package file.")}catch(s){x(`Error loading memory package: ${s.message}`,"Error")}},n.readAsText(t),e.target.value=""}const li=25*1024*1024,Qe=5e5,Zt=280,ci=1200,di=180,ui=500,mi="local-hash-v1",At=128,pi=new Set(["application/json","application/xml","application/yaml","application/x-yaml"]),gi=new Set(["txt","md","markdown","csv","json","log","xml","yaml","yml"]);function fi(e=""){const t=e.lastIndexOf(".");return t<0?"":e.slice(t+1).toLowerCase()}function hi(e){const t=(e.type||"").toLowerCase();return t.startsWith("text/")||pi.has(t)?!0:gi.has(fi(e.name))}function Ct(){return`kf_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function wi(e=0){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`}function yi(e=""){const t=e.replace(/\s+/g," ").trim();return t?t.length<=Zt?t:`${t.slice(0,Zt)}...`:"No text preview available."}function Dn(e){Array.isArray(e.knowledgeFiles)||(e.knowledgeFiles=[])}function we(e){(!e.knowledgeIndex||typeof e.knowledgeIndex!="object")&&(e.knowledgeIndex={}),Array.isArray(e.knowledgeIndex.chunks)||(e.knowledgeIndex.chunks=[]),Number.isFinite(e.knowledgeIndex.version)||(e.knowledgeIndex.version=1),Number.isFinite(e.knowledgeIndex.dimensions)||(e.knowledgeIndex.dimensions=At),e.knowledgeIndex.embeddingModel||(e.knowledgeIndex.embeddingModel=mi),Number.isFinite(e.knowledgeIndex.updatedAt)||(e.knowledgeIndex.updatedAt=Date.now())}function Pt(e){e&&(e.ragSettings=W(e.ragSettings,{scopeSource:e.folderId?"folder":"session"}))}function On(e){e&&(e.ragSettings=de(e.ragSettings))}function qn(e,t){!e?.chatSessions||!t||e.chatSessions.forEach(n=>{Pt(n),n.ragSettings.selectedFileIds=n.ragSettings.selectedFileIds.filter(o=>o!==t)})}function Hn(e,t){!e?.chatFolders||!t||e.chatFolders.forEach(n=>{On(n),n.ragSettings.selectedFileIds=n.ragSettings.selectedFileIds.filter(o=>o!==t)})}function bi(e){let t=2166136261;for(let n=0;n<e.length;n+=1)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return t>>>0}function vi(e=""){return e.toLowerCase().match(/[\p{L}\p{N}_-]{2,}/gu)||[]}function xi(e,t=At){const n=Array.from({length:t},()=>0),o=vi(e);if(o.length===0)return n;for(const a of o){const r=bi(a)%t;n[r]+=1}const s=Math.sqrt(n.reduce((a,r)=>a+r*r,0));return s?n.map(a=>Number((a/s).toFixed(6))):n}function Si(e=""){return e?Math.max(1,Math.round(e.length/4)):0}function Ii(e,t,n){const o=Math.min(e.length,t+n);if(o>=e.length)return e.length;const s=t+Math.floor(n*.6),a=e.slice(s,o),r=a.lastIndexOf(`
`);if(r>=0)return s+r+1;const i=Math.max(a.lastIndexOf(". "),a.lastIndexOf("! "),a.lastIndexOf("? "));if(i>=0)return s+i+2;const d=a.lastIndexOf(" ");return d>=0?s+d+1:o}function Ei(e,{targetChars:t=ci,overlapChars:n=di,maxChunks:o=ui}={}){const s=(e||"").replace(/\r\n/g,`
`).replace(/\u0000/g,"").trim();if(!s)return[];const a=[];let r=0,i=0;const d=o*5;for(;r<s.length&&a.length<o&&i<d;){i+=1;const u=Ii(s,r,t),m=s.slice(r,u).trim();if(m&&a.push(m),u>=s.length)break;r=Math.max(u-n,r+1)}return a}function De(e,t){we(e),e.knowledgeIndex.chunks=e.knowledgeIndex.chunks.filter(n=>n.fileId!==t)}function Nt(e,t){if(we(e),!t?.textContent?.trim())return t.status="failed",t.chunkCount=0,t.note="No text content available for indexing.",De(e,t.id),0;t.status="indexing",De(e,t.id);const n=Ei(t.textContent),o=Date.now(),s=n.map((a,r)=>({id:`kc_${t.id}_${r}_${o}`,fileId:t.id,fileName:t.name,chunkIndex:r,text:a,charCount:a.length,tokenEstimate:Si(a),vector:xi(a,e.knowledgeIndex.dimensions||At),embeddingModel:e.knowledgeIndex.embeddingModel,createdAt:o}));return e.knowledgeIndex.chunks.push(...s),e.knowledgeIndex.updatedAt=o,t.status=s.length>0?"indexed":"failed",t.chunkCount=s.length,t.indexedAt=o,t.embeddingModel=e.knowledgeIndex.embeddingModel,s.length}function ki(e){return`${e.name}__${e.size}__${e.lastModified||0}`}function ji(e){return{id:Ct(),name:e.name,type:e.type||"application/octet-stream",size:e.size||0,uploadedAt:Date.now(),source:"upload",status:"binary",chunkCount:0,indexedAt:null,embeddingModel:"",textContent:"",excerpt:"Preview not available for this file type yet."}}async function Ai(e){const t=await e.text(),n=t.length>Qe,o=n?t.slice(0,Qe):t,s=n?`Text was truncated at ${Qe.toLocaleString()} characters.`:"";return{id:Ct(),name:e.name,type:e.type||"text/plain",size:e.size||0,uploadedAt:Date.now(),source:"upload",status:"uploaded",chunkCount:0,indexedAt:null,embeddingModel:"",textContent:o,excerpt:yi(o),note:s}}function Ci(e,t){return{id:Ct(),name:e.name,type:e.type||"application/octet-stream",size:e.size||0,uploadedAt:Date.now(),source:"upload",status:"failed",chunkCount:0,indexedAt:null,embeddingModel:"",textContent:"",excerpt:`Could not read file: ${t.message||"Unknown error"}`}}function Pi(){document.getElementById("knowledge-file-input")?.click()}async function Ni(e){const t=Array.from(e||[]);if(t.length===0)return;const n=c.getProject();if(!n)return;T(n),Dn(n),we(n);const o=new Set(n.knowledgeFiles.map(f=>`${f.name}__${f.size}__${f.lastModified||0}`));let s=0,a=0,r=0,i=0,d=0,u=0;for(const f of t){const g=ki(f);if(o.has(g)){a+=1;continue}if((f.size||0)>li){r+=1;continue}let p;if(hi(f))try{p=await Ai(f)}catch(h){p=Ci(f,h),i+=1}else p=ji(f);if(p.lastModified=f.lastModified||0,p.sizeLabel=wi(p.size),p.textContent)try{const h=Nt(n,p);u+=h,h>0&&(d+=1)}catch(h){p.status="failed",p.note=`Indexing failed: ${h.message||"Unknown error"}`,p.chunkCount=0,De(n,p.id),i+=1}n.knowledgeFiles.unshift(p),o.add(g),s+=1}s>0&&(c.setProject(n),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender"));const m=[];s>0&&m.push(`Added ${s} file(s).`),d>0&&m.push(`Indexed ${d} file(s) into ${u} chunk(s).`),a>0&&m.push(`Skipped ${a} duplicate file(s).`),r>0&&m.push(`Skipped ${r} file(s) larger than 25 MB.`),i>0&&m.push(`${i} file(s) were added with read errors.`),m.length>0&&x(m.join(`
`),"Knowledge Files")}function Mi({fileId:e}){if(!e)return;const t=c.getProject();if(!t||!Array.isArray(t.knowledgeFiles))return;T(t);const n=t.knowledgeFiles.find(a=>a.id===e);if(!n||!confirm(`Delete "${n.name}" from Knowledge Files?`))return;t.knowledgeFiles=t.knowledgeFiles.filter(a=>a.id!==e),qn(t,e),Hn(t,e),De(t,e),c.getState().knowledgeFocus?.fileId===e&&c.setState("knowledgeFocus",null),c.setProject(t),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender")}function Li(){const e=c.getProject();if(!e||!Array.isArray(e.knowledgeFiles)||e.knowledgeFiles.length===0||(T(e),!confirm("Delete all knowledge files in this project?")))return;const n=e.knowledgeFiles.map(o=>o.id);e.knowledgeFiles=[],we(e),e.knowledgeIndex.chunks=[],e.knowledgeIndex.updatedAt=Date.now(),n.forEach(o=>{qn(e,o),Hn(e,o)}),c.setState("knowledgeFocus",null),c.setProject(e),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender")}function _i({fileId:e}){if(!e)return;const t=c.getProject();if(!t||!Array.isArray(t.knowledgeFiles))return;T(t),we(t);const n=t.knowledgeFiles.find(o=>o.id===e);if(n){if(!n.textContent){x("This file has no text content to index.","Knowledge Files");return}try{const o=Nt(t,n);c.setProject(t),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender"),x(`Re-indexed "${n.name}" (${o} chunk(s)).`,"Knowledge Files")}catch(o){n.status="failed",n.note=`Indexing failed: ${o.message||"Unknown error"}`,c.setProject(t),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender"),x(`Could not re-index "${n.name}".`,"Knowledge Files")}}}function Ti(){const e=c.getProject();if(!e||!Array.isArray(e.knowledgeFiles))return;T(e),we(e);let t=0,n=0;for(const o of e.knowledgeFiles){if(!o.textContent)continue;const s=Nt(e,o);n+=s,t+=1}c.setProject(e),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender"),x(`Re-indexed ${t} file(s) into ${n} chunk(s).`,"Knowledge Files")}function Fi({fileId:e,chunkIndex:t,fileName:n}={}){const o=c.getProject();if(!o)return;T(o),Dn(o),we(o);let s=e||"";if(!s&&n&&(s=o.knowledgeFiles.find(m=>m.name===n)?.id||""),!s){x("Could not locate source file for this citation.","Knowledge Files");return}const a=Number.isFinite(Number(t))?Math.max(0,Math.round(Number(t))):0,r=o.knowledgeIndex.chunks.find(u=>u.fileId===s&&u.chunkIndex===a),i=o.knowledgeIndex.chunks.find(u=>u.fileId===s),d=r||i;c.setState("knowledgeFocus",{fileId:s,chunkIndex:Number.isFinite(d?.chunkIndex)?d.chunkIndex:0,requestedAt:Date.now()}),c.bus.publish("studio:contentShouldRender")}function $i(){c.setState("knowledgeFocus",null),c.bus.publish("studio:contentShouldRender")}function Mt(e){return e?.chatSessions?.find(t=>t.id===e.activeSessionId)||null}function zn(e,t){Pt(t);const n=t.ragSettings.scopeSource==="folder",o=t.folderId?H(e,t.folderId):null;return n&&o?(On(o),{target:"folder",settings:o.ragSettings,folder:o}):(t.ragSettings.scopeSource==="folder"&&!o&&(t.ragSettings.scopeSource="session"),{target:"session",settings:t.ragSettings,folder:null})}function Bi({scopeSource:e}={}){const t=c.getProject();if(!t)return;T(t);const n=Mt(t);if(!n)return;Pt(n);const o=e==="folder"?"folder":"session";o==="folder"&&!H(t,n.folderId)?(x("This session is not in a folder. Move the session into a folder first.","Knowledge Files"),n.ragSettings.scopeSource="session"):n.ragSettings.scopeSource=o,n.updatedAt=Date.now(),c.setProject(t),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender")}function Ri(e={}){const t=c.getProject();if(!t)return;T(t);const n=Mt(t);if(!n)return;const{target:o,settings:s,folder:a}=zn(t,n),r={...s};if(e.scopeMode!==void 0&&(r.scopeMode=e.scopeMode==="selected"?"selected":"all"),e.retrievalTopK!==void 0){const i=Number(e.retrievalTopK);Number.isFinite(i)&&(r.retrievalTopK=Math.min(12,Math.max(1,Math.round(i))))}if(e.maxContextTokens!==void 0){const i=Number(e.maxContextTokens);Number.isFinite(i)&&(r.maxContextTokens=Math.min(1e4,Math.max(200,Math.round(i))))}o==="folder"&&a?(a.ragSettings=de(r),a.updatedAt=Date.now()):(n.ragSettings=W(r,{scopeSource:"session"}),n.ragSettings.scopeSource="session"),n.updatedAt=Date.now(),c.setProject(t),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender")}function Ui({fileId:e}){if(!e)return;const t=c.getProject();if(!t)return;T(t);const n=Mt(t);if(!n)return;const{target:o,settings:s,folder:a}=zn(t,n),r=new Set(s.selectedFileIds||[]);r.has(e)?r.delete(e):r.add(e);const i=Array.from(r);o==="folder"&&a?(a.ragSettings=de({...a.ragSettings,selectedFileIds:i}),a.updatedAt=Date.now()):(n.ragSettings=W({...n.ragSettings,selectedFileIds:i,scopeSource:"session"}),n.ragSettings.scopeSource="session"),n.updatedAt=Date.now(),c.setProject(t),c.updateAndPersistState(),c.bus.publish("studio:contentShouldRender")}function Di(e){mt({openrouterKey:e}),c.bus.publish("api:loadModels")}function Oi(e){mt({ollamaBaseUrl:e})}function qi(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=o=>{try{const s=JSON.parse(o.target.result);if(s&&s.userProfile&&s.appSettings&&s.modelPresets)confirm("This will overwrite your current settings and reload the application. Are you sure?")&&(localStorage.setItem("promptPrimUserSettings_v1",JSON.stringify(s)),x("Settings imported! The app will now reload.","Success"),setTimeout(()=>window.location.reload(),1500));else throw new Error("Invalid settings file format.")}catch(s){x(`Error importing settings: ${s.message}`,"Error")}},n.readAsText(t),e.target.value=""}function Ze(){const e=ce();if(!e)return;const t=yt(e),n=document.querySelector("#user-profile-menu .user-name"),o=document.querySelector("#user-profile-menu .user-plan"),s=document.getElementById("user-userCredits"),a=s?.querySelector("span:last-child"),r=document.querySelector("#user-profile-btn span");if(r&&e.userName&&(r.textContent=e.userName.charAt(0).toUpperCase()),n&&(n.textContent=e.userName||"User"),o){let i="Unknown",d="status-blocked";t?(i=e.planStatus==="active"?"Master Plan":"Subscription Expired",d=e.planStatus==="active"?"status-master":"status-blocked"):e.plan==="pro"?e.planStatus==="active"&&e.credits.current>0?(i="Pro Plan",d="status-active"):e.planStatus==="grace_period"?(i="Pro (Grace Period)",d="status-grace"):(i="Account Blocked",d="status-blocked"):e.plan==="free"&&(i=e.credits.current>0?"Free Plan":"Credits Depleted",d=e.credits.current>0?"status-free":"status-blocked"),o.textContent=i,o.className=`user-plan ${d}`}if(s&&a)if(t)s.style.display="none";else{s.style.display="flex";const i=sn(e.credits?.current??0);a.textContent=`$${i.toFixed(2)}`}}function Hi(){const e=document.querySelector(".user-profile-container"),t=document.getElementById("user-switcher-modal");!e||!t||(e.addEventListener("click",n=>{const o=n.target.closest("[data-action]");if(!o)return;const s=o.dataset.action;switch(s!=="toggle-menu"&&n.preventDefault(),s){case"toggle-menu":pt(n);break;case"user:account":c.bus.publish("ui:showAccountModal"),e.classList.remove("open");break;case"user:settings":rs(),e.classList.remove("open");break;case"user:logout":t.style.display="flex",e.classList.remove("open");break}}),t.addEventListener("click",n=>{const o=n.target,s=o.closest("button[data-user-id]");if(s){const a=s.dataset.userId;is(a),x(`Switched to ${a}. The app will now reload.`,"Success"),t.style.display="none",setTimeout(()=>window.location.reload(),1500)}(o.matches(".modal-close-btn")||o===t)&&(t.style.display="none")}),ls("theme-switcher-dropdown"),c.bus.subscribe("user:settingsLoaded",Ze),c.bus.subscribe("user:settingsUpdated",Ze),Ze())}function zi(e){const t=ce();if(t){if(yt(t)){x("Master profile plan is fixed and cannot be changed here.","Plan Locked");return}confirm(`Are you sure you want to switch to the ${e} plan?`)&&(console.log(`HANDLER: Changing plan for ${t.userId} to ${e}`),cs(t.userId,e),x(`Successfully switched to ${e} plan!`,"Success"))}}function Ki(e){const t=ce();t&&(console.log(`HANDLER: Refilling $${e} for ${t.userId}`),ds(t.userId,e),x(`Successfully added credits worth $${e}!`,"Success"))}const fe=document.getElementById("account-modal"),et=document.getElementById("account-modal-body");function Gi(){fe&&(Kn(),fe.style.display="flex")}function Vi(){fe&&(fe.style.display="none")}function Kn(){const e=ce();if(!et||!e){et.innerHTML="<p>Could not load user data.</p>";return}const t=yt(e);let n="";t?n="<p>Master profile is fixed for API management.</p>":e.plan==="free"?n='<button class="btn" data-action="switch-plan" data-plan="pro">Upgrade to Pro</button>':e.plan==="pro"&&(n=`
            <button class="btn btn-secondary" data-action="switch-plan" data-plan="free">Downgrade to Free</button>
            <button class="btn" data-action="switch-plan" data-plan="master">Upgrade to Master</button>
        `);const s=[10,30,50,100].map(r=>`<button class="btn btn-small btn-secondary" data-action="refill" data-amount="${r}">$${r}</button>`).join(""),a=sn(e.credits.current);et.innerHTML=`
        <div class="user-detail-grid">
            <div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" value="${e.userName}" readonly>
                </div>
                <div class="form-group">
                    <label>Current Plan</label>
                    <input type="text" value="${t?"Master":e.plan.charAt(0).toUpperCase()+e.plan.slice(1)}" readonly>
                </div>
                <div class="form-group">
                    <label>Credits</label>
                    <input type="text" value="${Math.floor(e.credits.current).toLocaleString()}" readonly>
                </div>
                <div class="form-group">
                    <label>Balance</label> 
                    <input type="text" value="$${a.toFixed(2)}" readonly>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>Change Plan</label>
                    <div>${n||"<p>No plan changes available.</p>"}</div>
                </div>
                <div class="form-group">
                    <label>Refill Credits (USD)</label>
                    <div class="refill-presets">${t?"<p>Not applicable.</p>":s}</div>
                </div>
            </div>
        </div>
    `}function Wi(){c.bus.subscribe("ui:showAccountModal",Gi),fe?.addEventListener("click",e=>{if(e.target.matches(".modal-close-btn")){Vi();return}const n=e.target.closest("[data-action]");if(!n)return;const o=n.dataset.action;o==="switch-plan"?zi(n.dataset.plan):o==="refill"&&Ki(parseInt(n.dataset.amount,10))}),c.bus.subscribe("user:settingsUpdated",()=>{fe&&fe.style.display==="flex"&&Kn()})}const Oe=new marked.Renderer,Ji=Oe.link;Oe.link=(e,t,n)=>Ji.call(Oe,e,t,n).replace(/^<a /,'<a target="_blank" rel="noopener noreferrer" ');marked.setOptions({renderer:Oe,gfm:!0,breaks:!1});function Yi(){window.addEventListener("storage",e=>{e.key==="promptPrimUserDatabase_v1"&&xs()})}function Xi(){if(!("ontouchstart"in window))return;const e=document.querySelector(".sessions-panel");if(!e)return;const t=60,n=80;let o=0,s=0,a=!1;document.body.addEventListener("touchstart",r=>{!e.classList.contains("visible")&&r.touches.length===2&&r.touches[0].clientX<t&&(o=r.touches[0].clientX,s=r.touches[0].clientY,a=!0)},{passive:!0}),document.body.addEventListener("touchmove",r=>{if(!a||r.touches.length!==2){a=!1;return}const i=r.touches[0].clientX,d=r.touches[0].clientY;Math.abs(d-s)>Math.abs(i-o)&&(a=!1)},{passive:!0}),document.body.addEventListener("touchend",r=>{if(!a)return;const i=r.changedTouches[0].clientX;a=!1,i-o>n&&document.getElementById("hamburger-btn")?.click()})}function Qi(){const e=c.bus;e.subscribe("project:new",dt),e.subscribe("project:open",Da),e.subscribe("project:fileSelectedForOpen",Oa),e.subscribe("project:save",t=>Nn(t)),e.subscribe("project:saveConfirm",({projectName:t})=>Mn(t)),e.subscribe("project:unsavedChangesChoice",Ha),e.subscribe("project:loaded",t=>{_e(t.projectData.name),Ee();try{const n=localStorage.getItem("promptPrimComposerState");if(n==="normal"||n==="maximized"){J(n);const o=localStorage.getItem("promptPrimComposerHeight"),s=document.getElementById("composer-panel");o&&s&&n==="normal"&&requestAnimationFrame(()=>{s.style.flexBasis=`${o}px`})}}catch(n){console.error("Could not restore composer state:",n)}}),e.subscribe("session:new",Et),e.subscribe("session:loaded",({session:t})=>{Ss(t.name),Is(),Se();const n=c.getState().preventPhotoStudioAutoMount,o=t.linkedEntity||c.getProject()?.activeEntity||null;if(!n)o&&c.bus.publish("entity:selected",o);else{const s=c.getProject();o&&(s.activeEntity={...o},c.setProject(s))}try{const s=localStorage.getItem("promptPrimComposerState");if(s==="normal"||s==="maximized"){J(s);const a=localStorage.getItem("promptPrimComposerHeight"),r=document.getElementById("composer-panel");a&&r&&s==="normal"&&(r.style.flexBasis=`${a}px`)}else J("collapsed")}catch(s){console.error("Could not set composer state on session load:",s)}try{Me()}catch{}document.querySelectorAll(".header-center .menu-toggle-btn").forEach(s=>s.classList.remove("active")),document.getElementById("switch-to-chat-btn")?.classList.add("active")}),e.subscribe("composer:append",({content:t})=>{const n=c.getState().composerApi;n&&n.appendContent?n.appendContent(t):console.warn("Composer is not ready to append content.")}),e.subscribe("session:cleared",()=>{Es(),Ir(),Se()}),e.subscribe("session:autoRename",Ba),e.subscribe("session:info",t=>pa(t)),e.subscribe("session:rename",t=>xa(t)),e.subscribe("session:move",t=>Fe(t)),e.subscribe("session:movePrompt",t=>Ca(t)),e.subscribe("session:contextMode",t=>lt(t)),e.subscribe("session:contextModePrompt",t=>Pa(t)),e.subscribe("session:clone",({sessionId:t,event:n})=>La(t,n)),e.subscribe("session:archive",({sessionId:t,event:n})=>_a(t,n)),e.subscribe("session:pin",({sessionId:t,event:n})=>Ma(t,n)),e.subscribe("session:delete",t=>Na(t)),e.subscribe("session:download",({sessionId:t})=>Ta({sessionId:t})),e.subscribe("folder:new",t=>kt(t)),e.subscribe("folder:rename",t=>Sa(t)),e.subscribe("folder:delete",t=>Ia(t)),e.subscribe("folder:updateSettings",t=>Ea(t)),e.subscribe("folder:newChat",t=>Aa(t)),e.subscribe("folder:activate",t=>ka(t)),e.subscribe("folder:collapse",t=>ja(t)),e.subscribe("agent:create",()=>Vt(!1)),e.subscribe("agent:save",tr),e.subscribe("agent:edit",({agentName:t})=>Vt(!0,t)),e.subscribe("agent:delete",({agentName:t})=>nr(t)),e.subscribe("agent:generateProfile",er),e.subscribe("group:create",()=>Wt(!1)),e.subscribe("group:save",Fr),e.subscribe("group:edit",({groupName:t})=>Wt(!0,t)),e.subscribe("group:delete",({groupName:t})=>$r({groupName:t})),e.subscribe("memory:create",()=>Yt(null)),e.subscribe("memory:save",oi),e.subscribe("memory:edit",({index:t})=>Yt(t)),e.subscribe("memory:delete",({index:t})=>ai({index:t})),e.subscribe("memory:toggle",t=>{si(t)}),e.subscribe("memory:exportPackage",ri),e.subscribe("memory:importPackage",()=>{document.getElementById("load-memory-package-input").click()}),e.subscribe("studio:itemClicked",Za),e.subscribe("summary:editFromChat",({logId:t})=>{_t(),setTimeout(()=>cn(t),50)}),e.subscribe("summary:generateNew",un),e.subscribe("summary:saveEdit",to),e.subscribe("summary:deleteLog",({logId:t})=>no({logId:t})),e.subscribe("summary:loadToContext",({logId:t})=>so({logId:t})),e.subscribe("settings:saveSummaryPreset",t=>oo(t)),e.subscribe("settings:renameSummaryPreset",t=>ao(t)),e.subscribe("settings:deleteSummaryPreset",t=>ro(t)),e.subscribe("chat:clearSummaryContext",ks),e.subscribe("summary:saveNewLog",t=>eo(t)),e.subscribe("entity:select",({type:t,name:n})=>Qa(t,n)),e.subscribe("open-composer",()=>{c.bus.publish("ui:toggleComposer")}),e.subscribe("composer:heightChanged",Fa),e.subscribe("ui:requestComposerOpen",()=>{J("normal")}),e.subscribe("ui:toggleComposer",()=>{J("normal")}),e.subscribe("composer:export",Fn),e.subscribe("chat:deleteMessage",t=>js(t)),e.subscribe("chat:sendMessage",As),e.subscribe("chat:stopGeneration",Cs),e.subscribe("chat:editMessage",({index:t})=>Ps({index:t})),e.subscribe("chat:copyMessage",({index:t,event:n})=>Ns({index:t,event:n})),e.subscribe("chat:regenerateMessage",({index:t})=>Ms({index:t})),e.subscribe("chat:fileUpload",t=>Lt(t)),e.subscribe("chat:filesSelected",t=>Lt(t)),e.subscribe("chat:removeFile",({index:t})=>Ls({index:t})),e.subscribe("knowledge:upload",Pi),e.subscribe("knowledge:filesSelected",t=>Ni(t)),e.subscribe("knowledge:delete",({fileId:t})=>Mi({fileId:t})),e.subscribe("knowledge:reindex",({fileId:t})=>_i({fileId:t})),e.subscribe("knowledge:reindexAll",Ti),e.subscribe("knowledge:clearAll",Li),e.subscribe("knowledge:updateSessionRagSettings",t=>Ri(t)),e.subscribe("knowledge:toggleSelection",({fileId:t})=>Ui({fileId:t})),e.subscribe("knowledge:setScopeSource",t=>Bi(t)),e.subscribe("knowledge:focusChunk",t=>Fi(t)),e.subscribe("knowledge:clearFocus",$i),e.subscribe("chat:summarize",_t),e.subscribe("chat:clearSummary",_s),e.subscribe("upload-file",()=>{document.getElementById("file-input")?.click()}),e.subscribe("api:loadModels",je),e.subscribe("api:loadUserModels",({apiKey:t,ollamaBaseUrl:n,isUserKey:o})=>{je({apiKey:t,ollamaBaseUrl:n,isUserKey:o})}),e.subscribe("settings:apiKeyChanged",Di),e.subscribe("settings:ollamaUrlChanged",Oi),e.subscribe("settings:fontChanged",Ya),e.subscribe("settings:systemAgentChanged",Xa),e.subscribe("group:manualSelectAgent",({agentName:t})=>{const n=c.getProject(),o=n.chatSessions.find(r=>r.id===n.activeSessionId),s=n.agentGroups[n.activeEntity.name];if(!o||!s)return;const a={type:"agent_turn",agentName:t};o.groupChatState.turnQueue.push(a),o.groupChatState.awaitsUserInput=!1,c.bus.publish("ui:renderAgentSelector"),Ts(n,o,s)}),e.subscribe("kieai:generate",fn),document.getElementById("switch-to-photo-btn")?.addEventListener("click",()=>{try{J("collapsed")}catch{}c.bus.publish("entity:select",{type:"agent",name:"Visual Studio"}),document.querySelectorAll(".header-center .menu-toggle-btn").forEach(t=>t.classList.remove("active")),document.getElementById("switch-to-photo-btn")?.classList.add("active")}),document.getElementById("switch-to-chat-btn")?.addEventListener("click",()=>{try{J("collapsed")}catch{}Me(),c.setState("preventPhotoStudioAutoMount",!0);const t=c.getProject();me(t.activeSessionId),setTimeout(()=>{c.setState("preventPhotoStudioAutoMount",!1)},100),document.querySelectorAll(".header-center .menu-toggle-btn").forEach(n=>n.classList.remove("active")),document.getElementById("switch-to-chat-btn")?.classList.add("active")}),document.getElementById("switch-to-composer-btn")?.addEventListener("click",()=>{Me();try{J("maximized")}catch{try{J("maximized")}catch{}}document.querySelectorAll(".header-center .menu-toggle-btn").forEach(t=>t.classList.remove("active")),document.getElementById("switch-to-composer-btn")?.classList.add("active")}),e.subscribe("entity:selected",t=>{const{type:n,name:o}=t,s=c.getState().preventPhotoStudioAutoMount;n==="agent"&&(o==="Visual Studio"||o.includes("KieAI")||o.includes("Wan")||o.includes("Seedance")||o.includes("Veo")||o.includes("Flux"))&&!s?(Uo(o),document.querySelectorAll(".header-center .menu-toggle-btn").forEach(r=>r.classList.remove("active")),document.getElementById("switch-to-photo-btn")?.classList.add("active")):s||(Me(),document.querySelectorAll(".header-center .menu-toggle-btn").forEach(r=>r.classList.remove("active")),document.getElementById("switch-to-chat-btn")?.classList.add("active"))}),console.log("âœ… Central Event Bus ready.")}function Zi(){gs(),Ko(),Ho(),fs(),hs(),Do(),Jo(),ga(),ws(),ys(),ni(),_r(),qr(),Kr(),bs(),Zs(),vs(),Hi(),Wi(),document.getElementById("import-settings-input")?.addEventListener("change",qi),console.log("âœ… All UI modules initialized.")}document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("loading-overlay");try{try{localStorage.removeItem("promptPrimComposerState"),localStorage.removeItem("promptPrimComposerHeight")}catch{}await us();const t=ce(),n=ms(),o=n.providerEnabled||{};if(await je({apiKey:o.openrouter!==!1?n.openrouterKey:"",ollamaBaseUrl:o.ollama!==!1?n.ollamaBaseUrl:"",isUserKey:!1}),t&&t.plan==="master"){const a=t.apiSettings?.providerEnabled||{};await je({apiKey:a.openrouter!==!1?t.apiSettings?.openrouterKey:"",ollamaBaseUrl:a.ollama!==!1?t.apiSettings?.ollamaBaseUrl:"",isUserKey:!0})}console.log("ðŸš€ Application starting..."),Zi(),Yi(),Qi(),Ua(),document.getElementById("load-memory-package-input").addEventListener("change",ii),document.getElementById("knowledge-file-input")?.addEventListener("change",a=>{c.bus.publish("knowledge:filesSelected",a.target.files),a.target.value=""});const s=localStorage.getItem("lastActiveProjectId");if(s){console.log(`Attempting to load last project with ID: ${s}`);try{await Ga(s)}catch(a){console.error(`[RECOVERY] Failed to load last project (ID: ${s}). This is likely due to corrupted data.`,a),alert("Could not load your last project due to an error. A new project will be created."),localStorage.removeItem("lastActiveProjectId"),console.log("[RECOVERY] Creating a new project as a fallback."),await dt()}}else await dt();e?.classList.remove("active"),console.log("ðŸŽ‰ Application initialized successfully.")}catch(t){console.error("[FATAL STARTUP ERROR]",t),e.querySelector("p").textContent=`A critical error occurred: ${t.message}`}});Xi();window.UserService=ps;
