import{s as a,t as k,a as g,d as Ue,b as B,f as Ne,S as I,g as De,o as V,c as pe,h as qe,e as v,l as M,i as Oe,j as He,k as P,m as Fe,n as U,p as Re,M as ge,q as X,r as ye,u as z,v as fe,w as be,x as ze,y as Ge,z as _e,A as he,B as Je,C as Ke,D as We,E as Ye,U as Ve,F as Xe,G as Qe,H as Ze,I as et,J as tt,K as nt,L as st,N as ot,O as at,P as rt,Q as it,R as ct,T as lt,V as dt,W as ut,X as mt,Y as pt,Z as gt,_ as yt,$ as ft,a0 as ne,a1 as bt,a2 as ht}from"./core.theme-g_vWwLtM.js";const f={};function vt(){f.appWrapper=document.querySelector(".app-wrapper"),f.toggleRightSidebarBtn=document.getElementById("toggle-right-sidebar-btn"),f.sessionsPanel=document.querySelector(".sessions-panel"),f.hamburgerBtn=document.getElementById("hamburger-btn"),f.closeSidebarBtn=document.querySelector('.sessions-panel .mobile-only[title="Close Sidebar"]'),f.mobileOverlay=document.getElementById("mobile-overlay"),f.composerPanel=document.querySelector(".composer-panel"),f.resizerRow=document.getElementById("resizer-row")}function St(e,t){if(!e||!t)return;let n=0,s=0,o=0,r=!1;const i=l=>{l.preventDefault(),e.classList.add("active"),document.body.style.cursor="row-resize",t.classList.contains("collapsed")&&(t.classList.remove("collapsed"),e.classList.remove("collapsed"),a.bus.publish("composer:visibilityChanged")),n=l.clientY,s=t.getBoundingClientRect().height,document.addEventListener("mousemove",d),document.addEventListener("mouseup",c)},d=l=>{o=l.clientY,r||(window.requestAnimationFrame(()=>{const u=o-n;let m=s-u;const p=parseInt(getComputedStyle(t).minHeight,10)||50;m<p&&(m=p),t.style.flexBasis=`${m}px`,r=!1}),r=!0)},c=()=>{e.classList.remove("active"),document.body.style.cursor="",document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c)};e.addEventListener("mousedown",i)}function Et(){if(!f.sessionsPanel)return;const e=t=>{t.stopPropagation(),t.preventDefault(),f.sessionsPanel.classList.remove("is-open"),f.mobileOverlay?.classList.remove("active")};f.hamburgerBtn?.addEventListener("click",t=>{window.innerWidth<=1024?(f.sessionsPanel.classList.add("is-open"),f.mobileOverlay?.classList.add("active")):f.appWrapper?.classList.toggle("sidebar-collapsed")}),f.mobileOverlay?.addEventListener("click",e,!0),f.closeSidebarBtn?.addEventListener("click",e,!0)}function Pt(){vt(),f.resizerRow&&f.composerPanel&&St(f.resizerRow,f.composerPanel),Et(),wt(),console.log("Core layout manager initialized.")}function wt(){!f.toggleRightSidebarBtn||!f.appWrapper||f.toggleRightSidebarBtn.addEventListener("click",()=>{f.appWrapper.classList.toggle("right-sidebar-collapsed"),f.appWrapper.classList.contains("right-sidebar-collapsed")||a.bus.publish("studio:rendered")})}const x={temperature:{label:"Temperature",provider:"all",type:"range",min:0,max:2,step:.01,default:1,tooltip:"Controls randomness. Higher is more creative."},top_p:{label:"Top P",provider:"all",type:"range",min:0,max:1,step:.01,default:1,tooltip:"Controls diversity via nucleus sampling."},top_k:{label:"Top K",provider:"all",type:"range",min:0,max:100,step:1,default:0,tooltip:"Limits sampling to the K most likely tokens."},max_tokens:{label:"Max Tokens",provider:"all",type:"range",min:1,max:32768,step:1,default:4096,tooltip:"The maximum number of tokens to generate."},frequency_penalty:{label:"Frequency Penalty",provider:"all",type:"range",min:-2,max:2,step:.01,default:0,tooltip:"Reduces the likelihood of repeating the same lines."},presence_penalty:{label:"Presence Penalty",provider:"all",type:"range",min:-2,max:2,step:.01,default:0,tooltip:"Reduces the likelihood of repeating existing topics."},seed:{label:"Seed",provider:"all",type:"number",default:-1,tooltip:"Use -1 for random output, or a specific number for deterministic output."},stop_sequences:{label:"Stop Sequences",provider:"all",type:"text",default:"",tooltip:"Comma-separated list of sequences to stop generation."},logit_bias:{label:"Logit Bias",provider:"openrouter",type:"textarea",default:"",tooltip:'Advanced: Enter "token:bias" pairs (e.g., "123:-1, 456:1.5").'},mirostat:{label:"Mirostat",provider:"ollama",type:"select",options:[0,1,2],default:0,tooltip:"Enables Mirostat sampling (0 = disabled, 1 = v1, 2 = v2)."},mirostat_tau:{label:"Mirostat Tau",provider:"ollama",type:"range",min:0,max:10,step:.1,default:5,tooltip:"Controls the balance between coherence and diversity for Mirostat."},mirostat_eta:{label:"Mirostat Eta",provider:"ollama",type:"range",min:0,max:1,step:.01,default:.1,tooltip:"Controls the learning rate for Mirostat."},repeat_penalty:{label:"Repeat Penalty",provider:"ollama",type:"range",min:0,max:2,step:.01,default:1.1,tooltip:"Strongly penalizes repeating tokens. A higher value reduces repetition more."}};function At(e,t,n){const s=n===void 0||n===""||n===null||n===t.default,o=s?"Default":n,r=s?"param-value":"param-value custom";let i="";const d=n==null||n===""?t.default:n;switch(t.type){case"range":i=`
                <input type="range" class="param-slider" data-control="slider"
                       min="${t.min}" max="${t.max}" 
                       step="${t.step}" value="${d}">
                <input type="number" class="param-input" data-control="input"
                       min="${t.min}" max="${t.max}" 
                       step="${t.step}" value="${d}">
                <button type="button" class="btn-link param-reset-btn" data-action="reset">Reset</button>
            `;break;case"number":i=`<input type="number" class="param-input-full" data-control="input" value="${d}" placeholder="${t.default}">`;break;case"text":i=`<input type="text" class="param-input-full" data-control="input" value="${d}" placeholder="${t.default}">`;break;case"textarea":i=`<textarea class="param-input-full" data-control="input" rows="3">${d}</textarea>`;break;case"select":i=`<select class="param-input-full" data-control="input">${t.options.map(l=>`<option value="${l}" ${l==d?"selected":""}>${l}</option>`).join("")}</select>`;break}return`
        <div class="param-wrapper" data-param-name="${e}">
            <div class="param-row" data-action="toggle">
                <span class="param-label" title="${t.tooltip}">${t.label}</span>
                <span class="${r}">${o}</span>
            </div>
            <div class="param-control hidden">
                ${i}
            </div>
        </div>
    `}function ve(e,t,n){if(!e)return null;let s="<h4>Core Parameters</h4>",o='<div id="ollama-section"><h4>Advanced (Ollama only)</h4>',r=!1;for(const l in x){const u=x[l],m=t?t[l]:void 0;if(u.provider==="all"||u.provider===n){const p=At(l,u,m);u.provider==="ollama"?(o+=p,r=!0):s+=p}}console.log("Generated Core HTML:",s),console.log("Generated Ollama HTML:",o),o+="</div>",e.innerHTML=s+o;const i=e.querySelector("#ollama-section");i&&(i.style.display=n==="ollama"&&r?"block":"none");const d=l=>{const u=l.target.closest("[data-action]");if(!u)return;const m=u.closest(".param-wrapper");if(m){if(u.dataset.action==="toggle"){const p=m.querySelector(".param-control"),y=p.classList.contains("hidden");e.querySelectorAll(".param-control:not(.hidden)").forEach(b=>b.classList.add("hidden")),y&&p.classList.remove("hidden")}else if(u.dataset.action==="reset"){const p=m.dataset.paramName,y=x[p];m.querySelector(".param-value").textContent="Default",m.querySelector(".param-value").classList.remove("custom"),m.querySelectorAll("input, select, textarea").forEach(b=>b.value=y.default)}}},c=l=>{const u=l.target.closest("[data-control]");if(!u)return;const m=u.closest(".param-wrapper");if(!m)return;const p=m.querySelector(".param-value"),y=m.querySelector(".param-slider"),b=m.querySelector(".param-input");y&&b&&(u.dataset.control==="slider"?b.value=l.target.value:y.value=l.target.value),p.textContent=l.target.value,p.classList.add("custom")};return e.addEventListener("click",d),e.addEventListener("input",c),{getValues:()=>{const l={};return e.querySelectorAll(".param-wrapper").forEach(u=>{const m=u.dataset.paramName;if(u.querySelector(".param-value.custom")){const p=u.querySelector('[data-control="input"], .param-input-full');if(p){const y=x[m];l[m]=y.type==="range"||y.type==="number"?parseFloat(p.value):p.value}}}),l},destroy:()=>{e.removeEventListener("click",d),e.removeEventListener("input",c),e.innerHTML=""}}}function Lt(){document.addEventListener("keydown",e=>{const t=document.querySelector('.modal-overlay[style*="display: flex"]'),n=document.getElementById("settings-panel"),s=n?.classList.contains("visible");if(!(!t&&!s)){if(e.key==="Escape"){if(e.preventDefault(),t){const o=t.querySelector(".btn-secondary")||t.querySelector(".modal-actions .btn");o&&o.click()}else if(s){const o=n.querySelector(".close-settings-btn");o&&o.click()}}if(e.key==="Enter"&&!e.shiftKey){if(e.target.tagName==="TEXTAREA"||e.target.tagName==="BUTTON")return;if(t){e.preventDefault();const o=t.querySelector(".modal-actions .btn:not(.btn-secondary):not(.btn-danger)");if(o)o.click();else{const r=t.querySelector(".modal-actions .btn");r&&r.click()}}}}}),console.log("Global keyboard bindings initialized.")}function q(e){const t=document.getElementById("project-title");if(t){const n=a.isUserDirty(),s=e||a.getProject()?.name||"Untitled";t.textContent=n?`${s} *`:s}}function It(){const e=document.getElementById("save-project-modal"),t=document.getElementById("project-name-input"),n=a.getProject();t.value=n?`${n.name} - Copy`:"Untitled Project",e.style.display="flex",t.focus(),t.select()}function se(){const e=document.getElementById("save-project-modal");e.style.display="none"}function jt(e){e&&e.stopPropagation(),document.getElementById("custom-entity-selector-wrapper").classList.toggle("open")}function Ct(e){const t=e.indexOf("_"),n=e.substring(0,t),s=e.substring(t+1);a.bus.publish("entity:select",{type:n,name:s}),document.getElementById("custom-entity-selector-wrapper").classList.remove("open")}function T(){const e=a.getProject();if(!e||!e.globalSettings)return;const t=document.getElementById("entitySelector"),n=document.getElementById("custom-entity-selector-options"),s=document.getElementById("custom-entity-selector-icon"),o=document.getElementById("custom-entity-selector-text");t.innerHTML="",n.innerHTML="";const r=(c,l,u,m)=>{const p=`${c}_${l}`,y=document.createElement("div");y.className="custom-select-option",y.innerHTML=`<span class="item-icon">${u}</span> <span>${l}</span>`,y.addEventListener("click",()=>Ct(p)),m.appendChild(new Option(`${u} ${l}`,p)),n.appendChild(y)},i=e.agentPresets||{};if(Object.keys(i).length>0){const c=document.createElement("optgroup");c.label="Agent Presets",t.appendChild(c);const l=document.createElement("div");l.className="custom-select-group",l.textContent="Agent Presets",n.appendChild(l),Object.keys(i).forEach(u=>{r("agent",u,i[u].icon||"🤖",c)})}const d=e.agentGroups||{};if(Object.keys(d).length>0){const c=document.createElement("optgroup");c.label="Agent Groups",t.appendChild(c);const l=document.createElement("div");l.className="custom-select-group",l.textContent="Agent Groups",n.appendChild(l),Object.keys(d).forEach(u=>{r("group",u,"🤝",c)})}if(e.activeEntity){const{type:c,name:l}=e.activeEntity;t.value=`${c}_${l}`,c==="agent"&&i[l]?(s.textContent=i[l].icon||"🤖",o.textContent=l):c==="group"?(s.textContent="🤝",o.textContent=l):(s.textContent="❔",o.textContent="Select...")}}function Bt(){a.bus.subscribe("project:loaded",n=>{q(n.projectData.name),T()}),a.bus.subscribe("project:nameChanged",n=>q(n)),a.bus.subscribe("userDirty:changed",()=>q()),a.bus.subscribe("entity:selected",T),a.bus.subscribe("agent:listChanged",T),a.bus.subscribe("group:listChanged",T),a.bus.subscribe("ui:showSaveAsModal",It);const e=document.querySelector(".sidebar-bottom-row .dropdown");if(e){const n=e.querySelector("button");n&&n.addEventListener("click",k),e.addEventListener("click",s=>{const o=s.target.closest("a");if(!o)return;const r=o.dataset.action;if(r){s.preventDefault();const i={newProject:{name:"project:new"},openProject:{name:"project:open"},saveProject:{name:"project:save",data:!1},saveProjectAs:{name:"project:save",data:!0},exportChat:{name:"project:exportChat"}};i[r]&&a.bus.publish(i[r].name,i[r].data),e.classList.remove("open")}})}const t=document.getElementById("save-project-modal");t&&t.addEventListener("click",n=>{if(n.target.matches(".btn:not(.btn-secondary)")){const s=document.getElementById("project-name-input").value.trim();s?(a.bus.publish("project:saveConfirm",{projectName:s}),se()):g("Please enter a project name.")}else(n.target.matches(".btn-secondary")||n.target===t)&&se()}),document.getElementById("load-project-input")?.addEventListener("change",n=>a.bus.publish("project:fileSelectedForOpen",n)),document.getElementById("custom-entity-selector-trigger")?.addEventListener("click",jt),console.log("Project UI Initialized with definitive listeners.")}let oe=!1;function O(e){const t=a.getProject();let n="💬";e.linkedEntity?.type==="agent"&&t.agentPresets[e.linkedEntity.name]?n=t.agentPresets[e.linkedEntity.name].icon||"🤖":e.linkedEntity?.type==="group"&&(n="🤝");const s=document.createElement("div");s.className="item session-item",s.dataset.sessionId=e.id,e.pinned&&s.classList.add("pinned");const o=e.name||"New Chat";return s.innerHTML=`
        <div class="item-header">
            <span class="item-name"><span class="item-icon">${n}</span> ${o}</span>
            <div class="item-actions">
                <div class="dropdown align-right">
                    <button class="btn-icon" data-action="toggle-menu" title="More options">&#8942;</button>
                    <div class="dropdown-content">
                        <a href="#" data-action="pin">${e.pinned?"Unpin":"Pin"} Session</a>
                        <a href="#" data-action="rename">Rename</a>
                        <a href="#" data-action="clone">Clone Session</a>
                        <a href="#" data-action="archive">${e.archived?"Unarchive":"Archive"} Session</a>                        <a href="#" data-action="download">Download Chat</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" data-action="delete" class="is-destructive">
                            <span class="material-symbols-outlined">delete</span> Delete Session
                        </a>                    
                    </div>
                </div>
            </div>
        </div>
    `,s}function Se(e){document.querySelectorAll(".session-item").forEach(n=>{n.classList.toggle("active",n.dataset.sessionId===e)})}function j(){const e=a.getProject();if(!e)return;const t=document.getElementById("pinnedSessionList"),n=document.getElementById("sessionListContainer"),s=document.getElementById("archivedSessionList"),o=document.getElementById("archivedSessionsSection");if(!t||!n||!s||!o)return;t.innerHTML="",n.innerHTML="",s.innerHTML="";const r=e.chatSessions||[],i=r.filter(l=>l.isPinned&&!l.archived),d=r.filter(l=>!l.isPinned&&!l.archived),c=r.filter(l=>l.archived);i.sort((l,u)=>u.updatedAt-l.updatedAt).forEach(l=>{t.appendChild(O(l))}),d.sort((l,u)=>u.updatedAt-l.updatedAt).forEach(l=>{n.appendChild(O(l))}),c.sort((l,u)=>u.updatedAt-l.updatedAt).forEach(l=>{s.appendChild(O(l))}),o.classList.toggle("hidden",c.length===0),Se(e.activeSessionId)}function Mt(){if(oe)return;oe=!0,a.bus.subscribe("project:loaded",j),a.bus.subscribe("session:listChanged",j),a.bus.subscribe("session:loaded",()=>Se(a.getProject()?.activeSessionId));const e=document.querySelector(".sessions-panel");e&&e.addEventListener("click",t=>{const n=t.target,s=n.closest(".dropdown-content a[data-action]");if(s){t.preventDefault(),t.stopPropagation();const i=n.closest(".session-item[data-session-id]");if(!i)return;const d=i.dataset.sessionId,c=s.dataset.action;a.bus.publish(`session:${c}`,{sessionId:d,event:t}),s.closest(".dropdown.open")?.classList.remove("open");return}if(n.closest('button[data-action="toggle-menu"]')){t.preventDefault(),t.stopPropagation(),k(t);return}if(n.closest("#new-chat-btn")){a.bus.publish("session:new");return}const r=n.closest(".session-item[data-session-id]");if(r){const i=r.dataset.sessionId;a.getProject().activeSessionId!==i&&w(i)}}),console.log("✅ Session UI and its dedicated event listener initialized ONCE.")}const Q=()=>document.querySelector("#composer-editor .composer-content-area");function Ee(e){const t=a.getProject(),n=t?.chatSessions.find(s=>s.id===t.activeSessionId);n&&n.composerContent!==e&&(n.composerContent=e,a.updateAndPersistState())}function G(){const e=Q();if(!e)return;const t=a.getProject();if(!t?.activeSessionId){e.innerHTML="";return}const n=t.chatSessions.find(s=>s.id===t.activeSessionId);e.innerHTML=n?.composerContent||""}function kt({content:e}){const t=Q(),n=document.getElementById("composer-panel");!t||!n||(n.classList.contains("collapsed")&&(n.classList.remove("collapsed"),document.getElementById("resizer-row")?.classList.remove("collapsed"),a.bus.publish("composer:visibilityChanged")),t.textContent.trim()!==""&&(t.innerHTML+="<br><hr><br>"),t.innerHTML+=e,t.scrollTop=t.scrollHeight,Ee(t.innerHTML))}function xt(e){const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("*").forEach(n=>{if(n.removeAttribute("style"),n.classList.length>0){const s=[];for(let o=0;o<n.classList.length;o++)n.classList[o].startsWith("hljs-")||s.push(n.classList[o]);s.forEach(o=>n.classList.remove(o))}}),t.innerHTML}function Tt(){const e=Q();if(!e)return;const t=e.innerHTML;if(!t.trim()){g("Composer is empty. Nothing to export.","Info");return}const s=`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Composer Export</title>
            
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
            
            <style>
                /* 2. สไตล์พื้นฐานของหน้าเว็บที่ Export */
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
                    line-height: 1.6; 
                    padding: 20px; 
                    max-width: 800px; 
                    margin: auto; 
                }
                pre {
                    background-color: #f6f8fa; /* สีพื้นหลัง Code Block สำหรับไฟล์ที่ Export */
                    padding: 16px;
                    border-radius: 6px;
                    overflow-x: auto;
                }
                code {
                    font-family: 'Fira Mono', 'Menlo', monospace;
                }
            </style>
        </head>
        <body>
            ${xt(t)}
        </body>
        </html>
    `,o=new Blob([s],{type:"text/html;charset=utf-8"}),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download=`composer-export-${Date.now()}.html`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}function $t(){const e=document.getElementById("color-palette");if(!e)return;const t=["#000000","#E03131","#C2255C","#9C36B5","#6741D9","#3B5BDB","#1971C2","#0C8599","#099268","#2F9E44","#66A80F","#F08C00","#E8590C","#868E96","#495057"];e.innerHTML="",t.forEach(n=>{const s=document.createElement("div");s.className="color-swatch",s.style.backgroundColor=n,s.dataset.color=n,e.appendChild(s)})}function A(){const e=document.querySelector(".composer-tools-area");if(!e)return;let t=!1;const n=document.queryCommandValue("formatBlock").toLowerCase();for(const o of["H1","H2","H3","P"]){const r=e.querySelector(`button[data-value="${o}"]`);r&&(n===`<${o.toLowerCase()}>`?(r.classList.add("is-active"),o!=="P"&&(t=!0)):r.classList.remove("is-active"))}["bold","italic","underline","strikeThrough"].forEach(o=>{const r=e.querySelector(`button[data-command="${o}"]`);if(r){const i=o==="bold"&&t?!1:document.queryCommandState(o);r.classList.toggle("is-active",i)}})}function Ut(e){const t=document.querySelector("#composer-editor .composer-content-area");t&&(t.innerHTML="")}function Nt(){const e=document.getElementById("composer-panel"),t=document.querySelector("#composer-editor .composer-content-area"),n=document.getElementById("mobile-composer-toggle");document.getElementById("composer-editor");const s=document.querySelector(".composer-tools-area"),o=document.getElementById("composer-collapse-btn"),r=document.getElementById("composer-expand-btn"),i=document.getElementById("export-composer-btn");if(!e||!t){console.error("Composer UI cannot initialize: Core elements not found.");return}const d=()=>{e.classList.contains("collapsed"),e.classList.toggle("collapsed");const p=e.classList.contains("collapsed");n&&n.classList.toggle("is-open",!p),a.bus.publish("composer:visibilityChanged")};n&&n.addEventListener("click",d);const c=document.getElementById("resizer-row");c&&c.addEventListener("mousedown",p=>{if(window.innerWidth<=768){p.preventDefault();return}}),a.bus.subscribe("project:loaded",G),a.bus.subscribe("session:loaded",G),a.bus.subscribe("composer:append",kt),a.bus.subscribe("ui:toggleComposer",d),t.addEventListener("focus",()=>{document.execCommand("formatBlock",!1,"p"),A()}),["click","keyup","focus"].forEach(p=>{t.addEventListener(p,()=>{setTimeout(A,1)})}),document.addEventListener("selectionchange",()=>{document.activeElement===t&&A()});const u=Ue(()=>Ee(t.innerHTML),500);t.addEventListener("input",u),["keyup","mouseup"].forEach(p=>t.addEventListener(p,A)),document.addEventListener("selectionchange",()=>{document.activeElement===t&&A()}),s&&($t(),s.addEventListener("mousedown",p=>{p.preventDefault();const y=p.target.closest("button, .color-swatch");if(y){if(t.focus(),y.id==="color-picker-btn"){y.parentElement.classList.toggle("open");return}if(y.classList.contains("color-swatch"))document.execCommand("foreColor",!1,y.dataset.color),y.closest(".dropdown")?.classList.remove("open");else{const b=y.dataset.command;if(b){let S=y.dataset.value||null;b==="formatBlock"&&S&&(S=`<${S}>`),document.execCommand(b,!1,S)}}A()}})),i&&i.addEventListener("click",Tt),o&&o.addEventListener("click",d),r&&r.addEventListener("click",()=>{const p=e.style.flexBasis&&parseInt(e.style.flexBasis,10)>window.innerHeight*.5;e.style.flexBasis=p?"35vh":"90vh"}),console.log("✅ Composer UI Initialized with definitive patches.")}const Dt=(e="sid")=>`${e}_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,N=()=>a.getProject(a.activeProjectId);function Pe(){const e=a.getProject(),t=e?.activeEntity;if(!e||!t)return;const n={id:`sid_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:"New Chat",history:[],composerContent:"",createdAt:Date.now(),updatedAt:Date.now(),pinned:!1,archived:!1,linkedEntity:{...t},summaryState:{activeSummaryId:null,summarizedUntilIndex:-1}};e.chatSessions.unshift(n),e.activeSessionId=n.id,a.setProject(e),w(n.id)}function w(e){const t=a.getProject();if(!t)return;if(!e){t.activeSessionId=null,a.setProject(t),a.bus.publish("session:cleared");return}const n=t.chatSessions.find(s=>s.id===e);if(!n){console.warn(`Session with ID ${e} not found. Loading most recent as fallback.`);const s=[...t.chatSessions].filter(o=>!o.archived).sort((o,r)=>r.updatedAt-o.updatedAt)[0];w(s?s.id:null);return}t.activeSessionId=e,n.linkedEntity&&(t.activeEntity={...n.linkedEntity}),a.setProject(t),a.updateAndPersistState(),a.bus.publish("session:loaded",{session:n})}function qt({sessionId:e}){const t=a.getProject(),n=t?.chatSessions.find(o=>o.id===e);if(!n)return;const s=prompt("Enter new name:",n.name);s&&s.trim()&&s.trim()!==n.name&&(n.name=s.trim(),n.updatedAt=Date.now(),a.updateAndPersistState(),a.bus.publish("session:listChanged"),e===t.activeSessionId&&a.bus.publish("ui:updateChatTitle",{title:n.name}))}async function Ot({sessionId:e}){if(!confirm("Are you sure you want to delete this chat session? This cannot be undone."))return;const t=a.getProject(),n=t.chatSessions.findIndex(s=>s.id===e);if(n!==-1){if(t.chatSessions.splice(n,1),await B(I,"readwrite","delete",e),t.activeSessionId===e){const s=[...t.chatSessions].filter(o=>!o.archived).sort((o,r)=>r.updatedAt-o.updatedAt)[0];t.activeSessionId=s?s.id:null,w(t.activeSessionId)}else a.bus.publish("session:listChanged");a.updateAndPersistState()}}function Ht(e,t){t?.stopPropagation();const n=N(),s=n?.chatSessions.find(o=>o.id===e);s&&(s.pinned=!s.pinned,s.updatedAt=Date.now(),a.updateAndPersistState(n),j())}function Ft(e,t){t?.stopPropagation();const n=N(),s=n?.chatSessions.find(r=>r.id===e);if(!s){g("Error: Could not find session to clone.","Error");return}const o=JSON.parse(JSON.stringify(s));o.id=Dt(),o.name=`${s.name} (Copy)`,o.createdAt=Date.now(),o.updatedAt=Date.now(),o.pinned=!1,o.archived=!1,n.chatSessions.unshift(o),n.activeSessionId=o.id,a.updateAndPersistState(n),w(o.id)}function Rt(e,t){t?.stopPropagation();const n=N(),s=n?.chatSessions.find(o=>o.id===e);if(s)if(s.archived=!s.archived,s.archived&&(s.pinned=!1),s.updatedAt=Date.now(),n.activeSessionId===e&&s.archived){const o=n.chatSessions.find(r=>!r.archived);n.activeSessionId=o?o.id:null,a.updateAndPersistState(n),w(n.activeSessionId)}else a.updateAndPersistState(n),j()}async function we(e){const t=e||N()?.chatSessions;if(!t)return;const n=De();if(!n){console.error("[SaveAllSessions] Cannot save, DB not available.");return}const s=n.transaction(I,"readwrite"),o=s.objectStore(I);for(const r of t)o.put(r);return new Promise((r,i)=>{s.oncomplete=()=>r(),s.onerror=()=>i(s.error)})}function zt(e){try{const t=a.getProject();if(!t)throw new Error("Project not found.");const n=e?.sessionId||t.activeSessionId;if(!n)throw new Error("No session is active or selected for download.");console.log(`Attempting to download session with ID: ${n}`);const s=t.chatSessions.find(u=>u.id===n);if(!s)throw new Error(`Session with ID ${n} could not be found.`);let o=`Chat Session: ${s.name||"Untitled Session"}
`;o+=`Exported on: ${new Date().toLocaleString()}
`,s.linkedEntity&&(o+=`Associated Entity: ${s.linkedEntity.name} (${s.linkedEntity.type})
`),o+=`============================================

`;const r=s.history||[];r.length===0?o+="[This session has no messages.]":r.forEach(u=>{const m=u.timestamp?Ne(u.timestamp):"No Timestamp",p=(u.speaker||u.role||"unknown").toUpperCase(),y=Array.isArray(u.content)?u.content.find(b=>b.type==="text")?.text||"[multimodal content]":u.content;o+=`[${m}] ${p}:
${y}

--------------------------------

`}),console.log(`Final text content length: ${o.length}`);const i=new Blob([o],{type:"text/plain;charset=utf-8"}),d=URL.createObjectURL(i),c=document.createElement("a"),l=(s.name||"untitled").replace(/[^a-z0-9]/gi,"_").toLowerCase();c.download=`session-export-${l}.txt`,c.href=d,document.body.appendChild(c),c.click(),setTimeout(()=>{document.body.removeChild(c),URL.revokeObjectURL(d),console.log("Download initiated and cleanup complete.")},100)}catch(t){console.error("Download Chat Session failed:",t),g(`Failed to download chat: ${t.message}`,"Error")}}function Gt({height:e}){const t=a.getProject(),n=t?.chatSessions.find(s=>s.id===t.activeSessionId);n&&e&&(n.composerHeight=e)}async function _t(){const e=a.getProject(),t=e?.chatSessions.find(n=>n.id===e.activeSessionId);if(!t){console.warn("[AutoSave] Could not find active session to save.");return}try{await B(I,"readwrite","put",t)}catch(n){console.error(`[AutoSave] Failed to save active session (${t.id}):`,n)}}function Jt({sessionId:e,newName:t}){const n=a.getProject();if(!n)return;const s=n.chatSessions.find(o=>o.id===e);!s||s.name!=="New Chat"||(s.name=t,s.updatedAt=Date.now(),a.updateAndPersistState(),a.bus.publish("session:listChanged"),n.activeSessionId===e&&a.bus.publish("ui:updateChatTitle",{title:t}))}async function Kt(){const e=a.getProject();if(!e||!e.id)return console.warn("[AutoSave] Aborted: Project not available for saving."),!1;console.log("[AutoSave] Persisting essential data to IndexedDB...");try{return await Z(),await _t(),console.log("[AutoSave] Essential project state successfully persisted."),!0}catch(t){return console.error("[AutoSave] Failed to persist project state:",t),!1}}function Wt(){let e;a.bus.subscribe("autosave:required",()=>{clearTimeout(e),e=setTimeout(async()=>{a.isAutoSaveDirty()&&await Kt()&&a.setAutoSaveDirty(!1)},2e3)})}function Yt(){a.isUserDirty()?(a.setState("pendingActionAfterSave",()=>{document.getElementById("load-project-input").click()}),pe()):document.getElementById("load-project-input").click()}async function _(){console.log("Proceeding with creating a new project...");try{const e=localStorage.getItem("lastActiveProjectId");e&&(await Oe(e),localStorage.removeItem("lastActiveProjectId"));const t=await fetch("/PromptPrim/default-project.prim");if(!t.ok)throw new Error(`Could not fetch default project file. Status: ${t.status}`);const n=await t.json(),s=He();s&&s.systemAgentDefaults&&(n.globalSettings.systemUtilityAgent=s.systemAgentDefaults.utilityAgent,n.globalSettings.summarizationPromptPresets=s.systemAgentDefaults.summarizationPresets),n.globalSettings.summarizationPromptPresets={...v},n.id=`proj_${Date.now()}`,await V(n.id),await D(n,!0)}catch(e){console.error("Failed to proceed with creating a new project:",e),g("Could not create a new project. Please check the browser console for more details.","Error")}}function J(){a.isUserDirty()?(a.setState("pendingActionAfterSave",_),pe()):_()}function Vt(e){const t=e.target.files[0];if(!t)return;console.log(`[OpenProject] File selected: ${t.name}. Reading file...`);const n=new FileReader;n.onload=async s=>{try{const o=s.target.result;console.log("[OpenProject] File read complete. Parsing JSON...");const r=JSON.parse(o);if(!r.id||!r.name)throw new Error("Invalid project file format.");console.log(`[OpenProject] JSON parsed successfully for project: ${r.name}. Loading data...`),await D(r,!0)}catch(o){console.error("[OpenProject] Failed to load project:",o),g(`Error loading project: ${o.message}`,"Error")}},n.onerror=()=>{console.error("[OpenProject] FileReader error."),g("Failed to read the selected file.","Error")},n.readAsText(t),e.target.value=""}function Xt(){try{const e=a.getState().pendingFileToOpen;if(!e)return;en(e),a.setState("pendingFileToOpen",null)}catch(e){console.error("Failed to proceed with opening project:",e),g("Could not open the project file.","Error")}}async function Ae(e=!1){const t=a.getProject();e||t.name==="Untitled Project"?a.bus.publish("ui:showSaveAsModal"):await Le(t.name)}async function Le(e){const t=e?.trim();if(!t)return g("Please enter a project name."),!1;const n=a.getProject();n.name=t,a.bus.publish("project:nameChanged",t),a.setUserDirty(!1);const s=JSON.parse(JSON.stringify(a.getProject())),o=Ie(s);try{const r=JSON.stringify(o,null,2),i=new Blob([r],{type:"application/json"}),d=URL.createObjectURL(i),c=document.createElement("a");return c.download=`${t.replace(/[^a-z0-9\u0E00-\u0E7F]/gi,"_").toLowerCase()}.prim`,c.href=d,document.body.appendChild(c),c.click(),URL.revokeObjectURL(d),document.body.removeChild(c),a.bus.publish("ui:hideSaveAsModal"),a.setAutoSaveDirty(!1),await sn(),a.getState().pendingActionAfterSave&&await Zt(),!0}catch(r){return console.error("Failed to save project:",r),g("Failed to save project file.","Error"),a.setUserDirty(!0),!1}}async function Qt(e){qe();const t=a.getState().pendingActionAfterSave;switch(a.setState("pendingActionAfterSave",null),e){case"save":await Ae(!1);break;case"discard":typeof t=="function"&&await t();break}}async function Zt(){const e=a.getState().pendingActionAfterSave;a.setState("pendingActionAfterSave",null),e==="open"?await Xt():e==="new"&&await _()}async function en(e){const t=new FileReader;t.onload=async n=>{try{const s=JSON.parse(n.target.result);if(s&&s.id&&s.name&&s.agentPresets)await D(s,!0),g(`Project '${s.name}' loaded successfully!`,"Project Loaded");else throw new Error("Invalid project file format.")}catch(s){g(`Error loading project: ${s.message}`,"Error"),console.error(s)}},t.readAsText(e)}async function tn(e){if(!e)throw new Error("Cannot load last project: Project ID is missing.");await V(e);const t=await B(X,"readonly","get",ge);if(t&&t.data&&t.data.id===e){const n=t.data,s=await B(I,"readonly","getAll"),o={...n,chatSessions:s||[]};await D(o,!1),console.log("Successfully loaded the last active project from IndexedDB.")}else throw new Error("Project data in DB is invalid or mismatched with last known ID.")}async function D(e,t=!1){let n=Ie(e);await V(n.id),t&&(n.isDirtyForUser=!1),n.globalSettings&&(n.globalSettings.summarizationPromptPresets={...v,...n.globalSettings.summarizationPromptPresets||{}}),a.setProject(n),await on(),n.globalSettings.apiKey&&await M({apiKey:n.globalSettings.apiKey}),n=a.getProject(),(n.chatSessions||[]).filter(i=>!i.archived).length===0&&Pe();const o=a.getProject();o.isDirtyForUser=!1,await nn(o);const r=o.chatSessions.find(i=>i.id===o.activeSessionId)||[...o.chatSessions].filter(i=>!i.archived).sort((i,d)=>d.updatedAt-i.updatedAt)[0];r&&w(r.id),a.bus.publish("project:loaded",{projectData:o}),a.bus.publish("userDirty:changed",!1),a.setAutoSaveDirty(!1),localStorage.setItem("lastActiveProjectId",o.id)}async function nn(e){await Re([I,X]),await Z(e),await we(e.chatSessions),console.log("Database has been rewritten with new project data.")}async function Z(e){const t=e||a.getProject();if(!t||!t.id){console.warn("Cannot persist metadata: project or project ID is missing.");return}const n={...t};delete n.chatSessions,await B(X,"readwrite","put",{id:ge,data:n})}async function sn(){const e=a.getProject();if(!e||!e.id)return!1;console.log("[AutoSave] Persisting project to IndexedDB...");try{return await Z(),await we(),console.log("[AutoSave] Project state successfully persisted."),!0}catch(t){return console.error("[AutoSave] Failed to persist project state:",t),!1}}async function on(){const e=a.getProject();!e||!e.globalSettings||(a.bus.publish("ui:applyFontSettings"),console.log("Global settings loaded into state."))}function an(e){const t=a.getProject();t.globalSettings.fontFamilySelect=e,a.setProject(t),a.updateAndPersistState(),a.bus.publish("ui:applyFontSettings")}function rn(){const e=a.getProject();if(!e.globalSettings)return;const t=e.globalSettings.systemUtilityAgent;t.model=document.getElementById("system-utility-model-select").value,t.systemPrompt=document.getElementById("system-utility-prompt").value;const n=a.getState().systemParameterEditor,s=n?n.getValues():{};Object.assign(t,s),a.setProject(e),a.updateAndPersistState(),g("System Agent settings saved!","Success")}function Ie(e){const t=P();if(e.globalSettings.systemUtilityAgent=Object.assign({},Fe,e.globalSettings.systemUtilityAgent),e.agentPresets)for(const n in e.agentPresets){const s=e.agentPresets[n],o=Object.assign({},U,s);(!o.createdBy||o.createdBy==="Unknown User")&&(o.createdBy=t.userName),o.createdAt||(o.createdAt=Date.now()),o.modifiedAt||(o.modifiedAt=o.createdAt),e.agentPresets[n]=o}if(e.isDirtyForUser===void 0&&(e.isDirtyForUser=!0),e.agentGroups)for(const n in e.agentGroups){const s=e.agentGroups[n];s&&!Array.isArray(s.agents)&&(s.agents=[])}return e}async function cn(e,t){a.setStagedEntity(null,!1);const n=a.getProject();n.activeEntity={type:e,name:t};const s=n.chatSessions.find(o=>o.id===n.activeSessionId);s&&(s.groupChatState&&(s.groupChatState.isRunning=!1),s.linkedEntity={...n.activeEntity},s.updatedAt=Date.now()),a.setProject(n),a.updateAndPersistState(),a.bus.publish("entity:selected",{type:e,name:t}),a.bus.publish("session:listChanged")}function ln({type:e,name:t}){const n={type:e,name:t},s=a.getStagedEntity(),o=a.getProject().activeEntity;if(s&&s.name===t&&s.type===e){a.bus.publish("entity:select",n);return}if(o&&o.name===t&&o.type===e){a.setStagedEntity(null);return}a.setStagedEntity(n)}function dn(e,t){const s=a.getProject().activeEntity,o=a.getStagedEntity(),r=document.createElement("div");return r.className="item agent-item",r.dataset.agentName=e,s?.type==="agent"&&s.name===e?r.classList.add("active"):o?.type==="agent"&&o.name===e&&r.classList.add("staged"),r.innerHTML=`
    <div class="item-header">
        <span class="item-name"><span class="item-icon">${t.icon||"🤖"}</span> ${e}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="agent:edit" title="Edit Agent">
                <span class="material-symbols-outlined">edit</span>
            </button>             
            <button class="btn-icon danger" data-action="agent:delete" title="Delete Agent">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,r}function un(e,t){if(!e)return;const n=e.querySelector(".agent-presets-section");n&&n.remove(),e.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section agent-presets-section" open>
            <summary class="section-header">
                <h3>🤖 Agent Presets</h3>
                <button class="btn-icon" data-action="agent:create" title="Create New Agent">+</button>
            </summary>
            <div class="section-box">
                <div id="agentPresetList" class="item-list"></div>
            </div>
        </details>`);const o=e.querySelector("#agentPresetList");if(o){if(!t||t.length===0){o.innerHTML='<p class="no-items-message">No agents found.</p>';return}t.forEach(r=>{o.appendChild(dn(r.name,r))})}}function je(e=[]){const t=document.getElementById("agent-tags-container"),n=document.getElementById("agent-tags-input");!t||!n||(t.querySelectorAll(".tag-pill").forEach(s=>s.remove()),(e||[]).forEach(s=>{const o=document.createElement("div");o.className="tag-pill",o.textContent=s,o.dataset.tag=s;const r=document.createElement("span");r.className="remove-tag",r.innerHTML="&times;",r.onclick=()=>o.remove(),o.appendChild(r),t.insertBefore(o,n)}))}function mn(e=[]){const n=a.getProject().memories||[],s=document.getElementById("agent-memory-list");if(s){if(s.innerHTML="",n.length===0){s.innerHTML='<p class="no-items-message">Create memories first.</p>';return}n.forEach(o=>{const r=(e||[]).includes(o.name),i=document.createElement("div");i.className="item",i.dataset.memoryName=o.name,i.innerHTML=`<span class="item-name">${o.name}</span><label class="switch"><input type="checkbox" ${r?"checked":""}><span class="slider round"></span></label>`,s.appendChild(i)})}}function pn(e){const t=document.querySelector('#agent-editor-modal .tab-content[data-tab-content="system"]');t&&t.classList.toggle("is-locked",e)}function Ce(){const e=document.getElementById("enhancer-model-name"),t=a.getProject();if(!e||!t)return;const n=t.globalSettings.systemUtilityAgent;if(n&&n.model){const s=[...a.getState().systemProviderModels||[],...a.getState().userProviderModels||[]];if(s.length===0){e.textContent=n.model;return}const o=s.find(r=>r.id===n.model);e.textContent=o?o.name:n.model}else e.textContent="N/A"}function ae(){const e=a.getState().activeParameterEditor;e&&typeof e.destroy=="function"&&(e.destroy(),a.setState("activeParameterEditor",null)),document.getElementById("agent-editor-modal").style.display="none",a.setState("editingAgentName",null)}function re(e=!1,t=null){const n=document.getElementById("agent-editor-modal");if(!n)return;a.setState("editingAgentName",e?t:null);const s=a.getProject(),o=e&&s.agentPresets[t]?s.agentPresets[t]:U;n.querySelectorAll(".tab-btn, .tab-content").forEach(m=>m.classList.remove("active")),n.querySelector('.tab-btn[data-tab="config"]')?.classList.add("active"),n.querySelector('.tab-content[data-tab-content="config"]')?.classList.add("active");const r=n.querySelector('.tab-content[data-tab-content="system"]');r&&(r.dataset.rendered="false");const i=document.getElementById("agent-profile-picture-preview");i&&(i.src=o.profilePicture||"/PromptPrim/icon.png"),document.getElementById("agent-name-input").value=e?t:"New Agent",document.getElementById("agent-icon-button").textContent=o.icon||"🤖",document.getElementById("agent-id-display").value=o.id||`agent_${Date.now()}`,document.getElementById("agent-description").value=o.description||"",ye("agent-model-search-wrapper",o.model,z()),document.getElementById("agent-system-prompt").value=o.systemPrompt,document.getElementById("agent-use-markdown").checked=o.useMarkdown,document.getElementById("agent-enable-web-search").checked=o.enableWebSearch;const d=document.getElementById("agent-params-container");if(d){const p=z().find(S=>S.id===o.model),y=p?p.provider:"openrouter",b=ve(d,o,y);a.setState("activeParameterEditor",b)}const c=document.getElementById("agent-created-by-input");c&&(c.value=e?o.createdBy||"Unknown":P().userName);const l=document.getElementById("agent-created-date");l&&(l.textContent=o.createdAt?new Date(o.createdAt).toLocaleString():"Not saved yet");const u=document.getElementById("agent-modified-date");u&&(u.textContent=o.modifiedAt?new Date(o.modifiedAt).toLocaleString():"Not saved yet"),je(o.tags),mn(o.activeMemories),pn(o.type==="third-party"),Ce(),n.style.display="flex"}function gn(){const e=document.getElementById("agent-editor-modal");if(!e)return;e.querySelector(".tab-buttons")?.addEventListener("click",c=>{const l=c.target.closest(".tab-btn");if(!l)return;const u=l.dataset.tab;e.querySelectorAll(".tab-btn, .tab-content").forEach(m=>m.classList.remove("active")),l.classList.add("active"),e.querySelector(`.tab-content[data-tab-content="${u}"]`)?.classList.add("active")}),e.addEventListener("click",c=>{const l=c.target;if(l.matches(".modal-actions .btn:not(.btn-secondary)"))a.bus.publish("agent:save");else if(l.closest("#generate-agent-profile-btn"))a.bus.publish("agent:generateProfile");else if(l.matches(".btn-secondary")||l.closest(".modal-close-btn"))ae();else if(l.closest("#agent-id-copy-btn")){const u=document.getElementById("agent-id-display");navigator.clipboard.writeText(u.value)}});const n=document.getElementById("agent-tags-input");n?.addEventListener("keydown",c=>{if(c.key==="Enter"){c.preventDefault(),c.stopPropagation();const l=n.value.trim();if(l){const u=Array.from(document.querySelectorAll("#agent-tags-container .tag-pill")).map(m=>m.dataset.tag);u.includes(l)||je([...u,l]),n.value=""}}});const s=document.getElementById("agent-icon-button"),o=document.getElementById("agent-emoji-picker");s&&o&&(s.addEventListener("click",c=>{c.stopPropagation(),document.body.classList.contains("dark-mode")?(o.classList.add("dark"),o.classList.remove("light")):(o.classList.add("light"),o.classList.remove("dark")),o.classList.toggle("hidden")}),o.addEventListener("emoji-click",c=>{c.detail.emoji&&(s.textContent=c.detail.emoji.unicode,o.classList.add("hidden"))}),document.addEventListener("click",c=>{!o.classList.contains("hidden")&&!o.contains(c.target)&&c.target!==s&&o.classList.add("hidden")}));const r=document.getElementById("agent-profile-picture-upload"),i=document.getElementById("agent-profile-picture-preview");r&&i&&r.addEventListener("change",c=>{const l=c.target.files?.[0];if(!l)return;if(!l.type.startsWith("image/")){g("Please select an image file (e.g., PNG, JPG, WEBP).","Unsupported File");return}const u=2*1024*1024;if(l.size>u){g("The selected image is too large. Please select a file smaller than 2MB.","File Too Large");return}const m=new FileReader;m.onload=p=>{i.src=p.target?.result||""},m.readAsDataURL(l)}),a.bus.subscribe("agent:editorShouldClose",ae);const d=()=>{e&&e.style.display==="flex"&&Ce()};a.bus.subscribe("models:loaded",d),a.bus.subscribe("user:modelsLoaded",d),a.bus.subscribe("agent:profileGenerated",c=>{if(!c)return;document.getElementById("agent-name-input").value=c.agent_name||"",document.getElementById("agent-icon-input").value=c.agent_icon||"",document.getElementById("agent-system-prompt").value=c.system_prompt||"";const l=a.getState().editingAgentName,u=a.getProject(),m=l?u.agentPresets[l]:U,p={...m,temperature:c.temperature??m.temperature,topP:c.top_p??m.topP,topK:c.top_k??m.topK,max_tokens:c.max_tokens??m.max_tokens,frequency_penalty:c.frequency_penalty??m.frequency_penalty,presence_penalty:c.presence_penalty??m.presence_penalty,seed:c.seed??m.seed},y=document.getElementById("agent-params-container");if(y){const b=a.getState().activeParameterEditor;b&&b.destroy();const $e=ve(y,p,"openrouter");a.setState("activeParameterEditor",$e)}}),a.bus.subscribe("agent:promptEnhanced",({newPrompt:c})=>{const l=document.getElementById("agent-system-prompt");l&&(l.value=c)})}function yn(e){const n=a.getProject().activeEntity,s=a.getStagedEntity(),o=document.createElement("div");return o.className="item group-item",o.dataset.groupName=e,n?.type==="group"&&n.name===e?o.classList.add("active"):s?.type==="group"&&s.name===e&&o.classList.add("staged"),o.innerHTML=`
     <div class="item-header">
        <span class="item-name"><span class="item-icon">🤝</span> ${e}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="group:edit" title="Edit Group">
                <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="btn-icon danger" data-action="group:delete" title="Delete Group">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,o}function fn(e){if(!e)return;const t=a.getProject();if(!t||!t.agentGroups)return;e.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>🤝 Agent Groups</h3>
                <button class="btn-icon" data-action="group:create" title="Create New Group">+</button>
            </summary>
            <div class="section-box">
                <div id="agentGroupList" class="item-list"></div>
            </div>
        </details>
    `);const s=e.querySelector("#agentGroupList:last-of-type");if(!s)return;const o=t.agentGroups;for(const r in o)s.appendChild(yn(r))}function Be(){const e=document.getElementById("group-flow-select").value,t=document.getElementById("group-rounds-control"),n=document.getElementById("group-timer-control");!t||!n||(e==="round-robin"?(t.classList.remove("hidden"),n.classList.add("hidden")):(t.classList.add("hidden"),n.classList.remove("hidden")))}function ie(e=!1,t=null){a.setState("editingGroupName",e?t:null);const n=a.getProject(),s=e?n.agentGroups[t]:null;document.getElementById("agent-group-modal-title").textContent=e?`Edit Group: ${t}`:"Create New Agent Group",document.getElementById("group-name-input").value=e?t:"";const o=document.getElementById("group-member-list");o.innerHTML="";const r=s?s.agents||[]:[],i=Object.keys(n.agentPresets),d=s?[...r]:[];i.forEach(c=>{d.includes(c)||d.push(c)}),d.forEach(c=>{const l=r.includes(c),u=document.createElement("div");u.className="agent-sortable-item",u.dataset.agentName=c,u.dataset.id=c;const m=`agent-cb-${c.replace(/\s+/g,"-")}`;u.innerHTML=`
            <input type="checkbox" id="${m}" ${l?"checked":""}>
            <label for="${m}">${c}</label>
            <span class="drag-handle">&#x2630;</span>
        `,u.querySelector('input[type="checkbox"]').addEventListener("change",()=>le(null)),o.appendChild(u)}),window.groupSortable&&window.groupSortable.destroy(),window.groupSortable=new Sortable(o,{animation:150,handle:".drag-handle"}),le(s?.moderatorAgent),document.getElementById("group-flow-select").value=s?.flowType||"auto-moderator",document.getElementById("group-max-turns-input").value=s?.maxTurns||1,document.getElementById("group-timer-input").value=s?.timerInSeconds||0,document.getElementById("group-summarization-threshold-input").value=s?.summarizationTokenThreshold??3e3,Be(),document.getElementById("agent-group-editor-modal").style.display="flex"}function ce(){window.groupSortable&&(window.groupSortable.destroy(),window.groupSortable=null),document.getElementById("agent-group-editor-modal").style.display="none",a.setState("editingGroupName",null)}function le(e=null){const t=document.getElementById("group-moderator-select"),n=document.querySelectorAll("#group-member-list .agent-sortable-item"),s=Array.from(n).filter(r=>r.querySelector('input[type="checkbox"]').checked).map(r=>r.dataset.agentName),o=t.value;t.innerHTML='<option value="">-- Select Moderator --</option>',s.forEach(r=>{t.add(new Option(r,r))}),e&&s.includes(e)?t.value=e:s.includes(o)&&(t.value=o)}function bn(){a.bus.subscribe("group:editorShouldClose",ce);const e=document.getElementById("agent-group-editor-modal");e&&(e.addEventListener("click",t=>{t.target.matches(".modal-actions .btn:not(.btn-secondary)")?a.bus.publish("group:save"):(t.target.matches(".btn-secondary")||t.target.closest(".modal-close-btn"))&&ce()}),e.addEventListener("click",t=>{if(t.target.matches(".stepper-btn")){const n=t.target.parentElement.querySelector('input[type="number"]');if(!n)return;let s=parseInt(n.value,10)+parseInt(t.target.dataset.step,10);s=Math.max(n.min,Math.min(n.max,s)),n.value=s}})),document.getElementById("group-flow-select")?.addEventListener("change",Be),console.log("✅ Group UI Initialized (Studio listener removed).")}let H=null;function hn(e,t,n){const s=document.createElement("div");s.className=`item memory-item ${t?"":"inactive"}`,s.dataset.name=e.name,s.dataset.memoryIndex=n;const r=fe([{label:"Edit...",action:"memory:edit",data:{index:n}},{label:"Delete",action:"memory:delete",data:{index:n},isDestructive:!0}]),i=document.createElement("div");i.className=`memory-toggle ${t?"active":""}`,i.title=`Click to ${t?"deactivate":"activate"}`,i.onclick=l=>{l.stopPropagation(),a.bus.publish("memory:toggle",{name:e.name})};const d=document.createElement("span");d.className="item-name",d.textContent=e.name;const c=document.createElement("div");return c.className="item-header",c.appendChild(i),c.appendChild(d),c.appendChild(r),s.appendChild(c),s}function vn(e){if(!e)return;const t=a.getProject();if(!t)return;const n=document.createElement("details");n.className="collapsible-section memory-section",n.open=!0;const s=document.createElement("summary");s.className="section-header",s.innerHTML="<h3>🧠 Command Memories</h3>";const o=[{label:"New Memory...",action:"memory:create"},{label:"Export Package...",action:"memory:exportPackage"},{label:"Import Package...",action:"memory:importPackage"}];s.appendChild(fe(o)),n.appendChild(s);const r=document.createElement("div");r.className="section-box",n.appendChild(r);const i=t.agentPresets?.[t.activeEntity?.name];if(!i)r.innerHTML='<p class="no-items-message">Select an Agent to see memories.</p>';else{r.innerHTML=`
            <details id="active-memories-details" open><summary>Active Memories</summary><div id="activeMemoriesList" class="item-list"></div></details>
            <details id="inactiveMemoriesSection" open><summary>Inactive Memories</summary><div id="inactiveMemoriesList" class="item-list"></div></details>
        `;const d=r.querySelector("#activeMemoriesList"),c=r.querySelector("#inactiveMemoriesList"),l=i.activeMemories||[];(t.memories||[]).forEach((m,p)=>{const y=l.includes(m.name);(y?d:c).appendChild(hn(m,y,p))}),H&&H.destroy(),H=new Sortable(d,{animation:150,onEnd:m=>{const p=a.getProject().agentPresets[a.getProject().activeEntity.name];if(!p)return;const y=m.item.dataset.name;p.activeMemories.splice(m.oldDraggableIndex,1),p.activeMemories.splice(m.newDraggableIndex,0,y),a.bus.publish("studio:contentShouldRender")}})}e.appendChild(n)}function de(e=null){const t=a.getProject(),n=document.getElementById("memory-editor-modal");if(!n)return;const s=t.memories||[];if(e!==null&&s[e]){const o=s[e];console.log("Editing memory at",e,o),n.querySelector("#memory-modal-title").textContent="Edit Memory",n.querySelector("#memory-name-input").value=o.name,n.querySelector("#memory-content-input").value=o.content,n.querySelector("#memory-edit-index").value=e}else console.log("Create new memory",e,s),n.querySelector("#memory-modal-title").textContent="Create New Memory",n.querySelector("#memory-name-input").value="",n.querySelector("#memory-content-input").value="",n.querySelector("#memory-edit-index").value="";n.style.display="flex"}function ue(){document.getElementById("memory-editor-modal").style.display="none"}function Sn(){a.bus.subscribe("memory:editorShouldClose",ue);const e=document.getElementById("memory-editor-modal");e&&e.addEventListener("click",t=>{const n=t.target;n.matches(".modal-actions .btn:not(.btn-secondary)")&&a.bus.publish("memory:save"),(n.matches(".btn-secondary")||n.closest(".modal-close-btn")||n===e)&&ue()})}function En(){const e=a.getProject();if(!e||!e.agentPresets)return[];const t=document.getElementById("asset-search-input")?.value.toLowerCase()||"",n=document.getElementById("asset-sort-select")?.value||"modified-desc";let s=Object.entries(e.agentPresets).map(([o,r])=>({name:o,...r}));return t&&(s=s.filter(o=>[o.name,o.id,o.description,o.model,...o.tags||[]].join(" ").toLowerCase().includes(t))),s.sort((o,r)=>{switch(n){case"modified-desc":return r.modifiedAt-o.modifiedAt;case"modified-asc":return o.modifiedAt-r.modifiedAt;case"created-desc":return r.createdAt-o.createdAt;case"created-asc":return o.createdAt-r.createdAt;case"name-asc":return o.name.localeCompare(r.name);case"name-desc":return r.name.localeCompare(o.name);default:return 0}}),s}function Pn(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=s=>{try{const o=JSON.parse(s.target.result);if(typeof o!="object"||o===null||Array.isArray(o))throw new Error("Invalid file format. Expected a JSON object of agents.");const r=a.getProject();let i=0,d=0;for(const c in o)r.agentPresets[c]?confirm(`Agent "${c}" already exists. Overwrite?`)&&(r.agentPresets[c]=o[c],d++):(r.agentPresets[c]=o[c],i++);a.setProject(r),a.updateAndPersistState(),a.bus.publish("studio:contentShouldRender"),g(`Import complete! Added: ${i}, Overwritten: ${d}.`,"Success")}catch(o){console.error("Failed to import agents:",o),g(`Error importing agents: ${o.message}`,"Error")}},n.readAsText(t),e.target.value=""}function L(){const e=document.querySelector("#studio-panel .studio-assets-container");if(!e)return;e.innerHTML="";const t=En();un(e,t),fn(e),vn(e)}function wn(){const e=document.getElementById("studio-panel");if(!e||e.dataset.listenerAttached==="true")return;e.dataset.listenerAttached="true",e.addEventListener("click",o=>{const r=o.target,i=r.closest(".memory-toggle");if(i){o.stopPropagation();const l=i.closest(".item[data-name]");l&&a.bus.publish("memory:toggle",{name:l.dataset.name});return}const d=r.closest("[data-action]");if(d){o.preventDefault(),o.stopPropagation();const l=d.dataset.action;let m={...r.closest(".item")?.dataset};if(d.dataset.data)try{const p=JSON.parse(d.dataset.data);Object.assign(m,p)}catch(p){console.error("Failed to parse data attribute JSON",p)}l==="toggle-menu"?k(o):(a.bus.publish(l,m),d.closest(".dropdown.open")?.classList.remove("open"));return}const c=r.closest(".item");if(c){o.preventDefault();const{agentName:l,groupName:u}=c.dataset;l?a.bus.publish("studio:itemClicked",{type:"agent",name:l}):u&&a.bus.publish("studio:itemClicked",{type:"group",name:u});return}});const t=document.getElementById("asset-search-input"),n=document.getElementById("asset-sort-select");t?.addEventListener("input",L),n?.addEventListener("change",L),document.getElementById("import-agents-input")?.addEventListener("change",Pn),a.bus.subscribe("project:loaded",L),a.bus.subscribe("studio:contentShouldRender",L),a.bus.subscribe("entity:selected",L),a.bus.subscribe("entity:staged",L),console.log("✅ Studio UI Initialized with definitive, robust event listeners.")}async function An(){const e=document.getElementById("enhancer-prompt-input").value.trim();if(!e){g("Please describe the agent you want to create or enhance.","Error");return}const t=a.getProject().globalSettings.systemUtilityAgent;if(!t||!t.model){g("System Utility Model not configured in Settings.","Error");return}const n=document.getElementById("generate-agent-profile-btn");n&&n.classList.add("is-loading"),a.bus.publish("agent:enhancerStatus",{text:"Processing request...",color:"var(--text-dark)"});try{const s=!!a.getState().editingAgentName;let o="";s?o=`You are an expert in refining LLM system prompts. Your task is to modify an existing system prompt based on a user's new request. Do not replace the original prompt, but integrate the new instruction into it cohesively. Respond ONLY with the new, complete, and modified system prompt as a single block of text.

            EXISTING PROMPT:
            ---
            ${document.getElementById("agent-system-prompt").value}
            ---

            USER'S MODIFICATION REQUEST:
            ---
            ${e}
            ---

            NEW, MODIFIED SYSTEM PROMPT:`:o=`You are an expert in designing LLM agent profiles. Based on the user's request, create a complete agent profile.
            Your response MUST be ONLY a single, valid JSON object with these exact keys:
            - "agent_name": string
            - "agent_icon": string (a single emoji)
            - "system_prompt": string
            - "temperature": number (between 0 and 2)
            - "top_p": number (between 0 and 1)
            - "top_k": integer (0 or higher)
            - "max_tokens": integer (e.g., 4096)
            - "frequency_penalty": number (between -2 and 2)
            - "presence_penalty": number (between -2 and 2)
            - "seed": integer (-1 for random)

            User's Request: "${e}"`;const r=await be(t,[{role:"user",content:o}]);if(!r||typeof r.content!="string")throw new Error("Received an invalid or empty response from the AI.");if(s)a.bus.publish("agent:promptEnhanced",{newPrompt:r.content}),a.bus.publish("agent:enhancerStatus",{text:"Prompt enhanced successfully!",color:"var(--success-color)"});else{const i=r.content.match(/{.*}/s);if(!i)throw new Error("LLM did not return a valid JSON object.");const d=JSON.parse(i[0]);a.bus.publish("agent:profileGenerated",d),a.bus.publish("agent:enhancerStatus",{text:"Profile generated successfully!",color:"var(--success-color)"})}}catch(s){console.error("Agent Profile Generation/Enhancement Error:",s);const o=`Error: ${s.message}`;a.bus.publish("agent:enhancerStatus",{text:o,color:"var(--error-color)"}),g(o,"Profile Generation Failed")}finally{n&&n.classList.remove("is-loading"),setTimeout(()=>a.bus.publish("agent:enhancerStatus",{text:""}),5e3)}}function Ln(){const e=a.getProject(),t=a.getState().editingAgentName,n=document.getElementById("agent-name-input").value.trim();if(!n){g("Please enter a name for the agent.","Error");return}if(t!==n&&e.agentPresets[n]){g(`An agent named '${n}' already exists.`,"Error");return}const s={icon:document.getElementById("agent-icon-button").textContent,description:document.getElementById("agent-description").value,model:document.getElementById("agent-model-select").value,systemPrompt:document.getElementById("agent-system-prompt").value,useMarkdown:document.getElementById("agent-use-markdown").checked,enableWebSearch:document.getElementById("agent-enable-web-search").checked,profilePicture:document.getElementById("agent-profile-picture-preview").src,tags:Array.from(document.querySelectorAll("#agent-tags-container .tag-pill")).map(c=>c.dataset.tag),activeMemories:Array.from(document.querySelectorAll("#agent-memory-list .item input:checked")).map(c=>c.closest(".item").dataset.memoryName)},o=a.getState().activeParameterEditor,r=o?o.getValues():{},i={...s,...r},d=t&&e.agentPresets[t]?{...e.agentPresets[t]}:{...U,id:`agent_${Date.now()}`,createdBy:UserService.getCurrentUserProfile().userName,createdAt:Date.now()};d.modifiedAt=Date.now(),d.createdBy=document.getElementById("agent-created-by-input").value,Object.assign(d,i),t&&t!==n&&delete e.agentPresets[t],e.agentPresets[n]=d,(!t||e.activeEntity&&e.activeEntity.name===t)&&(e.activeEntity={type:"agent",name:n}),a.setProject(e),a.updateAndPersistState(),a.bus.publish("studio:contentShouldRender"),a.bus.publish("agent:editorShouldClose")}function In(e){const t=a.getProject();if(!e||Object.keys(t.agentPresets).length<=1){g("Cannot delete the last agent.","Error");return}confirm(`Are you sure you want to delete the agent '${e}'? This action cannot be undone.`)&&(delete t.agentPresets[e],Object.values(t.agentGroups).forEach(n=>{n.agents=n.agents.filter(s=>s!==e),n.moderatorAgent===e&&(n.moderatorAgent=n.agents[0]||"")}),t.chatSessions.forEach(n=>{n.linkedEntity?.type==="agent"&&n.linkedEntity.name===e&&(n.linkedEntity={type:"agent",name:Object.keys(t.agentPresets)[0]})}),t.activeEntity.type==="agent"&&t.activeEntity.name===e&&(t.activeEntity={type:"agent",name:Object.keys(t.agentPresets)[0]}),a.setProject(t),a.updateAndPersistState(),a.bus.publish("agent:listChanged"),a.bus.publish("entity:selected",t.activeEntity))}function jn(){const e=a.getProject(),t=a.getState().editingGroupName,n=document.getElementById("group-name-input").value.trim();if(!n){g("Group name cannot be empty.","Error");return}if(n!==t&&e.agentGroups[n]){g(`A group named "${n}" already exists.`,"Error");return}const s=document.getElementById("group-moderator-select").value;if(!s){g("Please select a Moderator for the group.","Error");return}const o=window.groupSortable?window.groupSortable.toArray():[],r=document.querySelectorAll("#group-member-list .agent-sortable-item"),i=Array.from(r).filter(l=>l.querySelector('input[type="checkbox"]').checked).map(l=>l.dataset.agentName),d=o.filter(l=>i.includes(l));if(d.length===0){g("A group must have at least one member.","Error");return}const c={agents:d,moderatorAgent:s,flowType:document.getElementById("group-flow-select").value,maxTurns:parseInt(document.getElementById("group-max-turns-input").value,10),timerInSeconds:parseInt(document.getElementById("group-timer-input").value,10),summarizationTokenThreshold:parseInt(document.getElementById("group-summarization-threshold-input").value,10)};t&&t!==n&&(delete e.agentGroups[t],e.chatSessions.forEach(l=>{l.linkedEntity?.type==="group"&&l.linkedEntity.name===t&&(l.linkedEntity.name=n)})),e.agentGroups[n]=c,a.setProject(e),a.updateAndPersistState(),a.bus.publish("group:editorShouldClose"),g(`Group "${n}" saved successfully.`,"Success"),a.bus.publish("studio:contentShouldRender")}function Cn({groupName:e}){if(!confirm(`Are you sure you want to delete the group "${e}"? This cannot be undone.`))return;const t=a.getProject();delete t.agentGroups[e],a.setProject(t),a.updateAndPersistState(),a.bus.publish("group:listChanged"),g(`Group "${e}" has been deleted.`,"Success")}function Bn({name:e}){const t=a.getProject(),n=t.activeEntity?.name;if(!n)return;const s=t.agentPresets[n];if(!s)return;s.activeMemories||(s.activeMemories=[]),s.activeMemories.includes(e)?s.activeMemories=s.activeMemories.filter(r=>r!==e):s.activeMemories.push(e),a.updateAndPersistState(),a.bus.publish("studio:contentShouldRender")}function Mn(){const e=a.getProject(),t=document.getElementById("memory-name-input").value.trim(),n=document.getElementById("memory-content-input").value,s=document.getElementById("memory-edit-index").value;if(!t){g("Memory name cannot be empty.","Error");return}if(s!==""){const o=e.memories[s].name;e.memories[s]={name:t,content:n},Object.values(e.agentPresets).forEach(r=>{if(r.activeMemories){const i=r.activeMemories.indexOf(o);i>-1&&(r.activeMemories[i]=t)}})}else{if(e.memories.some(o=>o.name===t)){g(`A memory named "${t}" already exists.`,"Error");return}e.memories.push({name:t,content:n})}a.setProject(e),a.updateAndPersistState(),a.bus.publish("memory:editorShouldClose"),a.bus.publish("studio:contentShouldRender"),g(`Memory "${t}" saved successfully.`,"Success")}function kn({index:e}){if(!confirm("Are you sure you want to permanently delete this memory? This cannot be undone."))return;const t=a.getProject();if(!t.memories[e])return;const n=t.memories[e].name;t.memories.splice(e,1),Object.values(t.agentPresets).forEach(s=>{s.activeMemories&&(s.activeMemories=s.activeMemories.filter(o=>o!==n))}),a.setProject(t),a.updateAndPersistState(),a.bus.publish("studio:contentShouldRender")}function xn(){const t={memories:a.getProject().memories},n=JSON.stringify(t,null,2),s=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(s),r=document.createElement("a");r.href=o,r.download=`promptprim_memories_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}function Tn(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=s=>{try{const o=JSON.parse(s.target.result);if(o&&Array.isArray(o.memories)){const r=a.getProject(),i=new Set(r.memories.map(c=>c.name)),d=o.memories.filter(c=>!i.has(c.name));r.memories.push(...d),a.setProject(r),a.updateAndPersistState(),a.bus.publish("studio:contentShouldRender"),g("Memory package imported successfully!","Success")}else throw new Error("Invalid memory package file.")}catch(o){g(`Error loading memory package: ${o.message}`,"Error")}},n.readAsText(t),e.target.value=""}async function $n(){const e=a.getProject(),t=e.chatSessions.find(r=>r.id===e.activeSessionId);if(!t)return;const n=document.getElementById("summary-model-value").value;if(!n){g("Please select a model for summarization in the Settings tab.","Error");return}const s={...e.globalSettings.systemUtilityAgent,model:n},o=t.history.filter(r=>r.role==="user"||r.role==="assistant");if(o.length===0){g("Not enough messages to summarize.","Info");return}me(!0);try{const r=o.map(l=>`${l.speaker||l.role}: ${Array.isArray(l.content)?l.content.find(u=>u.type==="text")?.text||"[multimodal content]":l.content}`).join(`
`),d=document.getElementById("summary-modal-prompt-textarea").value.replace(/\$\{previousSummary\}/g,"This is a full-history summary from the beginning.").replace(/\$\{newMessages\}/g,r),c=await be(s,[{role:"user",content:d}]);if(!c||typeof c.content!="string")throw new Error("Received an invalid or empty response from the AI summarizer.");document.getElementById("summary-editor-title").value=`Summary of "${t.name}" at ${new Date().toLocaleTimeString()}`,document.getElementById("summary-editor-content").value=c.content,ke("new")}catch(r){g(`Summarization Failed: ${r.message}`,"Error")}finally{me(!1)}}function Un(){const e=a.getProject(),t=e.chatSessions.find(i=>i.id===e.activeSessionId),n=document.getElementById("summary-editor-title").value.trim(),s=document.getElementById("summary-editor-content").value.trim();if(!n||!s){g("Title and content cannot be empty.","Error");return}const o={id:`sum_${Date.now()}`,summary:n,content:s,timestamp:Date.now(),sourceSessionId:t.id};e.summaryLogs||(e.summaryLogs=[]),e.summaryLogs.push(o);const r={role:"system",content:`[Conversation summarized: "${n}"]`,isSummaryMarker:!0,summaryLogId:o.id};t.history.push(r),a.updateAndPersistState(),g("New summary log saved!","Success"),C(o.id),a.bus.publish("ui:renderMessages")}function Nn({logId:e,title:t,content:n}){if(!e||!t||!n)return;const o=a.getProject().summaryLogs.find(r=>r.id===e);o&&(o.summary=t,o.content=n,a.updateAndPersistState(),g("Changes saved!","Success"),te())}function Dn({logId:e}){if(!confirm("Are you sure you want to delete this summary log?"))return;const t=a.getProject();t.summaryLogs=t.summaryLogs.filter(n=>n.id!==e),t.chatSessions.forEach(n=>{n.summaryState?.activeSummaryId===e&&(n.summaryState.activeSummaryId=null)}),a.updateAndPersistState(),g("Log deleted.","Success"),C(null)}function qn({logId:e}){const t=a.getProject(),n=t.chatSessions.find(r=>r.id===t.activeSessionId),s=t.summaryLogs.find(r=>r.id===e);if(!n||!s)return;n.summaryState={activeSummaryId:s.id};const o={role:"system",content:`[System: Context loaded from summary: "${s.summary}"]`,isSummary:!0};n.history.push(o),a.updateAndPersistState(),a.bus.publish("ui:renderMessages"),Y(),g("Summary loaded into context!","Success")}function ee(){const t=document.getElementById("summary-modal-preset-select").value;if(t==="custom")return;const n=a.getProject(),s={...v,...n.globalSettings.summarizationPromptPresets};s[t]&&(document.getElementById("summary-modal-prompt-textarea").value=s[t],a.bus.publish("ui:renderSummarizationSelector"),a.bus.publish("ui:updateSummaryActionButtons"))}async function On({saveAs:e}){const t=document.getElementById("summary-modal-preset-select"),n=document.getElementById("summary-modal-prompt-textarea").value.trim();if(!n)return;let s=t.value;const o=v.hasOwnProperty(s);if((e||o||s==="custom")&&(s=prompt("Enter a name for this preset:",o?`${s} (Copy)`:"My Custom Prompt"),!s||!s.trim()))return;const r=a.getProject(),i=s.trim();r.globalSettings.summarizationPromptPresets[i]&&i!==t.value&&!confirm(`A preset named '${i}' already exists. Overwrite?`)||(r.globalSettings.summarizationPromptPresets[i]=n,a.setProject(r),await a.updateAndPersistState(),a.bus.publish("ui:renderSummarizationSelector"),setTimeout(()=>{const d=document.getElementById("summary-modal-preset-select");d&&(d.value=i),a.bus.publish("ui:updateSummaryActionButtons")},50),g(`Preset '${i}' saved!`,"Success"))}async function Hn(){const t=document.getElementById("summary-modal-preset-select").value;if(!v.hasOwnProperty(t)&&confirm(`Delete user preset "${t}"?`)){const n=a.getProject();delete n.globalSettings.summarizationPromptPresets[t],document.getElementById("summary-modal-prompt-textarea").value=v.Standard,a.setProject(n),await a.updateAndPersistState(),a.bus.publish("ui:renderSummarizationSelector"),g(`Preset '${t}' deleted.`,"Success")}}async function Fn(){const t=document.getElementById("summary-modal-preset-select").value;if(v.hasOwnProperty(t)||t==="custom")return;const n=prompt(`Enter new name for "${t}":`,t);if(!n||!n.trim()||n.trim()===t)return;const s=a.getProject(),o=n.trim();if(s.globalSettings.summarizationPromptPresets[o]){g(`A preset named '${o}' already exists.`,"Error");return}s.globalSettings.summarizationPromptPresets[o]=s.globalSettings.summarizationPromptPresets[t],delete s.globalSettings.summarizationPromptPresets[t],a.setProject(s),await a.updateAndPersistState(),a.bus.publish("ui:renderSummarizationSelector"),setTimeout(()=>{document.getElementById("summary-modal-preset-select").value=o,a.bus.publish("ui:updateSummaryActionButtons")},50),g(`Preset renamed to '${o}'!`,"Success")}function Rn({logId:e,messageIndex:t}){if(!confirm("Are you sure you want to delete this summary log? This will also remove the marker from the chat."))return;const n=a.getProject();n.summaryLogs=n.summaryLogs.filter(o=>o.id!==e);const s=n.chatSessions.find(o=>o.id===n.activeSessionId);s&&(s.history=s.history.filter(o=>o.summaryLogId!==e)),n.chatSessions.forEach(o=>{o.summaryState?.activeSummaryId===e&&(o.summaryState.activeSummaryId=null)}),a.updateAndPersistState(),g("Log deleted.","Success"),a.bus.publish("ui:renderMessages"),C(null)}let h=null;function Me(){const e=document.getElementById("summarization-modal");if(!e)return;const t=e.querySelector("#summary-modal-preset-select"),n=e.querySelector("#summary-modal-preset-actions .dropdown-content");if(!t||!n)return;n.innerHTML="";const s=t.options[t.selectedIndex];if(!s)return;const o=v.hasOwnProperty(s.value),r=s.value==="custom",i=(d,c,l={})=>{const u=document.createElement("a");return u.href="#",u.textContent=d,u.dataset.action=c,l.saveAs&&(u.dataset.saveAs="true"),u};if(r||o)n.appendChild(i(o?"Save as a Copy...":"Save as New Preset...","settings:saveSummaryPreset",{saveAs:!0}));else{n.appendChild(i("Save Changes","settings:saveSummaryPreset")),n.appendChild(i("Rename...","settings:renameSummaryPreset")),n.appendChild(i("Save as New Preset...","settings:saveSummaryPreset",{saveAs:!0})),n.appendChild(document.createElement("div")).className="dropdown-divider";const d=i("Delete Preset","settings:deleteSummaryPreset");d.classList.add("is-destructive"),n.appendChild(d)}}function K(){const e=a.getProject();if(!e||!e.globalSettings)return;const t=document.querySelector("#summarization-modal #summary-modal-preset-select");if(!t)return;const n=e.globalSettings.summarizationPromptPresets||{},s=t.value;t.innerHTML="";const o=document.createElement("optgroup");o.label="Factory Presets",t.appendChild(o);const r=document.createElement("optgroup");r.label="User Presets",t.appendChild(r);let i=!1;for(const d in n){const c=new Option(d,d);v.hasOwnProperty(d)?o.appendChild(c):(r.appendChild(c),i=!0)}i||r.remove(),n[s]?t.value=s:(t.value="Standard",ee()),Me()}function zn(e){const t=document.createElement("div");return t.className="item summary-log-item",t.dataset.logId=e.id,e.id===h&&t.classList.add("active"),t.innerHTML=`<span class="item-name"><span class="item-icon">💡</span> ${e.summary}</span>`,t.title=`Created: ${new Date(e.timestamp).toLocaleString()}`,t}function ke(e){const t=document.getElementById("summary-editor-actions"),n=document.getElementById("summarize-conversation-btn");!t||!n||(t.classList.remove("hidden"),n.classList.add("hidden"),t.querySelector("#summary-editor-delete-btn").style.display=e==="existing"?"inline-flex":"none",t.querySelector("#summary-editor-load-btn").style.display=e==="existing"?"inline-flex":"none",t.querySelector("#summary-editor-save-btn").textContent=e==="existing"?"Save Changes":"Save New Log")}function xe(){const e=document.getElementById("summarization-modal");if(!e)return;const t=e.querySelector("#summary-editor-actions"),n=e.querySelector("#summarize-conversation-btn");e.querySelector(".tab-btn.active")?.dataset.tab==="settings"?(t.classList.add("hidden"),n.classList.add("hidden")):h?(t.classList.remove("hidden"),n.classList.add("hidden")):(t.classList.add("hidden"),n.classList.remove("hidden"))}function C(e){h=e;const n=a.getProject().summaryLogs.find(s=>s.id===e);document.getElementById("summary-editor-title").value=n?n.summary:"",document.getElementById("summary-editor-content").value=n?n.content:"",n?ke("existing"):(document.getElementById("summary-editor-actions").classList.add("hidden"),document.getElementById("summarize-conversation-btn").classList.remove("hidden")),te()}function te(){const e=document.getElementById("summary-log-list-modal");if(!e)return;const t=a.getProject();e.innerHTML="";const n=t.summaryLogs||[];if(n.length===0){e.innerHTML='<p class="no-items-message">No summaries yet.</p>';return}const s=n.reduce((o,r)=>{const i=r.sourceSessionId,d=t.chatSessions.find(c=>c.id===i);return o[i]||(o[i]={name:d?d.name:"Unknown Session",logs:[]}),o[i].logs.push(r),o},{});Object.values(s).forEach(o=>{const r=o.logs.sort((d,c)=>c.timestamp-d.timestamp),i=document.createElement("details");i.open=!0,i.innerHTML=`<summary>For: ${o.name}</summary>`,r.forEach(d=>i.appendChild(zn(d))),e.appendChild(i)})}function W(){const e=document.getElementById("summarization-modal");if(!e)return;e.querySelectorAll(".tab-btn, .tab-content").forEach(o=>o.classList.remove("active")),e.querySelector('.tab-btn[data-tab="logs"]')?.classList.add("active"),e.querySelector('.tab-content[data-tab-content="logs"]')?.classList.add("active"),C(null),te(),K(),ee(),xe();const t=z(),s=a.getProject().globalSettings.systemUtilityAgent?.model;ye("summary-model-wrapper",s,t),e.style.display="flex"}function Y(){const e=document.getElementById("summarization-modal");e&&(e.style.display="none")}function me(e){const t=document.getElementById("summarize-conversation-btn");t&&t.classList.toggle("is-loading",e)}function Gn(){const e=document.getElementById("summarization-modal");if(!e)return;e.querySelector("#summary-modal-close-btn")?.addEventListener("click",Y),e.querySelector(".modal-close-btn")?.addEventListener("click",Y),e.querySelector("#summarize-conversation-btn")?.addEventListener("click",$n),e.querySelector("#summary-editor-save-btn")?.addEventListener("click",()=>{h?Nn({logId:h,title:document.getElementById("summary-editor-title").value,content:document.getElementById("summary-editor-content").value}):Un()}),e.querySelector("#summary-editor-delete-btn")?.addEventListener("click",()=>{h&&Dn({logId:h})}),e.querySelector("#summary-editor-load-btn")?.addEventListener("click",()=>{h&&qn({logId:h})}),e.querySelector(".tab-buttons")?.addEventListener("click",s=>{if(s.target.matches(".tab-btn")){const o=s.target.dataset.tab;e.querySelectorAll(".tab-btn, .tab-content").forEach(r=>r.classList.remove("active")),s.target.classList.add("active"),e.querySelector(`.tab-content[data-tab-content="${o}"]`)?.classList.add("active"),xe()}}),e.querySelector("#summary-log-list-modal")?.addEventListener("click",s=>{const o=s.target.closest(".summary-log-item[data-log-id]");o&&C(o.dataset.logId)}),e.querySelector("#summary-modal-preset-select")?.addEventListener("change",()=>{ee()}),e.querySelector("#summary-modal-prompt-textarea")?.addEventListener("input",()=>{K()});const t=e.querySelector("#summary-modal-preset-actions");t&&t.addEventListener("click",s=>{const o=s.target.closest("a[data-action], button[data-action]");if(!o)return;s.preventDefault(),s.stopPropagation();const r=o.dataset.action;if(r==="toggle-menu")k(s);else{const i=o.dataset.saveAs==="true";r==="settings:saveSummaryPreset"?On({saveAs:i}):r==="settings:renameSummaryPreset"?Fn():r==="settings:deleteSummaryPreset"&&Hn(),o.closest(".dropdown.open")?.classList.remove("open")}});const n=document.getElementById("summary-model-value");n&&n.addEventListener("change",s=>{const o=s.target.value;if(o){const r=a.getProject();r&&r.globalSettings.systemUtilityAgent&&(r.globalSettings.systemUtilityAgent.model=o,a.updateAndPersistState(),console.log(`Summary/System model updated to: ${o}`))}}),a.bus.subscribe("ui:renderSummarizationSelector",K),a.bus.subscribe("ui:updateSummaryActionButtons",Me),a.bus.subscribe("app:settingsChanged",()=>{e&&e.style.display==="flex"&&W()}),console.log("✅ Summarization Center UI Initialized.")}function _n(e){(void 0)({openrouterKey:e}),a.bus.publish("api:loadModels")}function Jn(e){(void 0)({ollamaBaseUrl:e})}function Kn(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=s=>{try{const o=JSON.parse(s.target.result);if(o&&o.userProfile&&o.appSettings&&o.modelPresets)confirm("This will overwrite your current settings and reload the application. Are you sure?")&&(localStorage.setItem("promptPrimUserSettings_v1",JSON.stringify(o)),g("Settings imported! The app will now reload.","Success"),setTimeout(()=>window.location.reload(),1500));else throw new Error("Invalid settings file format.")}catch(o){g(`Error importing settings: ${o.message}`,"Error")}},n.readAsText(t),e.target.value=""}function F(){const e=P();if(!e)return;const t=document.querySelector("#user-profile-menu .user-name"),n=document.querySelector("#user-profile-menu .user-plan"),s=document.getElementById("user-userCredits"),o=s?.querySelector("span:last-child"),r=document.querySelector("#user-profile-btn span");if(r&&e.userName&&(r.textContent=e.userName.charAt(0).toUpperCase()),t&&(t.textContent=e.userName||"User"),n){let i="Unknown",d="status-blocked";e.plan==="master"?(i=e.planStatus==="active"?"Master Plan":"Subscription Expired",d=e.planStatus==="active"?"status-master":"status-blocked"):e.plan==="pro"?e.planStatus==="active"&&e.credits.current>0?(i="Pro Plan",d="status-active"):e.planStatus==="grace_period"?(i="Pro (Grace Period)",d="status-grace"):(i="Account Blocked",d="status-blocked"):e.plan==="free"&&(i=e.credits.current>0?"Free Plan":"Credits Depleted",d=e.credits.current>0?"status-free":"status-blocked"),n.textContent=i,n.className=`user-plan ${d}`}if(s&&o)if(e.plan==="master")s.style.display="none";else{s.style.display="flex";const i=he(e.credits?.current??0);o.textContent=`$${i.toFixed(2)}`}}function Wn(){const e=document.querySelector(".user-profile-container"),t=document.getElementById("user-switcher-modal");!e||!t||(e.addEventListener("click",n=>{const s=n.target.closest("[data-action]");if(!s)return;const o=s.dataset.action;switch(o!=="toggle-menu"&&n.preventDefault(),o){case"toggle-menu":k(n);break;case"user:account":a.bus.publish("ui:showAccountModal"),e.classList.remove("open");break;case"user:settings":ze(),e.classList.remove("open");break;case"user:logout":t.style.display="flex",e.classList.remove("open");break}}),t.addEventListener("click",n=>{const s=n.target,o=s.closest("button[data-user-id]");if(o){const r=o.dataset.userId;Ge(r),g(`Switched to ${r}. The app will now reload.`,"Success"),t.style.display="none",setTimeout(()=>window.location.reload(),1500)}(s.matches(".modal-close-btn")||s===t)&&(t.style.display="none")}),_e("theme-switcher-dropdown"),a.bus.subscribe("user:settingsLoaded",F),a.bus.subscribe("user:settingsUpdated",F),F())}function Yn(e){const t=P();t&&confirm(`Are you sure you want to switch to the ${e} plan?`)&&(console.log(`HANDLER: Changing plan for ${t.userId} to ${e}`),Je(t.userId,e),g(`Successfully switched to ${e} plan!`,"Success"))}function Vn(e){const t=P();t&&(console.log(`HANDLER: Refilling $${e} for ${t.userId}`),Ke(t.userId,e),g(`Successfully added credits worth $${e}!`,"Success"))}const E=document.getElementById("account-modal"),R=document.getElementById("account-modal-body");function Xn(){E&&(Te(),E.style.display="flex")}function Qn(){E&&(E.style.display="none")}function Te(){const e=P();if(!R||!e){R.innerHTML="<p>Could not load user data.</p>";return}let t="";e.plan==="free"?t='<button class="btn" data-action="switch-plan" data-plan="pro">Upgrade to Pro</button>':e.plan==="pro"?t=`
            <button class="btn btn-secondary" data-action="switch-plan" data-plan="free">Downgrade to Free</button>
            <button class="btn" data-action="switch-plan" data-plan="master">Upgrade to Master</button>
        `:e.plan==="master"&&(t=`
            <button class="btn btn-secondary" data-action="switch-plan" data-plan="pro">Downgrade to Pro</button>
        `);const s=[10,30,50,100].map(r=>`<button class="btn btn-small btn-secondary" data-action="refill" data-amount="${r}">$${r}</button>`).join(""),o=he(e.credits.current);R.innerHTML=`
        <div class="user-detail-grid">
            <div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" value="${e.userName}" readonly>
                </div>
                 <div class="form-group">
                    <label>Current Plan</label>
                    <input type="text" value="${e.plan.charAt(0).toUpperCase()+e.plan.slice(1)}" readonly>
                </div>
                <div class="form-group">
                    <label>Credits</label>
                    <input type="text" value="${Math.floor(e.credits.current).toLocaleString()}" readonly>
                </div>
                <div class="form-group">
                    <label>Balance</label> 
                    <input type="text" value="$${o.toFixed(2)}" readonly>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>Change Plan</label>
                    <div>${t||"<p>No plan changes available.</p>"}</div>
                </div>
                <div class="form-group">
                    <label>Refill Credits (USD)</label>
                    <div class="refill-presets">${e.plan==="master"?"<p>Not applicable.</p>":s}</div>
                </div>
            </div>
        </div>
    `}function Zn(){a.bus.subscribe("ui:showAccountModal",Xn),E?.addEventListener("click",e=>{if(e.target.matches(".modal-close-btn")){Qn();return}const n=e.target.closest("[data-action]");if(!n)return;const s=n.dataset.action;s==="switch-plan"?Yn(n.dataset.plan):s==="refill"&&Vn(parseInt(n.dataset.amount,10))}),a.bus.subscribe("user:settingsUpdated",()=>{E&&E.style.display==="flex"&&Te()})}const $=new marked.Renderer,es=$.link;$.link=(e,t,n)=>es.call($,e,t,n).replace(/^<a /,'<a target="_blank" rel="noopener noreferrer" ');marked.setOptions({renderer:$,gfm:!0,breaks:!1});function ts(){window.addEventListener("storage",e=>{e.key==="promptPrimUserDatabase_v1"&&ot()})}function ns(){const e=a.bus;e.subscribe("project:new",J),e.subscribe("project:open",Yt),e.subscribe("project:fileSelectedForOpen",Vt),e.subscribe("project:save",t=>Ae(t)),e.subscribe("project:saveConfirm",({projectName:t})=>Le(t)),e.subscribe("project:unsavedChangesChoice",Qt),e.subscribe("session:new",Pe),e.subscribe("session:loaded",({session:t})=>{at(t.name),rt(),G(),j(),a.bus.publish("entity:selected",t.linkedEntity)}),e.subscribe("session:cleared",()=>{it(),Ut(),j()}),e.subscribe("session:autoRename",Jt),e.subscribe("session:rename",t=>qt(t)),e.subscribe("session:clone",({sessionId:t,event:n})=>Ft(t,n)),e.subscribe("session:archive",({sessionId:t,event:n})=>Rt(t,n)),e.subscribe("session:pin",({sessionId:t,event:n})=>Ht(t,n)),e.subscribe("session:delete",t=>Ot(t)),e.subscribe("session:download",({sessionId:t})=>zt({sessionId:t})),e.subscribe("agent:create",()=>re(!1)),e.subscribe("agent:save",Ln),e.subscribe("agent:edit",({agentName:t})=>re(!0,t)),e.subscribe("agent:delete",({agentName:t})=>In(t)),e.subscribe("agent:generateProfile",An),e.subscribe("group:create",()=>ie(!1)),e.subscribe("group:save",jn),e.subscribe("group:edit",({groupName:t})=>ie(!0,t)),e.subscribe("group:delete",({groupName:t})=>Cn({groupName:t})),e.subscribe("memory:create",()=>de(null)),e.subscribe("memory:save",Mn),e.subscribe("memory:edit",({index:t})=>de(t)),e.subscribe("memory:delete",({index:t})=>kn({index:t})),e.subscribe("memory:toggle",t=>{Bn(t)}),e.subscribe("memory:exportPackage",xn),e.subscribe("memory:importPackage",()=>{document.getElementById("load-memory-package-input").click()}),e.subscribe("studio:itemClicked",ln),e.subscribe("summary:view",({logId:t})=>(void 0)(t)),e.subscribe("summary:load",({logId:t})=>ct(t)),e.subscribe("summary:delete",({logId:t})=>lt(t)),e.subscribe("summary:editFromChat",({logId:t})=>{W(),setTimeout(()=>C(t),50)}),e.subscribe("summary:deleteFromChat",Rn),e.subscribe("chat:clearSummaryContext",dt),e.subscribe("entity:select",({type:t,name:n})=>cn(t,n)),e.subscribe("open-composer",()=>{a.bus.publish("ui:toggleComposer")}),e.subscribe("composer:heightChanged",Gt),e.subscribe("chat:deleteMessage",t=>ut(t)),e.subscribe("chat:sendMessage",mt),e.subscribe("chat:stopGeneration",pt),e.subscribe("chat:editMessage",({index:t})=>gt({index:t})),e.subscribe("chat:copyMessage",({index:t,event:n})=>yt({index:t,event:n})),e.subscribe("chat:regenerateMessage",({index:t})=>ft({index:t})),e.subscribe("chat:fileUpload",t=>ne(t)),e.subscribe("chat:filesSelected",t=>ne(t)),e.subscribe("chat:removeFile",({index:t})=>bt({index:t})),e.subscribe("chat:summarize",W),e.subscribe("chat:clearSummary",ht),e.subscribe("upload-file",()=>{document.getElementById("file-input")?.click()}),e.subscribe("api:loadModels",M),e.subscribe("api:loadUserModels",({apiKey:t,ollamaBaseUrl:n,isUserKey:s})=>{M({apiKey:t,ollamaBaseUrl:n,isUserKey:s})}),e.subscribe("settings:apiKeyChanged",_n),e.subscribe("settings:ollamaUrlChanged",Jn),e.subscribe("settings:fontChanged",an),e.subscribe("settings:systemAgentChanged",rn),console.log("✅ Central Event Bus ready.")}function ss(){Xe(),Lt(),Pt(),Qe(),Ze(),Bt(),Mt(),et(),tt(),Nt(),wn(),gn(),bn(),Sn(),nt(),Gn(),st(),Wn(),Zn(),document.getElementById("import-settings-input")?.addEventListener("change",Kn),console.log("✅ All UI modules initialized.")}document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("loading-overlay");try{await We();const t=P(),n=Ye();await M({apiKey:n.openrouterKey,ollamaBaseUrl:n.ollamaBaseUrl,isUserKey:!1}),t&&t.plan==="master"&&await M({apiKey:t.apiSettings?.openrouterKey,ollamaBaseUrl:t.apiSettings?.ollamaBaseUrl,isUserKey:!0}),console.log("🚀 Application starting..."),ss(),ts(),ns(),Wt(),document.getElementById("load-memory-package-input").addEventListener("change",Tn);const s=localStorage.getItem("lastActiveProjectId");if(s){console.log(`Attempting to load last project with ID: ${s}`);try{await tn(s)}catch(o){console.error(`[RECOVERY] Failed to load last project (ID: ${s}). This is likely due to corrupted data.`,o),alert("Could not load your last project due to an error. A new project will be created."),localStorage.removeItem("lastActiveProjectId"),console.log("[RECOVERY] Creating a new project as a fallback."),await J()}}else await J();e?.classList.remove("active"),console.log("🎉 Application initialized successfully.")}catch(t){console.error("[FATAL STARTUP ERROR]",t),e.querySelector("p").textContent=`A critical error occurred: ${t.message}`}});window.UserService=Ve;
