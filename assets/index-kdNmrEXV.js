(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const ce="AIChatbotDB_Project_",A="chatSessions",R="projectMetadata",He="projectInfo",J={"agent-name-input":"name","agent-icon-input":"icon","agent-model-select":"model","agent-system-prompt":"systemPrompt","agent-use-markdown":"useMarkdown","agent-temperature":"temperature","agent-topP":"topP","agent-topK":"topK","agent-presence-penalty":"presence_penalty","agent-frequency-penalty":"frequency_penalty","agent-max-tokens":"max_tokens","agent-seed":"seed","agent-stop-sequences":"stop_sequences"},M={Standard:`You are a professional summarizer. Your task is to create a dense, context-rich summary of a conversation. Include all key entities, character names, locations, critical events, and important emotional states. The summary should be detailed enough for another AI to pick up the conversation and understand all necessary context.

Here is the summary of the conversation so far:
--- PREVIOUS SUMMARY ---
\${previousSummary}
--- END PREVIOUS SUMMARY ---

Now, here are the new messages that have occurred since that summary:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide a new, single, cohesive summary that integrates the key points from the new messages into the previous one. Respond with ONLY the new, complete summary text.`,"Literary Analyst":`You are a meticulous literary analyst tasked with creating a detailed narrative digest. Your primary goal is to preserve the story's integrity, character development, and emotional nuances. Do NOT sacrifice important details for the sake of brevity.

Your digest must include:
- Plot Progression: Every significant event and the causal links between them.
- Character Arcs: Any changes in a character's state of mind, motivation, decisions, or relationships.
- Key Dialogue: Capture the essence and subtext of crucial conversations.
- Atmosphere & Setting: Mention key descriptions of the environment if they contribute to the mood or plot.
- New Elements: Note the introduction of any new characters, significant objects, or unresolved questions (foreshadowing).

Here is the narrative digest so far:
--- PREVIOUS DIGEST ---
\${previousSummary}
--- END PREVIOUS DIGEST ---

Now, here are the new scenes and dialogues that have occurred:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide a new, single, cohesive narrative digest that seamlessly integrates the key points from the new messages into the previous one. Write in a third-person, past-tense narrative style. Respond with ONLY the new, complete digest text.`,"Continuity Editor":`You are a continuity editor for a novel series. Your job is to create a 'Previously On...' document that ensures no plot points are ever lost. The output must be extremely detailed, acting as a perfect memory for another AI to continue the story without missing a single beat.

The document must retain:
- All character actions and their immediate consequences.
- The full names of any character or location mentioned.
- The specifics of any plans made or secrets revealed.
- Emotional state of each character at the end of the scene.
- Any objects that were acquired, lost, or noted as important.

The goal is maximum information retention, not summarization. Think of this as expanding upon the previous summary with new, detailed information.

Here is the continuity document so far:
--- PREVIOUS SUMMARY ---
\${previousSummary}
--- END PREVIOUS SUMMARY ---

Now, here are the new events to be added:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide the updated, complete continuity document, integrating the new events chronologically. Your response should be a single block of text containing only the updated document.`},Ct={icon:"ðŸ¤–",model:"",systemPrompt:"You are a helpful assistant.",useMarkdown:!0,temperature:1,topP:1,topK:0,presence_penalty:0,frequency_penalty:0,max_tokens:4096,seed:-1,stop_sequences:""},S={currentProject:{},allProviderModels:[],isLoading:!1,isDirtyForAutoSave:!1,abortController:null,editingAgentName:null,editingGroupName:null,stagedEntity:null,pendingFileToOpen:null,pendingActionAfterSave:null},$={events:{},subscribe(e,t){return typeof t!="function"?(console.warn(`Attempted to subscribe to "${e}" with a non-function.`,t),()=>{}):(this.events[e]=this.events[e]||[],this.events[e].push(t),()=>{this.events[e]=this.events[e].filter(n=>t!==n)})},publish(e,t){this.events[e]&&this.events[e].slice().forEach(n=>{if(typeof n=="function")try{n(t)}catch(s){console.error(`Error in subscriber for event "${e}":`,s)}})}},r={getState:()=>S,getProject:()=>S.currentProject,isLoading:()=>S.isLoading,getStagedEntity:()=>S.stagedEntity,setStagedEntity:(e,t=!0)=>{JSON.stringify(S.stagedEntity)!==JSON.stringify(e)&&(console.log("ðŸŸ  [STATE] Staged entity changing to:",e),S.stagedEntity=e,t&&r.bus.publish("entity:staged",e))},isUserDirty:()=>S.currentProject?.isDirtyForUser||!1,isAutoSaveDirty:()=>S.isDirtyForAutoSave,setState:(e,t)=>{S[e]=t},setProject:e=>{S.currentProject=e,$.publish("project:stateChanged",S.currentProject)},setLoading:e=>{S.isLoading!==e&&(S.isLoading=e,$.publish("loading:changed",e))},setUserDirty:e=>{S.currentProject&&S.currentProject.isDirtyForUser!==e&&(S.currentProject.isDirtyForUser=e,$.publish("userDirty:changed",e))},setAutoSaveDirty:e=>{S.isDirtyForAutoSave!==e&&(S.isDirtyForAutoSave=e,e&&$.publish("autosave:required"))},updateAndPersistState:()=>{r.setUserDirty(!0),r.setAutoSaveDirty(!0)},setAllModels:e=>{S.allProviderModels=e.sort((t,n)=>t.name.localeCompare(n.name)),S.currentProject&&S.currentProject.globalSettings&&(S.currentProject.globalSettings.allModels=S.allProviderModels),$.publish("models:loaded",S.allProviderModels)},newAbortController:()=>(S.abortController=new AbortController,S.abortController),abort:()=>{S.abortController&&(S.abortController.abort(),S.abortController=null)},bus:$},E={};function Lt(){E.appWrapper=document.querySelector(".app-wrapper"),E.toggleRightSidebarBtn=document.getElementById("toggle-right-sidebar-btn"),E.sessionsPanel=document.querySelector(".sessions-panel"),E.hamburgerBtn=document.getElementById("hamburger-btn"),E.closeSidebarBtn=document.querySelector('.sessions-panel .mobile-only[title="Close Sidebar"]'),E.mobileOverlay=document.getElementById("mobile-overlay"),E.composerPanel=document.querySelector(".composer-panel"),E.resizerRow=document.getElementById("resizer-row")}function It(e,t){if(!e||!t)return;let n=0,s=0,o=0,a=!1;const i=d=>{d.preventDefault(),e.classList.add("active"),document.body.style.cursor="row-resize",t.classList.contains("collapsed")&&(t.classList.remove("collapsed"),e.classList.remove("collapsed"),r.bus.publish("composer:visibilityChanged")),n=d.clientY,s=t.getBoundingClientRect().height,document.addEventListener("mousemove",c),document.addEventListener("mouseup",l)},c=d=>{o=d.clientY,a||(window.requestAnimationFrame(()=>{const u=o-n;let m=s-u;const p=parseInt(getComputedStyle(t).minHeight,10)||50;m<p&&(m=p),t.style.flexBasis=`${m}px`,a=!1}),a=!0)},l=()=>{e.classList.remove("active"),document.body.style.cursor="",document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",l)};e.addEventListener("mousedown",i)}function At(){if(!E.sessionsPanel)return;const e=t=>{t.stopPropagation(),t.preventDefault(),E.sessionsPanel.classList.remove("is-open"),E.mobileOverlay?.classList.remove("active")};E.hamburgerBtn?.addEventListener("click",t=>{window.innerWidth<=1024?(E.sessionsPanel.classList.add("is-open"),E.mobileOverlay?.classList.add("active")):E.appWrapper?.classList.toggle("sidebar-collapsed")}),E.mobileOverlay?.addEventListener("click",e,!0),E.closeSidebarBtn?.addEventListener("click",e,!0)}function kt(){Lt(),E.resizerRow&&E.composerPanel&&It(E.resizerRow,E.composerPanel),At(),jt(),console.log("Core layout manager initialized.")}function jt(){!E.toggleRightSidebarBtn||!E.appWrapper||E.toggleRightSidebarBtn.addEventListener("click",()=>{E.appWrapper.classList.toggle("right-sidebar-collapsed"),E.appWrapper.classList.contains("right-sidebar-collapsed")||r.bus.publish("studio:rendered")})}const Re="promptPrimUserSettings_v1";let w=null;const q={userProfile:{userId:`user_${Date.now()}`,userName:"New User",plan:"free",userCredits:1e6},appSettings:{activeModelPreset:"top_models",apiKeys:{openrouter:"",ollamaBaseUrl:"http://localhost:11434"},preferences:{font:"'Sarabun', sans-serif",theme:"system",language:"en"}},modelPresets:{free_tier:{name:"Free Tier",modelIds:["mistralai/mistral-7b-instruct:free","google/gemma-2-9b-it:free"]},top_models:{name:"Top Models",modelIds:["openai/gpt-4o","anthropic/claude-4-sonnet","google/gemma-3-27b-it"]}},systemAgentDefaults:{utilityAgent:{model:"google/gemma-3-27b-it",systemPrompt:"You are a highly efficient assistant..."},summarizationPresets:{Standard:"You are a professional summarizer..."}}};function Mt(){return new Promise(e=>{const t=localStorage.getItem(Re);if(t){w=JSON.parse(t);let n=!1;for(const o in q)w[o]||(w[o]=q[o],n=!0);const s=w.userProfile;s&&s.credits!==void 0&&(console.log("Migrating 'credits' to 'userCredits'."),s.userCredits=s.credits,delete s.credits,n=!0),(!s||typeof s.userCredits!="number"||s.userCredits<=0||s.userCredits===5e4)&&(console.warn("User profile or credits are invalid/stale. Resetting to new default for testing."),w.userProfile={...q.userProfile,...s||{},userCredits:q.userProfile.userCredits},n=!0),n&&D()}else w=q,D();console.log("ðŸ‘¤ User Settings Initialized:",w),r.bus.publish("user:settingsLoaded",w),e(w)})}function _(){return w}function _e(){return w?.userProfile||{}}function D(){w&&(localStorage.setItem(Re,JSON.stringify(w)),r.bus.publish("user:settingsUpdated",w))}const je={"openai/gpt-4o-mini":{prompt:.15,completion:.6},"google/gemma-3-27b-it":{prompt:.2,completion:.2},"anthropic/claude-3.5-sonnet":{prompt:3,completion:15},"meta-llama/llama-3.1-8b-instruct":{prompt:.2,completion:.2},default:{prompt:.5,completion:1.5}};function ze(e,t){if(!w||!e||!t)return;const n=w.userProfile;if(n.plan==="free"&&n.userCredits<=0)return;const s=je[t]||je.default,o=e.prompt_tokens/1e6*s.prompt,a=e.completion_tokens/1e6*s.completion,i=(o+a)*2.5,c=Math.ceil(i*1e6);console.log(`ðŸ”¥ Burning ${c.toLocaleString()} credits for model ${t}.`),n.userCredits-=c,D()}function Ge(){return w?.appSettings?.apiKeys?.openrouter||""}function We(){return w?.appSettings?.apiKeys?.ollamaBaseUrl||""}function Ye({openrouterKey:e,ollamaBaseUrl:t}){w&&(e!==void 0&&(w.appSettings.apiKeys.openrouter=e),t!==void 0&&(w.appSettings.apiKeys.ollamaBaseUrl=t),D())}function X(){return w?.modelPresets||{}}function Ke(e){w&&(w.modelPresets=e,D())}function xt(e){w&&(w.appSettings.activeModelPreset=e,D())}let L;function Je(){return L}async function Se(e){return L&&L.name===`${ce}${e}`?Promise.resolve(L):(L&&(L.close(),L=null),new Promise((t,n)=>{const s=indexedDB.open(`${ce}${e}`,5);s.onupgradeneeded=o=>{const a=o.target.result;a.objectStoreNames.contains(A)||a.createObjectStore(A,{keyPath:"id"}),a.objectStoreNames.contains(R)||a.createObjectStore(R,{keyPath:"id"})},s.onsuccess=o=>{L=o.target.result,console.log(`IndexedDB '${L.name}' opened successfully.`),t(L)},s.onerror=o=>{console.error("IndexedDB error:",o.target.error),n(o.target.error)}}))}async function x(e,t,n,s){return new Promise((o,a)=>{if(!L)return console.error("dbRequest called before DB was opened."),a("Database is not open.");try{const l=L.transaction(e,t).objectStore(e)[n](s);l.onsuccess=d=>o(d.target.result||(n==="getAll"?[]:null)),l.onerror=d=>a(d.target.error)}catch(i){console.error(`Error performing dbRequest (${n} on ${e}):`,i),a(i)}})}async function Bt(e){return new Promise((t,n)=>{if(!L)return n("Database is not open.");try{const s=L.transaction(e,"readwrite");s.oncomplete=()=>{console.log(`Stores cleared: ${e.join(", ")}`),t()},s.onerror=o=>n(s.error),e.forEach(o=>{L.objectStoreNames.contains(o)&&s.objectStore(o).clear()})}catch(s){n(s)}})}async function Tt(e){const t=`${ce}${e}`,n=Je();return n&&n.name===t&&n.close(),new Promise((s,o)=>{console.log(`[DB] Attempting to delete database: ${t}`);const a=indexedDB.deleteDatabase(t);a.onsuccess=()=>{console.log("[DB] Successfully deleted database."),s()},a.onerror=i=>{console.error("[DB] Error deleting database:",i.target.error),o(i.target.error)},a.onblocked=()=>{console.warn("[DB] Database delete was blocked. Please reload the application."),showCustomAlert("Could not clear old project data because a connection is still open. Please reload the page and try again.","Error"),o("Database blocked")}})}function V(e,t){let n;return function(...o){const a=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(a,t)}}function $t(e){if(!e)return"N/A";const t=new Date(e),n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),c=String(t.getSeconds()).padStart(2,"0");return`${n}-${s}-${o} ${a}:${i}:${c}`}class Ve{constructor(t){if(this.contentDiv=t.querySelector(".message-content .streaming-content"),this.accumulatedMarkdown="",this.isInsideCodeBlock=!1,this.renderTimeout=null,this.debounceDelay=40,!this.contentDiv)throw new Error("Target content element for rendering not found.")}streamChunk=t=>{this.accumulatedMarkdown+=t,clearTimeout(this.renderTimeout),this.renderTimeout=setTimeout(this.render,this.debounceDelay)};render=()=>{try{const t=(this.accumulatedMarkdown.match(/```/g)||[]).length%2===1;if(t||this.isInsideCodeBlock){const n=this.accumulatedMarkdown.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.contentDiv.innerHTML=`<pre class="streaming-code-preview">${n}</pre>`}else this.contentDiv.innerHTML=marked.parse(this.accumulatedMarkdown,{gfm:!0,breaks:!1});this.isInsideCodeBlock=t}catch{this.contentDiv.textContent=this.accumulatedMarkdown}};getFinalContent(){return clearTimeout(this.renderTimeout),this.accumulatedMarkdown}}function Nt(e){const t=document.getElementById("preset-selector"),n=document.getElementById("preset-name-input"),s=t.value,o=n.value.trim();if(!o){g("Preset name cannot be empty.","Error");return}if(e.size===0){g("Please select at least one model for the preset.","Error");return}const a=o.toLowerCase().replace(/\s+/g,"_"),i=X();s!=="--new--"&&s!==a&&delete i[s],i[a]={name:o,modelIds:Array.from(e)},Ke(i),g(`Preset "${o}" saved successfully!`,"Success"),F()}function Dt(){const e=document.getElementById("preset-selector"),t=e.value;if(t==="--new--"){g("No preset selected to delete.","Info");return}if(confirm(`Are you sure you want to delete the "${e.options[e.selectedIndex].text}" preset?`)){const n=X();delete n[t],Ke(n),g("Preset deleted.","Success"),F()}}let k=new Set,Me=-1;function le(e=null){const t=document.getElementById("model-info-bar");if(t){if(!e){t.classList.add("hidden");return}document.getElementById("info-bar-name").textContent=e.name,document.getElementById("info-bar-description").textContent=e.description||"No description available.",document.getElementById("info-bar-context").textContent=`${(e.context_length||0).toLocaleString()} tokens`,document.getElementById("info-bar-prompt-price").textContent=`$${e.pricing?.prompt||"N/A"} / 1M`,document.getElementById("info-bar-completion-price").textContent=`$${e.pricing?.completion||"N/A"} / 1M`,t.classList.remove("hidden")}}function Xe(){const e=document.getElementById("preset-included-list");if(!e)return;const t=r.getState().allProviderModels||[];if(e.innerHTML="",k.size===0){e.innerHTML='<p class="no-items-message">Select models from the list on the left.</p>';return}const n=document.createElement("div");n.className="included-models-count",n.textContent=`Included: ${k.size} models`,e.appendChild(n),t.forEach(s=>{if(k.has(s.id)){const o=document.createElement("div");o.className="model-manager-item",o.innerHTML=`<label>${s.name}<small>${s.id}</small></label>`,e.appendChild(o)}})}function de(){const e=document.getElementById("model-master-list"),t=document.getElementById("model-search-input"),n=document.getElementById("filter-selected-toggle");if(!e||!t||!n)return;const s=r.getState().allProviderModels||[],o=t.value.toLowerCase(),a=n.checked;e.innerHTML="";let i=s;a&&(i=s.filter(l=>k.has(l.id))),i.filter(l=>l.name.toLowerCase().includes(o)||l.id.toLowerCase().includes(o)).forEach(l=>{const d=k.has(l.id),u=document.createElement("div");u.className="model-manager-item",u.innerHTML=`
            <input type="checkbox" id="model-cb-${l.id}" data-model-id="${l.id}" ${d?"checked":""}>
            <label for="model-cb-${l.id}">
                ${l.name}
                <small>${l.id}</small>
            </label>
            <button type="button" class="btn-icon model-info-btn" data-model-id="${l.id}" title="View model details">
                <span class="material-symbols-outlined">info</span>
            </button>
        `,e.appendChild(u)}),Xe()}function F(){const e=document.getElementById("preset-selector"),t=document.getElementById("preset-name-input"),n=document.getElementById("delete-preset-btn"),s=document.getElementById("filter-selected-toggle");if(!e||!t||!n||!s)return;const o=e.value,a=X();e.innerHTML='<option value="--new--">-- Create New Preset --</option>';for(const c in a)e.add(new Option(a[c].name,c));e.querySelector(`option[value="${o}"]`)&&(e.value=o);const i=e.value;s.checked=!1,i==="--new--"?(t.value="",n.style.display="none",k.clear()):a[i]&&(t.value=a[i].name,n.style.display="block",k=new Set(a[i].modelIds)),de(),le(null)}function Ut(){const e=document.getElementById("model-search-input"),t=document.getElementById("model-master-list"),n=document.getElementById("preset-selector"),s=document.getElementById("save-preset-btn"),o=document.getElementById("delete-preset-btn"),a=document.getElementById("select-all-btn"),i=document.getElementById("deselect-all-btn"),c=document.getElementById("filter-selected-toggle"),l=document.getElementById("info-bar-close-btn");document.getElementById("apply-preset-btn")?.addEventListener("click",()=>{const m=n.value;if(!m||m==="--new--"){g("Please select a preset to apply.","Info");return}xt(m),g(`Preset "${n.options[n.selectedIndex].text}" is now active!`,"Success"),r.bus.publish("app:settingsChanged")}),t?.addEventListener("click",m=>{const p=m.target.closest(".model-info-btn"),y=m.target.closest('input[type="checkbox"]');if(p){m.stopPropagation();const h=p.dataset.modelId,f=r.getState().allProviderModels.find(v=>v.id===h);le(f);return}if(y){const f=Array.from(t.querySelectorAll('input[type="checkbox"]')).indexOf(y);m.shiftKey&&Me>-1,Me=f}}),t?.addEventListener("change",m=>{if(m.target.type==="checkbox"){const p=m.target.dataset.modelId;m.target.checked?k.add(p):k.delete(p),Xe()}}),e?.addEventListener("input",de),c?.addEventListener("change",de),n?.addEventListener("change",F),s?.addEventListener("click",()=>Nt(k)),o?.addEventListener("click",Dt),l?.addEventListener("click",()=>le(null)),a?.addEventListener("click",()=>{}),i?.addEventListener("click",()=>{}),document.querySelector('.tab-btn[data-tab="models"]')?.addEventListener("click",F),r.bus.subscribe("modelPresets:changed",F)}function Ee(e){if(!e)return[];const t=r.getState().allProviderModels||[],s=X()[e]?.modelIds||[],o=new Set(s);return t.filter(a=>o.has(a.id))}function Ot(){const e=document.getElementById("settings-modal");if(!e)return;const t=e.querySelector(".tab-buttons"),n=e.querySelectorAll(".tab-content");t&&t.addEventListener("click",s=>{if(s.target.matches(".tab-btn")){const o=s.target.dataset.tab;t&&n&&(t.querySelectorAll(".tab-btn").forEach(a=>a.classList.remove("active")),s.target.classList.add("active"),n.forEach(a=>{a.classList.toggle("active",a.dataset.tabContent===o)}))}})}function ue(){const e=_(),t=r.getProject();if(!t||!e)return;const n=e.systemAgentDefaults?.utilityAgent||{},s=t.globalSettings?.systemUtilityAgent||n;document.getElementById("apiKey").value=e.appSettings.apiKeys.openrouter||"",document.getElementById("ollamaBaseUrl").value=e.appSettings.apiKeys.ollamaBaseUrl||"",document.getElementById("system-utility-prompt").value=s.systemPrompt||"",document.getElementById("system-utility-temperature").value=s.temperature??1,document.getElementById("system-utility-topP").value=s.topP??1;const o=e.appSettings.activeModelPreset||"top_models",a=Ee(o);we("settings-system-model-wrapper",s.model,a)}function Qe(){ue(),Ft()}function qt(){Ot();const e=r.bus;document.getElementById("apiKey")?.addEventListener("input",V(n=>e.publish("settings:apiKeyChanged",n.target.value),500)),document.getElementById("ollamaBaseUrl")?.addEventListener("input",V(n=>e.publish("settings:ollamaUrlChanged",n.target.value),500)),document.getElementById("load-models-btn")?.addEventListener("click",()=>e.publish("api:loadModels")),["system-utility-prompt","system-utility-temperature","system-utility-topP"].forEach(n=>{document.getElementById(n)?.addEventListener("change",()=>e.publish("settings:systemAgentChanged"))}),document.querySelector("#settings-panel .modal-close-btn")?.addEventListener("click",Ht),r.bus.subscribe("models:loaded",()=>{const n=document.getElementById("settings-modal");n&&n.style.display==="flex"&&ue()}),r.bus.subscribe("app:settingsChanged",()=>{const n=document.getElementById("settings-modal");n&&n.style.display==="flex"&&ue()}),console.log("âœ… Settings UI Initialized.")}function Ze(e){const t=document.createElement("div");t.className="dropdown align-right";const n=document.createElement("button");n.className="btn-icon",n.innerHTML="&#8942;",n.title="More options",n.dataset.action="toggle-menu";const s=document.createElement("div");return s.className="dropdown-content",e.forEach(o=>{const a=document.createElement("a");a.href="#",a.textContent=o.label,o.isDestructive&&a.classList.add("is-destructive"),a.dataset.action=o.action,o.data&&(a.dataset.data=JSON.stringify(o.data)),s.appendChild(a)}),t.append(n,s),t}function Ft(){const e=document.getElementById("settings-modal");e&&(e.style.display="flex")}function Ht(){const e=document.getElementById("settings-modal");e&&(e.style.display="none")}function et(){document.getElementById("unsaved-changes-modal").style.display="flex"}function Rt(){document.getElementById("unsaved-changes-modal").style.display="none"}function g(e,t="Notification"){document.getElementById("alert-modal-title").textContent=t,document.getElementById("alert-modal-message").textContent=e,document.getElementById("alert-modal").style.display="flex"}function _t(){document.getElementById("alert-modal").style.display="none"}function zt(){document.querySelector(".sidebar").classList.toggle("open"),document.getElementById("mobile-overlay").classList.toggle("active")}function z(e){e.stopPropagation();const t=e.target.closest(".dropdown");if(!t)return;const n=t.querySelector(".dropdown-content"),s=t.classList.contains("open");if(document.querySelectorAll(".dropdown.open").forEach(o=>{o!==t&&o.classList.remove("open")}),!s){n.style.visibility="hidden",n.style.display="block";const o=n.offsetHeight;n.style.visibility="",n.style.display="";const a=e.target.closest("button").getBoundingClientRect();window.innerHeight-a.bottom<o&&a.top>o?n.classList.add("opens-up"):n.classList.remove("opens-up")}t.classList.toggle("open")}function Gt(){document.addEventListener("click",e=>{const t=document.querySelector(".dropdown.open");t&&!t.contains(e.target)&&t.classList.remove("open");const n=document.querySelector(".searchable-select-wrapper .searchable-select-options:not(.hidden)");if(n){const s=n.closest(".searchable-select-wrapper");s&&!s.contains(e.target)&&n.classList.add("hidden")}})}function Wt(){const e=r.getProject();e?.globalSettings?.fontFamilySelect&&document.documentElement.style.setProperty("--main-font-family",e.globalSettings.fontFamilySelect)}function Yt({message:e,state:t}){const n=document.getElementById("statusText"),s=document.getElementById("statusDot");!n||!s||(n.textContent=e||"Ready",s.className="status-dot",t==="connected"?s.classList.add("connected"):t==="error"?s.classList.add("error"):t==="loading"&&s.classList.add("warning"))}function Kt(){const e=document.getElementById("app-version");e&&(e.textContent="0.0.1alpha"),r.bus.subscribe("ui:applyFontSettings",Wt),r.bus.subscribe("status:update",Yt),document.querySelector("#settings-btn").addEventListener("click",Qe);const t=document.getElementById("mobile-overlay");t&&t.addEventListener("click",zt);const n=document.querySelector("#alert-modal .btn");n&&n.addEventListener("click",_t);const s=document.getElementById("unsaved-changes-modal");if(s){const o=s.querySelector(".btn:not(.btn-secondary):not(.btn-danger)");o&&o.addEventListener("click",()=>r.bus.publish("project:unsavedChangesChoice","save"));const a=s.querySelector(".btn-danger");a&&a.addEventListener("click",()=>r.bus.publish("project:unsavedChangesChoice","discard"));const i=s.querySelector(".btn-secondary");i&&i.addEventListener("click",()=>r.bus.publish("project:unsavedChangesChoice","cancel"))}console.log("Core UI Initialized and Listeners Attached.")}function Jt(e,t){const n=document.querySelector(".context-menu");n&&n.remove(),t.preventDefault(),t.stopPropagation();const s=document.createElement("div");s.className="context-menu";const o=document.createElement("ul");e.forEach(h=>{const f=document.createElement("li");f.textContent=h.label,h.isDestructive&&f.classList.add("destructive"),f.addEventListener("click",v=>{v.stopPropagation(),h.action()}),o.appendChild(f)}),s.appendChild(o),document.body.appendChild(s);const{clientX:a,clientY:i}=t.touches?t.touches[0]:t,c=s.offsetWidth,l=s.offsetHeight,d=window.innerWidth,u=window.innerHeight;let m=i,p=a;a+c>d&&(p=d-c-10),i+l>u&&(m=u-l-10),s.style.top=`${m}px`,s.style.left=`${p}px`,requestAnimationFrame(()=>{s.style.opacity="1",s.style.transform="scale(1)"});const y=()=>{s.remove(),document.removeEventListener("click",y,!0)};setTimeout(()=>{document.addEventListener("click",y,!0)},0)}function we(e,t,n){const s=document.getElementById(e);if(!s)return;const o=n!==void 0?n:r.getState().allProviderModels||[],a=s.querySelector('input[type="text"]'),i=s.querySelector('input[type="hidden"]'),c=s.querySelector(".searchable-select-options");if(!a||!i||!c)return;const l=u=>{if(c.innerHTML="",u.length===0){c.innerHTML='<div class="searchable-option-item">No models found for this preset.</div>';return}u.forEach(m=>{const p=document.createElement("div");p.className="searchable-option-item",p.dataset.value=m.id,p.innerHTML=`${m.name} <small>${m.id}</small>`,p.addEventListener("click",()=>{a.value=m.name,i.value=m.id,c.classList.add("hidden"),i.dispatchEvent(new Event("change",{bubbles:!0}))}),c.appendChild(p)})};a.addEventListener("input",()=>{const u=a.value.toLowerCase(),m=o.filter(p=>p.name.toLowerCase().includes(u)||p.id.toLowerCase().includes(u));l(m)}),a.addEventListener("focus",()=>{l(o),c.classList.remove("hidden")});const d=o.find(u=>u.id===t);d?(a.value=d.name,i.value=d.id):(a.value="",i.value=""),s.dataset.initialized||(s.dataset.initialized="true")}function Vt(e){e.querySelectorAll("pre > code").forEach(t=>{if(t.dataset.highlighted==="yes")return;const n=t.parentNode;if(n.parentNode.classList.contains("code-block-wrapper"))return;if(n.parentNode.tagName==="P"){const a=n.parentNode;a.parentNode.insertBefore(n,a),a.textContent.trim()||a.remove()}const s=document.createElement("div");s.className="code-block-wrapper",n.parentNode.insertBefore(s,n),s.appendChild(n);const o=document.createElement("button");o.className="copy-code-btn",o.textContent="Copy",s.appendChild(o),o.addEventListener("click",()=>{navigator.clipboard.writeText(t.textContent).then(()=>{o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy"},2e3)})}),window.hljs&&Array.from(t.classList).some(i=>i.startsWith("language-")&&i!=="language-undefined")&&hljs.highlightElement(t)})}function Xt(e,t){const n=e.split(/\n{2,}/);let s=0;t.innerHTML="";function o(){if(s>=n.length){tt(t),me();return}const a=document.createElement("div");a.innerHTML=marked.parse(n[s]||"",{gfm:!0,breaks:!1}),t.appendChild(a),s++,requestAnimationFrame(()=>{me(),o()})}o()}function xe(e){if(!e)return"";const t=new Date,n=new Date(e),s=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1);return n>=s?n.toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit",hour12:!1}):n>=o?"Yesterday":n.toLocaleDateString("th-TH",{day:"2-digit",month:"2-digit",year:"numeric"})}function tt(e){e.querySelectorAll("pre").forEach(n=>{if(n.querySelector(".code-block-copy-btn"))return;n.style.position="relative";const s=document.createElement("button");s.className="code-block-copy-btn",s.textContent="Copy",s.addEventListener("click",o=>{o.stopPropagation();const a=n.querySelector("code"),i=a?a.innerText:n.innerText;navigator.clipboard.writeText(i).then(()=>{s.textContent="Copied!",setTimeout(()=>{s.textContent="Copy"},1500)})}),n.appendChild(s)})}function Qt(e,t,n){const{role:s,content:o,speaker:a,isLoading:i,isError:c,isSummary:l}=e,d=r.getProject(),u=2e3,m=document.createElement("div");m.className=`message-turn-wrapper ${s}-turn`,m.dataset.index=t;const p=document.createElement("div");if(p.className=`message ${s}`,c&&p.classList.add("error"),l&&p.classList.add("system-summary-message"),s==="assistant"&&a){const y=d.agentPresets?.[a],h=y?y.icon:"ðŸ¤–",f=document.createElement("div");f.className="speaker-label-wrapper";const v=document.createElement("span");if(v.className="speaker-label",v.innerHTML=`${h} ${a}`,e.timestamp){const b=document.createElement("span");b.className="message-timestamp",b.innerHTML=`&nbsp;â€¢ ${xe(e.timestamp)}`,v.appendChild(b)}f.appendChild(v),m.appendChild(f)}else if(s==="user"&&e.timestamp){const y=document.createElement("span");y.className="message-timestamp",y.textContent=xe(e.timestamp),m.appendChild(y)}if(e.isSummaryMarker||e.isSummary){p.classList.add("summary-marker");const y=document.createElement("span");y.textContent=e.content;const h=document.createElement("div");h.className="summary-marker-actions";const f=document.createElement("button");f.className="btn-icon small",f.title="Edit this Summary",f.innerHTML='<span class="material-symbols-outlined">edit_note</span>';const v=e.summaryLogId||n.summaryState?.activeSummaryId;v&&(f.onclick=()=>r.bus.publish("summary:editFromChat",{logId:v}));const b=document.createElement("button");b.className="btn-icon small danger",b.title="Remove Marker from Chat",b.innerHTML='<span class="material-symbols-outlined">delete</span>',b.onclick=()=>r.bus.publish("chat:clearSummaryContext",{index:t}),h.append(f,b),p.append(y,h)}else if(s==="system"){const y=document.createElement("div");y.className="message-content",y.textContent=e.content,p.appendChild(y);const h=document.createElement("div");h.className="message-actions";const f=document.createElement("button");f.innerHTML='<span class="material-symbols-outlined" style="font-size: 18px;">delete_forever</span>',f.title="Delete",f.onclick=v=>r.bus.publish("chat:deleteMessage",{index:t,event:v}),h.appendChild(f),p.appendChild(h)}else{const y=document.createElement("div");if(y.className="message-content",p.appendChild(y),i)y.innerHTML='<span class="streaming-content"><div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></span>';else{const h=document.createElement("span");h.className="streaming-content",y.appendChild(h);let f="",v=!1;if(s==="user"?(f=Array.isArray(o)?o.filter(b=>b.type==="text").map(b=>b.text).join(`
`):o||"",v=f.length>u):s==="assistant"&&(f=o||"",v=f.length>u),v)h.innerHTML='<div class="loading-text">Loading large message...</div>',setTimeout(()=>Xt(f,h),0);else try{if(s==="assistant")h.innerHTML=marked.parse(o||"",{gfm:!0,breaks:!1}),tt(h);else if(s==="user"){if(Array.isArray(o))o.forEach(b=>{if(b.type==="text"&&b.text){const C=document.createElement("p");C.textContent=b.text,h.appendChild(C)}else if(b.type==="image_url"&&b.url){const C=document.createElement("img");C.src=b.url,C.className="multimodal-image",h.appendChild(C)}});else if(typeof o=="string"){const b=document.createElement("p");b.textContent=o,h.appendChild(b)}}}catch(b){console.error("Content rendering failed:",b),h.textContent="Error displaying content"}}if(!i&&!c){const h=document.createElement("div");h.className="message-actions";const f='style="font-size: 18px;"',v=document.createElement("button");v.innerHTML=`<span class="material-symbols-outlined" ${f}>edit</span>`,v.title="Edit",v.onclick=P=>r.bus.publish("chat:editMessage",{index:t,event:P}),h.appendChild(v);const b=document.createElement("button");if(b.innerHTML=`<span class="material-symbols-outlined" ${f}>content_copy</span>`,b.title="Copy",b.onclick=P=>r.bus.publish("chat:copyMessage",{index:t,event:P}),h.appendChild(b),s==="assistant"){const P=document.createElement("button");P.innerHTML=`<span class="material-symbols-outlined" ${f}>refresh</span>`,P.title="Regenerate",P.onclick=B=>r.bus.publish("chat:regenerateMessage",{index:t,event:B}),h.appendChild(P)}const C=document.createElement("button");C.innerHTML=`<span class="material-symbols-outlined" ${f}>delete_forever</span>`,C.title="Delete",C.onclick=P=>r.bus.publish("chat:deleteMessage",{index:t,event:P}),h.appendChild(C),p.appendChild(h)}}return m.appendChild(p),m}function Zt(e,t){const{role:n,content:s,speaker:o,isLoading:a,isError:i}=e,c=r.getProject(),l=document.getElementById("chatMessages"),d=document.createElement("div");d.className=`message-turn-wrapper ${n}-turn`,d.dataset.index=t;const u=document.createElement("div");u.className=`message ${n}`,i&&u.classList.add("error");const m=document.createElement("div");if(m.className="message-content",n==="assistant"&&o){const y=c.agentPresets?.[o],h=y?y.icon:"ðŸ¤–",f=document.createElement("div");f.className="speaker-label-wrapper",f.innerHTML=`<span class="speaker-label">${h} ${o}</span>`,d.appendChild(f)}const p=document.createElement("span");if(p.className="streaming-content",a)p.innerHTML='<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';else{const h=(c.agentPresets?.[o]||{}).useMarkdown!==!1,f=typeof s=="string"?s:s?.find(v=>v.type==="text")?.text||"";p.innerHTML=h&&window.marked?marked.parse(f,{gfm:!0,breaks:!1}):`<p>${f}</p>`,Vt(p)}return m.appendChild(p),u.appendChild(m),d.appendChild(u),l.appendChild(d),l.scrollTop=l.scrollHeight,d}function Q(){const e=r.getProject(),t=e.chatSessions.find(s=>s.id===e.activeSessionId);if(!t){console.error("[UI] renderMessages: No active session found!");return}const n=document.getElementById("chatMessages");if(!n){console.error("[UI] renderMessages: Chat container not found!");return}n.innerHTML="",t.history&&t.history.length>0&&t.history.forEach((s,o)=>{const a=Qt(s,o,t);n.appendChild(a)}),me()}function me(){const e=document.getElementById("chatMessages");e&&(e.scrollTop=e.scrollHeight)}function en(){document.getElementById("chatMessages").innerHTML="",Pe("AI Assistant")}function Pe(e){document.getElementById("chat-title").textContent=e||"AI Assistant"}function tn(e){const t=document.getElementById("file-preview-container");t.classList.toggle("hidden",!e||e.length===0),t.innerHTML="",!(!e||e.length===0)&&e.forEach((n,s)=>{const o=document.createElement("div");o.className="file-preview-item";let a="";n.type.startsWith("image/")?a=`<img src="${n.data||""}" class="file-preview-thumbnail" alt="${n.name}">`:a='<div class="file-preview-thumbnail file-icon">ðŸ“„</div>',o.innerHTML=`${a}<span class="file-preview-name">${n.name}</span><button class="remove-file-btn" data-action="chat:removeFile" data-index="${s}">&times;</button>`,t.appendChild(o)})}function ne(){const{totalTokens:e,agent:t,agentNameForDisplay:n}=ot();document.getElementById("active-agent-status").textContent=`Active: ${t.icon||""} ${n}`,document.getElementById("token-count-status").textContent=`~${e.toLocaleString()} Tokens`}function nn(){const{finalSystemPrompt:e,totalTokens:t,agentNameForDisplay:n,model:s}=ot();document.getElementById("inspector-agent-name").textContent=n,document.getElementById("inspector-agent-model").textContent=s,document.getElementById("inspector-token-count").textContent=`~${t.toLocaleString()}`,document.getElementById("inspector-system-prompt").textContent=e||"(No system prompt or memories active)",document.getElementById("context-inspector-modal").style.display="flex"}function sn(){document.getElementById("context-inspector-modal").style.display="none"}function on(){const e=document.getElementById("chat-actions-container"),t=document.getElementById("chat-actions-btn"),n=document.getElementById("chat-actions-menu");!e||!t||!n||(t.addEventListener("click",s=>{s.stopPropagation(),n.innerHTML="",n.innerHTML=`
            <a href="#" data-action="open-composer"><span class="material-symbols-outlined">edit_square</span> Composer</a>
            <a href="#" data-action="chat:summarize"><span class="material-symbols-outlined">psychology</span> Summarize</a>
            <a href="#" data-action="upload-file"><span class="material-symbols-outlined">attach_file</span> Upload files</a>
        `;const o=r.getProject(),a=o.chatSessions.find(i=>i.id===o.activeSessionId);a&&a.summaryState?.activeSummaryId&&(n.innerHTML+=`
                <div class="dropdown-divider"></div>
                <a href="#" data-action="chat:clearSummary" class="is-destructive"><span class="material-symbols-outlined">layers_clear</span> Clear Summary Context</a>
            `),e.classList.toggle("open")}),n.addEventListener("click",s=>{const o=s.target.closest("[data-action]");if(o){switch(s.preventDefault(),o.dataset.action){case"open-composer":r.bus.publish("ui:toggleComposer");break;case"chat:summarize":r.bus.publish("chat:summarize");break;case"upload-file":document.getElementById("file-input")?.click();break;case"chat:clearSummary":r.bus.publish("chat:clearSummaryContext",{index:-1});break}e.classList.remove("open")}}),document.addEventListener("click",s=>{e.classList.contains("open")&&!e.contains(s.target)&&e.classList.remove("open")}))}function rn(){const e=document.getElementById("chatInput"),t=document.getElementById("file-input"),n=document.getElementById("file-preview-container");if(e){e.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),r.bus.publish("chat:sendMessage"))});const s=V(()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px",ne()},500);e.addEventListener("input",s)}document.getElementById("sendBtn")?.addEventListener("click",()=>r.bus.publish("chat:sendMessage")),document.getElementById("stopBtn")?.addEventListener("click",()=>r.bus.publish("chat:stopGeneration")),document.getElementById("context-inspector-trigger-btn")?.addEventListener("click",nn),document.querySelector("#context-inspector-modal .btn-secondary")?.addEventListener("click",sn),t&&t.addEventListener("change",s=>{r.bus.publish("chat:fileUpload",s)}),n&&n.addEventListener("click",s=>{if(s.target.matches(".remove-file-btn")){const o=parseInt(s.target.dataset.index,10);r.bus.publish("chat:removeFile",{index:o})}}),on(),r.bus.subscribe("session:loaded",()=>ne()),r.bus.subscribe("entity:selected",()=>ne()),r.bus.subscribe("ui:renderMessages",Q),r.bus.subscribe("ui:renderFilePreviews",({files:s})=>tn(s)),r.bus.subscribe("ui:updateChatTitle",({title:s})=>Pe(s)),r.bus.subscribe("ui:toggleLoading",({isLoading:s})=>{document.getElementById("sendBtn")?.classList.toggle("hidden",s),document.getElementById("stopBtn")?.classList.toggle("hidden",!s)}),console.log("âœ… Chat UI Initialized.")}function an(){const e=document.getElementById("toggle-right-sidebar-btn"),t=document.getElementById("studio-panel"),n=document.getElementById("right-sidebar-overlay"),s=document.querySelector(".app-wrapper");!e||!t||(e.addEventListener("click",()=>{window.innerWidth<=900?(t.classList.add("open"),n?.classList.add("active"),document.body.style.overflow="hidden"):(t.classList.toggle("collapsed"),s?.classList.toggle("with-right-collapsed",t.classList.contains("collapsed")))}),n?.addEventListener("click",()=>{t.classList.remove("open"),n.classList.remove("active"),document.body.style.overflow=""}),window.addEventListener("resize",()=>{window.innerWidth>900&&(t.classList.remove("open"),n?.classList.remove("active"),document.body.style.overflow="")}))}async function nt(e,t,n){r.bus.publish("ui:toggleLoading",{isLoading:!0});try{n.flowType==="round-robin"?await cn(e,t,n):n.flowType==="auto-moderator"&&await ln(e,t,n)}catch(s){s.name!=="AbortError"&&(console.error("Error during group chat turn:",s),g(`An error occurred in the group chat: ${s.message}`,"Error"))}finally{r.bus.publish("ui:toggleLoading",{isLoading:!1}),r.bus.publish("status:update",{message:"Ready",state:"connected"}),await x(A,"readwrite","put",t),r.bus.publish("context:requestData")}}async function cn(e,t,n){const s=n.maxTurns||1,o=(n.agents||[]).filter(a=>a!==n.moderatorAgent);if(o.length===0){g("Round Robin mode requires at least one member who is not the moderator.","Info");return}for(let a=0;a<s;a++){if(s>1){const i={role:"system",content:`--- Round ${a+1} of ${s} ---`};t.history.push(i),ChatUI.addMessageToUI(i,t.history.length-1)}for(const i of o){if(r.getState().abortController?.signal.aborted)return;await st(e,t,i)}}}async function ln(e,t,n){const s=n.maxTurns||1;for(let o=0;o<s;o++)if(!await dn(e,t,n)||r.getState().abortController?.signal.aborted){console.log("Auto-moderator turn ended or was aborted.");break}}async function dn(e,t,n){const s=e.agentPresets[n.moderatorAgent];if(!s)throw new Error(`Moderator agent '${n.moderatorAgent}' not found.`);r.bus.publish("status:update",{message:`Moderator '${n.moderatorAgent}' is deciding...`,state:"loading"});const o=t.history.map(d=>`${d.speaker||d.role}: ${d.content}`).join(`
`),i=`Based on the following conversation, choose the single most appropriate agent to speak next from this list: [${n.agents.filter(d=>d!==n.moderatorAgent).join(", ")}]. Respond with ONLY the agent's name.

Conversation:
${o}`;let c;try{const d=await Z(s,[{role:"user",content:i}]);if(c=n.agents.find(u=>d.includes(u)),!c)throw new Error("Moderator did not return a valid agent name from the list.")}catch(d){return g(`Moderator failed: ${d.message}. Stopping this turn.`,"Error"),!1}const l={role:"system",content:`[Moderator selected ${c} to speak.]`};return t.history.push(l),r.bus.publish("ui:renderMessages"),await st(e,t,c),!0}async function st(e,t,n){const s=e.agentPresets[n];if(!s||!s.model){console.warn(`Skipping turn for agent '${n}' because they have no model configured.`);const l={role:"system",content:`[Skipping turn for ${n}: No model configured in Agent Studio.]`};t.history.push(l),r.bus.publish("ui:renderMessages");return}const o={role:"assistant",content:"...",speaker:n,isLoading:!0};t.history.push(o);const a=t.history.length-1;r.bus.publish("ui:renderMessages"),await new Promise(l=>setTimeout(l,50));const i=document.querySelector(`.message-turn-wrapper[data-index='${a}']`),c=i?.querySelector(".message-content .streaming-content");if(!i||!c){console.error(`Could not find UI placeholder for agent ${n}.`),t.history[a]={...o,content:"UI Error",isLoading:!1,isError:!0},r.bus.publish("ui:renderMessages");return}try{const l=lt(t.history.slice(0,-1),n),d=new Ve(i);await ut(s,l,d.streamChunk);const u=d.getFinalContent();t.history[a]={role:"assistant",content:u,speaker:n,isLoading:!1}}catch(l){l.name!=="AbortError"?t.history[a]={...o,content:`Error: ${l.message}`,isLoading:!1,isError:!0}:t.history.splice(a,1)}finally{r.bus.publish("ui:renderMessages")}}let I=[];function un(){const e=document.getElementById("chatMessages");if(!e)return;const t=s=>{const o=s.closest(".message.assistant");if(!o)return;const a=o.querySelector(".message-content");if(a){const i=a.cloneNode(!0);i.querySelectorAll(".code-block-wrapper").forEach(c=>{const l=c.querySelector("pre");l&&c.parentNode.replaceChild(l,c)}),r.bus.publish("composer:append",{content:i.innerHTML}),o.classList.add("sent-to-composer-feedback"),setTimeout(()=>{o.classList.remove("sent-to-composer-feedback")},500)}},n=(s,o)=>{s.type==="contextmenu"&&s.preventDefault();const a=window.getSelection(),i=a.toString().trim(),c=i&&a.containsNode(o,!0),l=[{label:"Send to Composer",action:()=>t(s.target)}];c&&l.push({label:"Send Selection to Composer",action:()=>{r.bus.publish("composer:append",{content:i})}}),Jt(l,s)};e.addEventListener("contextmenu",s=>{if(s.shiftKey)return;const o=s.target.closest(".message.assistant");o&&(s.preventDefault(),n(s,o))}),e.addEventListener("dblclick",s=>{const o=s.target.closest(".message.assistant");o&&n(s,o)})}function H(e){return typeof e!="string"||!e?0:Math.round(e.length/4)}function ot(){const e=r.getProject();if(!e||!e.activeEntity)return{finalSystemPrompt:"",totalTokens:0,agent:{},agentNameForDisplay:"N/A"};const t=ct(),n=e.chatSessions.find(d=>d.id===e.activeSessionId),s=n?H(JSON.stringify(n.history||[])):0,o=H(document.getElementById("chatInput")?.value||""),i=H(t)+s+o,c=e.agentPresets[e.activeEntity.name]||{},l=e.activeEntity.name||"N/A";return{finalSystemPrompt:t,totalTokens:i,agent:c,agentNameForDisplay:l,model:c.model||"N/A"}}async function rt(){if(r.isLoading())return;r.newAbortController();const e=r.getProject(),t=document.getElementById("chatInput"),n=t.value.trim();if(!n&&I.length===0)return;if(!e.activeEntity?.name){g("Please select an Agent or Group.","Error");return}let s;if(e.activeEntity.type==="agent")s=e.agentPresets[e.activeEntity.name];else{const c=e.agentGroups[e.activeEntity.name];s=e.agentPresets[c?.moderatorAgent]}if(!s||!s.model){g("The selected Agent/Moderator has no model configured.","Error");return}const o=e.chatSessions.find(c=>c.id===e.activeSessionId);if(!o)return;let a=[];n&&a.push({type:"text",text:n}),I.length>0&&I.forEach(c=>{a.push({type:"image_url",url:c.data})});const i={role:"user",content:a,speaker:"You",timestamp:Date.now()};if(console.log("[DEBUG 1.1] User message created:",i),o.history.push(i),o.name==="New Chat"&&o.history.length===1&&En(o),t.value="",t.style.height="auto",I=[],r.bus.publish("ui:renderFilePreviews",{files:I}),r.bus.publish("ui:renderMessages"),r.updateAndPersistState(),e.activeEntity.type==="agent")await Ce();else{const c=e.agentGroups[e.activeEntity.name];await nt(e,o,c)}}async function Ce(){const e=r.getProject(),t=e.chatSessions.find(d=>d.id===e.activeSessionId);if(!t||e.activeEntity.type!=="agent")return;const n=e.activeEntity.name,s=e.agentPresets[n];if(_e().userCredits<=0){g("Your userCredits have run out. Please upgrade to a Pro plan to continue.","Credits Depleted");return}r.bus.publish("ui:toggleLoading",{isLoading:!0});const a={role:"assistant",content:"",speaker:n,isLoading:!0},i=t.history.length;t.history.push(a);const c=Zt(a,i);let l;try{l=new Ve(c)}catch(d){console.error("UI Error:",d.message),r.bus.publish("ui:toggleLoading",{isLoading:!1}),r.bus.publish("status:update",{message:"UI Error",state:"error"}),t.history.pop();return}try{const d=lt(t.history.slice(0,-1),n),u=await ut(s,d,l.streamChunk);ze(u.usage,s.model);const p={role:"assistant",content:u.content,speaker:n,isLoading:!1,timestamp:Date.now(),stats:{...u.usage,duration:u.duration,speed:u.usage.completion_tokens/u.duration}};t.history[i]=p}catch(d){if(d.name!=="AbortError"){const u=`Error: ${d.message}`;t.history[i].content=u,console.error("LLM Stream Error:",d),r.bus.publish("status:update",{message:"An error occurred.",state:"error"})}else t.history.splice(i,1),console.log("Stream aborted by user.")}finally{r.bus.publish("ui:toggleLoading",{isLoading:!1}),Q(),await x(A,"readwrite","put",t),r.getState().abortController?.signal.aborted||r.bus.publish("status:update",{message:"Ready",state:"connected"})}}function Le(){r.abort(),r.setLoading(!1),r.bus.publish("ui:toggleLoading",{isLoading:!1})}window.ChatHandlers={sendMessage:rt,stopGeneration:Le};function mn({index:e}){I&&I[e]!==void 0&&(I.splice(e,1),r.bus.publish("ui:renderFilePreviews",{files:I}))}function pn(e){const t=e.target.files;if(t){for(const n of t){const s=`file_${Date.now()}_${Math.random()}`,o={id:s,name:n.name,type:n.type,data:null};I.push(o);const a=new FileReader;a.onload=i=>{const c=I.findIndex(l=>l.id===s);c!==-1&&(I[c].data=i.target.result,r.bus.publish("ui:renderFilePreviews",{files:I}))},a.readAsDataURL(n)}e.target.value=""}}async function gn(e){const t=r.getProject(),n=t.chatSessions.find(a=>a.id===t.activeSessionId),s=t.summaryLogs.find(a=>a.id===e);if(!n||!s)return;n.summaryState.activeSummaryId=s.id,n.summaryState.summarizedUntilIndex=n.history.length;const o={role:"system",content:`[ System: Context loaded from summary: "${s.summary}" ]

---

${s.content}`,isSummary:!0};n.history.push(o),await x(A,"readwrite","put",n),r.setProject(t),r.updateAndPersistState(),r.bus.publish("ui:renderMessages"),r.bus.publish("summary:listChanged")}function fn(){console.log("ðŸš€ unloadSummaryFromActiveSession handler called!");const e=r.getProject(),t=e.chatSessions.find(n=>n.id===e.activeSessionId);!t||!t.summaryState?.activeSummaryId||(console.log(`Clearing summary context for session: ${t.name}`),t.summaryState.activeSummaryId=null,t.history.push({role:"system",content:"[Summary context has been cleared. The full conversation history is now active.]"}),r.updateAndPersistState(),Q(),r.bus.publish("status:update",{message:"Summary context cleared.",state:"connected"}),g("Summary context cleared successfully.","Success"),r.bus.publish("context:requestData"))}async function yn(e){if(!confirm("Are you sure you want to permanently delete this summary log? This cannot be undone."))return;const t=r.getProject(),n=t.summaryLogs.findIndex(s=>s.id===e);n>-1&&(t.summaryLogs.splice(n,1),t.chatSessions.forEach(s=>{if(s.summaryState?.activeSummaryId===e&&(s.summaryState.activeSummaryId=null,s.id===t.activeSessionId)){const o={role:"system",content:"[ System: The active summary was deleted. Context has been cleared. ]"};s.history.push(o),r.bus.publish("ui:renderMessages")}}),r.setProject(t),await r.updateAndPersistState(),r.bus.publish("summary:listChanged"))}async function hn({index:e,event:t}){t&&t.stopPropagation();const n=t.currentTarget,s=r.getProject(),o=s.chatSessions.find(l=>l.id===s.activeSessionId);if(!o)return;const a=o.history[e];if(!a)return;let i="";typeof a.content=="string"?i=a.content:Array.isArray(a.content)&&(i=a.content.find(l=>l.type==="text")?.text||"");let c="";a.role==="assistant"&&window.marked?c=marked.parse(i,{gfm:!0,breaks:!1}):c=`<p>${i.replace(/\n/g,"<br>")}</p>`;try{const l=new Blob([c],{type:"text/html"}),d=new Blob([i],{type:"text/plain"}),u=new ClipboardItem({"text/html":l,"text/plain":d});if(await navigator.clipboard.write([u]),n){const m=n.querySelector(".material-symbols-outlined");if(m){const p=m.textContent;m.textContent="check",setTimeout(()=>{m.textContent=p},1500)}}}catch(l){console.error("Failed to copy rich text, falling back to plain text:",l),await navigator.clipboard.writeText(i),g("Failed to copy rich text, copied as plain text instead.","Warning")}}new TurndownService({headingStyle:"atx",codeBlockStyle:"fenced"});async function bn({index:e,event:t}){t&&t.stopPropagation();const n=r.getProject(),s=n.chatSessions.find(l=>l.id===n.activeSessionId);if(!s)return;const o=s.history[e],a=document.querySelector(`.message-turn-wrapper[data-index='${e}']`);if(!a)return;const i=a.querySelector(".message"),c=i.querySelector(".message-content");if(o.role==="user"){if(i.classList.contains("is-editing"))return;i.classList.add("is-editing"),a.classList.add("is-editing-child"),c&&(c.style.display="none");const l=document.createElement("div");l.className="inline-edit-container";const d=document.createElement("textarea");d.className="inline-edit-textarea";const u=Array.isArray(o.content)?o.content.find(f=>f.type==="text")?.text||"":o.content;d.value=u,d.addEventListener("input",()=>{d.style.height="auto",d.style.height=d.scrollHeight+"px"});const m=document.createElement("div");m.className="inline-edit-actions";const p=document.createElement("button");p.textContent="Save & Regenerate",p.className="btn btn-small";const y=document.createElement("button");y.textContent="Cancel",y.className="btn btn-small btn-secondary";const h=()=>{l.remove(),c&&(c.style.display="block"),i.classList.remove("is-editing"),a.classList.remove("is-editing-child")};p.addEventListener("click",async f=>{f.stopPropagation();const v=d.value.trim(),b=Array.isArray(o.content)?o.content.filter(P=>P.type!=="text"):[],C=[];if(v&&C.push({type:"text",text:v}),C.push(...b),C.length===0){g("Cannot save an empty message.","Warning");return}if(s.history[e].content=C,s.history.splice(e+1),r.updateAndPersistState(),r.bus.publish("ui:renderMessages"),n.activeEntity.type==="agent")await Ce();else if(n.activeEntity.type==="group"){const P=n.agentGroups[n.activeEntity.name];await nt(n,s,P)}}),y.addEventListener("click",f=>{f.stopPropagation(),h()}),d.addEventListener("keydown",f=>{f.key==="Escape"&&(f.preventDefault(),y.click())}),m.appendChild(y),m.appendChild(p),l.appendChild(d),l.appendChild(m),i.appendChild(l),d.focus(),d.dispatchEvent(new Event("input"))}else if(o.role==="assistant"){if(!c||i.classList.contains("is-editing"))return;i.classList.add("is-editing"),a.classList.add("is-editing-child"),c&&(c.style.display="none");const l=document.createElement("div");l.className="inline-edit-container";const d=document.createElement("textarea");d.className="inline-edit-textarea",d.value=o.content,d.addEventListener("input",()=>{d.style.height="auto",d.style.height=d.scrollHeight+"px"});const u=document.createElement("div");u.className="inline-edit-actions";const m=document.createElement("button");m.textContent="Save",m.className="btn btn-small";const p=document.createElement("button");p.textContent="Cancel",p.className="btn btn-small btn-secondary";const y=()=>{l.remove(),c&&(c.style.display="block"),i.classList.remove("is-editing"),a.classList.remove("is-editing-child")};m.addEventListener("click",h=>{h.stopPropagation(),s.history[e].content=d.value,r.updateAndPersistState(),r.bus.publish("ui:renderMessages")}),p.addEventListener("click",h=>{h.stopPropagation(),y()}),d.addEventListener("keydown",h=>{h.key==="Escape"&&(h.preventDefault(),p.click())}),u.appendChild(p),u.appendChild(m),l.appendChild(d),l.appendChild(u),i.appendChild(l),d.focus(),d.dispatchEvent(new Event("input"))}}async function vn({index:e}){const t=r.getProject(),n=t.chatSessions.find(o=>o.id===t.activeSessionId);if(!n||e>=n.history.length)return;Le();let s=-1;for(let o=e;o>=0;o--)if(n.history[o].role==="user"){s=o;break}s!==-1&&(n.history.splice(s+1),r.bus.publish("ui:renderMessages"),await Ce())}function Sn({index:e}){if(!confirm("Are you sure you want to delete this single message? This action cannot be undone."))return;const t=r.getProject(),n=t.chatSessions.find(s=>s.id===t.activeSessionId);n&&(n.history.splice(e,1),r.setProject(t),r.updateAndPersistState(),r.bus.publish("ui:renderMessages"))}async function En(e){await new Promise(t=>setTimeout(t,500));try{const n=r.getProject().globalSettings.systemUtilityAgent;if(!n||!n.model){console.warn("Auto-naming skipped: System Utility Agent not configured.");return}const s=e.history.find(d=>d.role==="user"),o=Array.isArray(s.content)?s.content.find(d=>d.type==="text")?.text:s.content;if(!o)return;const a=`Based on the user's initial query, create a concise title (3-5 words) and a single relevant emoji. Respond ONLY with a JSON object like {"title": "your title", "emoji": "ðŸ‘"}.

User's Query: "${o}"`,i=await Z({...n,temperature:.1},[{role:"user",content:a}]);ze(i.usage,n.model);let c={};try{const d=i.content.match(/{.*}/s);c=JSON.parse(d[0])}catch{console.error("Failed to parse title JSON:",i.content),c={title:o.substring(0,30),emoji:"ðŸ’¬"}}const l=`${c.emoji||"ðŸ’¬"} ${c.title||"New Chat"}`;r.bus.publish("session:autoRename",{sessionId:e.id,newName:l})}catch(t){console.error("Auto-rename process failed:",t)}}function wn({index:e}){const t=r.getProject(),n=t.chatSessions.find(a=>a.id===t.activeSessionId);if(!n)return;const s=n.history[e],o=n.summaryState?.activeSummaryId;o&&s?.summaryLogId===o&&(n.summaryState.activeSummaryId=null,console.log(`Summary context for log ID ${o} has been cleared.`)),n.history.splice(e,1),r.updateAndPersistState(),r.bus.publish("ui:renderMessages"),g("Marker/Context has been removed from this chat.","Info")}const Pn={"perplexity/sonar-small-online":{penalties:!1,seed:!1,top_k:!1,tools:!1},"perplexity/sonar-medium-online":{penalties:!1,seed:!1,top_k:!1,tools:!1},"xai/grok-1.5":{penalties:!1,seed:!1}};function W(e,t){if(!e||!e.id)return!1;const n=e.id,s=Pn[n];if(s&&s[t]!==void 0)return s[t];switch(t){case"penalties":case"seed":return!n.startsWith("xai/")&&!n.startsWith("perplexity/");case"tools":return!n.startsWith("perplexity/")&&e.supports_tools;default:return!0}}async function Cn(e){const t=await fetch("https://openrouter.ai/api/v1/models",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Could not fetch models from OpenRouter");return(await t.json()).data.map(s=>({id:s.id,name:s.name||s.id,provider:"openrouter",description:s.description,context_length:s.context_length,pricing:{prompt:s.pricing?.prompt||"0",completion:s.pricing?.completion||"0"},supports_tools:s.architecture?.tool_use===!0}))}async function Ln(e){try{const t=await fetch(`${e}/api/tags`);if(!t.ok)throw new Error(`Ollama connection failed (HTTP ${t.status})`);return(await t.json()).models.map(s=>({id:s.name,name:s.name,provider:"ollama",supports_tools:!1}))}catch{throw new Error("Could not connect to Ollama. Check URL and CORS settings.")}}async function at(e,t={},n=12e4){const s=new AbortController,o=setTimeout(()=>s.abort(),n),a=AbortSignal.any([t.signal,s.signal].filter(Boolean));try{return await fetch(e,{...t,signal:a})}finally{clearTimeout(o)}}async function it(){r.bus.publish("status:update",{message:"Loading models...",state:"loading"});const e=Ge(),t=We();let n=[];try{const c=[];e&&c.push(Cn(e).catch(d=>(console.error("OpenRouter fetch failed:",d),[]))),t&&c.push(Ln(t).catch(d=>(console.error("Ollama fetch failed:",d),[]))),n=(await Promise.all(c)).flat()}catch(c){r.bus.publish("status:update",{message:`Error loading models: ${c.message}`,state:"error"});return}r.setAllModels(n);const s=r.getProject();let o=!1;if(n.length>0&&s){const c=s.globalSettings.systemUtilityAgent,l=s.agentPresets["Default Agent"];if(c&&(!c.model||!n.some(d=>d.id===c.model))){const u=["google/gemma-3-27b-it","openai/gpt-4o-mini"].find(m=>n.some(p=>p.id===m));u&&(c.model=u,l&&(l.model=u),o=!0)}}o&&r.setProject(s);const a=r.getState().allProviderModels||[],i=a.length>0?`Loaded ${a.length} models.`:"No models found.";r.bus.publish("status:update",{message:i,state:"connected"})}function ct(e){const t=r.getProject();if(!t)return"";let n;const s=t.activeEntity,o=e||s?.name,a=e?"agent":s?.type;if(!o)return"";if(a==="agent")n=t.agentPresets?.[o];else if(a==="group"){const u=t.agentGroups?.[o];n=t.agentPresets?.[u?.moderatorAgent]}if(!n)return"";let i=n.systemPrompt||"";const c=n.activeMemories||[];if(c.length===0)return i.trim();const l=c.map(u=>{const m=t.memories.find(p=>p.name===u);return m?m.content:""}).filter(u=>u).join(`

`);return l?`${i.trim()}

--- Active Memories ---
${l}`:i.trim()}function lt(e,t){const s=r.getProject().agentPresets[t];if(!s)return[];const a=r.getState().allProviderModels.find(l=>l.id===s.model),i=[],c=ct(t);return c&&i.push({role:"system",content:c}),e.forEach(l=>{if(l.isLoading||!l.content)return;let d=l.content;Array.isArray(d)&&(a?.provider==="openrouter"?d=d.map(p=>p.type==="image_url"?{type:"image_url",image_url:{url:p.url}}:p):d=d.filter(p=>p.type==="text"&&p.text).map(p=>p.text).join(`
`));const u={role:l.role,content:d};i.push(u)}),i}function dt(e,t,n=!1){const s=r.getProject();console.log("API call sees these globalSettings:",s.globalSettings);const a=r.getState().allProviderModels.find(m=>m.id===e.model);if(!a)throw new Error(`Model data for agent.model ID '${e.model}' not found.`);const i=a.provider;let c,l,d;const u={temperature:parseFloat(e.temperature),top_p:parseFloat(e.topP),top_k:parseInt(e.topK,10),presence_penalty:parseFloat(e.presence_penalty),frequency_penalty:parseFloat(e.frequency_penalty),max_tokens:parseInt(e.max_tokens,10),seed:parseInt(e.seed,10),stop:e.stop_sequences?e.stop_sequences.split(",").map(m=>m.trim()).filter(Boolean):void 0};if(i==="openrouter"){c="https://openrouter.ai/api/v1/chat/completions",l={Authorization:`Bearer ${Ge()}`,"Content-Type":"application/json",Accept:"application/json","HTTP-Referer":"https://sarega.github.io/PromptPrim/","X-Title":"PromptPrim"};const m={temperature:u.temperature,top_p:u.top_p,max_tokens:u.max_tokens};W(a,"top_k")&&u.top_k>0&&(m.top_k=u.top_k),W(a,"penalties")&&(m.presence_penalty=u.presence_penalty,m.frequency_penalty=u.frequency_penalty),W(a,"seed")&&u.seed!==-1&&(m.seed=u.seed),u.stop&&(m.stop=u.stop),d={model:e.model,messages:t,stream:n,...m},W(a,"tools")&&(d.tools=[{type:"Google Search"}])}else{c=`${We()}/api/chat`,l={"Content-Type":"application/json"};const m={temperature:u.temperature,top_p:u.top_p,top_k:u.top_k,num_predict:u.max_tokens,seed:u.seed,stop:u.stop};Object.keys(m).forEach(p=>(m[p]==null||Number.isNaN(m[p]))&&delete m[p]),d={model:e.model,messages:t,stream:n,options:m}}return{url:c,headers:l,body:d,provider:i}}async function ut(e,t,n){const{url:s,headers:o,body:a,provider:i}=dt(e,t,!0);try{r.bus.publish("status:update",{message:`Responding with ${e.model}...`,state:"loading"});const c=performance.now(),l=await at(s,{method:"POST",headers:o,body:JSON.stringify(a),signal:r.getState().abortController?.signal});if(!l.ok)throw new Error(`API Error: ${l.status} ${l.statusText}`);const d=l.body.getReader(),u=new TextDecoder("utf-8");let m="",p="";for(;;){const{value:v,done:b}=await d.read();if(b)break;m+=u.decode(v,{stream:!0});const C=m.split(`
`);m=C.pop();for(const P of C){if(P.trim()===""||P.startsWith(":"))continue;let B="";try{if(i==="openrouter"){if(P.startsWith("data: ")){const G=P.replace(/^data: /,"").trim();if(G==="[DONE]")break;B=JSON.parse(G).choices?.[0]?.delta?.content||""}}else B=JSON.parse(P).message?.content||""}catch{console.warn("Skipping malformed JSON chunk:",P)}B&&(p+=B,n(B))}}const h=(performance.now()-c)/1e3;let f={prompt_tokens:0,completion_tokens:0};if(i==="openrouter"&&l.headers.has("x-openrouter-usage"))try{f=JSON.parse(l.headers.get("x-openrouter-usage"))}catch(v){console.error("Could not parse usage header:",v)}else f.prompt_tokens=H(JSON.stringify(t)),f.completion_tokens=H(p);return{content:p,usage:f,duration:h}}catch(c){throw c.name!=="AbortError"&&(console.error("Streaming failed:",c),r.bus.publish("status:update",{message:`Error: ${c.message}`,state:"error"})),c}}async function Z(e,t){const{url:n,headers:s,body:o,provider:a}=dt(e,t,!1);try{console.log("[API CALL]",{url:n,headers:s,body:o});const i=await at(n,{method:"POST",headers:s,body:JSON.stringify(o)});if(!i.ok){const d=await i.text();throw new Error(`API Error: ${i.status} ${d}`)}const c=await i.json(),l=a==="openrouter"&&c.choices?.length>0?c.choices[0].message.content:c.message?.content;if(l===void 0)throw new Error("Invalid API response structure.");return{content:l,usage:c.usage||{prompt_tokens:0,completion_tokens:0}}}catch(i){throw console.error("callLLM failed:",i),i}}function In(){document.addEventListener("keydown",e=>{const t=document.querySelector('.modal-overlay[style*="display: flex"]'),n=document.getElementById("settings-panel"),s=n?.classList.contains("visible");if(!(!t&&!s)){if(e.key==="Escape"){if(e.preventDefault(),t){const o=t.querySelector(".btn-secondary")||t.querySelector(".modal-actions .btn");o&&o.click()}else if(s){const o=n.querySelector(".close-settings-btn");o&&o.click()}}if(e.key==="Enter"&&!e.shiftKey){if(e.target.tagName==="TEXTAREA"||e.target.tagName==="BUTTON")return;if(t){e.preventDefault();const o=t.querySelector(".modal-actions .btn:not(.btn-secondary):not(.btn-danger)");if(o)o.click();else{const a=t.querySelector(".modal-actions .btn");a&&a.click()}}}}}),console.log("Global keyboard bindings initialized.")}function se(e){const t=document.getElementById("project-title");if(t){const n=r.isUserDirty(),s=e||r.getProject()?.name||"Untitled";t.textContent=n?`${s} *`:s}}function An(){const e=document.getElementById("save-project-modal"),t=document.getElementById("project-name-input"),n=r.getProject();t.value=n?`${n.name} - Copy`:"Untitled Project",e.style.display="flex",t.focus(),t.select()}function Be(){const e=document.getElementById("save-project-modal");e.style.display="none"}function kn(e){e&&e.stopPropagation(),document.getElementById("custom-entity-selector-wrapper").classList.toggle("open")}function jn(e){const t=e.indexOf("_"),n=e.substring(0,t),s=e.substring(t+1);r.bus.publish("entity:select",{type:n,name:s}),document.getElementById("custom-entity-selector-wrapper").classList.remove("open")}function Y(){const e=r.getProject();if(!e||!e.globalSettings)return;const t=document.getElementById("entitySelector"),n=document.getElementById("custom-entity-selector-options"),s=document.getElementById("custom-entity-selector-icon"),o=document.getElementById("custom-entity-selector-text");t.innerHTML="",n.innerHTML="";const a=(l,d,u,m)=>{const p=`${l}_${d}`,y=document.createElement("div");y.className="custom-select-option",y.innerHTML=`<span class="item-icon">${u}</span> <span>${d}</span>`,y.addEventListener("click",()=>jn(p)),m.appendChild(new Option(`${u} ${d}`,p)),n.appendChild(y)},i=e.agentPresets||{};if(Object.keys(i).length>0){const l=document.createElement("optgroup");l.label="Agent Presets",t.appendChild(l);const d=document.createElement("div");d.className="custom-select-group",d.textContent="Agent Presets",n.appendChild(d),Object.keys(i).forEach(u=>{a("agent",u,i[u].icon||"ðŸ¤–",l)})}const c=e.agentGroups||{};if(Object.keys(c).length>0){const l=document.createElement("optgroup");l.label="Agent Groups",t.appendChild(l);const d=document.createElement("div");d.className="custom-select-group",d.textContent="Agent Groups",n.appendChild(d),Object.keys(c).forEach(u=>{a("group",u,"ðŸ¤",l)})}if(e.activeEntity){const{type:l,name:d}=e.activeEntity;t.value=`${l}_${d}`,l==="agent"&&i[d]?(s.textContent=i[d].icon||"ðŸ¤–",o.textContent=d):l==="group"?(s.textContent="ðŸ¤",o.textContent=d):(s.textContent="â”",o.textContent="Select...")}}function Mn(){r.bus.subscribe("project:loaded",n=>{se(n.projectData.name),Y()}),r.bus.subscribe("project:nameChanged",n=>se(n)),r.bus.subscribe("userDirty:changed",()=>se()),r.bus.subscribe("entity:selected",Y),r.bus.subscribe("agent:listChanged",Y),r.bus.subscribe("group:listChanged",Y),r.bus.subscribe("ui:showSaveAsModal",An);const e=document.querySelector(".sidebar-bottom-row .dropdown");if(e){const n=e.querySelector("button");n&&n.addEventListener("click",z),e.addEventListener("click",s=>{const o=s.target.closest("a");if(!o)return;const a=o.dataset.action;if(a){s.preventDefault();const i={newProject:{name:"project:new"},openProject:{name:"project:open"},saveProject:{name:"project:save",data:!1},saveProjectAs:{name:"project:save",data:!0},exportChat:{name:"project:exportChat"}};i[a]&&r.bus.publish(i[a].name,i[a].data),e.classList.remove("open")}})}const t=document.getElementById("save-project-modal");t&&t.addEventListener("click",n=>{if(n.target.matches(".btn:not(.btn-secondary)")){const s=document.getElementById("project-name-input").value.trim();s?(r.bus.publish("project:saveConfirm",{projectName:s}),Be()):g("Please enter a project name.")}else(n.target.matches(".btn-secondary")||n.target===t)&&Be()}),document.getElementById("load-project-input")?.addEventListener("change",n=>r.bus.publish("project:fileSelectedForOpen",n)),document.getElementById("custom-entity-selector-trigger")?.addEventListener("click",kn),console.log("Project UI Initialized with definitive listeners.")}let Te=!1;function oe(e){const t=r.getProject();let n="ðŸ’¬";e.linkedEntity?.type==="agent"&&t.agentPresets[e.linkedEntity.name]?n=t.agentPresets[e.linkedEntity.name].icon||"ðŸ¤–":e.linkedEntity?.type==="group"&&(n="ðŸ¤");const s=document.createElement("div");s.className="item session-item",s.dataset.sessionId=e.id,e.pinned&&s.classList.add("pinned");const o=e.name||"New Chat";return s.innerHTML=`
        <div class="item-header">
            <span class="item-name"><span class="item-icon">${n}</span> ${o}</span>
            <div class="item-actions">
                <div class="dropdown align-right">
                    <button class="btn-icon" data-action="toggle-menu" title="More options">&#8942;</button>
                    <div class="dropdown-content">
                        <a href="#" data-action="pin">${e.pinned?"Unpin":"Pin"} Session</a>
                        <a href="#" data-action="rename">Rename</a>
                        <a href="#" data-action="clone">Clone Session</a>
                        <a href="#" data-action="archive">${e.archived?"Unarchive":"Archive"} Session</a>                        <a href="#" data-action="download">Download Chat</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" data-action="delete" class="is-destructive">
                            <span class="material-symbols-outlined">delete</span> Delete Session
                        </a>                    
                    </div>
                </div>
            </div>
        </div>
    `,s}function mt(e){document.querySelectorAll(".session-item").forEach(n=>{n.classList.toggle("active",n.dataset.sessionId===e)})}function U(){const e=r.getProject();if(!e)return;const t=document.getElementById("pinnedSessionList"),n=document.getElementById("sessionListContainer"),s=document.getElementById("archivedSessionList"),o=document.getElementById("archivedSessionsSection");if(!t||!n||!s||!o)return;t.innerHTML="",n.innerHTML="",s.innerHTML="";const a=e.chatSessions||[],i=a.filter(d=>d.isPinned&&!d.archived),c=a.filter(d=>!d.isPinned&&!d.archived),l=a.filter(d=>d.archived);i.sort((d,u)=>u.updatedAt-d.updatedAt).forEach(d=>{t.appendChild(oe(d))}),c.sort((d,u)=>u.updatedAt-d.updatedAt).forEach(d=>{n.appendChild(oe(d))}),l.sort((d,u)=>u.updatedAt-d.updatedAt).forEach(d=>{s.appendChild(oe(d))}),o.classList.toggle("hidden",l.length===0),mt(e.activeSessionId)}function xn(){if(Te)return;Te=!0,r.bus.subscribe("project:loaded",U),r.bus.subscribe("session:listChanged",U),r.bus.subscribe("session:loaded",()=>mt(r.getProject()?.activeSessionId));const e=document.querySelector(".sessions-panel");e&&e.addEventListener("click",t=>{const n=t.target,s=n.closest(".dropdown-content a[data-action]");if(s){t.preventDefault(),t.stopPropagation();const i=n.closest(".session-item[data-session-id]");if(!i)return;const c=i.dataset.sessionId,l=s.dataset.action;r.bus.publish(`session:${l}`,{sessionId:c,event:t}),s.closest(".dropdown.open")?.classList.remove("open");return}if(n.closest('button[data-action="toggle-menu"]')){t.preventDefault(),t.stopPropagation(),z(t);return}if(n.closest("#new-chat-btn")){r.bus.publish("session:new");return}const a=n.closest(".session-item[data-session-id]");if(a){const i=a.dataset.sessionId;r.getProject().activeSessionId!==i&&T(i)}}),console.log("âœ… Session UI and its dedicated event listener initialized ONCE.")}const Ie=()=>document.querySelector("#composer-editor .composer-content-area");function pt(e){const t=r.getProject(),n=t?.chatSessions.find(s=>s.id===t.activeSessionId);n&&n.composerContent!==e&&(n.composerContent=e,r.updateAndPersistState())}function pe(){const e=Ie();if(!e)return;const t=r.getProject();if(!t?.activeSessionId){e.innerHTML="";return}const n=t.chatSessions.find(s=>s.id===t.activeSessionId);e.innerHTML=n?.composerContent||""}function Bn({content:e}){const t=Ie(),n=document.getElementById("composer-panel");!t||!n||(n.classList.contains("collapsed")&&(n.classList.remove("collapsed"),document.getElementById("resizer-row")?.classList.remove("collapsed"),r.bus.publish("composer:visibilityChanged")),t.textContent.trim()!==""&&(t.innerHTML+="<br><hr><br>"),t.innerHTML+=e,t.scrollTop=t.scrollHeight,pt(t.innerHTML))}function Tn(e){const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("*").forEach(n=>{if(n.removeAttribute("style"),n.classList.length>0){const s=[];for(let o=0;o<n.classList.length;o++)n.classList[o].startsWith("hljs-")||s.push(n.classList[o]);s.forEach(o=>n.classList.remove(o))}}),t.innerHTML}function $n(){const e=Ie();if(!e)return;const t=e.innerHTML;if(!t.trim()){g("Composer is empty. Nothing to export.","Info");return}const s=`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Composer Export</title>
            
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
            
            <style>
                /* 2. à¸ªà¹„à¸•à¸¥à¹Œà¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸‚à¸­à¸‡à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¸—à¸µà¹ˆ Export */
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
                    line-height: 1.6; 
                    padding: 20px; 
                    max-width: 800px; 
                    margin: auto; 
                }
                pre {
                    background-color: #f6f8fa; /* à¸ªà¸µà¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡ Code Block à¸ªà¸³à¸«à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆ Export */
                    padding: 16px;
                    border-radius: 6px;
                    overflow-x: auto;
                }
                code {
                    font-family: 'Fira Mono', 'Menlo', monospace;
                }
            </style>
        </head>
        <body>
            ${Tn(t)}
        </body>
        </html>
    `,o=new Blob([s],{type:"text/html;charset=utf-8"}),a=URL.createObjectURL(o),i=document.createElement("a");i.href=a,i.download=`composer-export-${Date.now()}.html`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}function Nn(){const e=document.getElementById("color-palette");if(!e)return;const t=["#000000","#E03131","#C2255C","#9C36B5","#6741D9","#3B5BDB","#1971C2","#0C8599","#099268","#2F9E44","#66A80F","#F08C00","#E8590C","#868E96","#495057"];e.innerHTML="",t.forEach(n=>{const s=document.createElement("div");s.className="color-swatch",s.style.backgroundColor=n,s.dataset.color=n,e.appendChild(s)})}function N(){const e=document.querySelector(".composer-tools-area");if(!e)return;let t=!1;const n=document.queryCommandValue("formatBlock").toLowerCase();for(const o of["H1","H2","H3","P"]){const a=e.querySelector(`button[data-value="${o}"]`);a&&(n===`<${o.toLowerCase()}>`?(a.classList.add("is-active"),o!=="P"&&(t=!0)):a.classList.remove("is-active"))}["bold","italic","underline","strikeThrough"].forEach(o=>{const a=e.querySelector(`button[data-command="${o}"]`);if(a){const i=o==="bold"&&t?!1:document.queryCommandState(o);a.classList.toggle("is-active",i)}})}function Dn(e){const t=document.querySelector("#composer-editor .composer-content-area");t&&(t.innerHTML="")}function Un(){const e=document.getElementById("composer-panel"),t=document.querySelector("#composer-editor .composer-content-area"),n=document.getElementById("mobile-composer-toggle");document.getElementById("composer-editor");const s=document.querySelector(".composer-tools-area"),o=document.getElementById("composer-collapse-btn"),a=document.getElementById("composer-expand-btn"),i=document.getElementById("export-composer-btn");if(!e||!t){console.error("Composer UI cannot initialize: Core elements not found.");return}const c=()=>{e.classList.contains("collapsed"),e.classList.toggle("collapsed");const p=e.classList.contains("collapsed");n&&n.classList.toggle("is-open",!p),r.bus.publish("composer:visibilityChanged")};n&&n.addEventListener("click",c);const l=document.getElementById("resizer-row");l&&l.addEventListener("mousedown",p=>{if(window.innerWidth<=768){p.preventDefault();return}}),r.bus.subscribe("project:loaded",pe),r.bus.subscribe("session:loaded",pe),r.bus.subscribe("composer:append",Bn),r.bus.subscribe("ui:toggleComposer",c),t.addEventListener("focus",()=>{document.execCommand("formatBlock",!1,"p"),N()}),["click","keyup","focus"].forEach(p=>{t.addEventListener(p,()=>{setTimeout(N,1)})}),document.addEventListener("selectionchange",()=>{document.activeElement===t&&N()});const u=V(()=>pt(t.innerHTML),500);t.addEventListener("input",u),["keyup","mouseup"].forEach(p=>t.addEventListener(p,N)),document.addEventListener("selectionchange",()=>{document.activeElement===t&&N()}),s&&(Nn(),s.addEventListener("mousedown",p=>{p.preventDefault();const y=p.target.closest("button, .color-swatch");if(y){if(t.focus(),y.id==="color-picker-btn"){y.parentElement.classList.toggle("open");return}if(y.classList.contains("color-swatch"))document.execCommand("foreColor",!1,y.dataset.color),y.closest(".dropdown")?.classList.remove("open");else{const h=y.dataset.command;if(h){let f=y.dataset.value||null;h==="formatBlock"&&f&&(f=`<${f}>`),document.execCommand(h,!1,f)}}N()}})),i&&i.addEventListener("click",$n),o&&o.addEventListener("click",c),a&&a.addEventListener("click",()=>{const p=e.style.flexBasis&&parseInt(e.style.flexBasis,10)>window.innerHeight*.5;e.style.flexBasis=p?"35vh":"90vh"}),console.log("âœ… Composer UI Initialized with definitive patches.")}const On=(e="sid")=>`${e}_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,ee=()=>r.getProject(r.activeProjectId);function gt(){const e=r.getProject(),t=e?.activeEntity;if(!e||!t)return;const n={id:`sid_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:"New Chat",history:[],composerContent:"",createdAt:Date.now(),updatedAt:Date.now(),pinned:!1,archived:!1,linkedEntity:{...t},summaryState:{activeSummaryId:null,summarizedUntilIndex:-1}};e.chatSessions.unshift(n),e.activeSessionId=n.id,r.setProject(e),T(n.id)}function T(e){const t=r.getProject();if(!t)return;if(!e){t.activeSessionId=null,r.setProject(t),r.bus.publish("session:cleared");return}const n=t.chatSessions.find(s=>s.id===e);if(!n){console.warn(`Session with ID ${e} not found. Loading most recent as fallback.`);const s=[...t.chatSessions].filter(o=>!o.archived).sort((o,a)=>a.updatedAt-o.updatedAt)[0];T(s?s.id:null);return}t.activeSessionId=e,n.linkedEntity&&(t.activeEntity={...n.linkedEntity}),r.setProject(t),r.updateAndPersistState(),r.bus.publish("session:loaded",{session:n})}function qn({sessionId:e}){const t=r.getProject(),n=t?.chatSessions.find(o=>o.id===e);if(!n)return;const s=prompt("Enter new name:",n.name);s&&s.trim()&&s.trim()!==n.name&&(n.name=s.trim(),n.updatedAt=Date.now(),r.updateAndPersistState(),r.bus.publish("session:listChanged"),e===t.activeSessionId&&r.bus.publish("ui:updateChatTitle",{title:n.name}))}async function Fn({sessionId:e}){if(!confirm("Are you sure you want to delete this chat session? This cannot be undone."))return;const t=r.getProject(),n=t.chatSessions.findIndex(s=>s.id===e);if(n!==-1){if(t.chatSessions.splice(n,1),await x(A,"readwrite","delete",e),t.activeSessionId===e){const s=[...t.chatSessions].filter(o=>!o.archived).sort((o,a)=>a.updatedAt-o.updatedAt)[0];t.activeSessionId=s?s.id:null,T(t.activeSessionId)}else r.bus.publish("session:listChanged");r.updateAndPersistState()}}function Hn(e,t){t?.stopPropagation();const n=ee(),s=n?.chatSessions.find(o=>o.id===e);s&&(s.pinned=!s.pinned,s.updatedAt=Date.now(),r.updateAndPersistState(n),U())}function Rn(e,t){t?.stopPropagation();const n=ee(),s=n?.chatSessions.find(a=>a.id===e);if(!s){g("Error: Could not find session to clone.","Error");return}const o=JSON.parse(JSON.stringify(s));o.id=On(),o.name=`${s.name} (Copy)`,o.createdAt=Date.now(),o.updatedAt=Date.now(),o.pinned=!1,o.archived=!1,n.chatSessions.unshift(o),n.activeSessionId=o.id,r.updateAndPersistState(n),T(o.id)}function _n(e,t){t?.stopPropagation();const n=ee(),s=n?.chatSessions.find(o=>o.id===e);if(s)if(s.archived=!s.archived,s.archived&&(s.pinned=!1),s.updatedAt=Date.now(),n.activeSessionId===e&&s.archived){const o=n.chatSessions.find(a=>!a.archived);n.activeSessionId=o?o.id:null,r.updateAndPersistState(n),T(n.activeSessionId)}else r.updateAndPersistState(n),U()}async function ft(e){const t=e||ee()?.chatSessions;if(!t)return;const n=Je();if(!n){console.error("[SaveAllSessions] Cannot save, DB not available.");return}const s=n.transaction(A,"readwrite"),o=s.objectStore(A);for(const a of t)o.put(a);return new Promise((a,i)=>{s.oncomplete=()=>a(),s.onerror=()=>i(s.error)})}function zn(e){try{const t=r.getProject();if(!t)throw new Error("Project not found.");const n=e?.sessionId||t.activeSessionId;if(!n)throw new Error("No session is active or selected for download.");console.log(`Attempting to download session with ID: ${n}`);const s=t.chatSessions.find(u=>u.id===n);if(!s)throw new Error(`Session with ID ${n} could not be found.`);let o=`Chat Session: ${s.name||"Untitled Session"}
`;o+=`Exported on: ${new Date().toLocaleString()}
`,s.linkedEntity&&(o+=`Associated Entity: ${s.linkedEntity.name} (${s.linkedEntity.type})
`),o+=`============================================

`;const a=s.history||[];a.length===0?o+="[This session has no messages.]":a.forEach(u=>{const m=u.timestamp?$t(u.timestamp):"No Timestamp",p=(u.speaker||u.role||"unknown").toUpperCase(),y=Array.isArray(u.content)?u.content.find(h=>h.type==="text")?.text||"[multimodal content]":u.content;o+=`[${m}] ${p}:
${y}

--------------------------------

`}),console.log(`Final text content length: ${o.length}`);const i=new Blob([o],{type:"text/plain;charset=utf-8"}),c=URL.createObjectURL(i),l=document.createElement("a"),d=(s.name||"untitled").replace(/[^a-z0-9]/gi,"_").toLowerCase();l.download=`session-export-${d}.txt`,l.href=c,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),URL.revokeObjectURL(c),console.log("Download initiated and cleanup complete.")},100)}catch(t){console.error("Download Chat Session failed:",t),g(`Failed to download chat: ${t.message}`,"Error")}}function Gn({height:e}){const t=r.getProject(),n=t?.chatSessions.find(s=>s.id===t.activeSessionId);n&&e&&(n.composerHeight=e)}async function Wn(){const e=r.getProject(),t=e?.chatSessions.find(n=>n.id===e.activeSessionId);if(!t){console.warn("[AutoSave] Could not find active session to save.");return}try{await x(A,"readwrite","put",t)}catch(n){console.error(`[AutoSave] Failed to save active session (${t.id}):`,n)}}function Yn({sessionId:e,newName:t}){const n=r.getProject();if(!n)return;const s=n.chatSessions.find(o=>o.id===e);!s||s.name!=="New Chat"||(s.name=t,s.updatedAt=Date.now(),r.updateAndPersistState(),r.bus.publish("session:listChanged"),n.activeSessionId===e&&r.bus.publish("ui:updateChatTitle",{title:t}))}async function Kn(){const e=r.getProject();if(!e||!e.id)return console.warn("[AutoSave] Aborted: Project not available for saving."),!1;console.log("[AutoSave] Persisting essential data to IndexedDB...");try{return await Ae(),await Wn(),console.log("[AutoSave] Essential project state successfully persisted."),!0}catch(t){return console.error("[AutoSave] Failed to persist project state:",t),!1}}function Jn(){let e;r.bus.subscribe("autosave:required",()=>{clearTimeout(e),e=setTimeout(async()=>{r.isAutoSaveDirty()&&await Kn()&&r.setAutoSaveDirty(!1)},2e3)})}function Vn(){r.isUserDirty()?(r.setState("pendingActionAfterSave",()=>{document.getElementById("load-project-input").click()}),et()):document.getElementById("load-project-input").click()}async function ge(){console.log("Proceeding with creating a new project...");try{const e=localStorage.getItem("lastActiveProjectId");e&&(await Tt(e),localStorage.removeItem("lastActiveProjectId"));const t=await fetch("/PromptPrim/default-project.prim");if(!t.ok)throw new Error(`Could not fetch default project file. Status: ${t.status}`);const n=await t.json(),s=_();s&&s.systemAgentDefaults&&(n.globalSettings.systemUtilityAgent=s.systemAgentDefaults.utilityAgent,n.globalSettings.summarizationPromptPresets=s.systemAgentDefaults.summarizationPresets),n.id=`proj_${Date.now()}`,await Se(n.id),await te(n,!0)}catch(e){console.error("Failed to proceed with creating a new project:",e),g("Could not create a new project. Please check the browser console for more details.","Error")}}function fe(){r.isUserDirty()?(r.setState("pendingActionAfterSave",ge),et()):ge()}function Xn(e){const t=e.target.files[0];if(!t)return;console.log(`[OpenProject] File selected: ${t.name}. Reading file...`);const n=new FileReader;n.onload=async s=>{try{const o=s.target.result;console.log("[OpenProject] File read complete. Parsing JSON...");const a=JSON.parse(o);if(!a.id||!a.name)throw new Error("Invalid project file format.");console.log(`[OpenProject] JSON parsed successfully for project: ${a.name}. Loading data...`),await te(a,!0)}catch(o){console.error("[OpenProject] Failed to load project:",o),g(`Error loading project: ${o.message}`,"Error")}},n.onerror=()=>{console.error("[OpenProject] FileReader error."),g("Failed to read the selected file.","Error")},n.readAsText(t),e.target.value=""}function Qn(){try{const e=r.getState().pendingFileToOpen;if(!e)return;ts(e),r.setState("pendingFileToOpen",null)}catch(e){console.error("Failed to proceed with opening project:",e),g("Could not open the project file.","Error")}}async function yt(e=!1){const t=r.getProject();e||t.name==="Untitled Project"?r.bus.publish("ui:showSaveAsModal"):await ht(t.name)}async function ht(e){const t=e?.trim();if(!t)return g("Please enter a project name."),!1;const n=r.getProject();n.name=t,r.bus.publish("project:nameChanged",t),r.setUserDirty(!1);const s=JSON.parse(JSON.stringify(r.getProject())),o=bt(s);try{const a=JSON.stringify(o,null,2),i=new Blob([a],{type:"application/json"}),c=URL.createObjectURL(i),l=document.createElement("a");return l.download=`${t.replace(/[^a-z0-9\u0E00-\u0E7F]/gi,"_").toLowerCase()}.prim`,l.href=c,document.body.appendChild(l),l.click(),URL.revokeObjectURL(c),document.body.removeChild(l),r.bus.publish("ui:hideSaveAsModal"),r.setAutoSaveDirty(!1),await os(),r.getState().pendingActionAfterSave&&await es(),!0}catch(a){return console.error("Failed to save project:",a),g("Failed to save project file.","Error"),r.setUserDirty(!0),!1}}async function Zn(e){Rt();const t=r.getState().pendingActionAfterSave;switch(r.setState("pendingActionAfterSave",null),e){case"save":await yt(!1);break;case"discard":typeof t=="function"&&await t();break}}async function es(){const e=r.getState().pendingActionAfterSave;r.setState("pendingActionAfterSave",null),e==="open"?await Qn():e==="new"&&await ge()}async function ts(e){const t=new FileReader;t.onload=async n=>{try{const s=JSON.parse(n.target.result);if(s&&s.id&&s.name&&s.agentPresets)await te(s,!0),g(`Project '${s.name}' loaded successfully!`,"Project Loaded");else throw new Error("Invalid project file format.")}catch(s){g(`Error loading project: ${s.message}`,"Error"),console.error(s)}},t.readAsText(e)}async function ns(e){if(!e)throw new Error("Cannot load last project: Project ID is missing.");await Se(e);const t=await x(R,"readonly","get",He);if(t&&t.data&&t.data.id===e){const n=t.data,s=await x(A,"readonly","getAll"),o={...n,chatSessions:s||[]};await te(o,!1),console.log("Successfully loaded the last active project from IndexedDB.")}else throw new Error("Project data in DB is invalid or mismatched with last known ID.")}async function te(e,t=!1){let n=bt(e);await Se(n.id),t&&(n.isDirtyForUser=!1),r.setProject(n),await rs(),n.globalSettings.apiKey&&await it(),n=r.getProject(),(n.chatSessions||[]).filter(i=>!i.archived).length===0&&gt();const o=r.getProject();o.isDirtyForUser=!1,await ss(o);const a=o.chatSessions.find(i=>i.id===o.activeSessionId)||[...o.chatSessions].filter(i=>!i.archived).sort((i,c)=>c.updatedAt-i.updatedAt)[0];a&&T(a.id),r.bus.publish("project:loaded",{projectData:o}),r.bus.publish("userDirty:changed",!1),r.setAutoSaveDirty(!1),localStorage.setItem("lastActiveProjectId",o.id)}async function ss(e){await Bt([A,R]),await Ae(e),await ft(e.chatSessions),console.log("Database has been rewritten with new project data.")}async function Ae(e){const t=e||r.getProject();if(!t||!t.id){console.warn("Cannot persist metadata: project or project ID is missing.");return}const n={...t};delete n.chatSessions,await x(R,"readwrite","put",{id:He,data:n})}async function os(){const e=r.getProject();if(!e||!e.id)return!1;console.log("[AutoSave] Persisting project to IndexedDB...");try{return await Ae(),await ft(),console.log("[AutoSave] Project state successfully persisted."),!0}catch(t){return console.error("[AutoSave] Failed to persist project state:",t),!1}}async function rs(){const e=r.getProject();!e||!e.globalSettings||(r.bus.publish("ui:applyFontSettings"),console.log("Global settings loaded into state."))}function as(e){const t=r.getProject();t.globalSettings.fontFamilySelect=e,r.setProject(t),r.updateAndPersistState(),r.bus.publish("ui:applyFontSettings")}function is(){const e=r.getProject();if(!e.globalSettings)return;const t=e.globalSettings.systemUtilityAgent;t.model=document.getElementById("system-utility-model-select").value,t.systemPrompt=document.getElementById("system-utility-prompt").value,t.temperature=parseFloat(document.getElementById("system-utility-temperature").value),t.topP=parseFloat(document.getElementById("system-utility-topP").value),r.setProject(e),r.updateAndPersistState()}function bt(e){if(e.isDirtyForUser===void 0&&(e.isDirtyForUser=!0),e.agentGroups)for(const t in e.agentGroups){const n=e.agentGroups[t];n&&!Array.isArray(n.agents)&&(n.agents=[])}return e}async function cs(e,t){r.setStagedEntity(null,!1);const n=r.getProject();n.activeEntity={type:e,name:t};const s=n.chatSessions.find(o=>o.id===n.activeSessionId);s&&(s.groupChatState&&(s.groupChatState.isRunning=!1),s.linkedEntity={...n.activeEntity},s.updatedAt=Date.now()),r.setProject(n),r.updateAndPersistState(),r.bus.publish("entity:selected",{type:e,name:t}),r.bus.publish("session:listChanged")}function ls({type:e,name:t}){const n={type:e,name:t},s=r.getStagedEntity(),o=r.getProject().activeEntity;if(s&&s.name===t&&s.type===e){r.bus.publish("entity:select",n);return}if(o&&o.name===t&&o.type===e){r.setStagedEntity(null);return}r.setStagedEntity(n)}function ds(e,t){const s=r.getProject().activeEntity,o=r.getStagedEntity(),a=document.createElement("div");return a.className="item agent-item",a.dataset.agentName=e,s?.type==="agent"&&s.name===e?a.classList.add("active"):o?.type==="agent"&&o.name===e&&a.classList.add("staged"),a.innerHTML=`
    <div class="item-header">
        <span class="item-name"><span class="item-icon">${t.icon||"ðŸ¤–"}</span> ${e}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="agent:edit" title="Edit Agent">
                <span class="material-symbols-outlined">edit</span>
            </button>             
            <button class="btn-icon danger" data-action="agent:delete" title="Delete Agent">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,a}function us(e){if(!e)return;const t=r.getProject();if(!t||!t.agentPresets)return;e.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>ðŸ¤– Agent Presets</h3>
                <button class="btn-icon" data-action="agent:create" title="Create New Agent">+</button>
            </summary>
            <div class="section-box">
                <div id="agentPresetList" class="item-list"></div>
            </div>
        </details>
    `);const s=e.querySelector("#agentPresetList:last-of-type");if(!s)return;const o=t.agentPresets;for(const a in o)s.appendChild(ds(a,o[a]))}function ye(e=!1,t=null){r.setState("editingAgentName",e?t:null);const n=r.getProject();document.getElementById("agent-modal-title").textContent=e?`Edit Agent: ${t}`:"Create New Agent";const s=e&&t&&n.agentPresets[t]?n.agentPresets[t]:Ct;document.getElementById("agent-name-input").value=e?t:"",Object.keys(J).forEach(c=>{const l=document.getElementById(c),d=J[c];if(l&&d!=="name"&&d!=="model"){const u=s[d];l[l.type==="checkbox"?"checked":"value"]=u!==void 0?u:""}});const a=_().appSettings.activeModelPreset||"top_models",i=Ee(a);we("agent-model-search-wrapper",s.model,i),document.getElementById("agent-editor-modal").style.display="flex"}function $e(){document.getElementById("agent-editor-modal").style.display="none",r.setState("editingAgentName",null)}function ms(){const e=document.getElementById("agent-editor-modal");e&&e.addEventListener("click",t=>{const n=t.target;n.matches(".modal-actions .btn:not(.btn-secondary)")?r.bus.publish("agent:save"):n.closest("#generate-agent-profile-btn")?r.bus.publish("agent:generateProfile"):(n.matches(".btn-secondary")||n.closest(".modal-close-btn"))&&$e()}),r.bus.subscribe("agent:profileGenerated",t=>{}),r.bus.subscribe("agent:enhancerStatus",({text:t,color:n})=>{}),r.bus.subscribe("agent:editorShouldClose",$e),r.bus.subscribe("models:loaded",()=>{const t=document.getElementById("agent-editor-modal");if(t&&t.style.display==="flex"){console.log("[AgentUI] Models loaded. Refreshing agent editor content.");const n=r.getState().editingAgentName;ye(!!n,n)}}),console.log("âœ… Agent UI Initialized.")}function ps(e){const n=r.getProject().activeEntity,s=r.getStagedEntity(),o=document.createElement("div");return o.className="item group-item",o.dataset.groupName=e,n?.type==="group"&&n.name===e?o.classList.add("active"):s?.type==="group"&&s.name===e&&o.classList.add("staged"),o.innerHTML=`
     <div class="item-header">
        <span class="item-name"><span class="item-icon">ðŸ¤</span> ${e}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="group:edit" title="Edit Group">
                <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="btn-icon danger" data-action="group:delete" title="Delete Group">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,o}function gs(e){if(!e)return;const t=r.getProject();if(!t||!t.agentGroups)return;e.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>ðŸ¤ Agent Groups</h3>
                <button class="btn-icon" data-action="group:create" title="Create New Group">+</button>
            </summary>
            <div class="section-box">
                <div id="agentGroupList" class="item-list"></div>
            </div>
        </details>
    `);const s=e.querySelector("#agentGroupList:last-of-type");if(!s)return;const o=t.agentGroups;for(const a in o)s.appendChild(ps(a))}function vt(){const e=document.getElementById("group-flow-select").value,t=document.getElementById("group-rounds-control"),n=document.getElementById("group-timer-control");!t||!n||(e==="round-robin"?(t.classList.remove("hidden"),n.classList.add("hidden")):(t.classList.add("hidden"),n.classList.remove("hidden")))}function Ne(e=!1,t=null){r.setState("editingGroupName",e?t:null);const n=r.getProject(),s=e?n.agentGroups[t]:null;document.getElementById("agent-group-modal-title").textContent=e?`Edit Group: ${t}`:"Create New Agent Group",document.getElementById("group-name-input").value=e?t:"";const o=document.getElementById("group-member-list");o.innerHTML="";const a=s?s.agents||[]:[],i=Object.keys(n.agentPresets),c=s?[...a]:[];i.forEach(l=>{c.includes(l)||c.push(l)}),c.forEach(l=>{const d=a.includes(l),u=document.createElement("div");u.className="agent-sortable-item",u.dataset.agentName=l,u.dataset.id=l;const m=`agent-cb-${l.replace(/\s+/g,"-")}`;u.innerHTML=`
            <input type="checkbox" id="${m}" ${d?"checked":""}>
            <label for="${m}">${l}</label>
            <span class="drag-handle">&#x2630;</span>
        `,u.querySelector('input[type="checkbox"]').addEventListener("change",()=>Ue(null)),o.appendChild(u)}),window.groupSortable&&window.groupSortable.destroy(),window.groupSortable=new Sortable(o,{animation:150,handle:".drag-handle"}),Ue(s?.moderatorAgent),document.getElementById("group-flow-select").value=s?.flowType||"auto-moderator",document.getElementById("group-max-turns-input").value=s?.maxTurns||1,document.getElementById("group-timer-input").value=s?.timerInSeconds||0,document.getElementById("group-summarization-threshold-input").value=s?.summarizationTokenThreshold??3e3,vt(),document.getElementById("agent-group-editor-modal").style.display="flex"}function De(){window.groupSortable&&(window.groupSortable.destroy(),window.groupSortable=null),document.getElementById("agent-group-editor-modal").style.display="none",r.setState("editingGroupName",null)}function Ue(e=null){const t=document.getElementById("group-moderator-select"),n=document.querySelectorAll("#group-member-list .agent-sortable-item"),s=Array.from(n).filter(a=>a.querySelector('input[type="checkbox"]').checked).map(a=>a.dataset.agentName),o=t.value;t.innerHTML='<option value="">-- Select Moderator --</option>',s.forEach(a=>{t.add(new Option(a,a))}),e&&s.includes(e)?t.value=e:s.includes(o)&&(t.value=o)}function fs(){r.bus.subscribe("group:editorShouldClose",De);const e=document.getElementById("agent-group-editor-modal");e&&(e.addEventListener("click",t=>{t.target.matches(".modal-actions .btn:not(.btn-secondary)")?r.bus.publish("group:save"):(t.target.matches(".btn-secondary")||t.target.closest(".modal-close-btn"))&&De()}),e.addEventListener("click",t=>{if(t.target.matches(".stepper-btn")){const n=t.target.parentElement.querySelector('input[type="number"]');if(!n)return;let s=parseInt(n.value,10)+parseInt(t.target.dataset.step,10);s=Math.max(n.min,Math.min(n.max,s)),n.value=s}})),document.getElementById("group-flow-select")?.addEventListener("change",vt),console.log("âœ… Group UI Initialized (Studio listener removed).")}let re=null;function ys(e,t,n){const s=document.createElement("div");s.className=`item memory-item ${t?"":"inactive"}`,s.dataset.name=e.name,s.dataset.memoryIndex=n;const a=Ze([{label:"Edit...",action:"memory:edit",data:{index:n}},{label:"Delete",action:"memory:delete",data:{index:n},isDestructive:!0}]),i=document.createElement("div");i.className=`memory-toggle ${t?"active":""}`,i.title=`Click to ${t?"deactivate":"activate"}`,i.onclick=d=>{d.stopPropagation(),r.bus.publish("memory:toggle",{name:e.name})};const c=document.createElement("span");c.className="item-name",c.textContent=e.name;const l=document.createElement("div");return l.className="item-header",l.appendChild(i),l.appendChild(c),l.appendChild(a),s.appendChild(l),s}function hs(e){if(!e)return;const t=r.getProject();if(!t)return;const n=document.createElement("details");n.className="collapsible-section memory-section",n.open=!0;const s=document.createElement("summary");s.className="section-header",s.innerHTML="<h3>ðŸ§  Command Memories</h3>";const o=[{label:"New Memory...",action:"memory:create"},{label:"Export Package...",action:"memory:exportPackage"},{label:"Import Package...",action:"memory:importPackage"}];s.appendChild(Ze(o)),n.appendChild(s);const a=document.createElement("div");a.className="section-box",n.appendChild(a);const i=t.agentPresets?.[t.activeEntity?.name];if(!i)a.innerHTML='<p class="no-items-message">Select an Agent to see memories.</p>';else{a.innerHTML=`
            <details id="active-memories-details" open><summary>Active Memories</summary><div id="activeMemoriesList" class="item-list"></div></details>
            <details id="inactiveMemoriesSection" open><summary>Inactive Memories</summary><div id="inactiveMemoriesList" class="item-list"></div></details>
        `;const c=a.querySelector("#activeMemoriesList"),l=a.querySelector("#inactiveMemoriesList"),d=i.activeMemories||[];(t.memories||[]).forEach((m,p)=>{const y=d.includes(m.name);(y?c:l).appendChild(ys(m,y,p))}),re&&re.destroy(),re=new Sortable(c,{animation:150,onEnd:m=>{const p=r.getProject().agentPresets[r.getProject().activeEntity.name];if(!p)return;const y=m.item.dataset.name;p.activeMemories.splice(m.oldDraggableIndex,1),p.activeMemories.splice(m.newDraggableIndex,0,y),r.bus.publish("studio:contentShouldRender")}})}e.appendChild(n)}function bs(){r.bus.subscribe("memory:editorShouldClose",qe);const e=document.getElementById("memory-editor-modal");e&&e.addEventListener("click",t=>{const n=t.target;n.matches(".modal-actions .btn:not(.btn-secondary)")&&r.bus.publish("memory:save"),(n.matches(".btn-secondary")||n.closest(".modal-close-btn")||n===e)&&qe()}),console.log("âœ… Memory UI Initialized (Studio listener removed).")}function Oe(e=null){const t=r.getProject(),n=document.getElementById("memory-editor-modal");if(n){if(e!==null&&t.memories[e]){const s=t.memories[e];n.querySelector("#memory-modal-title").textContent="Edit Memory",n.querySelector("#memory-name-input").value=s.name,n.querySelector("#memory-content-input").value=s.content,n.querySelector("#memory-edit-index").value=e}else n.querySelector("#memory-modal-title").textContent="Create New Memory",n.querySelector("#memory-name-input").value="",n.querySelector("#memory-content-input").value="",n.querySelector("#memory-edit-index").value="";n.style.display="flex"}}function qe(){document.getElementById("memory-editor-modal").style.display="none"}function K(){const e=document.querySelector("#studio-panel .studio-assets-container");e&&(e.innerHTML="",us(e),gs(e),hs(e))}function vs(){const e=document.getElementById("studio-panel");e&&e.dataset.listenerAttached!=="true"&&(e.dataset.listenerAttached="true",e.addEventListener("click",t=>{const n=t.target,s=n.closest("[data-action]"),o=n.closest(".item");if(n.closest(".memory-toggle")){t.stopPropagation();const a=n.closest(".item[data-name]");if(a){const i=a.dataset.name;console.log(`[DEBUG 1] âœ… StudioUI: Memory Toggle clicked for: '${i}'. Publishing 'memory:toggle'.`),r.bus.publish("memory:toggle",{name:i})}else console.error("[DEBUG 1] âŒ StudioUI: Toggle clicked, but couldn't find parent .item[data-name].");return}if(s){t.preventDefault(),t.stopPropagation();const a=s.dataset.action;let i={...o?.dataset};if(s.dataset.data)try{const c=JSON.parse(s.dataset.data);Object.assign(i,c)}catch{}a==="toggle-menu"?z(t):(r.bus.publish(a,i),s.closest(".dropdown.open")?.classList.remove("open"));return}if(o){t.preventDefault();const{agentName:a,groupName:i}=o.dataset;a?r.bus.publish("studio:itemClicked",{type:"agent",name:a}):i&&r.bus.publish("studio:itemClicked",{type:"group",name:i})}}),r.bus.subscribe("project:loaded",K),r.bus.subscribe("entity:selected",K),r.bus.subscribe("studio:contentShouldRender",()=>{K()}),r.bus.subscribe("entity:staged",K),console.log("âœ… Studio UI and its dedicated event listener initialized ONCE."))}async function Ss(){const e=document.getElementById("enhancer-prompt-input").value.trim();if(!e){g("Please describe the agent you want to create.","Error");return}console.log("ðŸ§  generateAgentProfile handler received event. Enhancer Prompt:",e),r.bus.publish("agent:enhancerStatus",{text:"Generating profile...",color:"var(--text-dark)"});const t=r.getProject().globalSettings.systemUtilityAgent;if(!t||!t.model){r.bus.publish("agent:enhancerStatus",{text:"Error: System Utility Model not configured.",color:"var(--error-color)"});return}const n=`You are an expert in designing LLM agent profiles. Based on the user's request, create a complete agent profile. Your response MUST be a single, valid JSON object with the following keys: "agent_name" (a creative and fitting name for the agent), "agent_icon" (a single, relevant emoji for the agent), "system_prompt" (string), "temperature" (number), "top_p" (number), "top_k" (number), "presence_penalty" (number), "frequency_penalty" (number). For the parameters, choose values that are optimal for the requested task (e.g., creative tasks need higher temperature). User's Request: "${e}"`;try{const s=await Z(t,[{role:"user",content:n}]);console.log("ðŸ¤– Raw response from LLM:",s);const o=s.match(/{.*}/s);if(!o)throw new Error("LLM did not return a valid JSON object.");const a=JSON.parse(o[0]);r.bus.publish("agent:profileGenerated",a),r.bus.publish("agent:enhancerStatus",{text:"Profile generated successfully!",color:"var(--success-color)"})}catch(s){console.error("Agent Profile Generation Error:",s),r.bus.publish("agent:enhancerStatus",{text:`Error: ${s.message}`,color:"var(--error-color)"})}finally{setTimeout(()=>r.bus.publish("agent:enhancerStatus",{text:""}),5e3)}}function Es(){const t=document.getElementById("agent-name-input").value.trim();if(!t){g("Please enter a name for the agent.","Error");return}const n=r.getProject(),s=r.getState().editingAgentName;if(s!==t&&n.agentPresets[t]){g(`An agent named '${t}' already exists.`,"Error");return}const o={};if(Object.keys(J).forEach(a=>{const i=J[a];if(i==="name")return;const c=document.getElementById(a);c&&(o[i]=c.type==="checkbox"?c.checked:c.type==="number"?parseFloat(c.value):c.value)}),o.icon||(o.icon="ðŸ¤–"),s&&s!==t){const a=n.agentPresets[s];delete n.agentPresets[s],n.agentPresets[t]={...a,...o},n.chatSessions.forEach(i=>{i.linkedEntity?.type==="agent"&&i.linkedEntity.name===s&&(i.linkedEntity.name=t)}),Object.values(n.agentGroups).forEach(i=>{const c=i.agents.indexOf(s);c>-1&&(i.agents[c]=t),i.moderatorAgent===s&&(i.moderatorAgent=t)}),n.activeEntity.type==="agent"&&n.activeEntity.name===s&&(n.activeEntity.name=t)}else s?n.agentPresets[s]={...n.agentPresets[s],...o}:(o.activeMemories=[],n.agentPresets[t]=o,n.activeEntity={type:"agent",name:t});r.setProject(n),r.updateAndPersistState(),r.bus.publish("studio:contentShouldRender"),r.bus.publish("agent:editorShouldClose")}function ws(e){const t=r.getProject();if(!e||Object.keys(t.agentPresets).length<=1){g("Cannot delete the last agent.","Error");return}confirm(`Are you sure you want to delete the agent '${e}'? This action cannot be undone.`)&&(delete t.agentPresets[e],Object.values(t.agentGroups).forEach(n=>{n.agents=n.agents.filter(s=>s!==e),n.moderatorAgent===e&&(n.moderatorAgent=n.agents[0]||"")}),t.chatSessions.forEach(n=>{n.linkedEntity?.type==="agent"&&n.linkedEntity.name===e&&(n.linkedEntity={type:"agent",name:Object.keys(t.agentPresets)[0]})}),t.activeEntity.type==="agent"&&t.activeEntity.name===e&&(t.activeEntity={type:"agent",name:Object.keys(t.agentPresets)[0]}),r.setProject(t),r.updateAndPersistState(),r.bus.publish("agent:listChanged"),r.bus.publish("entity:selected",t.activeEntity))}function Ps(){const e=r.getProject(),t=r.getState().editingGroupName,n=document.getElementById("group-name-input").value.trim();if(!n){g("Group name cannot be empty.","Error");return}if(n!==t&&e.agentGroups[n]){g(`A group named "${n}" already exists.`,"Error");return}const s=document.getElementById("group-moderator-select").value;if(!s){g("Please select a Moderator for the group.","Error");return}const o=window.groupSortable?window.groupSortable.toArray():[],a=document.querySelectorAll("#group-member-list .agent-sortable-item"),i=Array.from(a).filter(d=>d.querySelector('input[type="checkbox"]').checked).map(d=>d.dataset.agentName),c=o.filter(d=>i.includes(d));if(c.length===0){g("A group must have at least one member.","Error");return}const l={agents:c,moderatorAgent:s,flowType:document.getElementById("group-flow-select").value,maxTurns:parseInt(document.getElementById("group-max-turns-input").value,10),timerInSeconds:parseInt(document.getElementById("group-timer-input").value,10),summarizationTokenThreshold:parseInt(document.getElementById("group-summarization-threshold-input").value,10)};t&&t!==n&&(delete e.agentGroups[t],e.chatSessions.forEach(d=>{d.linkedEntity?.type==="group"&&d.linkedEntity.name===t&&(d.linkedEntity.name=n)})),e.agentGroups[n]=l,r.setProject(e),r.updateAndPersistState(),r.bus.publish("group:editorShouldClose"),g(`Group "${n}" saved successfully.`,"Success"),r.bus.publish("studio:contentShouldRender")}function Cs({groupName:e}){if(!confirm(`Are you sure you want to delete the group "${e}"? This cannot be undone.`))return;const t=r.getProject();delete t.agentGroups[e],r.setProject(t),r.updateAndPersistState(),r.bus.publish("group:listChanged"),g(`Group "${e}" has been deleted.`,"Success")}function Ls({name:e}){const t=r.getProject(),n=t.agentPresets[t.activeEntity.name];if(!n)return;const s=n.activeMemories||[];s.includes(e)?n.activeMemories=s.filter(a=>a!==e):n.activeMemories=[...s,e],r.setProject(t),r.updateAndPersistState(),r.bus.publish("studio:contentShouldRender")}function Is(){const e=r.getProject(),t=document.getElementById("memory-name-input").value.trim(),n=document.getElementById("memory-content-input").value,s=document.getElementById("memory-edit-index").value;if(!t){g("Memory name cannot be empty.","Error");return}if(s!==""){const o=e.memories[s].name;e.memories[s]={name:t,content:n},Object.values(e.agentPresets).forEach(a=>{const i=a.activeMemories.indexOf(o);i>-1&&(a.activeMemories[i]=t)})}else{if(e.memories.some(o=>o.name===t)){g(`A memory named "${t}" already exists.`,"Error");return}e.memories.push({name:t,content:n})}r.setProject(e),r.updateAndPersistState(),r.bus.publish("memory:editorShouldClose"),r.bus.publish("studio:contentShouldRender"),g(`Memory "${t}" saved successfully.`,"Success")}function As({index:e}){if(!confirm("Are you sure you want to permanently delete this memory? This cannot be undone."))return;const t=r.getProject();if(!t.memories[e])return;const n=t.memories[e].name;t.memories.splice(e,1),Object.values(t.agentPresets).forEach(s=>{if(s.activeMemories){const o=s.activeMemories.indexOf(n);o>-1&&s.activeMemories.splice(o,1)}}),r.setProject(t),r.updateAndPersistState(),r.bus.publish("studio:contentShouldRender")}function ks(){try{const e=r.getProject(),t={memories:e.memories,agentPresets:e.agentPresets},n=JSON.stringify(t,null,2),s=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(s),a=document.createElement("a");a.style.display="none",a.href=o,a.download=`promptprim_agent_package_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o)}catch(e){g("Error saving agent package."),console.error(e)}}function js(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=s=>{try{const o=JSON.parse(s.target.result);if(o&&Array.isArray(o.memories)&&typeof o.agentPresets=="object"){const a=r.getProject(),i=new Set(a.memories.map(l=>l.name)),c=o.memories.filter(l=>!i.has(l.name));a.memories.push(...c),Object.assign(a.agentPresets,o.agentPresets),r.setProject(a),r.updateAndPersistState(),r.bus.publish("memory:listChanged"),r.bus.publish("agent:listChanged"),g("Agent package loaded successfully!")}else throw new Error("Invalid JSON format for agent package.")}catch(o){g(`Error loading agent package: ${o.message}`),console.error(o)}},n.readAsText(t),e.target.value=""}async function Ms(){const e=r.getProject(),t=e.chatSessions.find(a=>a.id===e.activeSessionId);if(!t)return;const n=document.getElementById("summary-model-value").value;if(!n){g("Please select a model for summarization in the Settings tab.","Error");return}const s={...e.globalSettings.systemUtilityAgent,model:n},o=t.history.filter(a=>a.role==="user"||a.role==="assistant");if(o.length===0){g("Not enough messages to summarize.","Info");return}Fe(!0);try{const a=o.map(d=>`${d.speaker||d.role}: ${Array.isArray(d.content)?d.content.find(u=>u.type==="text")?.text||"[multimodal content]":d.content}`).join(`
`),c=document.getElementById("summary-modal-prompt-textarea").value.replace(/\$\{previousSummary\}/g,"This is a full-history summary from the beginning.").replace(/\$\{newMessages\}/g,a),l=await Z(s,[{role:"user",content:c}]);document.getElementById("summary-editor-title").value=`Summary of "${t.name}" at ${new Date().toLocaleTimeString()}`,document.getElementById("summary-editor-content").value=l,wt("new")}catch(a){g(`Summarization Failed: ${a.message}`,"Error")}finally{Fe(!1)}}function xs(){const e=r.getProject(),t=e.chatSessions.find(i=>i.id===e.activeSessionId),n=document.getElementById("summary-editor-title").value.trim(),s=document.getElementById("summary-editor-content").value.trim();if(!n||!s){g("Title and content cannot be empty.","Error");return}const o={id:`sum_${Date.now()}`,summary:n,content:s,timestamp:Date.now(),sourceSessionId:t.id};e.summaryLogs||(e.summaryLogs=[]),e.summaryLogs.push(o);const a={role:"system",content:`[Conversation summarized: "${n}"]`,isSummaryMarker:!0,summaryLogId:o.id};t.history.push(a),r.updateAndPersistState(),g("New summary log saved!","Success"),O(o.id),r.bus.publish("ui:renderMessages")}function Bs({logId:e,title:t,content:n}){if(!e||!t||!n)return;const o=r.getProject().summaryLogs.find(a=>a.id===e);o&&(o.summary=t,o.content=n,r.updateAndPersistState(),g("Changes saved!","Success"),ke())}function Ts({logId:e}){if(!confirm("Are you sure you want to delete this summary log?"))return;const t=r.getProject();t.summaryLogs=t.summaryLogs.filter(n=>n.id!==e),t.chatSessions.forEach(n=>{n.summaryState?.activeSummaryId===e&&(n.summaryState.activeSummaryId=null)}),r.updateAndPersistState(),g("Log deleted.","Success"),O(null)}function $s({logId:e}){const t=r.getProject(),n=t.chatSessions.find(a=>a.id===t.activeSessionId),s=t.summaryLogs.find(a=>a.id===e);if(!n||!s)return;n.summaryState={activeSummaryId:s.id};const o={role:"system",content:`[System: Context loaded from summary: "${s.summary}"]`,isSummary:!0};n.history.push(o),r.updateAndPersistState(),r.bus.publish("ui:renderMessages"),ve(),g("Summary loaded into context!","Success")}function St(){const t=document.getElementById("summary-modal-preset-select").value;if(t==="custom")return;const n=r.getProject(),s={...M,...n.globalSettings.summarizationPromptPresets};s[t]&&(document.getElementById("summary-modal-prompt-textarea").value=s[t],r.bus.publish("ui:renderSummarizationSelector"),r.bus.publish("ui:updateSummaryActionButtons"))}async function Ns({saveAs:e}){const t=document.getElementById("summary-modal-preset-select"),n=document.getElementById("summary-modal-prompt-textarea").value.trim();if(!n)return;let s=t.value;const o=M.hasOwnProperty(s);if((e||o||s==="custom")&&(s=prompt("Enter a name for this preset:",o?`${s} (Copy)`:"My Custom Prompt"),!s||!s.trim()))return;const a=r.getProject(),i=s.trim();a.globalSettings.summarizationPromptPresets[i]&&i!==t.value&&!confirm(`A preset named '${i}' already exists. Overwrite?`)||(a.globalSettings.summarizationPromptPresets[i]=n,r.setProject(a),await r.updateAndPersistState(),r.bus.publish("ui:renderSummarizationSelector"),setTimeout(()=>{const c=document.getElementById("summary-modal-preset-select");c&&(c.value=i),r.bus.publish("ui:updateSummaryActionButtons")},50),g(`Preset '${i}' saved!`,"Success"))}async function Ds(){const t=document.getElementById("summary-modal-preset-select").value;if(!M.hasOwnProperty(t)&&confirm(`Delete user preset "${t}"?`)){const n=r.getProject();delete n.globalSettings.summarizationPromptPresets[t],document.getElementById("summary-modal-prompt-textarea").value=M.Standard,r.setProject(n),await r.updateAndPersistState(),r.bus.publish("ui:renderSummarizationSelector"),g(`Preset '${t}' deleted.`,"Success")}}async function Us(){const t=document.getElementById("summary-modal-preset-select").value;if(M.hasOwnProperty(t)||t==="custom")return;const n=prompt(`Enter new name for "${t}":`,t);if(!n||!n.trim()||n.trim()===t)return;const s=r.getProject(),o=n.trim();if(s.globalSettings.summarizationPromptPresets[o]){g(`A preset named '${o}' already exists.`,"Error");return}s.globalSettings.summarizationPromptPresets[o]=s.globalSettings.summarizationPromptPresets[t],delete s.globalSettings.summarizationPromptPresets[t],r.setProject(s),await r.updateAndPersistState(),r.bus.publish("ui:renderSummarizationSelector"),setTimeout(()=>{document.getElementById("summary-modal-preset-select").value=o,r.bus.publish("ui:updateSummaryActionButtons")},50),g(`Preset renamed to '${o}'!`,"Success")}function Os({logId:e,messageIndex:t}){if(!confirm("Are you sure you want to delete this summary log? This will also remove the marker from the chat."))return;const n=r.getProject();n.summaryLogs=n.summaryLogs.filter(o=>o.id!==e);const s=n.chatSessions.find(o=>o.id===n.activeSessionId);s&&(s.history=s.history.filter(o=>o.summaryLogId!==e)),n.chatSessions.forEach(o=>{o.summaryState?.activeSummaryId===e&&(o.summaryState.activeSummaryId=null)}),r.updateAndPersistState(),g("Log deleted.","Success"),r.bus.publish("ui:renderMessages"),O(null)}let j=null;function Et(){const e=document.getElementById("summarization-modal");if(!e)return;const t=e.querySelector("#summary-modal-preset-select"),n=e.querySelector("#summary-modal-preset-actions .dropdown-content");if(!t||!n)return;n.innerHTML="";const s=t.options[t.selectedIndex];if(!s)return;const o=M.hasOwnProperty(s.value),a=s.value==="custom",i=(c,l,d={})=>{const u=document.createElement("a");return u.href="#",u.textContent=c,u.dataset.action=l,d.saveAs&&(u.dataset.saveAs="true"),u};if(a||o)n.appendChild(i(o?"Save as a Copy...":"Save as New Preset...","settings:saveSummaryPreset",{saveAs:!0}));else{n.appendChild(i("Save Changes","settings:saveSummaryPreset")),n.appendChild(i("Rename...","settings:renameSummaryPreset")),n.appendChild(i("Save as New Preset...","settings:saveSummaryPreset",{saveAs:!0})),n.appendChild(document.createElement("div")).className="dropdown-divider";const c=i("Delete Preset","settings:deleteSummaryPreset");c.classList.add("is-destructive"),n.appendChild(c)}}function he(){const e=r.getProject();if(!e||!e.globalSettings)return;const t=document.getElementById("summarization-modal");if(!t)return;const n=t.querySelector("#summary-modal-preset-select"),s=t.querySelector("#summary-modal-prompt-textarea"),o=e.globalSettings.summarizationPromptPresets||{},a=s.value,i=n.value;n.innerHTML="";let c=null;const l=document.createElement("optgroup");l.label="Factory Presets";for(const u in M)l.appendChild(new Option(u,u)),M[u].trim()===a.trim()&&(c=u);n.appendChild(l);const d=Object.keys(o).filter(u=>!M.hasOwnProperty(u));if(d.length>0){const u=document.createElement("optgroup");u.label="User Presets",d.forEach(m=>{u.appendChild(new Option(m,m)),o[m].trim()===a.trim()&&(c=m)}),n.appendChild(u)}if(c)n.value=c;else if(i&&n.querySelector(`option[value="${i}"]`))n.value=i;else if(a.trim()!==""){const u=new Option("--- Custom (Unsaved) ---","custom",!0,!0);u.disabled=!0,n.add(u),n.value="custom"}Et()}function qs(e){const t=document.createElement("div");return t.className="item summary-log-item",t.dataset.logId=e.id,e.id===j&&t.classList.add("active"),t.innerHTML=`<span class="item-name"><span class="item-icon">ðŸ’¡</span> ${e.summary}</span>`,t.title=`Created: ${new Date(e.timestamp).toLocaleString()}`,t}function wt(e){const t=document.getElementById("summary-editor-actions"),n=document.getElementById("summarize-conversation-btn");!t||!n||(t.classList.remove("hidden"),n.classList.add("hidden"),t.querySelector("#summary-editor-delete-btn").style.display=e==="existing"?"inline-flex":"none",t.querySelector("#summary-editor-load-btn").style.display=e==="existing"?"inline-flex":"none",t.querySelector("#summary-editor-save-btn").textContent=e==="existing"?"Save Changes":"Save New Log")}function Pt(){const e=document.getElementById("summarization-modal");if(!e)return;const t=e.querySelector("#summary-editor-actions"),n=e.querySelector("#summarize-conversation-btn");e.querySelector(".tab-btn.active")?.dataset.tab==="settings"?(t.classList.add("hidden"),n.classList.add("hidden")):j?(t.classList.remove("hidden"),n.classList.add("hidden")):(t.classList.add("hidden"),n.classList.remove("hidden"))}function O(e){j=e;const n=r.getProject().summaryLogs.find(s=>s.id===e);document.getElementById("summary-editor-title").value=n?n.summary:"",document.getElementById("summary-editor-content").value=n?n.content:"",n?wt("existing"):(document.getElementById("summary-editor-actions").classList.add("hidden"),document.getElementById("summarize-conversation-btn").classList.remove("hidden")),ke()}function ke(){const e=document.getElementById("summary-log-list-modal");if(!e)return;const t=r.getProject();e.innerHTML="";const n=t.summaryLogs||[];if(n.length===0){e.innerHTML='<p class="no-items-message">No summaries yet.</p>';return}const s=n.reduce((o,a)=>{const i=a.sourceSessionId,c=t.chatSessions.find(l=>l.id===i);return o[i]||(o[i]={name:c?c.name:"Unknown Session",logs:[]}),o[i].logs.push(a),o},{});Object.values(s).forEach(o=>{const a=o.logs.sort((c,l)=>l.timestamp-c.timestamp),i=document.createElement("details");i.open=!0,i.innerHTML=`<summary>For: ${o.name}</summary>`,a.forEach(c=>i.appendChild(qs(c))),e.appendChild(i)})}function be(){const e=document.getElementById("summarization-modal");if(!e)return;e.querySelectorAll(".tab-btn, .tab-content").forEach(i=>i.classList.remove("active")),e.querySelector('.tab-btn[data-tab="logs"]')?.classList.add("active"),e.querySelector('.tab-content[data-tab-content="logs"]')?.classList.add("active"),O(null),ke(),he(),St(),Pt();const n=_().appSettings.activeModelPreset||"top_models",s=Ee(n),o=r.getProject(),a=document.getElementById("summary-model-value")?.value||o.globalSettings.systemUtilityAgent?.model;we("summary-model-wrapper",a,s),e.style.display="flex"}function ve(){const e=document.getElementById("summarization-modal");e&&(e.style.display="none")}function Fe(e){const t=document.getElementById("summarize-conversation-btn");t&&(t.disabled=e,t.textContent=e?"Summarizing...":"âœ¨ Summarize Conversation")}function Fs(){const e=document.getElementById("summarization-modal");if(!e)return;e.querySelector("#summary-modal-close-btn")?.addEventListener("click",ve),e.querySelector(".modal-close-btn")?.addEventListener("click",ve),e.querySelector("#summarize-conversation-btn")?.addEventListener("click",Ms),e.querySelector("#summary-editor-save-btn")?.addEventListener("click",()=>{j?Bs({logId:j,title:document.getElementById("summary-editor-title").value,content:document.getElementById("summary-editor-content").value}):xs()}),e.querySelector("#summary-editor-delete-btn")?.addEventListener("click",()=>{j&&Ts({logId:j})}),e.querySelector("#summary-editor-load-btn")?.addEventListener("click",()=>{j&&$s({logId:j})}),e.querySelector(".tab-buttons")?.addEventListener("click",n=>{if(n.target.matches(".tab-btn")){const s=n.target.dataset.tab;e.querySelectorAll(".tab-btn, .tab-content").forEach(o=>o.classList.remove("active")),n.target.classList.add("active"),e.querySelector(`.tab-content[data-tab-content="${s}"]`)?.classList.add("active"),Pt()}}),e.querySelector("#summary-log-list-modal")?.addEventListener("click",n=>{const s=n.target.closest(".summary-log-item[data-log-id]");s&&O(s.dataset.logId)}),e.querySelector("#summary-modal-preset-select")?.addEventListener("change",()=>{St()}),e.querySelector("#summary-modal-prompt-textarea")?.addEventListener("input",()=>{he()});const t=e.querySelector("#summary-modal-preset-actions");t&&t.addEventListener("click",n=>{const s=n.target.closest("a[data-action], button[data-action]");if(!s)return;n.preventDefault(),n.stopPropagation();const o=s.dataset.action;if(o==="toggle-menu")z(n);else{const a=s.dataset.saveAs==="true";o==="settings:saveSummaryPreset"?Ns({saveAs:a}):o==="settings:renameSummaryPreset"?Us():o==="settings:deleteSummaryPreset"&&Ds(),s.closest(".dropdown.open")?.classList.remove("open")}}),r.bus.subscribe("ui:renderSummarizationSelector",he),r.bus.subscribe("ui:updateSummaryActionButtons",Et),r.bus.subscribe("app:settingsChanged",()=>{e&&e.style.display==="flex"&&be()}),console.log("âœ… Summarization Center UI Initialized.")}function Hs(e){Ye({openrouterKey:e}),r.bus.publish("api:loadModels")}function Rs(e){Ye({ollamaBaseUrl:e})}function _s(){try{const e=_();if(!e)throw new Error("No user settings found to export.");const t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=`promptprim_settings_${e.userProfile.userId||Date.now()}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}catch(e){g(`Error exporting settings: ${e.message}`,"Error")}}function zs(){document.getElementById("import-settings-input")?.click()}function Gs(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=s=>{try{const o=JSON.parse(s.target.result);if(o&&o.userProfile&&o.appSettings&&o.modelPresets)confirm("This will overwrite your current settings and reload the application. Are you sure?")&&(localStorage.setItem("promptPrimUserSettings_v1",JSON.stringify(o)),g("Settings imported! The app will now reload.","Success"),setTimeout(()=>window.location.reload(),1500));else throw new Error("Invalid settings file format.")}catch(o){g(`Error importing settings: ${o.message}`,"Error")}},n.readAsText(t),e.target.value=""}function ae(e){document.body.classList.remove("dark-mode","light-mode");const t=document.getElementById("hljs-light-theme"),n=document.getElementById("hljs-dark-theme");let s=e==="dark";e==="system"&&(s=window.matchMedia("(prefers-color-scheme: dark)").matches),document.body.classList.add(s?"dark-mode":"light-mode"),t&&(t.disabled=s),n&&(n.disabled=!s)}function Ws(){const e=document.getElementById("theme-switcher-dropdown");if(!e)return;const t=e.querySelectorAll('input[type="radio"]'),n=localStorage.getItem("theme")||"system";t.forEach(s=>{s.value===n&&(s.checked=!0),s.addEventListener("change",o=>{const a=o.target.value;localStorage.setItem("theme",a),ae(a)})}),ae(n),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{(localStorage.getItem("theme")||"system")==="system"&&ae("system")})}function ie(){const e=_e();if(!e)return;const t=document.querySelector(".user-profile-menu .user-name"),n=document.querySelector(".user-profile-menu .user-plan"),s=document.querySelector("#user-userCredits span:last-child"),o=document.querySelector("#user-profile-btn span");t&&(t.textContent=e.userName||"User"),n&&(n.textContent=e.plan?`${e.plan.charAt(0).toUpperCase()}${e.plan.slice(1)} Plan`:"Free Plan"),s&&(s.textContent=Math.floor(e.userCredits).toLocaleString()),o&&e.userName&&(o.textContent=e.userName.charAt(0).toUpperCase())}function Ys(){const e=document.querySelector(".user-profile-container");e&&(e.addEventListener("click",t=>{const n=t.target.closest("[data-action]");if(n){const s=n.dataset.action;switch(s!=="toggle-menu"&&t.preventDefault(),s){case"toggle-menu":z(t);break;case"user:settings":Qe(),e.classList.remove("open");break;case"user:exportSettings":_s(),e.classList.remove("open");break;case"user:importSettings":zs(),e.classList.remove("open");break}}}),Ws(),r.bus.subscribe("user:settingsLoaded",ie),r.bus.subscribe("user:settingsUpdated",ie),ie(),console.log("âœ… User Profile UI Initialized."))}function Ks(){const e=r.bus;e.subscribe("project:new",fe),e.subscribe("project:open",Vn),e.subscribe("project:fileSelectedForOpen",Xn),e.subscribe("project:save",t=>yt(t)),e.subscribe("project:saveConfirm",({projectName:t})=>ht(t)),e.subscribe("project:unsavedChangesChoice",Zn),e.subscribe("session:new",gt),e.subscribe("session:loaded",({session:t})=>{Pe(t.name),Q(),pe(),U(),r.bus.publish("entity:selected",t.linkedEntity)}),e.subscribe("session:cleared",()=>{en(),Dn(),U()}),e.subscribe("session:autoRename",Yn),e.subscribe("session:rename",t=>qn(t)),e.subscribe("session:clone",({sessionId:t,event:n})=>Rn(t,n)),e.subscribe("session:archive",({sessionId:t,event:n})=>_n(t,n)),e.subscribe("session:pin",({sessionId:t,event:n})=>Hn(t,n)),e.subscribe("session:delete",t=>Fn(t)),e.subscribe("session:download",({sessionId:t})=>zn({sessionId:t})),e.subscribe("agent:create",()=>ye(!1)),e.subscribe("agent:save",Es),e.subscribe("agent:edit",({agentName:t})=>ye(!0,t)),e.subscribe("agent:delete",({agentName:t})=>ws(t)),e.subscribe("agent:generateProfile",Ss),e.subscribe("group:create",()=>Ne(!1)),e.subscribe("group:save",Ps),e.subscribe("group:edit",({groupName:t})=>Ne(!0,t)),e.subscribe("group:delete",({groupName:t})=>Cs({groupName:t})),e.subscribe("memory:create",()=>Oe(null)),e.subscribe("memory:save",Is),e.subscribe("memory:edit",({index:t})=>Oe(t)),e.subscribe("memory:delete",({index:t})=>As({index:t})),e.subscribe("memory:toggle",t=>{Ls(t)}),e.subscribe("memory:exportPackage",ks),e.subscribe("memory:importPackage",()=>{document.getElementById("load-memory-package-input").click()}),e.subscribe("studio:itemClicked",ls),e.subscribe("summary:view",({logId:t})=>(void 0)(t)),e.subscribe("summary:load",({logId:t})=>gn(t)),e.subscribe("summary:delete",({logId:t})=>yn(t)),e.subscribe("summary:editFromChat",({logId:t})=>{be(),setTimeout(()=>O(t),50)}),e.subscribe("summary:deleteFromChat",Os),e.subscribe("chat:clearSummaryContext",wn),e.subscribe("entity:select",({type:t,name:n})=>cs(t,n)),e.subscribe("open-composer",()=>{r.bus.publish("ui:toggleComposer")}),e.subscribe("composer:heightChanged",Gn),e.subscribe("chat:deleteMessage",t=>Sn(t)),e.subscribe("chat:sendMessage",rt),e.subscribe("chat:stopGeneration",Le),e.subscribe("chat:editMessage",({index:t})=>bn({index:t})),e.subscribe("chat:copyMessage",({index:t,event:n})=>hn({index:t,event:n})),e.subscribe("chat:regenerateMessage",({index:t})=>vn({index:t})),e.subscribe("chat:fileUpload",t=>pn(t)),e.subscribe("chat:removeFile",({index:t})=>mn({index:t})),e.subscribe("chat:summarize",be),e.subscribe("chat:clearSummary",fn),e.subscribe("upload-file",()=>{document.getElementById("file-input")?.click()}),e.subscribe("api:loadModels",it),e.subscribe("settings:apiKeyChanged",Hs),e.subscribe("settings:ollamaUrlChanged",Rs),e.subscribe("settings:fontChanged",as),e.subscribe("settings:systemAgentChanged",is),console.log("âœ… Central Event Bus ready.")}function Js(){Kt(),In(),kt(),an(),Gt(),Mn(),xn(),rn(),qt(),Un(),vs(),ms(),fs(),bs(),Ut(),Fs(),un(),Ys(),document.getElementById("import-settings-input")?.addEventListener("change",Gs),console.log("âœ… All UI modules initialized.")}document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("loading-overlay");try{await Mt(),console.log("ðŸš€ Application starting..."),Js(),Ks(),Jn(),document.getElementById("load-memory-package-input").addEventListener("change",js);const t=localStorage.getItem("lastActiveProjectId");if(t){console.log(`Attempting to load last project with ID: ${t}`);try{await ns(t)}catch(n){console.error(`[RECOVERY] Failed to load last project (ID: ${t}). This is likely due to corrupted data.`,n),alert("Could not load your last project due to an error. A new project will be created."),localStorage.removeItem("lastActiveProjectId"),console.log("[RECOVERY] Creating a new project as a fallback."),await fe()}}else await fe();e?.classList.remove("active"),console.log("ðŸŽ‰ Application initialized successfully.")}catch(t){console.error("[FATAL STARTUP ERROR]",t),e.querySelector("p").textContent=`A critical error occurred: ${t.message}`}});
