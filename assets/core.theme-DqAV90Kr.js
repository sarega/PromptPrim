(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const ee="AIChatbotDB_Project_",G="chatSessions",fe="projectMetadata",Nt="projectInfo",Oe={Standard:`You are a professional summarizer. Your task is to create a dense, context-rich summary of a conversation. Include all key entities, character names, locations, critical events, and important emotional states. The summary should be detailed enough for another AI to pick up the conversation and understand all necessary context.

Here is the summary of the conversation so far:
--- PREVIOUS SUMMARY ---
\${previousSummary}
--- END PREVIOUS SUMMARY ---

Now, here are the new messages that have occurred since that summary:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide a new, single, cohesive summary that integrates the key points from the new messages into the previous one. Respond with ONLY the new, complete summary text.`,"Literary Analyst":`You are a meticulous literary analyst tasked with creating a detailed narrative digest. Your primary goal is to preserve the story's integrity, character development, and emotional nuances. Do NOT sacrifice important details for the sake of brevity.

Your digest must include:
- Plot Progression: Every significant event and the causal links between them.
- Character Arcs: Any changes in a character's state of mind, motivation, decisions, or relationships.
- Key Dialogue: Capture the essence and subtext of crucial conversations.
- Atmosphere & Setting: Mention key descriptions of the environment if they contribute to the mood or plot.
- New Elements: Note the introduction of any new characters, significant objects, or unresolved questions (foreshadowing).

Here is the narrative digest so far:
--- PREVIOUS DIGEST ---
\${previousSummary}
--- END PREVIOUS DIGEST ---

Now, here are the new scenes and dialogues that have occurred:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide a new, single, cohesive narrative digest that seamlessly integrates the key points from the new messages into the previous one. Write in a third-person, past-tense narrative style. Respond with ONLY the new, complete digest text.`,"Continuity Editor":`You are a continuity editor for a novel series. Your job is to create a 'Previously On...' document that ensures no plot points are ever lost. The output must be extremely detailed, acting as a perfect memory for another AI to continue the story without missing a single beat.

The document must retain:
- All character actions and their immediate consequences.
- The full names of any character or location mentioned.
- The specifics of any plans made or secrets revealed.
- Emotional state of each character at the end of the scene.
- Any objects that were acquired, lost, or noted as important.

The goal is maximum information retention, not summarization. Think of this as expanding upon the previous summary with new, detailed information.

Here is the continuity document so far:
--- PREVIOUS SUMMARY ---
\${previousSummary}
--- END PREVIOUS SUMMARY ---

Now, here are the new events to be added:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide the updated, complete continuity document, integrating the new events chronologically. Your response should be a single block of text containing only the updated document.`},$t={model:"openai/gpt-4o-mini",systemPrompt:"You are a highly efficient assistant that processes user requests and responds in a structured JSON format when required. You are objective and precise.",summarizationPrompt:Oe.Standard,temperature:.2,topP:1,topK:0,presence_penalty:0,frequency_penalty:0,max_tokens:2048,seed:-1,stop_sequences:""},_t={id:`agent_${Date.now()}`,createdBy:"Unknown User",createdAt:Date.now(),modifiedAt:Date.now(),type:"custom",author:"",version:"1.0.0",description:"",tags:[],activeMemories:[],actions:[],icon:"🤖",model:"",systemPrompt:"You are a helpful assistant.",useMarkdown:!0,enableWebSearch:!1,temperature:1,topP:1,topK:0,presence_penalty:0,frequency_penalty:0,max_tokens:4096,seed:-1,stop_sequences:""},v={currentProject:{},systemProviderModels:[],userProviderModels:[],isLoading:!1,allProviderModels:[],isLoading:!1,isDirtyForAutoSave:!1,abortController:null,editingAgentName:null,editingGroupName:null,stagedEntity:null,pendingFileToOpen:null,pendingActionAfterSave:null},_={events:{},subscribe(e,t){return typeof t!="function"?(console.warn(`Attempted to subscribe to "${e}" with a non-function.`,t),()=>{}):(this.events[e]=this.events[e]||[],this.events[e].push(t),()=>{this.events[e]=this.events[e].filter(n=>t!==n)})},publish(e,t){this.events[e]&&this.events[e].slice().forEach(n=>{if(typeof n=="function")try{n(t)}catch(s){console.error(`Error in subscriber for event "${e}":`,s)}})}},i={getState:()=>v,getProject:()=>v.currentProject,isLoading:()=>v.isLoading,getStagedEntity:()=>v.stagedEntity,setStagedEntity:(e,t=!0)=>{JSON.stringify(v.stagedEntity)!==JSON.stringify(e)&&(console.log("🟠 [STATE] Staged entity changing to:",e),v.stagedEntity=e,t&&i.bus.publish("entity:staged",e))},isUserDirty:()=>v.currentProject?.isDirtyForUser||!1,isAutoSaveDirty:()=>v.isDirtyForAutoSave,setState:(e,t)=>{v[e]=t},setProject:e=>{v.currentProject=e,_.publish("project:stateChanged",v.currentProject)},setLoading:e=>{v.isLoading!==e&&(v.isLoading=e,_.publish("loading:changed",e))},setUserDirty:e=>{v.currentProject&&v.currentProject.isDirtyForUser!==e&&(v.currentProject.isDirtyForUser=e,_.publish("userDirty:changed",e))},setAutoSaveDirty:e=>{v.isDirtyForAutoSave!==e&&(v.isDirtyForAutoSave=e,e&&_.publish("autosave:required"))},updateAndPersistState:()=>{i.setUserDirty(!0),i.setAutoSaveDirty(!0)},setSystemModels:e=>{v.systemProviderModels=e.sort((t,n)=>t.name.localeCompare(n.name)),i.bus.publish("models:loaded",v.systemProviderModels)},setUserModels:e=>{v.userProviderModels=e.sort((t,n)=>t.name.localeCompare(n.name)),i.bus.publish("user:modelsLoaded",v.userProviderModels)},newAbortController:()=>(v.abortController=new AbortController,v.abortController),abort:()=>{v.abortController&&(v.abortController.abort(),v.abortController=null)},bus:_};function te(e,t){let n;return function(...o){const a=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(a,t)}}function Ft(e){if(!e)return"N/A";const t=new Date,n=new Date(e),s=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1),a={hour:"2-digit",minute:"2-digit",hour12:!1},r=n.toLocaleTimeString("th-TH",a);if(n>=s)return`Today ${r}`;if(n>=o)return`Yesterday ${r}`;{const c={day:"2-digit",month:"2-digit",year:"numeric"};return`${n.toLocaleDateString("th-TH",c)} ${r}`}}class be{constructor(t){if(this.contentDiv=t.querySelector(".message-content .streaming-content"),this.accumulatedMarkdown="",this.isInsideCodeBlock=!1,this.renderTimeout=null,this.debounceDelay=40,this.isFinished=!1,!this.contentDiv)throw new Error("Target content element for rendering not found.")}streamChunk=t=>{this.isFinished||(this.accumulatedMarkdown+=t,clearTimeout(this.renderTimeout),this.renderTimeout=setTimeout(this.render,this.debounceDelay))};render=()=>{if(!this.isFinished)try{if((this.accumulatedMarkdown.match(/```/g)||[]).length%2===1){const n=this.accumulatedMarkdown.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.contentDiv.innerHTML=`<pre class="streaming-code-preview">${n}</pre>`}else this.contentDiv.innerHTML=marked.parse(this.accumulatedMarkdown,{gfm:!0,breaks:!1})}catch{this.contentDiv.textContent=this.accumulatedMarkdown}};getFinalContent(){return this.isFinished=!0,clearTimeout(this.renderTimeout),this.accumulatedMarkdown}}function Se(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function Re(e){const t=document.getElementById("preset-selector"),n=document.getElementById("preset-name-input"),s=t.value,o=n.value.trim();if(!o){w("Preset name cannot be empty.","Error");return}if(e.size===0){w("Please select at least one model for the preset.","Error");return}const a=o.toLowerCase().replace(/\s+/g,"_"),r=V();s!=="--new--"&&s!==a&&delete r[s],r[a]={name:o,modelIds:Array.from(e)},me(r),w(`User Preset "${o}" saved successfully!`,"Success"),i.bus.publish("user:presetsChanged")}function je(){const e=document.getElementById("preset-selector"),t=e.value;if(t==="--new--"){w("No preset selected to delete.","Info");return}if(confirm(`Are you sure you want to delete your preset "${e.options[e.selectedIndex].text}"?`)){const n=V();delete n[t],me(n),w("User Preset deleted.","Success"),i.bus.publish("user:presetsChanged")}}let k=new Set;function ne(){const e=document.getElementById("model-master-list"),t=document.getElementById("model-search-input"),n=document.getElementById("filter-selected-toggle");if(!e||!t||!n)return;let s=x();const o=t.value.toLowerCase();n.checked&&(s=s.filter(r=>k.has(r.id))),o&&(s=s.filter(r=>r.name.toLowerCase().includes(o)||r.id.toLowerCase().includes(o))),e.innerHTML="",s.forEach((r,c)=>{const l=k.has(r.id),d=document.createElement("div");d.className="model-manager-item",d.innerHTML=`
            <input type="checkbox" id="user-model-cb-${r.id}" data-model-id="${r.id}" ${l?"checked":""}>
            <label for="user-model-cb-${r.id}">
                ${r.name} &nbsp;•&nbsp; <small>${r.id}</small>
            </label>
            <button class="btn-icon model-info-btn" data-model-id="${r.id}" title="Model Info">
                <span class="material-symbols-outlined">info</span>
            </button>
        `,e.appendChild(d)})}function se(e=null){const t=document.getElementById("model-info-bar");if(!t)return;if(!e){t.classList.add("hidden");return}document.getElementById("info-bar-name").textContent=e.name,document.getElementById("info-bar-description").textContent=e.description||"No description available.",document.getElementById("info-bar-context").textContent=`${(e.context_length||0).toLocaleString()} tokens`;const n=document.getElementById("info-bar-prompt-price"),s=document.getElementById("info-bar-completion-price");n&&(n.closest("span").style.display="none"),s&&(s.closest("span").style.display="none"),t.classList.remove("hidden")}function Y(){const e=document.getElementById("preset-included-list");if(!e)return;const t=x();e.innerHTML="";const n=document.createElement("div");if(n.className="included-models-count",n.textContent=`Included: ${k.size} models`,e.appendChild(n),k.size===0){e.innerHTML+='<p class="no-items-message">Select models from the list.</p>';return}t.forEach(s=>{if(k.has(s.id)){const o=document.createElement("div");o.className="model-manager-item",o.innerHTML=`<label>${s.name} &nbsp;•&nbsp; <small>${s.id}</small></label>`,e.appendChild(o)}})}function W(){const e=document.getElementById("preset-selector"),t=document.getElementById("preset-name-input");if(!e||!t)return;const n=V(),s=e.value;e.innerHTML='<option value="--new--">-- Create New Preset --</option>';for(const a in n)e.add(new Option(n[a].name,a));n[s]&&(e.value=s);const o=e.value;o==="--new--"?(t.value="",k.clear()):n[o]&&(t.value=n[o].name,k=new Set(n[o].modelIds)),ne(),Y(),se(null)}function Ot(){const e=document.querySelector('.tab-btn[data-tab="models"]'),t=document.getElementById("preset-selector"),n=document.getElementById("model-search-input"),s=document.getElementById("filter-selected-toggle"),o=document.getElementById("select-all-btn"),a=document.getElementById("deselect-all-btn"),r=document.getElementById("save-preset-btn"),c=document.getElementById("delete-preset-btn"),l=document.getElementById("model-master-list"),d=document.getElementById("info-bar-close-btn");e?.addEventListener("click",W),t?.addEventListener("change",W),n?.addEventListener("input",ne),s?.addEventListener("change",ne),d?.addEventListener("click",()=>se(null)),o?.addEventListener("click",()=>{l.querySelectorAll('input[type="checkbox"]').forEach(g=>{g.checked||(g.checked=!0,k.add(g.dataset.modelId))}),Y()}),a?.addEventListener("click",()=>{l.querySelectorAll('input[type="checkbox"]').forEach(g=>{g.checked&&(g.checked=!1,k.delete(g.dataset.modelId))}),Y()}),r?.addEventListener("click",()=>Re(k)),c?.addEventListener("click",je),l?.addEventListener("click",g=>{const u=g.target.closest('input[type="checkbox"]'),f=g.target.closest(".model-info-btn");if(u){const m=u.dataset.modelId;u.checked?k.add(m):k.delete(m),Y()}if(f){const m=f.dataset.modelId,h=x().find(y=>y.id===m);h&&se(h)}}),i.bus.subscribe("user:settingsUpdated",()=>{document.getElementById("settings-modal")?.style.display==="flex"&&document.querySelector('.tab-btn[data-tab="models"]')?.classList.contains("active")&&W()})}function qe(){const e=document.getElementById("settings-modal");if(!e)return;const t=e.querySelector(".tab-buttons"),n=e.querySelectorAll(".tab-content"),s=document.getElementById("settings-mobile-menu-trigger"),o=e.querySelector(".mobile-menu-popup");console.log("--- 1. initTabs: Finding elements ---"),console.log("Mobile Trigger Button:",s),console.log("Mobile Popup Container:",o),console.log("Tab Buttons inside Popup:",o?.querySelector(".tab-buttons")),s?.addEventListener("click",a=>{a.stopPropagation();const r=e.querySelector(".mobile-menu-popup");r?r.classList.toggle("is-open"):console.error("Could not find '.mobile-menu-popup' inside the settings modal on click.")}),t?.addEventListener("click",a=>{const r=a.target.closest(".tab-btn");if(!r)return;const c=r.dataset.tab;t.querySelectorAll(".tab-btn").forEach(g=>g.classList.remove("active")),r.classList.add("active"),n.forEach(g=>{g.classList.toggle("active",g.dataset.tabContent===c)});const l=document.getElementById("settings-current-tab-name"),d=s.querySelector(".material-symbols-outlined");if(l&&d){const g=r.querySelector(".material-symbols-outlined").textContent,u=r.querySelector(".tab-btn-text");u&&(l.textContent=u.textContent.trim()),g&&(d.textContent=g)}o?.classList.remove("is-open")}),document.addEventListener("click",a=>{o?.classList.contains("is-open")&&!o.contains(a.target)&&!s.contains(a.target)&&o.classList.remove("is-open")})}function O(){const e=I(),t=i.getProject();if(!t||!t.globalSettings)return;const n=document.getElementById("api-key-group"),s=document.getElementById("ollama-url-group"),o=document.getElementById("load-models-btn");e.plan==="master"?(n.style.display="block",s.style.display="block",o&&(o.style.display="inline-block"),document.getElementById("apiKey").value=e.apiSettings?.openrouterKey||"",document.getElementById("ollamaBaseUrl").value=e.apiSettings?.ollamaBaseUrl||""):(n.style.display="none",s.style.display="none",o&&(o.style.display="none"));const a=t.globalSettings.systemUtilityAgent||{};document.getElementById("system-utility-prompt").value=a.systemPrompt||"",x(),gt("settings-system-model-wrapper",a.model,x()),document.getElementById("system-utility-prompt").value=a.systemPrompt||"";const r=document.getElementById("system-utility-temperature"),c=document.getElementById("system-utility-topP");r&&(r.value=a.temperature??1),c&&(c.value=a.topP??1),W()}function He(){O(),ct()}function Rt(){qe();const e=i.bus;document.getElementById("load-models-btn")?.addEventListener("click",()=>{if(I().plan==="master"){const s=document.getElementById("apiKey").value,o=document.getElementById("ollamaBaseUrl").value;e.publish("api:loadUserModels",{apiKey:s,ollamaBaseUrl:o,isUserKey:!0})}}),document.getElementById("apiKey")?.addEventListener("input",te(n=>{const s=I();s&&s.plan==="master"&&(s.apiSettings.openrouterKey=n.target.value,J(s))},500)),e.subscribe("user:modelsLoaded",()=>{document.getElementById("settings-modal")?.style.display==="flex"&&O()}),document.getElementById("ollamaBaseUrl")?.addEventListener("input",te(n=>e.publish("settings:ollamaUrlChanged",n.target.value),500)),["system-utility-model-select","system-utility-prompt","system-utility-temperature","system-utility-topP"].forEach(n=>{document.getElementById(n)?.addEventListener("change",()=>e.publish("settings:systemAgentChanged"))}),document.querySelector("#settings-panel .modal-close-btn")?.addEventListener("click",lt),i.bus.subscribe("project:loaded",()=>{console.log("Project loaded. Re-rendering settings panel data."),O()}),i.bus.subscribe("models:loaded",()=>{const n=document.getElementById("settings-modal");n&&n.style.display==="flex"&&O()}),i.bus.subscribe("app:settingsChanged",()=>{const n=document.getElementById("settings-modal");n&&n.style.display==="flex"&&O()}),console.log("✅ Settings UI Initialized.")}let C;function Je(){return C}async function jt(e){return C&&C.name===`${ee}${e}`?Promise.resolve(C):(C&&(C.close(),C=null),new Promise((t,n)=>{const s=indexedDB.open(`${ee}${e}`,5);s.onupgradeneeded=o=>{const a=o.target.result;a.objectStoreNames.contains(G)||a.createObjectStore(G,{keyPath:"id"}),a.objectStoreNames.contains(fe)||a.createObjectStore(fe,{keyPath:"id"})},s.onsuccess=o=>{C=o.target.result,console.log(`IndexedDB '${C.name}' opened successfully.`),t(C)},s.onerror=o=>{console.error("IndexedDB error:",o.target.error),n(o.target.error)}}))}async function ve(e,t,n,s){return new Promise((o,a)=>{if(!C)return console.error("dbRequest called before DB was opened."),a("Database is not open.");try{const l=C.transaction(e,t).objectStore(e)[n](s);l.onsuccess=d=>o(d.target.result||(n==="getAll"?[]:null)),l.onerror=d=>a(d.target.error)}catch(r){console.error(`Error performing dbRequest (${n} on ${e}):`,r),a(r)}})}async function qt(e){return new Promise((t,n)=>{if(!C)return n("Database is not open.");try{const s=C.transaction(e,"readwrite");s.oncomplete=()=>{console.log(`Stores cleared: ${e.join(", ")}`),t()},s.onerror=o=>n(s.error),e.forEach(o=>{C.objectStoreNames.contains(o)&&s.objectStore(o).clear()})}catch(s){n(s)}})}async function Ht(e){const t=`${ee}${e}`,n=Je();return n&&n.name===t&&n.close(),new Promise((s,o)=>{console.log(`[DB] Attempting to delete database: ${t}`);const a=indexedDB.deleteDatabase(t);a.onsuccess=()=>{console.log("[DB] Successfully deleted database."),s()},a.onerror=r=>{console.error("[DB] Error deleting database:",r.target.error),o(r.target.error)},a.onblocked=()=>{console.warn("[DB] Database delete was blocked. Please reload the application."),showCustomAlert("Could not clear old project data because a connection is still open. Please reload the page and try again.","Error"),o("Database blocked")}})}function Ke(e){e.querySelectorAll("pre > code").forEach(t=>{if(t.dataset.enhanced==="true")return;const n=t.parentNode,s=document.createElement("div");s.className="code-block-wrapper",n.parentNode.replaceChild(s,n);const o=document.createElement("div");o.className="code-block-header";const a=Array.from(t.classList).find(d=>d.startsWith("language-")),r=a?a.replace("language-",""):"text",c=document.createElement("span");c.className="language-name",c.textContent=r,o.appendChild(c);const l=document.createElement("button");l.className="copy-code-btn",l.innerHTML='<span class="material-symbols-outlined">content_copy</span> Copy',o.appendChild(l),l.addEventListener("click",()=>{navigator.clipboard.writeText(t.textContent).then(()=>{l.innerHTML='<span class="material-symbols-outlined">check</span> Copied!',setTimeout(()=>{l.innerHTML='<span class="material-symbols-outlined">content_copy</span> Copy'},2e3)})}),s.appendChild(o),s.appendChild(n),window.hljs&&hljs.highlightElement(t),t.dataset.enhanced="true"})}function he(e){if(!e)return"";const t=new Date,n=new Date(e),s=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1);return n>=s?n.toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit",hour12:!1}):n>=o?"Yesterday":n.toLocaleDateString("th-TH",{day:"2-digit",month:"2-digit",year:"numeric"})}function Ee(e,t,n){const{role:s,content:o,speaker:a,isLoading:r,isError:c,isSummary:l}=e,d=i.getProject(),g=document.createElement("div");g.className=`message-turn-wrapper ${s}-turn`,g.dataset.index=t,g.dataset.messageId=e.id||`msg_idx_${t}`;const u=document.createElement("div");if(u.className=`message ${s}`,c&&u.classList.add("error"),l&&u.classList.add("system-summary-message"),s==="assistant"&&a){const f=d.agentPresets?.[a],m=f?f.icon:"🤖",p=document.createElement("div");p.className="speaker-label-wrapper";const h=document.createElement("span");if(h.className="speaker-label",h.innerHTML=`${m} ${a}`,e.timestamp){const y=document.createElement("span");y.className="message-timestamp",y.innerHTML=`&nbsp;• ${he(e.timestamp)}`,h.appendChild(y)}p.appendChild(h),g.appendChild(p)}else if(s==="user"&&e.timestamp){const f=document.createElement("span");f.className="message-timestamp",f.textContent=he(e.timestamp),g.appendChild(f)}if(e.isSummaryMarker||e.isSummary){u.classList.add("summary-marker");const f=document.createElement("span");f.textContent=e.content;const m=document.createElement("div");m.className="summary-marker-actions";const p=document.createElement("button");p.className="btn-icon small",p.title="Edit this Summary",p.innerHTML='<span class="material-symbols-outlined">edit_note</span>';const h=e.summaryLogId||n.summaryState?.activeSummaryId;h&&(p.onclick=()=>i.bus.publish("summary:editFromChat",{logId:h}));const y=document.createElement("button");y.className="btn-icon small danger",y.title="Remove Marker from Chat",y.innerHTML='<span class="material-symbols-outlined">delete</span>',y.onclick=()=>i.bus.publish("chat:clearSummaryContext",{index:t}),m.append(p,y),u.append(f,m)}else if(s==="system"){const f=document.createElement("div");f.className="message-content",f.textContent=e.content,u.appendChild(f);const m=document.createElement("div");m.className="message-actions";const p=document.createElement("button");p.innerHTML='<span class="material-symbols-outlined" style="font-size: 18px;">delete_forever</span>',p.title="Delete",p.onclick=h=>i.bus.publish("chat:deleteMessage",{index:t,event:h}),m.appendChild(p),u.appendChild(m)}else{const f=document.createElement("div");f.className="message-content",u.appendChild(f);const m=document.createElement("span");if(m.className="streaming-content",r)m.innerHTML='<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';else try{if(s==="assistant")m.innerHTML=marked.parse(o||"",{gfm:!0,breaks:!1}),Ke(m);else if(s==="user"){if(Array.isArray(o))o.forEach(p=>{if(p.type==="text"&&p.text){const h=document.createElement("p");h.textContent=p.text,m.appendChild(h)}else if(p.type==="image_url"&&p.url){const h=document.createElement("img");h.src=p.url,h.className="multimodal-image",m.appendChild(h)}});else if(typeof o=="string"){const p=document.createElement("p");p.textContent=o,m.appendChild(p)}}}catch(p){console.error("Content rendering failed:",p),m.textContent="Error displaying content"}if(f.appendChild(m),r||c){const p=document.createElement("div");p.className="message-actions";const h='style="font-size: 18px;"',y=document.createElement("button");y.innerHTML=`<span class="material-symbols-outlined" ${h}>delete_forever</span>`,y.title="Delete Incomplete Message",y.onclick=L=>i.bus.publish("chat:deleteMessage",{index:t,event:L}),p.appendChild(y),u.appendChild(p)}else if(!r&&!c){const p=document.createElement("div");p.className="message-actions";const h='style="font-size: 18px;"',y=document.createElement("button");y.innerHTML=`<span class="material-symbols-outlined" ${h}>edit</span>`,y.title="Edit",y.onclick=b=>i.bus.publish("chat:editMessage",{index:t,event:b}),p.appendChild(y);const L=document.createElement("button");if(L.innerHTML=`<span class="material-symbols-outlined" ${h}>content_copy</span>`,L.title="Copy",L.onclick=b=>i.bus.publish("chat:copyMessage",{index:t,event:b}),p.appendChild(L),s==="assistant"){const b=document.createElement("button");b.innerHTML=`<span class="material-symbols-outlined" ${h}>refresh</span>`,b.title="Regenerate",b.onclick=N=>i.bus.publish("chat:regenerateMessage",{index:t,event:N}),p.appendChild(b)}const E=document.createElement("button");E.innerHTML=`<span class="material-symbols-outlined" ${h}>delete_forever</span>`,E.title="Delete",E.onclick=b=>i.bus.publish("chat:deleteMessage",{index:t,event:b}),p.appendChild(E),u.appendChild(p)}}return g.appendChild(u),g}function U(){const e=i.getProject(),t=e.chatSessions.find(s=>s.id===e.activeSessionId);if(!t){console.error("[UI] renderMessages: No active session found!");return}const n=document.getElementById("chatMessages");if(!n){console.error("[UI] renderMessages: Chat container not found!");return}n.innerHTML="",t.history&&t.history.length>0&&t.history.forEach((s,o)=>{const a=Ee(s,o,t);n.appendChild(a)}),Ye()}function Ye(){const e=document.getElementById("chatMessages");e&&(e.scrollTop=e.scrollHeight)}function Jt(){document.getElementById("chatMessages").innerHTML="",we("AI Assistant")}function we(e){document.getElementById("chat-title").textContent=e||"AI Assistant"}function We(e){const t=document.getElementById("file-preview-container");t.classList.toggle("hidden",!e||e.length===0),t.innerHTML="",!(!e||e.length===0)&&e.forEach((n,s)=>{const o=document.createElement("div");o.className="file-preview-item";let a="";n.type.startsWith("image/")?a=`<img src="${n.data||""}" class="file-preview-thumbnail" alt="${n.name}">`:a='<div class="file-preview-thumbnail file-icon">📄</div>',o.innerHTML=`${a}<span class="file-preview-name">${n.name}</span><button class="remove-file-btn" data-action="chat:removeFile" data-index="${s}">&times;</button>`,t.appendChild(o)})}function ze(){const{finalSystemPrompt:e,totalTokens:t,agentNameForDisplay:n,model:s}=re();document.getElementById("inspector-agent-name").textContent=n,document.getElementById("inspector-agent-model").textContent=s,document.getElementById("inspector-token-count").textContent=`~${t.toLocaleString()}`,document.getElementById("inspector-system-prompt").textContent=e||"(No system prompt or memories active)",document.getElementById("context-inspector-modal").style.display="flex"}function Ge(){document.getElementById("context-inspector-modal").style.display="none"}function Qe(){const e=document.getElementById("chat-actions-container"),t=document.getElementById("chat-actions-btn"),n=document.getElementById("chat-actions-menu");!e||!t||!n||(t.addEventListener("click",s=>{s.stopPropagation(),n.innerHTML="",n.innerHTML=`
            <a href="#" data-action="open-composer"><span class="material-symbols-outlined">edit_square</span> Composer</a>
            <a href="#" data-action="chat:summarize"><span class="material-symbols-outlined">psychology</span> Summarize</a>
            <a href="#" data-action="upload-file"><span class="material-symbols-outlined">attach_file</span> Upload files</a>
        `;const o=i.getProject(),a=o.chatSessions.find(r=>r.id===o.activeSessionId);a&&a.summaryState?.activeSummaryId&&(n.innerHTML+=`
                <div class="dropdown-divider"></div>
                <a href="#" data-action="chat:clearSummary" class="is-destructive"><span class="material-symbols-outlined">layers_clear</span> Clear Summary Context</a>
            `),e.classList.toggle("open")}),n.addEventListener("click",s=>{const o=s.target.closest("[data-action]");if(o){switch(s.preventDefault(),o.dataset.action){case"open-composer":i.bus.publish("ui:toggleComposer");break;case"chat:summarize":i.bus.publish("chat:summarize");break;case"upload-file":document.getElementById("file-input")?.click();break;case"chat:clearSummary":i.bus.publish("chat:clearSummaryContext",{index:-1});break}e.classList.remove("open")}}),document.addEventListener("click",s=>{e.classList.contains("open")&&!e.contains(s.target)&&e.classList.remove("open")}))}function F(){const{totalTokens:e,agent:t,agentNameForDisplay:n}=re(),s=x(),o=document.getElementById("model-count-status"),a=document.getElementById("active-agent-status"),r=document.getElementById("token-count-status");o&&(o.textContent=`${s.length} Models`),a&&(a.textContent=`Active: ${t.icon||""} ${n}`),r&&(r.textContent=`~${e.toLocaleString()} Tokens`)}function Ve(){const e=document.getElementById("dropzone-overlay");if(!e)return;let t=0;const n=window,s=()=>{e.classList.add("active")},o=()=>{e.classList.remove("active")};n.addEventListener("dragenter",a=>{a.preventDefault(),a.stopPropagation(),t===0&&s(),t++}),n.addEventListener("dragover",a=>{a.preventDefault(),a.stopPropagation()}),n.addEventListener("dragleave",a=>{a.preventDefault(),a.stopPropagation(),t--,t===0&&o()}),n.addEventListener("drop",a=>{a.preventDefault(),a.stopPropagation(),t=0,o();const r=a.dataTransfer.files;r&&r.length>0&&i.bus.publish("chat:filesSelected",r)})}function Kt(){const e=document.getElementById("chatInput"),t=document.getElementById("file-input"),n=document.getElementById("file-preview-container");if(e){e.addEventListener("keydown",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),i.bus.publish("chat:sendMessage"))});const o=te(()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px",A()},500);e.addEventListener("input",o)}e.addEventListener("dragover",o=>{o.preventDefault()}),e.addEventListener("drop",o=>{o.preventDefault()}),document.getElementById("sendBtn")?.addEventListener("click",()=>i.bus.publish("chat:sendMessage")),document.getElementById("stopBtn")?.addEventListener("click",()=>i.bus.publish("chat:stopGeneration")),document.getElementById("context-inspector-trigger-btn")?.addEventListener("click",ze),document.querySelector("#context-inspector-modal .btn-secondary")?.addEventListener("click",Ge),t&&t.addEventListener("change",o=>{i.bus.publish("chat:filesSelected",o.target.files)}),n&&n.addEventListener("click",o=>{if(o.target.matches(".remove-file-btn")){const a=parseInt(o.target.dataset.index,10);i.bus.publish("chat:removeFile",{index:a})}}),Qe(),i.bus.subscribe("session:loaded",F),i.bus.subscribe("entity:selected",F),i.bus.subscribe("user:settingsUpdated",F),i.bus.subscribe("user:modelsLoaded",F),F(),i.bus.subscribe("ui:renderMessages",U),i.bus.subscribe("ui:renderFilePreviews",({files:o})=>We(o)),i.bus.subscribe("ui:updateChatTitle",({title:o})=>we(o)),i.bus.subscribe("ui:toggleLoading",({isLoading:o})=>{document.getElementById("sendBtn")?.classList.toggle("hidden",o),document.getElementById("stopBtn")?.classList.toggle("hidden",!o)}),document.getElementById("agent-selector-bar")?.addEventListener("click",o=>{const a=o.target.closest(".agent-select-btn");a&&i.bus.publish("group:manualSelectAgent",{agentName:a.dataset.agentName})}),i.bus.subscribe("ui:renderAgentSelector",Ze),Ve(),console.log("✅ Chat UI Initialized.")}function Yt(){const e=document.getElementById("toggle-right-sidebar-btn"),t=document.getElementById("studio-panel"),n=document.getElementById("right-sidebar-overlay"),s=document.querySelector(".app-wrapper");!e||!t||(e.addEventListener("click",()=>{window.innerWidth<=900?(t.classList.add("open"),n?.classList.add("active"),document.body.style.overflow="hidden"):(t.classList.toggle("collapsed"),s?.classList.toggle("with-right-collapsed",t.classList.contains("collapsed")))}),n?.addEventListener("click",()=>{t.classList.remove("open"),n.classList.remove("active"),document.body.style.overflow=""}),window.addEventListener("resize",()=>{window.innerWidth>900&&(t.classList.remove("open"),n?.classList.remove("active"),document.body.style.overflow="")}))}function Xe(e){const t=document.querySelector(`.message-turn-wrapper[data-message-id='${e.id}']`);if(!t){console.warn(`finalizeMessageBubble: Could not find bubble with ID ${e.id}. Forcing a full re-render.`),U();return}const n=Ee(e,parseInt(t.dataset.index),null);t.parentNode.replaceChild(n,t)}function Ze(){const e=i.getProject(),t=e.chatSessions.find(a=>a.id===e.activeSessionId),n=document.getElementById("agent-selector-bar");if(!n||!t||!e.activeEntity||e.activeEntity.type!=="group"){n?.classList.add("hidden");return}const s=e.agentGroups[e.activeEntity.name],o=t.groupChatState?.awaitsUserInput&&s?.flowType==="manual";n.innerHTML="",n.classList.toggle("hidden",!o),o&&(s.agents||[]).filter(r=>r!==s.moderatorAgent).forEach(r=>{const c=document.createElement("button");c.className="agent-select-btn",c.textContent=e.agentPresets[r]?.icon||"🤖",c.title=r,c.dataset.agentName=r,n.appendChild(c)})}async function ae(e,t,n){t.groupChatState={isRunning:!0,awaitsUserInput:!1,turnQueue:[],currentJob:null,error:null},i.bus.publish("ui:toggleLoading",{isLoading:!0}),n.flowType!=="manual"?(et(t,n),await tt(e,t,n)):(t.groupChatState.awaitsUserInput=!0,i.bus.publish("ui:renderAgentSelector"),i.bus.publish("status:update",{message:"Please select the next agent to speak.",state:"connected"}),i.bus.publish("ui:toggleLoading",{isLoading:!1}))}function et(e,t){if(t.flowType==="round-robin"){const n=(t.agents||[]).filter(s=>s!==t.moderatorAgent);for(let s=0;s<(t.maxTurns||1);s++)n.forEach(o=>e.groupChatState.turnQueue.push({type:"agent_turn",agentName:o}))}else t.flowType==="auto-moderator"&&e.groupChatState.turnQueue.push({type:"moderator_turn",agentName:t.moderatorAgent,turnNumber:1})}async function tt(e,t,n){for(t.groupChatState.isRunning=!0;t.groupChatState.isRunning&&t.groupChatState.turnQueue.length>0;){const s=t.groupChatState.turnQueue.shift();t.groupChatState.currentJob=s;try{await nt(e,t,n,s)}catch(o){o.name==="AbortError"?console.log("Group chat job aborted."):(console.error("Error in group chat job:",o),t.groupChatState.error=o.message,w(`Group Chat Error: ${o.message}`,"Error")),t.groupChatState.isRunning=!1}finally{t.groupChatState.currentJob=null}}t.groupChatState.isRunning=!1,n.flowType==="manual"?(t.groupChatState.awaitsUserInput=!0,i.bus.publish("ui:renderAgentSelector"),i.bus.publish("status:update",{message:"Please select the next agent.",state:"connected"})):(i.bus.publish("ui:toggleLoading",{isLoading:!1}),i.bus.publish("status:update",{message:"Group chat finished.",state:"connected"}))}async function nt(e,t,n,s){if(s.type==="agent_turn")await ot(e,t,s.agentName);else if(s.type==="moderator_turn"){const o=await st(e,t,n,s);if(o){t.groupChatState.turnQueue.unshift({type:"agent_turn",agentName:o});const a=n.maxTurns||1;s.turnNumber<a&&t.groupChatState.turnQueue.push({...s,turnNumber:s.turnNumber+1})}}}async function st(e,t,n,s){const o=e.agentPresets[s.agentName];if(!o)throw new Error(`Moderator agent '${s.agentName}' not found.`);i.bus.publish("status:update",{message:`Moderator '${s.agentName}' is deciding...`,state:"loading"});const a=t.history.map(g=>`${g.speaker||g.role}: ${g.content}`).join(`
`),c=`Based on the conversation, choose the single best agent to speak next from this list: [${n.agents.filter(g=>g!==n.moderatorAgent).join(", ")}]. Respond with ONLY the agent's name. If no one needs to speak, respond with "DONE".

Conversation:
${a}`,l=await Fe(o,[{role:"user",content:c}]),d=n.agents.find(g=>l.content.includes(g));return d&&(t.history.push({role:"system",content:`[Moderator selected ${d} to speak.]`}),i.bus.publish("ui:renderMessages")),d}async function ot(e,t,n){const s=e.agentPresets[n];if(!s||!s.model)throw new Error(`Agent '${n}' has no model configured.`);i.bus.publish("status:update",{message:`Thinking as ${n}...`,state:"loading"});const o={id:Se(),role:"assistant",content:"",speaker:n,isLoading:!0};t.history.push(o);const a=t.history.length-1;U(),await new Promise(d=>setTimeout(d,50));const r=document.querySelector(`.message-turn-wrapper[data-message-id='${o.id}']`);if(!r)throw t.history.pop(),new Error(`Could not find UI placeholder for agent ${n}.`);const c=new be(r),l=$e(t.history.slice(0,-1),n);try{const d=await _e(s,l,c.streamChunk),g=c.getFinalContent(),u={...o,content:g,isLoading:!1,timestamp:Date.now()};t.history[a]=u,i.updateAndPersistState()}catch(d){d.name!=="AbortError"?(console.error(`Error during ${n}'s turn:`,d),t.history[a]={...o,content:`Error: ${d.message}`,isLoading:!1,isError:!0}):t.history.splice(a,1),i.updateAndPersistState()}finally{U()}}let M=[];function Wt(){new TurndownService({headingStyle:"atx",codeBlockStyle:"fenced"});const e=document.getElementById("chatMessages");if(!e)return;const t=s=>{const o=s.closest(".message.assistant");if(!o)return;const a=o.querySelector(".message-content");if(a){const r=a.cloneNode(!0);r.querySelectorAll(".code-block-wrapper").forEach(c=>{const l=c.querySelector("pre");l&&c.parentNode.replaceChild(l,c)}),i.bus.publish("composer:append",{content:r.innerHTML}),o.classList.add("sent-to-composer-feedback"),setTimeout(()=>{o.classList.remove("sent-to-composer-feedback")},500)}},n=(s,o)=>{s.type==="contextmenu"&&s.preventDefault();const a=window.getSelection(),r=a.toString().trim(),c=r&&a.containsNode(o,!0),l=[{label:"Send to Composer",action:()=>t(s.target)}];c&&l.push({label:"Send Selection to Composer",action:()=>{i.bus.publish("composer:append",{content:r})}}),pt(l,s)};e.addEventListener("contextmenu",s=>{if(s.shiftKey)return;const o=s.target.closest(".message.assistant");o&&(s.preventDefault(),n(s,o))}),e.addEventListener("dblclick",s=>{const o=s.target.closest(".message.assistant");o&&n(s,o)})}function R(e){return typeof e!="string"||!e?0:Math.round(e.length/4)}function re(){const e=i.getProject();if(!e||!e.chatSessions||!e.activeSessionId)return{finalSystemPrompt:"",totalTokens:0,agent:{},agentNameForDisplay:"N/A",model:"N/A"};const t=e.chatSessions.find(d=>d.id===e.activeSessionId);if(!t||!e.activeEntity)return{finalSystemPrompt:"",totalTokens:0,agent:{},agentNameForDisplay:"N/A",model:"N/A"};let n="N/A",s={};if(e.activeEntity.type==="group"&&t.groupChatState?.isRunning&&t.groupChatState.currentJob)n=t.groupChatState.currentJob.agentName,s=e.agentPresets[n]||{};else if(n=e.activeEntity.name,e.activeEntity.type==="agent")s=e.agentPresets[n]||{};else if(e.activeEntity.type==="group"){const d=e.agentGroups[n];n=`Group: ${n} (Moderator)`,s=e.agentPresets[d?.moderatorAgent]||{}}const o=Ne(s.name||n.replace("Group: ","").replace(" (Moderator)","")),a=R(JSON.stringify(t.history||[])),r=R(document.getElementById("chatInput")?.value||""),l=R(o)+a+r;return{finalSystemPrompt:o,totalTokens:l,agent:s,agentNameForDisplay:n,model:s.model||"N/A"}}async function at(){if(i.isLoading())return;i.newAbortController();const e=i.getProject(),t=document.getElementById("chatInput");let n=t.value.trim();if(!n&&M.length===0)return;const s=I();if(s.planStatus==="expired"){w("Your account is suspended. Please refill your credits to continue.","Account Suspended");return}if(s.credits.current<=0&&(s.plan==="free"||s.plan==="pro"&&s.planStatus==="active"))if(s.plan==="pro"){Me();return}else{w("Your trial credits have run out.","Credits Depleted");return}if(!e.activeEntity?.name){w("Please select an Agent or Group.","Error");return}const o=e.chatSessions.find(a=>a.id===e.activeSessionId);if(o){i.bus.publish("ui:toggleLoading",{isLoading:!0}),i.bus.publish("status:update",{message:"Processing images...",state:"loading"});try{const a=[],r=/(https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp|bmp))/gi,c=n.match(r)||[],l=n.replace(r,"").trim();l&&a.push({type:"text",text:l}),(await Promise.all(c.map(m=>it(encodeURI(m))))).forEach(m=>{a.push({type:"image_url",url:m})}),M.length>0&&M.forEach(m=>{a.push({type:"image_url",url:m.data})});const g=a.some(m=>m.type==="image_url"),u=a.some(m=>m.type==="text");g&&!u&&a.unshift({type:"text",text:""});const f={role:"user",content:a,speaker:"You",timestamp:Date.now()};if(o.history.push(f),o.name==="New Chat"&&o.history.length===1&&rt(o),t.value="",t.style.height="auto",M=[],i.bus.publish("ui:renderFilePreviews",{files:M}),i.bus.publish("ui:renderMessages"),i.updateAndPersistState(),e.activeEntity.type==="agent")await ie();else{const m=e.agentGroups[e.activeEntity.name];await ae(e,o,m)}}catch(a){console.error("Error during sendMessage (Image Processing):",a);const r="Image Could Not Be Processed",c="For best results, please save the image to your device and use the '+' button to upload it directly.",l=`Details: ${a.message}`,d=`${c}

---
${l}`;w(d,r),M=[],i.bus.publish("ui:renderFilePreviews",{files:M}),i.bus.publish("ui:toggleLoading",{isLoading:!1}),i.bus.publish("status:update",{message:"Image processing failed",state:"error"})}}}async function ie(){const e=i.getProject(),t=e.chatSessions.find(c=>c.id===e.activeSessionId);if(!t||e.activeEntity.type!=="agent")return;const n=e.activeEntity.name,s=e.agentPresets[n];i.bus.publish("status:update",{message:`Responding with ${s.model}...`,state:"loading"}),i.bus.publish("ui:toggleLoading",{isLoading:!0});const o={id:Se(),role:"assistant",content:"",speaker:n,isLoading:!0};t.history.push(o),U();const a=document.querySelector(`.message-turn-wrapper[data-message-id='${o.id}']`);let r;if(!a){console.error("Could not find placeholderElement in the DOM immediately after render."),i.bus.publish("ui:toggleLoading",{isLoading:!1});return}try{r=new be(a)}catch(c){console.error("UI Error creating LiveMarkdownRenderer:",c.message),i.bus.publish("ui:toggleLoading",{isLoading:!1}),t.history.pop();return}try{const c=$e(t.history.slice(0,-1),n),l=await _e(s,c,r.streamChunk),d=Dt(s.model,l.usage),g=I();if(g&&g.plan!=="master"){const p={timestamp:Date.now(),model:s.model,promptTokens:l.usage.prompt_tokens||0,completionTokens:l.usage.completion_tokens||0,costUSD:d,duration:l.duration||0,usageIsEstimated:l.usageIsEstimated};Te(g.userId,p)}Ae(d),de(l.usage,s.model,d);const u=r.getFinalContent(),f={...o,content:u,speaker:n,isLoading:!1,timestamp:Date.now(),stats:{...l.usage,duration:l.duration,speed:l.usage.completion_tokens/(l.duration||1)}},m=t.history.findIndex(p=>p.id===o.id);m>-1&&(t.history[m]=f),Xe(f)}catch(c){if(c.name!=="AbortError"){const l=`Error: ${c.message}`;console.error("LLM Stream Error:",c),t.history[assistantMsgIndex]={...o,content:l,isLoading:!1,isError:!0},i.bus.publish("status:update",{message:"An error occurred.",state:"error"})}else t.history.splice(assistantMsgIndex,1),console.log("Stream aborted by user.")}finally{if(i.getState().abortController?.signal.aborted){console.log("Stream was manually aborted. UI state is handled by stopGeneration().");return}i.bus.publish("ui:toggleLoading",{isLoading:!1}),await ve(G,"readwrite","put",t),i.getState().abortController?.signal.aborted||i.bus.publish("status:update",{message:"Ready",state:"connected"})}}function Ie(){console.log("STOP button pressed. Aborting current request..."),i.abort(),i.setLoading(!1),i.bus.publish("ui:toggleLoading",{isLoading:!1})}window.ChatHandlers={sendMessage:at,stopGeneration:Ie};function zt({index:e}){M&&M[e]!==void 0&&(M.splice(e,1),i.bus.publish("ui:renderFilePreviews",{files:M}))}function Gt(e){if(e)for(const t of e){if(!t.type.startsWith("image/")){w(`File type not supported: ${t.type}. Please upload images only.`,"Unsupported File");continue}const n=`file_${Date.now()}_${Math.random()}`,s={id:n,name:t.name,type:t.type,data:null};M.push(s);const o=new FileReader;o.onload=a=>{const r=M.findIndex(c=>c.id===n);r!==-1&&(M[r].data=a.target.result,i.bus.publish("ui:renderFilePreviews",{files:M}))},o.readAsDataURL(t)}}async function Qt(e){const t=i.getProject(),n=t.chatSessions.find(a=>a.id===t.activeSessionId),s=t.summaryLogs.find(a=>a.id===e);if(!n||!s)return;n.summaryState.activeSummaryId=s.id,n.summaryState.summarizedUntilIndex=n.history.length;const o={role:"system",content:`[ System: Context loaded from summary: "${s.summary}" ]

---

${s.content}`,isSummary:!0};n.history.push(o),await ve(G,"readwrite","put",n),i.setProject(t),i.updateAndPersistState(),i.bus.publish("ui:renderMessages"),i.bus.publish("summary:listChanged")}function Vt(){console.log("🚀 unloadSummaryFromActiveSession handler called!");const e=i.getProject(),t=e.chatSessions.find(n=>n.id===e.activeSessionId);!t||!t.summaryState?.activeSummaryId||(console.log(`Clearing summary context for session: ${t.name}`),t.summaryState.activeSummaryId=null,t.history.push({role:"system",content:"[Summary context has been cleared. The full conversation history is now active.]"}),i.updateAndPersistState(),U(),i.bus.publish("status:update",{message:"Summary context cleared.",state:"connected"}),w("Summary context cleared successfully.","Success"),i.bus.publish("context:requestData"))}async function Xt(e){if(!confirm("Are you sure you want to permanently delete this summary log? This cannot be undone."))return;const t=i.getProject(),n=t.summaryLogs.findIndex(s=>s.id===e);n>-1&&(t.summaryLogs.splice(n,1),t.chatSessions.forEach(s=>{if(s.summaryState?.activeSummaryId===e&&(s.summaryState.activeSummaryId=null,s.id===t.activeSessionId)){const o={role:"system",content:"[ System: The active summary was deleted. Context has been cleared. ]"};s.history.push(o),i.bus.publish("ui:renderMessages")}}),i.setProject(t),await i.updateAndPersistState(),i.bus.publish("summary:listChanged"))}async function Zt({index:e,event:t}){t&&t.stopPropagation();const n=t.currentTarget,s=i.getProject(),o=s.chatSessions.find(l=>l.id===s.activeSessionId);if(!o)return;const a=o.history[e];if(!a)return;let r="";typeof a.content=="string"?r=a.content:Array.isArray(a.content)&&(r=a.content.find(l=>l.type==="text")?.text||"");let c="";a.role==="assistant"&&window.marked?c=marked.parse(r,{gfm:!0,breaks:!1}):c=`<p>${r.replace(/\n/g,"<br>")}</p>`;try{const l=new Blob([c],{type:"text/html"}),d=new Blob([r],{type:"text/plain"}),g=new ClipboardItem({"text/html":l,"text/plain":d});if(await navigator.clipboard.write([g]),n){const u=n.querySelector(".material-symbols-outlined");if(u){const f=u.textContent;u.textContent="check",setTimeout(()=>{u.textContent=f},1500)}}}catch(l){console.error("Failed to copy rich text, falling back to plain text:",l),await navigator.clipboard.writeText(r),w("Failed to copy rich text, copied as plain text instead.","Warning")}}async function en({index:e,event:t}){t&&t.stopPropagation();const n=i.getProject(),s=n.chatSessions.find(l=>l.id===n.activeSessionId);if(!s)return;const o=s.history[e],a=document.querySelector(`.message-turn-wrapper[data-index='${e}']`);if(!a)return;const r=a.querySelector(".message"),c=r.querySelector(".message-content");if(o.role==="user"){if(r.classList.contains("is-editing"))return;r.classList.add("is-editing"),a.classList.add("is-editing-child"),c&&(c.style.display="none");const l=document.createElement("div");l.className="inline-edit-container";const d=document.createElement("textarea");d.className="inline-edit-textarea";const g=Array.isArray(o.content)?o.content.find(h=>h.type==="text")?.text||"":o.content;d.value=g,d.addEventListener("input",()=>{d.style.height="auto",d.style.height=d.scrollHeight+"px"});const u=document.createElement("div");u.className="inline-edit-actions";const f=document.createElement("button");f.textContent="Save & Regenerate",f.className="btn btn-small";const m=document.createElement("button");m.textContent="Cancel",m.className="btn btn-small btn-secondary";const p=()=>{l.remove(),c&&(c.style.display="block"),r.classList.remove("is-editing"),a.classList.remove("is-editing-child")};f.addEventListener("click",async h=>{h.stopPropagation();const y=d.value.trim(),L=Array.isArray(o.content)?o.content.filter(b=>b.type!=="text"):[],E=[];if(y&&E.push({type:"text",text:y}),E.push(...L),E.length===0){w("Cannot save an empty message.","Warning");return}if(s.history[e].content=E,s.summaryState?.activeSummaryId&&e<s.summaryState.summarizedUntilIndex&&(s.summaryState.activeSummaryId=null,s.summaryState.summarizedUntilIndex=-1,console.log("Summary context has been reset due to a historical message edit."),s.history.splice(e+1,0,{role:"system",content:"[System: Conversation history was edited. Previous summary context has been cleared.]"})),s.history.splice(e+1),i.updateAndPersistState(),i.bus.publish("ui:renderMessages"),n.activeEntity.type==="agent")await ie();else if(n.activeEntity.type==="group"){const b=n.agentGroups[n.activeEntity.name];await ae(n,s,b)}A()}),m.addEventListener("click",h=>{h.stopPropagation(),p()}),d.addEventListener("keydown",h=>{h.key==="Escape"&&(h.preventDefault(),m.click())}),u.appendChild(m),u.appendChild(f),l.appendChild(d),l.appendChild(u),r.appendChild(l),d.focus(),d.dispatchEvent(new Event("input"))}else if(o.role==="assistant"){if(!c||r.classList.contains("is-editing"))return;r.classList.add("is-editing"),a.classList.add("is-editing-child"),c&&(c.style.display="none");const l=document.createElement("div");l.className="inline-edit-container";const d=document.createElement("textarea");d.className="inline-edit-textarea",d.value=o.content,d.addEventListener("input",()=>{d.style.height="auto",d.style.height=d.scrollHeight+"px"});const g=document.createElement("div");g.className="inline-edit-actions";const u=document.createElement("button");u.textContent="Save",u.className="btn btn-small";const f=document.createElement("button");f.textContent="Cancel",f.className="btn btn-small btn-secondary";const m=()=>{l.remove(),c&&(c.style.display="block"),r.classList.remove("is-editing"),a.classList.remove("is-editing-child")};u.addEventListener("click",p=>{p.stopPropagation(),s.history[e].content=d.value,i.updateAndPersistState(),i.bus.publish("ui:renderMessages")}),f.addEventListener("click",p=>{p.stopPropagation(),m()}),d.addEventListener("keydown",p=>{p.key==="Escape"&&(p.preventDefault(),f.click())}),g.appendChild(f),g.appendChild(u),l.appendChild(d),l.appendChild(g),r.appendChild(l),d.focus(),d.dispatchEvent(new Event("input"))}}async function tn({index:e}){const t=i.getProject(),n=t.chatSessions.find(s=>s.id===t.activeSessionId);if(!(!n||e>=n.history.length)){if(Ie(),n.history.splice(e),i.bus.publish("ui:renderMessages"),t.activeEntity.type==="agent")await ie();else if(t.activeEntity.type==="group"){const s=t.agentGroups[t.activeEntity.name];await ae(t,n,s)}}}function nn({index:e}){if(!confirm("Are you sure you want to delete this single message? This action cannot be undone."))return;const t=i.getProject(),n=t.chatSessions.find(s=>s.id===t.activeSessionId);n&&(n.history.splice(e,1),i.setProject(t),i.updateAndPersistState(),i.bus.publish("ui:renderMessages"),A())}async function rt(e){await new Promise(t=>setTimeout(t,500));try{const n=i.getProject().globalSettings.systemUtilityAgent;if(!n||!n.model){console.warn("Auto-naming skipped: System Utility Agent not configured.");return}const s=e.history.find(d=>d.role==="user"),o=Array.isArray(s.content)?s.content.find(d=>d.type==="text")?.text:s.content;if(!o)return;const a=`Based on the user's initial query, create a concise title (3-5 words) and a single relevant emoji. Respond ONLY with a JSON object like {"title": "your title", "emoji": "👍"}.

User's Query: "${o}"`,r=await Fe({...n,temperature:.1},[{role:"user",content:a}]);de(r.usage,n.model);let c={};try{const d=r.content.match(/{.*}/s);c=JSON.parse(d[0])}catch{console.error("Failed to parse title JSON:",r.content),c={title:o.substring(0,30),emoji:"💬"}}const l=`${c.emoji||"💬"} ${c.title||"New Chat"}`;i.bus.publish("session:autoRename",{sessionId:e.id,newName:l})}catch(t){console.error("Auto-rename process failed:",t)}}function sn({index:e}){const t=i.getProject(),n=t.chatSessions.find(a=>a.id===t.activeSessionId);if(!n)return;const s=n.history[e],o=n.summaryState?.activeSummaryId;o&&s?.summaryLogId===o&&(n.summaryState.activeSummaryId=null,console.log(`Summary context for log ID ${o} has been cleared.`)),n.history.splice(e,1),i.updateAndPersistState(),i.bus.publish("ui:renderMessages"),w("Marker/Context has been removed from this chat.","Info")}async function it(e){try{const n=await fetch("https://cors-anywhere.herokuapp.com/"+e);if(!n.ok)throw new Error(`Server responded with status ${n.status} (${n.statusText})`);const s=await n.blob();return new Promise((o,a)=>{const r=new FileReader;r.onloadend=()=>o(r.result),r.onerror=a,r.readAsDataURL(s)})}catch(t){throw console.error(`Could not convert image URL "${e}" to Base64:`,t.message),new Error(`Failed to process image from URL: ${e}. It might be protected (403 Forbidden).`)}}function A(e={}){const{message:t,state:n}=e,s=document.getElementById("statusText"),o=document.getElementById("statusDot"),a=document.getElementById("model-count-status");if(s&&o&&a){s.textContent=t||"Ready",o.className="status-dot";const u=n||"connected";u==="connected"?o.classList.add("connected"):u==="error"?o.classList.add("error"):u==="loading"&&o.classList.add("warning");const f=x();a.textContent=`${f.length} Models`}const{totalTokens:r,agent:c,agentNameForDisplay:l}=re(),d=document.getElementById("active-agent-status"),g=document.getElementById("token-count-status");d&&(d.textContent=`Active: ${c.icon||""} ${l}`),g&&(g.textContent=`~${r.toLocaleString()} Tokens`)}function ye({message:e,state:t}){const n=document.getElementById("statusText"),s=document.getElementById("statusDot");if(n&&s){n.textContent=e||"Ready",s.className="status-dot";const o=t||"connected";o==="connected"?s.classList.add("connected"):o==="error"?s.classList.add("error"):o==="loading"&&s.classList.add("warning")}}function on(e){const t=document.createElement("div");t.className="dropdown align-right";const n=document.createElement("button");n.className="btn-icon",n.innerHTML="&#8942;",n.title="More options",n.dataset.action="toggle-menu";const s=document.createElement("div");return s.className="dropdown-content",e.forEach(o=>{const a=document.createElement("a");a.href="#",a.textContent=o.label,o.isDestructive&&a.classList.add("is-destructive"),a.dataset.action=o.action,o.data&&(a.dataset.data=JSON.stringify(o.data)),s.appendChild(a)}),t.append(n,s),t}function ct(){const e=document.getElementById("settings-modal");e&&(e.style.display="flex")}function lt(){const e=document.getElementById("settings-modal");e&&(e.style.display="none")}function an(){document.getElementById("unsaved-changes-modal").style.display="flex"}function rn(){document.getElementById("unsaved-changes-modal").style.display="none"}function w(e,t="Notification"){document.getElementById("alert-modal-title").textContent=t,document.getElementById("alert-modal-message").textContent=e,document.getElementById("alert-modal").style.display="flex"}function dt(){document.getElementById("alert-modal").style.display="none"}function ut(){document.querySelector(".sidebar").classList.toggle("open"),document.getElementById("mobile-overlay").classList.toggle("active")}function cn(e){e.stopPropagation();const t=e.target.closest(".dropdown");if(!t)return;const n=t.querySelector(".dropdown-content"),s=t.classList.contains("open");if(document.querySelectorAll(".dropdown.open").forEach(o=>{o!==t&&o.classList.remove("open")}),!s){n.style.visibility="hidden",n.style.display="block";const o=n.offsetHeight;n.style.visibility="",n.style.display="";const a=e.target.closest("button").getBoundingClientRect();window.innerHeight-a.bottom<o&&a.top>o?n.classList.add("opens-up"):n.classList.remove("opens-up")}t.classList.toggle("open")}function ln(){document.addEventListener("click",e=>{const t=document.querySelector(".dropdown.open");t&&!t.contains(e.target)&&t.classList.remove("open");const n=document.querySelector(".searchable-select-wrapper .searchable-select-options:not(.hidden)");if(n){const s=n.closest(".searchable-select-wrapper");s&&!s.contains(e.target)&&n.classList.add("hidden")}})}function mt(){const e=i.getProject();e?.globalSettings?.fontFamilySelect&&document.documentElement.style.setProperty("--main-font-family",e.globalSettings.fontFamilySelect)}function dn(){const e=document.getElementById("app-version");e&&(e.textContent="0.0.1alpha"),i.bus.subscribe("ui:applyFontSettings",mt),i.bus.subscribe("session:loaded",()=>A()),i.bus.subscribe("entity:selected",()=>A()),i.bus.subscribe("user:settingsUpdated",()=>A()),i.bus.subscribe("user:modelsLoaded",()=>A()),i.bus.subscribe("status:update",ye),ye({});const t=document.querySelector("#settings-btn");t&&t.addEventListener("click",()=>{console.log("Settings button clicked. Re-rendering panel before showing."),He()});const n=document.getElementById("mobile-overlay");n&&n.addEventListener("click",ut);const s=document.querySelector("#alert-modal .btn");s&&s.addEventListener("click",dt);const o=document.getElementById("unsaved-changes-modal");if(o){const a=o.querySelector(".btn:not(.btn-secondary):not(.btn-danger)");a&&a.addEventListener("click",()=>i.bus.publish("project:unsavedChangesChoice","save"));const r=o.querySelector(".btn-danger");r&&r.addEventListener("click",()=>i.bus.publish("project:unsavedChangesChoice","discard"));const c=o.querySelector(".btn-secondary");c&&c.addEventListener("click",()=>i.bus.publish("project:unsavedChangesChoice","cancel"))}console.log("Core UI Initialized and Listeners Attached.")}function pt(e,t){const n=document.querySelector(".context-menu");n&&n.remove(),t.preventDefault(),t.stopPropagation();const s=document.createElement("div");s.className="context-menu";const o=document.createElement("ul");e.forEach(p=>{const h=document.createElement("li");h.textContent=p.label,p.isDestructive&&h.classList.add("destructive"),h.addEventListener("click",y=>{y.stopPropagation(),p.action()}),o.appendChild(h)}),s.appendChild(o),document.body.appendChild(s);const{clientX:a,clientY:r}=t.touches?t.touches[0]:t,c=s.offsetWidth,l=s.offsetHeight,d=window.innerWidth,g=window.innerHeight;let u=r,f=a;a+c>d&&(f=d-c-10),r+l>g&&(u=g-l-10),s.style.top=`${u}px`,s.style.left=`${f}px`,requestAnimationFrame(()=>{s.style.opacity="1",s.style.transform="scale(1)"});const m=()=>{s.remove(),document.removeEventListener("click",m,!0)};setTimeout(()=>{document.addEventListener("click",m,!0)},0)}function gt(e,t,n){const s=document.getElementById(e);if(!s)return;const o=n!==void 0?n:i.getState().allProviderModels||[],a=s.querySelector('input[type="text"]'),r=s.querySelector('input[type="hidden"]'),c=s.querySelector(".searchable-select-options");if(!a||!r||!c)return;let l=-1;const d=()=>{c.querySelectorAll(".searchable-option-item").forEach((m,p)=>{m.classList.toggle("active",p===l),p===l&&m.scrollIntoView({block:"nearest"})})},g=m=>{const p=c.querySelectorAll(".searchable-option-item");p[m]&&p[m].click()},u=m=>{if(c.innerHTML="",l=-1,m.length===0){c.innerHTML='<div class="searchable-option-item">No models found.</div>';return}m.forEach(p=>{const h=document.createElement("div");h.className="searchable-option-item",h.dataset.value=p.id,h.innerHTML=`${p.name} &nbsp;•&nbsp; <small>${p.id}</small>`,h.addEventListener("click",()=>{a.value=p.name,r.value=p.id,c.classList.add("hidden"),r.dispatchEvent(new Event("change",{bubbles:!0}))}),c.appendChild(h)})};a.addEventListener("keydown",m=>{const p=c.querySelectorAll(".searchable-option-item");p.length!==0&&(m.key==="ArrowDown"?(m.preventDefault(),l=(l+1)%p.length,d()):m.key==="ArrowUp"?(m.preventDefault(),l=(l-1+p.length)%p.length,d()):m.key==="Enter"?(m.preventDefault(),m.stopPropagation(),l>-1&&g(l)):m.key==="Escape"&&c.classList.add("hidden"))}),a.addEventListener("input",()=>u(o.filter(m=>m.name.toLowerCase().includes(a.value.toLowerCase())))),a.addEventListener("focus",()=>{u(o),c.classList.remove("hidden")});const f=o.find(m=>m.id===t);f?(a.value=f.name,r.value=f.id):(a.value="",r.value="")}const ce="promptPrimUserDatabase_v1",le="promptPrimAdminBilling_v1",Le="promptPrimMasterPresets_v1",Q="user_master";let S=[],B={},j=null;async function ft(){const e=localStorage.getItem(Le);if(e)B=JSON.parse(e),console.log("Loaded master presets from localStorage.");else try{const n=await fetch("/PromptPrim/master-presets.json");if(!n.ok)throw new Error(`Status: ${n.status}`);B=await n.json(),xe(B),console.log("Loaded default master presets from file.")}catch(t){console.error("Failed to load default master presets:",t),B={}}}function x(){const e=I();if(!e)return[];if(e.plan==="master")return i.getState().userProviderModels||[];const t=i.getState().systemProviderModels||[],n=Pe();if(e.plan==="pro"&&e.planStatus==="active"&&e.credits.current>0){const s=new Set(n.pro_tier?.modelIds||[]);return t.filter(o=>s.has(o.id))}if(e.plan==="free"&&e.credits.current>0||e.planStatus==="grace_period"){const s=new Set(n.free_tier?.modelIds||[]);return t.filter(o=>s.has(o.id))}return[]}function ht(){const e=localStorage.getItem(ce);e&&(S=JSON.parse(e).map(t=>JSON.parse(JSON.stringify(t))),i.bus.publish("user:settingsUpdated",I()),console.log("Cross-tab sync: In-memory user database reloaded."))}function z(e,t,n,s,o=0){const a={userId:e,userName:t,email:n,plan:s,planStatus:"active",gracePeriodStartDate:null,credits:{current:o,totalUsage:0,totalRefilledUSD:0,tokenUsage:{prompt:0,completion:0},totalUsedUSD:0},subscriptionEndDate:null,logs:[{timestamp:Date.now(),action:`Account created with ${s} plan.`}],activityLog:[],apiSettings:{openrouterKey:"",ollamaBaseUrl:"http://localhost:11434"},appSettings:{activeModelPreset:"my_first_preset"}};return s!=="master"&&(a.modelPresets={my_first_preset:{name:"My First Preset",modelIds:[]}}),a}function Ce(){const e=localStorage.getItem(ce);e?S=JSON.parse(e).map(t=>JSON.parse(JSON.stringify(t))):(S=[z("user_pro","Kaiwan (Pro)","kai@example.com","pro",1e6),z("user_free","Demo User (Free)","demo@example.com","free",5e4),z(Q,"Admin (Master)","admin@example.com","master",0)],P())}function P(){localStorage.setItem(ce,JSON.stringify(S)),i.bus.publish("user:settingsUpdated",I())}function yt(e){j=e,localStorage.setItem("promptPrimActiveUserId",e),console.log(`👤 Active user switched to: ${e}`)}function bt(){return JSON.parse(JSON.stringify(S))}function H(e){const t=S.find(n=>n.userId===e);return t?JSON.parse(JSON.stringify(t)):null}function St(e,t){const n=S.findIndex(s=>s.userId===e);n!==-1&&(t.plan!==void 0&&(S[n].plan=t.plan),t.credits!==void 0&&(S[n].credits=t.credits),t.plan!==void 0&&S[n].planStatus!=="active"&&(S[n].planStatus="active",S[n].gracePeriodStartDate=null),P())}function vt(){return I()}function I(){return S.length===0&&Ce(),S.find(e=>e.userId===j)||null}async function Et(){await ft(),Ce();const e=localStorage.getItem("promptPrimActiveUserId");e&&S.some(n=>n.userId===e)?j=e:!j&&S.length>0&&(j=S[0].userId);const t=I();return t&&wt(t),console.log("👤 Current User Profile Initialized:",t),i.bus.publish("user:settingsLoaded",t),t}function q(e){const t=T();return!t||!t.markupRate||t.markupRate===0?0:e/(t.markupRate*1e6)}function de(e,t,n=0){const s=I();if(!s||s.plan==="master")return;const a=T().markupRate||1,r=n*a*1e6;s.credits.current-=r,s.credits.totalUsage+=r,s.credits.current<0&&(s.credits.current=0),s.credits.totalUsedUSD||(s.credits.totalUsedUSD=0),s.credits.totalUsedUSD+=n;const c=q(s.credits.current);s.logs.push({timestamp:Date.now(),event:"Usage",details:`API Usage on model: ${t}`,amountUSD:-n,balanceAfterUSD:c}),s.credits.tokenUsage||(s.credits.tokenUsage={prompt:0,completion:0}),s.credits.tokenUsage.prompt+=e.prompt_tokens||0,s.credits.tokenUsage.completion+=e.completion_tokens||0,s.logs.push({timestamp:Date.now(),action:`API Usage Cost: $${n.toFixed(8)}`});const l=q(s.credits.current),d=s.credits.current+r,g=q(d);l<1&&g>=1&&w(`Your balance is low ($${l.toFixed(2)}). Please consider refilling to avoid service interruption.`,"Low Balance Warning"),P()}function Me(){const e=I();!e||e.plan!=="pro"||e.planStatus!=="active"||(e.planStatus="grace_period",e.gracePeriodStartDate=Date.now(),P(),w("Your Pro credits have run out. You now have 7 days of Free Plan access before your account is suspended. Please refill your credits.","Credits Depleted"))}function wt(e){if(!e||e.planStatus!=="grace_period")return;const t=7*24*60*60*1e3;Date.now()-e.gracePeriodStartDate>t&&(e.planStatus="expired",P(),w("Your grace period has expired. Please refill your credits to continue using the service.","Account Suspended"))}function ue(){return S.find(t=>t.userId===Q)?.apiSettings||{openrouterKey:"",ollamaBaseUrl:""}}function oe(){const e=I(),t=S.find(n=>n.userId==="user_master");return e.plan==="master"?e.apiSettings?.openrouterKey||"":t?.apiSettings?.openrouterKey||""}function ke(){const e=I(),t=S.find(n=>n.userId===Q);return e.plan==="master"?e.apiSettings?.ollamaBaseUrl||"":t?.apiSettings?.ollamaBaseUrl||""}function It({openrouter:e,ollamaBaseUrl:t}){const n=S.find(s=>s.userId===Q);n&&(n.apiSettings.openrouterKey=e,n.apiSettings.ollamaBaseUrl=t,P())}function Pe(){return B}function xe(e){B=e,localStorage.setItem(Le,JSON.stringify(B))}function V(){return I()?.modelPresets||{}}function me(e){const t=I();t&&(t.modelPresets=e,P())}function T(){const e=localStorage.getItem(le);return e?JSON.parse(e):{balanceUSD:10,usedUSD:0,markupRate:2.5}}function Lt(e){const t=T();t.balanceUSD=parseFloat(e.balanceUSD)||0,t.markupRate=parseFloat(e.markupRate)||1,localStorage.setItem(le,JSON.stringify(t))}function Ae(e){if(typeof e!="number"||e<=0)return;const t=T();t.usedUSD+=e,localStorage.setItem(le,JSON.stringify(t))}function Ct(e,t){const n=H(e);if(!n)return;n.plan==="free"&&(n.plan="pro",n.planStatus="active",n.logs.push({timestamp:Date.now(),action:`Upgraded to Pro plan via first refill of $${t.toFixed(2)}.`}),console.log(`User ${e} automatically upgraded to Pro.`));const s=T(),o=t*s.markupRate*1e6;n.credits.current+=o,n.credits.totalRefilledUSD+=t;const a=q(n.credits.current);if(n.logs.push({timestamp:Date.now(),event:"Refill",details:"Credit Refill",amountUSD:t,balanceAfterUSD:a}),n.plan==="master"){console.warn(`Attempted to refill credits for a Master plan user (${e}). Operation blocked.`);return}n.plan==="pro"&&n.planStatus!=="active"&&(n.planStatus="active",n.logs.push({timestamp:Date.now(),action:"Account status reactivated."})),J(n)}function J(e){const t=S.findIndex(n=>n.userId===e.userId);t!==-1&&(S[t]=e,P())}function Mt(e){const t=H(e);if(!t||t.plan!=="master")return;const n=30*24*60*60*1e3,s=Date.now(),o=t.subscriptionEndDate&&t.subscriptionEndDate>s?t.subscriptionEndDate:s;t.subscriptionEndDate=o+n,t.logs.push({timestamp:s,action:"Subscription extended by 30 days."}),J(t)}function Be(){const e=`u${Math.floor(Math.random()*900)+100}`;return S.some(t=>t.userId===e)?Be():e}function kt(e,t){if(!e||!t)return console.error("Username and email are required."),null;const n=Be(),s=z(n,e,t,"free",5e4);return S.push(s),P(),s}function Pt(e,t){const n=H(e);if(!n)return;const s=n.plan;s!==t&&(n.plan=t,n.planStatus="active",n.gracePeriodStartDate=null,n.logs.push({timestamp:Date.now(),action:`Plan changed from ${s} to ${t}.`}),P())}function xt(){return S.filter(e=>e.plan==="pro"||e.plan==="free").reduce((e,t)=>e+(t.credits?.current||0),0)}function Te(e,t){const n=H(e);n&&(Array.isArray(n.activityLog)||(n.activityLog=[]),n.activityLog.push(t),J(n))}function At(){const e=T(),t=S.filter(r=>r.plan!=="master"),n=t.reduce((r,c)=>r+(c.credits.totalRefilledUSD||0),0),s=e.usedUSD||0,o=t.reduce((r,c)=>r+(c.credits.tokenUsage?.prompt||0)+(c.credits.tokenUsage?.completion||0),0),a=t.reduce((r,c)=>r+(c.activityLog?.length||0),0);return{grossRevenue:n,totalCosts:s,netProfit:n-s,activeUsers:t.length,totalApiCalls:a,totalTokensProcessed:o}}function Bt(){return S.filter(e=>e.plan!=="master").map(e=>{const t=e.credits.totalRefilledUSD||0,n=e.credits.totalUsedUSD||0;return{userName:e.userName,userId:e.userId,plan:e.plan,totalRefilledUSD:t,totalUsageUSD:n,netValue:t-n}})}const un=Object.freeze(Object.defineProperty({__proto__:null,addNewUser:kt,burnCreditsForUsage:de,changeUserPlan:Pt,convertCreditsToUSD:q,downgradeToGracePeriod:Me,extendMasterSubscription:Mt,getAllUsers:bt,getAllowedModelsForCurrentUser:x,getApiKey:oe,getCurrentUserProfile:I,getFinancialSummary:At,getMasterModelPresets:Pe,getOllamaUrl:ke,getPerUserFinancials:Bt,getSystemApiSettings:ue,getSystemBillingInfo:T,getTotalCreditsIssued:xt,getUserById:H,getUserModelPresets:V,getUserSettings:vt,initUserSettings:Et,logSystemApiCost:Ae,logUserActivity:Te,refillCredits:Ct,reloadDatabaseFromStorage:ht,saveFullUserProfile:J,saveMasterModelPresets:xe,saveSystemApiSettings:It,saveSystemBillingInfo:Lt,saveUserModelPresets:me,setActiveUserId:yt,updateUser:St},Symbol.toStringTag,{value:"Module"})),Tt={"perplexity/sonar-small-online":{penalties:!1,seed:!1,top_k:!1,tools:!1},"perplexity/sonar-medium-online":{penalties:!1,seed:!1,top_k:!1,tools:!1},"xai/grok-1.5":{penalties:!1,seed:!1}};function X(e,t){if(!e||!e.id)return!1;const n=e.id,s=Tt[n];if(s&&s[t]!==void 0)return s[t];switch(t){case"penalties":case"seed":return!n.startsWith("xai/")&&!n.startsWith("perplexity/");case"tools":return!n.startsWith("perplexity/")&&e.supports_tools;default:return!0}}async function De(e){if(!e)return[];const t=await fetch("https://openrouter.ai/api/v1/models",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Could not fetch models from OpenRouter");return(await t.json()).data.map(s=>({id:s.id,name:s.name||s.id,provider:"openrouter",description:s.description,context_length:s.context_length,pricing:{prompt:s.pricing?.prompt||"0",completion:s.pricing?.completion||"0"},supports_tools:s.architecture?.tool_use===!0}))}async function Ue(e){if(!e)return[];try{const t=await fetch(`${e}/api/tags`);if(!t.ok)throw new Error(`Ollama connection failed (HTTP ${t.status})`);return(await t.json()).models.map(s=>({id:s.name,name:s.name,provider:"ollama",supports_tools:!1}))}catch{throw new Error("Could not connect to Ollama. Check URL and CORS settings.")}}async function pe(e,t={},n=12e4){const s=new AbortController,o=setTimeout(()=>s.abort(),n),a=AbortSignal.any([t.signal,s.signal].filter(Boolean));try{return await fetch(e,{...t,signal:a})}finally{clearTimeout(o)}}async function mn({apiKey:e,ollamaBaseUrl:t,isUserKey:n=!1}={}){i.bus.publish("status:update",{message:"Loading models...",state:"loading"});let s=[];if(e)try{const o=await De(e);s.push(...o)}catch(o){console.error("Failed to fetch OpenRouter models:",o),e&&w("Could not fetch models from OpenRouter.","Warning")}if(t)try{const o=await Ue(t);s.push(...o)}catch(o){console.error("Failed to fetch Ollama models:",o),t&&w(o.message,"Warning")}n?i.setUserModels(s):i.setSystemModels(s),i.bus.publish("status:update",{message:"Models loaded",state:"connected"})}async function pn(){i.bus.publish("status:update",{message:"Loading all system models...",state:"loading"});const e=(void 0)();let t=[];if(e.openrouterKey)try{const n=await De(e.openrouterKey);t.push(...n)}catch(n){console.error("Failed to fetch OpenRouter models:",n),w("Could not fetch models from OpenRouter. Check key and connection.","Warning")}if(e.ollamaBaseUrl)try{const n=await Ue(e.ollamaBaseUrl);t.push(...n)}catch(n){console.error("Failed to fetch Ollama models:",n),w(n.message,"Warning")}i.setSystemModels(t),console.log(`Loaded a total of ${t.length} system models.`),i.bus.publish("status:update",{message:"Models loaded",state:"connected"})}function Ne(e){const t=i.getProject();if(!t)return"";let n;const s=e;if(s)n=t.agentPresets?.[s];else{const c=t.activeEntity;if(c?.type==="agent")n=t.agentPresets?.[c.name];else if(c?.type==="group"){const l=t.agentGroups?.[c.name];n=t.agentPresets?.[l?.moderatorAgent]}}if(!n)return"";let o=n.systemPrompt||"";const a=n.activeMemories||[];if(a.length===0)return o.trim();const r=a.map(c=>t.memories.find(l=>l.name===c)?.content).filter(Boolean).join(`

`);return r?`${o.trim()}

--- Active Memories ---
${r}`:o.trim()}function $e(e,t){const n=i.getProject();if(!n)return[];const s=n.agentPresets[t];if(!s)return[];const o=[],a=Ne(t);a&&o.push({role:"system",content:a});const r=n.chatSessions.find(u=>u.id===n.activeSessionId),c=r?.summaryState?.activeSummaryId;let l=0;if(c){const u=n.summaryLogs?.find(f=>f.id===c);if(u){const f=`This is a summary of the conversation so far. Use this for context:

---
${u.content}
---`;o.push({role:"system",content:f}),l=r.summaryState.summarizedUntilIndex||0}}const d=e.slice(l),g=d.filter(u=>u.role==="assistant"&&u.content&&!u.isLoading).length;return d.forEach((u,f)=>{if(u.isLoading||!u.content||u.isSummary||u.isSummaryMarker)return;let m=u.content;Array.isArray(m)&&([...i.getState().systemProviderModels||[],...i.getState().userProviderModels||[]].find(b=>b.id===s.model)?.provider==="openrouter"?m=m.map(b=>b.type==="image_url"?{type:"image_url",image_url:{url:b.url}}:b):m=m.filter(b=>b.type==="text"&&b.text).map(b=>b.text).join(`
`));const p={role:u.role,content:m},h=f===d.length-1;g>0&&u.role==="assistant"&&h?p.role="user":u.role==="assistant"&&u.speaker&&(p.name=u.speaker.replace(/[^a-zA-Z0-9_-]/g,"_")),o.push(p)}),o}function ge(e,t,n=!1){const s=i.getProject(),o=e===s.globalSettings.systemUtilityAgent,r=(o?i.getState().systemProviderModels||[]:x()).find(y=>y.id===e.model);if(!r){const y=o?"it might be missing from the system's model list":"it's not allowed in your current plan";throw new Error(`Model '${e.model}' not found or not allowed because ${y}.`)}const c=r.provider;let l,d,g;const u={},f=parseFloat(e.temperature);isNaN(f)||(u.temperature=f);const m=parseFloat(e.topP);isNaN(m)||(u.top_p=m);const p=parseInt(e.max_tokens,10);if(!isNaN(p)&&p>0&&(u.max_tokens=p),X(r,"top_k")){const y=parseInt(e.topK,10);!isNaN(y)&&y>0&&(u.top_k=y)}if(X(r,"penalties")){const y=parseFloat(e.presence_penalty);isNaN(y)||(u.presence_penalty=y);const L=parseFloat(e.frequency_penalty);isNaN(L)||(u.frequency_penalty=L)}if(X(r,"seed")){const y=parseInt(e.seed,10);!isNaN(y)&&y!==-1&&(u.seed=y)}const h=e.stop_sequences?e.stop_sequences.split(",").map(y=>y.trim()).filter(Boolean):[];if(h.length>0&&(u.stop=h),c==="openrouter"){if(!(o?ue().openrouterKey:oe()))throw new Error("Required OpenRouter API Key is missing for this operation.");l="https://openrouter.ai/api/v1/chat/completions",d={Authorization:`Bearer ${oe()}`,"Content-Type":"application/json",Accept:"application/json","HTTP-Referer":"https://sarega.github.io/PromptPrim/","X-Title":"PromptPrim"},g={model:e.model,messages:t,stream:n,...u},e.enableWebSearch&&(e.model.startsWith("perplexity/")||(g.plugins=[{id:"web",max_results:5}]))}else l=`${ke()}/api/chat`,d={"Content-Type":"application/json"},g={model:e.model,messages:t,stream:n,options:u};return{url:l,headers:d,body:g,provider:c}}async function _e(e,t,n){const{url:s,headers:o,body:a,provider:r}=ge(e,t,!0);try{i.bus.publish("status:update",{message:`Responding with ${e.model}...`,state:"loading"});const c=performance.now(),l=await pe(s,{method:"POST",headers:o,body:JSON.stringify(a),signal:i.getState().abortController?.signal});if(!l.ok)throw new Error(`API Error: ${l.status} ${l.statusText}`);const d=l.body.getReader(),g=new TextDecoder("utf-8");let u="",f="";for(;;){const{value:E,done:b}=await d.read();if(b)break;u+=g.decode(E,{stream:!0});const N=u.split(`
`);u=N.pop();for(const D of N){if(D.trim()===""||D.startsWith(":"))continue;let $="";try{if(r==="openrouter"){if(D.startsWith("data: ")){const K=D.replace(/^data: /,"").trim();if(K==="[DONE]")continue;$=JSON.parse(K).choices?.[0]?.delta?.content||""}}else $=JSON.parse(D).message?.content||""}catch{console.warn("Skipping malformed JSON chunk:",D)}$&&(f+=$,n($))}}if(u.trim()){let E="";try{if(r==="openrouter"){if(u.startsWith("data: ")){const b=u.replace(/^data: /,"").trim();b!=="[DONE]"&&(E=JSON.parse(b).choices?.[0]?.delta?.content||"")}}else E=JSON.parse(u).message?.content||""}catch{console.warn("Skipping malformed final JSON chunk:",u)}E&&(f+=E,n(E))}const p=(performance.now()-c)/1e3;let h={prompt_tokens:0,completion_tokens:0},y=0,L=!0;if(r==="openrouter"&&l.headers.get("x-openrouter-usage"))try{const E=JSON.parse(l.headers.get("x-openrouter-usage"));h={prompt_tokens:E.prompt_tokens||0,completion_tokens:E.completion_tokens||0},y=E.cost||0,L=!1}catch(E){console.error("Could not parse usage header:",E)}return L&&(h.prompt_tokens=R(JSON.stringify(t)),h.completion_tokens=R(f)),{content:f,usage:h,duration:p,cost:y,usageIsEstimated:L}}catch(c){throw c.name!=="AbortError"&&(console.error("Streaming failed:",c),i.bus.publish("status:update",{message:`Error: ${c.message}`,state:"error"})),c}}async function Fe(e,t){console.log("📡 [callLLM] received:",{agent:e,messages:t});const{url:n,headers:s,body:o,provider:a}=ge(e,t,!1);try{const r=await pe(n,{method:"POST",headers:s,body:JSON.stringify(o)});if(!r.ok){const f=await r.text();throw new Error(`API Error: ${r.status} ${f}`)}const c=await r.json(),l=a==="openrouter"&&c.choices?.length>0?c.choices[0].message.content:c.message?.content;if(l===void 0)throw new Error("Invalid API response structure.");let d=0,g=c.usage||{prompt_tokens:0,completion_tokens:0},u=!0;if(a==="openrouter"&&r.headers.get("x-openrouter-usage"))try{const f=JSON.parse(r.headers.get("x-openrouter-usage"));d=f.cost||0,g.prompt_tokens=f.prompt_tokens||g.prompt_tokens,g.completion_tokens=f.completion_tokens||g.completion_tokens,u=!1}catch(f){console.error("Could not parse usage header in callLLM:",f)}return{content:l,usage:g,cost:d,usageIsEstimated:u}}catch(r){throw console.error("callLLM failed:",r),r}}function Dt(e,t){const s=[...i.getState().systemProviderModels||[],...i.getState().userProviderModels||[]].find(r=>r.id===e);if(!s||!s.pricing)return console.warn(`Could not find pricing data for model: ${e}`),0;const o=(t.prompt_tokens||0)*parseFloat(s.pricing.prompt),a=(t.completion_tokens||0)*parseFloat(s.pricing.completion);return o+a}async function gn(e,t){const n=ue(),s=n.openrouterKey,o=n.ollamaBaseUrl;if(!s&&!o)throw new Error("System API or Ollama URL is not configured by the admin.");const{url:a,headers:r,body:c}=ge(e,t,!1);try{const l=await pe(a,{method:"POST",headers:r,body:JSON.stringify(c)});if(!l.ok){const f=await l.text();throw new Error(`API Error: ${l.status} ${f}`)}const d=await l.json(),u=(c.model.includes("/")?"openrouter":"ollama")==="openrouter"&&d.choices?.length>0?d.choices[0].message.content:d.message?.content;if(u===void 0)throw new Error("Invalid API response structure.");return{content:u,usage:d.usage||{}}}catch(l){throw console.error("callSystemLLM failed:",l),l}}function Z(e){document.body.classList.remove("dark-mode","light-mode");const t=document.getElementById("hljs-light-theme"),n=document.getElementById("hljs-dark-theme");let s=e==="dark";e==="system"&&(s=window.matchMedia("(prefers-color-scheme: dark)").matches),document.body.classList.toggle("dark-mode",s),t&&(t.disabled=s),n&&(n.disabled=!s)}function fn(e){const t=document.getElementById(e);if(!t)return;const n=t.querySelectorAll('input[type="radio"]'),s=localStorage.getItem("theme")||"system";n.forEach(o=>{o.value===s&&(o.checked=!0),o.addEventListener("change",a=>{const r=a.target.value;localStorage.setItem("theme",r),Z(r)})}),Z(s),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{(localStorage.getItem("theme")||"system")==="system"&&Z("system")})}export{Zt as $,fn as A,q as B,Pt as C,Ct as D,Et as E,ue as F,dn as G,Yt as H,ln as I,Kt as J,Rt as K,Ot as L,Nt as M,Wt as N,ht as O,we as P,U as Q,Jt as R,G as S,Qt as T,un as U,Xt as V,sn as W,nn as X,at as Y,Ie as Z,en as _,w as a,tn as a0,Gt as a1,zt as a2,Vt as a3,tt as a4,Pe as a5,xe as a6,It as a7,pn as a8,xt as a9,H as aa,Mt as ab,bt as ac,kt as ad,J as ae,At as af,Bt as ag,ve as b,an as c,te as d,Oe as e,Ft as f,Je as g,rn as h,Ht as i,vt as j,I as k,mn as l,$t as m,_t as n,jt as o,qt as p,fe as q,gt as r,i as s,cn as t,x as u,on as v,gn as w,Fe as x,He as y,yt as z};
