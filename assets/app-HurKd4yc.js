import"./main-CpNDKUGA.js";import{j as g,R as Sn,a as En,r as A}from"./client-C1G-q6RG.js";import{t as ze,s as i,g as nt,d as oe,a as b,c as lo,b as co,e as He,f as uo,S as Me,h as mo,o as Ht,i as wn,j as po,l as Ge,k as go,m as fo,n as Ee,p as ho,q as gt,r as yo,M as Pn,u as Gt,v as bo,w as jn,x as vo,y as So,z as Eo,A as wo,B as Cn,C as Po,D as jo,E as Co,F as xo,U as Ao,G as Io,H as Lo,I as To,J as Mo,K as Do,L as ko,N as Bo,O as No,P as _o,Q as Oo,R as $o,T as Uo,V as Fo,W as Ro,X as qo,Y as Ho,Z as Go,_ as zo,$ as en,a0 as Yo,a1 as Wo,a2 as Xo}from"./core.theme-D33NMCdy.js";function Jo(){return g.jsxs("div",{style:{padding:"20px",backgroundColor:"#f0f8ff",border:"1px solid #b0c4de",borderRadius:"8px"},children:[g.jsx("h1",{children:"Hello from React! 👋"}),g.jsx("p",{children:"This component is rendered by React."})]})}const tn=document.getElementById("react-root");tn&&Sn.createRoot(tn).render(g.jsx(En.StrictMode,{children:g.jsx(Jo,{})}));const Ke={temperature:{label:"Temperature",provider:"all",type:"range",min:0,max:2,step:.01,default:1,tooltip:"Controls randomness. Higher is more creative."},top_p:{label:"Top P",provider:"all",type:"range",min:0,max:1,step:.01,default:1,tooltip:"Controls diversity via nucleus sampling."},top_k:{label:"Top K",provider:"all",type:"range",min:0,max:100,step:1,default:0,tooltip:"Limits sampling to the K most likely tokens."},max_tokens:{label:"Max Tokens",provider:"all",type:"range",min:1,max:32768,step:1,default:4096,tooltip:"The maximum number of tokens to generate."},frequency_penalty:{label:"Frequency Penalty",provider:"all",type:"range",min:-2,max:2,step:.01,default:0,tooltip:"Reduces the likelihood of repeating the same lines."},presence_penalty:{label:"Presence Penalty",provider:"all",type:"range",min:-2,max:2,step:.01,default:0,tooltip:"Reduces the likelihood of repeating existing topics."},seed:{label:"Seed",provider:"all",type:"number",default:-1,tooltip:"Use -1 for random output, or a specific number for deterministic output."},stop_sequences:{label:"Stop Sequences",provider:"all",type:"text",default:"",tooltip:"Comma-separated list of sequences to stop generation."},logit_bias:{label:"Logit Bias",provider:"openrouter",type:"textarea",default:"",tooltip:'Advanced: Enter "token:bias" pairs (e.g., "123:-1, 456:1.5").'},mirostat:{label:"Mirostat",provider:"ollama",type:"select",options:[0,1,2],default:0,tooltip:"Enables Mirostat sampling (0 = disabled, 1 = v1, 2 = v2)."},mirostat_tau:{label:"Mirostat Tau",provider:"ollama",type:"range",min:0,max:10,step:.1,default:5,tooltip:"Controls the balance between coherence and diversity for Mirostat."},mirostat_eta:{label:"Mirostat Eta",provider:"ollama",type:"range",min:0,max:1,step:.01,default:.1,tooltip:"Controls the learning rate for Mirostat."},repeat_penalty:{label:"Repeat Penalty",provider:"ollama",type:"range",min:0,max:2,step:.01,default:1.1,tooltip:"Strongly penalizes repeating tokens. A higher value reduces repetition more."}};function Ko(t,e,n){const o=n===void 0||n===""||n===null||n===e.default,s=o?"Default":n,a=o?"param-value":"param-value custom";let r="";const d=n==null||n===""?e.default:n;switch(e.type){case"range":r=`
                <input type="range" class="param-slider" data-control="slider"
                       min="${e.min}" max="${e.max}" 
                       step="${e.step}" value="${d}">
                <input type="number" class="param-input" data-control="input"
                       min="${e.min}" max="${e.max}" 
                       step="${e.step}" value="${d}">
                <button type="button" class="btn-link param-reset-btn" data-action="reset">Reset</button>
            `;break;case"number":r=`<input type="number" class="param-input-full" data-control="input" value="${d}" placeholder="${e.default}">`;break;case"text":r=`<input type="text" class="param-input-full" data-control="input" value="${d}" placeholder="${e.default}">`;break;case"textarea":r=`<textarea class="param-input-full" data-control="input" rows="3">${d}</textarea>`;break;case"select":r=`<select class="param-input-full" data-control="input">${e.options.map(l=>`<option value="${l}" ${l==d?"selected":""}>${l}</option>`).join("")}</select>`;break}return`
        <div class="param-wrapper" data-param-name="${t}">
            <div class="param-row" data-action="toggle">
                <span class="param-label" title="${e.tooltip}">${e.label}</span>
                <span class="${a}">${s}</span>
            </div>
            <div class="param-control hidden">
                ${r}
            </div>
        </div>
    `}function xn(t,e,n){if(!t)return null;let o="<h4>Core Parameters</h4>",s='<div id="ollama-section"><h4>Advanced (Ollama only)</h4>',a=!1;for(const l in Ke){const m=Ke[l],u=e?e[l]:void 0;if(m.provider==="all"||m.provider===n){const p=Ko(l,m,u);m.provider==="ollama"?(s+=p,a=!0):o+=p}}console.log("Generated Core HTML:",o),console.log("Generated Ollama HTML:",s),s+="</div>",t.innerHTML=o+s;const r=t.querySelector("#ollama-section");r&&(r.style.display=n==="ollama"&&a?"block":"none");const d=l=>{const m=l.target.closest("[data-action]");if(!m)return;const u=m.closest(".param-wrapper");if(u){if(m.dataset.action==="toggle"){const p=u.querySelector(".param-control"),h=p.classList.contains("hidden");t.querySelectorAll(".param-control:not(.hidden)").forEach(y=>y.classList.add("hidden")),h&&p.classList.remove("hidden")}else if(m.dataset.action==="reset"){const p=u.dataset.paramName,h=Ke[p];u.querySelector(".param-value").textContent="Default",u.querySelector(".param-value").classList.remove("custom"),u.querySelectorAll("input, select, textarea").forEach(y=>y.value=h.default)}}},c=l=>{const m=l.target.closest("[data-control]");if(!m)return;const u=m.closest(".param-wrapper");if(!u)return;const p=u.querySelector(".param-value"),h=u.querySelector(".param-slider"),y=u.querySelector(".param-input");h&&y&&(m.dataset.control==="slider"?y.value=l.target.value:h.value=l.target.value),p.textContent=l.target.value,p.classList.add("custom")};return t.addEventListener("click",d),t.addEventListener("input",c),{getValues:()=>{const l={};return t.querySelectorAll(".param-wrapper").forEach(m=>{const u=m.dataset.paramName;if(m.querySelector(".param-value.custom")){const p=m.querySelector('[data-control="input"], .param-input-full');if(p){const h=Ke[u];l[u]=h.type==="range"||h.type==="number"?parseFloat(p.value):p.value}}}),l},destroy:()=>{t.removeEventListener("click",d),t.removeEventListener("input",c),t.innerHTML=""}}}function An(t,e,n){const o=Sn.createRoot(n),s=()=>o.unmount();o.render(g.jsx(En.StrictMode,{children:g.jsx(t,{...e,unmount:s})}))}let le=null;function In(){const t=document.getElementById("summarization-modal");if(!t)return;const e=t.querySelector("#summary-modal-preset-select"),n=t.querySelector("#summary-modal-preset-actions .dropdown-content");if(!e||!n)return;n.innerHTML="";const o=e.options[e.selectedIndex];if(!o)return;const s=oe.hasOwnProperty(o.value),a=o.value==="custom",r=(d,c,l={})=>{const m=document.createElement("a");return m.href="#",m.textContent=d,m.dataset.action=c,l.saveAs&&(m.dataset.saveAs="true"),m};if(a||s)n.appendChild(r(s?"Save as a Copy...":"Save as New Preset...","settings:saveSummaryPreset",{saveAs:!0}));else{n.appendChild(r("Save Changes","settings:saveSummaryPreset")),n.appendChild(r("Rename...","settings:renameSummaryPreset")),n.appendChild(r("Save as New Preset...","settings:saveSummaryPreset",{saveAs:!0})),n.appendChild(document.createElement("div")).className="dropdown-divider";const d=r("Delete Preset","settings:deleteSummaryPreset");d.classList.add("is-destructive"),n.appendChild(d)}}function nn(){const t=i.getProject();if(!t||!t.globalSettings)return;const e=document.querySelector("#summarization-modal #summary-modal-preset-select");if(!e)return;const n=t.globalSettings.summarizationPromptPresets||{},o=e.value;e.innerHTML="";const s=document.createElement("optgroup");s.label="Factory Presets",e.appendChild(s);const a=document.createElement("optgroup");a.label="User Presets",e.appendChild(a);let r=!1;for(const d in n){const c=new Option(d,d);oe.hasOwnProperty(d)?s.appendChild(c):(a.appendChild(c),r=!0)}r||a.remove(),n[o]?e.value=o:(e.value="Standard",Bn()),In()}function Vo(t){const e=document.createElement("div");return e.className="item summary-log-item",e.dataset.logId=t.id,t.id===le&&e.classList.add("active"),e.innerHTML=`<span class="item-name"><span class="item-icon">💡</span> ${t.summary}</span>`,e.title=`Created: ${new Date(t.timestamp).toLocaleString()}`,e}function Qo(t){const e=document.getElementById("summary-editor-actions"),n=document.getElementById("summarize-conversation-btn");!e||!n||(e.classList.remove("hidden"),n.classList.add("hidden"),e.querySelector("#summary-editor-delete-btn").style.display="inline-flex",e.querySelector("#summary-editor-load-btn").style.display="inline-flex",e.querySelector("#summary-editor-save-btn").textContent="Save Changes")}function Zo(){const t=document.getElementById("summarization-modal");if(!t)return;const e=t.querySelector("#summary-editor-actions"),n=t.querySelector("#summarize-conversation-btn");t.querySelector(".tab-btn.active")?.dataset.tab==="settings"?(e.classList.add("hidden"),n.classList.add("hidden")):le?(e.classList.remove("hidden"),n.classList.add("hidden")):(e.classList.add("hidden"),n.classList.remove("hidden"))}function zt(t){le=t;const n=i.getProject().summaryLogs.find(o=>o.id===t);document.getElementById("summary-editor-title").value=n?n.summary:"",document.getElementById("summary-editor-content").value=n?n.content:"",n?Qo():(document.getElementById("summary-editor-actions").classList.add("hidden"),document.getElementById("summarize-conversation-btn").classList.remove("hidden")),Ln()}function Ln(){const t=document.getElementById("summary-log-list-modal");if(!t)return;const e=i.getProject();t.innerHTML="";const n=e.summaryLogs||[];if(n.length===0){t.innerHTML='<p class="no-items-message">No summaries yet.</p>';return}const o=n.reduce((s,a)=>{const r=a.sourceSessionId,d=e.chatSessions.find(c=>c.id===r);return s[r]||(s[r]={name:d?d.name:"Unknown Session",logs:[]}),s[r].logs.push(a),s},{});Object.values(o).forEach(s=>{const a=s.logs.sort((d,c)=>c.timestamp-d.timestamp),r=document.createElement("details");r.open=!0,r.innerHTML=`<summary>For: ${s.name}</summary>`,a.forEach(d=>r.appendChild(Vo(d))),t.appendChild(r)})}function kt(){const t=i.getProject(),e=t.chatSessions.find(s=>s.id===t.activeSessionId);if(!e)return;const n={summaryLogs:t.summaryLogs||[],allModels:nt(),promptTemplates:{...oe,...t.globalSettings.summarizationPromptPresets},currentSessionName:e.name,systemUtilityModel:t.globalSettings.systemUtilityAgent?.model,activeTemplate:t.globalSettings.activeSummarizationPreset,defaultPresets:oe,onApplySettings:s=>ts(s)},o=document.getElementById("react-modal-root");o&&An(ss,n,o)}function Bt(){const t=document.getElementById("summarization-modal");t&&(t.style.display="none")}function es(){const t=document.getElementById("summarization-modal");if(!t)return;t.querySelector("#summary-modal-close-btn")?.addEventListener("click",Bt),t.querySelector(".modal-close-btn")?.addEventListener("click",Bt),t.querySelector("#summarize-conversation-btn")?.addEventListener("click",Yt),t.querySelector("#summary-editor-save-btn")?.addEventListener("click",()=>{le?Mn({logId:le,title:document.getElementById("summary-editor-title").value,content:document.getElementById("summary-editor-content").value}):Tn()}),t.querySelector("#summary-editor-delete-btn")?.addEventListener("click",()=>{le&&Dn({logId:le})}),t.querySelector("#summary-editor-load-btn")?.addEventListener("click",()=>{le&&kn({logId:le})}),t.querySelector(".tab-buttons")?.addEventListener("click",o=>{if(o.target.matches(".tab-btn")){const s=o.target.dataset.tab;t.querySelectorAll(".tab-btn, .tab-content").forEach(a=>a.classList.remove("active")),o.target.classList.add("active"),t.querySelector(`.tab-content[data-tab-content="${s}"]`)?.classList.add("active"),Zo()}}),t.querySelector("#summary-log-list-modal")?.addEventListener("click",o=>{const s=o.target.closest(".summary-log-item[data-log-id]");s&&zt(s.dataset.logId)}),t.querySelector("#summary-modal-preset-select")?.addEventListener("change",()=>{Bn()}),t.querySelector("#summary-modal-prompt-textarea")?.addEventListener("input",()=>{nn()});const e=t.querySelector("#summary-modal-preset-actions");e&&e.addEventListener("click",o=>{const s=o.target.closest("a[data-action], button[data-action]");if(!s)return;o.preventDefault(),o.stopPropagation();const a=s.dataset.action;if(a==="toggle-menu")ze(o);else{const r=s.dataset.saveAs==="true";a==="settings:saveSummaryPreset"?Nn({saveAs:r}):a==="settings:renameSummaryPreset"?_n():a==="settings:deleteSummaryPreset"&&On(),s.closest(".dropdown.open")?.classList.remove("open")}});const n=document.getElementById("summary-model-value");n&&n.addEventListener("change",o=>{const s=o.target.value;if(s){const a=i.getProject();a&&a.globalSettings.systemUtilityAgent&&(a.globalSettings.systemUtilityAgent.model=s,i.updateAndPersistState(),console.log(`Summary/System model updated to: ${s}`))}}),i.bus.subscribe("ui:renderSummarizationSelector",nn),i.bus.subscribe("ui:updateSummaryActionButtons",In),i.bus.subscribe("app:settingsChanged",()=>{t&&t.style.display==="flex"&&kt()}),console.log("✅ Summarization Center UI Initialized.")}async function Yt({modelId:t,promptTemplate:e}){const n=i.getProject(),o=n.chatSessions.find(l=>l.id===n.activeSessionId);if(!o)throw new Error("Active session not found.");if(!t)throw b("Please select a model for summarization in the Settings tab.","Error"),new Error("Model for summarization not selected.");const s={...n.globalSettings.systemUtilityAgent,model:t},a=o.history.filter(l=>l.role==="user"||l.role==="assistant");if(a.length<2)throw b("Not enough new messages to summarize.","Info"),new Error("Not enough messages.");const r=a.map(l=>`${l.speaker||l.role}: ${Array.isArray(l.content)?l.content.find(m=>m.type==="text")?.text||"[multimodal content]":l.content}`).join(`
`),d=e.replace(/\$\{previousSummary\}/g,"This is a full-history summary from the beginning.").replace(/\$\{newMessages\}/g,r),c=await lo(s,[{role:"user",content:d}]);if(!c||typeof c.content!="string")throw new Error("Received an invalid or empty response from the AI summarizer.");return{title:`Summary of "${o.name}" at ${new Date().toLocaleTimeString()}`,content:c.content}}function Tn({title:t,content:e}){const n=i.getProject(),o=n.chatSessions.find(a=>a.id===n.activeSessionId);if(!n||!o||!t||!e)return;const s={id:`sum_${Date.now()}`,summary:t,content:e,timestamp:Date.now(),sourceSessionId:o.id};n.summaryLogs||(n.summaryLogs=[]),n.summaryLogs.push(s),i.updateAndPersistState(),b("New summary log saved!","Success"),i.bus.publish("summary:listChanged",{newlyCreatedId:s.id})}function Mn({logId:t,title:e,content:n}){if(!t||!e||!n)return;const s=i.getProject().summaryLogs.find(a=>a.id===t);s&&(s.summary=e,s.content=n,i.updateAndPersistState(),b("Changes saved!","Success"),Ln())}function Dn({logId:t}){if(!confirm("Are you sure you want to delete this summary log?"))return;const e=i.getProject();e.summaryLogs=e.summaryLogs.filter(n=>n.id!==t),e.chatSessions.forEach(n=>{n.summaryState?.activeSummaryId===t&&(n.summaryState.activeSummaryId=null)}),i.updateAndPersistState(),b("Log deleted.","Success"),zt(null)}function kn({logId:t}){const e=i.getProject(),n=e.chatSessions.find(a=>a.id===e.activeSessionId),o=e.summaryLogs.find(a=>a.id===t);if(!n||!o)return;n.summaryState={activeSummaryId:o.id};const s={role:"system",content:`[System: Context loaded from summary: "${o.summary}"]`,isSummary:!0};n.history.push(s),i.updateAndPersistState(),i.bus.publish("ui:renderMessages"),Bt(),b("Summary loaded into context!","Success")}function Bn(){const e=document.getElementById("summary-modal-preset-select").value;if(e==="custom")return;const n=i.getProject(),o={...oe,...n.globalSettings.summarizationPromptPresets};o[e]&&(document.getElementById("summary-modal-prompt-textarea").value=o[e],i.bus.publish("ui:renderSummarizationSelector"),i.bus.publish("ui:updateSummaryActionButtons"))}async function Nn({saveAs:t,presetName:e,content:n}){const o=n.trim();if(!o){b("Preset content cannot be empty.","Error");return}let s=e;const a=i.getProject(),r=oe.hasOwnProperty(s);if(t||r||!s){const d=prompt("Enter a name for this new preset:",r?`${s} (Copy)`:"My Custom Preset");if(!d||!d.trim())return;s=d.trim()}a.globalSettings.summarizationPromptPresets[s]&&s!==e&&!confirm(`A preset named '${s}' already exists. Overwrite?`)||(a.globalSettings.summarizationPromptPresets[s]=o,a.globalSettings.activeSummarizationPreset=s,i.setProject(a),await i.updateAndPersistState(),i.bus.publish("summary:presetsChanged",{newSelectedName:s}),b(`Preset '${s}' saved!`,"Success"))}async function _n({presetName:t}){if(oe.hasOwnProperty(t)||t==="custom")return;const e=prompt(`Enter new name for "${t}":`,t);if(!e||!e.trim()||e.trim()===t)return;const n=i.getProject(),o=e.trim();if(n.globalSettings.summarizationPromptPresets[o]){b(`A preset named '${o}' already exists.`,"Error");return}n.globalSettings.summarizationPromptPresets[o]=n.globalSettings.summarizationPromptPresets[t],delete n.globalSettings.summarizationPromptPresets[t],n.globalSettings.activeSummarizationPreset=o,i.setProject(n),await i.updateAndPersistState(),i.bus.publish("summary:presetsChanged"),b(`Preset renamed to '${o}'!`,"Success")}async function On({presetName:t}){if(!oe.hasOwnProperty(t)&&confirm(`Delete user preset "${t}"?`)){const e=i.getProject();delete e.globalSettings.summarizationPromptPresets[t],e.globalSettings.activeSummarizationPreset===t&&(e.globalSettings.activeSummarizationPreset="Standard"),i.setProject(e),await i.updateAndPersistState(),i.bus.publish("summary:presetsChanged"),b(`Preset '${t}' deleted.`,"Success")}}function ts({model:t,templateName:e}){const n=i.getProject();!n||!n.globalSettings||(t&&n.globalSettings.systemUtilityAgent&&(n.globalSettings.systemUtilityAgent.model=t),n.globalSettings.activeSummarizationPreset=e,i.setProject(n),i.updateAndPersistState(),b("Settings Applied!","Success"))}const ns=A.memo(({selectedLog:t,currentSessionName:e,isGenerating:n,onGenerate:o,editorTitle:s,setEditorTitle:a,editorContent:r,setEditorContent:d})=>g.jsxs(g.Fragment,{children:[g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[g.jsx("h4",{children:t?"Edit Summary":`Generate new summary for "${e}"`}),!t&&g.jsx("button",{className:`btn ${n?"is-loading":""}`,onClick:o,disabled:n,children:"✨ Generate New Summary"})]}),g.jsxs("div",{className:"form-group",style:{flexGrow:1,display:"flex",flexDirection:"column"},children:[g.jsx("label",{children:"Summary Title"}),g.jsx("input",{type:"text",value:s,onChange:c=>a(c.target.value),placeholder:"A concise title..."}),g.jsx("label",{style:{marginTop:"10px"},children:"Summary Content (Editable)"}),g.jsx("textarea",{style:{flexGrow:1,resize:"none"},value:r,onChange:c=>d(c.target.value)})]})]})),os=A.memo(({selectedModel:t,setSelectedModel:e,allModels:n,selectedTemplateName:o,handleTemplateChange:s,promptTemplates:a,templateContent:r,setTemplateContent:d,defaultPresets:c,handleActionClick:l})=>{const m=Object.keys(a).filter(p=>c.hasOwnProperty(p)).sort(),u=Object.keys(a).filter(p=>!c.hasOwnProperty(p)).sort();return g.jsxs(g.Fragment,{children:[g.jsx("h4",{children:"Settings"}),g.jsxs("div",{className:"form-group",children:[g.jsx("label",{children:"Summarization Model"}),g.jsxs("select",{value:t,onChange:p=>e(p.target.value),children:[g.jsx("option",{value:"",children:"-- Select a Model --"}),n.map(p=>g.jsx("option",{value:p.id,children:p.name},p.id))]})]}),g.jsxs("div",{className:"form-group",style:{flexGrow:1,display:"flex",flexDirection:"column"},children:[g.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center",marginBottom:"10px"},children:[g.jsx("label",{style:{flexGrow:1,marginBottom:0},children:"Summarization Prompt Template"}),g.jsxs("div",{className:"dropdown align-right",children:[g.jsx("button",{className:"btn btn-small btn-secondary",onClick:p=>p.currentTarget.parentElement.classList.toggle("open"),children:"Actions ▾"}),g.jsx("div",{className:"dropdown-content",children:o&&!c[o]?g.jsxs(g.Fragment,{children:[g.jsx("a",{href:"#",onClick:()=>l("settings:saveSummaryPreset",{saveAs:!1,presetName:o,content:r}),children:"Save Changes"}),g.jsx("a",{href:"#",onClick:()=>l("settings:renameSummaryPreset",{presetName:o}),children:"Rename..."}),g.jsx("a",{href:"#",onClick:()=>l("settings:saveSummaryPreset",{saveAs:!0,content:r}),children:"Save as New Preset..."}),g.jsx("div",{className:"dropdown-divider"}),g.jsx("a",{href:"#",className:"is-destructive",onClick:()=>l("settings:deleteSummaryPreset",{presetName:o}),children:"Delete Preset"})]}):g.jsx("a",{href:"#",onClick:()=>l("settings:saveSummaryPreset",{saveAs:!0,content:r}),children:"Save as New Preset..."})})]})]}),g.jsxs("select",{value:o,onChange:s,children:[g.jsx("optgroup",{label:"Factory Presets (Read-only)",children:m.map(p=>g.jsx("option",{value:p,children:p},p))}),u.length>0&&g.jsx("optgroup",{label:"User Presets",children:u.map(p=>g.jsx("option",{value:p,children:p},p))})]}),g.jsx("textarea",{style:{flexGrow:1,resize:"none",marginTop:"10px"},value:r,onChange:p=>d(p.target.value)})]})]})});function ss({unmount:t,summaryLogs:e,allModels:n,promptTemplates:o,currentSessionName:s,systemUtilityModel:a,activeTemplate:r,defaultPresets:d,onApplySettings:c}){const[l,m]=A.useState("logs"),[u,p]=A.useState(null),[h,y]=A.useState(""),[w,T]=A.useState(""),[O,I]=A.useState(""),[$,F]=A.useState(a||""),[W,z]=A.useState(o),[X,v]=A.useState(r||"Standard"),[M,U]=A.useState(o[r||"Standard"]||""),[q,se]=A.useState(!1);A.useEffect(()=>{u?(T(u.summary),I(u.content)):(T(""),I(""))},[u]),A.useEffect(()=>{const x=()=>{const he=i.getProject(),Je={...oe,...he.globalSettings.summarizationPromptPresets},bt=he.globalSettings.activeSummarizationPreset||"Standard";z(Je),v(bt)},Be=({newlyCreatedId:he})=>{if(he){const Je=i.getProject().summaryLogs.find(bt=>bt.id===he);Je&&p(Je)}},Zt=i.bus.subscribe("summary:presetsChanged",x),Xe=i.bus.subscribe("summary:listChanged",Be);return()=>{Zt(),Xe()}},[]),A.useEffect(()=>{U(W[X]||"")},[X,W]);const H=A.useMemo(()=>h?e.filter(x=>x.summary.toLowerCase().includes(h.toLowerCase())):e,[h,e]),ie=x=>{p(x),m("logs")},fe=async()=>{se(!0),p(null);try{const x=await Yt({modelId:$,promptTemplate:M});T(x.title),I(x.content),p({id:"new_log",summary:x.title,content:x.content})}catch(x){console.error("Summary generation failed:",x)}finally{se(!1)}},V=(x,Be)=>{i.bus.publish(x,Be)},Pe=x=>{v(x.target.value)};return g.jsx("div",{id:"summarization-modal",className:"modal-overlay",style:{display:"flex"},children:g.jsxs("div",{className:"modal-box is-resizable",children:[g.jsxs("div",{className:"modal-header",children:[g.jsx("h3",{children:"Conversation Summary Center"}),g.jsx("button",{className:"btn-icon",title:"Settings",onClick:()=>m(l==="logs"?"settings":"logs"),children:g.jsx("span",{className:"material-symbols-outlined",children:l==="settings"?"article":"settings"})}),g.jsx("button",{className:"modal-close-btn",onClick:t,children:"×"})]}),g.jsxs("div",{className:"modal-body",children:[g.jsxs("div",{className:"log-list-column",children:[g.jsx("input",{type:"text",placeholder:"Search summaries...",value:h,onChange:x=>y(x.target.value),style:{marginBottom:"15px"}}),g.jsx("div",{id:"summary-log-list-modal",className:"item-list",children:H.map(x=>g.jsx("div",{className:`item summary-log-item ${u?.id===x.id?"active":""}`,onClick:()=>ie(x),children:g.jsxs("span",{className:"item-name",children:[g.jsx("span",{className:"item-icon",children:"💡"})," ",x.summary]})},x.id))})]}),g.jsx("div",{className:"log-editor-column",children:l==="logs"?g.jsx(ns,{selectedLog:u,currentSessionName:s,isGenerating:q,onGenerate:fe,editorTitle:w,setEditorTitle:T,editorContent:O,setEditorContent:I}):g.jsx(os,{selectedModel:$,setSelectedModel:F,allModels:n,selectedTemplateName:X,handleTemplateChange:Pe,promptTemplates:W,templateContent:M,setTemplateContent:U,defaultPresets:d,handleActionClick:V})})]}),g.jsxs("div",{className:"modal-actions",children:[g.jsx("button",{className:"btn btn-secondary",onClick:t,children:"Close"}),l==="logs"&&u&&g.jsxs(g.Fragment,{children:[u.id!=="new_log"&&g.jsx("button",{className:"btn btn-danger",onClick:()=>V("summary:deleteLog",{logId:u.id}),children:"Delete Log"}),u.id!=="new_log"&&g.jsx("button",{className:"btn",onClick:()=>V("summary:loadToContext",{logId:u.id}),children:"Load to Context"}),g.jsx("button",{className:"btn",onClick:()=>V(u.id==="new_log"?"summary:saveNewLog":"summary:saveEdit",{logId:u.id,title:w,content:O}),children:u.id==="new_log"?"Save New Log":"Save Changes"})]}),l==="settings"&&g.jsx("button",{className:"btn",onClick:()=>c({model:$,templateName:X}),children:"Apply Settings"})]})]})})}const L={};function as(){L.appWrapper=document.querySelector(".app-wrapper"),L.toggleRightSidebarBtn=document.getElementById("toggle-right-sidebar-btn"),L.sessionsPanel=document.querySelector(".sessions-panel"),L.hamburgerBtn=document.getElementById("hamburger-btn"),L.closeSidebarBtn=document.querySelector('.sessions-panel .mobile-only[title="Close Sidebar"]'),L.mobileOverlay=document.getElementById("mobile-overlay"),L.composerPanel=document.querySelector(".composer-panel"),L.resizerRow=document.getElementById("resizer-row")}function rs(t,e){if(!t||!e)return;let n=0,o=0,s=0,a=!1;const r=l=>{l.preventDefault(),t.classList.add("active"),document.body.style.cursor="row-resize",e.classList.contains("collapsed")&&(e.classList.remove("collapsed"),t.classList.remove("collapsed"),i.bus.publish("composer:visibilityChanged")),n=l.clientY,o=e.getBoundingClientRect().height,document.addEventListener("mousemove",d),document.addEventListener("mouseup",c)},d=l=>{s=l.clientY,a||(window.requestAnimationFrame(()=>{const m=s-n;let u=o-m;const p=parseInt(getComputedStyle(e).minHeight,10)||50;u<p&&(u=p),e.style.flexBasis=`${u}px`,a=!1}),a=!0)},c=()=>{t.classList.remove("active"),document.body.style.cursor="",document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c)};t.addEventListener("mousedown",r)}function is(){if(!L.sessionsPanel)return;const t=e=>{e.stopPropagation(),e.preventDefault(),L.sessionsPanel.classList.remove("is-open"),L.mobileOverlay?.classList.remove("active")};L.hamburgerBtn?.addEventListener("click",e=>{window.innerWidth<=1024?(L.sessionsPanel.classList.add("is-open"),L.mobileOverlay?.classList.add("active")):L.appWrapper?.classList.toggle("sidebar-collapsed")}),L.mobileOverlay?.addEventListener("click",t,!0),L.closeSidebarBtn?.addEventListener("click",t,!0)}function ls(){as(),L.resizerRow&&L.composerPanel&&rs(L.resizerRow,L.composerPanel),is(),cs(),console.log("Core layout manager initialized.")}function cs(){!L.toggleRightSidebarBtn||!L.appWrapper||L.toggleRightSidebarBtn.addEventListener("click",()=>{L.appWrapper.classList.toggle("right-sidebar-collapsed"),L.appWrapper.classList.contains("right-sidebar-collapsed")||i.bus.publish("studio:rendered")})}function ds(){document.addEventListener("keydown",t=>{const e=document.querySelector('.modal-overlay[style*="display: flex"]'),n=document.getElementById("settings-panel"),o=n?.classList.contains("visible");if(!(!e&&!o)){if(t.key==="Escape"){if(t.preventDefault(),e){const s=e.querySelector(".btn-secondary")||e.querySelector(".modal-actions .btn");s&&s.click()}else if(o){const s=n.querySelector(".close-settings-btn");s&&s.click()}}if(t.key==="Enter"&&!t.shiftKey){if(t.target.tagName==="TEXTAREA"||t.target.tagName==="BUTTON")return;if(e){t.preventDefault();const s=e.querySelector(".modal-actions .btn:not(.btn-secondary):not(.btn-danger)");if(s)s.click();else{const a=e.querySelector(".modal-actions .btn");a&&a.click()}}}}}),console.log("Global keyboard bindings initialized.")}function vt(t){const e=document.getElementById("project-title");if(e){const n=i.isUserDirty(),o=t||i.getProject()?.name||"Untitled";e.textContent=n?`${o} *`:o}}function us(){const t=document.getElementById("save-project-modal"),e=document.getElementById("project-name-input"),n=i.getProject();e.value=n?`${n.name} - Copy`:"Untitled Project",t.style.display="flex",e.focus(),e.select()}function on(){const t=document.getElementById("save-project-modal");t.style.display="none"}function ms(t){t&&t.stopPropagation(),document.getElementById("custom-entity-selector-wrapper").classList.toggle("open")}function ps(t){const e=t.indexOf("_"),n=t.substring(0,e),o=t.substring(e+1);i.bus.publish("entity:select",{type:n,name:o}),document.getElementById("custom-entity-selector-wrapper").classList.remove("open")}function Ve(){const t=i.getProject();if(!t||!t.globalSettings)return;const e=document.getElementById("entitySelector"),n=document.getElementById("custom-entity-selector-options"),o=document.getElementById("custom-entity-selector-icon"),s=document.getElementById("custom-entity-selector-text");e.innerHTML="",n.innerHTML="";const a=(c,l,m,u)=>{const p=`${c}_${l}`,h=document.createElement("div");h.className="custom-select-option",h.innerHTML=`<span class="item-icon">${m}</span> <span>${l}</span>`,h.addEventListener("click",()=>ps(p)),u.appendChild(new Option(`${m} ${l}`,p)),n.appendChild(h)},r=t.agentPresets||{};if(Object.keys(r).length>0){const c=document.createElement("optgroup");c.label="Agent Presets",e.appendChild(c);const l=document.createElement("div");l.className="custom-select-group",l.textContent="Agent Presets",n.appendChild(l),Object.keys(r).forEach(m=>{a("agent",m,r[m].icon||"🤖",c)})}const d=t.agentGroups||{};if(Object.keys(d).length>0){const c=document.createElement("optgroup");c.label="Agent Groups",e.appendChild(c);const l=document.createElement("div");l.className="custom-select-group",l.textContent="Agent Groups",n.appendChild(l),Object.keys(d).forEach(m=>{a("group",m,"🤝",c)})}if(t.activeEntity){const{type:c,name:l}=t.activeEntity;e.value=`${c}_${l}`,c==="agent"&&r[l]?(o.textContent=r[l].icon||"🤖",s.textContent=l):c==="group"?(o.textContent="🤝",s.textContent=l):(o.textContent="❔",s.textContent="Select...")}}function gs(){i.bus.subscribe("project:loaded",n=>{vt(n.projectData.name),Ve()}),i.bus.subscribe("project:nameChanged",n=>vt(n)),i.bus.subscribe("userDirty:changed",()=>vt()),i.bus.subscribe("entity:selected",Ve),i.bus.subscribe("agent:listChanged",Ve),i.bus.subscribe("group:listChanged",Ve),i.bus.subscribe("ui:showSaveAsModal",us);const t=document.querySelector(".sidebar-bottom-row .dropdown");if(t){const n=t.querySelector("button");n&&n.addEventListener("click",ze),t.addEventListener("click",o=>{const s=o.target.closest("a");if(!s)return;const a=s.dataset.action;if(a){o.preventDefault();const r={newProject:{name:"project:new"},openProject:{name:"project:open"},saveProject:{name:"project:save",data:!1},saveProjectAs:{name:"project:save",data:!0},exportChat:{name:"project:exportChat"}};r[a]&&i.bus.publish(r[a].name,r[a].data),t.classList.remove("open")}})}const e=document.getElementById("save-project-modal");e&&e.addEventListener("click",n=>{if(n.target.matches(".btn:not(.btn-secondary)")){const o=document.getElementById("project-name-input").value.trim();o?(i.bus.publish("project:saveConfirm",{projectName:o}),on()):b("Please enter a project name.")}else(n.target.matches(".btn-secondary")||n.target===e)&&on()}),document.getElementById("load-project-input")?.addEventListener("change",n=>i.bus.publish("project:fileSelectedForOpen",n)),document.getElementById("custom-entity-selector-trigger")?.addEventListener("click",ms),console.log("Project UI Initialized with definitive listeners.")}let sn=!1;function St(t){const e=i.getProject();let n="💬";t.linkedEntity?.type==="agent"&&e.agentPresets[t.linkedEntity.name]?n=e.agentPresets[t.linkedEntity.name].icon||"🤖":t.linkedEntity?.type==="group"&&(n="🤝");const o=document.createElement("div");o.className="item session-item",o.dataset.sessionId=t.id,t.pinned&&o.classList.add("pinned");const s=t.name||"New Chat";return o.innerHTML=`
        <div class="item-header">
            <span class="item-name"><span class="item-icon">${n}</span> ${s}</span>
            <div class="item-actions">
                <div class="dropdown align-right">
                    <button class="btn-icon" data-action="toggle-menu" title="More options">&#8942;</button>
                    <div class="dropdown-content">
                        <a href="#" data-action="pin">${t.pinned?"Unpin":"Pin"} Session</a>
                        <a href="#" data-action="rename">Rename</a>
                        <a href="#" data-action="clone">Clone Session</a>
                        <a href="#" data-action="archive">${t.archived?"Unarchive":"Archive"} Session</a>                        <a href="#" data-action="download">Download Chat</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" data-action="delete" class="is-destructive">
                            <span class="material-symbols-outlined">delete</span> Delete Session
                        </a>                    
                    </div>
                </div>
            </div>
        </div>
    `,o}function $n(t){document.querySelectorAll(".session-item").forEach(n=>{n.classList.toggle("active",n.dataset.sessionId===t)})}function De(){const t=i.getProject();if(!t)return;const e=document.getElementById("pinnedSessionList"),n=document.getElementById("sessionListContainer"),o=document.getElementById("archivedSessionList"),s=document.getElementById("archivedSessionsSection");if(!e||!n||!o||!s)return;e.innerHTML="",n.innerHTML="",o.innerHTML="";const a=t.chatSessions||[],r=a.filter(l=>l.isPinned&&!l.archived),d=a.filter(l=>!l.isPinned&&!l.archived),c=a.filter(l=>l.archived);r.sort((l,m)=>m.updatedAt-l.updatedAt).forEach(l=>{e.appendChild(St(l))}),d.sort((l,m)=>m.updatedAt-l.updatedAt).forEach(l=>{n.appendChild(St(l))}),c.sort((l,m)=>m.updatedAt-l.updatedAt).forEach(l=>{o.appendChild(St(l))}),s.classList.toggle("hidden",c.length===0),$n(t.activeSessionId)}function fs(){if(sn)return;sn=!0,i.bus.subscribe("project:loaded",De),i.bus.subscribe("session:listChanged",De),i.bus.subscribe("session:loaded",()=>$n(i.getProject()?.activeSessionId));const t=document.querySelector(".sessions-panel");t&&t.addEventListener("click",e=>{const n=e.target,o=n.closest(".dropdown-content a[data-action]");if(o){e.preventDefault(),e.stopPropagation();const r=n.closest(".session-item[data-session-id]");if(!r)return;const d=r.dataset.sessionId,c=o.dataset.action;i.bus.publish(`session:${c}`,{sessionId:d,event:e}),o.closest(".dropdown.open")?.classList.remove("open");return}if(n.closest('button[data-action="toggle-menu"]')){e.preventDefault(),e.stopPropagation(),ze(e);return}if(n.closest("#new-chat-btn")){i.bus.publish("session:new");return}const a=n.closest(".session-item[data-session-id]");if(a){const r=a.dataset.sessionId;i.getProject().activeSessionId!==r&&we(r)}}),console.log("✅ Session UI and its dedicated event listener initialized ONCE.")}const Wt=()=>document.querySelector("#composer-editor .composer-content-area");function Un(t){const e=i.getProject(),n=e?.chatSessions.find(o=>o.id===e.activeSessionId);n&&n.composerContent!==t&&(n.composerContent=t,i.updateAndPersistState())}function Nt(){const t=Wt();if(!t)return;const e=i.getProject();if(!e?.activeSessionId){t.innerHTML="";return}const n=e.chatSessions.find(o=>o.id===e.activeSessionId);t.innerHTML=n?.composerContent||""}function hs({content:t}){const e=Wt(),n=document.getElementById("composer-panel");!e||!n||(n.classList.contains("collapsed")&&(n.classList.remove("collapsed"),document.getElementById("resizer-row")?.classList.remove("collapsed"),i.bus.publish("composer:visibilityChanged")),e.textContent.trim()!==""&&(e.innerHTML+="<br><hr><br>"),e.innerHTML+=t,e.scrollTop=e.scrollHeight,Un(e.innerHTML))}function ys(t){const e=document.createElement("div");return e.innerHTML=t,e.querySelectorAll("*").forEach(n=>{if(n.removeAttribute("style"),n.classList.length>0){const o=[];for(let s=0;s<n.classList.length;s++)n.classList[s].startsWith("hljs-")||o.push(n.classList[s]);o.forEach(s=>n.classList.remove(s))}}),e.innerHTML}function bs(){const t=Wt();if(!t)return;const e=t.innerHTML;if(!e.trim()){b("Composer is empty. Nothing to export.","Info");return}const o=`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Composer Export</title>
            
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
            
            <style>
                /* 2. สไตล์พื้นฐานของหน้าเว็บที่ Export */
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
                    line-height: 1.6; 
                    padding: 20px; 
                    max-width: 800px; 
                    margin: auto; 
                }
                pre {
                    background-color: #f6f8fa; /* สีพื้นหลัง Code Block สำหรับไฟล์ที่ Export */
                    padding: 16px;
                    border-radius: 6px;
                    overflow-x: auto;
                }
                code {
                    font-family: 'Fira Mono', 'Menlo', monospace;
                }
            </style>
        </head>
        <body>
            ${ys(e)}
        </body>
        </html>
    `,s=new Blob([o],{type:"text/html;charset=utf-8"}),a=URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download=`composer-export-${Date.now()}.html`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}function vs(){const t=document.getElementById("color-palette");if(!t)return;const e=["#000000","#E03131","#C2255C","#9C36B5","#6741D9","#3B5BDB","#1971C2","#0C8599","#099268","#2F9E44","#66A80F","#F08C00","#E8590C","#868E96","#495057"];t.innerHTML="",e.forEach(n=>{const o=document.createElement("div");o.className="color-swatch",o.style.backgroundColor=n,o.dataset.color=n,t.appendChild(o)})}function je(){const t=document.querySelector(".composer-tools-area");if(!t)return;let e=!1;const n=document.queryCommandValue("formatBlock").toLowerCase();for(const s of["H1","H2","H3","P"]){const a=t.querySelector(`button[data-value="${s}"]`);a&&(n===`<${s.toLowerCase()}>`?(a.classList.add("is-active"),s!=="P"&&(e=!0)):a.classList.remove("is-active"))}["bold","italic","underline","strikeThrough"].forEach(s=>{const a=t.querySelector(`button[data-command="${s}"]`);if(a){const r=s==="bold"&&e?!1:document.queryCommandState(s);a.classList.toggle("is-active",r)}})}function Ss(t){const e=document.querySelector("#composer-editor .composer-content-area");e&&(e.innerHTML="")}function Es(){const t=document.getElementById("composer-panel"),e=document.querySelector("#composer-editor .composer-content-area"),n=document.getElementById("mobile-composer-toggle");document.getElementById("composer-editor");const o=document.querySelector(".composer-tools-area"),s=document.getElementById("composer-collapse-btn"),a=document.getElementById("composer-expand-btn"),r=document.getElementById("export-composer-btn");if(!t||!e){console.error("Composer UI cannot initialize: Core elements not found.");return}const d=()=>{t.classList.contains("collapsed"),t.classList.toggle("collapsed");const p=t.classList.contains("collapsed");n&&n.classList.toggle("is-open",!p),i.bus.publish("composer:visibilityChanged")};n&&n.addEventListener("click",d);const c=document.getElementById("resizer-row");c&&c.addEventListener("mousedown",p=>{if(window.innerWidth<=768){p.preventDefault();return}}),i.bus.subscribe("project:loaded",Nt),i.bus.subscribe("session:loaded",Nt),i.bus.subscribe("composer:append",hs),i.bus.subscribe("ui:toggleComposer",d),e.addEventListener("focus",()=>{document.execCommand("formatBlock",!1,"p"),je()}),["click","keyup","focus"].forEach(p=>{e.addEventListener(p,()=>{setTimeout(je,1)})}),document.addEventListener("selectionchange",()=>{document.activeElement===e&&je()});const m=co(()=>Un(e.innerHTML),500);e.addEventListener("input",m),["keyup","mouseup"].forEach(p=>e.addEventListener(p,je)),document.addEventListener("selectionchange",()=>{document.activeElement===e&&je()}),o&&(vs(),o.addEventListener("mousedown",p=>{p.preventDefault();const h=p.target.closest("button, .color-swatch");if(h){if(e.focus(),h.id==="color-picker-btn"){h.parentElement.classList.toggle("open");return}if(h.classList.contains("color-swatch"))document.execCommand("foreColor",!1,h.dataset.color),h.closest(".dropdown")?.classList.remove("open");else{const y=h.dataset.command;if(y){let w=h.dataset.value||null;y==="formatBlock"&&w&&(w=`<${w}>`),document.execCommand(y,!1,w)}}je()}})),r&&r.addEventListener("click",bs),s&&s.addEventListener("click",d),a&&a.addEventListener("click",()=>{const p=t.style.flexBasis&&parseInt(t.style.flexBasis,10)>window.innerHeight*.5;t.style.flexBasis=p?"35vh":"90vh"}),console.log("✅ Composer UI Initialized with definitive patches.")}const ws=(t="sid")=>`${t}_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,ft=()=>i.getProject(i.activeProjectId);function Fn(){const t=i.getProject(),e=t?.activeEntity;if(!t||!e)return;const n={id:`sid_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:"New Chat",history:[],composerContent:"",createdAt:Date.now(),updatedAt:Date.now(),pinned:!1,archived:!1,linkedEntity:{...e},summaryState:{activeSummaryId:null,summarizedUntilIndex:-1},groupChatState:{isRunning:!1,awaitsUserInput:!1,turnQueue:[],currentJob:null,error:null}};t.chatSessions.unshift(n),t.activeSessionId=n.id,i.setProject(t),we(n.id)}function we(t){const e=i.getProject();if(!e)return;if(!t){e.activeSessionId=null,i.setProject(e),i.bus.publish("session:cleared");return}const n=e.chatSessions.find(o=>o.id===t);if(!n){console.warn(`Session with ID ${t} not found. Loading most recent as fallback.`);const o=[...e.chatSessions].filter(s=>!s.archived).sort((s,a)=>a.updatedAt-s.updatedAt)[0];we(o?o.id:null);return}e.activeSessionId=t,n.linkedEntity&&(e.activeEntity={...n.linkedEntity}),i.setProject(e),i.updateAndPersistState(),i.bus.publish("session:loaded",{session:n})}function Ps({sessionId:t}){const e=i.getProject(),n=e?.chatSessions.find(s=>s.id===t);if(!n)return;const o=prompt("Enter new name:",n.name);o&&o.trim()&&o.trim()!==n.name&&(n.name=o.trim(),n.updatedAt=Date.now(),i.updateAndPersistState(),i.bus.publish("session:listChanged"),t===e.activeSessionId&&i.bus.publish("ui:updateChatTitle",{title:n.name}))}async function js({sessionId:t}){if(!confirm("Are you sure you want to delete this chat session? This cannot be undone."))return;const e=i.getProject(),n=e.chatSessions.findIndex(o=>o.id===t);if(n!==-1){if(e.chatSessions.splice(n,1),await He(Me,"readwrite","delete",t),e.activeSessionId===t){const o=[...e.chatSessions].filter(s=>!s.archived).sort((s,a)=>a.updatedAt-s.updatedAt)[0];e.activeSessionId=o?o.id:null,we(e.activeSessionId)}else i.bus.publish("session:listChanged");i.updateAndPersistState()}}function Cs(t,e){e?.stopPropagation();const n=ft(),o=n?.chatSessions.find(s=>s.id===t);o&&(o.pinned=!o.pinned,o.updatedAt=Date.now(),i.updateAndPersistState(n),De())}function xs(t,e){e?.stopPropagation();const n=ft(),o=n?.chatSessions.find(a=>a.id===t);if(!o){b("Error: Could not find session to clone.","Error");return}const s=JSON.parse(JSON.stringify(o));s.id=ws(),s.name=`${o.name} (Copy)`,s.createdAt=Date.now(),s.updatedAt=Date.now(),s.pinned=!1,s.archived=!1,n.chatSessions.unshift(s),n.activeSessionId=s.id,i.updateAndPersistState(n),we(s.id)}function As(t,e){e?.stopPropagation();const n=ft(),o=n?.chatSessions.find(s=>s.id===t);if(o)if(o.archived=!o.archived,o.archived&&(o.pinned=!1),o.updatedAt=Date.now(),n.activeSessionId===t&&o.archived){const s=n.chatSessions.find(a=>!a.archived);n.activeSessionId=s?s.id:null,i.updateAndPersistState(n),we(n.activeSessionId)}else i.updateAndPersistState(n),De()}async function Rn(t){const e=t||ft()?.chatSessions;if(!e)return;const n=mo();if(!n){console.error("[SaveAllSessions] Cannot save, DB not available.");return}const o=n.transaction(Me,"readwrite"),s=o.objectStore(Me);for(const a of e)s.put(a);return new Promise((a,r)=>{o.oncomplete=()=>a(),o.onerror=()=>r(o.error)})}function Is(t){try{const e=i.getProject();if(!e)throw new Error("Project not found.");const n=t?.sessionId||e.activeSessionId;if(!n)throw new Error("No session is active or selected for download.");console.log(`Attempting to download session with ID: ${n}`);const o=e.chatSessions.find(m=>m.id===n);if(!o)throw new Error(`Session with ID ${n} could not be found.`);let s=`Chat Session: ${o.name||"Untitled Session"}
`;s+=`Exported on: ${new Date().toLocaleString()}
`,o.linkedEntity&&(s+=`Associated Entity: ${o.linkedEntity.name} (${o.linkedEntity.type})
`),s+=`============================================

`;const a=o.history||[];a.length===0?s+="[This session has no messages.]":a.forEach(m=>{const u=m.timestamp?uo(m.timestamp):"No Timestamp",p=(m.speaker||m.role||"unknown").toUpperCase(),h=Array.isArray(m.content)?m.content.find(y=>y.type==="text")?.text||"[multimodal content]":m.content;s+=`[${u}] ${p}:
${h}

--------------------------------

`}),console.log(`Final text content length: ${s.length}`);const r=new Blob([s],{type:"text/plain;charset=utf-8"}),d=URL.createObjectURL(r),c=document.createElement("a"),l=(o.name||"untitled").replace(/[^a-z0-9]/gi,"_").toLowerCase();c.download=`session-export-${l}.txt`,c.href=d,document.body.appendChild(c),c.click(),setTimeout(()=>{document.body.removeChild(c),URL.revokeObjectURL(d),console.log("Download initiated and cleanup complete.")},100)}catch(e){console.error("Download Chat Session failed:",e),b(`Failed to download chat: ${e.message}`,"Error")}}function Ls({height:t}){const e=i.getProject(),n=e?.chatSessions.find(o=>o.id===e.activeSessionId);n&&t&&(n.composerHeight=t)}async function Ts(){const t=i.getProject(),e=t?.chatSessions.find(n=>n.id===t.activeSessionId);if(!e){console.warn("[AutoSave] Could not find active session to save.");return}try{await He(Me,"readwrite","put",e)}catch(n){console.error(`[AutoSave] Failed to save active session (${e.id}):`,n)}}function Ms({sessionId:t,newName:e}){const n=i.getProject();if(!n)return;const o=n.chatSessions.find(s=>s.id===t);!o||o.name!=="New Chat"||(o.name=e,o.updatedAt=Date.now(),i.updateAndPersistState(),i.bus.publish("session:listChanged"),n.activeSessionId===t&&i.bus.publish("ui:updateChatTitle",{title:e}))}async function Ds(){const t=i.getProject();if(!t||!t.id)return console.warn("[AutoSave] Aborted: Project not available for saving."),!1;console.log("[AutoSave] Persisting essential data to IndexedDB...");try{return await Xt(),await Ts(),console.log("[AutoSave] Essential project state successfully persisted."),!0}catch(e){return console.error("[AutoSave] Failed to persist project state:",e),!1}}function ks(){let t;i.bus.subscribe("autosave:required",()=>{clearTimeout(t),t=setTimeout(async()=>{i.isAutoSaveDirty()&&await Ds()&&i.setAutoSaveDirty(!1)},2e3)})}function Bs(){i.isUserDirty()?(i.setState("pendingActionAfterSave",()=>{document.getElementById("load-project-input").click()}),wn()):document.getElementById("load-project-input").click()}async function _t(){console.log("Proceeding with creating a new project...");try{const t=localStorage.getItem("lastActiveProjectId");t&&(await go(t),localStorage.removeItem("lastActiveProjectId"));const e=await fetch("/PromptPrim/default-project.prim");if(!e.ok)throw new Error(`Could not fetch default project file. Status: ${e.status}`);const n=await e.json(),o=fo();o&&o.systemAgentDefaults&&(n.globalSettings.systemUtilityAgent=o.systemAgentDefaults.utilityAgent,n.globalSettings.summarizationPromptPresets=o.systemAgentDefaults.summarizationPresets),n.globalSettings.summarizationPromptPresets={...oe},n.id=`proj_${Date.now()}`,await Ht(n.id),await ht(n,!0)}catch(t){console.error("Failed to proceed with creating a new project:",t),b("Could not create a new project. Please check the browser console for more details.","Error")}}function Ot(){i.isUserDirty()?(i.setState("pendingActionAfterSave",_t),wn()):_t()}function Ns(t){const e=t.target.files[0];if(!e)return;console.log(`[OpenProject] File selected: ${e.name}. Reading file...`);const n=new FileReader;n.onload=async o=>{try{const s=o.target.result;console.log("[OpenProject] File read complete. Parsing JSON...");const a=JSON.parse(s);if(!a.id||!a.name)throw new Error("Invalid project file format.");console.log(`[OpenProject] JSON parsed successfully for project: ${a.name}. Loading data...`),await ht(a,!0)}catch(s){console.error("[OpenProject] Failed to load project:",s),b(`Error loading project: ${s.message}`,"Error")}},n.onerror=()=>{console.error("[OpenProject] FileReader error."),b("Failed to read the selected file.","Error")},n.readAsText(e),t.target.value=""}function _s(){try{const t=i.getState().pendingFileToOpen;if(!t)return;Us(t),i.setState("pendingFileToOpen",null)}catch(t){console.error("Failed to proceed with opening project:",t),b("Could not open the project file.","Error")}}async function qn(t=!1){const e=i.getProject();t||e.name==="Untitled Project"?i.bus.publish("ui:showSaveAsModal"):await Hn(e.name)}async function Hn(t){const e=t?.trim();if(!e)return b("Please enter a project name."),!1;const n=i.getProject();n.name=e,i.bus.publish("project:nameChanged",e),i.setUserDirty(!1);const o=JSON.parse(JSON.stringify(i.getProject())),s=Gn(o);try{const a=JSON.stringify(s,null,2),r=new Blob([a],{type:"application/json"}),d=URL.createObjectURL(r),c=document.createElement("a");return c.download=`${e.replace(/[^a-z0-9\u0E00-\u0E7F]/gi,"_").toLowerCase()}.prim`,c.href=d,document.body.appendChild(c),c.click(),URL.revokeObjectURL(d),document.body.removeChild(c),i.bus.publish("ui:hideSaveAsModal"),i.setAutoSaveDirty(!1),await qs(),i.getState().pendingActionAfterSave&&await $s(),!0}catch(a){return console.error("Failed to save project:",a),b("Failed to save project file.","Error"),i.setUserDirty(!0),!1}}async function Os(t){po();const e=i.getState().pendingActionAfterSave;switch(i.setState("pendingActionAfterSave",null),t){case"save":await qn(!1);break;case"discard":typeof e=="function"&&await e();break}}async function $s(){const t=i.getState().pendingActionAfterSave;i.setState("pendingActionAfterSave",null),t==="open"?await _s():t==="new"&&await _t()}async function Us(t){const e=new FileReader;e.onload=async n=>{try{const o=JSON.parse(n.target.result);if(o&&o.id&&o.name&&o.agentPresets)await ht(o,!0),b(`Project '${o.name}' loaded successfully!`,"Project Loaded");else throw new Error("Invalid project file format.")}catch(o){b(`Error loading project: ${o.message}`,"Error"),console.error(o)}},e.readAsText(t)}async function Fs(t){if(!t)throw new Error("Cannot load last project: Project ID is missing.");await Ht(t);const e=await He(Gt,"readonly","get",Pn);if(e&&e.data&&e.data.id===t){const n=e.data,o=await He(Me,"readonly","getAll"),s={...n,chatSessions:o||[]};await ht(s,!1),console.log("Successfully loaded the last active project from IndexedDB.")}else throw new Error("Project data in DB is invalid or mismatched with last known ID.")}async function ht(t,e=!1){let n=Gn(t);await Ht(n.id),e&&(n.isDirtyForUser=!1),n.globalSettings&&(n.globalSettings.summarizationPromptPresets={...oe,...n.globalSettings.summarizationPromptPresets||{}}),i.setProject(n),await Hs(),n.globalSettings.apiKey&&await Ge({apiKey:n.globalSettings.apiKey}),n=i.getProject(),(n.chatSessions||[]).filter(r=>!r.archived).length===0&&Fn();const s=i.getProject();s.isDirtyForUser=!1,await Rs(s);const a=s.chatSessions.find(r=>r.id===s.activeSessionId)||[...s.chatSessions].filter(r=>!r.archived).sort((r,d)=>d.updatedAt-r.updatedAt)[0];a&&we(a.id),i.bus.publish("project:loaded",{projectData:s}),i.bus.publish("userDirty:changed",!1),i.setAutoSaveDirty(!1),localStorage.setItem("lastActiveProjectId",s.id)}async function Rs(t){await yo([Me,Gt]),await Xt(t),await Rn(t.chatSessions),console.log("Database has been rewritten with new project data.")}async function Xt(t){const e=t||i.getProject();if(!e||!e.id){console.warn("Cannot persist metadata: project or project ID is missing.");return}const n={...e};delete n.chatSessions,await He(Gt,"readwrite","put",{id:Pn,data:n})}async function qs(){const t=i.getProject();if(!t||!t.id)return!1;console.log("[AutoSave] Persisting project to IndexedDB...");try{return await Xt(),await Rn(),console.log("[AutoSave] Project state successfully persisted."),!0}catch(e){return console.error("[AutoSave] Failed to persist project state:",e),!1}}async function Hs(){const t=i.getProject();!t||!t.globalSettings||(i.bus.publish("ui:applyFontSettings"),console.log("Global settings loaded into state."))}function Gs(t){const e=i.getProject();e.globalSettings.fontFamilySelect=t,i.setProject(e),i.updateAndPersistState(),i.bus.publish("ui:applyFontSettings")}function zs(){const t=i.getProject();if(!t.globalSettings)return;const e=t.globalSettings.systemUtilityAgent;e.model=document.getElementById("system-utility-model-select").value,e.systemPrompt=document.getElementById("system-utility-prompt").value;const n=i.getState().systemParameterEditor,o=n?n.getValues():{};Object.assign(e,o),i.setProject(t),i.updateAndPersistState(),b("System Agent settings saved!","Success")}function Gn(t){const e=Ee();if(t.globalSettings.systemUtilityAgent=Object.assign({},ho,t.globalSettings.systemUtilityAgent),t.agentPresets)for(const n in t.agentPresets){const o=t.agentPresets[n],s=Object.assign({},gt,o);(!s.createdBy||s.createdBy==="Unknown User")&&(s.createdBy=e.userName),s.createdAt||(s.createdAt=Date.now()),s.modifiedAt||(s.modifiedAt=s.createdAt),t.agentPresets[n]=s}if(t.isDirtyForUser===void 0&&(t.isDirtyForUser=!0),t.agentGroups)for(const n in t.agentGroups){const o=t.agentGroups[n];o&&!Array.isArray(o.agents)&&(o.agents=[])}return t}async function Ys(t,e){i.setStagedEntity(null,!1);const n=i.getProject();n.activeEntity={type:t,name:e};const o=n.chatSessions.find(s=>s.id===n.activeSessionId);o&&(o.groupChatState&&(o.groupChatState.isRunning=!1),o.linkedEntity={...n.activeEntity},o.updatedAt=Date.now()),i.setProject(n),i.updateAndPersistState(),i.bus.publish("entity:selected",{type:t,name:e}),i.bus.publish("session:listChanged")}function Ws({type:t,name:e}){const n={type:t,name:e},o=i.getStagedEntity(),s=i.getProject().activeEntity;if(o&&o.name===e&&o.type===t){i.bus.publish("entity:select",n);return}if(s&&s.name===e&&s.type===t){i.setStagedEntity(null);return}i.setStagedEntity(n)}function Xs(t,e){const o=i.getProject().activeEntity,s=i.getStagedEntity(),a=document.createElement("div");return a.className="item agent-item",a.dataset.agentName=t,o?.type==="agent"&&o.name===t?a.classList.add("active"):s?.type==="agent"&&s.name===t&&a.classList.add("staged"),a.innerHTML=`
    <div class="item-header">
        <span class="item-name"><span class="item-icon">${e.icon||"🤖"}</span> ${t}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="agent:edit" title="Edit Agent">
                <span class="material-symbols-outlined">edit</span>
            </button>             
            <button class="btn-icon danger" data-action="agent:delete" title="Delete Agent">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,a}function Js(t,e){if(!t)return;const n=t.querySelector(".agent-presets-section");n&&n.remove(),t.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section agent-presets-section" open>
            <summary class="section-header">
                <h3>🤖 Agent Presets</h3>
                <button class="btn-icon" data-action="agent:create" title="Create New Agent">+</button>
            </summary>
            <div class="section-box">
                <div id="agentPresetList" class="item-list"></div>
            </div>
        </details>`);const s=t.querySelector("#agentPresetList");if(s){if(!e||e.length===0){s.innerHTML='<p class="no-items-message">No agents found.</p>';return}e.forEach(a=>{s.appendChild(Xs(a.name,a))})}}function zn(t=[]){const e=document.getElementById("agent-tags-container"),n=document.getElementById("agent-tags-input");!e||!n||(e.querySelectorAll(".tag-pill").forEach(o=>o.remove()),(t||[]).forEach(o=>{const s=document.createElement("div");s.className="tag-pill",s.textContent=o,s.dataset.tag=o;const a=document.createElement("span");a.className="remove-tag",a.innerHTML="&times;",a.onclick=()=>s.remove(),s.appendChild(a),e.insertBefore(s,n)}))}function Ks(t=[]){const n=i.getProject().memories||[],o=document.getElementById("agent-memory-list");if(o){if(o.innerHTML="",n.length===0){o.innerHTML='<p class="no-items-message">Create memories first.</p>';return}n.forEach(s=>{const a=(t||[]).includes(s.name),r=document.createElement("div");r.className="item",r.dataset.memoryName=s.name,r.innerHTML=`<span class="item-name">${s.name}</span><label class="switch"><input type="checkbox" ${a?"checked":""}><span class="slider round"></span></label>`,o.appendChild(r)})}}function Vs(t){const e=document.querySelector('#agent-editor-modal .tab-content[data-tab-content="system"]');e&&e.classList.toggle("is-locked",t)}function Yn(){const t=document.getElementById("enhancer-model-name"),e=i.getProject();if(!t||!e)return;const n=e.globalSettings.systemUtilityAgent;if(n&&n.model){const o=[...i.getState().systemProviderModels||[],...i.getState().userProviderModels||[]];if(o.length===0){t.textContent=n.model;return}const s=o.find(a=>a.id===n.model);t.textContent=s?s.name:n.model}else t.textContent="N/A"}function an(){const t=i.getState().activeParameterEditor;t&&typeof t.destroy=="function"&&(t.destroy(),i.setState("activeParameterEditor",null)),document.getElementById("agent-editor-modal").style.display="none",i.setState("editingAgentName",null)}function rn(t=!1,e=null){const n=document.getElementById("agent-editor-modal");if(!n)return;i.setState("editingAgentName",t?e:null);const o=i.getProject(),s=t&&o.agentPresets[e]?o.agentPresets[e]:gt;n.querySelectorAll(".tab-btn, .tab-content").forEach(y=>y.classList.remove("active")),n.querySelector('.tab-btn[data-tab="config"]')?.classList.add("active"),n.querySelector('.tab-content[data-tab-content="config"]')?.classList.add("active");const a=n.querySelector('.tab-content[data-tab-content="system"]');a&&(a.dataset.rendered="false");const r=document.getElementById("agent-profile-picture-preview");r&&(r.src=s.profilePicture||"/PromptPrim/icon.png"),document.getElementById("agent-name-input").value=t?e:"New Agent",document.getElementById("agent-icon-button").textContent=s.icon||"🤖",document.getElementById("agent-id-display").value=s.id||`agent_${Date.now()}`,document.getElementById("agent-description").value=s.description||"",bo("agent-model-search-wrapper",s.model,nt()),document.getElementById("agent-system-prompt").value=s.systemPrompt,document.getElementById("agent-use-markdown").checked=s.useMarkdown,document.getElementById("agent-enable-web-search").checked=s.enableWebSearch;const d=document.getElementById("agent-params-container");if(d){const w=nt().find(I=>I.id===s.model),T=w?w.provider:"openrouter",O=xn(d,s,T);i.setState("activeParameterEditor",O)}const c=document.getElementById("agent-created-by-input");c&&(c.value=t?s.createdBy||"Unknown":Ee().userName);const l=document.getElementById("agent-created-date");l&&(l.textContent=s.createdAt?new Date(s.createdAt).toLocaleString():"Not saved yet");const m=document.getElementById("agent-modified-date");m&&(m.textContent=s.modifiedAt?new Date(s.modifiedAt).toLocaleString():"Not saved yet"),zn(s.tags),Ks(s.activeMemories),Vs(s.type==="third-party"),Yn();const u=document.getElementById("agent-model-warning"),p=document.getElementById("agent-model-warning-text"),h=document.getElementById("agent-model-search-wrapper");if(u&&p&&h){const w=nt().some(T=>T.id===s.model);t&&s.model&&!w?(p.innerHTML=`<strong>Model Not Found:</strong> The original model (<code>${s.model}</code>) could not be found. Please select a new model.`,u.classList.remove("hidden"),h.classList.add("has-warning")):(u.classList.add("hidden"),h.classList.remove("has-warning"))}n.style.display="flex"}function Qs(){const t=document.getElementById("agent-editor-modal");if(!t)return;t.querySelector(".tab-buttons")?.addEventListener("click",c=>{const l=c.target.closest(".tab-btn");if(!l)return;const m=l.dataset.tab;t.querySelectorAll(".tab-btn, .tab-content").forEach(u=>u.classList.remove("active")),l.classList.add("active"),t.querySelector(`.tab-content[data-tab-content="${m}"]`)?.classList.add("active")}),t.addEventListener("click",c=>{const l=c.target;if(l.matches(".modal-actions .btn:not(.btn-secondary)"))i.bus.publish("agent:save");else if(l.closest("#generate-agent-profile-btn"))i.bus.publish("agent:generateProfile");else if(l.matches(".btn-secondary")||l.closest(".modal-close-btn"))an();else if(l.closest("#agent-id-copy-btn")){const m=document.getElementById("agent-id-display");navigator.clipboard.writeText(m.value)}});const n=document.getElementById("agent-tags-input");n?.addEventListener("keydown",c=>{if(c.key==="Enter"){c.preventDefault(),c.stopPropagation();const l=n.value.trim();if(l){const m=Array.from(document.querySelectorAll("#agent-tags-container .tag-pill")).map(u=>u.dataset.tag);m.includes(l)||zn([...m,l]),n.value=""}}});const o=document.getElementById("agent-icon-button"),s=document.getElementById("agent-emoji-picker");o&&s&&(o.addEventListener("click",c=>{c.stopPropagation(),document.body.classList.contains("dark-mode")?(s.classList.add("dark"),s.classList.remove("light")):(s.classList.add("light"),s.classList.remove("dark")),s.classList.toggle("hidden")}),s.addEventListener("emoji-click",c=>{c.detail.emoji&&(o.textContent=c.detail.emoji.unicode,s.classList.add("hidden"))}),document.addEventListener("click",c=>{!s.classList.contains("hidden")&&!s.contains(c.target)&&c.target!==o&&s.classList.add("hidden")}));const a=document.getElementById("agent-profile-picture-upload"),r=document.getElementById("agent-profile-picture-preview");a&&r&&a.addEventListener("change",c=>{const l=c.target.files?.[0];if(!l)return;if(!l.type.startsWith("image/")){b("Please select an image file (e.g., PNG, JPG, WEBP).","Unsupported File");return}const m=2*1024*1024;if(l.size>m){b("The selected image is too large. Please select a file smaller than 2MB.","File Too Large");return}const u=new FileReader;u.onload=p=>{r.src=p.target?.result||""},u.readAsDataURL(l)}),i.bus.subscribe("agent:editorShouldClose",an);const d=()=>{t&&t.style.display==="flex"&&Yn()};i.bus.subscribe("models:loaded",d),i.bus.subscribe("user:modelsLoaded",d),i.bus.subscribe("agent:profileGenerated",c=>{if(!c)return;document.getElementById("agent-name-input").value=c.agent_name||"",document.getElementById("agent-icon-button").textContent=c.agent_icon||"🤖",document.getElementById("agent-system-prompt").value=c.system_prompt||"";const l=i.getState().editingAgentName,m=i.getProject(),u=l?m.agentPresets[l]:gt,p={...u,temperature:c.temperature??u.temperature,topP:c.top_p??u.topP,topK:c.top_k??u.topK,max_tokens:c.max_tokens??u.max_tokens,frequency_penalty:c.frequency_penalty??u.frequency_penalty,presence_penalty:c.presence_penalty??u.presence_penalty,seed:c.seed??u.seed},h=document.getElementById("agent-params-container");if(h){const y=i.getState().activeParameterEditor;y&&y.destroy();const T=xn(h,p,"openrouter");i.setState("activeParameterEditor",T)}}),i.bus.subscribe("agent:promptEnhanced",({newPrompt:c})=>{const l=document.getElementById("agent-system-prompt");l&&(l.value=c)}),console.log("✅ Agent UI Initialized with Full Profile Generation Logic.")}/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */function ln(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(s){return Object.getOwnPropertyDescriptor(t,s).enumerable})),n.push.apply(n,o)}return n}function re(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?ln(Object(n),!0).forEach(function(o){Zs(t,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ln(Object(n)).forEach(function(o){Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(n,o))})}return t}function ot(t){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?ot=function(e){return typeof e}:ot=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ot(t)}function Zs(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function de(){return de=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},de.apply(this,arguments)}function ea(t,e){if(t==null)return{};var n={},o=Object.keys(t),s,a;for(a=0;a<o.length;a++)s=o[a],!(e.indexOf(s)>=0)&&(n[s]=t[s]);return n}function ta(t,e){if(t==null)return{};var n=ea(t,e),o,s;if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);for(s=0;s<a.length;s++)o=a[s],!(e.indexOf(o)>=0)&&Object.prototype.propertyIsEnumerable.call(t,o)&&(n[o]=t[o])}return n}var na="1.15.6";function ce(t){if(typeof window<"u"&&window.navigator)return!!navigator.userAgent.match(t)}var ue=ce(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),Ye=ce(/Edge/i),cn=ce(/firefox/i),$e=ce(/safari/i)&&!ce(/chrome/i)&&!ce(/android/i),Jt=ce(/iP(ad|od|hone)/i),Wn=ce(/chrome/i)&&ce(/android/i),Xn={capture:!1,passive:!1};function C(t,e,n){t.addEventListener(e,n,!ue&&Xn)}function j(t,e,n){t.removeEventListener(e,n,!ue&&Xn)}function lt(t,e){if(e){if(e[0]===">"&&(e=e.substring(1)),t)try{if(t.matches)return t.matches(e);if(t.msMatchesSelector)return t.msMatchesSelector(e);if(t.webkitMatchesSelector)return t.webkitMatchesSelector(e)}catch{return!1}return!1}}function Jn(t){return t.host&&t!==document&&t.host.nodeType?t.host:t.parentNode}function ne(t,e,n,o){if(t){n=n||document;do{if(e!=null&&(e[0]===">"?t.parentNode===n&&lt(t,e):lt(t,e))||o&&t===n)return t;if(t===n)break}while(t=Jn(t))}return null}var dn=/\s+/g;function Q(t,e,n){if(t&&e)if(t.classList)t.classList[n?"add":"remove"](e);else{var o=(" "+t.className+" ").replace(dn," ").replace(" "+e+" "," ");t.className=(o+(n?" "+e:"")).replace(dn," ")}}function S(t,e,n){var o=t&&t.style;if(o){if(n===void 0)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(t,""):t.currentStyle&&(n=t.currentStyle),e===void 0?n:n[e];!(e in o)&&e.indexOf("webkit")===-1&&(e="-webkit-"+e),o[e]=n+(typeof n=="string"?"":"px")}}function Te(t,e){var n="";if(typeof t=="string")n=t;else do{var o=S(t,"transform");o&&o!=="none"&&(n=o+" "+n)}while(!e&&(t=t.parentNode));var s=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return s&&new s(n)}function Kn(t,e,n){if(t){var o=t.getElementsByTagName(e),s=0,a=o.length;if(n)for(;s<a;s++)n(o[s],s);return o}return[]}function ae(){var t=document.scrollingElement;return t||document.documentElement}function _(t,e,n,o,s){if(!(!t.getBoundingClientRect&&t!==window)){var a,r,d,c,l,m,u;if(t!==window&&t.parentNode&&t!==ae()?(a=t.getBoundingClientRect(),r=a.top,d=a.left,c=a.bottom,l=a.right,m=a.height,u=a.width):(r=0,d=0,c=window.innerHeight,l=window.innerWidth,m=window.innerHeight,u=window.innerWidth),(e||n)&&t!==window&&(s=s||t.parentNode,!ue))do if(s&&s.getBoundingClientRect&&(S(s,"transform")!=="none"||n&&S(s,"position")!=="static")){var p=s.getBoundingClientRect();r-=p.top+parseInt(S(s,"border-top-width")),d-=p.left+parseInt(S(s,"border-left-width")),c=r+a.height,l=d+a.width;break}while(s=s.parentNode);if(o&&t!==window){var h=Te(s||t),y=h&&h.a,w=h&&h.d;h&&(r/=w,d/=y,u/=y,m/=w,c=r+m,l=d+u)}return{top:r,left:d,bottom:c,right:l,width:u,height:m}}}function un(t,e,n){for(var o=ge(t,!0),s=_(t)[e];o;){var a=_(o)[n],r=void 0;if(r=s>=a,!r)return o;if(o===ae())break;o=ge(o,!1)}return!1}function ke(t,e,n,o){for(var s=0,a=0,r=t.children;a<r.length;){if(r[a].style.display!=="none"&&r[a]!==E.ghost&&(o||r[a]!==E.dragged)&&ne(r[a],n.draggable,t,!1)){if(s===e)return r[a];s++}a++}return null}function Kt(t,e){for(var n=t.lastElementChild;n&&(n===E.ghost||S(n,"display")==="none"||e&&!lt(n,e));)n=n.previousElementSibling;return n||null}function ee(t,e){var n=0;if(!t||!t.parentNode)return-1;for(;t=t.previousElementSibling;)t.nodeName.toUpperCase()!=="TEMPLATE"&&t!==E.clone&&(!e||lt(t,e))&&n++;return n}function mn(t){var e=0,n=0,o=ae();if(t)do{var s=Te(t),a=s.a,r=s.d;e+=t.scrollLeft*a,n+=t.scrollTop*r}while(t!==o&&(t=t.parentNode));return[e,n]}function oa(t,e){for(var n in t)if(t.hasOwnProperty(n)){for(var o in e)if(e.hasOwnProperty(o)&&e[o]===t[n][o])return Number(n)}return-1}function ge(t,e){if(!t||!t.getBoundingClientRect)return ae();var n=t,o=!1;do if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var s=S(n);if(n.clientWidth<n.scrollWidth&&(s.overflowX=="auto"||s.overflowX=="scroll")||n.clientHeight<n.scrollHeight&&(s.overflowY=="auto"||s.overflowY=="scroll")){if(!n.getBoundingClientRect||n===document.body)return ae();if(o||e)return n;o=!0}}while(n=n.parentNode);return ae()}function sa(t,e){if(t&&e)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function Et(t,e){return Math.round(t.top)===Math.round(e.top)&&Math.round(t.left)===Math.round(e.left)&&Math.round(t.height)===Math.round(e.height)&&Math.round(t.width)===Math.round(e.width)}var Ue;function Vn(t,e){return function(){if(!Ue){var n=arguments,o=this;n.length===1?t.call(o,n[0]):t.apply(o,n),Ue=setTimeout(function(){Ue=void 0},e)}}}function aa(){clearTimeout(Ue),Ue=void 0}function Qn(t,e,n){t.scrollLeft+=e,t.scrollTop+=n}function Zn(t){var e=window.Polymer,n=window.jQuery||window.Zepto;return e&&e.dom?e.dom(t).cloneNode(!0):n?n(t).clone(!0)[0]:t.cloneNode(!0)}function eo(t,e,n){var o={};return Array.from(t.children).forEach(function(s){var a,r,d,c;if(!(!ne(s,e.draggable,t,!1)||s.animated||s===n)){var l=_(s);o.left=Math.min((a=o.left)!==null&&a!==void 0?a:1/0,l.left),o.top=Math.min((r=o.top)!==null&&r!==void 0?r:1/0,l.top),o.right=Math.max((d=o.right)!==null&&d!==void 0?d:-1/0,l.right),o.bottom=Math.max((c=o.bottom)!==null&&c!==void 0?c:-1/0,l.bottom)}}),o.width=o.right-o.left,o.height=o.bottom-o.top,o.x=o.left,o.y=o.top,o}var K="Sortable"+new Date().getTime();function ra(){var t=[],e;return{captureAnimationState:function(){if(t=[],!!this.options.animation){var o=[].slice.call(this.el.children);o.forEach(function(s){if(!(S(s,"display")==="none"||s===E.ghost)){t.push({target:s,rect:_(s)});var a=re({},t[t.length-1].rect);if(s.thisAnimationDuration){var r=Te(s,!0);r&&(a.top-=r.f,a.left-=r.e)}s.fromRect=a}})}},addAnimationState:function(o){t.push(o)},removeAnimationState:function(o){t.splice(oa(t,{target:o}),1)},animateAll:function(o){var s=this;if(!this.options.animation){clearTimeout(e),typeof o=="function"&&o();return}var a=!1,r=0;t.forEach(function(d){var c=0,l=d.target,m=l.fromRect,u=_(l),p=l.prevFromRect,h=l.prevToRect,y=d.rect,w=Te(l,!0);w&&(u.top-=w.f,u.left-=w.e),l.toRect=u,l.thisAnimationDuration&&Et(p,u)&&!Et(m,u)&&(y.top-u.top)/(y.left-u.left)===(m.top-u.top)/(m.left-u.left)&&(c=la(y,p,h,s.options)),Et(u,m)||(l.prevFromRect=m,l.prevToRect=u,c||(c=s.options.animation),s.animate(l,y,u,c)),c&&(a=!0,r=Math.max(r,c),clearTimeout(l.animationResetTimer),l.animationResetTimer=setTimeout(function(){l.animationTime=0,l.prevFromRect=null,l.fromRect=null,l.prevToRect=null,l.thisAnimationDuration=null},c),l.thisAnimationDuration=c)}),clearTimeout(e),a?e=setTimeout(function(){typeof o=="function"&&o()},r):typeof o=="function"&&o(),t=[]},animate:function(o,s,a,r){if(r){S(o,"transition",""),S(o,"transform","");var d=Te(this.el),c=d&&d.a,l=d&&d.d,m=(s.left-a.left)/(c||1),u=(s.top-a.top)/(l||1);o.animatingX=!!m,o.animatingY=!!u,S(o,"transform","translate3d("+m+"px,"+u+"px,0)"),this.forRepaintDummy=ia(o),S(o,"transition","transform "+r+"ms"+(this.options.easing?" "+this.options.easing:"")),S(o,"transform","translate3d(0,0,0)"),typeof o.animated=="number"&&clearTimeout(o.animated),o.animated=setTimeout(function(){S(o,"transition",""),S(o,"transform",""),o.animated=!1,o.animatingX=!1,o.animatingY=!1},r)}}}}function ia(t){return t.offsetWidth}function la(t,e,n,o){return Math.sqrt(Math.pow(e.top-t.top,2)+Math.pow(e.left-t.left,2))/Math.sqrt(Math.pow(e.top-n.top,2)+Math.pow(e.left-n.left,2))*o.animation}var Ce=[],wt={initializeByDefault:!0},We={mount:function(e){for(var n in wt)wt.hasOwnProperty(n)&&!(n in e)&&(e[n]=wt[n]);Ce.forEach(function(o){if(o.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),Ce.push(e)},pluginEvent:function(e,n,o){var s=this;this.eventCanceled=!1,o.cancel=function(){s.eventCanceled=!0};var a=e+"Global";Ce.forEach(function(r){n[r.pluginName]&&(n[r.pluginName][a]&&n[r.pluginName][a](re({sortable:n},o)),n.options[r.pluginName]&&n[r.pluginName][e]&&n[r.pluginName][e](re({sortable:n},o)))})},initializePlugins:function(e,n,o,s){Ce.forEach(function(d){var c=d.pluginName;if(!(!e.options[c]&&!d.initializeByDefault)){var l=new d(e,n,e.options);l.sortable=e,l.options=e.options,e[c]=l,de(o,l.defaults)}});for(var a in e.options)if(e.options.hasOwnProperty(a)){var r=this.modifyOption(e,a,e.options[a]);typeof r<"u"&&(e.options[a]=r)}},getEventProperties:function(e,n){var o={};return Ce.forEach(function(s){typeof s.eventProperties=="function"&&de(o,s.eventProperties.call(n[s.pluginName],e))}),o},modifyOption:function(e,n,o){var s;return Ce.forEach(function(a){e[a.pluginName]&&a.optionListeners&&typeof a.optionListeners[n]=="function"&&(s=a.optionListeners[n].call(e[a.pluginName],o))}),s}};function ca(t){var e=t.sortable,n=t.rootEl,o=t.name,s=t.targetEl,a=t.cloneEl,r=t.toEl,d=t.fromEl,c=t.oldIndex,l=t.newIndex,m=t.oldDraggableIndex,u=t.newDraggableIndex,p=t.originalEvent,h=t.putSortable,y=t.extraEventProperties;if(e=e||n&&n[K],!!e){var w,T=e.options,O="on"+o.charAt(0).toUpperCase()+o.substr(1);window.CustomEvent&&!ue&&!Ye?w=new CustomEvent(o,{bubbles:!0,cancelable:!0}):(w=document.createEvent("Event"),w.initEvent(o,!0,!0)),w.to=r||n,w.from=d||n,w.item=s||n,w.clone=a,w.oldIndex=c,w.newIndex=l,w.oldDraggableIndex=m,w.newDraggableIndex=u,w.originalEvent=p,w.pullMode=h?h.lastPutMode:void 0;var I=re(re({},y),We.getEventProperties(o,e));for(var $ in I)w[$]=I[$];n&&n.dispatchEvent(w),T[O]&&T[O].call(e,w)}}var da=["evt"],J=function(e,n){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},s=o.evt,a=ta(o,da);We.pluginEvent.bind(E)(e,n,re({dragEl:f,parentEl:B,ghostEl:P,rootEl:D,nextEl:ve,lastDownEl:st,cloneEl:k,cloneHidden:pe,dragStarted:Ne,putSortable:R,activeSortable:E.active,originalEvent:s,oldIndex:Le,oldDraggableIndex:Fe,newIndex:Z,newDraggableIndex:me,hideGhostForTarget:so,unhideGhostForTarget:ao,cloneNowHidden:function(){pe=!0},cloneNowShown:function(){pe=!1},dispatchSortableEvent:function(d){Y({sortable:n,name:d,originalEvent:s})}},a))};function Y(t){ca(re({putSortable:R,cloneEl:k,targetEl:f,rootEl:D,oldIndex:Le,oldDraggableIndex:Fe,newIndex:Z,newDraggableIndex:me},t))}var f,B,P,D,ve,st,k,pe,Le,Z,Fe,me,Qe,R,Ie=!1,ct=!1,dt=[],ye,te,Pt,jt,pn,gn,Ne,xe,Re,qe=!1,Ze=!1,at,G,Ct=[],$t=!1,ut=[],yt=typeof document<"u",et=Jt,fn=Ye||ue?"cssFloat":"float",ua=yt&&!Wn&&!Jt&&"draggable"in document.createElement("div"),to=(function(){if(yt){if(ue)return!1;var t=document.createElement("x");return t.style.cssText="pointer-events:auto",t.style.pointerEvents==="auto"}})(),no=function(e,n){var o=S(e),s=parseInt(o.width)-parseInt(o.paddingLeft)-parseInt(o.paddingRight)-parseInt(o.borderLeftWidth)-parseInt(o.borderRightWidth),a=ke(e,0,n),r=ke(e,1,n),d=a&&S(a),c=r&&S(r),l=d&&parseInt(d.marginLeft)+parseInt(d.marginRight)+_(a).width,m=c&&parseInt(c.marginLeft)+parseInt(c.marginRight)+_(r).width;if(o.display==="flex")return o.flexDirection==="column"||o.flexDirection==="column-reverse"?"vertical":"horizontal";if(o.display==="grid")return o.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(a&&d.float&&d.float!=="none"){var u=d.float==="left"?"left":"right";return r&&(c.clear==="both"||c.clear===u)?"vertical":"horizontal"}return a&&(d.display==="block"||d.display==="flex"||d.display==="table"||d.display==="grid"||l>=s&&o[fn]==="none"||r&&o[fn]==="none"&&l+m>s)?"vertical":"horizontal"},ma=function(e,n,o){var s=o?e.left:e.top,a=o?e.right:e.bottom,r=o?e.width:e.height,d=o?n.left:n.top,c=o?n.right:n.bottom,l=o?n.width:n.height;return s===d||a===c||s+r/2===d+l/2},pa=function(e,n){var o;return dt.some(function(s){var a=s[K].options.emptyInsertThreshold;if(!(!a||Kt(s))){var r=_(s),d=e>=r.left-a&&e<=r.right+a,c=n>=r.top-a&&n<=r.bottom+a;if(d&&c)return o=s}}),o},oo=function(e){function n(a,r){return function(d,c,l,m){var u=d.options.group.name&&c.options.group.name&&d.options.group.name===c.options.group.name;if(a==null&&(r||u))return!0;if(a==null||a===!1)return!1;if(r&&a==="clone")return a;if(typeof a=="function")return n(a(d,c,l,m),r)(d,c,l,m);var p=(r?d:c).options.group.name;return a===!0||typeof a=="string"&&a===p||a.join&&a.indexOf(p)>-1}}var o={},s=e.group;(!s||ot(s)!="object")&&(s={name:s}),o.name=s.name,o.checkPull=n(s.pull,!0),o.checkPut=n(s.put),o.revertClone=s.revertClone,e.group=o},so=function(){!to&&P&&S(P,"display","none")},ao=function(){!to&&P&&S(P,"display","")};yt&&!Wn&&document.addEventListener("click",function(t){if(ct)return t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.stopImmediatePropagation&&t.stopImmediatePropagation(),ct=!1,!1},!0);var be=function(e){if(f){e=e.touches?e.touches[0]:e;var n=pa(e.clientX,e.clientY);if(n){var o={};for(var s in e)e.hasOwnProperty(s)&&(o[s]=e[s]);o.target=o.rootEl=n,o.preventDefault=void 0,o.stopPropagation=void 0,n[K]._onDragOver(o)}}},ga=function(e){f&&f.parentNode[K]._isOutsideThisEl(e.target)};function E(t,e){if(!(t&&t.nodeType&&t.nodeType===1))throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(t));this.el=t,this.options=e=de({},e),t[K]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(t.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return no(t,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(r,d){r.setData("Text",d.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:E.supportPointer!==!1&&"PointerEvent"in window&&(!$e||Jt),emptyInsertThreshold:5};We.initializePlugins(this,t,n);for(var o in n)!(o in e)&&(e[o]=n[o]);oo(e);for(var s in this)s.charAt(0)==="_"&&typeof this[s]=="function"&&(this[s]=this[s].bind(this));this.nativeDraggable=e.forceFallback?!1:ua,this.nativeDraggable&&(this.options.touchStartThreshold=1),e.supportPointer?C(t,"pointerdown",this._onTapStart):(C(t,"mousedown",this._onTapStart),C(t,"touchstart",this._onTapStart)),this.nativeDraggable&&(C(t,"dragover",this),C(t,"dragenter",this)),dt.push(this.el),e.store&&e.store.get&&this.sort(e.store.get(this)||[]),de(this,ra())}E.prototype={constructor:E,_isOutsideThisEl:function(e){!this.el.contains(e)&&e!==this.el&&(xe=null)},_getDirection:function(e,n){return typeof this.options.direction=="function"?this.options.direction.call(this,e,n,f):this.options.direction},_onTapStart:function(e){if(e.cancelable){var n=this,o=this.el,s=this.options,a=s.preventOnFilter,r=e.type,d=e.touches&&e.touches[0]||e.pointerType&&e.pointerType==="touch"&&e,c=(d||e).target,l=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||c,m=s.filter;if(wa(o),!f&&!(/mousedown|pointerdown/.test(r)&&e.button!==0||s.disabled)&&!l.isContentEditable&&!(!this.nativeDraggable&&$e&&c&&c.tagName.toUpperCase()==="SELECT")&&(c=ne(c,s.draggable,o,!1),!(c&&c.animated)&&st!==c)){if(Le=ee(c),Fe=ee(c,s.draggable),typeof m=="function"){if(m.call(this,e,c,this)){Y({sortable:n,rootEl:l,name:"filter",targetEl:c,toEl:o,fromEl:o}),J("filter",n,{evt:e}),a&&e.preventDefault();return}}else if(m&&(m=m.split(",").some(function(u){if(u=ne(l,u.trim(),o,!1),u)return Y({sortable:n,rootEl:u,name:"filter",targetEl:c,fromEl:o,toEl:o}),J("filter",n,{evt:e}),!0}),m)){a&&e.preventDefault();return}s.handle&&!ne(l,s.handle,o,!1)||this._prepareDragStart(e,d,c)}}},_prepareDragStart:function(e,n,o){var s=this,a=s.el,r=s.options,d=a.ownerDocument,c;if(o&&!f&&o.parentNode===a){var l=_(o);if(D=a,f=o,B=f.parentNode,ve=f.nextSibling,st=o,Qe=r.group,E.dragged=f,ye={target:f,clientX:(n||e).clientX,clientY:(n||e).clientY},pn=ye.clientX-l.left,gn=ye.clientY-l.top,this._lastX=(n||e).clientX,this._lastY=(n||e).clientY,f.style["will-change"]="all",c=function(){if(J("delayEnded",s,{evt:e}),E.eventCanceled){s._onDrop();return}s._disableDelayedDragEvents(),!cn&&s.nativeDraggable&&(f.draggable=!0),s._triggerDragStart(e,n),Y({sortable:s,name:"choose",originalEvent:e}),Q(f,r.chosenClass,!0)},r.ignore.split(",").forEach(function(m){Kn(f,m.trim(),xt)}),C(d,"dragover",be),C(d,"mousemove",be),C(d,"touchmove",be),r.supportPointer?(C(d,"pointerup",s._onDrop),!this.nativeDraggable&&C(d,"pointercancel",s._onDrop)):(C(d,"mouseup",s._onDrop),C(d,"touchend",s._onDrop),C(d,"touchcancel",s._onDrop)),cn&&this.nativeDraggable&&(this.options.touchStartThreshold=4,f.draggable=!0),J("delayStart",this,{evt:e}),r.delay&&(!r.delayOnTouchOnly||n)&&(!this.nativeDraggable||!(Ye||ue))){if(E.eventCanceled){this._onDrop();return}r.supportPointer?(C(d,"pointerup",s._disableDelayedDrag),C(d,"pointercancel",s._disableDelayedDrag)):(C(d,"mouseup",s._disableDelayedDrag),C(d,"touchend",s._disableDelayedDrag),C(d,"touchcancel",s._disableDelayedDrag)),C(d,"mousemove",s._delayedDragTouchMoveHandler),C(d,"touchmove",s._delayedDragTouchMoveHandler),r.supportPointer&&C(d,"pointermove",s._delayedDragTouchMoveHandler),s._dragStartTimer=setTimeout(c,r.delay)}else c()}},_delayedDragTouchMoveHandler:function(e){var n=e.touches?e.touches[0]:e;Math.max(Math.abs(n.clientX-this._lastX),Math.abs(n.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){f&&xt(f),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;j(e,"mouseup",this._disableDelayedDrag),j(e,"touchend",this._disableDelayedDrag),j(e,"touchcancel",this._disableDelayedDrag),j(e,"pointerup",this._disableDelayedDrag),j(e,"pointercancel",this._disableDelayedDrag),j(e,"mousemove",this._delayedDragTouchMoveHandler),j(e,"touchmove",this._delayedDragTouchMoveHandler),j(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,n){n=n||e.pointerType=="touch"&&e,!this.nativeDraggable||n?this.options.supportPointer?C(document,"pointermove",this._onTouchMove):n?C(document,"touchmove",this._onTouchMove):C(document,"mousemove",this._onTouchMove):(C(f,"dragend",this),C(D,"dragstart",this._onDragStart));try{document.selection?rt(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch{}},_dragStarted:function(e,n){if(Ie=!1,D&&f){J("dragStarted",this,{evt:n}),this.nativeDraggable&&C(document,"dragover",ga);var o=this.options;!e&&Q(f,o.dragClass,!1),Q(f,o.ghostClass,!0),E.active=this,e&&this._appendGhost(),Y({sortable:this,name:"start",originalEvent:n})}else this._nulling()},_emulateDragOver:function(){if(te){this._lastX=te.clientX,this._lastY=te.clientY,so();for(var e=document.elementFromPoint(te.clientX,te.clientY),n=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(te.clientX,te.clientY),e!==n);)n=e;if(f.parentNode[K]._isOutsideThisEl(e),n)do{if(n[K]){var o=void 0;if(o=n[K]._onDragOver({clientX:te.clientX,clientY:te.clientY,target:e,rootEl:n}),o&&!this.options.dragoverBubble)break}e=n}while(n=Jn(n));ao()}},_onTouchMove:function(e){if(ye){var n=this.options,o=n.fallbackTolerance,s=n.fallbackOffset,a=e.touches?e.touches[0]:e,r=P&&Te(P,!0),d=P&&r&&r.a,c=P&&r&&r.d,l=et&&G&&mn(G),m=(a.clientX-ye.clientX+s.x)/(d||1)+(l?l[0]-Ct[0]:0)/(d||1),u=(a.clientY-ye.clientY+s.y)/(c||1)+(l?l[1]-Ct[1]:0)/(c||1);if(!E.active&&!Ie){if(o&&Math.max(Math.abs(a.clientX-this._lastX),Math.abs(a.clientY-this._lastY))<o)return;this._onDragStart(e,!0)}if(P){r?(r.e+=m-(Pt||0),r.f+=u-(jt||0)):r={a:1,b:0,c:0,d:1,e:m,f:u};var p="matrix(".concat(r.a,",").concat(r.b,",").concat(r.c,",").concat(r.d,",").concat(r.e,",").concat(r.f,")");S(P,"webkitTransform",p),S(P,"mozTransform",p),S(P,"msTransform",p),S(P,"transform",p),Pt=m,jt=u,te=a}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!P){var e=this.options.fallbackOnBody?document.body:D,n=_(f,!0,et,!0,e),o=this.options;if(et){for(G=e;S(G,"position")==="static"&&S(G,"transform")==="none"&&G!==document;)G=G.parentNode;G!==document.body&&G!==document.documentElement?(G===document&&(G=ae()),n.top+=G.scrollTop,n.left+=G.scrollLeft):G=ae(),Ct=mn(G)}P=f.cloneNode(!0),Q(P,o.ghostClass,!1),Q(P,o.fallbackClass,!0),Q(P,o.dragClass,!0),S(P,"transition",""),S(P,"transform",""),S(P,"box-sizing","border-box"),S(P,"margin",0),S(P,"top",n.top),S(P,"left",n.left),S(P,"width",n.width),S(P,"height",n.height),S(P,"opacity","0.8"),S(P,"position",et?"absolute":"fixed"),S(P,"zIndex","100000"),S(P,"pointerEvents","none"),E.ghost=P,e.appendChild(P),S(P,"transform-origin",pn/parseInt(P.style.width)*100+"% "+gn/parseInt(P.style.height)*100+"%")}},_onDragStart:function(e,n){var o=this,s=e.dataTransfer,a=o.options;if(J("dragStart",this,{evt:e}),E.eventCanceled){this._onDrop();return}J("setupClone",this),E.eventCanceled||(k=Zn(f),k.removeAttribute("id"),k.draggable=!1,k.style["will-change"]="",this._hideClone(),Q(k,this.options.chosenClass,!1),E.clone=k),o.cloneId=rt(function(){J("clone",o),!E.eventCanceled&&(o.options.removeCloneOnHide||D.insertBefore(k,f),o._hideClone(),Y({sortable:o,name:"clone"}))}),!n&&Q(f,a.dragClass,!0),n?(ct=!0,o._loopId=setInterval(o._emulateDragOver,50)):(j(document,"mouseup",o._onDrop),j(document,"touchend",o._onDrop),j(document,"touchcancel",o._onDrop),s&&(s.effectAllowed="move",a.setData&&a.setData.call(o,s,f)),C(document,"drop",o),S(f,"transform","translateZ(0)")),Ie=!0,o._dragStartId=rt(o._dragStarted.bind(o,n,e)),C(document,"selectstart",o),Ne=!0,window.getSelection().removeAllRanges(),$e&&S(document.body,"user-select","none")},_onDragOver:function(e){var n=this.el,o=e.target,s,a,r,d=this.options,c=d.group,l=E.active,m=Qe===c,u=d.sort,p=R||l,h,y=this,w=!1;if($t)return;function T(x,Be){J(x,y,re({evt:e,isOwner:m,axis:h?"vertical":"horizontal",revert:r,dragRect:s,targetRect:a,canSort:u,fromSortable:p,target:o,completed:I,onMove:function(Xe,he){return tt(D,n,f,s,Xe,_(Xe),e,he)},changed:$},Be))}function O(){T("dragOverAnimationCapture"),y.captureAnimationState(),y!==p&&p.captureAnimationState()}function I(x){return T("dragOverCompleted",{insertion:x}),x&&(m?l._hideClone():l._showClone(y),y!==p&&(Q(f,R?R.options.ghostClass:l.options.ghostClass,!1),Q(f,d.ghostClass,!0)),R!==y&&y!==E.active?R=y:y===E.active&&R&&(R=null),p===y&&(y._ignoreWhileAnimating=o),y.animateAll(function(){T("dragOverAnimationComplete"),y._ignoreWhileAnimating=null}),y!==p&&(p.animateAll(),p._ignoreWhileAnimating=null)),(o===f&&!f.animated||o===n&&!o.animated)&&(xe=null),!d.dragoverBubble&&!e.rootEl&&o!==document&&(f.parentNode[K]._isOutsideThisEl(e.target),!x&&be(e)),!d.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),w=!0}function $(){Z=ee(f),me=ee(f,d.draggable),Y({sortable:y,name:"change",toEl:n,newIndex:Z,newDraggableIndex:me,originalEvent:e})}if(e.preventDefault!==void 0&&e.cancelable&&e.preventDefault(),o=ne(o,d.draggable,n,!0),T("dragOver"),E.eventCanceled)return w;if(f.contains(e.target)||o.animated&&o.animatingX&&o.animatingY||y._ignoreWhileAnimating===o)return I(!1);if(ct=!1,l&&!d.disabled&&(m?u||(r=B!==D):R===this||(this.lastPutMode=Qe.checkPull(this,l,f,e))&&c.checkPut(this,l,f,e))){if(h=this._getDirection(e,o)==="vertical",s=_(f),T("dragOverValid"),E.eventCanceled)return w;if(r)return B=D,O(),this._hideClone(),T("revert"),E.eventCanceled||(ve?D.insertBefore(f,ve):D.appendChild(f)),I(!0);var F=Kt(n,d.draggable);if(!F||ba(e,h,this)&&!F.animated){if(F===f)return I(!1);if(F&&n===e.target&&(o=F),o&&(a=_(o)),tt(D,n,f,s,o,a,e,!!o)!==!1)return O(),F&&F.nextSibling?n.insertBefore(f,F.nextSibling):n.appendChild(f),B=n,$(),I(!0)}else if(F&&ya(e,h,this)){var W=ke(n,0,d,!0);if(W===f)return I(!1);if(o=W,a=_(o),tt(D,n,f,s,o,a,e,!1)!==!1)return O(),n.insertBefore(f,W),B=n,$(),I(!0)}else if(o.parentNode===n){a=_(o);var z=0,X,v=f.parentNode!==n,M=!ma(f.animated&&f.toRect||s,o.animated&&o.toRect||a,h),U=h?"top":"left",q=un(o,"top","top")||un(f,"top","top"),se=q?q.scrollTop:void 0;xe!==o&&(X=a[U],qe=!1,Ze=!M&&d.invertSwap||v),z=va(e,o,a,h,M?1:d.swapThreshold,d.invertedSwapThreshold==null?d.swapThreshold:d.invertedSwapThreshold,Ze,xe===o);var H;if(z!==0){var ie=ee(f);do ie-=z,H=B.children[ie];while(H&&(S(H,"display")==="none"||H===P))}if(z===0||H===o)return I(!1);xe=o,Re=z;var fe=o.nextElementSibling,V=!1;V=z===1;var Pe=tt(D,n,f,s,o,a,e,V);if(Pe!==!1)return(Pe===1||Pe===-1)&&(V=Pe===1),$t=!0,setTimeout(ha,30),O(),V&&!fe?n.appendChild(f):o.parentNode.insertBefore(f,V?fe:o),q&&Qn(q,0,se-q.scrollTop),B=f.parentNode,X!==void 0&&!Ze&&(at=Math.abs(X-_(o)[U])),$(),I(!0)}if(n.contains(f))return I(!1)}return!1},_ignoreWhileAnimating:null,_offMoveEvents:function(){j(document,"mousemove",this._onTouchMove),j(document,"touchmove",this._onTouchMove),j(document,"pointermove",this._onTouchMove),j(document,"dragover",be),j(document,"mousemove",be),j(document,"touchmove",be)},_offUpEvents:function(){var e=this.el.ownerDocument;j(e,"mouseup",this._onDrop),j(e,"touchend",this._onDrop),j(e,"pointerup",this._onDrop),j(e,"pointercancel",this._onDrop),j(e,"touchcancel",this._onDrop),j(document,"selectstart",this)},_onDrop:function(e){var n=this.el,o=this.options;if(Z=ee(f),me=ee(f,o.draggable),J("drop",this,{evt:e}),B=f&&f.parentNode,Z=ee(f),me=ee(f,o.draggable),E.eventCanceled){this._nulling();return}Ie=!1,Ze=!1,qe=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),Ut(this.cloneId),Ut(this._dragStartId),this.nativeDraggable&&(j(document,"drop",this),j(n,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),$e&&S(document.body,"user-select",""),S(f,"transform",""),e&&(Ne&&(e.cancelable&&e.preventDefault(),!o.dropBubble&&e.stopPropagation()),P&&P.parentNode&&P.parentNode.removeChild(P),(D===B||R&&R.lastPutMode!=="clone")&&k&&k.parentNode&&k.parentNode.removeChild(k),f&&(this.nativeDraggable&&j(f,"dragend",this),xt(f),f.style["will-change"]="",Ne&&!Ie&&Q(f,R?R.options.ghostClass:this.options.ghostClass,!1),Q(f,this.options.chosenClass,!1),Y({sortable:this,name:"unchoose",toEl:B,newIndex:null,newDraggableIndex:null,originalEvent:e}),D!==B?(Z>=0&&(Y({rootEl:B,name:"add",toEl:B,fromEl:D,originalEvent:e}),Y({sortable:this,name:"remove",toEl:B,originalEvent:e}),Y({rootEl:B,name:"sort",toEl:B,fromEl:D,originalEvent:e}),Y({sortable:this,name:"sort",toEl:B,originalEvent:e})),R&&R.save()):Z!==Le&&Z>=0&&(Y({sortable:this,name:"update",toEl:B,originalEvent:e}),Y({sortable:this,name:"sort",toEl:B,originalEvent:e})),E.active&&((Z==null||Z===-1)&&(Z=Le,me=Fe),Y({sortable:this,name:"end",toEl:B,originalEvent:e}),this.save()))),this._nulling()},_nulling:function(){J("nulling",this),D=f=B=P=ve=k=st=pe=ye=te=Ne=Z=me=Le=Fe=xe=Re=R=Qe=E.dragged=E.ghost=E.clone=E.active=null,ut.forEach(function(e){e.checked=!0}),ut.length=Pt=jt=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":f&&(this._onDragOver(e),fa(e));break;case"selectstart":e.preventDefault();break}},toArray:function(){for(var e=[],n,o=this.el.children,s=0,a=o.length,r=this.options;s<a;s++)n=o[s],ne(n,r.draggable,this.el,!1)&&e.push(n.getAttribute(r.dataIdAttr)||Ea(n));return e},sort:function(e,n){var o={},s=this.el;this.toArray().forEach(function(a,r){var d=s.children[r];ne(d,this.options.draggable,s,!1)&&(o[a]=d)},this),n&&this.captureAnimationState(),e.forEach(function(a){o[a]&&(s.removeChild(o[a]),s.appendChild(o[a]))}),n&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,n){return ne(e,n||this.options.draggable,this.el,!1)},option:function(e,n){var o=this.options;if(n===void 0)return o[e];var s=We.modifyOption(this,e,n);typeof s<"u"?o[e]=s:o[e]=n,e==="group"&&oo(o)},destroy:function(){J("destroy",this);var e=this.el;e[K]=null,j(e,"mousedown",this._onTapStart),j(e,"touchstart",this._onTapStart),j(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(j(e,"dragover",this),j(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),function(n){n.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),dt.splice(dt.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!pe){if(J("hideClone",this),E.eventCanceled)return;S(k,"display","none"),this.options.removeCloneOnHide&&k.parentNode&&k.parentNode.removeChild(k),pe=!0}},_showClone:function(e){if(e.lastPutMode!=="clone"){this._hideClone();return}if(pe){if(J("showClone",this),E.eventCanceled)return;f.parentNode==D&&!this.options.group.revertClone?D.insertBefore(k,f):ve?D.insertBefore(k,ve):D.appendChild(k),this.options.group.revertClone&&this.animate(f,k),S(k,"display",""),pe=!1}}};function fa(t){t.dataTransfer&&(t.dataTransfer.dropEffect="move"),t.cancelable&&t.preventDefault()}function tt(t,e,n,o,s,a,r,d){var c,l=t[K],m=l.options.onMove,u;return window.CustomEvent&&!ue&&!Ye?c=new CustomEvent("move",{bubbles:!0,cancelable:!0}):(c=document.createEvent("Event"),c.initEvent("move",!0,!0)),c.to=e,c.from=t,c.dragged=n,c.draggedRect=o,c.related=s||e,c.relatedRect=a||_(e),c.willInsertAfter=d,c.originalEvent=r,t.dispatchEvent(c),m&&(u=m.call(l,c,r)),u}function xt(t){t.draggable=!1}function ha(){$t=!1}function ya(t,e,n){var o=_(ke(n.el,0,n.options,!0)),s=eo(n.el,n.options,P),a=10;return e?t.clientX<s.left-a||t.clientY<o.top&&t.clientX<o.right:t.clientY<s.top-a||t.clientY<o.bottom&&t.clientX<o.left}function ba(t,e,n){var o=_(Kt(n.el,n.options.draggable)),s=eo(n.el,n.options,P),a=10;return e?t.clientX>s.right+a||t.clientY>o.bottom&&t.clientX>o.left:t.clientY>s.bottom+a||t.clientX>o.right&&t.clientY>o.top}function va(t,e,n,o,s,a,r,d){var c=o?t.clientY:t.clientX,l=o?n.height:n.width,m=o?n.top:n.left,u=o?n.bottom:n.right,p=!1;if(!r){if(d&&at<l*s){if(!qe&&(Re===1?c>m+l*a/2:c<u-l*a/2)&&(qe=!0),qe)p=!0;else if(Re===1?c<m+at:c>u-at)return-Re}else if(c>m+l*(1-s)/2&&c<u-l*(1-s)/2)return Sa(e)}return p=p||r,p&&(c<m+l*a/2||c>u-l*a/2)?c>m+l/2?1:-1:0}function Sa(t){return ee(f)<ee(t)?1:-1}function Ea(t){for(var e=t.tagName+t.className+t.src+t.href+t.textContent,n=e.length,o=0;n--;)o+=e.charCodeAt(n);return o.toString(36)}function wa(t){ut.length=0;for(var e=t.getElementsByTagName("input"),n=e.length;n--;){var o=e[n];o.checked&&ut.push(o)}}function rt(t){return setTimeout(t,0)}function Ut(t){return clearTimeout(t)}yt&&C(document,"touchmove",function(t){(E.active||Ie)&&t.cancelable&&t.preventDefault()});E.utils={on:C,off:j,css:S,find:Kn,is:function(e,n){return!!ne(e,n,e,!1)},extend:sa,throttle:Vn,closest:ne,toggleClass:Q,clone:Zn,index:ee,nextTick:rt,cancelNextTick:Ut,detectDirection:no,getChild:ke,expando:K};E.get=function(t){return t[K]};E.mount=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];e[0].constructor===Array&&(e=e[0]),e.forEach(function(o){if(!o.prototype||!o.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(o));o.utils&&(E.utils=re(re({},E.utils),o.utils)),We.mount(o)})};E.create=function(t,e){return new E(t,e)};E.version=na;var N=[],_e,Ft,Rt=!1,At,It,mt,Oe;function Pa(){function t(){this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0};for(var e in this)e.charAt(0)==="_"&&typeof this[e]=="function"&&(this[e]=this[e].bind(this))}return t.prototype={dragStarted:function(n){var o=n.originalEvent;this.sortable.nativeDraggable?C(document,"dragover",this._handleAutoScroll):this.options.supportPointer?C(document,"pointermove",this._handleFallbackAutoScroll):o.touches?C(document,"touchmove",this._handleFallbackAutoScroll):C(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(n){var o=n.originalEvent;!this.options.dragOverBubble&&!o.rootEl&&this._handleAutoScroll(o)},drop:function(){this.sortable.nativeDraggable?j(document,"dragover",this._handleAutoScroll):(j(document,"pointermove",this._handleFallbackAutoScroll),j(document,"touchmove",this._handleFallbackAutoScroll),j(document,"mousemove",this._handleFallbackAutoScroll)),hn(),it(),aa()},nulling:function(){mt=Ft=_e=Rt=Oe=At=It=null,N.length=0},_handleFallbackAutoScroll:function(n){this._handleAutoScroll(n,!0)},_handleAutoScroll:function(n,o){var s=this,a=(n.touches?n.touches[0]:n).clientX,r=(n.touches?n.touches[0]:n).clientY,d=document.elementFromPoint(a,r);if(mt=n,o||this.options.forceAutoScrollFallback||Ye||ue||$e){Lt(n,this.options,d,o);var c=ge(d,!0);Rt&&(!Oe||a!==At||r!==It)&&(Oe&&hn(),Oe=setInterval(function(){var l=ge(document.elementFromPoint(a,r),!0);l!==c&&(c=l,it()),Lt(n,s.options,l,o)},10),At=a,It=r)}else{if(!this.options.bubbleScroll||ge(d,!0)===ae()){it();return}Lt(n,this.options,ge(d,!1),!1)}}},de(t,{pluginName:"scroll",initializeByDefault:!0})}function it(){N.forEach(function(t){clearInterval(t.pid)}),N=[]}function hn(){clearInterval(Oe)}var Lt=Vn(function(t,e,n,o){if(e.scroll){var s=(t.touches?t.touches[0]:t).clientX,a=(t.touches?t.touches[0]:t).clientY,r=e.scrollSensitivity,d=e.scrollSpeed,c=ae(),l=!1,m;Ft!==n&&(Ft=n,it(),_e=e.scroll,m=e.scrollFn,_e===!0&&(_e=ge(n,!0)));var u=0,p=_e;do{var h=p,y=_(h),w=y.top,T=y.bottom,O=y.left,I=y.right,$=y.width,F=y.height,W=void 0,z=void 0,X=h.scrollWidth,v=h.scrollHeight,M=S(h),U=h.scrollLeft,q=h.scrollTop;h===c?(W=$<X&&(M.overflowX==="auto"||M.overflowX==="scroll"||M.overflowX==="visible"),z=F<v&&(M.overflowY==="auto"||M.overflowY==="scroll"||M.overflowY==="visible")):(W=$<X&&(M.overflowX==="auto"||M.overflowX==="scroll"),z=F<v&&(M.overflowY==="auto"||M.overflowY==="scroll"));var se=W&&(Math.abs(I-s)<=r&&U+$<X)-(Math.abs(O-s)<=r&&!!U),H=z&&(Math.abs(T-a)<=r&&q+F<v)-(Math.abs(w-a)<=r&&!!q);if(!N[u])for(var ie=0;ie<=u;ie++)N[ie]||(N[ie]={});(N[u].vx!=se||N[u].vy!=H||N[u].el!==h)&&(N[u].el=h,N[u].vx=se,N[u].vy=H,clearInterval(N[u].pid),(se!=0||H!=0)&&(l=!0,N[u].pid=setInterval((function(){o&&this.layer===0&&E.active._onTouchMove(mt);var fe=N[this.layer].vy?N[this.layer].vy*d:0,V=N[this.layer].vx?N[this.layer].vx*d:0;typeof m=="function"&&m.call(E.dragged.parentNode[K],V,fe,t,mt,N[this.layer].el)!=="continue"||Qn(N[this.layer].el,V,fe)}).bind({layer:u}),24))),u++}while(e.bubbleScroll&&p!==c&&(p=ge(p,!1)));Rt=l}},30),ro=function(e){var n=e.originalEvent,o=e.putSortable,s=e.dragEl,a=e.activeSortable,r=e.dispatchSortableEvent,d=e.hideGhostForTarget,c=e.unhideGhostForTarget;if(n){var l=o||a;d();var m=n.changedTouches&&n.changedTouches.length?n.changedTouches[0]:n,u=document.elementFromPoint(m.clientX,m.clientY);c(),l&&!l.el.contains(u)&&(r("spill"),this.onSpill({dragEl:s,putSortable:o}))}};function Vt(){}Vt.prototype={startIndex:null,dragStart:function(e){var n=e.oldDraggableIndex;this.startIndex=n},onSpill:function(e){var n=e.dragEl,o=e.putSortable;this.sortable.captureAnimationState(),o&&o.captureAnimationState();var s=ke(this.sortable.el,this.startIndex,this.options);s?this.sortable.el.insertBefore(n,s):this.sortable.el.appendChild(n),this.sortable.animateAll(),o&&o.animateAll()},drop:ro};de(Vt,{pluginName:"revertOnSpill"});function Qt(){}Qt.prototype={onSpill:function(e){var n=e.dragEl,o=e.putSortable,s=o||this.sortable;s.captureAnimationState(),n.parentNode&&n.parentNode.removeChild(n),s.animateAll()},drop:ro};de(Qt,{pluginName:"removeOnSpill"});E.mount(new Pa);E.mount(Qt,Vt);function ja({unmount:t,groupData:e,allAgents:n,onSave:o}){const[s,a]=A.useState(""),[r,d]=A.useState([]),[c,l]=A.useState("manual"),[m,u]=A.useState(""),[p,h]=A.useState(""),[y,w]=A.useState(1),[T,O]=A.useState(0),I=A.useRef(null);A.useEffect(()=>{if(e){a(e.name||"");const v=(e.agents||[]).filter(M=>n&&n.hasOwnProperty(M));d(v),l(e.flowType||"manual"),u(e.moderatorAgent||""),w(e.maxTurns||1),O(e.timerInSeconds||0)}else a("New Group"),d([]),l("manual"),u(""),w(1),O(0)},[e,n]),A.useEffect(()=>{m&&!r.includes(m)&&u("")},[r,m]),A.useEffect(()=>{if(I.current){const v=E.create(I.current,{animation:150,handle:".agent-sortable-item",onEnd:M=>{const U=[...r],[q]=U.splice(M.oldIndex,1);U.splice(M.newIndex,0,q),d(U)}});return()=>v.destroy()}},[r]);const $=v=>{const M=r.includes(v);d(M?U=>U.filter(q=>q!==v):U=>[...U,v])},F=()=>{o({name:s,members:r,flowType:c,moderator:m,maxTurns:y,timerInSeconds:T})},{selectedList:W,availableList:z}=A.useMemo(()=>{const v=p.toLowerCase(),M=Object.keys(n),U=new Set(r),q=r.filter(H=>H.toLowerCase().includes(v)),se=M.filter(H=>!U.has(H)&&H.toLowerCase().includes(v)).sort();return{selectedList:q,availableList:se}},[p,n,r]),X=r.map(v=>g.jsx("option",{value:v,children:v},v));return g.jsx("div",{id:"agent-group-editor-modal",className:"modal-overlay",style:{display:"flex"},children:g.jsxs("div",{className:"modal-box is-resizable",children:[g.jsxs("div",{className:"modal-header",children:[g.jsx("h3",{id:"agent-group-modal-title",children:e?`Edit Group: ${s}`:"Create New Agent Group"}),g.jsx("button",{type:"button",className:"modal-close-btn",title:"Close",onClick:t,children:"×"})]}),g.jsxs("div",{className:"modal-body",style:{display:"flex",flexDirection:"column"},children:[g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-name-input",children:"Group Name"}),g.jsx("input",{type:"text",id:"group-name-input",value:s,onChange:v=>a(v.target.value)})]}),g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-flow-select",children:"Conversation Flow"}),g.jsxs("select",{id:"group-flow-select",value:c,onChange:v=>l(v.target.value),children:[g.jsx("option",{value:"manual",children:"Manual Selection"}),g.jsx("option",{value:"round-robin",children:"Round Robin"}),g.jsx("option",{value:"auto-moderator",children:"Automated Moderator"})]})]}),c==="round-robin"&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-max-turns-input",children:"Rounds (1-8)"}),g.jsx("input",{type:"number",id:"group-max-turns-input",value:y,onChange:v=>w(Math.max(1,Math.min(8,parseInt(v.target.value,10)))),min:"1",max:"8"})]}),c==="auto-moderator"&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-timer-input",children:"Timer (0-180 seconds)"}),g.jsx("input",{type:"number",id:"group-timer-input",value:T,onChange:v=>O(parseInt(v.target.value,10)),min:"0",max:"180",step:"10"}),g.jsx("p",{className:"modal-warning",children:"ใส่ 0 เพื่อให้ Moderator ทำงานรอบเดียวแล้วหยุด (โหมดปกติ)"})]}),g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-moderator-select",children:"Moderator Agent"}),g.jsxs("select",{id:"group-moderator-select",value:m,onChange:v=>u(v.target.value),disabled:r.length===0,children:[g.jsx("option",{value:"",children:"-- Select from members --"}),X]})]}),g.jsxs("div",{className:"form-group",style:{display:"flex",flexDirection:"column"},children:[g.jsxs("label",{children:["Group Members (",r.length," selected)"]}),g.jsx("input",{type:"text",placeholder:"Search agents...",value:p,onChange:v=>h(v.target.value),style:{marginBottom:"10px"}}),g.jsxs("div",{id:"group-member-list",children:[g.jsx("div",{ref:I,children:W.map(v=>g.jsxs("div",{className:"agent-sortable-item","data-id":v,children:[g.jsx("input",{type:"checkbox",id:`agent-cb-${v}`,checked:!0,onChange:()=>$(v)}),g.jsxs("label",{htmlFor:`agent-cb-${v}`,children:[n[v]?.icon||"🤖"," ",v]})]},v))}),W.length>0&&z.length>0&&g.jsx("hr",{style:{margin:"10px 0"}}),g.jsx("div",{children:z.map(v=>g.jsxs("div",{className:"agent-sortable-item",children:[g.jsx("input",{type:"checkbox",id:`agent-cb-${v}`,checked:!1,onChange:()=>$(v)}),g.jsxs("label",{htmlFor:`agent-cb-${v}`,children:[n[v]?.icon||"🤖"," ",v]})]},v))})]})]})]}),g.jsxs("div",{className:"modal-actions",children:[g.jsx("button",{className:"btn btn-secondary",onClick:t,children:"ยกเลิก"}),g.jsx("button",{className:"btn",onClick:F,children:"บันทึก Group"})]})]})})}function Ca(){console.warn("saveAgentGroup is deprecated and should not be called from the new UI.");const t=i.getProject(),e=i.getState().editingGroupName,n=document.getElementById("group-name-input").value.trim();if(!n){b("Group name cannot be empty.","Error");return}if(n!==e&&t.agentGroups[n]){b(`A group named "${n}" already exists.`,"Error");return}const o=document.getElementById("group-moderator-select").value;if(!o){b("Please select a Moderator for the group.","Error");return}const s=window.groupSortable?window.groupSortable.toArray():[],a=document.querySelectorAll("#group-member-list .agent-sortable-item"),r=Array.from(a).filter(l=>l.querySelector('input[type="checkbox"]').checked).map(l=>l.dataset.agentName),d=s.filter(l=>r.includes(l));if(d.length===0){b("A group must have at least one member.","Error");return}const c={agents:d,moderatorAgent:o,flowType:document.getElementById("group-flow-select").value,maxTurns:parseInt(document.getElementById("group-max-turns-input").value,10),timerInSeconds:parseInt(document.getElementById("group-timer-input").value,10)};e&&e!==n&&(delete t.agentGroups[e],t.chatSessions.forEach(l=>{l.linkedEntity?.type==="group"&&l.linkedEntity.name===e&&(l.linkedEntity.name=n)})),t.agentGroups[n]=c,i.setProject(t),i.updateAndPersistState(),i.bus.publish("group:editorShouldClose"),b(`Group "${n}" saved successfully.`,"Success"),i.bus.publish("studio:contentShouldRender")}function xa({groupName:t}){if(!confirm(`Are you sure you want to delete the group "${t}"? This cannot be undone.`))return;const e=i.getProject();delete e.agentGroups[t],i.setProject(e),i.updateAndPersistState(),i.bus.publish("studio:contentShouldRender"),b(`Group "${t}" has been deleted.`,"Success")}function Aa(t,e){const n=i.getProject(),o=t.name.trim();if(!o){b("Group name cannot be empty.","Error");return}if(o!==e&&n.agentGroups[o]){b(`A group named "${o}" already exists.`,"Error");return}e&&e!==o&&delete n.agentGroups[e],n.agentGroups[o]={agents:t.members,moderatorAgent:t.moderator,flowType:t.flowType,maxTurns:t.maxTurns,timerInSeconds:t.timerInSeconds},i.setProject(n),i.updateAndPersistState(),b(`Group "${o}" saved successfully.`,"Success"),i.bus.publish("studio:contentShouldRender")}function Ia(t){const n=i.getProject().activeEntity,o=i.getStagedEntity(),s=document.createElement("div");return s.className="item group-item",s.dataset.groupName=t,n?.type==="group"&&n.name===t?s.classList.add("active"):o?.type==="group"&&o.name===t&&s.classList.add("staged"),s.innerHTML=`
     <div class="item-header">
        <span class="item-name"><span class="item-icon">🤝</span> ${t}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="group:edit" title="Edit Group">
                <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="btn-icon danger" data-action="group:delete" title="Delete Group">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,s}function La(t){if(!t)return;const e=i.getProject();if(!e||!e.agentGroups)return;t.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>🤝 Agent Groups</h3>
                <button class="btn-icon" data-action="group:create" title="Create New Group">+</button>
            </summary>
            <div class="section-box">
                <div id="agentGroupList" class="item-list"></div>
            </div>
        </details>
    `);const o=t.querySelector("#agentGroupList:last-of-type");if(!o)return;const s=e.agentGroups;for(const a in s)o.appendChild(Ia(a))}function Ta(){const t=document.getElementById("group-flow-select").value,e=document.getElementById("group-rounds-control"),n=document.getElementById("group-timer-control");!e||!n||(t==="round-robin"?(e.classList.remove("hidden"),n.classList.add("hidden")):(e.classList.add("hidden"),n.classList.remove("hidden")))}function yn(t=!1,e=null){const n=i.getProject(),o=t?{name:e,...n.agentGroups[e]}:null,s=n.agentPresets||{},a=document.getElementById("react-modal-root");a&&An(ja,{groupData:o,allAgents:s,onSave:d=>{Aa(d,e),qt()}},a)}function qt(){const t=document.getElementById("react-modal-root");t&&(t.innerHTML=""),i.setState("editingGroupName",null)}function Ma(){i.bus.subscribe("group:editorShouldClose",qt);const t=document.getElementById("agent-group-editor-modal");t&&(t.addEventListener("click",e=>{e.target.matches(".modal-actions .btn:not(.btn-secondary)")?i.bus.publish("group:save"):(e.target.matches(".btn-secondary")||e.target.closest(".modal-close-btn"))&&qt()}),t.addEventListener("click",e=>{if(e.target.matches(".stepper-btn")){const n=e.target.parentElement.querySelector('input[type="number"]');if(!n)return;let o=parseInt(n.value,10)+parseInt(e.target.dataset.step,10);o=Math.max(n.min,Math.min(n.max,o)),n.value=o}})),document.getElementById("group-flow-select")?.addEventListener("change",Ta),console.log("✅ Group UI Initialized (Studio listener removed).")}let Tt=null;function Da(t,e,n){const o=document.createElement("div");o.className=`item memory-item ${e?"":"inactive"}`,o.dataset.name=t.name,o.dataset.memoryIndex=n;const a=jn([{label:"Edit...",action:"memory:edit",data:{index:n}},{label:"Delete",action:"memory:delete",data:{index:n},isDestructive:!0}]),r=document.createElement("div");r.className=`memory-toggle ${e?"active":""}`,r.title=`Click to ${e?"deactivate":"activate"}`,r.onclick=l=>{l.stopPropagation(),i.bus.publish("memory:toggle",{name:t.name})};const d=document.createElement("span");d.className="item-name",d.textContent=t.name;const c=document.createElement("div");return c.className="item-header",c.appendChild(r),c.appendChild(d),c.appendChild(a),o.appendChild(c),o}function ka(t){if(!t)return;const e=i.getProject();if(!e)return;const n=document.createElement("details");n.className="collapsible-section memory-section",n.open=!0;const o=document.createElement("summary");o.className="section-header",o.innerHTML="<h3>🧠 Command Memories</h3>";const s=[{label:"New Memory...",action:"memory:create"},{label:"Export Package...",action:"memory:exportPackage"},{label:"Import Package...",action:"memory:importPackage"}];o.appendChild(jn(s)),n.appendChild(o);const a=document.createElement("div");a.className="section-box",n.appendChild(a);const r=e.agentPresets?.[e.activeEntity?.name];if(!r)a.innerHTML='<p class="no-items-message">Select an Agent to see memories.</p>';else{a.innerHTML=`
            <details id="active-memories-details" open><summary>Active Memories</summary><div id="activeMemoriesList" class="item-list"></div></details>
            <details id="inactiveMemoriesSection" open><summary>Inactive Memories</summary><div id="inactiveMemoriesList" class="item-list"></div></details>
        `;const d=a.querySelector("#activeMemoriesList"),c=a.querySelector("#inactiveMemoriesList"),l=r.activeMemories||[];(e.memories||[]).forEach((u,p)=>{const h=l.includes(u.name);(h?d:c).appendChild(Da(u,h,p))}),Tt&&Tt.destroy(),Tt=new Sortable(d,{animation:150,onEnd:u=>{const p=i.getProject().agentPresets[i.getProject().activeEntity.name];if(!p)return;const h=u.item.dataset.name;p.activeMemories.splice(u.oldDraggableIndex,1),p.activeMemories.splice(u.newDraggableIndex,0,h),i.bus.publish("studio:contentShouldRender")}})}t.appendChild(n)}function bn(t=null){const e=i.getProject(),n=document.getElementById("memory-editor-modal");if(!n)return;const o=e.memories||[];if(t!==null&&o[t]){const s=o[t];console.log("Editing memory at",t,s),n.querySelector("#memory-modal-title").textContent="Edit Memory",n.querySelector("#memory-name-input").value=s.name,n.querySelector("#memory-content-input").value=s.content,n.querySelector("#memory-edit-index").value=t}else console.log("Create new memory",t,o),n.querySelector("#memory-modal-title").textContent="Create New Memory",n.querySelector("#memory-name-input").value="",n.querySelector("#memory-content-input").value="",n.querySelector("#memory-edit-index").value="";n.style.display="flex"}function vn(){document.getElementById("memory-editor-modal").style.display="none"}function Ba(){i.bus.subscribe("memory:editorShouldClose",vn);const t=document.getElementById("memory-editor-modal");t&&t.addEventListener("click",e=>{const n=e.target;n.matches(".modal-actions .btn:not(.btn-secondary)")&&i.bus.publish("memory:save"),(n.matches(".btn-secondary")||n.closest(".modal-close-btn")||n===t)&&vn()})}function Na(){const t=i.getProject();if(!t||!t.agentPresets)return[];const e=document.getElementById("asset-search-input")?.value.toLowerCase()||"",n=document.getElementById("asset-sort-select")?.value||"modified-desc";let o=Object.entries(t.agentPresets).map(([s,a])=>({name:s,...a}));return e&&(o=o.filter(s=>[s.name,s.id,s.description,s.model,...s.tags||[]].join(" ").toLowerCase().includes(e))),o.sort((s,a)=>{switch(n){case"modified-desc":return a.modifiedAt-s.modifiedAt;case"modified-asc":return s.modifiedAt-a.modifiedAt;case"created-desc":return a.createdAt-s.createdAt;case"created-asc":return s.createdAt-a.createdAt;case"name-asc":return s.name.localeCompare(a.name);case"name-desc":return a.name.localeCompare(s.name);default:return 0}}),o}function _a(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=o=>{try{const s=JSON.parse(o.target.result);if(typeof s!="object"||s===null||Array.isArray(s))throw new Error("Invalid file format. Expected a JSON object of agents.");const a=i.getProject();let r=0,d=0;for(const c in s)a.agentPresets[c]?confirm(`Agent "${c}" already exists. Overwrite?`)&&(a.agentPresets[c]=s[c],d++):(a.agentPresets[c]=s[c],r++);i.setProject(a),i.updateAndPersistState(),i.bus.publish("studio:contentShouldRender"),b(`Import complete! Added: ${r}, Overwritten: ${d}.`,"Success")}catch(s){console.error("Failed to import agents:",s),b(`Error importing agents: ${s.message}`,"Error")}},n.readAsText(e),t.target.value=""}function Ae(){const t=document.querySelector("#studio-panel .studio-assets-container");if(!t)return;t.innerHTML="";const e=Na();Js(t,e),La(t),ka(t)}function Oa(){const t=document.getElementById("studio-panel");if(!t||t.dataset.listenerAttached==="true")return;t.dataset.listenerAttached="true",t.addEventListener("click",s=>{const a=s.target,r=a.closest(".memory-toggle");if(r){s.stopPropagation();const l=r.closest(".item[data-name]");l&&i.bus.publish("memory:toggle",{name:l.dataset.name});return}const d=a.closest("[data-action]");if(d){s.preventDefault(),s.stopPropagation();const l=d.dataset.action;let u={...a.closest(".item")?.dataset};if(d.dataset.data)try{const p=JSON.parse(d.dataset.data);Object.assign(u,p)}catch(p){console.error("Failed to parse data attribute JSON",p)}l==="toggle-menu"?ze(s):(i.bus.publish(l,u),d.closest(".dropdown.open")?.classList.remove("open"));return}const c=a.closest(".item");if(c){s.preventDefault();const{agentName:l,groupName:m}=c.dataset;l?i.bus.publish("studio:itemClicked",{type:"agent",name:l}):m&&i.bus.publish("studio:itemClicked",{type:"group",name:m});return}});const e=document.getElementById("asset-search-input"),n=document.getElementById("asset-sort-select");e?.addEventListener("input",Ae),n?.addEventListener("change",Ae),document.getElementById("import-agents-input")?.addEventListener("change",_a),i.bus.subscribe("project:loaded",Ae),i.bus.subscribe("studio:contentShouldRender",Ae),i.bus.subscribe("entity:selected",Ae),i.bus.subscribe("entity:staged",Ae),console.log("✅ Studio UI Initialized with definitive, robust event listeners.")}async function $a(){const t=document.getElementById("enhancer-prompt-input").value.trim();if(!t){b("Please describe the agent you want to create or enhance.","Error");return}const e=i.getProject().globalSettings.systemUtilityAgent;if(!e||!e.model){b("System Utility Model not configured in Settings.","Error");return}const n=document.getElementById("generate-agent-profile-btn");n&&n.classList.add("is-loading"),i.bus.publish("agent:enhancerStatus",{text:"Processing request...",color:"var(--text-dark)"});try{const o=!!i.getState().editingAgentName;let s="";o?s=`You are an expert in refining LLM system prompts. Your task is to modify an existing system prompt based on a user's new request. Do not replace the original prompt, but integrate the new instruction into it cohesively. Respond ONLY with the new, complete, and modified system prompt as a single block of text.

            EXISTING PROMPT:
            ---
            ${document.getElementById("agent-system-prompt").value}
            ---

            USER'S MODIFICATION REQUEST:
            ---
            ${t}
            ---

            NEW, MODIFIED SYSTEM PROMPT:`:s=`You are an expert in designing LLM agent profiles. Based on the user's request, create a complete agent profile.
            Your response MUST be ONLY a single, valid JSON object with these exact keys:
            - "agent_name": string
            - "agent_icon": string (a single emoji)
            - "system_prompt": string
            - "temperature": number (between 0 and 2)
            - "top_p": number (between 0 and 1)
            - "top_k": integer (0 or higher)
            - "max_tokens": integer (e.g., 4096)
            - "frequency_penalty": number (between -2 and 2)
            - "presence_penalty": number (between -2 and 2)
            - "seed": integer (-1 for random)

            User's Request: "${t}"`;const a=await vo(e,[{role:"user",content:s}]);if(!a||typeof a.content!="string")throw new Error("Received an invalid or empty response from the AI.");if(o)i.bus.publish("agent:promptEnhanced",{newPrompt:a.content}),i.bus.publish("agent:enhancerStatus",{text:"Prompt enhanced successfully!",color:"var(--success-color)"});else{const r=a.content.match(/{.*}/s);if(!r)throw new Error("LLM did not return a valid JSON object.");const d=JSON.parse(r[0]);i.bus.publish("agent:profileGenerated",d),i.bus.publish("agent:enhancerStatus",{text:"Profile generated successfully!",color:"var(--success-color)"})}}catch(o){console.error("Agent Profile Generation/Enhancement Error:",o);const s=`Error: ${o.message}`;i.bus.publish("agent:enhancerStatus",{text:s,color:"var(--error-color)"}),b(s,"Profile Generation Failed")}finally{n&&n.classList.remove("is-loading"),setTimeout(()=>i.bus.publish("agent:enhancerStatus",{text:""}),5e3)}}function Ua(){const t=i.getProject(),e=i.getState().editingAgentName,n=document.getElementById("agent-name-input").value.trim();if(!n){b("Please enter a name for the agent.","Error");return}if(e!==n&&t.agentPresets[n]){b(`An agent named '${n}' already exists.`,"Error");return}if(!document.getElementById("agent-model-select").value){b("You must select a model for the agent before saving.","Model Required");const l=document.getElementById("agent-model-search-wrapper");l&&(l.classList.add("has-warning"),setTimeout(()=>l.classList.remove("has-warning"),2e3));return}const s={icon:document.getElementById("agent-icon-button").textContent,description:document.getElementById("agent-description").value,model:document.getElementById("agent-model-select").value,systemPrompt:document.getElementById("agent-system-prompt").value,useMarkdown:document.getElementById("agent-use-markdown").checked,enableWebSearch:document.getElementById("agent-enable-web-search").checked,profilePicture:document.getElementById("agent-profile-picture-preview").src,tags:Array.from(document.querySelectorAll("#agent-tags-container .tag-pill")).map(l=>l.dataset.tag),activeMemories:Array.from(document.querySelectorAll("#agent-memory-list .item input:checked")).map(l=>l.closest(".item").dataset.memoryName)},a=i.getState().activeParameterEditor,r=a?a.getValues():{},d={...s,...r},c=e&&t.agentPresets[e]?{...t.agentPresets[e]}:{...gt,id:`agent_${Date.now()}`,createdBy:UserService.getCurrentUserProfile().userName,createdAt:Date.now()};c.modifiedAt=Date.now(),c.createdBy=document.getElementById("agent-created-by-input").value,Object.assign(c,d),e&&e!==n&&delete t.agentPresets[e],t.agentPresets[n]=c,(!e||t.activeEntity&&t.activeEntity.name===e)&&(t.activeEntity={type:"agent",name:n}),i.setProject(t),i.updateAndPersistState(),i.bus.publish("studio:contentShouldRender"),i.bus.publish("agent:editorShouldClose")}function Fa(t){const e=i.getProject();if(!t||Object.keys(e.agentPresets).length<=1){b("Cannot delete the last agent.","Error");return}confirm(`Are you sure you want to delete the agent '${t}'? This action cannot be undone.`)&&(delete e.agentPresets[t],Object.values(e.agentGroups).forEach(n=>{n.agents=n.agents.filter(o=>o!==t),n.moderatorAgent===t&&(n.moderatorAgent=n.agents[0]||"")}),e.chatSessions.forEach(n=>{n.linkedEntity?.type==="agent"&&n.linkedEntity.name===t&&(n.linkedEntity={type:"agent",name:Object.keys(e.agentPresets)[0]})}),e.activeEntity.type==="agent"&&e.activeEntity.name===t&&(e.activeEntity={type:"agent",name:Object.keys(e.agentPresets)[0]}),i.setProject(e),i.updateAndPersistState(),i.bus.publish("agent:listChanged"),i.bus.publish("entity:selected",e.activeEntity))}function Ra({name:t}){const e=i.getProject(),n=e.activeEntity?.name;if(!n)return;const o=e.agentPresets[n];if(!o)return;o.activeMemories||(o.activeMemories=[]),o.activeMemories.includes(t)?o.activeMemories=o.activeMemories.filter(a=>a!==t):o.activeMemories.push(t),i.updateAndPersistState(),i.bus.publish("studio:contentShouldRender")}function qa(){const t=i.getProject(),e=document.getElementById("memory-name-input").value.trim(),n=document.getElementById("memory-content-input").value,o=document.getElementById("memory-edit-index").value;if(!e){b("Memory name cannot be empty.","Error");return}if(o!==""){const s=t.memories[o].name;t.memories[o]={name:e,content:n},Object.values(t.agentPresets).forEach(a=>{if(a.activeMemories){const r=a.activeMemories.indexOf(s);r>-1&&(a.activeMemories[r]=e)}})}else{if(t.memories.some(s=>s.name===e)){b(`A memory named "${e}" already exists.`,"Error");return}t.memories.push({name:e,content:n})}i.setProject(t),i.updateAndPersistState(),i.bus.publish("memory:editorShouldClose"),i.bus.publish("studio:contentShouldRender"),b(`Memory "${e}" saved successfully.`,"Success")}function Ha({index:t}){if(!confirm("Are you sure you want to permanently delete this memory? This cannot be undone."))return;const e=i.getProject();if(!e.memories[t])return;const n=e.memories[t].name;e.memories.splice(t,1),Object.values(e.agentPresets).forEach(o=>{o.activeMemories&&(o.activeMemories=o.activeMemories.filter(s=>s!==n))}),i.setProject(e),i.updateAndPersistState(),i.bus.publish("studio:contentShouldRender")}function Ga(){const e={memories:i.getProject().memories},n=JSON.stringify(e,null,2),o=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(o),a=document.createElement("a");a.href=s,a.download=`promptprim_memories_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}function za(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=o=>{try{const s=JSON.parse(o.target.result);if(s&&Array.isArray(s.memories)){const a=i.getProject(),r=new Set(a.memories.map(c=>c.name)),d=s.memories.filter(c=>!r.has(c.name));a.memories.push(...d),i.setProject(a),i.updateAndPersistState(),i.bus.publish("studio:contentShouldRender"),b("Memory package imported successfully!","Success")}else throw new Error("Invalid memory package file.")}catch(s){b(`Error loading memory package: ${s.message}`,"Error")}},n.readAsText(e),t.target.value=""}function Ya(t){(void 0)({openrouterKey:t}),i.bus.publish("api:loadModels")}function Wa(t){(void 0)({ollamaBaseUrl:t})}function Xa(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=o=>{try{const s=JSON.parse(o.target.result);if(s&&s.userProfile&&s.appSettings&&s.modelPresets)confirm("This will overwrite your current settings and reload the application. Are you sure?")&&(localStorage.setItem("promptPrimUserSettings_v1",JSON.stringify(s)),b("Settings imported! The app will now reload.","Success"),setTimeout(()=>window.location.reload(),1500));else throw new Error("Invalid settings file format.")}catch(s){b(`Error importing settings: ${s.message}`,"Error")}},n.readAsText(e),t.target.value=""}function Mt(){const t=Ee();if(!t)return;const e=document.querySelector("#user-profile-menu .user-name"),n=document.querySelector("#user-profile-menu .user-plan"),o=document.getElementById("user-userCredits"),s=o?.querySelector("span:last-child"),a=document.querySelector("#user-profile-btn span");if(a&&t.userName&&(a.textContent=t.userName.charAt(0).toUpperCase()),e&&(e.textContent=t.userName||"User"),n){let r="Unknown",d="status-blocked";t.plan==="master"?(r=t.planStatus==="active"?"Master Plan":"Subscription Expired",d=t.planStatus==="active"?"status-master":"status-blocked"):t.plan==="pro"?t.planStatus==="active"&&t.credits.current>0?(r="Pro Plan",d="status-active"):t.planStatus==="grace_period"?(r="Pro (Grace Period)",d="status-grace"):(r="Account Blocked",d="status-blocked"):t.plan==="free"&&(r=t.credits.current>0?"Free Plan":"Credits Depleted",d=t.credits.current>0?"status-free":"status-blocked"),n.textContent=r,n.className=`user-plan ${d}`}if(o&&s)if(t.plan==="master")o.style.display="none";else{o.style.display="flex";const r=Cn(t.credits?.current??0);s.textContent=`$${r.toFixed(2)}`}}function Ja(){const t=document.querySelector(".user-profile-container"),e=document.getElementById("user-switcher-modal");!t||!e||(t.addEventListener("click",n=>{const o=n.target.closest("[data-action]");if(!o)return;const s=o.dataset.action;switch(s!=="toggle-menu"&&n.preventDefault(),s){case"toggle-menu":ze(n);break;case"user:account":i.bus.publish("ui:showAccountModal"),t.classList.remove("open");break;case"user:settings":So(),t.classList.remove("open");break;case"user:logout":e.style.display="flex",t.classList.remove("open");break}}),e.addEventListener("click",n=>{const o=n.target,s=o.closest("button[data-user-id]");if(s){const a=s.dataset.userId;Eo(a),b(`Switched to ${a}. The app will now reload.`,"Success"),e.style.display="none",setTimeout(()=>window.location.reload(),1500)}(o.matches(".modal-close-btn")||o===e)&&(e.style.display="none")}),wo("theme-switcher-dropdown"),i.bus.subscribe("user:settingsLoaded",Mt),i.bus.subscribe("user:settingsUpdated",Mt),Mt())}function Ka(t){const e=Ee();e&&confirm(`Are you sure you want to switch to the ${t} plan?`)&&(console.log(`HANDLER: Changing plan for ${e.userId} to ${t}`),Po(e.userId,t),b(`Successfully switched to ${t} plan!`,"Success"))}function Va(t){const e=Ee();e&&(console.log(`HANDLER: Refilling $${t} for ${e.userId}`),jo(e.userId,t),b(`Successfully added credits worth $${t}!`,"Success"))}const Se=document.getElementById("account-modal"),Dt=document.getElementById("account-modal-body");function Qa(){Se&&(io(),Se.style.display="flex")}function Za(){Se&&(Se.style.display="none")}function io(){const t=Ee();if(!Dt||!t){Dt.innerHTML="<p>Could not load user data.</p>";return}let e="";t.plan==="free"?e='<button class="btn" data-action="switch-plan" data-plan="pro">Upgrade to Pro</button>':t.plan==="pro"?e=`
            <button class="btn btn-secondary" data-action="switch-plan" data-plan="free">Downgrade to Free</button>
            <button class="btn" data-action="switch-plan" data-plan="master">Upgrade to Master</button>
        `:t.plan==="master"&&(e=`
            <button class="btn btn-secondary" data-action="switch-plan" data-plan="pro">Downgrade to Pro</button>
        `);const o=[10,30,50,100].map(a=>`<button class="btn btn-small btn-secondary" data-action="refill" data-amount="${a}">$${a}</button>`).join(""),s=Cn(t.credits.current);Dt.innerHTML=`
        <div class="user-detail-grid">
            <div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" value="${t.userName}" readonly>
                </div>
                 <div class="form-group">
                    <label>Current Plan</label>
                    <input type="text" value="${t.plan.charAt(0).toUpperCase()+t.plan.slice(1)}" readonly>
                </div>
                <div class="form-group">
                    <label>Credits</label>
                    <input type="text" value="${Math.floor(t.credits.current).toLocaleString()}" readonly>
                </div>
                <div class="form-group">
                    <label>Balance</label> 
                    <input type="text" value="$${s.toFixed(2)}" readonly>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>Change Plan</label>
                    <div>${e||"<p>No plan changes available.</p>"}</div>
                </div>
                <div class="form-group">
                    <label>Refill Credits (USD)</label>
                    <div class="refill-presets">${t.plan==="master"?"<p>Not applicable.</p>":o}</div>
                </div>
            </div>
        </div>
    `}function er(){i.bus.subscribe("ui:showAccountModal",Qa),Se?.addEventListener("click",t=>{if(t.target.matches(".modal-close-btn")){Za();return}const n=t.target.closest("[data-action]");if(!n)return;const o=n.dataset.action;o==="switch-plan"?Ka(n.dataset.plan):o==="refill"&&Va(parseInt(n.dataset.amount,10))}),i.bus.subscribe("user:settingsUpdated",()=>{Se&&Se.style.display==="flex"&&io()})}const pt=new marked.Renderer,tr=pt.link;pt.link=(t,e,n)=>tr.call(pt,t,e,n).replace(/^<a /,'<a target="_blank" rel="noopener noreferrer" ');marked.setOptions({renderer:pt,gfm:!0,breaks:!1});function nr(){window.addEventListener("storage",t=>{t.key==="promptPrimUserDatabase_v1"&&No()})}function or(){const t=i.bus;t.subscribe("project:new",Ot),t.subscribe("project:open",Bs),t.subscribe("project:fileSelectedForOpen",Ns),t.subscribe("project:save",e=>qn(e)),t.subscribe("project:saveConfirm",({projectName:e})=>Hn(e)),t.subscribe("project:unsavedChangesChoice",Os),t.subscribe("session:new",Fn),t.subscribe("session:loaded",({session:e})=>{_o(e.name),Oo(),Nt(),De(),i.bus.publish("entity:selected",e.linkedEntity)}),t.subscribe("session:cleared",()=>{$o(),Ss(),De()}),t.subscribe("session:autoRename",Ms),t.subscribe("session:rename",e=>Ps(e)),t.subscribe("session:clone",({sessionId:e,event:n})=>xs(e,n)),t.subscribe("session:archive",({sessionId:e,event:n})=>As(e,n)),t.subscribe("session:pin",({sessionId:e,event:n})=>Cs(e,n)),t.subscribe("session:delete",e=>js(e)),t.subscribe("session:download",({sessionId:e})=>Is({sessionId:e})),t.subscribe("agent:create",()=>rn(!1)),t.subscribe("agent:save",Ua),t.subscribe("agent:edit",({agentName:e})=>rn(!0,e)),t.subscribe("agent:delete",({agentName:e})=>Fa(e)),t.subscribe("agent:generateProfile",$a),t.subscribe("group:create",()=>yn(!1)),t.subscribe("group:save",Ca),t.subscribe("group:edit",({groupName:e})=>yn(!0,e)),t.subscribe("group:delete",({groupName:e})=>xa({groupName:e})),t.subscribe("memory:create",()=>bn(null)),t.subscribe("memory:save",qa),t.subscribe("memory:edit",({index:e})=>bn(e)),t.subscribe("memory:delete",({index:e})=>Ha({index:e})),t.subscribe("memory:toggle",e=>{Ra(e)}),t.subscribe("memory:exportPackage",Ga),t.subscribe("memory:importPackage",()=>{document.getElementById("load-memory-package-input").click()}),t.subscribe("studio:itemClicked",Ws),t.subscribe("summary:editFromChat",({logId:e})=>{kt(),setTimeout(()=>zt(e),50)}),t.subscribe("summary:generateNew",Yt),t.subscribe("summary:saveEdit",Mn),t.subscribe("summary:deleteLog",({logId:e})=>Dn({logId:e})),t.subscribe("summary:loadToContext",({logId:e})=>kn({logId:e})),t.subscribe("settings:saveSummaryPreset",e=>Nn(e)),t.subscribe("settings:renameSummaryPreset",e=>_n(e)),t.subscribe("settings:deleteSummaryPreset",e=>On(e)),t.subscribe("chat:clearSummaryContext",Uo),t.subscribe("summary:saveNewLog",e=>Tn(e)),t.subscribe("entity:select",({type:e,name:n})=>Ys(e,n)),t.subscribe("open-composer",()=>{i.bus.publish("ui:toggleComposer")}),t.subscribe("composer:heightChanged",Ls),t.subscribe("chat:deleteMessage",e=>Fo(e)),t.subscribe("chat:sendMessage",Ro),t.subscribe("chat:stopGeneration",qo),t.subscribe("chat:editMessage",({index:e})=>Ho({index:e})),t.subscribe("chat:copyMessage",({index:e,event:n})=>Go({index:e,event:n})),t.subscribe("chat:regenerateMessage",({index:e})=>zo({index:e})),t.subscribe("chat:fileUpload",e=>en(e)),t.subscribe("chat:filesSelected",e=>en(e)),t.subscribe("chat:removeFile",({index:e})=>Yo({index:e})),t.subscribe("chat:summarize",kt),t.subscribe("chat:clearSummary",Wo),t.subscribe("upload-file",()=>{document.getElementById("file-input")?.click()}),t.subscribe("api:loadModels",Ge),t.subscribe("api:loadUserModels",({apiKey:e,ollamaBaseUrl:n,isUserKey:o})=>{Ge({apiKey:e,ollamaBaseUrl:n,isUserKey:o})}),t.subscribe("settings:apiKeyChanged",Ya),t.subscribe("settings:ollamaUrlChanged",Wa),t.subscribe("settings:fontChanged",Gs),t.subscribe("settings:systemAgentChanged",zs),t.subscribe("group:manualSelectAgent",({agentName:e})=>{const n=i.getProject(),o=n.chatSessions.find(r=>r.id===n.activeSessionId),s=n.agentGroups[n.activeEntity.name];if(!o||!s)return;const a={type:"agent_turn",agentName:e};o.groupChatState.turnQueue.push(a),o.groupChatState.awaitsUserInput=!1,i.bus.publish("ui:renderAgentSelector"),Xo(n,o,s)}),console.log("✅ Central Event Bus ready.")}function sr(){Io(),ds(),ls(),Lo(),To(),gs(),fs(),Mo(),Do(),Es(),Oa(),Qs(),Ma(),Ba(),ko(),es(),Bo(),Ja(),er(),document.getElementById("import-settings-input")?.addEventListener("change",Xa),console.log("✅ All UI modules initialized.")}document.addEventListener("DOMContentLoaded",async()=>{const t=document.getElementById("loading-overlay");try{await Co();const e=Ee(),n=xo();await Ge({apiKey:n.openrouterKey,ollamaBaseUrl:n.ollamaBaseUrl,isUserKey:!1}),e&&e.plan==="master"&&await Ge({apiKey:e.apiSettings?.openrouterKey,ollamaBaseUrl:e.apiSettings?.ollamaBaseUrl,isUserKey:!0}),console.log("🚀 Application starting..."),sr(),nr(),or(),ks(),document.getElementById("load-memory-package-input").addEventListener("change",za);const o=localStorage.getItem("lastActiveProjectId");if(o){console.log(`Attempting to load last project with ID: ${o}`);try{await Fs(o)}catch(s){console.error(`[RECOVERY] Failed to load last project (ID: ${o}). This is likely due to corrupted data.`,s),alert("Could not load your last project due to an error. A new project will be created."),localStorage.removeItem("lastActiveProjectId"),console.log("[RECOVERY] Creating a new project as a fallback."),await Ot()}}else await Ot();t?.classList.remove("active"),console.log("🎉 Application initialized successfully.")}catch(e){console.error("[FATAL STARTUP ERROR]",e),t.querySelector("p").textContent=`A critical error occurred: ${e.message}`}});window.UserService=Ao;
