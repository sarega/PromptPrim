import"./main-DAw_gB5G.js";import{R as Gy,j as g,a as ot,r as T,b as Jy,g as am,c as lm}from"./client-CZ2o165L.js";import{s as k,g as id,a as cm,b as h,c as Kn,d as Ft,e as Sa,f as tn,h as To,S as Zn,i as wt,u as ss,j as ie,k as dm,l as ze,n as ad,m as so,o as Yy,p as Nn,q as Bt,r as ka,t as ld,F as cd,v as um,w as pm,x as fm,y as mm,z as hm,A as gm,B as io,C as _o,D as bm,E as Xy,G as Qy,H as ko,I as dd,J as Zy,K as mi,L as ew,M as tw,N as ud,O as ym,P as nw,Q as is,R as ow,T as rw,U as $r,V as xa,W as Ca,X as wm,Y as sw,Z as vm,_ as pd,$ as iw,a0 as fd,a1 as Ea,a2 as aw,a3 as Sn,a4 as Tu,a5 as lw,a6 as Sm,a7 as cw,a8 as at,a9 as as,aa as Pu,ab as Ms,ac as dw,ad as km,ae as hi,af as xm,ag as Cm,ah as Bu,ai as md,aj as uw,ak as pw,al as fw,am as mw,an as gi,ao as hw,ap as gw,aq as Em,ar as bw,as as yw,at as ww,au as vw,av as Sw,aw as kw,ax as xw,ay as Cw,az as Ew,aA as Iw,aB as Aw,aC as Nw,aD as Mw,aE as Tw,aF as Pw,aG as Bw,aH as Ow,aI as Lw,aJ as Dw,aK as Rw,aL as jw,aM as Ou,aN as _w,aO as $w,aP as Fw}from"./core.theme-Dg-InXk9.js";const Ts={},ao={mount(t,e,n){if(!n)return;const o=n.id;if(!o){console.error("ReactBridge Error: Target element must have an ID.");return}let r=Ts[o];r||(r=Gy.createRoot(n),Ts[o]=r),r.render(g.jsx(ot.StrictMode,{children:g.jsx(t,{...e,unmount:()=>this.unmount(n)})}))},unmount(t){if(!t||!t.id)return;const e=Ts[t.id];e&&(e.unmount(),delete Ts[t.id])}};function Ww(t){const e=document.getElementById("preset-selector"),n=document.getElementById("preset-name-input"),o=e.value,r=n.value.trim();if(!r){k("Preset name cannot be empty.","Error");return}if(t.size===0){k("Please select at least one model for the preset.","Error");return}const s=r.toLowerCase().replace(/\s+/g,"_"),i=id();o!=="--new--"&&o!==s&&delete i[o],i[s]={name:r,modelIds:Array.from(t)},cm(i),k(`User Preset "${r}" saved successfully!`,"Success"),h.bus.publish("user:presetsChanged")}function zw(){const t=document.getElementById("preset-selector"),e=t.value;if(e==="--new--"){k("No preset selected to delete.","Info");return}if(confirm(`Are you sure you want to delete your preset "${t.options[t.selectedIndex].text}"?`)){const n=id();delete n[e],cm(n),k("User Preset deleted.","Success"),h.bus.publish("user:presetsChanged")}}let Nt=new Set;function Yl(){const t=document.getElementById("model-master-list"),e=document.getElementById("model-search-input"),n=document.getElementById("filter-selected-toggle");if(!t||!e||!n)return;let o=Kn();const r=e.value.toLowerCase();n.checked&&(o=o.filter(i=>Nt.has(i.id))),r&&(o=o.filter(i=>i.name.toLowerCase().includes(r)||i.id.toLowerCase().includes(r))),t.innerHTML="",o.forEach((i,a)=>{const l=Nt.has(i.id),c=document.createElement("div");c.className="model-manager-item",c.innerHTML=`
            <input type="checkbox" id="user-model-cb-${i.id}" data-model-id="${i.id}" ${l?"checked":""}>
            <label for="user-model-cb-${i.id}">
                ${i.name} &nbsp;â€¢&nbsp; <small>${i.id}</small>
            </label>
            <button class="btn-icon model-info-btn" data-model-id="${i.id}" title="Model Info">
                <span class="material-symbols-outlined">info</span>
            </button>
        `,t.appendChild(c)})}function Xl(t=null){const e=document.getElementById("model-info-bar");if(!e)return;if(!t){e.classList.add("hidden");return}document.getElementById("info-bar-name").textContent=t.name,document.getElementById("info-bar-description").textContent=t.description||"No description available.",document.getElementById("info-bar-context").textContent=`${(t.context_length||0).toLocaleString()} tokens`;const n=document.getElementById("info-bar-prompt-price"),o=document.getElementById("info-bar-completion-price");n&&(n.closest("span").style.display="none"),o&&(o.closest("span").style.display="none"),e.classList.remove("hidden")}function Xs(){const t=document.getElementById("preset-included-list");if(!t)return;const e=Kn();t.innerHTML="";const n=document.createElement("div");if(n.className="included-models-count",n.textContent=`Included: ${Nt.size} models`,t.appendChild(n),Nt.size===0){t.innerHTML+='<p class="no-items-message">Select models from the list.</p>';return}e.forEach(o=>{if(Nt.has(o.id)){const r=document.createElement("div");r.className="model-manager-item",r.innerHTML=`<label>${o.name} &nbsp;â€¢&nbsp; <small>${o.id}</small></label>`,t.appendChild(r)}})}function Qs(){const t=document.getElementById("preset-selector"),e=document.getElementById("preset-name-input");if(!t||!e)return;const n=id(),o=t.value;t.innerHTML='<option value="--new--">-- Create New Preset --</option>';for(const s in n)t.add(new Option(n[s].name,s));n[o]&&(t.value=o);const r=t.value;r==="--new--"?(e.value="",Nt.clear()):n[r]&&(e.value=n[r].name,Nt=new Set(n[r].modelIds)),Yl(),Xs(),Xl(null)}function Hw(){const t=document.querySelector('.tab-btn[data-tab="models"]'),e=document.getElementById("preset-selector"),n=document.getElementById("model-search-input"),o=document.getElementById("filter-selected-toggle"),r=document.getElementById("select-all-btn"),s=document.getElementById("deselect-all-btn"),i=document.getElementById("save-preset-btn"),a=document.getElementById("delete-preset-btn"),l=document.getElementById("model-master-list"),c=document.getElementById("info-bar-close-btn");t?.addEventListener("click",Qs),e?.addEventListener("change",Qs),n?.addEventListener("input",Yl),o?.addEventListener("change",Yl),c?.addEventListener("click",()=>Xl(null)),r?.addEventListener("click",()=>{l.querySelectorAll('input[type="checkbox"]').forEach(d=>{d.checked||(d.checked=!0,Nt.add(d.dataset.modelId))}),Xs()}),s?.addEventListener("click",()=>{l.querySelectorAll('input[type="checkbox"]').forEach(d=>{d.checked&&(d.checked=!1,Nt.delete(d.dataset.modelId))}),Xs()}),i?.addEventListener("click",()=>Ww(Nt)),a?.addEventListener("click",zw),l?.addEventListener("click",d=>{const u=d.target.closest('input[type="checkbox"]'),f=d.target.closest(".model-info-btn");if(u){const p=u.dataset.modelId;u.checked?Nt.add(p):Nt.delete(p),Xs()}if(f){const p=f.dataset.modelId,b=Kn().find(y=>y.id===p);b&&Xl(b)}}),h.bus.subscribe("user:settingsUpdated",()=>{document.getElementById("settings-modal")?.style.display==="flex"&&document.querySelector('.tab-btn[data-tab="models"]')?.classList.contains("active")&&Qs()})}const Ql="summary-modal-container";let Im=null;function Uw(t){const e=document.createElement("div");return e.className="item summary-log-item",e.dataset.logId=t.id,t.id===Im&&e.classList.add("active"),e.innerHTML=`<span class="item-name"><span class="item-icon">ðŸ’¡</span> ${t.summary}</span>`,e.title=`Created: ${new Date(t.timestamp).toLocaleString()}`,e}function Vw(t){const e=document.getElementById("summary-editor-actions"),n=document.getElementById("summarize-conversation-btn");!e||!n||(e.classList.remove("hidden"),n.classList.add("hidden"),e.querySelector("#summary-editor-delete-btn").style.display="inline-flex",e.querySelector("#summary-editor-load-btn").style.display="inline-flex",e.querySelector("#summary-editor-save-btn").textContent="Save Changes")}function Am(t){Im=t;const n=h.getProject().summaryLogs.find(o=>o.id===t);document.getElementById("summary-editor-title").value=n?n.summary:"",document.getElementById("summary-editor-content").value=n?n.content:"",n?Vw():(document.getElementById("summary-editor-actions").classList.add("hidden"),document.getElementById("summarize-conversation-btn").classList.remove("hidden")),Nm()}function Nm(){const t=document.getElementById("summary-log-list-modal");if(!t)return;const e=h.getProject();t.innerHTML="";const n=e.summaryLogs||[];if(n.length===0){t.innerHTML='<p class="no-items-message">No summaries yet.</p>';return}const o=n.reduce((r,s)=>{const i=s.sourceSessionId,a=e.chatSessions.find(l=>l.id===i);return r[i]||(r[i]={name:a?a.name:"Unknown Session",logs:[]}),r[i].logs.push(s),r},{});Object.values(o).forEach(r=>{const s=r.logs.sort((a,l)=>l.timestamp-a.timestamp),i=document.createElement("details");i.open=!0,i.innerHTML=`<summary>For: ${r.name}</summary>`,s.forEach(a=>i.appendChild(Uw(a))),t.appendChild(i)})}function qw(){let t=document.getElementById(Ql);return t||(t=document.createElement("div"),t.id=Ql,document.body.appendChild(t)),t}function Kw(){const t=document.getElementById(Ql);t&&(ao.unmount(t),t.remove())}function Lu(){console.log("ðŸ“ showSummarizationCenter called");const t=h.getProject(),e=t.chatSessions.find(r=>r.id===t.activeSessionId);if(!e)return;const n=qw(),o={summaryLogs:t.summaryLogs||[],allModels:Kn(),promptTemplates:{...Ft,...t.globalSettings.summarizationPromptPresets},currentSessionName:e.name,systemUtilityModel:t.globalSettings.systemUtilityAgent?.model,activeTemplate:t.globalSettings.activeSummarizationPreset,defaultPresets:Ft,onApplySettings:r=>{nv(r),Zl()},unmount:Zl};ao.mount(sv,o,n),n.style.display="block"}function Zl(){console.log("ðŸ“ hideSummarizationCenter called"),Kw()}function Gw(){console.log("âœ… Summary UI Initialized (Listeners are in app.js)")}async function Mm({modelId:t,promptTemplate:e}){const n=h.getProject(),o=n.chatSessions.find(c=>c.id===n.activeSessionId);if(!o)throw new Error("Active session not found.");if(!t)throw k("Please select a model for summarization in the Settings tab.","Error"),new Error("Model for summarization not selected.");const r={...n.globalSettings.systemUtilityAgent,model:t},s=o.history.filter(c=>c.role==="user"||c.role==="assistant");if(s.length<2)throw k("Not enough new messages to summarize.","Info"),new Error("Not enough messages.");const i=s.map(c=>`${c.speaker||c.role}: ${Array.isArray(c.content)?c.content.find(d=>d.type==="text")?.text||"[multimodal content]":c.content}`).join(`
`),a=e.replace(/\$\{previousSummary\}/g,"This is a full-history summary from the beginning.").replace(/\$\{newMessages\}/g,i),l=await Sa(r,[{role:"user",content:a}]);if(!l||typeof l.content!="string")throw new Error("Received an invalid or empty response from the AI summarizer.");return{title:`Summary of "${o.name}" at ${new Date().toLocaleTimeString()}`,content:l.content}}function Jw({title:t,content:e}){const n=h.getProject(),o=n.chatSessions.find(s=>s.id===n.activeSessionId);if(!n||!o||!t||!e)return;const r={id:`sum_${Date.now()}`,summary:t,content:e,timestamp:Date.now(),sourceSessionId:o.id};n.summaryLogs||(n.summaryLogs=[]),n.summaryLogs.push(r),h.updateAndPersistState(),k("New summary log saved!","Success"),h.bus.publish("summary:listChanged",{newlyCreatedId:r.id})}function Yw({logId:t,title:e,content:n}){if(!t||!e||!n)return;const r=h.getProject().summaryLogs.find(s=>s.id===t);r&&(r.summary=e,r.content=n,h.updateAndPersistState(),k("Changes saved!","Success"),Nm())}function Xw({logId:t}){if(!confirm("Are you sure you want to delete this summary log?"))return;const e=h.getProject();e.summaryLogs=e.summaryLogs.filter(n=>n.id!==t),e.chatSessions.forEach(n=>{n.summaryState?.activeSummaryId===t&&(n.summaryState.activeSummaryId=null)}),h.updateAndPersistState(),k("Log deleted.","Success"),Am(null)}function Qw({logId:t}){const e=h.getProject(),n=e.chatSessions.find(s=>s.id===e.activeSessionId),o=e.summaryLogs.find(s=>s.id===t);if(!n||!o)return;n.summaryState={activeSummaryId:o.id};const r={role:"system",content:`[System: Context loaded from summary: "${o.summary}"]`,isSummary:!0};n.history.push(r),h.updateAndPersistState(),h.bus.publish("ui:renderMessages"),Zl(),k("Summary loaded into context!","Success")}async function Zw({saveAs:t,presetName:e,content:n}){const o=n.trim();if(!o){k("Preset content cannot be empty.","Error");return}let r=e;const s=h.getProject(),i=Ft.hasOwnProperty(r);if(t||i||!r){const a=prompt("Enter a name for this new preset:",i?`${r} (Copy)`:"My Custom Preset");if(!a||!a.trim())return;r=a.trim()}s.globalSettings.summarizationPromptPresets[r]&&r!==e&&!confirm(`A preset named '${r}' already exists. Overwrite?`)||(s.globalSettings.summarizationPromptPresets[r]=o,s.globalSettings.activeSummarizationPreset=r,h.setProject(s),await h.updateAndPersistState(),h.bus.publish("summary:presetsChanged",{newSelectedName:r}),k(`Preset '${r}' saved!`,"Success"))}async function ev({presetName:t}){if(Ft.hasOwnProperty(t)||t==="custom")return;const e=prompt(`Enter new name for "${t}":`,t);if(!e||!e.trim()||e.trim()===t)return;const n=h.getProject(),o=e.trim();if(n.globalSettings.summarizationPromptPresets[o]){k(`A preset named '${o}' already exists.`,"Error");return}n.globalSettings.summarizationPromptPresets[o]=n.globalSettings.summarizationPromptPresets[t],delete n.globalSettings.summarizationPromptPresets[t],n.globalSettings.activeSummarizationPreset=o,h.setProject(n),await h.updateAndPersistState(),h.bus.publish("summary:presetsChanged"),k(`Preset renamed to '${o}'!`,"Success")}async function tv({presetName:t}){if(!Ft.hasOwnProperty(t)&&confirm(`Delete user preset "${t}"?`)){const e=h.getProject();delete e.globalSettings.summarizationPromptPresets[t],e.globalSettings.activeSummarizationPreset===t&&(e.globalSettings.activeSummarizationPreset="Standard"),h.setProject(e),await h.updateAndPersistState(),h.bus.publish("summary:presetsChanged"),k(`Preset '${t}' deleted.`,"Success")}}function nv({model:t,templateName:e}){const n=h.getProject();!n||!n.globalSettings||(t&&n.globalSettings.systemUtilityAgent&&(n.globalSettings.systemUtilityAgent.model=t),n.globalSettings.activeSummarizationPreset=e,h.setProject(n),h.updateAndPersistState(),k("Settings Applied!","Success"))}const ov=T.memo(({selectedLog:t,currentSessionName:e,isGenerating:n,onGenerate:o,editorTitle:r,setEditorTitle:s,editorContent:i,setEditorContent:a})=>g.jsxs(g.Fragment,{children:[g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[g.jsx("h4",{children:t?"Edit Summary":`Generate new summary for "${e}"`}),!t&&g.jsx("button",{className:`btn ${n?"is-loading":""}`,onClick:o,disabled:n,children:"âœ¨ Generate New Summary"})]}),g.jsxs("div",{className:"form-group",style:{flexGrow:1,display:"flex",flexDirection:"column"},children:[g.jsx("label",{children:"Summary Title"}),g.jsx("input",{type:"text",value:r,onChange:l=>s(l.target.value),placeholder:"A concise title..."}),g.jsx("label",{style:{marginTop:"10px"},children:"Summary Content (Editable)"}),g.jsx("textarea",{style:{flexGrow:1,resize:"none"},value:i,onChange:l=>a(l.target.value)})]})]})),rv=T.memo(({selectedModel:t,setSelectedModel:e,allModels:n=[],selectedTemplateName:o,handleTemplateChange:r,promptTemplates:s={},templateContent:i,setTemplateContent:a,defaultPresets:l={},handleActionClick:c})=>{const d=(p,m)=>Object.prototype.hasOwnProperty.call(p||{},m),u=Object.keys(s).filter(p=>d(l,p)).sort(),f=Object.keys(s).filter(p=>!d(l,p)).sort();return g.jsxs(g.Fragment,{children:[g.jsx("h4",{children:"Settings"}),g.jsxs("div",{className:"form-group",children:[g.jsx("label",{children:"Summarization Model"}),g.jsxs("select",{value:t,onChange:p=>e(p.target.value),children:[g.jsx("option",{value:"",children:"-- Select a Model --"}),n.map(p=>g.jsx("option",{value:p.id,children:p.name},p.id))]})]}),g.jsxs("div",{className:"form-group",style:{flexGrow:1,display:"flex",flexDirection:"column"},children:[g.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center",marginBottom:"10px"},children:[g.jsx("label",{style:{flexGrow:1,marginBottom:0},children:"Summarization Prompt Template"}),g.jsxs("div",{className:"dropdown align-right",children:[g.jsx("button",{className:"btn btn-small btn-secondary",onClick:p=>p.currentTarget.parentElement.classList.toggle("open"),children:"Actions â–¾"}),g.jsx("div",{className:"dropdown-content",children:o&&!d(l,o)?g.jsxs(g.Fragment,{children:[g.jsx("a",{href:"#",onClick:p=>{p.preventDefault(),c("settings:saveSummaryPreset",{saveAs:!1,presetName:o,content:i})},children:"Save Changes"}),g.jsx("a",{href:"#",onClick:p=>{p.preventDefault(),c("settings:renameSummaryPreset",{presetName:o})},children:"Rename..."}),g.jsx("a",{href:"#",onClick:p=>{p.preventDefault(),c("settings:saveSummaryPreset",{saveAs:!0,content:i})},children:"Save as New Preset..."}),g.jsx("div",{className:"dropdown-divider"}),g.jsx("a",{href:"#",className:"is-destructive",onClick:p=>{p.preventDefault(),c("settings:deleteSummaryPreset",{presetName:o})},children:"Delete Preset"})]}):g.jsx("a",{href:"#",onClick:p=>{p.preventDefault(),c("settings:saveSummaryPreset",{saveAs:!0,content:i})},children:"Save as New Preset..."})})]})]}),g.jsxs("select",{value:o,onChange:r,children:[g.jsx("optgroup",{label:"Factory Presets (Read-only)",children:u.map(p=>g.jsx("option",{value:p,children:p},p))}),f.length>0&&g.jsx("optgroup",{label:"User Presets",children:f.map(p=>g.jsx("option",{value:p,children:p},p))})]}),g.jsx("textarea",{style:{flexGrow:1,resize:"none",marginTop:"10px"},value:i,onChange:p=>a(p.target.value)})]})]})});function sv({unmount:t,summaryLogs:e=[],allModels:n=[],promptTemplates:o={},currentSessionName:r="",systemUtilityModel:s="",activeTemplate:i="Standard",defaultPresets:a={},onApplySettings:l=()=>{}}){const[c,d]=T.useState("logs"),[u,f]=T.useState(null),[p,m]=T.useState(""),[b,y]=T.useState(""),[w,v]=T.useState(""),[S,C]=T.useState(s||""),[x,I]=T.useState(o),[N,E]=T.useState(i||"Standard"),[A,L]=T.useState(o[i||"Standard"]||""),[B,G]=T.useState(!1);T.useEffect(()=>{u?(y(u.summary),v(u.content)):(y(""),v(""))},[u]),T.useEffect(()=>{const ae=()=>{const O=h.getProject(),q={...Ft,...O.globalSettings.summarizationPromptPresets},$=O.globalSettings.activeSummarizationPreset||"Standard";I(q),E($)},j=({newlyCreatedId:O})=>{if(O){const q=h.getProject().summaryLogs.find($=>$.id===O);q&&f(q)}},V=h.bus.subscribe("summary:presetsChanged",ae),W=h.bus.subscribe("summary:listChanged",j);return()=>{V(),W()}},[]),T.useEffect(()=>{L(x[N]||"")},[N,x]);const K=T.useMemo(()=>p?e.filter(ae=>ae.summary.toLowerCase().includes(p.toLowerCase())):e,[p,e]),_=ae=>{f(ae),d("logs")},me=async()=>{G(!0),f(null);try{const ae=await Mm({modelId:S,promptTemplate:A});y(ae.title),v(ae.content),f({id:"new_log",summary:ae.title,content:ae.content})}catch(ae){console.error("Summary generation failed:",ae)}finally{G(!1)}},Q=(ae,j)=>{h.bus.publish(ae,j)},Oe=ae=>{E(ae.target.value)};return g.jsx("div",{id:"summarization-modal",className:"modal-overlay","data-owner":"summary",style:{display:"flex"},children:g.jsxs("div",{className:"modal-box is-resizable",children:[g.jsxs("div",{className:"modal-header",children:[g.jsx("h3",{children:"Conversation Summary Center"}),g.jsx("button",{className:"btn-icon",title:"Settings",onClick:()=>d(c==="logs"?"settings":"logs"),children:g.jsx("span",{className:"material-symbols-outlined",children:c==="settings"?"article":"settings"})}),g.jsx("button",{className:"modal-close-btn",onClick:t,children:"Ã—"})]}),g.jsxs("div",{className:"modal-body",children:[g.jsxs("div",{className:"log-list-column",children:[g.jsx("input",{type:"text",placeholder:"Search summaries...",value:p,onChange:ae=>m(ae.target.value),style:{marginBottom:"15px"}}),g.jsx("div",{id:"summary-log-list-modal",className:"item-list",children:K.map(ae=>g.jsx("div",{className:`item summary-log-item ${u?.id===ae.id?"active":""}`,onClick:()=>_(ae),children:g.jsxs("span",{className:"item-name",children:[g.jsx("span",{className:"item-icon",children:"ðŸ’¡"})," ",ae.summary]})},ae.id))})]}),g.jsx("div",{className:"log-editor-column",children:c==="logs"?g.jsx(ov,{selectedLog:u,currentSessionName:r,isGenerating:B,onGenerate:me,editorTitle:b,setEditorTitle:y,editorContent:w,setEditorContent:v}):g.jsx(rv,{selectedModel:S,setSelectedModel:C,allModels:n,selectedTemplateName:N,handleTemplateChange:Oe,promptTemplates:x,templateContent:A,setTemplateContent:L,defaultPresets:a,handleActionClick:Q})})]}),g.jsxs("div",{className:"modal-actions",children:[g.jsx("button",{className:"btn btn-secondary",onClick:t,children:"Close"}),c==="logs"&&u&&g.jsxs(g.Fragment,{children:[u.id!=="new_log"&&g.jsx("button",{className:"btn btn-danger",onClick:()=>Q("summary:deleteLog",{logId:u.id}),children:"Delete Log"}),u.id!=="new_log"&&g.jsx("button",{className:"btn",onClick:()=>Q("summary:loadToContext",{logId:u.id}),children:"Load to Context"}),g.jsx("button",{className:"btn",onClick:()=>Q(u.id==="new_log"?"summary:saveNewLog":"summary:saveEdit",{logId:u.id,title:b,content:w}),children:u.id==="new_log"?"Save New Log":"Save Changes"})]}),c==="settings"&&g.jsx("button",{className:"btn",onClick:()=>l({model:S,templateName:N}),children:"Apply Settings"})]})]})})}const iv="https://api.kie.ai/api/v1/jobs/createTask",Tm="https://api.kie.ai/api/v1/jobs/recordInfo",av="https://kieai.redpandaai.co/api/file-stream-upload";async function ec(t,e="user-uploads",n=null){const o=tn();if(!o)throw new Error("Kie.ai API Key is missing. Please check your Settings.");if(!(t instanceof File))throw new Error("Invalid file object provided to uploadFileStream.");const r=new FormData;r.append("file",t),e&&r.append("uploadPath",e),n&&r.append("fileName",n);const s={Authorization:`Bearer ${o}`},i=await fetch(av,{method:"POST",headers:s,body:r});let a;try{a=await i.json()}catch{throw new Error("Failed to parse upload response.")}if(!i.ok||!a||!a.success){const d=a?.msg||a?.message||`HTTP ${i.status} during file upload`;throw new Error(d)}const l=a.data||{},c=l.fileUrl||l.downloadUrl;if(!c)throw new Error("Upload succeeded but no file URL was returned by the API.");return c}const hd=5;function Pm({durationSec:t=5,resolution:e="720p"}={}){let n=1;e==="1080p"?n=1.8:e==="4k"&&(n=3);const o=Math.max(180,t*18*n);return Math.ceil(o/hd)}async function tc(t){const e=await t.text();try{return JSON.parse(e)}catch{throw console.error("Non-JSON API Response (HTML/Error Page):",e),new Error(`Invalid API Response: Server returned non-JSON data (Status ${t.status}). Check API Key/Endpoint.`)}}async function Du(t,e,n=()=>{},o={}){const{taskContext:r={}}=o,s=tn();if(!s)throw new Error("Kie.ai API Key is missing. Please check your Settings.");const i={Authorization:`Bearer ${s}`,"Content-Type":"application/json"},a={model:t,input:e};n("Submitting task...");let l=await fetch(iv,{method:"POST",headers:i,body:JSON.stringify(a)});const c=await tc(l);if(!l.ok||c.code!==200)throw new Error(`Submission Failed (${l.status}): ${c.msg||c.message||"Check parameters."}`);const d=c.data?.taskId;if(!d)throw new Error("Invalid response: Task ID is missing.");n(`Task submitted: ${d}. Waiting...`),h.bus.publish("kieai:progress",{taskId:d,status:"submitted",progress:0,message:"Queued"});let u=0;const f=Pm({durationSec:Number(r.durationSec)||Number(e.duration)||5,resolution:String(r.resolution||e.resolution)||"720p"});for(;u<f;){const p=Math.min(hd*Math.max(1,Math.ceil(u/6)+1),15);await new Promise(v=>setTimeout(v,p*1e3)),u++;const m=`${Tm}?taskId=${encodeURIComponent(d)}`;let b;try{b=await fetch(m,{headers:i})}catch{h.bus.publish("kieai:progress",{taskId:d,status:"network-retry",progress:null,attempt:u,max:f,message:"Network hiccup, retrying..."});continue}const y=await tc(b);if(!b.ok||y.code!==200)throw new Error(`Polling API Error (${b.status}): ${y.msg||"Check Key/Balance."}`);const w=y.data?.state;if(w==="success"){h.bus.publish("kieai:progress",{taskId:d,status:"success",progress:100,attempt:u,max:f,message:"Done"});let v={};try{v=JSON.parse(y.data.resultJson)}catch(S){console.warn("Could not parse resultJson",S)}return{url:v.resultUrls?.[0],resultJson:v,taskId:d}}else{if(w==="fail")throw new Error(`Kie.ai Task Failed: ${y.data.failMsg||"Generation failed."}`);{const v=Number(y.data?.percent??y.data?.progress??NaN),S=isFinite(v)?Math.max(0,Math.min(100,v)):Math.round(u/f*95);h.bus.publish("kieai:progress",{taskId:d,status:w,progress:S,attempt:u,max:f,message:`Status: ${w}`}),n(`Status: ${w} (${u}/${f})`)}}}throw new Error("Kie.ai Polling Timed Out.")}async function lv(t,e={},n=()=>{}){const o=tn();if(!o)throw new Error("Kie.ai API Key is missing. Please check your Settings.");const r={Authorization:`Bearer ${o}`,"Content-Type":"application/json"};let s=0;const i=Pm({durationSec:Number(e.durationSec)||5,resolution:String(e.resolution||"720p")});for(h.bus.publish("kieai:progress",{taskId:t,status:"resuming",progress:null,attempt:0,max:i,message:"Resuming task..."});s<i;){await new Promise(u=>setTimeout(u,hd*1e3)),s++;const a=`${Tm}?taskId=${encodeURIComponent(t)}`;let l;try{l=await fetch(a,{headers:r})}catch{h.bus.publish("kieai:progress",{taskId:t,status:"network-retry",progress:null,attempt:s,max:i,message:"Network hiccup, retrying..."});continue}const c=await tc(l);if(!l.ok||c.code!==200)throw new Error(`Polling API Error (${l.status}): ${c.msg||"Check Key/Balance."}`);const d=c.data?.state;if(d==="success"){h.bus.publish("kieai:progress",{taskId:t,status:"success",progress:100,attempt:s,max:i,message:"Done"});let u={};try{u=JSON.parse(c.data.resultJson)}catch(f){console.warn("Could not parse resultJson",f)}return{url:u.resultUrls?.[0],resultJson:u,taskId:t}}if(d==="fail")throw new Error(c.data?.failMsg||"Generation failed");h.bus.publish("kieai:progress",{taskId:t,status:d,progress:null,attempt:s,max:i,message:`Status: ${d}`})}throw new Error("Resume polling timed out")}const cv="https://api.kie.ai/api/v1/generate",dv="https://api.kie.ai/api/v1/generate/record-info",uv="https://api.kie.ai/api/v1/wav/generate",pv="https://api.kie.ai/api/v1/wav/record-info",fv="https://api.kie.ai/api/v1/vocal-removal/generate",mv="https://api.kie.ai/api/v1/vocal-removal/record-info",hv="https://api.kie.ai/api/v1/midi/generate",gv="https://api.kie.ai/api/v1/midi/record-info";async function eo(t){const e=await t.text();try{return JSON.parse(e)}catch{throw new Error(`Invalid JSON from API (status ${t.status})`)}}async function bv(t,e=()=>{},n={}){const o=tn();if(!o)throw new Error("Kie.ai API Key is missing. Please check your Settings.");const r={Authorization:`Bearer ${o}`,"Content-Type":"application/json"};e("Submitting music task...");let s;try{s=await fetch(cv,{method:"POST",headers:r,body:JSON.stringify(t)})}catch{throw new Error("Network error during submission")}const i=await eo(s);if(!s.ok||i.code!==200){const u=i?.msg||i?.message||`HTTP ${s.status}`;throw new Error(`Music submission failed: ${u}`)}const a=i.data?.taskId;if(!a)throw new Error("Invalid submission response: missing taskId");e(`Task submitted: ${a}. Waiting...`),h.bus.publish("kieai:progress",{taskId:a,status:"submitted",progress:0,message:"Queued"});const l=1e4,c=60;let d=0;for(;d<c;){await new Promise(m=>setTimeout(m,l)),d++;let u;try{u=await fetch(`${dv}?taskId=${encodeURIComponent(a)}`,{method:"GET",headers:r})}catch{h.bus.publish("kieai:progress",{taskId:a,status:"network-retry",progress:null,attempt:d,max:c,message:"Network hiccup, retrying..."});continue}const f=await eo(u);if(!u.ok||f.code!==200){const m=f?.msg||f?.message||`HTTP ${u.status}`;throw new Error(`Music polling error: ${m}`)}const p=f.data?.status;if(p==="SUCCESS"||p==="FIRST_SUCCESS"||p==="TEXT_SUCCESS"){h.bus.publish("kieai:progress",{taskId:a,status:"success",progress:100,attempt:d,max:c,message:"Done"});const b=(f.data?.response?.sunoData||[])[0]||{},y=b.audioUrl||b.streamAudioUrl||null;return{taskId:a,audioUrl:y,streamAudioUrl:b.streamAudioUrl||null,title:b.title,prompt:b.prompt,audioId:b.id}}if(p==="CREATE_TASK_FAILED"||p==="GENERATE_AUDIO_FAILED"||p==="CALLBACK_EXCEPTION"||p==="SENSITIVE_WORD_ERROR"){const m=f.data?.errorMessage||`Music generation failed (status: ${p})`;throw new Error(m)}h.bus.publish("kieai:progress",{taskId:a,status:p||"pending",progress:null,attempt:d,max:c,message:p||"Pending"})}throw new Error("Music generation timed out")}async function yv(t,e,n="https://example.com/callback"){const o=tn();if(!o)throw new Error("Kie.ai API Key is missing.");const r={Authorization:`Bearer ${o}`,"Content-Type":"application/json"},i=await fetch(uv,{method:"POST",headers:r,body:JSON.stringify({taskId:t,audioId:e,callBackUrl:n})}),a=await eo(i);if(!i.ok||a.code!==200){const l=a?.msg||a?.message||`HTTP ${i.status}`;throw new Error(`WAV conversion submission failed: ${l}`)}return a.data?.taskId}async function wv(t,e=60,n=1e4){const o=tn();if(!o)throw new Error("Kie.ai API Key is missing.");const r={Authorization:`Bearer ${o}`};let s=0;for(;s<e;){await new Promise(c=>setTimeout(c,n)),s++;const i=await fetch(`${pv}?taskId=${encodeURIComponent(t)}`,{method:"GET",headers:r}),a=await eo(i);if(!i.ok||a.code!==200){const c=a?.msg||a?.message||`HTTP ${i.status}`;throw new Error(`WAV polling failed: ${c}`)}const l=a.data?.successFlag;if(l==="SUCCESS"||l===1||l==="1"){const c=a.data?.response?.audioWavUrl;if(!c)throw new Error("WAV conversion completed but URL missing");return c}if(typeof l=="string"&&l.startsWith("GENERATE_AUDIO_FAILED")||typeof l=="number"&&l>1)throw new Error("WAV conversion failed")}throw new Error("WAV conversion timed out")}async function vv(t,e,n="split_stem",o="https://example.com/callback"){const r=tn();if(!r)throw new Error("Kie.ai API Key is missing.");const s={Authorization:`Bearer ${r}`,"Content-Type":"application/json"},a=await fetch(fv,{method:"POST",headers:s,body:JSON.stringify({taskId:t,audioId:e,type:n,callBackUrl:o})}),l=await eo(a);if(!a.ok||l.code!==200){const c=l?.msg||l?.message||`HTTP ${a.status}`;throw new Error(`Vocal separation submission failed: ${c}`)}return l.data?.taskId}async function Sv(t,e=60,n=1e4){const o=tn();if(!o)throw new Error("Kie.ai API Key is missing.");const r={Authorization:`Bearer ${o}`};let s=0;for(;s<e;){await new Promise(c=>setTimeout(c,n)),s++;const i=await fetch(`${mv}?taskId=${encodeURIComponent(t)}`,{method:"GET",headers:r}),a=await eo(i);if(!i.ok||a.code!==200){const c=a?.msg||a?.message||`HTTP ${i.status}`;throw new Error(`Vocal separation polling failed: ${c}`)}const l=a.data?.successFlag;if(l==="SUCCESS"||l===1||l==="1")return a.data;if(typeof l=="string"&&(l.startsWith("CREATE_TASK_FAILED")||l.startsWith("GENERATE_AUDIO_FAILED"))||typeof l=="number"&&l>1)throw new Error("Vocal separation failed")}throw new Error("Vocal separation timed out")}async function kv(t,e="https://example.com/callback"){const n=tn();if(!n)throw new Error("Kie.ai API Key is missing.");const o={Authorization:`Bearer ${n}`,"Content-Type":"application/json"},s=await fetch(hv,{method:"POST",headers:o,body:JSON.stringify({taskId:t,callBackUrl:e})}),i=await eo(s);if(!s.ok||i.code!==200){const a=i?.msg||i?.message||`HTTP ${s.status}`;throw new Error(`MIDI generation submission failed: ${a}`)}return i.data?.taskId}async function xv(t,e=60,n=1e4){const o=tn();if(!o)throw new Error("Kie.ai API Key is missing.");const r={Authorization:`Bearer ${o}`};let s=0;for(;s<e;){await new Promise(c=>setTimeout(c,n)),s++;const i=await fetch(`${gv}?taskId=${encodeURIComponent(t)}`,{method:"GET",headers:r}),a=await eo(i);if(!i.ok||a.code!==200){const c=a?.msg||a?.message||`HTTP ${i.status}`;throw new Error(`MIDI polling failed: ${c}`)}const l=a.data?.successFlag;if(l==="SUCCESS"||l===1||l==="1")return a.data?.midiData;if(typeof l=="string"&&(l.startsWith("CREATE_TASK_FAILED")||l.startsWith("GENERATE_AUDIO_FAILED"))||typeof l=="number"&&l>1)throw new Error("MIDI generation failed")}throw new Error("MIDI generation timed out")}const bi=[{id:"video/wan-2-6-text-to-video",name:"Wan 2.6 T2V",type:"video",modelApiId:"wan/2-6-text-to-video"},{id:"video/wan-2-6-image-to-video",name:"Wan 2.6 I2V",type:"video",modelApiId:"wan/2-6-image-to-video"},{id:"video/wan-2-6-video-to-video",name:"Wan 2.6 V2V",type:"video",modelApiId:"wan/2-6-video-to-video"},{id:"video/wan2.5-text-to-video",name:"WAN 2.5 T2V",type:"video",modelApiId:"wan/2-5-text-to-video"},{id:"video/wan2.5-image-to-video",name:"WAN 2.5 I2V",type:"video",modelApiId:"wan/2-5-image-to-video"},{id:"video/v1-pro-text-to-video",name:"Seedance V1 Pro T2V",type:"video",modelApiId:"bytedance/v1-pro-text-to-video"},{id:"video/v1-lite-text-to-video",name:"Seedance V1 Lite T2V",type:"video",modelApiId:"bytedance/v1-lite-text-to-video"},{id:"video/v1-pro-image-to-video",name:"Seedance V1 Pro I2V",type:"video",modelApiId:"bytedance/v1-pro-image-to-video"},{id:"video/v1-lite-image-to-video",name:"Seedance V1 Lite I2V",type:"video",modelApiId:"bytedance/v1-lite-image-to-video"},{id:"video/seedance-1-5-pro-text-to-video",name:"Seedance 1.5 Pro T2V",type:"video",modelApiId:"bytedance/seedance-1.5-pro"},{id:"video/seedance-1-5-pro-image-to-video",name:"Seedance 1.5 Pro I2V",type:"video",modelApiId:"bytedance/seedance-1.5-pro"},{id:"image/seedream4.0-text-to-image",name:"Seedream 4.0 T2I",type:"image",modelApiId:"bytedance/seedream-v4-text-to-image"},{id:"image/seedream4.5-text-to-image",name:"Seedream 4.5 T2I",type:"image",modelApiId:"seedream/4.5-text-to-image"},{id:"image/seedream4-edit",name:"Seedream V4 Edit",type:"image",modelApiId:"bytedance/seedream-v4-edit"},{id:"image/seedream4.5-edit",name:"Seedream 4.5 Edit",type:"image",modelApiId:"seedream/4.5-edit"},{id:"audio/suno-v3_5-text-to-music",name:"Suno V3.5 T2M",type:"audio",modelApiId:"suno/v3_5-text-to-music"},{id:"audio/suno-v4-text-to-music",name:"Suno V4 T2M",type:"audio",modelApiId:"suno/v4-text-to-music"},{id:"audio/suno-v4_5-text-to-music",name:"Suno V4.5 T2M",type:"audio",modelApiId:"suno/v4_5-text-to-music"},{id:"audio/suno-v4_5plus-text-to-music",name:"Suno V4.5+ T2M",type:"audio",modelApiId:"suno/v4_5plus-text-to-music"},{id:"audio/suno-v5-text-to-music",name:"Suno V5 T2M",type:"audio",modelApiId:"suno/v5-text-to-music"}],gd={"wan/2-6-text-to-video":{defaults:{duration:5,resolution:"1080p"},limits:{duration:[5,10,15],resolution:["720p","1080p"]}},"wan/2-6-image-to-video":{defaults:{duration:5,resolution:"1080p"},limits:{duration:[5,10,15],resolution:["720p","1080p"]},requires:["image_urls"]},"wan/2-6-video-to-video":{defaults:{duration:5,resolution:"1080p"},limits:{duration:[5,10],resolution:["720p","1080p"]},requires:["video_urls"]},"wan/2-5-text-to-video":{defaults:{duration:5,resolution:"720p",aspect_ratio:"16:9"},limits:{duration:[5,10],resolution:["720p","1080p"]}},"wan/2-5-image-to-video":{defaults:{duration:5,resolution:"720p"},limits:{duration:[5,10],resolution:["720p","1080p"]},requires:["image_url"]},"bytedance/v1-pro-text-to-video":{defaults:{duration:5,resolution:"1080p",camera_fixed:!1,enable_safety_checker:!0},limits:{duration:[5,10],resolution:["720p","1080p"]}},"bytedance/v1-lite-text-to-video":{defaults:{duration:5,resolution:"720p",camera_fixed:!0,enable_safety_checker:!0},limits:{duration:[5,10],resolution:["720p"]}},"bytedance/v1-pro-image-to-video":{defaults:{duration:5,resolution:"720p",camera_fixed:!1,enable_safety_checker:!0,seed:-1},limits:{duration:[5,10],resolution:["480p","720p","1080p"]},requires:["image_url"]},"bytedance/v1-lite-image-to-video":{defaults:{duration:5,resolution:"720p",camera_fixed:!1,enable_safety_checker:!0,seed:-1},limits:{duration:[5,10],resolution:["480p","720p","1080p"]},requires:["image_url"]},"bytedance/seedance-1.5-pro":{defaults:{duration:4,resolution:"720p",aspect_ratio:"16:9",fixed_lens:!1,generate_audio:!1},limits:{duration:[4,8,12],resolution:["480p","720p","1080p"],aspect_ratio:["16:9","21:9","4:3","3:4","1:1","4:5","5:4","9:16","2:3","3:2"]}},"bytedance/seedream-v4-text-to-image":{defaults:{image_size:"square_hd",image_resolution:"1K"},limits:{image_size:["square","square_hd","portrait_4_3","portrait_3_2","portrait_16_9","landscape_4_3","landscape_3_2","landscape_16_9","landscape_21_9"],image_resolution:["1K","2K","4K"]}},"seedream/4.5-text-to-image":{defaults:{aspect_ratio:"1:1",quality:"basic"},limits:{aspect_ratio:["1:1","4:3","3:4","16:9","9:16","2:3","3:2","21:9"],quality:["basic","high"]}},"bytedance/seedream-v4-edit":{defaults:{image_size:"square_hd",image_resolution:"1K",max_images:1},limits:{image_size:["square","square_hd","portrait_4_3","portrait_3_2","portrait_16_9","landscape_4_3","landscape_3_2","landscape_16_9","landscape_21_9"],image_resolution:["1K","2K","4K"],max_images:[1,2,3,4,5,6]},requires:["image_urls"]},"seedream/4.5-edit":{defaults:{aspect_ratio:"1:1",quality:"basic",max_images:1},limits:{aspect_ratio:["1:1","4:3","3:4","16:9","9:16","2:3","3:2","21:9"],quality:["basic","high"],max_images:[1,2,3,4,5,6,7,8,9,10,11,12,13,14]},requires:["image_urls"]},"suno/v3_5-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V3_5"},limits:{}},"suno/v4-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V4"},limits:{}},"suno/v4_5-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V4_5"},limits:{}},"suno/v4_5plus-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V4_5PLUS"},limits:{}},"suno/v5-text-to-music":{defaults:{customMode:!1,instrumental:!1,model:"V5"},limits:{}}};function Bm(t){return gd[t]?.defaults??{}}function Ru(t){return gd[t]?.limits??{}}function Cv(){return bi}async function Om(t){const{modelId:e,prompt:n,duration:o,resolution:r,seed:s,image_url_input:i,negative_prompt:a,enable_prompt_expansion:l,camera_fixed:c,fixed_lens:d,generate_audio:u,enable_safety_checker:f,enableSafetyChecker:p,image_size:m,image_resolution:b,max_images:y,aspect_ratio:w,quality:v,customMode:S,instrumental:C,model:x,style:I,title:N,negativeTags:E,callBackUrl:A}=t,L=bi.find(K=>K.id===e),B=e?.toLowerCase().includes("suno")||e?.toLowerCase().startsWith("audio/")||L&&L.type==="audio",G=e?.toLowerCase().startsWith("image/")||L&&L.type==="image";if(!L&&!B){k(`Model ID ${e} not found in handler mapping.`,"Configuration Error");return}h.bus.publish("kieai:statusUpdate",{status:"loading",message:"Submitting task..."});try{if(B){let O;L?.modelApiId?O=(L.modelApiId.split("/")[1]||"v3_5").split("-")[0]:O="v3_5";const q=O.toUpperCase(),$={prompt:n,customMode:S||!1,instrumental:C||!1,model:x||q};I&&($.style=I),N&&($.title=N),E&&($.negativeTags=E),A&&($.callBackUrl=A),$.callBackUrl||($.callBackUrl="https://example.com/callback");const le=await bv($,De=>h.bus.publish("kieai:statusUpdate",{status:"loading",message:De}),{});h.bus.publish("kieai:statusUpdate",{status:"success",message:"Music generation complete!"}),h.bus.publish("kieai:newResult",{id:le.taskId,type:"audio",prompt:n,url:le.audioUrl,streamUrl:le.streamAudioUrl,title:le.title,audioId:le.audioId,wavUrl:null,midiData:null});return}if(G){const q=(gd[L.modelApiId]||{}).defaults||{},$={prompt:n};if(L.modelApiId==="bytedance/seedream-v4-text-to-image")$.image_size=m||q.image_size||"square_hd",$.image_resolution=b||q.image_resolution||"1K",$.max_images=Number(y||q.max_images||1);else if(L.modelApiId==="seedream/4.5-text-to-image")$.aspect_ratio=w||q.aspect_ratio||"1:1",$.quality=v||q.quality||"basic";else if(L.modelApiId==="bytedance/seedream-v4-edit"){let De=[];const mt=t.image_urls||t.imageUrls||null,kt=t.image_files||t.imageFiles||null;if(kt&&(kt instanceof FileList||Array.isArray(kt))){const sn=Array.from(kt);if(sn.length<1)throw new Error("Seedream V4 Edit requires at least 1 image.");if(sn.length>10)throw new Error("Seedream V4 Edit supports up to 10 images.");for(const an of sn){if(!(an instanceof File))continue;if(an.size>10*1024*1024)throw new Error("Each image must be <= 10MB.");if(!["image/jpeg","image/png","image/webp"].includes(an.type))throw new Error("Supported formats: JPEG, PNG, WEBP.");const Ya=await ec(an,"seedream-edit");De.push(Ya)}}else Array.isArray(mt)&&(De=mt.filter(Boolean));if(!De.length)throw new Error("Seedream V4 Edit requires image_urls (or image_files).");$.image_urls=De,$.image_size=m||q.image_size||"square_hd",$.image_resolution=b||q.image_resolution||"1K",$.max_images=Number(y||q.max_images||1),s!=null&&s!==-1&&($.seed=Number(s))}else if(L.modelApiId==="seedream/4.5-edit"){let De=[];const mt=t.image_urls||t.imageUrls||null,kt=t.image_files||t.imageFiles||null;if(kt&&(kt instanceof FileList||Array.isArray(kt))){const sn=Array.from(kt);if(sn.length<1)throw new Error("Seedream 4.5 Edit requires at least 1 image.");if(sn.length>14)throw new Error("Seedream 4.5 Edit supports up to 14 images.");for(const an of sn){if(!(an instanceof File))continue;if(an.size>10*1024*1024)throw new Error("Each image must be <= 10MB.");if(!["image/jpeg","image/png","image/webp"].includes(an.type))throw new Error("Supported formats: JPEG, PNG, WEBP.");const Ya=await ec(an,"seedream-4.5-edit");De.push(Ya)}}else Array.isArray(mt)&&(De=mt.filter(Boolean));if(!De.length)throw new Error("Seedream 4.5 Edit requires image_urls (or image_files).");$.image_urls=De,$.aspect_ratio=w||q.aspect_ratio||"1:1",$.quality=v||q.quality||"basic",s!=null&&s!==-1&&($.seed=Number(s))}else m&&($.image_size=m),b&&($.image_resolution=b),y!==void 0&&($.max_images=Number(y)),w&&($.aspect_ratio=w),v&&($.quality=v);const le=await Du(L.modelApiId,$,De=>h.bus.publish("kieai:statusUpdate",{status:"loading",message:De}),{taskContext:{}});return h.bus.publish("kieai:statusUpdate",{status:"success",message:"Image generation complete!"}),h.bus.publish("kieai:newResult",{id:le.taskId,type:"image",prompt:n,url:le.url,resultJson:le.resultJson}),le}const K=e.includes("wan2.5"),_=e.includes("wan-2-6"),me=K||_,Q=!B&&e.includes("image-to-video"),Oe=!B&&e.includes("video-to-video"),ae=e.includes("v1-pro")||e.includes("v1-lite"),j=L?.modelApiId==="bytedance/seedance-1.5-pro"||e.includes("seedance-1-5-pro"),V={prompt:n,resolution:String(r)||"720p",duration:String(o)||"5"};if(!_&&!j&&(V.seed=Number(s)||-1),!Q&&!Oe&&(V.aspect_ratio=t.aspect_ratio||"16:9"),Q){const O=i?.trim();if(!O||!O.startsWith("http"))throw new Error("I2V requires a valid public image URL.");_?V.image_urls=[O]:j?V.input_urls=[O]:V.image_url=O}if(Oe){const O=t.video_url_input?.trim();if(!O||!O.startsWith("http"))throw new Error("V2V requires a valid public video URL.");V.video_urls=[O]}if(j){const O=[],q=Array.isArray(t.input_urls)?t.input_urls:Array.isArray(t.image_urls)?t.image_urls:null;if(q)q.forEach($=>{const le=String($||"").trim();le&&le.startsWith("http")&&O.push(le)});else{const $=String(i||t.image_url||"").trim();$&&$.startsWith("http")&&O.push($)}O.length>0&&(V.input_urls=O.slice(0,2))}if(K&&(a&&(V.negative_prompt=a),V.enable_prompt_expansion=l||!1),ae){V.camera_fixed=c||!1;const O=f!==void 0?f:p!==void 0?p:void 0;V.enable_safety_checker=O!==void 0?O:!0}j&&(V.fixed_lens=d===!0,V.generate_audio=u===!0);const W=await Du(L.modelApiId,V,O=>h.bus.publish("kieai:statusUpdate",{status:"loading",message:O}),{taskContext:{durationSec:Number(o)||Number(t.duration)||5,resolution:String(r)||"720p"}});h.bus.publish("kieai:statusUpdate",{status:"success",message:"Generation Complete!"}),h.bus.publish("kieai:newResult",{id:W.taskId,type:"video",prompt:n,url:W.url})}catch(K){const _=K.message||"An unknown network error occurred.";console.error("Kie.ai Generation Error (Task: N/A):",K),_.includes("Image required")||_.includes("valid public image URL")?k("Please paste a valid public image URL.","Input Missing"):k(`API Error: ${_}`,"Kie.ai Submission Failed")}finally{h.bus.publish("kieai:statusUpdate",{status:"ready",message:"Ready"})}}function Lm(t){return`studio:${t}`}async function Wo(t,e){const n={id:Lm(t),projectId:t,type:"studio",updatedAt:Date.now(),...e};return To(Zn,"readwrite","put",n)}async function Ev(t){try{return await To(Zn,"readonly","get",Lm(t))||null}catch(e){return console.warn("Failed to load studio session",e),null}}const Iv=ot.memo(({onFileDrop:t,imagePreviewUrl:e,removeImage:n})=>{const[o,r]=T.useState(!1),s=c=>{c.preventDefault(),r(!0)},i=c=>{c.preventDefault(),r(!1)},a=c=>{c.preventDefault(),r(!1),c.dataTransfer.files&&c.dataTransfer.files.length>0&&t(c.dataTransfer.files[0])},l=c=>{c.target.files&&c.target.files.length>0&&t(c.target.files[0])};return e?g.jsxs("div",{className:"tw-relative tw-p-2 tw-bg-slate-600 tw-rounded-lg tw-flex tw-justify-center",children:[g.jsx("img",{src:e,alt:"Upload Preview",className:"tw-max-h-40 tw-rounded-md tw-shadow-lg"}),g.jsx("button",{type:"button",onClick:n,className:"tw-absolute tw-top-0 tw-right-0 tw-bg-red-500 hover:tw-bg-red-600 tw-text-white tw-rounded-full tw-w-6 tw-h-6 tw-flex tw-items-center tw-justify-center tw-text-sm",children:"Ã—"})]}):g.jsxs("label",{htmlFor:"i2v-file-upload",onDragOver:s,onDragLeave:i,onDrop:a,className:`tw-border-2 tw-border-dashed tw-rounded-lg tw-p-6 tw-text-center tw-cursor-pointer tw-block tw-transition ${o?"tw-border-cyan-400 tw-bg-slate-600":"tw-border-slate-500 tw-bg-slate-700"}`,children:[g.jsx("input",{type:"file",id:"i2v-file-upload",className:"tw-hidden",accept:"image/*",onChange:l}),g.jsx("span",{className:"material-symbols-outlined tw-text-4xl tw-text-gray-400",children:"cloud_upload"}),g.jsx("p",{className:"tw-text-gray-400 tw-text-sm",children:"Drag & drop or click to upload image"})]})}),Av=ot.memo(({images:t,onImagesChange:e,maxImages:n=14})=>{const[o,r]=T.useState(!1),s=ot.useRef(null),i=p=>{p.preventDefault(),p.stopPropagation(),r(!0)},a=p=>{p.preventDefault(),p.stopPropagation(),r(!1)},l=p=>{p.preventDefault(),p.stopPropagation(),r(!1),p.dataTransfer.files&&p.dataTransfer.files.length>0&&d(Array.from(p.dataTransfer.files))},c=p=>{p.target.files&&p.target.files.length>0&&d(Array.from(p.target.files))},d=p=>{const m=p.filter(S=>S.type.startsWith("image/"));if(m.length===0){alert("Please select valid image files (JPEG, PNG, WEBP)");return}const b=t.length,y=n-b;if(y<=0){alert(`Maximum ${n} images allowed`);return}const w=m.slice(0,y);w.length<m.length&&alert(`Only adding ${w.length} images to stay within ${n} image limit`);const v=w.map(S=>({file:S,preview:URL.createObjectURL(S),id:`${Date.now()}-${Math.random()}`}));e([...t,...v])},u=p=>{const m=t.find(b=>b.id===p);m?.preview&&URL.revokeObjectURL(m.preview),e(t.filter(b=>b.id!==p))},f=()=>{t.forEach(p=>{p.preview&&URL.revokeObjectURL(p.preview)}),e([])};return g.jsxs("div",{className:"tw-space-y-3",children:[t.length>0&&g.jsxs("div",{className:"tw-flex tw-justify-between tw-items-center",children:[g.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-red-400",children:"image_urls *"}),g.jsx("button",{type:"button",onClick:f,className:"tw-text-xs tw-text-red-400 hover:tw-text-red-300 tw-bg-slate-600 hover:tw-bg-slate-500 tw-px-3 tw-py-1 tw-rounded",children:"Remove All"})]}),t.map(p=>g.jsxs("div",{className:"tw-bg-slate-600 tw-rounded-lg tw-p-4",children:[g.jsxs("div",{className:"tw-flex tw-items-start tw-justify-between tw-mb-2",children:[g.jsxs("div",{className:"tw-flex tw-items-center tw-gap-2 tw-text-gray-300",children:[g.jsx("span",{className:"material-symbols-outlined tw-text-lg",children:"image"}),g.jsxs("span",{className:"tw-text-sm",children:["File ",t.indexOf(p)+1]})]}),g.jsx("button",{type:"button",onClick:()=>u(p.id),className:"tw-text-xs tw-text-red-400 hover:tw-text-red-300 tw-bg-slate-700 hover:tw-bg-slate-600 tw-px-2 tw-py-1 tw-rounded",children:"Remove"})]}),g.jsx("div",{className:"tw-flex tw-justify-center tw-bg-slate-700 tw-rounded tw-p-2",children:g.jsx("img",{src:p.preview,alt:`Upload ${t.indexOf(p)+1}`,className:"tw-max-h-48 tw-rounded tw-object-contain"})})]},p.id)),t.length<n&&g.jsx("div",{onDragOver:i,onDragLeave:a,onDrop:l,className:`tw-border-2 tw-border-dashed tw-rounded-lg tw-transition ${o?"tw-border-cyan-400 tw-bg-slate-600":"tw-border-slate-500 tw-bg-slate-700"}`,children:g.jsxs("label",{htmlFor:"multi-image-upload",className:"tw-block tw-p-6 tw-text-center tw-cursor-pointer",children:[g.jsx("input",{ref:s,type:"file",id:"multi-image-upload",className:"tw-hidden",accept:"image/jpeg,image/png,image/webp",multiple:!0,onChange:c}),g.jsx("span",{className:"material-symbols-outlined tw-text-3xl tw-text-gray-400",children:"add_circle"}),g.jsxs("p",{className:"tw-text-gray-400 tw-text-sm tw-mt-2",children:["Add more files (",t.length,"/",n,")"]}),g.jsx("p",{className:"tw-text-gray-500 tw-text-xs tw-mt-1",children:"Upload an image file to use as input for the API"})]})})]})}),Nv=(t,e,n,o,r,s,i,a)=>{const l=t?.id||"",c=l.includes("wan2.5");l.includes("wan-2-6");const d=t?.type==="audio",u=t?.type==="image",f=u&&l.includes("edit"),p=!d&&l.includes("image-to-video"),m=!d&&l.includes("video-to-video"),b=l.includes("v1-pro")||l.includes("v1-lite"),y=l.includes("seedance-1-5-pro"),v=l.includes("seedream4.5-edit")||l.includes("4.5-edit")?14:10;return g.jsxs(g.Fragment,{children:[d&&g.jsxs("div",{className:"form-group tw-flex tw-flex-col tw-gap-3",children:[g.jsxs("div",{className:"tw-flex tw-justify-between tw-items-center",children:[g.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Advanced Custom Mode"}),g.jsx("input",{type:"checkbox",checked:!!e.customMode,onChange:S=>n(C=>({...C,customMode:S.target.checked})),className:"tw-toggle"})]}),g.jsxs("div",{className:"tw-flex tw-justify-between tw-items-center",children:[g.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Instrumental Only"}),g.jsx("input",{type:"checkbox",checked:!!e.instrumental,onChange:S=>n(C=>({...C,instrumental:S.target.checked})),className:"tw-toggle"})]}),e.customMode&&g.jsxs(g.Fragment,{children:[g.jsxs("div",{children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Style (Custom Mode)"}),g.jsx("input",{type:"text",value:e.style||"",onChange:S=>n(C=>({...C,style:S.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"e.g., Jazz, Classical"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Title (Custom Mode)"}),g.jsx("input",{type:"text",value:e.title||"",onChange:S=>n(C=>({...C,title:S.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"Song title"})]})]})]}),p&&!d&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Initial Frame Image (Public URL or Upload)"}),g.jsx("input",{type:"text",value:e.image_url_input||"",onChange:S=>n(C=>({...C,image_url_input:S.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white tw-mb-3",placeholder:"Paste Public Image URL here (e.g., https://example.com/pic.jpg)"}),g.jsx(Iv,{onFileDrop:r,imagePreviewUrl:o,removeImage:s})]}),m&&!d&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Input Video (Public URL)"}),g.jsx("input",{type:"text",value:e.video_url_input||"",onChange:S=>n(C=>({...C,video_url_input:S.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"Paste Public Video URL here (e.g., https://example.com/video.mp4)"}),g.jsx("p",{className:"tw-text-xs tw-text-gray-400 tw-mt-1",children:"Supported formats: MP4, MOV, MKV (max 10MB)"})]}),f&&g.jsxs("div",{className:"form-group",children:[g.jsx(Av,{images:i,onImagesChange:a,maxImages:v}),g.jsx("p",{className:"tw-text-xs tw-text-gray-400 tw-mt-2",children:"Supported formats: JPEG, PNG, WEBP (each file â‰¤ 10MB)"})]}),u&&(l.includes("seedream4.0")||l.includes("seedream-v4"))&&!l.includes("edit")&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Image Size"}),g.jsxs("select",{value:e.image_size||"square_hd",onChange:S=>n(C=>({...C,image_size:S.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",children:[g.jsx("option",{value:"square",children:"Square"}),g.jsx("option",{value:"square_hd",children:"Square HD"}),g.jsx("option",{value:"portrait_4_3",children:"Portrait 4:3"}),g.jsx("option",{value:"portrait_3_2",children:"Portrait 3:2"}),g.jsx("option",{value:"portrait_16_9",children:"Portrait 16:9"}),g.jsx("option",{value:"landscape_4_3",children:"Landscape 4:3"}),g.jsx("option",{value:"landscape_3_2",children:"Landscape 3:2"}),g.jsx("option",{value:"landscape_16_9",children:"Landscape 16:9"}),g.jsx("option",{value:"landscape_21_9",children:"Landscape 21:9"})]})]}),u&&l.includes("4.5")&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Aspect Ratio"}),g.jsxs("select",{value:e.aspect_ratio||"1:1",onChange:S=>n(C=>({...C,aspect_ratio:S.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",children:[g.jsx("option",{value:"1:1",children:"1:1 (Square)"}),g.jsx("option",{value:"4:3",children:"4:3 (Landscape)"}),g.jsx("option",{value:"3:4",children:"3:4 (Portrait)"}),g.jsx("option",{value:"16:9",children:"16:9 (Widescreen)"}),g.jsx("option",{value:"9:16",children:"9:16 (Vertical)"}),g.jsx("option",{value:"2:3",children:"2:3 (Portrait)"}),g.jsx("option",{value:"3:2",children:"3:2 (Landscape)"}),g.jsx("option",{value:"21:9",children:"21:9 (Ultra-wide)"})]})]}),u&&(l.includes("seedream4.0")||l.includes("seedream-v4"))&&!l.includes("edit")&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Image Resolution"}),g.jsxs("div",{className:"tw-flex tw-gap-2",children:[g.jsx("button",{type:"button",onClick:()=>n(S=>({...S,image_resolution:"1K"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${e.image_resolution==="1K"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"1K"}),g.jsx("button",{type:"button",onClick:()=>n(S=>({...S,image_resolution:"2K"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${e.image_resolution==="2K"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"2K"}),g.jsx("button",{type:"button",onClick:()=>n(S=>({...S,image_resolution:"4K"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${e.image_resolution==="4K"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"4K"})]})]}),u&&(l.includes("4.5")||l.includes("edit"))&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Quality"}),g.jsxs("div",{className:"tw-flex tw-gap-2",children:[g.jsx("button",{type:"button",onClick:()=>n(S=>({...S,quality:"basic"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${e.quality==="basic"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"Basic (2K)"}),g.jsx("button",{type:"button",onClick:()=>n(S=>({...S,quality:"high"})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${e.quality==="high"?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:"High (4K)"})]})]}),c&&!d&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Negative Prompt (Optional)"}),g.jsx("textarea",{value:e.negative_prompt||"",onChange:S=>n(C=>({...C,negative_prompt:S.target.value})),rows:"2",className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"Content to avoid"})]}),c&&!d&&g.jsxs("div",{className:"form-group tw-flex tw-justify-between tw-items-center",children:[g.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Enable Prompt Expansion"}),g.jsx("input",{type:"checkbox",checked:!!e.enable_prompt_expansion,onChange:S=>n(C=>({...C,enable_prompt_expansion:S.target.checked})),className:"tw-toggle"})]}),b&&!d&&g.jsxs(g.Fragment,{children:[g.jsxs("div",{className:"form-group tw-flex tw-justify-between tw-items-center",children:[g.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Fixed Camera Position"}),g.jsx("input",{type:"checkbox",checked:!!e.camera_fixed,onChange:S=>n(C=>({...C,camera_fixed:S.target.checked})),className:"tw-toggle"})]}),g.jsxs("div",{className:"form-group tw-flex tw-justify-between tw-items-center",children:[g.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Enable Safety Checker"}),g.jsx("input",{type:"checkbox",checked:e.enable_safety_checker??!0,onChange:S=>n(C=>({...C,enable_safety_checker:S.target.checked})),className:"tw-toggle"})]})]}),y&&!d&&g.jsxs(g.Fragment,{children:[g.jsxs("div",{className:"form-group tw-flex tw-justify-between tw-items-center",children:[g.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Fixed Lens"}),g.jsx("input",{type:"checkbox",checked:!!e.fixed_lens,onChange:S=>n(C=>({...C,fixed_lens:S.target.checked})),className:"tw-toggle"})]}),g.jsxs("div",{className:"form-group tw-flex tw-justify-between tw-items-center",children:[g.jsx("label",{className:"tw-text-sm tw-font-medium tw-text-gray-300",children:"Generate Audio"}),g.jsx("input",{type:"checkbox",checked:!!e.generate_audio,onChange:S=>n(C=>({...C,generate_audio:S.target.checked})),className:"tw-toggle"})]})]})]})},Mv=({models:t,onSubmit:e,status:n})=>{const o=t.find(W=>W.id.includes("wan2.5-text-to-video"))?.id||t[0]?.id,[r,s]=T.useState(o),[i,a]=T.useState(""),[l,c]=T.useState({resolution:"1080p",duration:5,aspect_ratio:"1:1",seed:-1,enable_safety_checker:!0,fixed_lens:!1,generate_audio:!1,image_url_input:"",video_url_input:"",quality:"basic",image_size:"square_hd",image_resolution:"1K",customMode:!1,instrumental:!1,style:"",title:"",negativeTags:"",callBackUrl:""}),[d,u]=T.useState({duration:[5,10],resolution:["480p","720p","1080p"]});T.useEffect(()=>{const W=h.bus.subscribe("studio:restoreForm",O=>{if(O){if(O.modelId){s(O.modelId);const q=bi.find($=>$.id===O.modelId);q?.modelApiId&&u(Ru(q.modelApiId))}a(O.prompt||""),O.params&&c(q=>({...q,...O.params}))}});return()=>{W()}},[]);const[f,p]=T.useState(null),[m,b]=T.useState([]);T.useEffect(()=>()=>{m.forEach(W=>{W.preview&&URL.revokeObjectURL(W.preview)})},[m]);const y=T.useMemo(()=>t.find(W=>W.id===r)||t[0],[r,t]);if(!y)return g.jsx("p",{className:"tw-text-red-400 tw-p-4",children:"Error: Model data failed to load or initialize."});const w=y?.type==="audio",v=y?.type==="image",S=!w&&r.includes("image-to-video"),C=!w&&r.includes("video-to-video"),x=r.includes("wan2.5"),I=r.includes("wan-2-6"),N=r.includes("v1-pro")||r.includes("v1-lite"),E=r.includes("seedance-1-5-pro"),A=n.status==="loading",L=T.useCallback(async W=>{const O=new FileReader;if(O.onload=async q=>{p(q.target.result);try{const $=await ec(W,"images/user-uploads");c(le=>({...le,image_url_input:$}))}catch($){let le="Upload failed: ";$?.response?.status===413?le+="File size exceeds 5MB limit":$?.response?.status===415?le+="Unsupported file type (JPEG/PNG only)":le+=$?.message||"Server connection failed",alert(le),p(null),c(De=>({...De,image_url_input:"",customMode:!1,instrumental:!1})),console.error("File upload error:",$)}},!W.type.startsWith("image/")){alert("Only image files are allowed (JPEG, PNG)");return}O.readAsDataURL(W)},[]),B=T.useCallback(()=>{p(null),c(W=>({...W,image_url_input:""}))},[]),G=W=>{if(W.preventDefault(),!i||A)return;if(w){e({modelId:r,prompt:i,...l});return}if(v){const{modelId:le,...De}=l;if(r.includes("edit")&&m.length>0){const kt=new DataTransfer;m.forEach(sn=>{kt.items.add(sn.file)}),De.image_files=kt.files}e({modelId:r,prompt:i,...De});return}if(S&&(!l.image_url_input||!l.image_url_input.startsWith("http"))){alert("I2V requires a valid public image URL (e.g., https://example.com/pic.jpg).");return}if(C&&(!l.video_url_input||!l.video_url_input.startsWith("http"))){alert("V2V requires a valid public video URL (e.g., https://example.com/video.mp4).");return}const O={resolution:String(l.resolution)||"1080p",duration:String(l.duration)||"5",seed:Number(l.seed)||-1};S||(O.aspect_ratio=l.aspect_ratio||"16:9"),S&&(O.image_url=l.image_url_input);const{modelId:q,...$}=l;e({modelId:r,...$,prompt:i,...O})},K=W=>{const O=W.target.value,q=bi.find(mt=>mt.id===O);s(O),p(null),m.forEach(mt=>{mt.preview&&URL.revokeObjectURL(mt.preview)}),b([]);const le=q?.type==="image"?"1:1":"16:9";c(mt=>({...mt,camera_fixed:!1,enable_safety_checker:!0,fixed_lens:!1,generate_audio:!1,negative_prompt:"",enable_prompt_expansion:!1,image_url_input:"",video_url_input:"",image_files:null,customMode:!1,instrumental:!1,style:"",title:"",negativeTags:"",callBackUrl:"",resolution:"1080p",duration:5,aspect_ratio:le,seed:-1,quality:"basic",image_size:"square_hd",image_resolution:"1K",...q?.modelApiId?Bm(q.modelApiId):{}}));const De=q?.modelApiId?Ru(q.modelApiId):{};u(De)},_=T.useMemo(()=>Nv(y,l,c,f,L,B,m,b),[y,l,f,L,B,m]),me=T.useMemo(()=>{if(w||v)return null;const W=d.resolution||(x?["720p","1080p"]:["480p","720p","1080p"]);return g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Resolution"}),g.jsx("div",{className:"tw-flex tw-gap-2",children:W.map(O=>g.jsx("button",{type:"button",onClick:()=>c(q=>({...q,resolution:O})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${l.resolution===O?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:O},O))})]})},[x,l.resolution,d.resolution,w,v]),Q=T.useMemo(()=>{if(w||v)return null;const W=d.duration||[5,10];return g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Duration (seconds)"}),g.jsx("div",{className:"tw-flex tw-gap-2",children:W.map(O=>g.jsxs("button",{type:"button",onClick:()=>c(q=>({...q,duration:O})),className:`tw-flex-1 tw-py-1.5 tw-rounded-md tw-text-sm ${l.duration===O?"tw-bg-cyan-500 tw-text-white":"tw-bg-slate-600 tw-text-gray-300 hover:tw-bg-slate-500"}`,children:[O,"s"]},O))})]})},[l.duration,d.duration,w,v]),Oe=T.useMemo(()=>{if(w||v||S||C)return null;const W=Array.isArray(d.aspect_ratio)&&d.aspect_ratio.length>0?d.aspect_ratio:["16:9","21:9","4:3","1:1","3:4","9:16"];return g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Aspect Ratio"}),g.jsx("select",{value:l.aspect_ratio||"16:9",onChange:O=>c(q=>({...q,aspect_ratio:O.target.value})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",children:W.map(O=>g.jsx("option",{value:O,children:O},O))})]})},[l.aspect_ratio,w,v,S,C,d.aspect_ratio]),[ae,j]=T.useState(!1),V=T.useMemo(()=>{const W={modelId:r,prompt:i};if(w){const q=(y?.modelApiId?.split("/")?.[1]||"").split("-")[0],$=q?q.toUpperCase():void 0,le={prompt:i,customMode:l.customMode||!1,instrumental:l.instrumental||!1,model:l.model||$};return l.style&&(le.style=l.style),l.title&&(le.title=l.title),l.negativeTags&&(le.negativeTags=l.negativeTags),l.callBackUrl&&(le.callBackUrl=l.callBackUrl),{...W,...le}}const O={resolution:String(l.resolution)||d.resolution?.[0]||"1080p",duration:String(l.duration)||"5"};return I||(O.seed=Number(l.seed)||-1),!S&&!C&&(O.aspect_ratio=l.aspect_ratio||"16:9"),S&&(O.image_url=l.image_url_input||""),C&&(O.video_url=l.video_url_input||""),x&&(l.negative_prompt&&(O.negative_prompt=l.negative_prompt),O.enable_prompt_expansion=!!l.enable_prompt_expansion),N&&(O.camera_fixed=!!l.camera_fixed,O.enable_safety_checker=l.enable_safety_checker!==void 0?!!l.enable_safety_checker:!0),E&&(O.fixed_lens=!!l.fixed_lens,O.generate_audio=!!l.generate_audio),{...W,...O}},[r,i,l,w,S,x,N,E,d.resolution,y?.modelApiId]);return g.jsxs("form",{onSubmit:G,className:"photo-studio-form-panel tw-bg-slate-700 tw-p-4 tw-rounded-lg tw-shadow-lg tw-flex tw-flex-col tw-gap-4",children:[g.jsx("h4",{className:"tw-text-white tw-font-bold tw-text-lg",children:"Generation Settings"}),g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Model Endpoint"}),g.jsx("select",{value:r,onChange:K,className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",children:t.map(W=>g.jsx("option",{value:W.id,children:W.name},W.id))})]}),g.jsx("textarea",{value:i,onChange:W=>a(W.target.value),placeholder:w?l.customMode&&!l.instrumental?"Enter the full song lyrics here...":"Describe the theme or mood for the song...":`Enter prompt for ${y.name}...`,rows:5,className:"tw-w-full tw-p-3 tw-rounded-md tw-bg-slate-600 tw-text-white tw-border tw-border-slate-500 focus:tw-border-cyan-400",required:!0}),_,g.jsxs("div",{className:"photo-studio-two-col-grid tw-grid tw-grid-cols-2 tw-gap-4",children:[!S&&!C&&Oe,me]}),!w&&!v&&g.jsxs("div",{className:"photo-studio-two-col-grid tw-grid tw-grid-cols-2 tw-gap-4",children:[Q,!I&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-300",children:"Seed (-1 for Random)"}),g.jsx("input",{type:"number",value:l.seed,onChange:W=>c(O=>({...O,seed:parseInt(W.target.value,10)||-1})),className:"tw-w-full tw-p-2 tw-rounded-md tw-bg-slate-600 tw-text-white",placeholder:"-1",min:"-1",max:"2147483647"})]})]}),g.jsx("button",{type:"submit",disabled:A,className:`btn tw-w-full tw-py-3 ${A?"is-loading":"tw-bg-cyan-500 hover:tw-bg-cyan-600"}`,children:A?n.message:"âœ¨ Run Generation"}),n.status==="error"&&g.jsxs("p",{className:"tw-text-red-400 tw-text-sm tw-mt-2 tw-text-center",children:["Error: ",n.message]}),g.jsx("div",{className:"tw-mt-4 tw-text-right",children:g.jsx("button",{type:"button",onClick:()=>j(W=>!W),className:"tw-text-cyan-400 tw-text-sm hover:tw-underline",children:ae?"Hide JSON":"Show JSON"})}),ae&&g.jsx("pre",{className:"tw-mt-2 tw-bg-slate-800 tw-rounded-md tw-text-gray-200 tw-text-xs tw-p-3 tw-overflow-x-auto",children:JSON.stringify(V,null,2)})]})},Tv=({results:t,onDelete:e,onConvertWav:n,onGenerateMidi:o})=>g.jsxs("div",{className:"photo-studio-results tw-mt-6",children:[g.jsxs("h4",{className:"tw-text-white tw-font-bold tw-text-lg tw-mb-3",children:["Results (",t.length,")"]}),g.jsxs("div",{className:"tw-flex tw-flex-col tw-gap-4 tw-p-2",children:[t.map(r=>g.jsxs("div",{className:"tw-bg-slate-700 tw-rounded-xl tw-overflow-hidden tw-shadow-xl",children:[r.type==="image"?g.jsx("img",{src:r.url,alt:r.prompt,className:"tw-w-full tw-h-auto tw-object-contain tw-max-h-[60vh]"}):r.type==="audio"?(()=>{const s=r.wavUrl||r.url||r.streamUrl;return s?g.jsx("audio",{controls:!0,src:s,className:"tw-w-full tw-h-auto tw-max-h-[60vh]"}):g.jsx("div",{className:"tw-p-3 tw-text-gray-400",children:"Audio unavailable"})})():g.jsx("video",{controls:!0,preload:"metadata",src:r.url,className:"tw-w-full tw-h-auto tw-object-contain tw-max-h-[60vh]"}),g.jsx("p",{className:"tw-text-xs tw-p-3 tw-text-gray-300 tw-leading-snug",children:r.type==="audio"&&r.title?r.title:r.prompt}),g.jsx("div",{className:"tw-flex tw-flex-wrap tw-justify-end tw-gap-3 tw-px-3 tw-py-2",children:r.type==="audio"?g.jsxs(g.Fragment,{children:[(()=>{const s=r.url||r.streamUrl;return typeof s=="string"&&s.length>0?g.jsx("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"MP3"}):null})(),r.wavUrl?g.jsx("a",{href:r.wavUrl,target:"_blank",rel:"noopener noreferrer",className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"WAV"}):g.jsx("button",{type:"button",onClick:()=>n&&n(r.id),className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"Convert to WAV"}),r.midiData?g.jsx("a",{href:`data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(r.midiData))}`,download:`midi-${r.id}.json`,className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"MIDI"}):g.jsx("button",{type:"button",onClick:()=>o&&o(r.id),className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"Generate MIDI"}),g.jsx("button",{type:"button",onClick:()=>e&&e(r.id),className:"tw-text-red-400 hover:tw-underline tw-text-sm",children:"Delete"})]}):g.jsxs(g.Fragment,{children:[g.jsx("a",{href:r.url,download:!0,className:"tw-text-cyan-400 hover:tw-underline tw-text-sm",children:"Download"}),g.jsx("button",{type:"button",onClick:()=>e&&e(r.id),className:"tw-text-red-400 hover:tw-underline tw-text-sm",children:"Delete"})]})})]},r.id)),t.length===0&&g.jsx("p",{className:"tw-text-gray-400 tw-text-center",children:"Start generating images, videos, or audio!"})]})]});function Pv({agentName:t,models:e,onGenerate:n}){const[o,r]=T.useState([]),[s,i]=T.useState({status:"ready",message:"Ready"}),[a,l]=T.useState({taskId:null,percent:0,label:"Idle",attempt:0,max:0}),[c,d]=T.useState(()=>typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 768px)").matches),[u,f]=T.useState({settings:!0,results:!0}),p=ot.useRef(null),m=ot.useRef([]);T.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const x=window.matchMedia("(max-width: 768px)"),I=N=>{d(!!N.matches)};return I(x),typeof x.addEventListener=="function"?(x.addEventListener("change",I),()=>x.removeEventListener("change",I)):(x.addListener(I),()=>x.removeListener(I))},[]);const b=T.useCallback(x=>{f(I=>({...I,[x]:!I[x]}))},[]),y=T.useCallback(x=>{f(I=>I[x]?I:{...I,[x]:!0})},[]),w=T.useCallback(x=>{const{prompt:I,modelId:N,...E}=x;p.current={modelId:x.modelId,prompt:I,params:{...E}},n&&n(x)},[n]),v=T.useCallback(x=>{r(I=>{const N=I.filter(E=>E.id!==x);try{const A=h.getProject()?.id||"default";Wo(A,{form:p.current,pendingTasks:m.current,results:N})}catch{}return N})},[]),S=T.useCallback(async x=>{const I=o.find(N=>N.id===x);if(!(!I||I.type!=="audio"))try{if(i({status:"loading",message:"Starting WAV conversion..."}),I.conversionPending)throw new Error("Conversion already in progress");const N=o.map(B=>B.id===x?{...B,conversionPending:!0}:B);r(N);const E=await yv(I.id,I.audioId);i({status:"loading",message:"Processing audio..."});const A=await Promise.race([wv(E),new Promise((B,G)=>setTimeout(()=>G(new Error("Conversion timeout - try again later")),3e5))]),L=o.map(B=>B.id===x?{...B,wavUrl:A,conversionPending:!1}:B);r(L),i({status:"success",message:"WAV ready!"}),Wo(h.getProject()?.id||"default",{form:p.current,pendingTasks:m.current,results:L}).catch(console.error)}catch(N){console.error("WAV conversion failed:",N);const E=N.response?.data?.error?.includes("Invalid audio")?"Invalid audio format - must be MP3":N.message.includes("timeout")?"Conversion timed out":"Conversion failed - please try again";i({status:"error",message:E,retryId:x});const A=o.map(L=>L.id===x?{...L,conversionPending:!1}:L);r(A)}},[o]),C=T.useCallback(async x=>{const I=o.find(N=>N.id===x);if(!(!I||I.type!=="audio")){i({status:"loading",message:"Separating vocals..."});try{const N=await vv(I.id,I.audioId,"split_stem"),E=await Sv(N);i({status:"loading",message:"Generating MIDI..."});const A=await kv(N),L=await xv(A),B=o.map(_=>_.id===x?{..._,midiData:L}:_);r(B),i({status:"success",message:"MIDI generation complete!"});const K=h.getProject()?.id||"default";Wo(K,{form:p.current,pendingTasks:m.current,results:B}).catch(()=>{})}catch(N){i({status:"error",message:N.message||"MIDI generation failed"})}}},[o]);return T.useEffect(()=>{const x=({status:B,message:G})=>i({status:B,message:G}),I=B=>{r(G=>{const K=[B,...G];m.current=m.current.filter(Q=>Q.taskId!==B.id);const me=h.getProject()?.id||"default";return Wo(me,{form:p.current,pendingTasks:m.current,results:K}).catch(()=>{}),K})},N=B=>{if(l(G=>({taskId:B.taskId||G.taskId,percent:typeof B.progress=="number"&&isFinite(B.progress)?B.progress:G.percent,label:B.message||B.status||G.label,attempt:B.attempt||G.attempt,max:B.max||G.max})),B.status==="submitted"){m.current=[{taskId:B.taskId,meta:{durationSec:p.current?.params?.duration||5,resolution:p.current?.params?.resolution||"720p"}},...m.current];const K=h.getProject()?.id||"default";Wo(K,{form:p.current,pendingTasks:m.current,results:o}).catch(()=>{})}else if(B.status==="success"){m.current=m.current.filter(_=>_.taskId!==B.taskId);const K=h.getProject()?.id||"default";Wo(K,{form:p.current,pendingTasks:m.current,results:o}).catch(()=>{})}},E=h.bus.subscribe("kieai:statusUpdate",x),A=h.bus.subscribe("kieai:newResult",I),L=h.bus.subscribe("kieai:progress",N);return()=>{E(),A(),L()}},[o,n]),T.useEffect(()=>{let x=!0;return(async()=>{try{const E=h.getProject()?.id||"default",A=await Ev(E);if(!x||!A)return;if(!((Array.isArray(A.results)||A.results===void 0)&&(typeof A.form=="object"||A.form===void 0)&&(Array.isArray(A.pendingTasks)||A.pendingTasks===void 0)))throw new Error("Invalid session format");if(batchUpdates(()=>{A.results?.length&&r(A.results.filter(B=>B?.id&&(B.type==="audio"||B.type==="video"||B.type==="image"))),A.form&&(p.current=A.form,h.bus.publish("studio:restoreForm",{...A.form,params:{...Bm(A.form.modelId),...A.form.params}})),A.pendingTasks?.length&&(m.current=A.pendingTasks.filter(B=>B?.taskId&&B?.meta?.durationSec))}),m.current.length){const G=[...m.current],K=async()=>{for(;G.length>0&&x;){const _=G.shift();try{const me=await lv(_.taskId,_.meta);x&&h.bus.publish("kieai:newResult",{id:me.taskId,type:"video",prompt:_.meta.prompt||"",url:me.url})}catch(me){console.warn("Resume polling failed for task:",_.taskId,me),x&&i({status:"error",message:`Failed to resume task ${_.taskId.slice(0,6)}...`})}}};Array.from({length:3}).forEach(K)}}catch(N){console.error("Session load failed:",N),x&&(i({status:"error",message:"Corrupted session data - starting fresh"}),r([]),m.current=[])}})(),()=>{x=!1}},[]),T.useEffect(()=>{c&&(s.status==="loading"||o.length>0)&&y("results")},[c,s.status,o.length,y]),g.jsxs("div",{className:"studio-content photo-studio-workspace photo-studio-shell tw-flex tw-flex-col tw-h-full tw-p-4 tw-bg-slate-800 tw-text-white tw-overflow-y-auto",children:[g.jsx("div",{className:"photo-studio-topbar tw-flex tw-items-center tw-mb-2",children:g.jsx("h2",{className:"photo-studio-title tw-text-xl tw-font-extrabold tw-text-cyan-400",children:t})}),g.jsxs("div",{className:"photo-studio-layout tw-flex tw-gap-6 tw-flex-grow tw-overflow-hidden",children:[g.jsx("div",{className:"photo-studio-form-column tw-w-full lg:tw-w-1/3 tw-flex-shrink-0",children:g.jsxs("section",{className:`photo-studio-mobile-panel ${c&&!u.settings?"is-collapsed":"is-open"}`,children:[g.jsxs("button",{type:"button",className:"photo-studio-mobile-panel-toggle","aria-expanded":!c||u.settings,onClick:()=>b("settings"),children:[g.jsxs("span",{className:"photo-studio-mobile-panel-title",children:[g.jsx("span",{className:"material-symbols-outlined",children:"tune"}),"Settings"]}),g.jsx("span",{className:"photo-studio-mobile-panel-toggle-icon material-symbols-outlined",children:u.settings?"expand_less":"expand_more"})]}),g.jsx("div",{className:"photo-studio-mobile-panel-body",children:g.jsxs("div",{className:"photo-studio-mobile-panel-body-inner",children:[g.jsx(Mv,{models:e,onSubmit:w,status:s}),s.status!=="ready"&&g.jsxs("div",{className:"photo-studio-progress-card tw-mt-4 tw-bg-slate-700 tw-rounded-lg tw-p-3",children:[g.jsxs("div",{className:"tw-flex tw-justify-between tw-text-xs tw-text-gray-300",children:[g.jsx("span",{children:a.label}),g.jsxs("span",{children:[a.attempt,"/",a.max||"âˆž"]})]}),g.jsx("progress",{className:"tw-w-full tw-mt-2",max:"100",value:a.percent||5})]})]})})]})}),g.jsx("div",{className:"photo-studio-results-column tw-w-full lg:tw-w-2/3",children:g.jsxs("section",{className:`photo-studio-mobile-panel ${c&&!u.results?"is-collapsed":"is-open"}`,children:[g.jsxs("button",{type:"button",className:"photo-studio-mobile-panel-toggle","aria-expanded":!c||u.results,onClick:()=>b("results"),children:[g.jsxs("span",{className:"photo-studio-mobile-panel-title",children:[g.jsx("span",{className:"material-symbols-outlined",children:"view_comfy"}),"Results",g.jsx("span",{className:"photo-studio-mobile-panel-count",children:o.length})]}),g.jsx("span",{className:"photo-studio-mobile-panel-meta",children:s.status==="loading"?"Generating":s.status==="error"?"Error":""}),g.jsx("span",{className:"photo-studio-mobile-panel-toggle-icon material-symbols-outlined",children:u.results?"expand_less":"expand_more"})]}),g.jsx("div",{className:"photo-studio-mobile-panel-body",children:g.jsx("div",{className:"photo-studio-mobile-panel-body-inner",children:g.jsx(Tv,{results:o,onDelete:v,onConvertWav:S,onGenerateMidi:C})})})]})})]})]})}const nc="kieai-studio-workspace",bd="photo-studio-root";let Fr=null;function Bv(){const t=Cv();return Array.isArray(t)?t.filter(e=>{const n=String(e?.id||"").toLowerCase(),o=String(e?.modelApiId||"").toLowerCase();return!n.includes("suno")&&!o.includes("suno/")}):[]}function Ov(){let t=document.getElementById(nc);if(!t){t=document.createElement("div"),t.id=nc,t.className="workspace hidden",(document.querySelector("#main-chat-panel .main-content-wrapper")||document.querySelector(".main-view-container"))?.appendChild(t);const e=document.createElement("div");e.id=bd,t.appendChild(e)}return t}function Dm(t){const e=document.querySelector("#main-chat-panel .main-content-wrapper");e&&e.classList.toggle("photo-studio-active",!!t)}function Lv(){if(Fr)return;const t=document.querySelector(".app-wrapper"),e=document.getElementById("sessions-panel")||document.querySelector(".sessions-panel"),n=document.getElementById("studio-panel"),o=document.getElementById("mobile-overlay"),r=document.getElementById("right-sidebar-overlay");Fr={appWrapper:{sidebarCollapsed:!!t?.classList.contains("sidebar-collapsed"),rightSidebarCollapsed:!!t?.classList.contains("right-sidebar-collapsed"),withRightCollapsed:!!t?.classList.contains("with-right-collapsed")},sessionsPanel:{isOpen:!!e?.classList.contains("is-open")},studioPanel:{collapsed:!!n?.classList.contains("collapsed"),open:!!n?.classList.contains("open")},overlays:{leftActive:!!o?.classList.contains("active"),rightActive:!!r?.classList.contains("active")},bodyOverflow:document.body.style.overflow||""},t?.classList.add("sidebar-collapsed"),e?.classList.remove("is-open"),o?.classList.remove("active"),n?.classList.add("collapsed"),n?.classList.remove("open"),t?.classList.add("with-right-collapsed"),t?.classList.add("right-sidebar-collapsed"),r?.classList.remove("active"),document.body.style.overflow=""}function Dv(){if(!Fr)return;const t=Fr;Fr=null;const e=document.querySelector(".app-wrapper"),n=document.getElementById("sessions-panel")||document.querySelector(".sessions-panel"),o=document.getElementById("studio-panel"),r=document.getElementById("mobile-overlay"),s=document.getElementById("right-sidebar-overlay");e&&(e.classList.toggle("sidebar-collapsed",t.appWrapper.sidebarCollapsed),e.classList.toggle("right-sidebar-collapsed",t.appWrapper.rightSidebarCollapsed),e.classList.toggle("with-right-collapsed",t.appWrapper.withRightCollapsed)),n?.classList.toggle("is-open",t.sessionsPanel.isOpen),o?.classList.toggle("collapsed",t.studioPanel.collapsed),o?.classList.toggle("open",t.studioPanel.open),r?.classList.toggle("active",t.overlays.leftActive),s?.classList.toggle("active",t.overlays.rightActive),document.body.style.overflow=t.bodyOverflow}function Rv(t){const e=Ov(),n=document.getElementById("chat-compose-workspace");e.removeAttribute("style"),n&&n.classList.remove("hidden"),Lv(),Dm(!0),e.classList.remove("hidden");const r={agentName:typeof t=="string"?t.replace(/^Visual Studio\b/,"Media Studio"):t,models:Bv(),onGenerate:Om};ao.mount(Pv,r,document.getElementById(bd))}function Pn(){const t=document.getElementById(nc),e=document.getElementById("chat-compose-workspace");t&&(t.removeAttribute("style"),Dm(!1),t.classList.add("hidden"),e&&e.classList.remove("hidden"),Dv(),ao.unmount(document.getElementById(bd)))}function jv(){const t=document.getElementById("kieAiApiKey");if(t){const e=wt();t.value=e?.apiSettings?.kieAiApiKey||"",t.addEventListener("input",()=>{ss({kieAiApiKey:t.value})})}}const ue={};function _v(){ue.appWrapper=document.querySelector(".app-wrapper"),ue.toggleRightSidebarBtn=document.getElementById("toggle-right-sidebar-btn"),ue.sessionsPanel=document.querySelector(".sessions-panel"),ue.hamburgerBtn=document.getElementById("hamburger-btn"),ue.closeSidebarBtn=document.querySelector('.sessions-panel .mobile-only[title="Close Sidebar"]'),ue.mobileOverlay=document.getElementById("mobile-overlay"),ue.composerPanel=document.querySelector(".composer-panel"),ue.resizerRow=document.getElementById("resizer-row"),ue.rightSidebar=document.getElementById("studio-panel"),ue.rightSidebarResizer=document.getElementById("right-sidebar-resizer")}function $v(t,e){if(!t||!e||t.dataset.rightSidebarResizerBound==="true")return;t.dataset.rightSidebarResizerBound="true";const n="promptPrimRightSidebarWidth",o=280,r=760;let s=null,i=0,a=0,l=0,c=null;const d=(S,C,x)=>Math.min(Math.max(S,C),x),u=()=>{const C=e.parentElement?.getBoundingClientRect().width||window.innerWidth;return d(C*.55,o,r)},f=S=>{const C=u(),x=d(Math.round(S),o,C);return document.documentElement.style.setProperty("--promptprim-right-sidebar-width",`${x}px`),e.style.width=`${x}px`,e.style.flexBasis=`${x}px`,x},p=()=>{const S=localStorage.getItem(n),C=Number(S);Number.isFinite(C)&&C>0?f(C):f(e.getBoundingClientRect().width||380)},m=()=>{if(s===null)return;c&&(cancelAnimationFrame(c),c=null);const S=e.getBoundingClientRect().width||a;localStorage.setItem(n,String(Math.round(S)));try{t.releasePointerCapture(s)}catch{}t.classList.remove("active"),e.classList.remove("is-resizing"),document.body.style.cursor="",s=null},b=S=>{s===null||S.pointerId!==s||(l=S.clientX,!c&&(c=requestAnimationFrame(()=>{const C=i-l;f(a+C),c=null})))},y=S=>{s===null||S.pointerId!==s||m()},w=S=>{s===null||S.pointerId!==s||m()},v=S=>{window.innerWidth<=900||e.classList.contains("collapsed")||ue.appWrapper?.classList.contains("with-right-collapsed")||S.pointerType==="mouse"&&S.button!==0||(S.preventDefault(),s=S.pointerId,i=S.clientX,a=e.getBoundingClientRect().width||380,l=S.clientX,t.classList.add("active"),e.classList.add("is-resizing"),document.body.style.cursor="col-resize",t.setPointerCapture(S.pointerId))};p(),window.addEventListener("resize",()=>{if(window.innerWidth<=900)return;const S=e.getBoundingClientRect().width||Number(localStorage.getItem(n))||380;f(S)}),t.addEventListener("pointerdown",v),t.addEventListener("pointermove",b),t.addEventListener("pointerup",y),t.addEventListener("pointercancel",w)}function Fv(t,e){if(!t||!e||t.dataset.horizontalResizerBound==="true")return;t.dataset.horizontalResizerBound="true";const n=140,o=140,r=[.38,.55,.72];let s=null,i=0,a=0,l=0,c=null;const d=(v,S,C)=>Math.min(Math.max(v,S),C),u=()=>{const S=e.parentElement?.getBoundingClientRect().height||window.innerHeight,C=Math.max(n,S-o);return{containerHeight:S,maxHeight:C}},f=v=>{e.style.flexBasis=`${Math.round(v)}px`},p=()=>{if(s===null)return;c&&(cancelAnimationFrame(c),c=null);const v=e.getBoundingClientRect().height,{containerHeight:S,maxHeight:C}=u(),x=r.map(N=>d(S*N,n,C)),I=x.reduce((N,E)=>Math.abs(E-v)<Math.abs(N-v)?E:N,x[0]||v);f(I),localStorage.setItem("promptPrimComposerHeight",String(Math.round(I))),h.bus.publish("composer:heightChanged",{height:Math.round(I)});try{t.releasePointerCapture(s)}catch{}t.classList.remove("active"),e.classList.remove("is-resizing"),document.body.style.cursor="",s=null},m=v=>{s===null||v.pointerId!==s||(l=v.clientY,!c&&(c=requestAnimationFrame(()=>{const S=l-i,{maxHeight:C}=u(),x=d(a-S,n,C);f(x),c=null})))},b=v=>{s===null||v.pointerId!==s||p()},y=v=>{s===null||v.pointerId!==s||p()},w=v=>{window.innerWidth<=768||v.pointerType==="mouse"&&v.button!==0||(v.preventDefault(),e.classList.contains("collapsed")&&h.bus.publish("ui:requestComposerOpen"),s=v.pointerId,i=v.clientY,a=e.getBoundingClientRect().height,l=v.clientY,t.classList.add("active"),e.classList.add("is-resizing"),document.body.style.cursor="row-resize",t.setPointerCapture(v.pointerId))};t.addEventListener("pointerdown",w),t.addEventListener("pointermove",m),t.addEventListener("pointerup",b),t.addEventListener("pointercancel",y)}function Wv(){if(!ue.sessionsPanel)return;const t=e=>{e.stopPropagation(),e.preventDefault(),ue.sessionsPanel.classList.remove("is-open"),ue.mobileOverlay?.classList.remove("active")};ue.hamburgerBtn?.addEventListener("click",e=>{if(window.innerWidth<=1024){const n=!ue.sessionsPanel.classList.contains("is-open");ue.sessionsPanel.classList.toggle("is-open",n),ue.mobileOverlay?.classList.toggle("active",n)}else ue.appWrapper?.classList.toggle("sidebar-collapsed")}),ue.mobileOverlay?.addEventListener("click",t,!0),ue.closeSidebarBtn?.addEventListener("click",t,!0)}function zv(){_v(),ue.resizerRow&&ue.composerPanel&&Fv(ue.resizerRow,ue.composerPanel),ue.rightSidebarResizer&&ue.rightSidebar&&$v(ue.rightSidebarResizer,ue.rightSidebar),Wv(),Hv(),console.log("Core layout manager initialized.")}function Hv(){!ue.toggleRightSidebarBtn||!ue.appWrapper||ue.toggleRightSidebarBtn.addEventListener("click",()=>{ue.appWrapper.classList.toggle("right-sidebar-collapsed"),ue.appWrapper.classList.contains("right-sidebar-collapsed")||h.bus.publish("studio:rendered")})}function Uv(){document.addEventListener("keydown",t=>{const e=document.querySelector('.modal-overlay[style*="display: flex"]'),n=document.getElementById("settings-panel"),o=n?.classList.contains("visible");if(!(!e&&!o)){if(t.key==="Escape"){if(t.preventDefault(),e){const r=e.querySelector(".btn-secondary")||e.querySelector(".modal-actions .btn");r&&r.click()}else if(o){const r=n.querySelector(".close-settings-btn");r&&r.click()}}if(t.key==="Enter"&&!t.shiftKey){if(t.target.tagName==="TEXTAREA"||t.target.tagName==="BUTTON")return;if(e){t.preventDefault();const r=e.querySelector(".modal-actions .btn:not(.btn-secondary):not(.btn-danger)");if(r)r.click();else{const s=e.querySelector(".modal-actions .btn");s&&s.click()}}}}}),console.log("Global keyboard bindings initialized.")}var Vv=Jy();const Rm=am(Vv);var Xa={exports:{}},Qa={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ju;function qv(){if(ju)return Qa;ju=1;var t=lm();function e(u,f){return u===f&&(u!==0||1/u===1/f)||u!==u&&f!==f}var n=typeof Object.is=="function"?Object.is:e,o=t.useState,r=t.useEffect,s=t.useLayoutEffect,i=t.useDebugValue;function a(u,f){var p=f(),m=o({inst:{value:p,getSnapshot:f}}),b=m[0].inst,y=m[1];return s(function(){b.value=p,b.getSnapshot=f,l(b)&&y({inst:b})},[u,p,f]),r(function(){return l(b)&&y({inst:b}),u(function(){l(b)&&y({inst:b})})},[u]),i(p),p}function l(u){var f=u.getSnapshot;u=u.value;try{var p=f();return!n(u,p)}catch{return!0}}function c(u,f){return f()}var d=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?c:a;return Qa.useSyncExternalStore=t.useSyncExternalStore!==void 0?t.useSyncExternalStore:d,Qa}var _u;function jm(){return _u||(_u=1,Xa.exports=qv()),Xa.exports}var _m=jm();function qe(t){this.content=t}qe.prototype={constructor:qe,find:function(t){for(var e=0;e<this.content.length;e+=2)if(this.content[e]===t)return e;return-1},get:function(t){var e=this.find(t);return e==-1?void 0:this.content[e+1]},update:function(t,e,n){var o=n&&n!=t?this.remove(n):this,r=o.find(t),s=o.content.slice();return r==-1?s.push(n||t,e):(s[r+1]=e,n&&(s[r]=n)),new qe(s)},remove:function(t){var e=this.find(t);if(e==-1)return this;var n=this.content.slice();return n.splice(e,2),new qe(n)},addToStart:function(t,e){return new qe([t,e].concat(this.remove(t).content))},addToEnd:function(t,e){var n=this.remove(t).content.slice();return n.push(t,e),new qe(n)},addBefore:function(t,e,n){var o=this.remove(e),r=o.content.slice(),s=o.find(t);return r.splice(s==-1?r.length:s,0,e,n),new qe(r)},forEach:function(t){for(var e=0;e<this.content.length;e+=2)t(this.content[e],this.content[e+1])},prepend:function(t){return t=qe.from(t),t.size?new qe(t.content.concat(this.subtract(t).content)):this},append:function(t){return t=qe.from(t),t.size?new qe(this.subtract(t).content.concat(t.content)):this},subtract:function(t){var e=this;t=qe.from(t);for(var n=0;n<t.content.length;n+=2)e=e.remove(t.content[n]);return e},toObject:function(){var t={};return this.forEach(function(e,n){t[e]=n}),t},get size(){return this.content.length>>1}};qe.from=function(t){if(t instanceof qe)return t;var e=[];if(t)for(var n in t)e.push(n,t[n]);return new qe(e)};function $m(t,e,n){for(let o=0;;o++){if(o==t.childCount||o==e.childCount)return t.childCount==e.childCount?null:n;let r=t.child(o),s=e.child(o);if(r==s){n+=r.nodeSize;continue}if(!r.sameMarkup(s))return n;if(r.isText&&r.text!=s.text){for(let i=0;r.text[i]==s.text[i];i++)n++;return n}if(r.content.size||s.content.size){let i=$m(r.content,s.content,n+1);if(i!=null)return i}n+=r.nodeSize}}function Fm(t,e,n,o){for(let r=t.childCount,s=e.childCount;;){if(r==0||s==0)return r==s?null:{a:n,b:o};let i=t.child(--r),a=e.child(--s),l=i.nodeSize;if(i==a){n-=l,o-=l;continue}if(!i.sameMarkup(a))return{a:n,b:o};if(i.isText&&i.text!=a.text){let c=0,d=Math.min(i.text.length,a.text.length);for(;c<d&&i.text[i.text.length-c-1]==a.text[a.text.length-c-1];)c++,n--,o--;return{a:n,b:o}}if(i.content.size||a.content.size){let c=Fm(i.content,a.content,n-1,o-1);if(c)return c}n-=l,o-=l}}class M{constructor(e,n){if(this.content=e,this.size=n||0,n==null)for(let o=0;o<e.length;o++)this.size+=e[o].nodeSize}nodesBetween(e,n,o,r=0,s){for(let i=0,a=0;a<n;i++){let l=this.content[i],c=a+l.nodeSize;if(c>e&&o(l,r+a,s||null,i)!==!1&&l.content.size){let d=a+1;l.nodesBetween(Math.max(0,e-d),Math.min(l.content.size,n-d),o,r+d)}a=c}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,n,o,r){let s="",i=!0;return this.nodesBetween(e,n,(a,l)=>{let c=a.isText?a.text.slice(Math.max(e,l)-l,n-l):a.isLeaf?r?typeof r=="function"?r(a):r:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&c||a.isTextblock)&&o&&(i?i=!1:s+=o),s+=c},0),s}append(e){if(!e.size)return this;if(!this.size)return e;let n=this.lastChild,o=e.firstChild,r=this.content.slice(),s=0;for(n.isText&&n.sameMarkup(o)&&(r[r.length-1]=n.withText(n.text+o.text),s=1);s<e.content.length;s++)r.push(e.content[s]);return new M(r,this.size+e.size)}cut(e,n=this.size){if(e==0&&n==this.size)return this;let o=[],r=0;if(n>e)for(let s=0,i=0;i<n;s++){let a=this.content[s],l=i+a.nodeSize;l>e&&((i<e||l>n)&&(a.isText?a=a.cut(Math.max(0,e-i),Math.min(a.text.length,n-i)):a=a.cut(Math.max(0,e-i-1),Math.min(a.content.size,n-i-1))),o.push(a),r+=a.nodeSize),i=l}return new M(o,r)}cutByIndex(e,n){return e==n?M.empty:e==0&&n==this.content.length?this:new M(this.content.slice(e,n))}replaceChild(e,n){let o=this.content[e];if(o==n)return this;let r=this.content.slice(),s=this.size+n.nodeSize-o.nodeSize;return r[e]=n,new M(r,s)}addToStart(e){return new M([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new M(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let n=0;n<this.content.length;n++)if(!this.content[n].eq(e.content[n]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let n=this.content[e];if(!n)throw new RangeError("Index "+e+" out of range for "+this);return n}maybeChild(e){return this.content[e]||null}forEach(e){for(let n=0,o=0;n<this.content.length;n++){let r=this.content[n];e(r,o,n),o+=r.nodeSize}}findDiffStart(e,n=0){return $m(this,e,n)}findDiffEnd(e,n=this.size,o=e.size){return Fm(this,e,n,o)}findIndex(e){if(e==0)return Ps(0,e);if(e==this.size)return Ps(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let n=0,o=0;;n++){let r=this.child(n),s=o+r.nodeSize;if(s>=e)return s==e?Ps(n+1,s):Ps(n,o);o=s}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,n){if(!n)return M.empty;if(!Array.isArray(n))throw new RangeError("Invalid input for Fragment.fromJSON");return new M(n.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return M.empty;let n,o=0;for(let r=0;r<e.length;r++){let s=e[r];o+=s.nodeSize,r&&s.isText&&e[r-1].sameMarkup(s)?(n||(n=e.slice(0,r)),n[n.length-1]=s.withText(n[n.length-1].text+s.text)):n&&n.push(s)}return new M(n||e,o)}static from(e){if(!e)return M.empty;if(e instanceof M)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new M([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}M.empty=new M([],0);const Za={index:0,offset:0};function Ps(t,e){return Za.index=t,Za.offset=e,Za}function yi(t,e){if(t===e)return!0;if(!(t&&typeof t=="object")||!(e&&typeof e=="object"))return!1;let n=Array.isArray(t);if(Array.isArray(e)!=n)return!1;if(n){if(t.length!=e.length)return!1;for(let o=0;o<t.length;o++)if(!yi(t[o],e[o]))return!1}else{for(let o in t)if(!(o in e)||!yi(t[o],e[o]))return!1;for(let o in e)if(!(o in t))return!1}return!0}let Se=class oc{constructor(e,n){this.type=e,this.attrs=n}addToSet(e){let n,o=!1;for(let r=0;r<e.length;r++){let s=e[r];if(this.eq(s))return e;if(this.type.excludes(s.type))n||(n=e.slice(0,r));else{if(s.type.excludes(this.type))return e;!o&&s.type.rank>this.type.rank&&(n||(n=e.slice(0,r)),n.push(this),o=!0),n&&n.push(s)}}return n||(n=e.slice()),o||n.push(this),n}removeFromSet(e){for(let n=0;n<e.length;n++)if(this.eq(e[n]))return e.slice(0,n).concat(e.slice(n+1));return e}isInSet(e){for(let n=0;n<e.length;n++)if(this.eq(e[n]))return!0;return!1}eq(e){return this==e||this.type==e.type&&yi(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let n in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,n){if(!n)throw new RangeError("Invalid input for Mark.fromJSON");let o=e.marks[n.type];if(!o)throw new RangeError(`There is no mark type ${n.type} in this schema`);let r=o.create(n.attrs);return o.checkAttrs(r.attrs),r}static sameSet(e,n){if(e==n)return!0;if(e.length!=n.length)return!1;for(let o=0;o<e.length;o++)if(!e[o].eq(n[o]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return oc.none;if(e instanceof oc)return[e];let n=e.slice();return n.sort((o,r)=>o.type.rank-r.type.rank),n}};Se.none=[];class wi extends Error{}class R{constructor(e,n,o){this.content=e,this.openStart=n,this.openEnd=o}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,n){let o=zm(this.content,e+this.openStart,n);return o&&new R(o,this.openStart,this.openEnd)}removeBetween(e,n){return new R(Wm(this.content,e+this.openStart,n+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,n){if(!n)return R.empty;let o=n.openStart||0,r=n.openEnd||0;if(typeof o!="number"||typeof r!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new R(M.fromJSON(e,n.content),o,r)}static maxOpen(e,n=!0){let o=0,r=0;for(let s=e.firstChild;s&&!s.isLeaf&&(n||!s.type.spec.isolating);s=s.firstChild)o++;for(let s=e.lastChild;s&&!s.isLeaf&&(n||!s.type.spec.isolating);s=s.lastChild)r++;return new R(e,o,r)}}R.empty=new R(M.empty,0,0);function Wm(t,e,n){let{index:o,offset:r}=t.findIndex(e),s=t.maybeChild(o),{index:i,offset:a}=t.findIndex(n);if(r==e||s.isText){if(a!=n&&!t.child(i).isText)throw new RangeError("Removing non-flat range");return t.cut(0,e).append(t.cut(n))}if(o!=i)throw new RangeError("Removing non-flat range");return t.replaceChild(o,s.copy(Wm(s.content,e-r-1,n-r-1)))}function zm(t,e,n,o){let{index:r,offset:s}=t.findIndex(e),i=t.maybeChild(r);if(s==e||i.isText)return o&&!o.canReplace(r,r,n)?null:t.cut(0,e).append(n).append(t.cut(e));let a=zm(i.content,e-s-1,n,i);return a&&t.replaceChild(r,i.copy(a))}function Kv(t,e,n){if(n.openStart>t.depth)throw new wi("Inserted content deeper than insertion position");if(t.depth-n.openStart!=e.depth-n.openEnd)throw new wi("Inconsistent open depths");return Hm(t,e,n,0)}function Hm(t,e,n,o){let r=t.index(o),s=t.node(o);if(r==e.index(o)&&o<t.depth-n.openStart){let i=Hm(t,e,n,o+1);return s.copy(s.content.replaceChild(r,i))}else if(n.content.size)if(!n.openStart&&!n.openEnd&&t.depth==o&&e.depth==o){let i=t.parent,a=i.content;return Co(i,a.cut(0,t.parentOffset).append(n.content).append(a.cut(e.parentOffset)))}else{let{start:i,end:a}=Gv(n,t);return Co(s,Vm(t,i,a,e,o))}else return Co(s,vi(t,e,o))}function Um(t,e){if(!e.type.compatibleContent(t.type))throw new wi("Cannot join "+e.type.name+" onto "+t.type.name)}function rc(t,e,n){let o=t.node(n);return Um(o,e.node(n)),o}function xo(t,e){let n=e.length-1;n>=0&&t.isText&&t.sameMarkup(e[n])?e[n]=t.withText(e[n].text+t.text):e.push(t)}function Wr(t,e,n,o){let r=(e||t).node(n),s=0,i=e?e.index(n):r.childCount;t&&(s=t.index(n),t.depth>n?s++:t.textOffset&&(xo(t.nodeAfter,o),s++));for(let a=s;a<i;a++)xo(r.child(a),o);e&&e.depth==n&&e.textOffset&&xo(e.nodeBefore,o)}function Co(t,e){return t.type.checkContent(e),t.copy(e)}function Vm(t,e,n,o,r){let s=t.depth>r&&rc(t,e,r+1),i=o.depth>r&&rc(n,o,r+1),a=[];return Wr(null,t,r,a),s&&i&&e.index(r)==n.index(r)?(Um(s,i),xo(Co(s,Vm(t,e,n,o,r+1)),a)):(s&&xo(Co(s,vi(t,e,r+1)),a),Wr(e,n,r,a),i&&xo(Co(i,vi(n,o,r+1)),a)),Wr(o,null,r,a),new M(a)}function vi(t,e,n){let o=[];if(Wr(null,t,n,o),t.depth>n){let r=rc(t,e,n+1);xo(Co(r,vi(t,e,n+1)),o)}return Wr(e,null,n,o),new M(o)}function Gv(t,e){let n=e.depth-t.openStart,r=e.node(n).copy(t.content);for(let s=n-1;s>=0;s--)r=e.node(s).copy(M.from(r));return{start:r.resolveNoCache(t.openStart+n),end:r.resolveNoCache(r.content.size-t.openEnd-n)}}class ls{constructor(e,n,o){this.pos=e,this.path=n,this.parentOffset=o,this.depth=n.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,n=this.index(this.depth);if(n==e.childCount)return null;let o=this.pos-this.path[this.path.length-1],r=e.child(n);return o?e.child(n).cut(o):r}get nodeBefore(){let e=this.index(this.depth),n=this.pos-this.path[this.path.length-1];return n?this.parent.child(e).cut(0,n):e==0?null:this.parent.child(e-1)}posAtIndex(e,n){n=this.resolveDepth(n);let o=this.path[n*3],r=n==0?0:this.path[n*3-1]+1;for(let s=0;s<e;s++)r+=o.child(s).nodeSize;return r}marks(){let e=this.parent,n=this.index();if(e.content.size==0)return Se.none;if(this.textOffset)return e.child(n).marks;let o=e.maybeChild(n-1),r=e.maybeChild(n);if(!o){let a=o;o=r,r=a}let s=o.marks;for(var i=0;i<s.length;i++)s[i].type.spec.inclusive===!1&&(!r||!s[i].isInSet(r.marks))&&(s=s[i--].removeFromSet(s));return s}marksAcross(e){let n=this.parent.maybeChild(this.index());if(!n||!n.isInline)return null;let o=n.marks,r=e.parent.maybeChild(e.index());for(var s=0;s<o.length;s++)o[s].type.spec.inclusive===!1&&(!r||!o[s].isInSet(r.marks))&&(o=o[s--].removeFromSet(o));return o}sharedDepth(e){for(let n=this.depth;n>0;n--)if(this.start(n)<=e&&this.end(n)>=e)return n;return 0}blockRange(e=this,n){if(e.pos<this.pos)return e.blockRange(this);for(let o=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);o>=0;o--)if(e.pos<=this.end(o)&&(!n||n(this.node(o))))return new Si(this,e,o);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let n=1;n<=this.depth;n++)e+=(e?"/":"")+this.node(n).type.name+"_"+this.index(n-1);return e+":"+this.parentOffset}static resolve(e,n){if(!(n>=0&&n<=e.content.size))throw new RangeError("Position "+n+" out of range");let o=[],r=0,s=n;for(let i=e;;){let{index:a,offset:l}=i.content.findIndex(s),c=s-l;if(o.push(i,a,r+l),!c||(i=i.child(a),i.isText))break;s=c-1,r+=l+1}return new ls(n,o,s)}static resolveCached(e,n){let o=$u.get(e);if(o)for(let s=0;s<o.elts.length;s++){let i=o.elts[s];if(i.pos==n)return i}else $u.set(e,o=new Jv);let r=o.elts[o.i]=ls.resolve(e,n);return o.i=(o.i+1)%Yv,r}}class Jv{constructor(){this.elts=[],this.i=0}}const Yv=12,$u=new WeakMap;class Si{constructor(e,n,o){this.$from=e,this.$to=n,this.depth=o}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const Xv=Object.create(null);let Gn=class sc{constructor(e,n,o,r=Se.none){this.type=e,this.attrs=n,this.marks=r,this.content=o||M.empty}get children(){return this.content.content}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,n,o,r=0){this.content.nodesBetween(e,n,o,r,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,n,o,r){return this.content.textBetween(e,n,o,r)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,n,o){return this.type==e&&yi(this.attrs,n||e.defaultAttrs||Xv)&&Se.sameSet(this.marks,o||Se.none)}copy(e=null){return e==this.content?this:new sc(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new sc(this.type,this.attrs,this.content,e)}cut(e,n=this.content.size){return e==0&&n==this.content.size?this:this.copy(this.content.cut(e,n))}slice(e,n=this.content.size,o=!1){if(e==n)return R.empty;let r=this.resolve(e),s=this.resolve(n),i=o?0:r.sharedDepth(n),a=r.start(i),c=r.node(i).content.cut(r.pos-a,s.pos-a);return new R(c,r.depth-i,s.depth-i)}replace(e,n,o){return Kv(this.resolve(e),this.resolve(n),o)}nodeAt(e){for(let n=this;;){let{index:o,offset:r}=n.content.findIndex(e);if(n=n.maybeChild(o),!n)return null;if(r==e||n.isText)return n;e-=r+1}}childAfter(e){let{index:n,offset:o}=this.content.findIndex(e);return{node:this.content.maybeChild(n),index:n,offset:o}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:n,offset:o}=this.content.findIndex(e);if(o<e)return{node:this.content.child(n),index:n,offset:o};let r=this.content.child(n-1);return{node:r,index:n-1,offset:o-r.nodeSize}}resolve(e){return ls.resolveCached(this,e)}resolveNoCache(e){return ls.resolve(this,e)}rangeHasMark(e,n,o){let r=!1;return n>e&&this.nodesBetween(e,n,s=>(o.isInSet(s.marks)&&(r=!0),!r)),r}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),qm(this.marks,e)}contentMatchAt(e){let n=this.type.contentMatch.matchFragment(this.content,0,e);if(!n)throw new Error("Called contentMatchAt on a node with invalid content");return n}canReplace(e,n,o=M.empty,r=0,s=o.childCount){let i=this.contentMatchAt(e).matchFragment(o,r,s),a=i&&i.matchFragment(this.content,n);if(!a||!a.validEnd)return!1;for(let l=r;l<s;l++)if(!this.type.allowsMarks(o.child(l).marks))return!1;return!0}canReplaceWith(e,n,o,r){if(r&&!this.type.allowsMarks(r))return!1;let s=this.contentMatchAt(e).matchType(o),i=s&&s.matchFragment(this.content,n);return i?i.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=Se.none;for(let n=0;n<this.marks.length;n++){let o=this.marks[n];o.type.checkAttrs(o.attrs),e=o.addToSet(e)}if(!Se.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(n=>n.type.name)}`);this.content.forEach(n=>n.check())}toJSON(){let e={type:this.type.name};for(let n in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(n=>n.toJSON())),e}static fromJSON(e,n){if(!n)throw new RangeError("Invalid input for Node.fromJSON");let o;if(n.marks){if(!Array.isArray(n.marks))throw new RangeError("Invalid mark data for Node.fromJSON");o=n.marks.map(e.markFromJSON)}if(n.type=="text"){if(typeof n.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(n.text,o)}let r=M.fromJSON(e,n.content),s=e.nodeType(n.type).create(n.attrs,r,o);return s.type.checkAttrs(s.attrs),s}};Gn.prototype.text=void 0;class ki extends Gn{constructor(e,n,o,r){if(super(e,n,null,r),!o)throw new RangeError("Empty text nodes are not allowed");this.text=o}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):qm(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,n){return this.text.slice(e,n)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new ki(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new ki(this.type,this.attrs,e,this.marks)}cut(e=0,n=this.text.length){return e==0&&n==this.text.length?this:this.withText(this.text.slice(e,n))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function qm(t,e){for(let n=t.length-1;n>=0;n--)e=t[n].type.name+"("+e+")";return e}class Po{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,n){let o=new Qv(e,n);if(o.next==null)return Po.empty;let r=Km(o);o.next&&o.err("Unexpected trailing text");let s=sS(rS(r));return iS(s,o),s}matchType(e){for(let n=0;n<this.next.length;n++)if(this.next[n].type==e)return this.next[n].next;return null}matchFragment(e,n=0,o=e.childCount){let r=this;for(let s=n;r&&s<o;s++)r=r.matchType(e.child(s).type);return r}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:n}=this.next[e];if(!(n.isText||n.hasRequiredAttrs()))return n}return null}compatible(e){for(let n=0;n<this.next.length;n++)for(let o=0;o<e.next.length;o++)if(this.next[n].type==e.next[o].type)return!0;return!1}fillBefore(e,n=!1,o=0){let r=[this];function s(i,a){let l=i.matchFragment(e,o);if(l&&(!n||l.validEnd))return M.from(a.map(c=>c.createAndFill()));for(let c=0;c<i.next.length;c++){let{type:d,next:u}=i.next[c];if(!(d.isText||d.hasRequiredAttrs())&&r.indexOf(u)==-1){r.push(u);let f=s(u,a.concat(d));if(f)return f}}return null}return s(this,[])}findWrapping(e){for(let o=0;o<this.wrapCache.length;o+=2)if(this.wrapCache[o]==e)return this.wrapCache[o+1];let n=this.computeWrapping(e);return this.wrapCache.push(e,n),n}computeWrapping(e){let n=Object.create(null),o=[{match:this,type:null,via:null}];for(;o.length;){let r=o.shift(),s=r.match;if(s.matchType(e)){let i=[];for(let a=r;a.type;a=a.via)i.push(a.type);return i.reverse()}for(let i=0;i<s.next.length;i++){let{type:a,next:l}=s.next[i];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in n)&&(!r.type||l.validEnd)&&(o.push({match:a.contentMatch,type:a,via:r}),n[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function n(o){e.push(o);for(let r=0;r<o.next.length;r++)e.indexOf(o.next[r].next)==-1&&n(o.next[r].next)}return n(this),e.map((o,r)=>{let s=r+(o.validEnd?"*":" ")+" ";for(let i=0;i<o.next.length;i++)s+=(i?", ":"")+o.next[i].type.name+"->"+e.indexOf(o.next[i].next);return s}).join(`
`)}}Po.empty=new Po(!0);class Qv{constructor(e,n){this.string=e,this.nodeTypes=n,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function Km(t){let e=[];do e.push(Zv(t));while(t.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function Zv(t){let e=[];do e.push(eS(t));while(t.next&&t.next!=")"&&t.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function eS(t){let e=oS(t);for(;;)if(t.eat("+"))e={type:"plus",expr:e};else if(t.eat("*"))e={type:"star",expr:e};else if(t.eat("?"))e={type:"opt",expr:e};else if(t.eat("{"))e=tS(t,e);else break;return e}function Fu(t){/\D/.test(t.next)&&t.err("Expected number, got '"+t.next+"'");let e=Number(t.next);return t.pos++,e}function tS(t,e){let n=Fu(t),o=n;return t.eat(",")&&(t.next!="}"?o=Fu(t):o=-1),t.eat("}")||t.err("Unclosed braced range"),{type:"range",min:n,max:o,expr:e}}function nS(t,e){let n=t.nodeTypes,o=n[e];if(o)return[o];let r=[];for(let s in n){let i=n[s];i.isInGroup(e)&&r.push(i)}return r.length==0&&t.err("No node type or group '"+e+"' found"),r}function oS(t){if(t.eat("(")){let e=Km(t);return t.eat(")")||t.err("Missing closing paren"),e}else if(/\W/.test(t.next))t.err("Unexpected token '"+t.next+"'");else{let e=nS(t,t.next).map(n=>(t.inline==null?t.inline=n.isInline:t.inline!=n.isInline&&t.err("Mixing inline and block content"),{type:"name",value:n}));return t.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function rS(t){let e=[[]];return r(s(t,0),n()),e;function n(){return e.push([])-1}function o(i,a,l){let c={term:l,to:a};return e[i].push(c),c}function r(i,a){i.forEach(l=>l.to=a)}function s(i,a){if(i.type=="choice")return i.exprs.reduce((l,c)=>l.concat(s(c,a)),[]);if(i.type=="seq")for(let l=0;;l++){let c=s(i.exprs[l],a);if(l==i.exprs.length-1)return c;r(c,a=n())}else if(i.type=="star"){let l=n();return o(a,l),r(s(i.expr,l),l),[o(l)]}else if(i.type=="plus"){let l=n();return r(s(i.expr,a),l),r(s(i.expr,l),l),[o(l)]}else{if(i.type=="opt")return[o(a)].concat(s(i.expr,a));if(i.type=="range"){let l=a;for(let c=0;c<i.min;c++){let d=n();r(s(i.expr,l),d),l=d}if(i.max==-1)r(s(i.expr,l),l);else for(let c=i.min;c<i.max;c++){let d=n();o(l,d),r(s(i.expr,l),d),l=d}return[o(l)]}else{if(i.type=="name")return[o(a,void 0,i.value)];throw new Error("Unknown expr type")}}}}function Gm(t,e){return e-t}function Wu(t,e){let n=[];return o(e),n.sort(Gm);function o(r){let s=t[r];if(s.length==1&&!s[0].term)return o(s[0].to);n.push(r);for(let i=0;i<s.length;i++){let{term:a,to:l}=s[i];!a&&n.indexOf(l)==-1&&o(l)}}}function sS(t){let e=Object.create(null);return n(Wu(t,0));function n(o){let r=[];o.forEach(i=>{t[i].forEach(({term:a,to:l})=>{if(!a)return;let c;for(let d=0;d<r.length;d++)r[d][0]==a&&(c=r[d][1]);Wu(t,l).forEach(d=>{c||r.push([a,c=[]]),c.indexOf(d)==-1&&c.push(d)})})});let s=e[o.join(",")]=new Po(o.indexOf(t.length-1)>-1);for(let i=0;i<r.length;i++){let a=r[i][1].sort(Gm);s.next.push({type:r[i][0],next:e[a.join(",")]||n(a)})}return s}}function iS(t,e){for(let n=0,o=[t];n<o.length;n++){let r=o[n],s=!r.validEnd,i=[];for(let a=0;a<r.next.length;a++){let{type:l,next:c}=r.next[a];i.push(l.name),s&&!(l.isText||l.hasRequiredAttrs())&&(s=!1),o.indexOf(c)==-1&&o.push(c)}s&&e.err("Only non-generatable nodes ("+i.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function Jm(t){let e=Object.create(null);for(let n in t){let o=t[n];if(!o.hasDefault)return null;e[n]=o.default}return e}function Ym(t,e){let n=Object.create(null);for(let o in t){let r=e&&e[o];if(r===void 0){let s=t[o];if(s.hasDefault)r=s.default;else throw new RangeError("No value supplied for attribute "+o)}n[o]=r}return n}function Xm(t,e,n,o){for(let r in e)if(!(r in t))throw new RangeError(`Unsupported attribute ${r} for ${n} of type ${r}`);for(let r in t){let s=t[r];s.validate&&s.validate(e[r])}}function Qm(t,e){let n=Object.create(null);if(e)for(let o in e)n[o]=new lS(t,o,e[o]);return n}let zu=class Zm{constructor(e,n,o){this.name=e,this.schema=n,this.spec=o,this.markSet=null,this.groups=o.group?o.group.split(" "):[],this.attrs=Qm(e,o.attrs),this.defaultAttrs=Jm(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(o.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==Po.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}isInGroup(e){return this.groups.indexOf(e)>-1}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:Ym(this.attrs,e)}create(e=null,n,o){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new Gn(this,this.computeAttrs(e),M.from(n),Se.setFrom(o))}createChecked(e=null,n,o){return n=M.from(n),this.checkContent(n),new Gn(this,this.computeAttrs(e),n,Se.setFrom(o))}createAndFill(e=null,n,o){if(e=this.computeAttrs(e),n=M.from(n),n.size){let i=this.contentMatch.fillBefore(n);if(!i)return null;n=i.append(n)}let r=this.contentMatch.matchFragment(n),s=r&&r.fillBefore(M.empty,!0);return s?new Gn(this,e,n.append(s),Se.setFrom(o)):null}validContent(e){let n=this.contentMatch.matchFragment(e);if(!n||!n.validEnd)return!1;for(let o=0;o<e.childCount;o++)if(!this.allowsMarks(e.child(o).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){Xm(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let n=0;n<e.length;n++)if(!this.allowsMarkType(e[n].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let n;for(let o=0;o<e.length;o++)this.allowsMarkType(e[o].type)?n&&n.push(e[o]):n||(n=e.slice(0,o));return n?n.length?n:Se.none:e}static compile(e,n){let o=Object.create(null);e.forEach((s,i)=>o[s]=new Zm(s,n,i));let r=n.spec.topNode||"doc";if(!o[r])throw new RangeError("Schema is missing its top node type ('"+r+"')");if(!o.text)throw new RangeError("Every schema needs a 'text' type");for(let s in o.text.attrs)throw new RangeError("The text node type should not have attributes");return o}};function aS(t,e,n){let o=n.split("|");return r=>{let s=r===null?"null":typeof r;if(o.indexOf(s)<0)throw new RangeError(`Expected value of type ${o} for attribute ${e} on type ${t}, got ${s}`)}}class lS{constructor(e,n,o){this.hasDefault=Object.prototype.hasOwnProperty.call(o,"default"),this.default=o.default,this.validate=typeof o.validate=="string"?aS(e,n,o.validate):o.validate}get isRequired(){return!this.hasDefault}}class Ia{constructor(e,n,o,r){this.name=e,this.rank=n,this.schema=o,this.spec=r,this.attrs=Qm(e,r.attrs),this.excluded=null;let s=Jm(this.attrs);this.instance=s?new Se(this,s):null}create(e=null){return!e&&this.instance?this.instance:new Se(this,Ym(this.attrs,e))}static compile(e,n){let o=Object.create(null),r=0;return e.forEach((s,i)=>o[s]=new Ia(s,r++,n,i)),o}removeFromSet(e){for(var n=0;n<e.length;n++)e[n].type==this&&(e=e.slice(0,n).concat(e.slice(n+1)),n--);return e}isInSet(e){for(let n=0;n<e.length;n++)if(e[n].type==this)return e[n]}checkAttrs(e){Xm(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class eh{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let n=this.spec={};for(let r in e)n[r]=e[r];n.nodes=qe.from(e.nodes),n.marks=qe.from(e.marks||{}),this.nodes=zu.compile(this.spec.nodes,this),this.marks=Ia.compile(this.spec.marks,this);let o=Object.create(null);for(let r in this.nodes){if(r in this.marks)throw new RangeError(r+" can not be both a node and a mark");let s=this.nodes[r],i=s.spec.content||"",a=s.spec.marks;if(s.contentMatch=o[i]||(o[i]=Po.parse(i,this.nodes)),s.inlineContent=s.contentMatch.inlineContent,s.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!s.isInline||!s.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=s}s.markSet=a=="_"?null:a?Hu(this,a.split(" ")):a==""||!s.inlineContent?[]:null}for(let r in this.marks){let s=this.marks[r],i=s.spec.excludes;s.excluded=i==null?[s]:i==""?[]:Hu(this,i.split(" "))}this.nodeFromJSON=r=>Gn.fromJSON(this,r),this.markFromJSON=r=>Se.fromJSON(this,r),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,n=null,o,r){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof zu){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(n,o,r)}text(e,n){let o=this.nodes.text;return new ki(o,o.defaultAttrs,e,Se.setFrom(n))}mark(e,n){return typeof e=="string"&&(e=this.marks[e]),e.create(n)}nodeType(e){let n=this.nodes[e];if(!n)throw new RangeError("Unknown node type: "+e);return n}}function Hu(t,e){let n=[];for(let o=0;o<e.length;o++){let r=e[o],s=t.marks[r],i=s;if(s)n.push(s);else for(let a in t.marks){let l=t.marks[a];(r=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(r)>-1)&&n.push(i=l)}if(!i)throw new SyntaxError("Unknown mark type: '"+e[o]+"'")}return n}function cS(t){return t.tag!=null}function dS(t){return t.style!=null}class Jn{constructor(e,n){this.schema=e,this.rules=n,this.tags=[],this.styles=[];let o=this.matchedStyles=[];n.forEach(r=>{if(cS(r))this.tags.push(r);else if(dS(r)){let s=/[^=]*/.exec(r.style)[0];o.indexOf(s)<0&&o.push(s),this.styles.push(r)}}),this.normalizeLists=!this.tags.some(r=>{if(!/^(ul|ol)\b/.test(r.tag)||!r.node)return!1;let s=e.nodes[r.node];return s.contentMatch.matchType(s)})}parse(e,n={}){let o=new Vu(this,n,!1);return o.addAll(e,Se.none,n.from,n.to),o.finish()}parseSlice(e,n={}){let o=new Vu(this,n,!0);return o.addAll(e,Se.none,n.from,n.to),R.maxOpen(o.finish())}matchTag(e,n,o){for(let r=o?this.tags.indexOf(o)+1:0;r<this.tags.length;r++){let s=this.tags[r];if(fS(e,s.tag)&&(s.namespace===void 0||e.namespaceURI==s.namespace)&&(!s.context||n.matchesContext(s.context))){if(s.getAttrs){let i=s.getAttrs(e);if(i===!1)continue;s.attrs=i||void 0}return s}}}matchStyle(e,n,o,r){for(let s=r?this.styles.indexOf(r)+1:0;s<this.styles.length;s++){let i=this.styles[s],a=i.style;if(!(a.indexOf(e)!=0||i.context&&!o.matchesContext(i.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=n))){if(i.getAttrs){let l=i.getAttrs(n);if(l===!1)continue;i.attrs=l||void 0}return i}}}static schemaRules(e){let n=[];function o(r){let s=r.priority==null?50:r.priority,i=0;for(;i<n.length;i++){let a=n[i];if((a.priority==null?50:a.priority)<s)break}n.splice(i,0,r)}for(let r in e.marks){let s=e.marks[r].spec.parseDOM;s&&s.forEach(i=>{o(i=qu(i)),i.mark||i.ignore||i.clearMark||(i.mark=r)})}for(let r in e.nodes){let s=e.nodes[r].spec.parseDOM;s&&s.forEach(i=>{o(i=qu(i)),i.node||i.ignore||i.mark||(i.node=r)})}return n}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new Jn(e,Jn.schemaRules(e)))}}const th={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},uS={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},nh={ol:!0,ul:!0},cs=1,ic=2,zr=4;function Uu(t,e,n){return e!=null?(e?cs:0)|(e==="full"?ic:0):t&&t.whitespace=="pre"?cs|ic:n&~zr}class Bs{constructor(e,n,o,r,s,i){this.type=e,this.attrs=n,this.marks=o,this.solid=r,this.options=i,this.content=[],this.activeMarks=Se.none,this.match=s||(i&zr?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let n=this.type.contentMatch.fillBefore(M.from(e));if(n)this.match=this.type.contentMatch.matchFragment(n);else{let o=this.type.contentMatch,r;return(r=o.findWrapping(e.type))?(this.match=o,r):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&cs)){let o=this.content[this.content.length-1],r;if(o&&o.isText&&(r=/[ \t\r\n\u000c]+$/.exec(o.text))){let s=o;o.text.length==r[0].length?this.content.pop():this.content[this.content.length-1]=s.withText(s.text.slice(0,s.text.length-r[0].length))}}let n=M.from(this.content);return!e&&this.match&&(n=n.append(this.match.fillBefore(M.empty,!0))),this.type?this.type.create(this.attrs,n,this.marks):n}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!th.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class Vu{constructor(e,n,o){this.parser=e,this.options=n,this.isOpen=o,this.open=0,this.localPreserveWS=!1;let r=n.topNode,s,i=Uu(null,n.preserveWhitespace,0)|(o?zr:0);r?s=new Bs(r.type,r.attrs,Se.none,!0,n.topMatch||r.type.contentMatch,i):o?s=new Bs(null,null,Se.none,!0,null,i):s=new Bs(e.schema.topNodeType,null,Se.none,!0,null,i),this.nodes=[s],this.find=n.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e,n){e.nodeType==3?this.addTextNode(e,n):e.nodeType==1&&this.addElement(e,n)}addTextNode(e,n){let o=e.nodeValue,r=this.top,s=r.options&ic?"full":this.localPreserveWS||(r.options&cs)>0;if(s==="full"||r.inlineContext(e)||/[^ \t\r\n\u000c]/.test(o)){if(s)s!=="full"?o=o.replace(/\r?\n|\r/g," "):o=o.replace(/\r\n?/g,`
`);else if(o=o.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(o)&&this.open==this.nodes.length-1){let i=r.content[r.content.length-1],a=e.previousSibling;(!i||a&&a.nodeName=="BR"||i.isText&&/[ \t\r\n\u000c]$/.test(i.text))&&(o=o.slice(1))}o&&this.insertNode(this.parser.schema.text(o),n,!/\S/.test(o)),this.findInText(e)}else this.findInside(e)}addElement(e,n,o){let r=this.localPreserveWS,s=this.top;(e.tagName=="PRE"||/pre/.test(e.style&&e.style.whiteSpace))&&(this.localPreserveWS=!0);let i=e.nodeName.toLowerCase(),a;nh.hasOwnProperty(i)&&this.parser.normalizeLists&&pS(e);let l=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(a=this.parser.matchTag(e,this,o));e:if(l?l.ignore:uS.hasOwnProperty(i))this.findInside(e),this.ignoreFallback(e,n);else if(!l||l.skip||l.closeParent){l&&l.closeParent?this.open=Math.max(0,this.open-1):l&&l.skip.nodeType&&(e=l.skip);let c,d=this.needsBlock;if(th.hasOwnProperty(i))s.content.length&&s.content[0].isInline&&this.open&&(this.open--,s=this.top),c=!0,s.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e,n);break e}let u=l&&l.skip?n:this.readStyles(e,n);u&&this.addAll(e,u),c&&this.sync(s),this.needsBlock=d}else{let c=this.readStyles(e,n);c&&this.addElementByRule(e,l,c,l.consuming===!1?a:void 0)}this.localPreserveWS=r}leafFallback(e,n){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`),n)}ignoreFallback(e,n){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"),n,!0)}readStyles(e,n){let o=e.style;if(o&&o.length)for(let r=0;r<this.parser.matchedStyles.length;r++){let s=this.parser.matchedStyles[r],i=o.getPropertyValue(s);if(i)for(let a=void 0;;){let l=this.parser.matchStyle(s,i,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?n=n.filter(c=>!l.clearMark(c)):n=n.concat(this.parser.schema.marks[l.mark].create(l.attrs)),l.consuming===!1)a=l;else break}}return n}addElementByRule(e,n,o,r){let s,i;if(n.node)if(i=this.parser.schema.nodes[n.node],i.isLeaf)this.insertNode(i.create(n.attrs),o,e.nodeName=="BR")||this.leafFallback(e,o);else{let l=this.enter(i,n.attrs||null,o,n.preserveWhitespace);l&&(s=!0,o=l)}else{let l=this.parser.schema.marks[n.mark];o=o.concat(l.create(n.attrs))}let a=this.top;if(i&&i.isLeaf)this.findInside(e);else if(r)this.addElement(e,o,r);else if(n.getContent)this.findInside(e),n.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l,o,!1));else{let l=e;typeof n.contentElement=="string"?l=e.querySelector(n.contentElement):typeof n.contentElement=="function"?l=n.contentElement(e):n.contentElement&&(l=n.contentElement),this.findAround(e,l,!0),this.addAll(l,o),this.findAround(e,l,!1)}s&&this.sync(a)&&this.open--}addAll(e,n,o,r){let s=o||0;for(let i=o?e.childNodes[o]:e.firstChild,a=r==null?null:e.childNodes[r];i!=a;i=i.nextSibling,++s)this.findAtPoint(e,s),this.addDOM(i,n);this.findAtPoint(e,s)}findPlace(e,n,o){let r,s;for(let i=this.open,a=0;i>=0;i--){let l=this.nodes[i],c=l.findWrapping(e);if(c&&(!r||r.length>c.length+a)&&(r=c,s=l,!c.length))break;if(l.solid){if(o)break;a+=2}}if(!r)return null;this.sync(s);for(let i=0;i<r.length;i++)n=this.enterInner(r[i],null,n,!1);return n}insertNode(e,n,o){if(e.isInline&&this.needsBlock&&!this.top.type){let s=this.textblockFromContext();s&&(n=this.enterInner(s,null,n))}let r=this.findPlace(e,n,o);if(r){this.closeExtra();let s=this.top;s.match&&(s.match=s.match.matchType(e.type));let i=Se.none;for(let a of r.concat(e.marks))(s.type?s.type.allowsMarkType(a.type):Ku(a.type,e.type))&&(i=a.addToSet(i));return s.content.push(e.mark(i)),!0}return!1}enter(e,n,o,r){let s=this.findPlace(e.create(n),o,!1);return s&&(s=this.enterInner(e,n,o,!0,r)),s}enterInner(e,n,o,r=!1,s){this.closeExtra();let i=this.top;i.match=i.match&&i.match.matchType(e);let a=Uu(e,s,i.options);i.options&zr&&i.content.length==0&&(a|=zr);let l=Se.none;return o=o.filter(c=>(i.type?i.type.allowsMarkType(c.type):Ku(c.type,e))?(l=c.addToSet(l),!1):!0),this.nodes.push(new Bs(e,n,l,r,null,a)),this.open++,o}closeExtra(e=!1){let n=this.nodes.length-1;if(n>this.open){for(;n>this.open;n--)this.nodes[n-1].content.push(this.nodes[n].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(!!(this.isOpen||this.options.topOpen))}sync(e){for(let n=this.open;n>=0;n--){if(this.nodes[n]==e)return this.open=n,!0;this.localPreserveWS&&(this.nodes[n].options|=cs)}return!1}get currentPos(){this.closeExtra();let e=0;for(let n=this.open;n>=0;n--){let o=this.nodes[n].content;for(let r=o.length-1;r>=0;r--)e+=o[r].nodeSize;n&&e++}return e}findAtPoint(e,n){if(this.find)for(let o=0;o<this.find.length;o++)this.find[o].node==e&&this.find[o].offset==n&&(this.find[o].pos=this.currentPos)}findInside(e){if(this.find)for(let n=0;n<this.find.length;n++)this.find[n].pos==null&&e.nodeType==1&&e.contains(this.find[n].node)&&(this.find[n].pos=this.currentPos)}findAround(e,n,o){if(e!=n&&this.find)for(let r=0;r<this.find.length;r++)this.find[r].pos==null&&e.nodeType==1&&e.contains(this.find[r].node)&&n.compareDocumentPosition(this.find[r].node)&(o?2:4)&&(this.find[r].pos=this.currentPos)}findInText(e){if(this.find)for(let n=0;n<this.find.length;n++)this.find[n].node==e&&(this.find[n].pos=this.currentPos-(e.nodeValue.length-this.find[n].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let n=e.split("/"),o=this.options.context,r=!this.isOpen&&(!o||o.parent.type==this.nodes[0].type),s=-(o?o.depth+1:0)+(r?0:1),i=(a,l)=>{for(;a>=0;a--){let c=n[a];if(c==""){if(a==n.length-1||a==0)continue;for(;l>=s;l--)if(i(a-1,l))return!0;return!1}else{let d=l>0||l==0&&r?this.nodes[l].type:o&&l>=s?o.node(l-s).type:null;if(!d||d.name!=c&&!d.isInGroup(c))return!1;l--}}return!0};return i(n.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let n=e.depth;n>=0;n--){let o=e.node(n).contentMatchAt(e.indexAfter(n)).defaultType;if(o&&o.isTextblock&&o.defaultAttrs)return o}for(let n in this.parser.schema.nodes){let o=this.parser.schema.nodes[n];if(o.isTextblock&&o.defaultAttrs)return o}}}function pS(t){for(let e=t.firstChild,n=null;e;e=e.nextSibling){let o=e.nodeType==1?e.nodeName.toLowerCase():null;o&&nh.hasOwnProperty(o)&&n?(n.appendChild(e),e=n):o=="li"?n=e:o&&(n=null)}}function fS(t,e){return(t.matches||t.msMatchesSelector||t.webkitMatchesSelector||t.mozMatchesSelector).call(t,e)}function qu(t){let e={};for(let n in t)e[n]=t[n];return e}function Ku(t,e){let n=e.schema.nodes;for(let o in n){let r=n[o];if(!r.allowsMarkType(t))continue;let s=[],i=a=>{s.push(a);for(let l=0;l<a.edgeCount;l++){let{type:c,next:d}=a.edge(l);if(c==e||s.indexOf(d)<0&&i(d))return!0}};if(i(r.contentMatch))return!0}}class $o{constructor(e,n){this.nodes=e,this.marks=n}serializeFragment(e,n={},o){o||(o=el(n).createDocumentFragment());let r=o,s=[];return e.forEach(i=>{if(s.length||i.marks.length){let a=0,l=0;for(;a<s.length&&l<i.marks.length;){let c=i.marks[l];if(!this.marks[c.type.name]){l++;continue}if(!c.eq(s[a][0])||c.type.spec.spanning===!1)break;a++,l++}for(;a<s.length;)r=s.pop()[1];for(;l<i.marks.length;){let c=i.marks[l++],d=this.serializeMark(c,i.isInline,n);d&&(s.push([c,r]),r.appendChild(d.dom),r=d.contentDOM||d.dom)}}r.appendChild(this.serializeNodeInner(i,n))}),o}serializeNodeInner(e,n){let{dom:o,contentDOM:r}=Zs(el(n),this.nodes[e.type.name](e),null,e.attrs);if(r){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,n,r)}return o}serializeNode(e,n={}){let o=this.serializeNodeInner(e,n);for(let r=e.marks.length-1;r>=0;r--){let s=this.serializeMark(e.marks[r],e.isInline,n);s&&((s.contentDOM||s.dom).appendChild(o),o=s.dom)}return o}serializeMark(e,n,o={}){let r=this.marks[e.type.name];return r&&Zs(el(o),r(e,n),null,e.attrs)}static renderSpec(e,n,o=null,r){return Zs(e,n,o,r)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new $o(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let n=Gu(e.nodes);return n.text||(n.text=o=>o.text),n}static marksFromSchema(e){return Gu(e.marks)}}function Gu(t){let e={};for(let n in t){let o=t[n].spec.toDOM;o&&(e[n]=o)}return e}function el(t){return t.document||window.document}const Ju=new WeakMap;function mS(t){let e=Ju.get(t);return e===void 0&&Ju.set(t,e=hS(t)),e}function hS(t){let e=null;function n(o){if(o&&typeof o=="object")if(Array.isArray(o))if(typeof o[0]=="string")e||(e=[]),e.push(o);else for(let r=0;r<o.length;r++)n(o[r]);else for(let r in o)n(o[r])}return n(t),e}function Zs(t,e,n,o){if(typeof e=="string")return{dom:t.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let r=e[0],s;if(typeof r!="string")throw new RangeError("Invalid array passed to renderSpec");if(o&&(s=mS(o))&&s.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let i=r.indexOf(" ");i>0&&(n=r.slice(0,i),r=r.slice(i+1));let a,l=n?t.createElementNS(n,r):t.createElement(r),c=e[1],d=1;if(c&&typeof c=="object"&&c.nodeType==null&&!Array.isArray(c)){d=2;for(let u in c)if(c[u]!=null){let f=u.indexOf(" ");f>0?l.setAttributeNS(u.slice(0,f),u.slice(f+1),c[u]):u=="style"&&l.style?l.style.cssText=c[u]:l.setAttribute(u,c[u])}}for(let u=d;u<e.length;u++){let f=e[u];if(f===0){if(u<e.length-1||u>d)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:p,contentDOM:m}=Zs(t,f,n,o);if(l.appendChild(p),m){if(a)throw new RangeError("Multiple content holes");a=m}}}return{dom:l,contentDOM:a}}const oh=65535,rh=Math.pow(2,16);function gS(t,e){return t+e*rh}function Yu(t){return t&oh}function bS(t){return(t-(t&oh))/rh}const sh=1,ih=2,ei=4,ah=8;class ac{constructor(e,n,o){this.pos=e,this.delInfo=n,this.recover=o}get deleted(){return(this.delInfo&ah)>0}get deletedBefore(){return(this.delInfo&(sh|ei))>0}get deletedAfter(){return(this.delInfo&(ih|ei))>0}get deletedAcross(){return(this.delInfo&ei)>0}}class yt{constructor(e,n=!1){if(this.ranges=e,this.inverted=n,!e.length&&yt.empty)return yt.empty}recover(e){let n=0,o=Yu(e);if(!this.inverted)for(let r=0;r<o;r++)n+=this.ranges[r*3+2]-this.ranges[r*3+1];return this.ranges[o*3]+n+bS(e)}mapResult(e,n=1){return this._map(e,n,!1)}map(e,n=1){return this._map(e,n,!0)}_map(e,n,o){let r=0,s=this.inverted?2:1,i=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?r:0);if(l>e)break;let c=this.ranges[a+s],d=this.ranges[a+i],u=l+c;if(e<=u){let f=c?e==l?-1:e==u?1:n:n,p=l+r+(f<0?0:d);if(o)return p;let m=e==(n<0?l:u)?null:gS(a/3,e-l),b=e==l?ih:e==u?sh:ei;return(n<0?e!=l:e!=u)&&(b|=ah),new ac(p,b,m)}r+=d-c}return o?e+r:new ac(e+r,0,null)}touches(e,n){let o=0,r=Yu(n),s=this.inverted?2:1,i=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?o:0);if(l>e)break;let c=this.ranges[a+s],d=l+c;if(e<=d&&a==r*3)return!0;o+=this.ranges[a+i]-c}return!1}forEach(e){let n=this.inverted?2:1,o=this.inverted?1:2;for(let r=0,s=0;r<this.ranges.length;r+=3){let i=this.ranges[r],a=i-(this.inverted?s:0),l=i+(this.inverted?0:s),c=this.ranges[r+n],d=this.ranges[r+o];e(a,a+c,l,l+d),s+=d-c}}invert(){return new yt(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?yt.empty:new yt(e<0?[0,-e,0]:[0,0,e])}}yt.empty=new yt([]);class ds{constructor(e,n,o=0,r=e?e.length:0){this.mirror=n,this.from=o,this.to=r,this._maps=e||[],this.ownData=!(e||n)}get maps(){return this._maps}slice(e=0,n=this.maps.length){return new ds(this._maps,this.mirror,e,n)}appendMap(e,n){this.ownData||(this._maps=this._maps.slice(),this.mirror=this.mirror&&this.mirror.slice(),this.ownData=!0),this.to=this._maps.push(e),n!=null&&this.setMirror(this._maps.length-1,n)}appendMapping(e){for(let n=0,o=this._maps.length;n<e._maps.length;n++){let r=e.getMirror(n);this.appendMap(e._maps[n],r!=null&&r<n?o+r:void 0)}}getMirror(e){if(this.mirror){for(let n=0;n<this.mirror.length;n++)if(this.mirror[n]==e)return this.mirror[n+(n%2?-1:1)]}}setMirror(e,n){this.mirror||(this.mirror=[]),this.mirror.push(e,n)}appendMappingInverted(e){for(let n=e.maps.length-1,o=this._maps.length+e._maps.length;n>=0;n--){let r=e.getMirror(n);this.appendMap(e._maps[n].invert(),r!=null&&r>n?o-r-1:void 0)}}invert(){let e=new ds;return e.appendMappingInverted(this),e}map(e,n=1){if(this.mirror)return this._map(e,n,!0);for(let o=this.from;o<this.to;o++)e=this._maps[o].map(e,n);return e}mapResult(e,n=1){return this._map(e,n,!1)}_map(e,n,o){let r=0;for(let s=this.from;s<this.to;s++){let i=this._maps[s],a=i.mapResult(e,n);if(a.recover!=null){let l=this.getMirror(s);if(l!=null&&l>s&&l<this.to){s=l,e=this._maps[l].recover(a.recover);continue}}r|=a.delInfo,e=a.pos}return o?e:new ac(e,r,null)}}const tl=Object.create(null);class Ze{getMap(){return yt.empty}merge(e){return null}static fromJSON(e,n){if(!n||!n.stepType)throw new RangeError("Invalid input for Step.fromJSON");let o=tl[n.stepType];if(!o)throw new RangeError(`No step type ${n.stepType} defined`);return o.fromJSON(e,n)}static jsonID(e,n){if(e in tl)throw new RangeError("Duplicate use of step JSON ID "+e);return tl[e]=n,n.prototype.jsonID=e,n}}class _e{constructor(e,n){this.doc=e,this.failed=n}static ok(e){return new _e(e,null)}static fail(e){return new _e(null,e)}static fromReplace(e,n,o,r){try{return _e.ok(e.replace(n,o,r))}catch(s){if(s instanceof wi)return _e.fail(s.message);throw s}}}function yd(t,e,n){let o=[];for(let r=0;r<t.childCount;r++){let s=t.child(r);s.content.size&&(s=s.copy(yd(s.content,e,s))),s.isInline&&(s=e(s,n,r)),o.push(s)}return M.fromArray(o)}class zn extends Ze{constructor(e,n,o){super(),this.from=e,this.to=n,this.mark=o}apply(e){let n=e.slice(this.from,this.to),o=e.resolve(this.from),r=o.node(o.sharedDepth(this.to)),s=new R(yd(n.content,(i,a)=>!i.isAtom||!a.type.allowsMarkType(this.mark.type)?i:i.mark(this.mark.addToSet(i.marks)),r),n.openStart,n.openEnd);return _e.fromReplace(e,this.from,this.to,s)}invert(){return new jt(this.from,this.to,this.mark)}map(e){let n=e.mapResult(this.from,1),o=e.mapResult(this.to,-1);return n.deleted&&o.deleted||n.pos>=o.pos?null:new zn(n.pos,o.pos,this.mark)}merge(e){return e instanceof zn&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new zn(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,n){if(typeof n.from!="number"||typeof n.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new zn(n.from,n.to,e.markFromJSON(n.mark))}}Ze.jsonID("addMark",zn);class jt extends Ze{constructor(e,n,o){super(),this.from=e,this.to=n,this.mark=o}apply(e){let n=e.slice(this.from,this.to),o=new R(yd(n.content,r=>r.mark(this.mark.removeFromSet(r.marks)),e),n.openStart,n.openEnd);return _e.fromReplace(e,this.from,this.to,o)}invert(){return new zn(this.from,this.to,this.mark)}map(e){let n=e.mapResult(this.from,1),o=e.mapResult(this.to,-1);return n.deleted&&o.deleted||n.pos>=o.pos?null:new jt(n.pos,o.pos,this.mark)}merge(e){return e instanceof jt&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new jt(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,n){if(typeof n.from!="number"||typeof n.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new jt(n.from,n.to,e.markFromJSON(n.mark))}}Ze.jsonID("removeMark",jt);class Hn extends Ze{constructor(e,n){super(),this.pos=e,this.mark=n}apply(e){let n=e.nodeAt(this.pos);if(!n)return _e.fail("No node at mark step's position");let o=n.type.create(n.attrs,null,this.mark.addToSet(n.marks));return _e.fromReplace(e,this.pos,this.pos+1,new R(M.from(o),0,n.isLeaf?0:1))}invert(e){let n=e.nodeAt(this.pos);if(n){let o=this.mark.addToSet(n.marks);if(o.length==n.marks.length){for(let r=0;r<n.marks.length;r++)if(!n.marks[r].isInSet(o))return new Hn(this.pos,n.marks[r]);return new Hn(this.pos,this.mark)}}return new Bo(this.pos,this.mark)}map(e){let n=e.mapResult(this.pos,1);return n.deletedAfter?null:new Hn(n.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,n){if(typeof n.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new Hn(n.pos,e.markFromJSON(n.mark))}}Ze.jsonID("addNodeMark",Hn);class Bo extends Ze{constructor(e,n){super(),this.pos=e,this.mark=n}apply(e){let n=e.nodeAt(this.pos);if(!n)return _e.fail("No node at mark step's position");let o=n.type.create(n.attrs,null,this.mark.removeFromSet(n.marks));return _e.fromReplace(e,this.pos,this.pos+1,new R(M.from(o),0,n.isLeaf?0:1))}invert(e){let n=e.nodeAt(this.pos);return!n||!this.mark.isInSet(n.marks)?this:new Hn(this.pos,this.mark)}map(e){let n=e.mapResult(this.pos,1);return n.deletedAfter?null:new Bo(n.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,n){if(typeof n.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new Bo(n.pos,e.markFromJSON(n.mark))}}Ze.jsonID("removeNodeMark",Bo);class We extends Ze{constructor(e,n,o,r=!1){super(),this.from=e,this.to=n,this.slice=o,this.structure=r}apply(e){return this.structure&&lc(e,this.from,this.to)?_e.fail("Structure replace would overwrite content"):_e.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new yt([this.from,this.to-this.from,this.slice.size])}invert(e){return new We(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let n=e.mapResult(this.from,1),o=e.mapResult(this.to,-1);return n.deletedAcross&&o.deletedAcross?null:new We(n.pos,Math.max(n.pos,o.pos),this.slice,this.structure)}merge(e){if(!(e instanceof We)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let n=this.slice.size+e.slice.size==0?R.empty:new R(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new We(this.from,this.to+(e.to-e.from),n,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let n=this.slice.size+e.slice.size==0?R.empty:new R(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new We(e.from,this.to,n,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,n){if(typeof n.from!="number"||typeof n.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new We(n.from,n.to,R.fromJSON(e,n.slice),!!n.structure)}}Ze.jsonID("replace",We);class He extends Ze{constructor(e,n,o,r,s,i,a=!1){super(),this.from=e,this.to=n,this.gapFrom=o,this.gapTo=r,this.slice=s,this.insert=i,this.structure=a}apply(e){if(this.structure&&(lc(e,this.from,this.gapFrom)||lc(e,this.gapTo,this.to)))return _e.fail("Structure gap-replace would overwrite content");let n=e.slice(this.gapFrom,this.gapTo);if(n.openStart||n.openEnd)return _e.fail("Gap is not a flat range");let o=this.slice.insertAt(this.insert,n.content);return o?_e.fromReplace(e,this.from,this.to,o):_e.fail("Content does not fit in gap")}getMap(){return new yt([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let n=this.gapTo-this.gapFrom;return new He(this.from,this.from+this.slice.size+n,this.from+this.insert,this.from+this.insert+n,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let n=e.mapResult(this.from,1),o=e.mapResult(this.to,-1),r=this.from==this.gapFrom?n.pos:e.map(this.gapFrom,-1),s=this.to==this.gapTo?o.pos:e.map(this.gapTo,1);return n.deletedAcross&&o.deletedAcross||r<n.pos||s>o.pos?null:new He(n.pos,o.pos,r,s,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,n){if(typeof n.from!="number"||typeof n.to!="number"||typeof n.gapFrom!="number"||typeof n.gapTo!="number"||typeof n.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new He(n.from,n.to,n.gapFrom,n.gapTo,R.fromJSON(e,n.slice),n.insert,!!n.structure)}}Ze.jsonID("replaceAround",He);function lc(t,e,n){let o=t.resolve(e),r=n-e,s=o.depth;for(;r>0&&s>0&&o.indexAfter(s)==o.node(s).childCount;)s--,r--;if(r>0){let i=o.node(s).maybeChild(o.indexAfter(s));for(;r>0;){if(!i||i.isLeaf)return!0;i=i.firstChild,r--}}return!1}function yS(t,e,n,o){let r=[],s=[],i,a;t.doc.nodesBetween(e,n,(l,c,d)=>{if(!l.isInline)return;let u=l.marks;if(!o.isInSet(u)&&d.type.allowsMarkType(o.type)){let f=Math.max(c,e),p=Math.min(c+l.nodeSize,n),m=o.addToSet(u);for(let b=0;b<u.length;b++)u[b].isInSet(m)||(i&&i.to==f&&i.mark.eq(u[b])?i.to=p:r.push(i=new jt(f,p,u[b])));a&&a.to==f?a.to=p:s.push(a=new zn(f,p,o))}}),r.forEach(l=>t.step(l)),s.forEach(l=>t.step(l))}function wS(t,e,n,o){let r=[],s=0;t.doc.nodesBetween(e,n,(i,a)=>{if(!i.isInline)return;s++;let l=null;if(o instanceof Ia){let c=i.marks,d;for(;d=o.isInSet(c);)(l||(l=[])).push(d),c=d.removeFromSet(c)}else o?o.isInSet(i.marks)&&(l=[o]):l=i.marks;if(l&&l.length){let c=Math.min(a+i.nodeSize,n);for(let d=0;d<l.length;d++){let u=l[d],f;for(let p=0;p<r.length;p++){let m=r[p];m.step==s-1&&u.eq(r[p].style)&&(f=m)}f?(f.to=c,f.step=s):r.push({style:u,from:Math.max(a,e),to:c,step:s})}}}),r.forEach(i=>t.step(new jt(i.from,i.to,i.style)))}function wd(t,e,n,o=n.contentMatch,r=!0){let s=t.doc.nodeAt(e),i=[],a=e+1;for(let l=0;l<s.childCount;l++){let c=s.child(l),d=a+c.nodeSize,u=o.matchType(c.type);if(!u)i.push(new We(a,d,R.empty));else{o=u;for(let f=0;f<c.marks.length;f++)n.allowsMarkType(c.marks[f].type)||t.step(new jt(a,d,c.marks[f]));if(r&&c.isText&&n.whitespace!="pre"){let f,p=/\r?\n|\r/g,m;for(;f=p.exec(c.text);)m||(m=new R(M.from(n.schema.text(" ",n.allowedMarks(c.marks))),0,0)),i.push(new We(a+f.index,a+f.index+f[0].length,m))}}a=d}if(!o.validEnd){let l=o.fillBefore(M.empty,!0);t.replace(a,a,new R(l,0,0))}for(let l=i.length-1;l>=0;l--)t.step(i[l])}function vS(t,e,n){return(e==0||t.canReplace(e,t.childCount))&&(n==t.childCount||t.canReplace(0,n))}function wr(t){let n=t.parent.content.cutByIndex(t.startIndex,t.endIndex);for(let o=t.depth;;--o){let r=t.$from.node(o),s=t.$from.index(o),i=t.$to.indexAfter(o);if(o<t.depth&&r.canReplace(s,i,n))return o;if(o==0||r.type.spec.isolating||!vS(r,s,i))break}return null}function SS(t,e,n){let{$from:o,$to:r,depth:s}=e,i=o.before(s+1),a=r.after(s+1),l=i,c=a,d=M.empty,u=0;for(let m=s,b=!1;m>n;m--)b||o.index(m)>0?(b=!0,d=M.from(o.node(m).copy(d)),u++):l--;let f=M.empty,p=0;for(let m=s,b=!1;m>n;m--)b||r.after(m+1)<r.end(m)?(b=!0,f=M.from(r.node(m).copy(f)),p++):c++;t.step(new He(l,c,i,a,new R(d.append(f),u,p),d.size-u,!0))}function vd(t,e,n=null,o=t){let r=kS(t,e),s=r&&xS(o,e);return s?r.map(Xu).concat({type:e,attrs:n}).concat(s.map(Xu)):null}function Xu(t){return{type:t,attrs:null}}function kS(t,e){let{parent:n,startIndex:o,endIndex:r}=t,s=n.contentMatchAt(o).findWrapping(e);if(!s)return null;let i=s.length?s[0]:e;return n.canReplaceWith(o,r,i)?s:null}function xS(t,e){let{parent:n,startIndex:o,endIndex:r}=t,s=n.child(o),i=e.contentMatch.findWrapping(s.type);if(!i)return null;let l=(i.length?i[i.length-1]:e).contentMatch;for(let c=o;l&&c<r;c++)l=l.matchType(n.child(c).type);return!l||!l.validEnd?null:i}function CS(t,e,n){let o=M.empty;for(let i=n.length-1;i>=0;i--){if(o.size){let a=n[i].type.contentMatch.matchFragment(o);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}o=M.from(n[i].type.create(n[i].attrs,o))}let r=e.start,s=e.end;t.step(new He(r,s,r,s,new R(o,0,0),n.length,!0))}function ES(t,e,n,o,r){if(!o.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let s=t.steps.length;t.doc.nodesBetween(e,n,(i,a)=>{let l=typeof r=="function"?r(i):r;if(i.isTextblock&&!i.hasMarkup(o,l)&&IS(t.doc,t.mapping.slice(s).map(a),o)){let c=null;if(o.schema.linebreakReplacement){let p=o.whitespace=="pre",m=!!o.contentMatch.matchType(o.schema.linebreakReplacement);p&&!m?c=!1:!p&&m&&(c=!0)}c===!1&&ch(t,i,a,s),wd(t,t.mapping.slice(s).map(a,1),o,void 0,c===null);let d=t.mapping.slice(s),u=d.map(a,1),f=d.map(a+i.nodeSize,1);return t.step(new He(u,f,u+1,f-1,new R(M.from(o.create(l,null,i.marks)),0,0),1,!0)),c===!0&&lh(t,i,a,s),!1}})}function lh(t,e,n,o){e.forEach((r,s)=>{if(r.isText){let i,a=/\r?\n|\r/g;for(;i=a.exec(r.text);){let l=t.mapping.slice(o).map(n+1+s+i.index);t.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function ch(t,e,n,o){e.forEach((r,s)=>{if(r.type==r.type.schema.linebreakReplacement){let i=t.mapping.slice(o).map(n+1+s);t.replaceWith(i,i+1,e.type.schema.text(`
`))}})}function IS(t,e,n){let o=t.resolve(e),r=o.index();return o.parent.canReplaceWith(r,r+1,n)}function AS(t,e,n,o,r){let s=t.doc.nodeAt(e);if(!s)throw new RangeError("No node at given position");n||(n=s.type);let i=n.create(o,null,r||s.marks);if(s.isLeaf)return t.replaceWith(e,e+s.nodeSize,i);if(!n.validContent(s.content))throw new RangeError("Invalid content for node type "+n.name);t.step(new He(e,e+s.nodeSize,e+1,e+s.nodeSize-1,new R(M.from(i),0,0),1,!0))}function kn(t,e,n=1,o){let r=t.resolve(e),s=r.depth-n,i=o&&o[o.length-1]||r.parent;if(s<0||r.parent.type.spec.isolating||!r.parent.canReplace(r.index(),r.parent.childCount)||!i.type.validContent(r.parent.content.cutByIndex(r.index(),r.parent.childCount)))return!1;for(let c=r.depth-1,d=n-2;c>s;c--,d--){let u=r.node(c),f=r.index(c);if(u.type.spec.isolating)return!1;let p=u.content.cutByIndex(f,u.childCount),m=o&&o[d+1];m&&(p=p.replaceChild(0,m.type.create(m.attrs)));let b=o&&o[d]||u;if(!u.canReplace(f+1,u.childCount)||!b.type.validContent(p))return!1}let a=r.indexAfter(s),l=o&&o[0];return r.node(s).canReplaceWith(a,a,l?l.type:r.node(s+1).type)}function NS(t,e,n=1,o){let r=t.doc.resolve(e),s=M.empty,i=M.empty;for(let a=r.depth,l=r.depth-n,c=n-1;a>l;a--,c--){s=M.from(r.node(a).copy(s));let d=o&&o[c];i=M.from(d?d.type.create(d.attrs,i):r.node(a).copy(i))}t.step(new We(e,e,new R(s.append(i),n,n),!0))}function lo(t,e){let n=t.resolve(e),o=n.index();return dh(n.nodeBefore,n.nodeAfter)&&n.parent.canReplace(o,o+1)}function MS(t,e){e.content.size||t.type.compatibleContent(e.type);let n=t.contentMatchAt(t.childCount),{linebreakReplacement:o}=t.type.schema;for(let r=0;r<e.childCount;r++){let s=e.child(r),i=s.type==o?t.type.schema.nodes.text:s.type;if(n=n.matchType(i),!n||!t.type.allowsMarks(s.marks))return!1}return n.validEnd}function dh(t,e){return!!(t&&e&&!t.isLeaf&&MS(t,e))}function Aa(t,e,n=-1){let o=t.resolve(e);for(let r=o.depth;;r--){let s,i,a=o.index(r);if(r==o.depth?(s=o.nodeBefore,i=o.nodeAfter):n>0?(s=o.node(r+1),a++,i=o.node(r).maybeChild(a)):(s=o.node(r).maybeChild(a-1),i=o.node(r+1)),s&&!s.isTextblock&&dh(s,i)&&o.node(r).canReplace(a,a+1))return e;if(r==0)break;e=n<0?o.before(r):o.after(r)}}function TS(t,e,n){let o=null,{linebreakReplacement:r}=t.doc.type.schema,s=t.doc.resolve(e-n),i=s.node().type;if(r&&i.inlineContent){let d=i.whitespace=="pre",u=!!i.contentMatch.matchType(r);d&&!u?o=!1:!d&&u&&(o=!0)}let a=t.steps.length;if(o===!1){let d=t.doc.resolve(e+n);ch(t,d.node(),d.before(),a)}i.inlineContent&&wd(t,e+n-1,i,s.node().contentMatchAt(s.index()),o==null);let l=t.mapping.slice(a),c=l.map(e-n);if(t.step(new We(c,l.map(e+n,-1),R.empty,!0)),o===!0){let d=t.doc.resolve(c);lh(t,d.node(),d.before(),t.steps.length)}return t}function PS(t,e,n){let o=t.resolve(e);if(o.parent.canReplaceWith(o.index(),o.index(),n))return e;if(o.parentOffset==0)for(let r=o.depth-1;r>=0;r--){let s=o.index(r);if(o.node(r).canReplaceWith(s,s,n))return o.before(r+1);if(s>0)return null}if(o.parentOffset==o.parent.content.size)for(let r=o.depth-1;r>=0;r--){let s=o.indexAfter(r);if(o.node(r).canReplaceWith(s,s,n))return o.after(r+1);if(s<o.node(r).childCount)return null}return null}function uh(t,e,n){let o=t.resolve(e);if(!n.content.size)return e;let r=n.content;for(let s=0;s<n.openStart;s++)r=r.firstChild.content;for(let s=1;s<=(n.openStart==0&&n.size?2:1);s++)for(let i=o.depth;i>=0;i--){let a=i==o.depth?0:o.pos<=(o.start(i+1)+o.end(i+1))/2?-1:1,l=o.index(i)+(a>0?1:0),c=o.node(i),d=!1;if(s==1)d=c.canReplace(l,l,r);else{let u=c.contentMatchAt(l).findWrapping(r.firstChild.type);d=u&&c.canReplaceWith(l,l,u[0])}if(d)return a==0?o.pos:a<0?o.before(i+1):o.after(i+1)}return null}function Na(t,e,n=e,o=R.empty){if(e==n&&!o.size)return null;let r=t.resolve(e),s=t.resolve(n);return ph(r,s,o)?new We(e,n,o):new BS(r,s,o).fit()}function ph(t,e,n){return!n.openStart&&!n.openEnd&&t.start()==e.start()&&t.parent.canReplace(t.index(),e.index(),n.content)}class BS{constructor(e,n,o){this.$from=e,this.$to=n,this.unplaced=o,this.frontier=[],this.placed=M.empty;for(let r=0;r<=e.depth;r++){let s=e.node(r);this.frontier.push({type:s.type,match:s.contentMatchAt(e.indexAfter(r))})}for(let r=e.depth;r>0;r--)this.placed=M.from(e.node(r).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let c=this.findFittable();c?this.placeNodes(c):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),n=this.placed.size-this.depth-this.$from.depth,o=this.$from,r=this.close(e<0?this.$to:o.doc.resolve(e));if(!r)return null;let s=this.placed,i=o.depth,a=r.depth;for(;i&&a&&s.childCount==1;)s=s.firstChild.content,i--,a--;let l=new R(s,i,a);return e>-1?new He(o.pos,e,this.$to.pos,this.$to.end(),l,n):l.size||o.pos!=this.$to.pos?new We(o.pos,r.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let n=this.unplaced.content,o=0,r=this.unplaced.openEnd;o<e;o++){let s=n.firstChild;if(n.childCount>1&&(r=0),s.type.spec.isolating&&r<=o){e=o;break}n=s.content}for(let n=1;n<=2;n++)for(let o=n==1?e:this.unplaced.openStart;o>=0;o--){let r,s=null;o?(s=nl(this.unplaced.content,o-1).firstChild,r=s.content):r=this.unplaced.content;let i=r.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:c}=this.frontier[a],d,u=null;if(n==1&&(i?c.matchType(i.type)||(u=c.fillBefore(M.from(i),!1)):s&&l.compatibleContent(s.type)))return{sliceDepth:o,frontierDepth:a,parent:s,inject:u};if(n==2&&i&&(d=c.findWrapping(i.type)))return{sliceDepth:o,frontierDepth:a,parent:s,wrap:d};if(s&&c.matchType(s.type))break}}}openMore(){let{content:e,openStart:n,openEnd:o}=this.unplaced,r=nl(e,n);return!r.childCount||r.firstChild.isLeaf?!1:(this.unplaced=new R(e,n+1,Math.max(o,r.size+n>=e.size-o?n+1:0)),!0)}dropNode(){let{content:e,openStart:n,openEnd:o}=this.unplaced,r=nl(e,n);if(r.childCount<=1&&n>0){let s=e.size-n<=n+r.size;this.unplaced=new R(Nr(e,n-1,1),n-1,s?n-1:o)}else this.unplaced=new R(Nr(e,n,1),n,o)}placeNodes({sliceDepth:e,frontierDepth:n,parent:o,inject:r,wrap:s}){for(;this.depth>n;)this.closeFrontierNode();if(s)for(let b=0;b<s.length;b++)this.openFrontierNode(s[b]);let i=this.unplaced,a=o?o.content:i.content,l=i.openStart-e,c=0,d=[],{match:u,type:f}=this.frontier[n];if(r){for(let b=0;b<r.childCount;b++)d.push(r.child(b));u=u.matchFragment(r)}let p=a.size+e-(i.content.size-i.openEnd);for(;c<a.childCount;){let b=a.child(c),y=u.matchType(b.type);if(!y)break;c++,(c>1||l==0||b.content.size)&&(u=y,d.push(fh(b.mark(f.allowedMarks(b.marks)),c==1?l:0,c==a.childCount?p:-1)))}let m=c==a.childCount;m||(p=-1),this.placed=Mr(this.placed,n,M.from(d)),this.frontier[n].match=u,m&&p<0&&o&&o.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let b=0,y=a;b<p;b++){let w=y.lastChild;this.frontier.push({type:w.type,match:w.contentMatchAt(w.childCount)}),y=w.content}this.unplaced=m?e==0?R.empty:new R(Nr(i.content,e-1,1),e-1,p<0?i.openEnd:e-1):new R(Nr(i.content,e,c),i.openStart,i.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],n;if(!e.type.isTextblock||!ol(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(n=this.findCloseLevel(this.$to))&&n.depth==this.depth)return-1;let{depth:o}=this.$to,r=this.$to.after(o);for(;o>1&&r==this.$to.end(--o);)++r;return r}findCloseLevel(e){e:for(let n=Math.min(this.depth,e.depth);n>=0;n--){let{match:o,type:r}=this.frontier[n],s=n<e.depth&&e.end(n+1)==e.pos+(e.depth-(n+1)),i=ol(e,n,r,o,s);if(i){for(let a=n-1;a>=0;a--){let{match:l,type:c}=this.frontier[a],d=ol(e,a,c,l,!0);if(!d||d.childCount)continue e}return{depth:n,fit:i,move:s?e.doc.resolve(e.after(n+1)):e}}}}close(e){let n=this.findCloseLevel(e);if(!n)return null;for(;this.depth>n.depth;)this.closeFrontierNode();n.fit.childCount&&(this.placed=Mr(this.placed,n.depth,n.fit)),e=n.move;for(let o=n.depth+1;o<=e.depth;o++){let r=e.node(o),s=r.type.contentMatch.fillBefore(r.content,!0,e.index(o));this.openFrontierNode(r.type,r.attrs,s)}return e}openFrontierNode(e,n=null,o){let r=this.frontier[this.depth];r.match=r.match.matchType(e),this.placed=Mr(this.placed,this.depth,M.from(e.create(n,o))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let n=this.frontier.pop().match.fillBefore(M.empty,!0);n.childCount&&(this.placed=Mr(this.placed,this.frontier.length,n))}}function Nr(t,e,n){return e==0?t.cutByIndex(n,t.childCount):t.replaceChild(0,t.firstChild.copy(Nr(t.firstChild.content,e-1,n)))}function Mr(t,e,n){return e==0?t.append(n):t.replaceChild(t.childCount-1,t.lastChild.copy(Mr(t.lastChild.content,e-1,n)))}function nl(t,e){for(let n=0;n<e;n++)t=t.firstChild.content;return t}function fh(t,e,n){if(e<=0)return t;let o=t.content;return e>1&&(o=o.replaceChild(0,fh(o.firstChild,e-1,o.childCount==1?n-1:0))),e>0&&(o=t.type.contentMatch.fillBefore(o).append(o),n<=0&&(o=o.append(t.type.contentMatch.matchFragment(o).fillBefore(M.empty,!0)))),t.copy(o)}function ol(t,e,n,o,r){let s=t.node(e),i=r?t.indexAfter(e):t.index(e);if(i==s.childCount&&!n.compatibleContent(s.type))return null;let a=o.fillBefore(s.content,!0,i);return a&&!OS(n,s.content,i)?a:null}function OS(t,e,n){for(let o=n;o<e.childCount;o++)if(!t.allowsMarks(e.child(o).marks))return!0;return!1}function LS(t){return t.spec.defining||t.spec.definingForContent}function DS(t,e,n,o){if(!o.size)return t.deleteRange(e,n);let r=t.doc.resolve(e),s=t.doc.resolve(n);if(ph(r,s,o))return t.step(new We(e,n,o));let i=hh(r,t.doc.resolve(n));i[i.length-1]==0&&i.pop();let a=-(r.depth+1);i.unshift(a);for(let f=r.depth,p=r.pos-1;f>0;f--,p--){let m=r.node(f).type.spec;if(m.defining||m.definingAsContext||m.isolating)break;i.indexOf(f)>-1?a=f:r.before(f)==p&&i.splice(1,0,-f)}let l=i.indexOf(a),c=[],d=o.openStart;for(let f=o.content,p=0;;p++){let m=f.firstChild;if(c.push(m),p==o.openStart)break;f=m.content}for(let f=d-1;f>=0;f--){let p=c[f],m=LS(p.type);if(m&&!p.sameMarkup(r.node(Math.abs(a)-1)))d=f;else if(m||!p.type.isTextblock)break}for(let f=o.openStart;f>=0;f--){let p=(f+d+1)%(o.openStart+1),m=c[p];if(m)for(let b=0;b<i.length;b++){let y=i[(b+l)%i.length],w=!0;y<0&&(w=!1,y=-y);let v=r.node(y-1),S=r.index(y-1);if(v.canReplaceWith(S,S,m.type,m.marks))return t.replace(r.before(y),w?s.after(y):n,new R(mh(o.content,0,o.openStart,p),p,o.openEnd))}}let u=t.steps.length;for(let f=i.length-1;f>=0&&(t.replace(e,n,o),!(t.steps.length>u));f--){let p=i[f];p<0||(e=r.before(p),n=s.after(p))}}function mh(t,e,n,o,r){if(e<n){let s=t.firstChild;t=t.replaceChild(0,s.copy(mh(s.content,e+1,n,o,s)))}if(e>o){let s=r.contentMatchAt(0),i=s.fillBefore(t).append(t);t=i.append(s.matchFragment(i).fillBefore(M.empty,!0))}return t}function RS(t,e,n,o){if(!o.isInline&&e==n&&t.doc.resolve(e).parent.content.size){let r=PS(t.doc,e,o.type);r!=null&&(e=n=r)}t.replaceRange(e,n,new R(M.from(o),0,0))}function jS(t,e,n){let o=t.doc.resolve(e),r=t.doc.resolve(n),s=hh(o,r);for(let i=0;i<s.length;i++){let a=s[i],l=i==s.length-1;if(l&&a==0||o.node(a).type.contentMatch.validEnd)return t.delete(o.start(a),r.end(a));if(a>0&&(l||o.node(a-1).canReplace(o.index(a-1),r.indexAfter(a-1))))return t.delete(o.before(a),r.after(a))}for(let i=1;i<=o.depth&&i<=r.depth;i++)if(e-o.start(i)==o.depth-i&&n>o.end(i)&&r.end(i)-n!=r.depth-i&&o.start(i-1)==r.start(i-1)&&o.node(i-1).canReplace(o.index(i-1),r.index(i-1)))return t.delete(o.before(i),n);t.delete(e,n)}function hh(t,e){let n=[],o=Math.min(t.depth,e.depth);for(let r=o;r>=0;r--){let s=t.start(r);if(s<t.pos-(t.depth-r)||e.end(r)>e.pos+(e.depth-r)||t.node(r).type.spec.isolating||e.node(r).type.spec.isolating)break;(s==e.start(r)||r==t.depth&&r==e.depth&&t.parent.inlineContent&&e.parent.inlineContent&&r&&e.start(r-1)==s-1)&&n.push(r)}return n}class ir extends Ze{constructor(e,n,o){super(),this.pos=e,this.attr=n,this.value=o}apply(e){let n=e.nodeAt(this.pos);if(!n)return _e.fail("No node at attribute step's position");let o=Object.create(null);for(let s in n.attrs)o[s]=n.attrs[s];o[this.attr]=this.value;let r=n.type.create(o,null,n.marks);return _e.fromReplace(e,this.pos,this.pos+1,new R(M.from(r),0,n.isLeaf?0:1))}getMap(){return yt.empty}invert(e){return new ir(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let n=e.mapResult(this.pos,1);return n.deletedAfter?null:new ir(n.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,n){if(typeof n.pos!="number"||typeof n.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new ir(n.pos,n.attr,n.value)}}Ze.jsonID("attr",ir);class us extends Ze{constructor(e,n){super(),this.attr=e,this.value=n}apply(e){let n=Object.create(null);for(let r in e.attrs)n[r]=e.attrs[r];n[this.attr]=this.value;let o=e.type.create(n,e.content,e.marks);return _e.ok(o)}getMap(){return yt.empty}invert(e){return new us(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,n){if(typeof n.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new us(n.attr,n.value)}}Ze.jsonID("docAttr",us);let dr=class extends Error{};dr=function t(e){let n=Error.call(this,e);return n.__proto__=t.prototype,n};dr.prototype=Object.create(Error.prototype);dr.prototype.constructor=dr;dr.prototype.name="TransformError";class gh{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new ds}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let n=this.maybeStep(e);if(n.failed)throw new dr(n.failed);return this}maybeStep(e){let n=e.apply(this.doc);return n.failed||this.addStep(e,n.doc),n}get docChanged(){return this.steps.length>0}addStep(e,n){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=n}replace(e,n=e,o=R.empty){let r=Na(this.doc,e,n,o);return r&&this.step(r),this}replaceWith(e,n,o){return this.replace(e,n,new R(M.from(o),0,0))}delete(e,n){return this.replace(e,n,R.empty)}insert(e,n){return this.replaceWith(e,e,n)}replaceRange(e,n,o){return DS(this,e,n,o),this}replaceRangeWith(e,n,o){return RS(this,e,n,o),this}deleteRange(e,n){return jS(this,e,n),this}lift(e,n){return SS(this,e,n),this}join(e,n=1){return TS(this,e,n),this}wrap(e,n){return CS(this,e,n),this}setBlockType(e,n=e,o,r=null){return ES(this,e,n,o,r),this}setNodeMarkup(e,n,o=null,r){return AS(this,e,n,o,r),this}setNodeAttribute(e,n,o){return this.step(new ir(e,n,o)),this}setDocAttribute(e,n){return this.step(new us(e,n)),this}addNodeMark(e,n){return this.step(new Hn(e,n)),this}removeNodeMark(e,n){let o=this.doc.nodeAt(e);if(!o)throw new RangeError("No node at position "+e);if(n instanceof Se)n.isInSet(o.marks)&&this.step(new Bo(e,n));else{let r=o.marks,s,i=[];for(;s=n.isInSet(r);)i.push(new Bo(e,s)),r=s.removeFromSet(r);for(let a=i.length-1;a>=0;a--)this.step(i[a])}return this}split(e,n=1,o){return NS(this,e,n,o),this}addMark(e,n,o){return yS(this,e,n,o),this}removeMark(e,n,o){return wS(this,e,n,o),this}clearIncompatible(e,n,o){return wd(this,e,n,o),this}}const rl=Object.create(null);class ne{constructor(e,n,o){this.$anchor=e,this.$head=n,this.ranges=o||[new _S(e.min(n),e.max(n))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let n=0;n<e.length;n++)if(e[n].$from.pos!=e[n].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,n=R.empty){let o=n.content.lastChild,r=null;for(let a=0;a<n.openEnd;a++)r=o,o=o.lastChild;let s=e.steps.length,i=this.ranges;for(let a=0;a<i.length;a++){let{$from:l,$to:c}=i[a],d=e.mapping.slice(s);e.replaceRange(d.map(l.pos),d.map(c.pos),a?R.empty:n),a==0&&ep(e,s,(o?o.isInline:r&&r.isTextblock)?-1:1)}}replaceWith(e,n){let o=e.steps.length,r=this.ranges;for(let s=0;s<r.length;s++){let{$from:i,$to:a}=r[s],l=e.mapping.slice(o),c=l.map(i.pos),d=l.map(a.pos);s?e.deleteRange(c,d):(e.replaceRangeWith(c,d,n),ep(e,o,n.isInline?-1:1))}}static findFrom(e,n,o=!1){let r=e.parent.inlineContent?new Z(e):Xo(e.node(0),e.parent,e.pos,e.index(),n,o);if(r)return r;for(let s=e.depth-1;s>=0;s--){let i=n<0?Xo(e.node(0),e.node(s),e.before(s+1),e.index(s),n,o):Xo(e.node(0),e.node(s),e.after(s+1),e.index(s)+1,n,o);if(i)return i}return null}static near(e,n=1){return this.findFrom(e,n)||this.findFrom(e,-n)||new St(e.node(0))}static atStart(e){return Xo(e,e,0,0,1)||new St(e)}static atEnd(e){return Xo(e,e,e.content.size,e.childCount,-1)||new St(e)}static fromJSON(e,n){if(!n||!n.type)throw new RangeError("Invalid input for Selection.fromJSON");let o=rl[n.type];if(!o)throw new RangeError(`No selection type ${n.type} defined`);return o.fromJSON(e,n)}static jsonID(e,n){if(e in rl)throw new RangeError("Duplicate use of selection JSON ID "+e);return rl[e]=n,n.prototype.jsonID=e,n}getBookmark(){return Z.between(this.$anchor,this.$head).getBookmark()}}ne.prototype.visible=!0;class _S{constructor(e,n){this.$from=e,this.$to=n}}let Qu=!1;function Zu(t){!Qu&&!t.parent.inlineContent&&(Qu=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+t.parent.type.name+")"))}class Z extends ne{constructor(e,n=e){Zu(e),Zu(n),super(e,n)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,n){let o=e.resolve(n.map(this.head));if(!o.parent.inlineContent)return ne.near(o);let r=e.resolve(n.map(this.anchor));return new Z(r.parent.inlineContent?r:o,o)}replace(e,n=R.empty){if(super.replace(e,n),n==R.empty){let o=this.$from.marksAcross(this.$to);o&&e.ensureMarks(o)}}eq(e){return e instanceof Z&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new Ma(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,n){if(typeof n.anchor!="number"||typeof n.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new Z(e.resolve(n.anchor),e.resolve(n.head))}static create(e,n,o=n){let r=e.resolve(n);return new this(r,o==n?r:e.resolve(o))}static between(e,n,o){let r=e.pos-n.pos;if((!o||r)&&(o=r>=0?1:-1),!n.parent.inlineContent){let s=ne.findFrom(n,o,!0)||ne.findFrom(n,-o,!0);if(s)n=s.$head;else return ne.near(n,o)}return e.parent.inlineContent||(r==0?e=n:(e=(ne.findFrom(e,-o,!0)||ne.findFrom(e,o,!0)).$anchor,e.pos<n.pos!=r<0&&(e=n))),new Z(e,n)}}ne.jsonID("text",Z);class Ma{constructor(e,n){this.anchor=e,this.head=n}map(e){return new Ma(e.map(this.anchor),e.map(this.head))}resolve(e){return Z.between(e.resolve(this.anchor),e.resolve(this.head))}}class U extends ne{constructor(e){let n=e.nodeAfter,o=e.node(0).resolve(e.pos+n.nodeSize);super(e,o),this.node=n}map(e,n){let{deleted:o,pos:r}=n.mapResult(this.anchor),s=e.resolve(r);return o?ne.near(s):new U(s)}content(){return new R(M.from(this.node),0,0)}eq(e){return e instanceof U&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new Sd(this.anchor)}static fromJSON(e,n){if(typeof n.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new U(e.resolve(n.anchor))}static create(e,n){return new U(e.resolve(n))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}U.prototype.visible=!1;ne.jsonID("node",U);class Sd{constructor(e){this.anchor=e}map(e){let{deleted:n,pos:o}=e.mapResult(this.anchor);return n?new Ma(o,o):new Sd(o)}resolve(e){let n=e.resolve(this.anchor),o=n.nodeAfter;return o&&U.isSelectable(o)?new U(n):ne.near(n)}}class St extends ne{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,n=R.empty){if(n==R.empty){e.delete(0,e.doc.content.size);let o=ne.atStart(e.doc);o.eq(e.selection)||e.setSelection(o)}else super.replace(e,n)}toJSON(){return{type:"all"}}static fromJSON(e){return new St(e)}map(e){return new St(e)}eq(e){return e instanceof St}getBookmark(){return $S}}ne.jsonID("all",St);const $S={map(){return this},resolve(t){return new St(t)}};function Xo(t,e,n,o,r,s=!1){if(e.inlineContent)return Z.create(t,n);for(let i=o-(r>0?0:1);r>0?i<e.childCount:i>=0;i+=r){let a=e.child(i);if(a.isAtom){if(!s&&U.isSelectable(a))return U.create(t,n-(r<0?a.nodeSize:0))}else{let l=Xo(t,a,n+r,r<0?a.childCount:0,r,s);if(l)return l}n+=a.nodeSize*r}return null}function ep(t,e,n){let o=t.steps.length-1;if(o<e)return;let r=t.steps[o];if(!(r instanceof We||r instanceof He))return;let s=t.mapping.maps[o],i;s.forEach((a,l,c,d)=>{i==null&&(i=d)}),t.setSelection(ne.near(t.doc.resolve(i),n))}const tp=1,Os=2,np=4;class FS extends gh{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|tp)&~Os,this.storedMarks=null,this}get selectionSet(){return(this.updated&tp)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=Os,this}ensureMarks(e){return Se.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&Os)>0}addStep(e,n){super.addStep(e,n),this.updated=this.updated&~Os,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,n=!0){let o=this.selection;return n&&(e=e.mark(this.storedMarks||(o.empty?o.$from.marks():o.$from.marksAcross(o.$to)||Se.none))),o.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,n,o){let r=this.doc.type.schema;if(n==null)return e?this.replaceSelectionWith(r.text(e),!0):this.deleteSelection();{if(o==null&&(o=n),o=o??n,!e)return this.deleteRange(n,o);let s=this.storedMarks;if(!s){let i=this.doc.resolve(n);s=o==n?i.marks():i.marksAcross(this.doc.resolve(o))}return this.replaceRangeWith(n,o,r.text(e,s)),this.selection.empty||this.setSelection(ne.near(this.selection.$to)),this}}setMeta(e,n){return this.meta[typeof e=="string"?e:e.key]=n,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=np,this}get scrolledIntoView(){return(this.updated&np)>0}}function op(t,e){return!e||!t?t:t.bind(e)}class Tr{constructor(e,n,o){this.name=e,this.init=op(n.init,o),this.apply=op(n.apply,o)}}const WS=[new Tr("doc",{init(t){return t.doc||t.schema.topNodeType.createAndFill()},apply(t){return t.doc}}),new Tr("selection",{init(t,e){return t.selection||ne.atStart(e.doc)},apply(t){return t.selection}}),new Tr("storedMarks",{init(t){return t.storedMarks||null},apply(t,e,n,o){return o.selection.$cursor?t.storedMarks:null}}),new Tr("scrollToSelection",{init(){return 0},apply(t,e){return t.scrolledIntoView?e+1:e}})];class sl{constructor(e,n){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=WS.slice(),n&&n.forEach(o=>{if(this.pluginsByKey[o.key])throw new RangeError("Adding different instances of a keyed plugin ("+o.key+")");this.plugins.push(o),this.pluginsByKey[o.key]=o,o.spec.state&&this.fields.push(new Tr(o.key,o.spec.state,o))})}}class or{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,n=-1){for(let o=0;o<this.config.plugins.length;o++)if(o!=n){let r=this.config.plugins[o];if(r.spec.filterTransaction&&!r.spec.filterTransaction.call(r,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let n=[e],o=this.applyInner(e),r=null;for(;;){let s=!1;for(let i=0;i<this.config.plugins.length;i++){let a=this.config.plugins[i];if(a.spec.appendTransaction){let l=r?r[i].n:0,c=r?r[i].state:this,d=l<n.length&&a.spec.appendTransaction.call(a,l?n.slice(l):n,c,o);if(d&&o.filterTransaction(d,i)){if(d.setMeta("appendedTransaction",e),!r){r=[];for(let u=0;u<this.config.plugins.length;u++)r.push(u<i?{state:o,n:n.length}:{state:this,n:0})}n.push(d),o=o.applyInner(d),s=!0}r&&(r[i]={state:o,n:n.length})}}if(!s)return{state:o,transactions:n}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let n=new or(this.config),o=this.config.fields;for(let r=0;r<o.length;r++){let s=o[r];n[s.name]=s.apply(e,this[s.name],this,n)}return n}get tr(){return new FS(this)}static create(e){let n=new sl(e.doc?e.doc.type.schema:e.schema,e.plugins),o=new or(n);for(let r=0;r<n.fields.length;r++)o[n.fields[r].name]=n.fields[r].init(e,o);return o}reconfigure(e){let n=new sl(this.schema,e.plugins),o=n.fields,r=new or(n);for(let s=0;s<o.length;s++){let i=o[s].name;r[i]=this.hasOwnProperty(i)?this[i]:o[s].init(e,r)}return r}toJSON(e){let n={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(n.storedMarks=this.storedMarks.map(o=>o.toJSON())),e&&typeof e=="object")for(let o in e){if(o=="doc"||o=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let r=e[o],s=r.spec.state;s&&s.toJSON&&(n[o]=s.toJSON.call(r,this[r.key]))}return n}static fromJSON(e,n,o){if(!n)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let r=new sl(e.schema,e.plugins),s=new or(r);return r.fields.forEach(i=>{if(i.name=="doc")s.doc=Gn.fromJSON(e.schema,n.doc);else if(i.name=="selection")s.selection=ne.fromJSON(s.doc,n.selection);else if(i.name=="storedMarks")n.storedMarks&&(s.storedMarks=n.storedMarks.map(e.schema.markFromJSON));else{if(o)for(let a in o){let l=o[a],c=l.spec.state;if(l.key==i.name&&c&&c.fromJSON&&Object.prototype.hasOwnProperty.call(n,a)){s[i.name]=c.fromJSON.call(l,e,n[a],s);return}}s[i.name]=i.init(e,s)}}),s}}function bh(t,e,n){for(let o in t){let r=t[o];r instanceof Function?r=r.bind(e):o=="handleDOMEvents"&&(r=bh(r,e,{})),n[o]=r}return n}class Me{constructor(e){this.spec=e,this.props={},e.props&&bh(e.props,this,this.props),this.key=e.key?e.key.key:yh("plugin")}getState(e){return e[this.key]}}const il=Object.create(null);function yh(t){return t in il?t+"$"+ ++il[t]:(il[t]=0,t+"$")}class Fe{constructor(e="key"){this.key=yh(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const Ke=function(t){for(var e=0;;e++)if(t=t.previousSibling,!t)return e},ur=function(t){let e=t.assignedSlot||t.parentNode;return e&&e.nodeType==11?e.host:e};let cc=null;const mn=function(t,e,n){let o=cc||(cc=document.createRange());return o.setEnd(t,n??t.nodeValue.length),o.setStart(t,e||0),o},zS=function(){cc=null},Oo=function(t,e,n,o){return n&&(rp(t,e,n,o,-1)||rp(t,e,n,o,1))},HS=/^(img|br|input|textarea|hr)$/i;function rp(t,e,n,o,r){for(var s;;){if(t==n&&e==o)return!0;if(e==(r<0?0:Mt(t))){let i=t.parentNode;if(!i||i.nodeType!=1||Ss(t)||HS.test(t.nodeName)||t.contentEditable=="false")return!1;e=Ke(t)+(r<0?0:1),t=i}else if(t.nodeType==1){let i=t.childNodes[e+(r<0?-1:0)];if(i.nodeType==1&&i.contentEditable=="false")if(!((s=i.pmViewDesc)===null||s===void 0)&&s.ignoreForSelection)e+=r;else return!1;else t=i,e=r<0?Mt(t):0}else return!1}}function Mt(t){return t.nodeType==3?t.nodeValue.length:t.childNodes.length}function US(t,e){for(;;){if(t.nodeType==3&&e)return t;if(t.nodeType==1&&e>0){if(t.contentEditable=="false")return null;t=t.childNodes[e-1],e=Mt(t)}else if(t.parentNode&&!Ss(t))e=Ke(t),t=t.parentNode;else return null}}function VS(t,e){for(;;){if(t.nodeType==3&&e<t.nodeValue.length)return t;if(t.nodeType==1&&e<t.childNodes.length){if(t.contentEditable=="false")return null;t=t.childNodes[e],e=0}else if(t.parentNode&&!Ss(t))e=Ke(t)+1,t=t.parentNode;else return null}}function qS(t,e,n){for(let o=e==0,r=e==Mt(t);o||r;){if(t==n)return!0;let s=Ke(t);if(t=t.parentNode,!t)return!1;o=o&&s==0,r=r&&s==Mt(t)}}function Ss(t){let e;for(let n=t;n&&!(e=n.pmViewDesc);n=n.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==t||e.contentDOM==t)}const Ta=function(t){return t.focusNode&&Oo(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset)};function go(t,e){let n=document.createEvent("Event");return n.initEvent("keydown",!0,!0),n.keyCode=t,n.key=n.code=e,n}function KS(t){let e=t.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function GS(t,e,n){if(t.caretPositionFromPoint)try{let o=t.caretPositionFromPoint(e,n);if(o)return{node:o.offsetNode,offset:Math.min(Mt(o.offsetNode),o.offset)}}catch{}if(t.caretRangeFromPoint){let o=t.caretRangeFromPoint(e,n);if(o)return{node:o.startContainer,offset:Math.min(Mt(o.startContainer),o.startOffset)}}}const Qt=typeof navigator<"u"?navigator:null,sp=typeof document<"u"?document:null,co=Qt&&Qt.userAgent||"",dc=/Edge\/(\d+)/.exec(co),wh=/MSIE \d/.exec(co),uc=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(co),ft=!!(wh||uc||dc),Yn=wh?document.documentMode:uc?+uc[1]:dc?+dc[1]:0,Wt=!ft&&/gecko\/(\d+)/i.test(co);Wt&&+(/Firefox\/(\d+)/.exec(co)||[0,0])[1];const pc=!ft&&/Chrome\/(\d+)/.exec(co),Xe=!!pc,vh=pc?+pc[1]:0,rt=!ft&&!!Qt&&/Apple Computer/.test(Qt.vendor),pr=rt&&(/Mobile\/\w+/.test(co)||!!Qt&&Qt.maxTouchPoints>2),At=pr||(Qt?/Mac/.test(Qt.platform):!1),JS=Qt?/Win/.test(Qt.platform):!1,vn=/Android \d/.test(co),ks=!!sp&&"webkitFontSmoothing"in sp.documentElement.style,YS=ks?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function XS(t){let e=t.defaultView&&t.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:t.documentElement.clientWidth,top:0,bottom:t.documentElement.clientHeight}}function ln(t,e){return typeof t=="number"?t:t[e]}function QS(t){let e=t.getBoundingClientRect(),n=e.width/t.offsetWidth||1,o=e.height/t.offsetHeight||1;return{left:e.left,right:e.left+t.clientWidth*n,top:e.top,bottom:e.top+t.clientHeight*o}}function ip(t,e,n){let o=t.someProp("scrollThreshold")||0,r=t.someProp("scrollMargin")||5,s=t.dom.ownerDocument;for(let i=n||t.dom;i;){if(i.nodeType!=1){i=ur(i);continue}let a=i,l=a==s.body,c=l?XS(s):QS(a),d=0,u=0;if(e.top<c.top+ln(o,"top")?u=-(c.top-e.top+ln(r,"top")):e.bottom>c.bottom-ln(o,"bottom")&&(u=e.bottom-e.top>c.bottom-c.top?e.top+ln(r,"top")-c.top:e.bottom-c.bottom+ln(r,"bottom")),e.left<c.left+ln(o,"left")?d=-(c.left-e.left+ln(r,"left")):e.right>c.right-ln(o,"right")&&(d=e.right-c.right+ln(r,"right")),d||u)if(l)s.defaultView.scrollBy(d,u);else{let p=a.scrollLeft,m=a.scrollTop;u&&(a.scrollTop+=u),d&&(a.scrollLeft+=d);let b=a.scrollLeft-p,y=a.scrollTop-m;e={left:e.left-b,top:e.top-y,right:e.right-b,bottom:e.bottom-y}}let f=l?"fixed":getComputedStyle(i).position;if(/^(fixed|sticky)$/.test(f))break;i=f=="absolute"?i.offsetParent:ur(i)}}function ZS(t){let e=t.dom.getBoundingClientRect(),n=Math.max(0,e.top),o,r;for(let s=(e.left+e.right)/2,i=n+1;i<Math.min(innerHeight,e.bottom);i+=5){let a=t.root.elementFromPoint(s,i);if(!a||a==t.dom||!t.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=n-20){o=a,r=l.top;break}}return{refDOM:o,refTop:r,stack:Sh(t.dom)}}function Sh(t){let e=[],n=t.ownerDocument;for(let o=t;o&&(e.push({dom:o,top:o.scrollTop,left:o.scrollLeft}),t!=n);o=ur(o));return e}function ek({refDOM:t,refTop:e,stack:n}){let o=t?t.getBoundingClientRect().top:0;kh(n,o==0?0:o-e)}function kh(t,e){for(let n=0;n<t.length;n++){let{dom:o,top:r,left:s}=t[n];o.scrollTop!=r+e&&(o.scrollTop=r+e),o.scrollLeft!=s&&(o.scrollLeft=s)}}let zo=null;function tk(t){if(t.setActive)return t.setActive();if(zo)return t.focus(zo);let e=Sh(t);t.focus(zo==null?{get preventScroll(){return zo={preventScroll:!0},!0}}:void 0),zo||(zo=!1,kh(e,0))}function xh(t,e){let n,o=2e8,r,s=0,i=e.top,a=e.top,l,c;for(let d=t.firstChild,u=0;d;d=d.nextSibling,u++){let f;if(d.nodeType==1)f=d.getClientRects();else if(d.nodeType==3)f=mn(d).getClientRects();else continue;for(let p=0;p<f.length;p++){let m=f[p];if(m.top<=i&&m.bottom>=a){i=Math.max(m.bottom,i),a=Math.min(m.top,a);let b=m.left>e.left?m.left-e.left:m.right<e.left?e.left-m.right:0;if(b<o){n=d,o=b,r=b&&n.nodeType==3?{left:m.right<e.left?m.right:m.left,top:e.top}:e,d.nodeType==1&&b&&(s=u+(e.left>=(m.left+m.right)/2?1:0));continue}}else m.top>e.top&&!l&&m.left<=e.left&&m.right>=e.left&&(l=d,c={left:Math.max(m.left,Math.min(m.right,e.left)),top:m.top});!n&&(e.left>=m.right&&e.top>=m.top||e.left>=m.left&&e.top>=m.bottom)&&(s=u+1)}}return!n&&l&&(n=l,r=c,o=0),n&&n.nodeType==3?nk(n,r):!n||o&&n.nodeType==1?{node:t,offset:s}:xh(n,r)}function nk(t,e){let n=t.nodeValue.length,o=document.createRange();for(let r=0;r<n;r++){o.setEnd(t,r+1),o.setStart(t,r);let s=On(o,1);if(s.top!=s.bottom&&kd(e,s))return{node:t,offset:r+(e.left>=(s.left+s.right)/2?1:0)}}return{node:t,offset:0}}function kd(t,e){return t.left>=e.left-1&&t.left<=e.right+1&&t.top>=e.top-1&&t.top<=e.bottom+1}function ok(t,e){let n=t.parentNode;return n&&/^li$/i.test(n.nodeName)&&e.left<t.getBoundingClientRect().left?n:t}function rk(t,e,n){let{node:o,offset:r}=xh(e,n),s=-1;if(o.nodeType==1&&!o.firstChild){let i=o.getBoundingClientRect();s=i.left!=i.right&&n.left>(i.left+i.right)/2?1:-1}return t.docView.posFromDOM(o,r,s)}function sk(t,e,n,o){let r=-1;for(let s=e,i=!1;s!=t.dom;){let a=t.docView.nearestDesc(s,!0),l;if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)&&((l=a.dom.getBoundingClientRect()).width||l.height)&&(a.node.isBlock&&a.parent&&!/^T(R|BODY|HEAD|FOOT)$/.test(a.dom.nodeName)&&(!i&&l.left>o.left||l.top>o.top?r=a.posBefore:(!i&&l.right<o.left||l.bottom<o.top)&&(r=a.posAfter),i=!0),!a.contentDOM&&r<0&&!a.node.isText))return(a.node.isBlock?o.top<(l.top+l.bottom)/2:o.left<(l.left+l.right)/2)?a.posBefore:a.posAfter;s=a.dom.parentNode}return r>-1?r:t.docView.posFromDOM(e,n,-1)}function Ch(t,e,n){let o=t.childNodes.length;if(o&&n.top<n.bottom)for(let r=Math.max(0,Math.min(o-1,Math.floor(o*(e.top-n.top)/(n.bottom-n.top))-2)),s=r;;){let i=t.childNodes[s];if(i.nodeType==1){let a=i.getClientRects();for(let l=0;l<a.length;l++){let c=a[l];if(kd(e,c))return Ch(i,e,c)}}if((s=(s+1)%o)==r)break}return t}function ik(t,e){let n=t.dom.ownerDocument,o,r=0,s=GS(n,e.left,e.top);s&&({node:o,offset:r}=s);let i=(t.root.elementFromPoint?t.root:n).elementFromPoint(e.left,e.top),a;if(!i||!t.dom.contains(i.nodeType!=1?i.parentNode:i)){let c=t.dom.getBoundingClientRect();if(!kd(e,c)||(i=Ch(t.dom,e,c),!i))return null}if(rt)for(let c=i;o&&c;c=ur(c))c.draggable&&(o=void 0);if(i=ok(i,e),o){if(Wt&&o.nodeType==1&&(r=Math.min(r,o.childNodes.length),r<o.childNodes.length)){let d=o.childNodes[r],u;d.nodeName=="IMG"&&(u=d.getBoundingClientRect()).right<=e.left&&u.bottom>e.top&&r++}let c;ks&&r&&o.nodeType==1&&(c=o.childNodes[r-1]).nodeType==1&&c.contentEditable=="false"&&c.getBoundingClientRect().top>=e.top&&r--,o==t.dom&&r==o.childNodes.length-1&&o.lastChild.nodeType==1&&e.top>o.lastChild.getBoundingClientRect().bottom?a=t.state.doc.content.size:(r==0||o.nodeType!=1||o.childNodes[r-1].nodeName!="BR")&&(a=sk(t,o,r,e))}a==null&&(a=rk(t,i,e));let l=t.docView.nearestDesc(i,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function ap(t){return t.top<t.bottom||t.left<t.right}function On(t,e){let n=t.getClientRects();if(n.length){let o=n[e<0?0:n.length-1];if(ap(o))return o}return Array.prototype.find.call(n,ap)||t.getBoundingClientRect()}const ak=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Eh(t,e,n){let{node:o,offset:r,atom:s}=t.docView.domFromPos(e,n<0?-1:1),i=ks||Wt;if(o.nodeType==3)if(i&&(ak.test(o.nodeValue)||(n<0?!r:r==o.nodeValue.length))){let l=On(mn(o,r,r),n);if(Wt&&r&&/\s/.test(o.nodeValue[r-1])&&r<o.nodeValue.length){let c=On(mn(o,r-1,r-1),-1);if(c.top==l.top){let d=On(mn(o,r,r+1),-1);if(d.top!=l.top)return Cr(d,d.left<c.left)}}return l}else{let l=r,c=r,d=n<0?1:-1;return n<0&&!r?(c++,d=-1):n>=0&&r==o.nodeValue.length?(l--,d=1):n<0?l--:c++,Cr(On(mn(o,l,c),d),d<0)}if(!t.state.doc.resolve(e-(s||0)).parent.inlineContent){if(s==null&&r&&(n<0||r==Mt(o))){let l=o.childNodes[r-1];if(l.nodeType==1)return al(l.getBoundingClientRect(),!1)}if(s==null&&r<Mt(o)){let l=o.childNodes[r];if(l.nodeType==1)return al(l.getBoundingClientRect(),!0)}return al(o.getBoundingClientRect(),n>=0)}if(s==null&&r&&(n<0||r==Mt(o))){let l=o.childNodes[r-1],c=l.nodeType==3?mn(l,Mt(l)-(i?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(c)return Cr(On(c,1),!1)}if(s==null&&r<Mt(o)){let l=o.childNodes[r];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let c=l?l.nodeType==3?mn(l,0,i?0:1):l.nodeType==1?l:null:null;if(c)return Cr(On(c,-1),!0)}return Cr(On(o.nodeType==3?mn(o):o,-n),n>=0)}function Cr(t,e){if(t.width==0)return t;let n=e?t.left:t.right;return{top:t.top,bottom:t.bottom,left:n,right:n}}function al(t,e){if(t.height==0)return t;let n=e?t.top:t.bottom;return{top:n,bottom:n,left:t.left,right:t.right}}function Ih(t,e,n){let o=t.state,r=t.root.activeElement;o!=e&&t.updateState(e),r!=t.dom&&t.focus();try{return n()}finally{o!=e&&t.updateState(o),r!=t.dom&&r&&r.focus()}}function lk(t,e,n){let o=e.selection,r=n=="up"?o.$from:o.$to;return Ih(t,e,()=>{let{node:s}=t.docView.domFromPos(r.pos,n=="up"?-1:1);for(;;){let a=t.docView.nearestDesc(s,!0);if(!a)break;if(a.node.isBlock){s=a.contentDOM||a.dom;break}s=a.dom.parentNode}let i=Eh(t,r.pos,1);for(let a=s.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=mn(a,0,a.nodeValue.length).getClientRects();else continue;for(let c=0;c<l.length;c++){let d=l[c];if(d.bottom>d.top+1&&(n=="up"?i.top-d.top>(d.bottom-i.top)*2:d.bottom-i.bottom>(i.bottom-d.top)*2))return!1}}return!0})}const ck=/[\u0590-\u08ac]/;function dk(t,e,n){let{$head:o}=e.selection;if(!o.parent.isTextblock)return!1;let r=o.parentOffset,s=!r,i=r==o.parent.content.size,a=t.domSelection();return a?!ck.test(o.parent.textContent)||!a.modify?n=="left"||n=="backward"?s:i:Ih(t,e,()=>{let{focusNode:l,focusOffset:c,anchorNode:d,anchorOffset:u}=t.domSelectionRange(),f=a.caretBidiLevel;a.modify("move",n,"character");let p=o.depth?t.docView.domAfterPos(o.before()):t.dom,{focusNode:m,focusOffset:b}=t.domSelectionRange(),y=m&&!p.contains(m.nodeType==1?m:m.parentNode)||l==m&&c==b;try{a.collapse(d,u),l&&(l!=d||c!=u)&&a.extend&&a.extend(l,c)}catch{}return f!=null&&(a.caretBidiLevel=f),y}):o.pos==o.start()||o.pos==o.end()}let lp=null,cp=null,dp=!1;function uk(t,e,n){return lp==e&&cp==n?dp:(lp=e,cp=n,dp=n=="up"||n=="down"?lk(t,e,n):dk(t,e,n))}const Tt=0,up=1,yo=2,Zt=3;class xs{constructor(e,n,o,r){this.parent=e,this.children=n,this.dom=o,this.contentDOM=r,this.dirty=Tt,o.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,n,o){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let n=0;n<this.children.length;n++)e+=this.children[n].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let n=0,o=this.posAtStart;;n++){let r=this.children[n];if(r==e)return o;o+=r.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,n,o){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(o<0){let s,i;if(e==this.contentDOM)s=e.childNodes[n-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;s=e.previousSibling}for(;s&&!((i=s.pmViewDesc)&&i.parent==this);)s=s.previousSibling;return s?this.posBeforeChild(i)+i.size:this.posAtStart}else{let s,i;if(e==this.contentDOM)s=e.childNodes[n];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;s=e.nextSibling}for(;s&&!((i=s.pmViewDesc)&&i.parent==this);)s=s.nextSibling;return s?this.posBeforeChild(i):this.posAtEnd}let r;if(e==this.dom&&this.contentDOM)r=n>Ke(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))r=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(n==0)for(let s=e;;s=s.parentNode){if(s==this.dom){r=!1;break}if(s.previousSibling)break}if(r==null&&n==e.childNodes.length)for(let s=e;;s=s.parentNode){if(s==this.dom){r=!0;break}if(s.nextSibling)break}}return r??o>0?this.posAtEnd:this.posAtStart}nearestDesc(e,n=!1){for(let o=!0,r=e;r;r=r.parentNode){let s=this.getDesc(r),i;if(s&&(!n||s.node))if(o&&(i=s.nodeDOM)&&!(i.nodeType==1?i.contains(e.nodeType==1?e:e.parentNode):i==e))o=!1;else return s}}getDesc(e){let n=e.pmViewDesc;for(let o=n;o;o=o.parent)if(o==this)return n}posFromDOM(e,n,o){for(let r=e;r;r=r.parentNode){let s=this.getDesc(r);if(s)return s.localPosFromDOM(e,n,o)}return-1}descAt(e){for(let n=0,o=0;n<this.children.length;n++){let r=this.children[n],s=o+r.size;if(o==e&&s!=o){for(;!r.border&&r.children.length;)for(let i=0;i<r.children.length;i++){let a=r.children[i];if(a.size){r=a;break}}return r}if(e<s)return r.descAt(e-o-r.border);o=s}}domFromPos(e,n){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let o=0,r=0;for(let s=0;o<this.children.length;o++){let i=this.children[o],a=s+i.size;if(a>e||i instanceof Nh){r=e-s;break}s=a}if(r)return this.children[o].domFromPos(r-this.children[o].border,n);for(let s;o&&!(s=this.children[o-1]).size&&s instanceof Ah&&s.side>=0;o--);if(n<=0){let s,i=!0;for(;s=o?this.children[o-1]:null,!(!s||s.dom.parentNode==this.contentDOM);o--,i=!1);return s&&n&&i&&!s.border&&!s.domAtom?s.domFromPos(s.size,n):{node:this.contentDOM,offset:s?Ke(s.dom)+1:0}}else{let s,i=!0;for(;s=o<this.children.length?this.children[o]:null,!(!s||s.dom.parentNode==this.contentDOM);o++,i=!1);return s&&i&&!s.border&&!s.domAtom?s.domFromPos(0,n):{node:this.contentDOM,offset:s?Ke(s.dom):this.contentDOM.childNodes.length}}}parseRange(e,n,o=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:n,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let r=-1,s=-1;for(let i=o,a=0;;a++){let l=this.children[a],c=i+l.size;if(r==-1&&e<=c){let d=i+l.border;if(e>=d&&n<=c-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,n,d);e=i;for(let u=a;u>0;u--){let f=this.children[u-1];if(f.size&&f.dom.parentNode==this.contentDOM&&!f.emptyChildAt(1)){r=Ke(f.dom)+1;break}e-=f.size}r==-1&&(r=0)}if(r>-1&&(c>n||a==this.children.length-1)){n=c;for(let d=a+1;d<this.children.length;d++){let u=this.children[d];if(u.size&&u.dom.parentNode==this.contentDOM&&!u.emptyChildAt(-1)){s=Ke(u.dom);break}n+=u.size}s==-1&&(s=this.contentDOM.childNodes.length);break}i=c}return{node:this.contentDOM,from:e,to:n,fromOffset:r,toOffset:s}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let n=this.children[e<0?0:this.children.length-1];return n.size==0||n.emptyChildAt(e)}domAfterPos(e){let{node:n,offset:o}=this.domFromPos(e,0);if(n.nodeType!=1||o==n.childNodes.length)throw new RangeError("No node after pos "+e);return n.childNodes[o]}setSelection(e,n,o,r=!1){let s=Math.min(e,n),i=Math.max(e,n);for(let p=0,m=0;p<this.children.length;p++){let b=this.children[p],y=m+b.size;if(s>m&&i<y)return b.setSelection(e-m-b.border,n-m-b.border,o,r);m=y}let a=this.domFromPos(e,e?-1:1),l=n==e?a:this.domFromPos(n,n?-1:1),c=o.root.getSelection(),d=o.domSelectionRange(),u=!1;if((Wt||rt)&&e==n){let{node:p,offset:m}=a;if(p.nodeType==3){if(u=!!(m&&p.nodeValue[m-1]==`
`),u&&m==p.nodeValue.length)for(let b=p,y;b;b=b.parentNode){if(y=b.nextSibling){y.nodeName=="BR"&&(a=l={node:y.parentNode,offset:Ke(y)+1});break}let w=b.pmViewDesc;if(w&&w.node&&w.node.isBlock)break}}else{let b=p.childNodes[m-1];u=b&&(b.nodeName=="BR"||b.contentEditable=="false")}}if(Wt&&d.focusNode&&d.focusNode!=l.node&&d.focusNode.nodeType==1){let p=d.focusNode.childNodes[d.focusOffset];p&&p.contentEditable=="false"&&(r=!0)}if(!(r||u&&rt)&&Oo(a.node,a.offset,d.anchorNode,d.anchorOffset)&&Oo(l.node,l.offset,d.focusNode,d.focusOffset))return;let f=!1;if((c.extend||e==n)&&!u){c.collapse(a.node,a.offset);try{e!=n&&c.extend(l.node,l.offset),f=!0}catch{}}if(!f){if(e>n){let m=a;a=l,l=m}let p=document.createRange();p.setEnd(l.node,l.offset),p.setStart(a.node,a.offset),c.removeAllRanges(),c.addRange(p)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,n){for(let o=0,r=0;r<this.children.length;r++){let s=this.children[r],i=o+s.size;if(o==i?e<=i&&n>=o:e<i&&n>o){let a=o+s.border,l=i-s.border;if(e>=a&&n<=l){this.dirty=e==o||n==i?yo:up,e==a&&n==l&&(s.contentLost||s.dom.parentNode!=this.contentDOM)?s.dirty=Zt:s.markDirty(e-a,n-a);return}else s.dirty=s.dom==s.contentDOM&&s.dom.parentNode==this.contentDOM&&!s.children.length?yo:Zt}o=i}this.dirty=yo}markParentsDirty(){let e=1;for(let n=this.parent;n;n=n.parent,e++){let o=e==1?yo:up;n.dirty<o&&(n.dirty=o)}}get domAtom(){return!1}get ignoreForCoords(){return!1}get ignoreForSelection(){return!1}isText(e){return!1}}class Ah extends xs{constructor(e,n,o,r){let s,i=n.type.toDOM;if(typeof i=="function"&&(i=i(o,()=>{if(!s)return r;if(s.parent)return s.parent.posBeforeChild(s)})),!n.type.spec.raw){if(i.nodeType!=1){let a=document.createElement("span");a.appendChild(i),i=a}i.contentEditable="false",i.classList.add("ProseMirror-widget")}super(e,[],i,null),this.widget=n,this.widget=n,s=this}matchesWidget(e){return this.dirty==Tt&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let n=this.widget.spec.stopEvent;return n?n(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get ignoreForSelection(){return!!this.widget.type.spec.relaxedSide}get side(){return this.widget.type.side}}class pk extends xs{constructor(e,n,o,r){super(e,[],n,null),this.textDOM=o,this.text=r}get size(){return this.text.length}localPosFromDOM(e,n){return e!=this.textDOM?this.posAtStart+(n?this.size:0):this.posAtStart+n}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class Lo extends xs{constructor(e,n,o,r,s){super(e,[],o,r),this.mark=n,this.spec=s}static create(e,n,o,r){let s=r.nodeViews[n.type.name],i=s&&s(n,r,o);return(!i||!i.dom)&&(i=$o.renderSpec(document,n.type.spec.toDOM(n,o),null,n.attrs)),new Lo(e,n,i.dom,i.contentDOM||i.dom,i)}parseRule(){return this.dirty&Zt||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=Zt&&this.mark.eq(e)}markDirty(e,n){if(super.markDirty(e,n),this.dirty!=Tt){let o=this.parent;for(;!o.node;)o=o.parent;o.dirty<this.dirty&&(o.dirty=this.dirty),this.dirty=Tt}}slice(e,n,o){let r=Lo.create(this.parent,this.mark,!0,o),s=this.children,i=this.size;n<i&&(s=mc(s,n,i,o)),e>0&&(s=mc(s,0,e,o));for(let a=0;a<s.length;a++)s[a].parent=r;return r.children=s,r}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}}class Xn extends xs{constructor(e,n,o,r,s,i,a,l,c){super(e,[],s,i),this.node=n,this.outerDeco=o,this.innerDeco=r,this.nodeDOM=a}static create(e,n,o,r,s,i){let a=s.nodeViews[n.type.name],l,c=a&&a(n,s,()=>{if(!l)return i;if(l.parent)return l.parent.posBeforeChild(l)},o,r),d=c&&c.dom,u=c&&c.contentDOM;if(n.isText){if(!d)d=document.createTextNode(n.text);else if(d.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else d||({dom:d,contentDOM:u}=$o.renderSpec(document,n.type.spec.toDOM(n),null,n.attrs));!u&&!n.isText&&d.nodeName!="BR"&&(d.hasAttribute("contenteditable")||(d.contentEditable="false"),n.type.spec.draggable&&(d.draggable=!0));let f=d;return d=Ph(d,o,n),c?l=new fk(e,n,o,r,d,u||null,f,c,s,i+1):n.isText?new Pa(e,n,o,r,d,f,s):new Xn(e,n,o,r,d,u||null,f,s,i+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let n=this.children.length-1;n>=0;n--){let o=this.children[n];if(this.dom.contains(o.dom.parentNode)){e.contentElement=o.dom.parentNode;break}}e.contentElement||(e.getContent=()=>M.empty)}return e}matchesNode(e,n,o){return this.dirty==Tt&&e.eq(this.node)&&xi(n,this.outerDeco)&&o.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,n){let o=this.node.inlineContent,r=n,s=e.composing?this.localCompositionInfo(e,n):null,i=s&&s.pos>-1?s:null,a=s&&s.pos<0,l=new hk(this,i&&i.node,e);yk(this.node,this.innerDeco,(c,d,u)=>{c.spec.marks?l.syncToMarks(c.spec.marks,o,e):c.type.side>=0&&!u&&l.syncToMarks(d==this.node.childCount?Se.none:this.node.child(d).marks,o,e),l.placeWidget(c,e,r)},(c,d,u,f)=>{l.syncToMarks(c.marks,o,e);let p;l.findNodeMatch(c,d,u,f)||a&&e.state.selection.from>r&&e.state.selection.to<r+c.nodeSize&&(p=l.findIndexWithChild(s.node))>-1&&l.updateNodeAt(c,d,u,p,e)||l.updateNextNode(c,d,u,e,f,r)||l.addNode(c,d,u,e,r),r+=c.nodeSize}),l.syncToMarks([],o,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==yo)&&(i&&this.protectLocalComposition(e,i),Mh(this.contentDOM,this.children,e),pr&&wk(this.dom))}localCompositionInfo(e,n){let{from:o,to:r}=e.state.selection;if(!(e.state.selection instanceof Z)||o<n||r>n+this.node.content.size)return null;let s=e.input.compositionNode;if(!s||!this.dom.contains(s.parentNode))return null;if(this.node.inlineContent){let i=s.nodeValue,a=vk(this.node.content,i,o-n,r-n);return a<0?null:{node:s,pos:a,text:i}}else return{node:s,pos:-1,text:""}}protectLocalComposition(e,{node:n,pos:o,text:r}){if(this.getDesc(n))return;let s=n;for(;s.parentNode!=this.contentDOM;s=s.parentNode){for(;s.previousSibling;)s.parentNode.removeChild(s.previousSibling);for(;s.nextSibling;)s.parentNode.removeChild(s.nextSibling);s.pmViewDesc&&(s.pmViewDesc=void 0)}let i=new pk(this,s,n,r);e.input.compositionNodes.push(i),this.children=mc(this.children,o,o+r.length,e,i)}update(e,n,o,r){return this.dirty==Zt||!e.sameMarkup(this.node)?!1:(this.updateInner(e,n,o,r),!0)}updateInner(e,n,o,r){this.updateOuterDeco(n),this.node=e,this.innerDeco=o,this.contentDOM&&this.updateChildren(r,this.posAtStart),this.dirty=Tt}updateOuterDeco(e){if(xi(e,this.outerDeco))return;let n=this.nodeDOM.nodeType!=1,o=this.dom;this.dom=Th(this.dom,this.nodeDOM,fc(this.outerDeco,this.node,n),fc(e,this.node,n)),this.dom!=o&&(o.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.dom.draggable=!0)}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.dom.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function pp(t,e,n,o,r){Ph(o,e,t);let s=new Xn(void 0,t,e,n,o,o,o,r,0);return s.contentDOM&&s.updateChildren(r,0),s}class Pa extends Xn{constructor(e,n,o,r,s,i,a){super(e,n,o,r,s,null,i,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,n,o,r){return this.dirty==Zt||this.dirty!=Tt&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(n),(this.dirty!=Tt||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,r.trackWrites==this.nodeDOM&&(r.trackWrites=null)),this.node=e,this.dirty=Tt,!0)}inParent(){let e=this.parent.contentDOM;for(let n=this.nodeDOM;n;n=n.parentNode)if(n==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,n,o){return e==this.nodeDOM?this.posAtStart+Math.min(n,this.node.text.length):super.localPosFromDOM(e,n,o)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,n,o){let r=this.node.cut(e,n),s=document.createTextNode(r.text);return new Pa(this.parent,r,this.outerDeco,this.innerDeco,s,s,o)}markDirty(e,n){super.markDirty(e,n),this.dom!=this.nodeDOM&&(e==0||n==this.nodeDOM.nodeValue.length)&&(this.dirty=Zt)}get domAtom(){return!1}isText(e){return this.node.text==e}}class Nh extends xs{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==Tt&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class fk extends Xn{constructor(e,n,o,r,s,i,a,l,c,d){super(e,n,o,r,s,i,a,c,d),this.spec=l}update(e,n,o,r){if(this.dirty==Zt)return!1;if(this.spec.update&&(this.node.type==e.type||this.spec.multiType)){let s=this.spec.update(e,n,o);return s&&this.updateInner(e,n,o,r),s}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,n,o,r)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,n,o,r){this.spec.setSelection?this.spec.setSelection(e,n,o.root):super.setSelection(e,n,o,r)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function Mh(t,e,n){let o=t.firstChild,r=!1;for(let s=0;s<e.length;s++){let i=e[s],a=i.dom;if(a.parentNode==t){for(;a!=o;)o=fp(o),r=!0;o=o.nextSibling}else r=!0,t.insertBefore(a,o);if(i instanceof Lo){let l=o?o.previousSibling:t.lastChild;Mh(i.contentDOM,i.children,n),o=l?l.nextSibling:t.firstChild}}for(;o;)o=fp(o),r=!0;r&&n.trackWrites==t&&(n.trackWrites=null)}const Hr=function(t){t&&(this.nodeName=t)};Hr.prototype=Object.create(null);const wo=[new Hr];function fc(t,e,n){if(t.length==0)return wo;let o=n?wo[0]:new Hr,r=[o];for(let s=0;s<t.length;s++){let i=t[s].type.attrs;if(i){i.nodeName&&r.push(o=new Hr(i.nodeName));for(let a in i){let l=i[a];l!=null&&(n&&r.length==1&&r.push(o=new Hr(e.isInline?"span":"div")),a=="class"?o.class=(o.class?o.class+" ":"")+l:a=="style"?o.style=(o.style?o.style+";":"")+l:a!="nodeName"&&(o[a]=l))}}}return r}function Th(t,e,n,o){if(n==wo&&o==wo)return e;let r=e;for(let s=0;s<o.length;s++){let i=o[s],a=n[s];if(s){let l;a&&a.nodeName==i.nodeName&&r!=t&&(l=r.parentNode)&&l.nodeName.toLowerCase()==i.nodeName||(l=document.createElement(i.nodeName),l.pmIsDeco=!0,l.appendChild(r),a=wo[0]),r=l}mk(r,a||wo[0],i)}return r}function mk(t,e,n){for(let o in e)o!="class"&&o!="style"&&o!="nodeName"&&!(o in n)&&t.removeAttribute(o);for(let o in n)o!="class"&&o!="style"&&o!="nodeName"&&n[o]!=e[o]&&t.setAttribute(o,n[o]);if(e.class!=n.class){let o=e.class?e.class.split(" ").filter(Boolean):[],r=n.class?n.class.split(" ").filter(Boolean):[];for(let s=0;s<o.length;s++)r.indexOf(o[s])==-1&&t.classList.remove(o[s]);for(let s=0;s<r.length;s++)o.indexOf(r[s])==-1&&t.classList.add(r[s]);t.classList.length==0&&t.removeAttribute("class")}if(e.style!=n.style){if(e.style){let o=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,r;for(;r=o.exec(e.style);)t.style.removeProperty(r[1])}n.style&&(t.style.cssText+=n.style)}}function Ph(t,e,n){return Th(t,t,wo,fc(e,n,t.nodeType!=1))}function xi(t,e){if(t.length!=e.length)return!1;for(let n=0;n<t.length;n++)if(!t[n].type.eq(e[n].type))return!1;return!0}function fp(t){let e=t.nextSibling;return t.parentNode.removeChild(t),e}class hk{constructor(e,n,o){this.lock=n,this.view=o,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=gk(e.node.content,e)}destroyBetween(e,n){if(e!=n){for(let o=e;o<n;o++)this.top.children[o].destroy();this.top.children.splice(e,n-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,n,o){let r=0,s=this.stack.length>>1,i=Math.min(s,e.length);for(;r<i&&(r==s-1?this.top:this.stack[r+1<<1]).matchesMark(e[r])&&e[r].type.spec.spanning!==!1;)r++;for(;r<s;)this.destroyRest(),this.top.dirty=Tt,this.index=this.stack.pop(),this.top=this.stack.pop(),s--;for(;s<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let c=this.top.children[l];if(c.matchesMark(e[s])&&!this.isLocked(c.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=Lo.create(this.top,e[s],n,o);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,s++}}findNodeMatch(e,n,o,r){let s=-1,i;if(r>=this.preMatch.index&&(i=this.preMatch.matches[r-this.preMatch.index]).parent==this.top&&i.matchesNode(e,n,o))s=this.top.children.indexOf(i,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let c=this.top.children[a];if(c.matchesNode(e,n,o)&&!this.preMatch.matched.has(c)){s=a;break}}return s<0?!1:(this.destroyBetween(this.index,s),this.index++,!0)}updateNodeAt(e,n,o,r,s){let i=this.top.children[r];return i.dirty==Zt&&i.dom==i.contentDOM&&(i.dirty=yo),i.update(e,n,o,s)?(this.destroyBetween(this.index,r),this.index++,!0):!1}findIndexWithChild(e){for(;;){let n=e.parentNode;if(!n)return-1;if(n==this.top.contentDOM){let o=e.pmViewDesc;if(o){for(let r=this.index;r<this.top.children.length;r++)if(this.top.children[r]==o)return r}return-1}e=n}}updateNextNode(e,n,o,r,s,i){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof Xn){let c=this.preMatch.matched.get(l);if(c!=null&&c!=s)return!1;let d=l.dom,u,f=this.isLocked(d)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=Zt&&xi(n,l.outerDeco));if(!f&&l.update(e,n,o,r))return this.destroyBetween(this.index,a),l.dom!=d&&(this.changed=!0),this.index++,!0;if(!f&&(u=this.recreateWrapper(l,e,n,o,r,i)))return this.destroyBetween(this.index,a),this.top.children[this.index]=u,u.contentDOM&&(u.dirty=yo,u.updateChildren(r,i+1),u.dirty=Tt),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,n,o,r,s,i){if(e.dirty||n.isAtom||!e.children.length||!e.node.content.eq(n.content)||!xi(o,e.outerDeco)||!r.eq(e.innerDeco))return null;let a=Xn.create(this.top,n,o,r,s,i);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,n,o,r,s){let i=Xn.create(this.top,e,n,o,r,s);i.contentDOM&&i.updateChildren(r,s+1),this.top.children.splice(this.index++,0,i),this.changed=!0}placeWidget(e,n,o){let r=this.index<this.top.children.length?this.top.children[this.index]:null;if(r&&r.matchesWidget(e)&&(e==r.widget||!r.widget.type.toDOM.parentNode))this.index++;else{let s=new Ah(this.top,e,n,o);this.top.children.splice(this.index++,0,s),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],n=this.top;for(;e instanceof Lo;)n=e,e=n.children[n.children.length-1];(!e||!(e instanceof Pa)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((rt||Xe)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",n),this.addHackNode("BR",this.top))}addHackNode(e,n){if(n==this.top&&this.index<n.children.length&&n.children[this.index].matchesHack(e))this.index++;else{let o=document.createElement(e);e=="IMG"&&(o.className="ProseMirror-separator",o.alt=""),e=="BR"&&(o.className="ProseMirror-trailingBreak");let r=new Nh(this.top,[],o,null);n!=this.top?n.children.push(r):n.children.splice(this.index++,0,r),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function gk(t,e){let n=e,o=n.children.length,r=t.childCount,s=new Map,i=[];e:for(;r>0;){let a;for(;;)if(o){let c=n.children[o-1];if(c instanceof Lo)n=c,o=c.children.length;else{a=c,o--;break}}else{if(n==e)break e;o=n.parent.children.indexOf(n),n=n.parent}let l=a.node;if(l){if(l!=t.child(r-1))break;--r,s.set(a,r),i.push(a)}}return{index:r,matched:s,matches:i.reverse()}}function bk(t,e){return t.type.side-e.type.side}function yk(t,e,n,o){let r=e.locals(t),s=0;if(r.length==0){for(let c=0;c<t.childCount;c++){let d=t.child(c);o(d,r,e.forChild(s,d),c),s+=d.nodeSize}return}let i=0,a=[],l=null;for(let c=0;;){let d,u;for(;i<r.length&&r[i].to==s;){let y=r[i++];y.widget&&(d?(u||(u=[d])).push(y):d=y)}if(d)if(u){u.sort(bk);for(let y=0;y<u.length;y++)n(u[y],c,!!l)}else n(d,c,!!l);let f,p;if(l)p=-1,f=l,l=null;else if(c<t.childCount)p=c,f=t.child(c++);else break;for(let y=0;y<a.length;y++)a[y].to<=s&&a.splice(y--,1);for(;i<r.length&&r[i].from<=s&&r[i].to>s;)a.push(r[i++]);let m=s+f.nodeSize;if(f.isText){let y=m;i<r.length&&r[i].from<y&&(y=r[i].from);for(let w=0;w<a.length;w++)a[w].to<y&&(y=a[w].to);y<m&&(l=f.cut(y-s),f=f.cut(0,y-s),m=y,p=-1)}else for(;i<r.length&&r[i].to<m;)i++;let b=f.isInline&&!f.isLeaf?a.filter(y=>!y.inline):a.slice();o(f,b,e.forChild(s,f),p),s=m}}function wk(t){if(t.nodeName=="UL"||t.nodeName=="OL"){let e=t.style.cssText;t.style.cssText=e+"; list-style: square !important",window.getComputedStyle(t).listStyle,t.style.cssText=e}}function vk(t,e,n,o){for(let r=0,s=0;r<t.childCount&&s<=o;){let i=t.child(r++),a=s;if(s+=i.nodeSize,!i.isText)continue;let l=i.text;for(;r<t.childCount;){let c=t.child(r++);if(s+=c.nodeSize,!c.isText)break;l+=c.text}if(s>=n){if(s>=o&&l.slice(o-e.length-a,o-a)==e)return o-e.length;let c=a<o?l.lastIndexOf(e,o-a-1):-1;if(c>=0&&c+e.length+a>=n)return a+c;if(n==o&&l.length>=o+e.length-a&&l.slice(o-a,o-a+e.length)==e)return o}}return-1}function mc(t,e,n,o,r){let s=[];for(let i=0,a=0;i<t.length;i++){let l=t[i],c=a,d=a+=l.size;c>=n||d<=e?s.push(l):(c<e&&s.push(l.slice(0,e-c,o)),r&&(s.push(r),r=void 0),d>n&&s.push(l.slice(n-c,l.size,o)))}return s}function xd(t,e=null){let n=t.domSelectionRange(),o=t.state.doc;if(!n.focusNode)return null;let r=t.docView.nearestDesc(n.focusNode),s=r&&r.size==0,i=t.docView.posFromDOM(n.focusNode,n.focusOffset,1);if(i<0)return null;let a=o.resolve(i),l,c;if(Ta(n)){for(l=i;r&&!r.node;)r=r.parent;let u=r.node;if(r&&u.isAtom&&U.isSelectable(u)&&r.parent&&!(u.isInline&&qS(n.focusNode,n.focusOffset,r.dom))){let f=r.posBefore;c=new U(i==f?a:o.resolve(f))}}else{if(n instanceof t.dom.ownerDocument.defaultView.Selection&&n.rangeCount>1){let u=i,f=i;for(let p=0;p<n.rangeCount;p++){let m=n.getRangeAt(p);u=Math.min(u,t.docView.posFromDOM(m.startContainer,m.startOffset,1)),f=Math.max(f,t.docView.posFromDOM(m.endContainer,m.endOffset,-1))}if(u<0)return null;[l,i]=f==t.state.selection.anchor?[f,u]:[u,f],a=o.resolve(i)}else l=t.docView.posFromDOM(n.anchorNode,n.anchorOffset,1);if(l<0)return null}let d=o.resolve(l);if(!c){let u=e=="pointer"||t.state.selection.head<a.pos&&!s?1:-1;c=Cd(t,d,a,u)}return c}function Bh(t){return t.editable?t.hasFocus():Lh(t)&&document.activeElement&&document.activeElement.contains(t.dom)}function xn(t,e=!1){let n=t.state.selection;if(Oh(t,n),!!Bh(t)){if(!e&&t.input.mouseDown&&t.input.mouseDown.allowDefault&&Xe){let o=t.domSelectionRange(),r=t.domObserver.currentSelection;if(o.anchorNode&&r.anchorNode&&Oo(o.anchorNode,o.anchorOffset,r.anchorNode,r.anchorOffset)){t.input.mouseDown.delayedSelectionSync=!0,t.domObserver.setCurSelection();return}}if(t.domObserver.disconnectSelection(),t.cursorWrapper)kk(t);else{let{anchor:o,head:r}=n,s,i;mp&&!(n instanceof Z)&&(n.$from.parent.inlineContent||(s=hp(t,n.from)),!n.empty&&!n.$from.parent.inlineContent&&(i=hp(t,n.to))),t.docView.setSelection(o,r,t,e),mp&&(s&&gp(s),i&&gp(i)),n.visible?t.dom.classList.remove("ProseMirror-hideselection"):(t.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&Sk(t))}t.domObserver.setCurSelection(),t.domObserver.connectSelection()}}const mp=rt||Xe&&vh<63;function hp(t,e){let{node:n,offset:o}=t.docView.domFromPos(e,0),r=o<n.childNodes.length?n.childNodes[o]:null,s=o?n.childNodes[o-1]:null;if(rt&&r&&r.contentEditable=="false")return ll(r);if((!r||r.contentEditable=="false")&&(!s||s.contentEditable=="false")){if(r)return ll(r);if(s)return ll(s)}}function ll(t){return t.contentEditable="true",rt&&t.draggable&&(t.draggable=!1,t.wasDraggable=!0),t}function gp(t){t.contentEditable="false",t.wasDraggable&&(t.draggable=!0,t.wasDraggable=null)}function Sk(t){let e=t.dom.ownerDocument;e.removeEventListener("selectionchange",t.input.hideSelectionGuard);let n=t.domSelectionRange(),o=n.anchorNode,r=n.anchorOffset;e.addEventListener("selectionchange",t.input.hideSelectionGuard=()=>{(n.anchorNode!=o||n.anchorOffset!=r)&&(e.removeEventListener("selectionchange",t.input.hideSelectionGuard),setTimeout(()=>{(!Bh(t)||t.state.selection.visible)&&t.dom.classList.remove("ProseMirror-hideselection")},20))})}function kk(t){let e=t.domSelection(),n=document.createRange();if(!e)return;let o=t.cursorWrapper.dom,r=o.nodeName=="IMG";r?n.setStart(o.parentNode,Ke(o)+1):n.setStart(o,0),n.collapse(!0),e.removeAllRanges(),e.addRange(n),!r&&!t.state.selection.visible&&ft&&Yn<=11&&(o.disabled=!0,o.disabled=!1)}function Oh(t,e){if(e instanceof U){let n=t.docView.descAt(e.from);n!=t.lastSelectedViewDesc&&(bp(t),n&&n.selectNode(),t.lastSelectedViewDesc=n)}else bp(t)}function bp(t){t.lastSelectedViewDesc&&(t.lastSelectedViewDesc.parent&&t.lastSelectedViewDesc.deselectNode(),t.lastSelectedViewDesc=void 0)}function Cd(t,e,n,o){return t.someProp("createSelectionBetween",r=>r(t,e,n))||Z.between(e,n,o)}function yp(t){return t.editable&&!t.hasFocus()?!1:Lh(t)}function Lh(t){let e=t.domSelectionRange();if(!e.anchorNode)return!1;try{return t.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(t.editable||t.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function xk(t){let e=t.docView.domFromPos(t.state.selection.anchor,0),n=t.domSelectionRange();return Oo(e.node,e.offset,n.anchorNode,n.anchorOffset)}function hc(t,e){let{$anchor:n,$head:o}=t.selection,r=e>0?n.max(o):n.min(o),s=r.parent.inlineContent?r.depth?t.doc.resolve(e>0?r.after():r.before()):null:r;return s&&ne.findFrom(s,e)}function Ln(t,e){return t.dispatch(t.state.tr.setSelection(e).scrollIntoView()),!0}function wp(t,e,n){let o=t.state.selection;if(o instanceof Z)if(n.indexOf("s")>-1){let{$head:r}=o,s=r.textOffset?null:e<0?r.nodeBefore:r.nodeAfter;if(!s||s.isText||!s.isLeaf)return!1;let i=t.state.doc.resolve(r.pos+s.nodeSize*(e<0?-1:1));return Ln(t,new Z(o.$anchor,i))}else if(o.empty){if(t.endOfTextblock(e>0?"forward":"backward")){let r=hc(t.state,e);return r&&r instanceof U?Ln(t,r):!1}else if(!(At&&n.indexOf("m")>-1)){let r=o.$head,s=r.textOffset?null:e<0?r.nodeBefore:r.nodeAfter,i;if(!s||s.isText)return!1;let a=e<0?r.pos-s.nodeSize:r.pos;return s.isAtom||(i=t.docView.descAt(a))&&!i.contentDOM?U.isSelectable(s)?Ln(t,new U(e<0?t.state.doc.resolve(r.pos-s.nodeSize):r)):ks?Ln(t,new Z(t.state.doc.resolve(e<0?a:a+s.nodeSize))):!1:!1}}else return!1;else{if(o instanceof U&&o.node.isInline)return Ln(t,new Z(e>0?o.$to:o.$from));{let r=hc(t.state,e);return r?Ln(t,r):!1}}}function Ci(t){return t.nodeType==3?t.nodeValue.length:t.childNodes.length}function Ur(t,e){let n=t.pmViewDesc;return n&&n.size==0&&(e<0||t.nextSibling||t.nodeName!="BR")}function Ho(t,e){return e<0?Ck(t):Ek(t)}function Ck(t){let e=t.domSelectionRange(),n=e.focusNode,o=e.focusOffset;if(!n)return;let r,s,i=!1;for(Wt&&n.nodeType==1&&o<Ci(n)&&Ur(n.childNodes[o],-1)&&(i=!0);;)if(o>0){if(n.nodeType!=1)break;{let a=n.childNodes[o-1];if(Ur(a,-1))r=n,s=--o;else if(a.nodeType==3)n=a,o=n.nodeValue.length;else break}}else{if(Dh(n))break;{let a=n.previousSibling;for(;a&&Ur(a,-1);)r=n.parentNode,s=Ke(a),a=a.previousSibling;if(a)n=a,o=Ci(n);else{if(n=n.parentNode,n==t.dom)break;o=0}}}i?gc(t,n,o):r&&gc(t,r,s)}function Ek(t){let e=t.domSelectionRange(),n=e.focusNode,o=e.focusOffset;if(!n)return;let r=Ci(n),s,i;for(;;)if(o<r){if(n.nodeType!=1)break;let a=n.childNodes[o];if(Ur(a,1))s=n,i=++o;else break}else{if(Dh(n))break;{let a=n.nextSibling;for(;a&&Ur(a,1);)s=a.parentNode,i=Ke(a)+1,a=a.nextSibling;if(a)n=a,o=0,r=Ci(n);else{if(n=n.parentNode,n==t.dom)break;o=r=0}}}s&&gc(t,s,i)}function Dh(t){let e=t.pmViewDesc;return e&&e.node&&e.node.isBlock}function Ik(t,e){for(;t&&e==t.childNodes.length&&!Ss(t);)e=Ke(t)+1,t=t.parentNode;for(;t&&e<t.childNodes.length;){let n=t.childNodes[e];if(n.nodeType==3)return n;if(n.nodeType==1&&n.contentEditable=="false")break;t=n,e=0}}function Ak(t,e){for(;t&&!e&&!Ss(t);)e=Ke(t),t=t.parentNode;for(;t&&e;){let n=t.childNodes[e-1];if(n.nodeType==3)return n;if(n.nodeType==1&&n.contentEditable=="false")break;t=n,e=t.childNodes.length}}function gc(t,e,n){if(e.nodeType!=3){let s,i;(i=Ik(e,n))?(e=i,n=0):(s=Ak(e,n))&&(e=s,n=s.nodeValue.length)}let o=t.domSelection();if(!o)return;if(Ta(o)){let s=document.createRange();s.setEnd(e,n),s.setStart(e,n),o.removeAllRanges(),o.addRange(s)}else o.extend&&o.extend(e,n);t.domObserver.setCurSelection();let{state:r}=t;setTimeout(()=>{t.state==r&&xn(t)},50)}function vp(t,e){let n=t.state.doc.resolve(e);if(!(Xe||JS)&&n.parent.inlineContent){let r=t.coordsAtPos(e);if(e>n.start()){let s=t.coordsAtPos(e-1),i=(s.top+s.bottom)/2;if(i>r.top&&i<r.bottom&&Math.abs(s.left-r.left)>1)return s.left<r.left?"ltr":"rtl"}if(e<n.end()){let s=t.coordsAtPos(e+1),i=(s.top+s.bottom)/2;if(i>r.top&&i<r.bottom&&Math.abs(s.left-r.left)>1)return s.left>r.left?"ltr":"rtl"}}return getComputedStyle(t.dom).direction=="rtl"?"rtl":"ltr"}function Sp(t,e,n){let o=t.state.selection;if(o instanceof Z&&!o.empty||n.indexOf("s")>-1||At&&n.indexOf("m")>-1)return!1;let{$from:r,$to:s}=o;if(!r.parent.inlineContent||t.endOfTextblock(e<0?"up":"down")){let i=hc(t.state,e);if(i&&i instanceof U)return Ln(t,i)}if(!r.parent.inlineContent){let i=e<0?r:s,a=o instanceof St?ne.near(i,e):ne.findFrom(i,e);return a?Ln(t,a):!1}return!1}function kp(t,e){if(!(t.state.selection instanceof Z))return!0;let{$head:n,$anchor:o,empty:r}=t.state.selection;if(!n.sameParent(o))return!0;if(!r)return!1;if(t.endOfTextblock(e>0?"forward":"backward"))return!0;let s=!n.textOffset&&(e<0?n.nodeBefore:n.nodeAfter);if(s&&!s.isText){let i=t.state.tr;return e<0?i.delete(n.pos-s.nodeSize,n.pos):i.delete(n.pos,n.pos+s.nodeSize),t.dispatch(i),!0}return!1}function xp(t,e,n){t.domObserver.stop(),e.contentEditable=n,t.domObserver.start()}function Nk(t){if(!rt||t.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:n}=t.domSelectionRange();if(e&&e.nodeType==1&&n==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let o=e.firstChild;xp(t,o,"true"),setTimeout(()=>xp(t,o,"false"),20)}return!1}function Mk(t){let e="";return t.ctrlKey&&(e+="c"),t.metaKey&&(e+="m"),t.altKey&&(e+="a"),t.shiftKey&&(e+="s"),e}function Tk(t,e){let n=e.keyCode,o=Mk(e);if(n==8||At&&n==72&&o=="c")return kp(t,-1)||Ho(t,-1);if(n==46&&!e.shiftKey||At&&n==68&&o=="c")return kp(t,1)||Ho(t,1);if(n==13||n==27)return!0;if(n==37||At&&n==66&&o=="c"){let r=n==37?vp(t,t.state.selection.from)=="ltr"?-1:1:-1;return wp(t,r,o)||Ho(t,r)}else if(n==39||At&&n==70&&o=="c"){let r=n==39?vp(t,t.state.selection.from)=="ltr"?1:-1:1;return wp(t,r,o)||Ho(t,r)}else{if(n==38||At&&n==80&&o=="c")return Sp(t,-1,o)||Ho(t,-1);if(n==40||At&&n==78&&o=="c")return Nk(t)||Sp(t,1,o)||Ho(t,1);if(o==(At?"m":"c")&&(n==66||n==73||n==89||n==90))return!0}return!1}function Ed(t,e){t.someProp("transformCopied",p=>{e=p(e,t)});let n=[],{content:o,openStart:r,openEnd:s}=e;for(;r>1&&s>1&&o.childCount==1&&o.firstChild.childCount==1;){r--,s--;let p=o.firstChild;n.push(p.type.name,p.attrs!=p.type.defaultAttrs?p.attrs:null),o=p.content}let i=t.someProp("clipboardSerializer")||$o.fromSchema(t.state.schema),a=Wh(),l=a.createElement("div");l.appendChild(i.serializeFragment(o,{document:a}));let c=l.firstChild,d,u=0;for(;c&&c.nodeType==1&&(d=Fh[c.nodeName.toLowerCase()]);){for(let p=d.length-1;p>=0;p--){let m=a.createElement(d[p]);for(;l.firstChild;)m.appendChild(l.firstChild);l.appendChild(m),u++}c=l.firstChild}c&&c.nodeType==1&&c.setAttribute("data-pm-slice",`${r} ${s}${u?` -${u}`:""} ${JSON.stringify(n)}`);let f=t.someProp("clipboardTextSerializer",p=>p(e,t))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:f,slice:e}}function Rh(t,e,n,o,r){let s=r.parent.type.spec.code,i,a;if(!n&&!e)return null;let l=e&&(o||s||!n);if(l){if(t.someProp("transformPastedText",f=>{e=f(e,s||o,t)}),s)return e?new R(M.from(t.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0):R.empty;let u=t.someProp("clipboardTextParser",f=>f(e,r,o,t));if(u)a=u;else{let f=r.marks(),{schema:p}=t.state,m=$o.fromSchema(p);i=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(b=>{let y=i.appendChild(document.createElement("p"));b&&y.appendChild(m.serializeNode(p.text(b,f)))})}}else t.someProp("transformPastedHTML",u=>{n=u(n,t)}),i=Lk(n),ks&&Dk(i);let c=i&&i.querySelector("[data-pm-slice]"),d=c&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(c.getAttribute("data-pm-slice")||"");if(d&&d[3])for(let u=+d[3];u>0;u--){let f=i.firstChild;for(;f&&f.nodeType!=1;)f=f.nextSibling;if(!f)break;i=f}if(a||(a=(t.someProp("clipboardParser")||t.someProp("domParser")||Jn.fromSchema(t.state.schema)).parseSlice(i,{preserveWhitespace:!!(l||d),context:r,ruleFromNode(f){return f.nodeName=="BR"&&!f.nextSibling&&f.parentNode&&!Pk.test(f.parentNode.nodeName)?{ignore:!0}:null}})),d)a=Rk(Cp(a,+d[1],+d[2]),d[4]);else if(a=R.maxOpen(Bk(a.content,r),!0),a.openStart||a.openEnd){let u=0,f=0;for(let p=a.content.firstChild;u<a.openStart&&!p.type.spec.isolating;u++,p=p.firstChild);for(let p=a.content.lastChild;f<a.openEnd&&!p.type.spec.isolating;f++,p=p.lastChild);a=Cp(a,u,f)}return t.someProp("transformPasted",u=>{a=u(a,t)}),a}const Pk=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function Bk(t,e){if(t.childCount<2)return t;for(let n=e.depth;n>=0;n--){let r=e.node(n).contentMatchAt(e.index(n)),s,i=[];if(t.forEach(a=>{if(!i)return;let l=r.findWrapping(a.type),c;if(!l)return i=null;if(c=i.length&&s.length&&_h(l,s,a,i[i.length-1],0))i[i.length-1]=c;else{i.length&&(i[i.length-1]=$h(i[i.length-1],s.length));let d=jh(a,l);i.push(d),r=r.matchType(d.type),s=l}}),i)return M.from(i)}return t}function jh(t,e,n=0){for(let o=e.length-1;o>=n;o--)t=e[o].create(null,M.from(t));return t}function _h(t,e,n,o,r){if(r<t.length&&r<e.length&&t[r]==e[r]){let s=_h(t,e,n,o.lastChild,r+1);if(s)return o.copy(o.content.replaceChild(o.childCount-1,s));if(o.contentMatchAt(o.childCount).matchType(r==t.length-1?n.type:t[r+1]))return o.copy(o.content.append(M.from(jh(n,t,r+1))))}}function $h(t,e){if(e==0)return t;let n=t.content.replaceChild(t.childCount-1,$h(t.lastChild,e-1)),o=t.contentMatchAt(t.childCount).fillBefore(M.empty,!0);return t.copy(n.append(o))}function bc(t,e,n,o,r,s){let i=e<0?t.firstChild:t.lastChild,a=i.content;return t.childCount>1&&(s=0),r<o-1&&(a=bc(a,e,n,o,r+1,s)),r>=n&&(a=e<0?i.contentMatchAt(0).fillBefore(a,s<=r).append(a):a.append(i.contentMatchAt(i.childCount).fillBefore(M.empty,!0))),t.replaceChild(e<0?0:t.childCount-1,i.copy(a))}function Cp(t,e,n){return e<t.openStart&&(t=new R(bc(t.content,-1,e,t.openStart,0,t.openEnd),e,t.openEnd)),n<t.openEnd&&(t=new R(bc(t.content,1,n,t.openEnd,0,0),t.openStart,n)),t}const Fh={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let Ep=null;function Wh(){return Ep||(Ep=document.implementation.createHTMLDocument("title"))}let cl=null;function Ok(t){let e=window.trustedTypes;return e?(cl||(cl=e.defaultPolicy||e.createPolicy("ProseMirrorClipboard",{createHTML:n=>n})),cl.createHTML(t)):t}function Lk(t){let e=/^(\s*<meta [^>]*>)*/.exec(t);e&&(t=t.slice(e[0].length));let n=Wh().createElement("div"),o=/<([a-z][^>\s]+)/i.exec(t),r;if((r=o&&Fh[o[1].toLowerCase()])&&(t=r.map(s=>"<"+s+">").join("")+t+r.map(s=>"</"+s+">").reverse().join("")),n.innerHTML=Ok(t),r)for(let s=0;s<r.length;s++)n=n.querySelector(r[s])||n;return n}function Dk(t){let e=t.querySelectorAll(Xe?"span:not([class]):not([style])":"span.Apple-converted-space");for(let n=0;n<e.length;n++){let o=e[n];o.childNodes.length==1&&o.textContent=="Â "&&o.parentNode&&o.parentNode.replaceChild(t.ownerDocument.createTextNode(" "),o)}}function Rk(t,e){if(!t.size)return t;let n=t.content.firstChild.type.schema,o;try{o=JSON.parse(e)}catch{return t}let{content:r,openStart:s,openEnd:i}=t;for(let a=o.length-2;a>=0;a-=2){let l=n.nodes[o[a]];if(!l||l.hasRequiredAttrs())break;r=M.from(l.create(o[a+1],r)),s++,i++}return new R(r,s,i)}const st={},it={},jk={touchstart:!0,touchmove:!0};class _k{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:"",button:0},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastChromeDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function $k(t){for(let e in st){let n=st[e];t.dom.addEventListener(e,t.input.eventHandlers[e]=o=>{Wk(t,o)&&!Id(t,o)&&(t.editable||!(o.type in it))&&n(t,o)},jk[e]?{passive:!0}:void 0)}rt&&t.dom.addEventListener("input",()=>null),yc(t)}function Un(t,e){t.input.lastSelectionOrigin=e,t.input.lastSelectionTime=Date.now()}function Fk(t){t.domObserver.stop();for(let e in t.input.eventHandlers)t.dom.removeEventListener(e,t.input.eventHandlers[e]);clearTimeout(t.input.composingTimeout),clearTimeout(t.input.lastIOSEnterFallbackTimeout)}function yc(t){t.someProp("handleDOMEvents",e=>{for(let n in e)t.input.eventHandlers[n]||t.dom.addEventListener(n,t.input.eventHandlers[n]=o=>Id(t,o))})}function Id(t,e){return t.someProp("handleDOMEvents",n=>{let o=n[e.type];return o?o(t,e)||e.defaultPrevented:!1})}function Wk(t,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let n=e.target;n!=t.dom;n=n.parentNode)if(!n||n.nodeType==11||n.pmViewDesc&&n.pmViewDesc.stopEvent(e))return!1;return!0}function zk(t,e){!Id(t,e)&&st[e.type]&&(t.editable||!(e.type in it))&&st[e.type](t,e)}it.keydown=(t,e)=>{let n=e;if(t.input.shiftKey=n.keyCode==16||n.shiftKey,!Hh(t,n)&&(t.input.lastKeyCode=n.keyCode,t.input.lastKeyCodeTime=Date.now(),!(vn&&Xe&&n.keyCode==13)))if(n.keyCode!=229&&t.domObserver.forceFlush(),pr&&n.keyCode==13&&!n.ctrlKey&&!n.altKey&&!n.metaKey){let o=Date.now();t.input.lastIOSEnter=o,t.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{t.input.lastIOSEnter==o&&(t.someProp("handleKeyDown",r=>r(t,go(13,"Enter"))),t.input.lastIOSEnter=0)},200)}else t.someProp("handleKeyDown",o=>o(t,n))||Tk(t,n)?n.preventDefault():Un(t,"key")};it.keyup=(t,e)=>{e.keyCode==16&&(t.input.shiftKey=!1)};it.keypress=(t,e)=>{let n=e;if(Hh(t,n)||!n.charCode||n.ctrlKey&&!n.altKey||At&&n.metaKey)return;if(t.someProp("handleKeyPress",r=>r(t,n))){n.preventDefault();return}let o=t.state.selection;if(!(o instanceof Z)||!o.$from.sameParent(o.$to)){let r=String.fromCharCode(n.charCode),s=()=>t.state.tr.insertText(r).scrollIntoView();!/[\r\n]/.test(r)&&!t.someProp("handleTextInput",i=>i(t,o.$from.pos,o.$to.pos,r,s))&&t.dispatch(s()),n.preventDefault()}};function Ba(t){return{left:t.clientX,top:t.clientY}}function Hk(t,e){let n=e.x-t.clientX,o=e.y-t.clientY;return n*n+o*o<100}function Ad(t,e,n,o,r){if(o==-1)return!1;let s=t.state.doc.resolve(o);for(let i=s.depth+1;i>0;i--)if(t.someProp(e,a=>i>s.depth?a(t,n,s.nodeAfter,s.before(i),r,!0):a(t,n,s.node(i),s.before(i),r,!1)))return!0;return!1}function ar(t,e,n){if(t.focused||t.focus(),t.state.selection.eq(e))return;let o=t.state.tr.setSelection(e);o.setMeta("pointer",!0),t.dispatch(o)}function Uk(t,e){if(e==-1)return!1;let n=t.state.doc.resolve(e),o=n.nodeAfter;return o&&o.isAtom&&U.isSelectable(o)?(ar(t,new U(n)),!0):!1}function Vk(t,e){if(e==-1)return!1;let n=t.state.selection,o,r;n instanceof U&&(o=n.node);let s=t.state.doc.resolve(e);for(let i=s.depth+1;i>0;i--){let a=i>s.depth?s.nodeAfter:s.node(i);if(U.isSelectable(a)){o&&n.$from.depth>0&&i>=n.$from.depth&&s.before(n.$from.depth+1)==n.$from.pos?r=s.before(n.$from.depth):r=s.before(i);break}}return r!=null?(ar(t,U.create(t.state.doc,r)),!0):!1}function qk(t,e,n,o,r){return Ad(t,"handleClickOn",e,n,o)||t.someProp("handleClick",s=>s(t,e,o))||(r?Vk(t,n):Uk(t,n))}function Kk(t,e,n,o){return Ad(t,"handleDoubleClickOn",e,n,o)||t.someProp("handleDoubleClick",r=>r(t,e,o))}function Gk(t,e,n,o){return Ad(t,"handleTripleClickOn",e,n,o)||t.someProp("handleTripleClick",r=>r(t,e,o))||Jk(t,n,o)}function Jk(t,e,n){if(n.button!=0)return!1;let o=t.state.doc;if(e==-1)return o.inlineContent?(ar(t,Z.create(o,0,o.content.size)),!0):!1;let r=o.resolve(e);for(let s=r.depth+1;s>0;s--){let i=s>r.depth?r.nodeAfter:r.node(s),a=r.before(s);if(i.inlineContent)ar(t,Z.create(o,a+1,a+1+i.content.size));else if(U.isSelectable(i))ar(t,U.create(o,a));else continue;return!0}}function Nd(t){return Ei(t)}const zh=At?"metaKey":"ctrlKey";st.mousedown=(t,e)=>{let n=e;t.input.shiftKey=n.shiftKey;let o=Nd(t),r=Date.now(),s="singleClick";r-t.input.lastClick.time<500&&Hk(n,t.input.lastClick)&&!n[zh]&&t.input.lastClick.button==n.button&&(t.input.lastClick.type=="singleClick"?s="doubleClick":t.input.lastClick.type=="doubleClick"&&(s="tripleClick")),t.input.lastClick={time:r,x:n.clientX,y:n.clientY,type:s,button:n.button};let i=t.posAtCoords(Ba(n));i&&(s=="singleClick"?(t.input.mouseDown&&t.input.mouseDown.done(),t.input.mouseDown=new Yk(t,i,n,!!o)):(s=="doubleClick"?Kk:Gk)(t,i.pos,i.inside,n)?n.preventDefault():Un(t,"pointer"))};class Yk{constructor(e,n,o,r){this.view=e,this.pos=n,this.event=o,this.flushed=r,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!o[zh],this.allowDefault=o.shiftKey;let s,i;if(n.inside>-1)s=e.state.doc.nodeAt(n.inside),i=n.inside;else{let d=e.state.doc.resolve(n.pos);s=d.parent,i=d.depth?d.before():0}const a=r?null:o.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.dom.nodeType==1?l.dom:null;let{selection:c}=e.state;(o.button==0&&s.type.spec.draggable&&s.type.spec.selectable!==!1||c instanceof U&&c.from<=i&&c.to>i)&&(this.mightDrag={node:s,pos:i,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&Wt&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),Un(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>xn(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let n=this.pos;this.view.state.doc!=this.startDoc&&(n=this.view.posAtCoords(Ba(e))),this.updateAllowDefault(e),this.allowDefault||!n?Un(this.view,"pointer"):qk(this.view,n.pos,n.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||rt&&this.mightDrag&&!this.mightDrag.node.isAtom||Xe&&!this.view.state.selection.visible&&Math.min(Math.abs(n.pos-this.view.state.selection.from),Math.abs(n.pos-this.view.state.selection.to))<=2)?(ar(this.view,ne.near(this.view.state.doc.resolve(n.pos))),e.preventDefault()):Un(this.view,"pointer")}move(e){this.updateAllowDefault(e),Un(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}st.touchstart=t=>{t.input.lastTouch=Date.now(),Nd(t),Un(t,"pointer")};st.touchmove=t=>{t.input.lastTouch=Date.now(),Un(t,"pointer")};st.contextmenu=t=>Nd(t);function Hh(t,e){return t.composing?!0:rt&&Math.abs(e.timeStamp-t.input.compositionEndedAt)<500?(t.input.compositionEndedAt=-2e8,!0):!1}const Xk=vn?5e3:-1;it.compositionstart=it.compositionupdate=t=>{if(!t.composing){t.domObserver.flush();let{state:e}=t,n=e.selection.$to;if(e.selection instanceof Z&&(e.storedMarks||!n.textOffset&&n.parentOffset&&n.nodeBefore.marks.some(o=>o.type.spec.inclusive===!1)))t.markCursor=t.state.storedMarks||n.marks(),Ei(t,!0),t.markCursor=null;else if(Ei(t,!e.selection.empty),Wt&&e.selection.empty&&n.parentOffset&&!n.textOffset&&n.nodeBefore.marks.length){let o=t.domSelectionRange();for(let r=o.focusNode,s=o.focusOffset;r&&r.nodeType==1&&s!=0;){let i=s<0?r.lastChild:r.childNodes[s-1];if(!i)break;if(i.nodeType==3){let a=t.domSelection();a&&a.collapse(i,i.nodeValue.length);break}else r=i,s=-1}}t.input.composing=!0}Uh(t,Xk)};it.compositionend=(t,e)=>{t.composing&&(t.input.composing=!1,t.input.compositionEndedAt=e.timeStamp,t.input.compositionPendingChanges=t.domObserver.pendingRecords().length?t.input.compositionID:0,t.input.compositionNode=null,t.input.compositionPendingChanges&&Promise.resolve().then(()=>t.domObserver.flush()),t.input.compositionID++,Uh(t,20))};function Uh(t,e){clearTimeout(t.input.composingTimeout),e>-1&&(t.input.composingTimeout=setTimeout(()=>Ei(t),e))}function Vh(t){for(t.composing&&(t.input.composing=!1,t.input.compositionEndedAt=Zk());t.input.compositionNodes.length>0;)t.input.compositionNodes.pop().markParentsDirty()}function Qk(t){let e=t.domSelectionRange();if(!e.focusNode)return null;let n=US(e.focusNode,e.focusOffset),o=VS(e.focusNode,e.focusOffset);if(n&&o&&n!=o){let r=o.pmViewDesc,s=t.domObserver.lastChangedTextNode;if(n==s||o==s)return s;if(!r||!r.isText(o.nodeValue))return o;if(t.input.compositionNode==o){let i=n.pmViewDesc;if(!(!i||!i.isText(n.nodeValue)))return o}}return n||o}function Zk(){let t=document.createEvent("Event");return t.initEvent("event",!0,!0),t.timeStamp}function Ei(t,e=!1){if(!(vn&&t.domObserver.flushingSoon>=0)){if(t.domObserver.forceFlush(),Vh(t),e||t.docView&&t.docView.dirty){let n=xd(t),o=t.state.selection;return n&&!n.eq(o)?t.dispatch(t.state.tr.setSelection(n)):(t.markCursor||e)&&!o.$from.node(o.$from.sharedDepth(o.to)).inlineContent?t.dispatch(t.state.tr.deleteSelection()):t.updateState(t.state),!0}return!1}}function ex(t,e){if(!t.dom.parentNode)return;let n=t.dom.parentNode.appendChild(document.createElement("div"));n.appendChild(e),n.style.cssText="position: fixed; left: -10000px; top: 10px";let o=getSelection(),r=document.createRange();r.selectNodeContents(e),t.dom.blur(),o.removeAllRanges(),o.addRange(r),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n),t.focus()},50)}const ps=ft&&Yn<15||pr&&YS<604;st.copy=it.cut=(t,e)=>{let n=e,o=t.state.selection,r=n.type=="cut";if(o.empty)return;let s=ps?null:n.clipboardData,i=o.content(),{dom:a,text:l}=Ed(t,i);s?(n.preventDefault(),s.clearData(),s.setData("text/html",a.innerHTML),s.setData("text/plain",l)):ex(t,a),r&&t.dispatch(t.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function tx(t){return t.openStart==0&&t.openEnd==0&&t.content.childCount==1?t.content.firstChild:null}function nx(t,e){if(!t.dom.parentNode)return;let n=t.input.shiftKey||t.state.selection.$from.parent.type.spec.code,o=t.dom.parentNode.appendChild(document.createElement(n?"textarea":"div"));n||(o.contentEditable="true"),o.style.cssText="position: fixed; left: -10000px; top: 10px",o.focus();let r=t.input.shiftKey&&t.input.lastKeyCode!=45;setTimeout(()=>{t.focus(),o.parentNode&&o.parentNode.removeChild(o),n?fs(t,o.value,null,r,e):fs(t,o.textContent,o.innerHTML,r,e)},50)}function fs(t,e,n,o,r){let s=Rh(t,e,n,o,t.state.selection.$from);if(t.someProp("handlePaste",l=>l(t,r,s||R.empty)))return!0;if(!s)return!1;let i=tx(s),a=i?t.state.tr.replaceSelectionWith(i,o):t.state.tr.replaceSelection(s);return t.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function qh(t){let e=t.getData("text/plain")||t.getData("Text");if(e)return e;let n=t.getData("text/uri-list");return n?n.replace(/\r?\n/g," "):""}it.paste=(t,e)=>{let n=e;if(t.composing&&!vn)return;let o=ps?null:n.clipboardData,r=t.input.shiftKey&&t.input.lastKeyCode!=45;o&&fs(t,qh(o),o.getData("text/html"),r,n)?n.preventDefault():nx(t,n)};class Kh{constructor(e,n,o){this.slice=e,this.move=n,this.node=o}}const ox=At?"altKey":"ctrlKey";function Gh(t,e){let n=t.someProp("dragCopies",o=>!o(e));return n??!e[ox]}st.dragstart=(t,e)=>{let n=e,o=t.input.mouseDown;if(o&&o.done(),!n.dataTransfer)return;let r=t.state.selection,s=r.empty?null:t.posAtCoords(Ba(n)),i;if(!(s&&s.pos>=r.from&&s.pos<=(r instanceof U?r.to-1:r.to))){if(o&&o.mightDrag)i=U.create(t.state.doc,o.mightDrag.pos);else if(n.target&&n.target.nodeType==1){let u=t.docView.nearestDesc(n.target,!0);u&&u.node.type.spec.draggable&&u!=t.docView&&(i=U.create(t.state.doc,u.posBefore))}}let a=(i||t.state.selection).content(),{dom:l,text:c,slice:d}=Ed(t,a);(!n.dataTransfer.files.length||!Xe||vh>120)&&n.dataTransfer.clearData(),n.dataTransfer.setData(ps?"Text":"text/html",l.innerHTML),n.dataTransfer.effectAllowed="copyMove",ps||n.dataTransfer.setData("text/plain",c),t.dragging=new Kh(d,Gh(t,n),i)};st.dragend=t=>{let e=t.dragging;window.setTimeout(()=>{t.dragging==e&&(t.dragging=null)},50)};it.dragover=it.dragenter=(t,e)=>e.preventDefault();it.drop=(t,e)=>{let n=e,o=t.dragging;if(t.dragging=null,!n.dataTransfer)return;let r=t.posAtCoords(Ba(n));if(!r)return;let s=t.state.doc.resolve(r.pos),i=o&&o.slice;i?t.someProp("transformPasted",m=>{i=m(i,t)}):i=Rh(t,qh(n.dataTransfer),ps?null:n.dataTransfer.getData("text/html"),!1,s);let a=!!(o&&Gh(t,n));if(t.someProp("handleDrop",m=>m(t,n,i||R.empty,a))){n.preventDefault();return}if(!i)return;n.preventDefault();let l=i?uh(t.state.doc,s.pos,i):s.pos;l==null&&(l=s.pos);let c=t.state.tr;if(a){let{node:m}=o;m?m.replace(c):c.deleteSelection()}let d=c.mapping.map(l),u=i.openStart==0&&i.openEnd==0&&i.content.childCount==1,f=c.doc;if(u?c.replaceRangeWith(d,d,i.content.firstChild):c.replaceRange(d,d,i),c.doc.eq(f))return;let p=c.doc.resolve(d);if(u&&U.isSelectable(i.content.firstChild)&&p.nodeAfter&&p.nodeAfter.sameMarkup(i.content.firstChild))c.setSelection(new U(p));else{let m=c.mapping.map(l);c.mapping.maps[c.mapping.maps.length-1].forEach((b,y,w,v)=>m=v),c.setSelection(Cd(t,p,c.doc.resolve(m)))}t.focus(),t.dispatch(c.setMeta("uiEvent","drop"))};st.focus=t=>{t.input.lastFocus=Date.now(),t.focused||(t.domObserver.stop(),t.dom.classList.add("ProseMirror-focused"),t.domObserver.start(),t.focused=!0,setTimeout(()=>{t.docView&&t.hasFocus()&&!t.domObserver.currentSelection.eq(t.domSelectionRange())&&xn(t)},20))};st.blur=(t,e)=>{let n=e;t.focused&&(t.domObserver.stop(),t.dom.classList.remove("ProseMirror-focused"),t.domObserver.start(),n.relatedTarget&&t.dom.contains(n.relatedTarget)&&t.domObserver.currentSelection.clear(),t.focused=!1)};st.beforeinput=(t,e)=>{if(Xe&&vn&&e.inputType=="deleteContentBackward"){t.domObserver.flushSoon();let{domChangeCount:o}=t.input;setTimeout(()=>{if(t.input.domChangeCount!=o||(t.dom.blur(),t.focus(),t.someProp("handleKeyDown",s=>s(t,go(8,"Backspace")))))return;let{$cursor:r}=t.state.selection;r&&r.pos>0&&t.dispatch(t.state.tr.delete(r.pos-1,r.pos).scrollIntoView())},50)}};for(let t in it)st[t]=it[t];function ms(t,e){if(t==e)return!0;for(let n in t)if(t[n]!==e[n])return!1;for(let n in e)if(!(n in t))return!1;return!0}class Ii{constructor(e,n){this.toDOM=e,this.spec=n||Eo,this.side=this.spec.side||0}map(e,n,o,r){let{pos:s,deleted:i}=e.mapResult(n.from+r,this.side<0?-1:1);return i?null:new nt(s-o,s-o,this)}valid(){return!0}eq(e){return this==e||e instanceof Ii&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&ms(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class Qn{constructor(e,n){this.attrs=e,this.spec=n||Eo}map(e,n,o,r){let s=e.map(n.from+r,this.spec.inclusiveStart?-1:1)-o,i=e.map(n.to+r,this.spec.inclusiveEnd?1:-1)-o;return s>=i?null:new nt(s,i,this)}valid(e,n){return n.from<n.to}eq(e){return this==e||e instanceof Qn&&ms(this.attrs,e.attrs)&&ms(this.spec,e.spec)}static is(e){return e.type instanceof Qn}destroy(){}}class Md{constructor(e,n){this.attrs=e,this.spec=n||Eo}map(e,n,o,r){let s=e.mapResult(n.from+r,1);if(s.deleted)return null;let i=e.mapResult(n.to+r,-1);return i.deleted||i.pos<=s.pos?null:new nt(s.pos-o,i.pos-o,this)}valid(e,n){let{index:o,offset:r}=e.content.findIndex(n.from),s;return r==n.from&&!(s=e.child(o)).isText&&r+s.nodeSize==n.to}eq(e){return this==e||e instanceof Md&&ms(this.attrs,e.attrs)&&ms(this.spec,e.spec)}destroy(){}}class nt{constructor(e,n,o){this.from=e,this.to=n,this.type=o}copy(e,n){return new nt(e,n,this.type)}eq(e,n=0){return this.type.eq(e.type)&&this.from+n==e.from&&this.to+n==e.to}map(e,n,o){return this.type.map(e,this,n,o)}static widget(e,n,o){return new nt(e,e,new Ii(n,o))}static inline(e,n,o,r){return new nt(e,n,new Qn(o,r))}static node(e,n,o,r){return new nt(e,n,new Md(o,r))}get spec(){return this.type.spec}get inline(){return this.type instanceof Qn}get widget(){return this.type instanceof Ii}}const Qo=[],Eo={};class Ne{constructor(e,n){this.local=e.length?e:Qo,this.children=n.length?n:Qo}static create(e,n){return n.length?Ai(n,e,0,Eo):Ye}find(e,n,o){let r=[];return this.findInner(e??0,n??1e9,r,0,o),r}findInner(e,n,o,r,s){for(let i=0;i<this.local.length;i++){let a=this.local[i];a.from<=n&&a.to>=e&&(!s||s(a.spec))&&o.push(a.copy(a.from+r,a.to+r))}for(let i=0;i<this.children.length;i+=3)if(this.children[i]<n&&this.children[i+1]>e){let a=this.children[i]+1;this.children[i+2].findInner(e-a,n-a,o,r+a,s)}}map(e,n,o){return this==Ye||e.maps.length==0?this:this.mapInner(e,n,0,0,o||Eo)}mapInner(e,n,o,r,s){let i;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,o,r);l&&l.type.valid(n,l)?(i||(i=[])).push(l):s.onRemove&&s.onRemove(this.local[a].spec)}return this.children.length?rx(this.children,i||[],e,n,o,r,s):i?new Ne(i.sort(Io),Qo):Ye}add(e,n){return n.length?this==Ye?Ne.create(e,n):this.addInner(e,n,0):this}addInner(e,n,o){let r,s=0;e.forEach((a,l)=>{let c=l+o,d;if(d=Yh(n,a,c)){for(r||(r=this.children.slice());s<r.length&&r[s]<l;)s+=3;r[s]==l?r[s+2]=r[s+2].addInner(a,d,c+1):r.splice(s,0,l,l+a.nodeSize,Ai(d,a,c+1,Eo)),s+=3}});let i=Jh(s?Xh(n):n,-o);for(let a=0;a<i.length;a++)i[a].type.valid(e,i[a])||i.splice(a--,1);return new Ne(i.length?this.local.concat(i).sort(Io):this.local,r||this.children)}remove(e){return e.length==0||this==Ye?this:this.removeInner(e,0)}removeInner(e,n){let o=this.children,r=this.local;for(let s=0;s<o.length;s+=3){let i,a=o[s]+n,l=o[s+1]+n;for(let d=0,u;d<e.length;d++)(u=e[d])&&u.from>a&&u.to<l&&(e[d]=null,(i||(i=[])).push(u));if(!i)continue;o==this.children&&(o=this.children.slice());let c=o[s+2].removeInner(i,a+1);c!=Ye?o[s+2]=c:(o.splice(s,3),s-=3)}if(r.length){for(let s=0,i;s<e.length;s++)if(i=e[s])for(let a=0;a<r.length;a++)r[a].eq(i,n)&&(r==this.local&&(r=this.local.slice()),r.splice(a--,1))}return o==this.children&&r==this.local?this:r.length||o.length?new Ne(r,o):Ye}forChild(e,n){if(this==Ye)return this;if(n.isLeaf)return Ne.empty;let o,r;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(o=this.children[a+2]);break}let s=e+1,i=s+n.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<i&&l.to>s&&l.type instanceof Qn){let c=Math.max(s,l.from)-s,d=Math.min(i,l.to)-s;c<d&&(r||(r=[])).push(l.copy(c,d))}}if(r){let a=new Ne(r.sort(Io),Qo);return o?new $n([a,o]):a}return o||Ye}eq(e){if(this==e)return!0;if(!(e instanceof Ne)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let n=0;n<this.local.length;n++)if(!this.local[n].eq(e.local[n]))return!1;for(let n=0;n<this.children.length;n+=3)if(this.children[n]!=e.children[n]||this.children[n+1]!=e.children[n+1]||!this.children[n+2].eq(e.children[n+2]))return!1;return!0}locals(e){return Td(this.localsInner(e))}localsInner(e){if(this==Ye)return Qo;if(e.inlineContent||!this.local.some(Qn.is))return this.local;let n=[];for(let o=0;o<this.local.length;o++)this.local[o].type instanceof Qn||n.push(this.local[o]);return n}forEachSet(e){e(this)}}Ne.empty=new Ne([],[]);Ne.removeOverlap=Td;const Ye=Ne.empty;class $n{constructor(e){this.members=e}map(e,n){const o=this.members.map(r=>r.map(e,n,Eo));return $n.from(o)}forChild(e,n){if(n.isLeaf)return Ne.empty;let o=[];for(let r=0;r<this.members.length;r++){let s=this.members[r].forChild(e,n);s!=Ye&&(s instanceof $n?o=o.concat(s.members):o.push(s))}return $n.from(o)}eq(e){if(!(e instanceof $n)||e.members.length!=this.members.length)return!1;for(let n=0;n<this.members.length;n++)if(!this.members[n].eq(e.members[n]))return!1;return!0}locals(e){let n,o=!0;for(let r=0;r<this.members.length;r++){let s=this.members[r].localsInner(e);if(s.length)if(!n)n=s;else{o&&(n=n.slice(),o=!1);for(let i=0;i<s.length;i++)n.push(s[i])}}return n?Td(o?n:n.sort(Io)):Qo}static from(e){switch(e.length){case 0:return Ye;case 1:return e[0];default:return new $n(e.every(n=>n instanceof Ne)?e:e.reduce((n,o)=>n.concat(o instanceof Ne?o:o.members),[]))}}forEachSet(e){for(let n=0;n<this.members.length;n++)this.members[n].forEachSet(e)}}function rx(t,e,n,o,r,s,i){let a=t.slice();for(let c=0,d=s;c<n.maps.length;c++){let u=0;n.maps[c].forEach((f,p,m,b)=>{let y=b-m-(p-f);for(let w=0;w<a.length;w+=3){let v=a[w+1];if(v<0||f>v+d-u)continue;let S=a[w]+d-u;p>=S?a[w+1]=f<=S?-2:-1:f>=d&&y&&(a[w]+=y,a[w+1]+=y)}u+=y}),d=n.maps[c].map(d,-1)}let l=!1;for(let c=0;c<a.length;c+=3)if(a[c+1]<0){if(a[c+1]==-2){l=!0,a[c+1]=-1;continue}let d=n.map(t[c]+s),u=d-r;if(u<0||u>=o.content.size){l=!0;continue}let f=n.map(t[c+1]+s,-1),p=f-r,{index:m,offset:b}=o.content.findIndex(u),y=o.maybeChild(m);if(y&&b==u&&b+y.nodeSize==p){let w=a[c+2].mapInner(n,y,d+1,t[c]+s+1,i);w!=Ye?(a[c]=u,a[c+1]=p,a[c+2]=w):(a[c+1]=-2,l=!0)}else l=!0}if(l){let c=sx(a,t,e,n,r,s,i),d=Ai(c,o,0,i);e=d.local;for(let u=0;u<a.length;u+=3)a[u+1]<0&&(a.splice(u,3),u-=3);for(let u=0,f=0;u<d.children.length;u+=3){let p=d.children[u];for(;f<a.length&&a[f]<p;)f+=3;a.splice(f,0,d.children[u],d.children[u+1],d.children[u+2])}}return new Ne(e.sort(Io),a)}function Jh(t,e){if(!e||!t.length)return t;let n=[];for(let o=0;o<t.length;o++){let r=t[o];n.push(new nt(r.from+e,r.to+e,r.type))}return n}function sx(t,e,n,o,r,s,i){function a(l,c){for(let d=0;d<l.local.length;d++){let u=l.local[d].map(o,r,c);u?n.push(u):i.onRemove&&i.onRemove(l.local[d].spec)}for(let d=0;d<l.children.length;d+=3)a(l.children[d+2],l.children[d]+c+1)}for(let l=0;l<t.length;l+=3)t[l+1]==-1&&a(t[l+2],e[l]+s+1);return n}function Yh(t,e,n){if(e.isLeaf)return null;let o=n+e.nodeSize,r=null;for(let s=0,i;s<t.length;s++)(i=t[s])&&i.from>n&&i.to<o&&((r||(r=[])).push(i),t[s]=null);return r}function Xh(t){let e=[];for(let n=0;n<t.length;n++)t[n]!=null&&e.push(t[n]);return e}function Ai(t,e,n,o){let r=[],s=!1;e.forEach((a,l)=>{let c=Yh(t,a,l+n);if(c){s=!0;let d=Ai(c,a,n+l+1,o);d!=Ye&&r.push(l,l+a.nodeSize,d)}});let i=Jh(s?Xh(t):t,-n).sort(Io);for(let a=0;a<i.length;a++)i[a].type.valid(e,i[a])||(o.onRemove&&o.onRemove(i[a].spec),i.splice(a--,1));return i.length||r.length?new Ne(i,r):Ye}function Io(t,e){return t.from-e.from||t.to-e.to}function Td(t){let e=t;for(let n=0;n<e.length-1;n++){let o=e[n];if(o.from!=o.to)for(let r=n+1;r<e.length;r++){let s=e[r];if(s.from==o.from){s.to!=o.to&&(e==t&&(e=t.slice()),e[r]=s.copy(s.from,o.to),Ip(e,r+1,s.copy(o.to,s.to)));continue}else{s.from<o.to&&(e==t&&(e=t.slice()),e[n]=o.copy(o.from,s.from),Ip(e,r,o.copy(s.from,o.to)));break}}}return e}function Ip(t,e,n){for(;e<t.length&&Io(n,t[e])>0;)e++;t.splice(e,0,n)}function dl(t){let e=[];return t.someProp("decorations",n=>{let o=n(t.state);o&&o!=Ye&&e.push(o)}),t.cursorWrapper&&e.push(Ne.create(t.state.doc,[t.cursorWrapper.deco])),$n.from(e)}const ix={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},ax=ft&&Yn<=11;class lx{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class cx{constructor(e,n){this.view=e,this.handleDOMChange=n,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new lx,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(o=>{for(let r=0;r<o.length;r++)this.queue.push(o[r]);ft&&Yn<=11&&o.some(r=>r.type=="childList"&&r.removedNodes.length||r.type=="characterData"&&r.oldValue.length>r.target.nodeValue.length)?this.flushSoon():this.flush()}),ax&&(this.onCharData=o=>{this.queue.push({target:o.target,type:"characterData",oldValue:o.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,ix)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let n=0;n<e.length;n++)this.queue.push(e[n]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(yp(this.view)){if(this.suppressingSelectionUpdates)return xn(this.view);if(ft&&Yn<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&Oo(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let n=new Set,o;for(let s=e.focusNode;s;s=ur(s))n.add(s);for(let s=e.anchorNode;s;s=ur(s))if(n.has(s)){o=s;break}let r=o&&this.view.docView.nearestDesc(o);if(r&&r.ignoreMutation({type:"selection",target:o.nodeType==3?o.parentNode:o}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let n=this.pendingRecords();n.length&&(this.queue=[]);let o=e.domSelectionRange(),r=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(o)&&yp(e)&&!this.ignoreSelectionChange(o),s=-1,i=-1,a=!1,l=[];if(e.editable)for(let d=0;d<n.length;d++){let u=this.registerMutation(n[d],l);u&&(s=s<0?u.from:Math.min(u.from,s),i=i<0?u.to:Math.max(u.to,i),u.typeOver&&(a=!0))}if(Wt&&l.length){let d=l.filter(u=>u.nodeName=="BR");if(d.length==2){let[u,f]=d;u.parentNode&&u.parentNode.parentNode==f.parentNode?f.remove():u.remove()}else{let{focusNode:u}=this.currentSelection;for(let f of d){let p=f.parentNode;p&&p.nodeName=="LI"&&(!u||px(e,u)!=p)&&f.remove()}}}let c=null;s<0&&r&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&Ta(o)&&(c=xd(e))&&c.eq(ne.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,xn(e),this.currentSelection.set(o),e.scrollToSelection()):(s>-1||r)&&(s>-1&&(e.docView.markDirty(s,i),dx(e)),this.handleDOMChange(s,i,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(o)||xn(e),this.currentSelection.set(o))}registerMutation(e,n){if(n.indexOf(e.target)>-1)return null;let o=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(o==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!o||o.ignoreMutation(e))return null;if(e.type=="childList"){for(let d=0;d<e.addedNodes.length;d++){let u=e.addedNodes[d];n.push(u),u.nodeType==3&&(this.lastChangedTextNode=u)}if(o.contentDOM&&o.contentDOM!=o.dom&&!o.contentDOM.contains(e.target))return{from:o.posBefore,to:o.posAfter};let r=e.previousSibling,s=e.nextSibling;if(ft&&Yn<=11&&e.addedNodes.length)for(let d=0;d<e.addedNodes.length;d++){let{previousSibling:u,nextSibling:f}=e.addedNodes[d];(!u||Array.prototype.indexOf.call(e.addedNodes,u)<0)&&(r=u),(!f||Array.prototype.indexOf.call(e.addedNodes,f)<0)&&(s=f)}let i=r&&r.parentNode==e.target?Ke(r)+1:0,a=o.localPosFromDOM(e.target,i,-1),l=s&&s.parentNode==e.target?Ke(s):e.target.childNodes.length,c=o.localPosFromDOM(e.target,l,1);return{from:a,to:c}}else return e.type=="attributes"?{from:o.posAtStart-o.border,to:o.posAtEnd+o.border}:(this.lastChangedTextNode=e.target,{from:o.posAtStart,to:o.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let Ap=new WeakMap,Np=!1;function dx(t){if(!Ap.has(t)&&(Ap.set(t,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(t.dom).whiteSpace)!==-1)){if(t.requiresGeckoHackNode=Wt,Np)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),Np=!0}}function Mp(t,e){let n=e.startContainer,o=e.startOffset,r=e.endContainer,s=e.endOffset,i=t.domAtPos(t.state.selection.anchor);return Oo(i.node,i.offset,r,s)&&([n,o,r,s]=[r,s,n,o]),{anchorNode:n,anchorOffset:o,focusNode:r,focusOffset:s}}function ux(t,e){if(e.getComposedRanges){let r=e.getComposedRanges(t.root)[0];if(r)return Mp(t,r)}let n;function o(r){r.preventDefault(),r.stopImmediatePropagation(),n=r.getTargetRanges()[0]}return t.dom.addEventListener("beforeinput",o,!0),document.execCommand("indent"),t.dom.removeEventListener("beforeinput",o,!0),n?Mp(t,n):null}function px(t,e){for(let n=e.parentNode;n&&n!=t.dom;n=n.parentNode){let o=t.docView.nearestDesc(n,!0);if(o&&o.node.isBlock)return n}return null}function fx(t,e,n){let{node:o,fromOffset:r,toOffset:s,from:i,to:a}=t.docView.parseRange(e,n),l=t.domSelectionRange(),c,d=l.anchorNode;if(d&&t.dom.contains(d.nodeType==1?d:d.parentNode)&&(c=[{node:d,offset:l.anchorOffset}],Ta(l)||c.push({node:l.focusNode,offset:l.focusOffset})),Xe&&t.input.lastKeyCode===8)for(let y=s;y>r;y--){let w=o.childNodes[y-1],v=w.pmViewDesc;if(w.nodeName=="BR"&&!v){s=y;break}if(!v||v.size)break}let u=t.state.doc,f=t.someProp("domParser")||Jn.fromSchema(t.state.schema),p=u.resolve(i),m=null,b=f.parse(o,{topNode:p.parent,topMatch:p.parent.contentMatchAt(p.index()),topOpen:!0,from:r,to:s,preserveWhitespace:p.parent.type.whitespace=="pre"?"full":!0,findPositions:c,ruleFromNode:mx,context:p});if(c&&c[0].pos!=null){let y=c[0].pos,w=c[1]&&c[1].pos;w==null&&(w=y),m={anchor:y+i,head:w+i}}return{doc:b,sel:m,from:i,to:a}}function mx(t){let e=t.pmViewDesc;if(e)return e.parseRule();if(t.nodeName=="BR"&&t.parentNode){if(rt&&/^(ul|ol)$/i.test(t.parentNode.nodeName)){let n=document.createElement("div");return n.appendChild(document.createElement("li")),{skip:n}}else if(t.parentNode.lastChild==t||rt&&/^(tr|table)$/i.test(t.parentNode.nodeName))return{ignore:!0}}else if(t.nodeName=="IMG"&&t.getAttribute("mark-placeholder"))return{ignore:!0};return null}const hx=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|img|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function gx(t,e,n,o,r){let s=t.input.compositionPendingChanges||(t.composing?t.input.compositionID:0);if(t.input.compositionPendingChanges=0,e<0){let E=t.input.lastSelectionTime>Date.now()-50?t.input.lastSelectionOrigin:null,A=xd(t,E);if(A&&!t.state.selection.eq(A)){if(Xe&&vn&&t.input.lastKeyCode===13&&Date.now()-100<t.input.lastKeyCodeTime&&t.someProp("handleKeyDown",B=>B(t,go(13,"Enter"))))return;let L=t.state.tr.setSelection(A);E=="pointer"?L.setMeta("pointer",!0):E=="key"&&L.scrollIntoView(),s&&L.setMeta("composition",s),t.dispatch(L)}return}let i=t.state.doc.resolve(e),a=i.sharedDepth(n);e=i.before(a+1),n=t.state.doc.resolve(n).after(a+1);let l=t.state.selection,c=fx(t,e,n),d=t.state.doc,u=d.slice(c.from,c.to),f,p;t.input.lastKeyCode===8&&Date.now()-100<t.input.lastKeyCodeTime?(f=t.state.selection.to,p="end"):(f=t.state.selection.from,p="start"),t.input.lastKeyCode=null;let m=wx(u.content,c.doc.content,c.from,f,p);if(m&&t.input.domChangeCount++,(pr&&t.input.lastIOSEnter>Date.now()-225||vn)&&r.some(E=>E.nodeType==1&&!hx.test(E.nodeName))&&(!m||m.endA>=m.endB)&&t.someProp("handleKeyDown",E=>E(t,go(13,"Enter")))){t.input.lastIOSEnter=0;return}if(!m)if(o&&l instanceof Z&&!l.empty&&l.$head.sameParent(l.$anchor)&&!t.composing&&!(c.sel&&c.sel.anchor!=c.sel.head))m={start:l.from,endA:l.to,endB:l.to};else{if(c.sel){let E=Tp(t,t.state.doc,c.sel);if(E&&!E.eq(t.state.selection)){let A=t.state.tr.setSelection(E);s&&A.setMeta("composition",s),t.dispatch(A)}}return}t.state.selection.from<t.state.selection.to&&m.start==m.endB&&t.state.selection instanceof Z&&(m.start>t.state.selection.from&&m.start<=t.state.selection.from+2&&t.state.selection.from>=c.from?m.start=t.state.selection.from:m.endA<t.state.selection.to&&m.endA>=t.state.selection.to-2&&t.state.selection.to<=c.to&&(m.endB+=t.state.selection.to-m.endA,m.endA=t.state.selection.to)),ft&&Yn<=11&&m.endB==m.start+1&&m.endA==m.start&&m.start>c.from&&c.doc.textBetween(m.start-c.from-1,m.start-c.from+1)==" Â "&&(m.start--,m.endA--,m.endB--);let b=c.doc.resolveNoCache(m.start-c.from),y=c.doc.resolveNoCache(m.endB-c.from),w=d.resolve(m.start),v=b.sameParent(y)&&b.parent.inlineContent&&w.end()>=m.endA,S;if((pr&&t.input.lastIOSEnter>Date.now()-225&&(!v||r.some(E=>E.nodeName=="DIV"||E.nodeName=="P"))||!v&&b.pos<c.doc.content.size&&(!b.sameParent(y)||!b.parent.inlineContent)&&!/\S/.test(c.doc.textBetween(b.pos,y.pos,"",""))&&(S=ne.findFrom(c.doc.resolve(b.pos+1),1,!0))&&S.head>b.pos)&&t.someProp("handleKeyDown",E=>E(t,go(13,"Enter")))){t.input.lastIOSEnter=0;return}if(t.state.selection.anchor>m.start&&yx(d,m.start,m.endA,b,y)&&t.someProp("handleKeyDown",E=>E(t,go(8,"Backspace")))){vn&&Xe&&t.domObserver.suppressSelectionUpdates();return}Xe&&m.endB==m.start&&(t.input.lastChromeDelete=Date.now()),vn&&!v&&b.start()!=y.start()&&y.parentOffset==0&&b.depth==y.depth&&c.sel&&c.sel.anchor==c.sel.head&&c.sel.head==m.endA&&(m.endB-=2,y=c.doc.resolveNoCache(m.endB-c.from),setTimeout(()=>{t.someProp("handleKeyDown",function(E){return E(t,go(13,"Enter"))})},20));let C=m.start,x=m.endA,I=E=>{let A=E||t.state.tr.replace(C,x,c.doc.slice(m.start-c.from,m.endB-c.from));if(c.sel){let L=Tp(t,A.doc,c.sel);L&&!(Xe&&t.composing&&L.empty&&(m.start!=m.endB||t.input.lastChromeDelete<Date.now()-100)&&(L.head==C||L.head==A.mapping.map(x)-1)||ft&&L.empty&&L.head==C)&&A.setSelection(L)}return s&&A.setMeta("composition",s),A.scrollIntoView()},N;if(v){if(b.pos==y.pos){ft&&Yn<=11&&b.parentOffset==0&&(t.domObserver.suppressSelectionUpdates(),setTimeout(()=>xn(t),20));let E=I(t.state.tr.delete(C,x)),A=d.resolve(m.start).marksAcross(d.resolve(m.endA));A&&E.ensureMarks(A),t.dispatch(E)}else if(m.endA==m.endB&&(N=bx(b.parent.content.cut(b.parentOffset,y.parentOffset),w.parent.content.cut(w.parentOffset,m.endA-w.start())))){let E=I(t.state.tr);N.type=="add"?E.addMark(C,x,N.mark):E.removeMark(C,x,N.mark),t.dispatch(E)}else if(b.parent.child(b.index()).isText&&b.index()==y.index()-(y.textOffset?0:1)){let E=b.parent.textBetween(b.parentOffset,y.parentOffset),A=()=>I(t.state.tr.insertText(E,C,x));t.someProp("handleTextInput",L=>L(t,C,x,E,A))||t.dispatch(A())}}else t.dispatch(I())}function Tp(t,e,n){return Math.max(n.anchor,n.head)>e.content.size?null:Cd(t,e.resolve(n.anchor),e.resolve(n.head))}function bx(t,e){let n=t.firstChild.marks,o=e.firstChild.marks,r=n,s=o,i,a,l;for(let d=0;d<o.length;d++)r=o[d].removeFromSet(r);for(let d=0;d<n.length;d++)s=n[d].removeFromSet(s);if(r.length==1&&s.length==0)a=r[0],i="add",l=d=>d.mark(a.addToSet(d.marks));else if(r.length==0&&s.length==1)a=s[0],i="remove",l=d=>d.mark(a.removeFromSet(d.marks));else return null;let c=[];for(let d=0;d<e.childCount;d++)c.push(l(e.child(d)));if(M.from(c).eq(t))return{mark:a,type:i}}function yx(t,e,n,o,r){if(n-e<=r.pos-o.pos||ul(o,!0,!1)<r.pos)return!1;let s=t.resolve(e);if(!o.parent.isTextblock){let a=s.nodeAfter;return a!=null&&n==e+a.nodeSize}if(s.parentOffset<s.parent.content.size||!s.parent.isTextblock)return!1;let i=t.resolve(ul(s,!0,!0));return!i.parent.isTextblock||i.pos>n||ul(i,!0,!1)<n?!1:o.parent.content.cut(o.parentOffset).eq(i.parent.content)}function ul(t,e,n){let o=t.depth,r=e?t.end():t.pos;for(;o>0&&(e||t.indexAfter(o)==t.node(o).childCount);)o--,r++,e=!1;if(n){let s=t.node(o).maybeChild(t.indexAfter(o));for(;s&&!s.isLeaf;)s=s.firstChild,r++}return r}function wx(t,e,n,o,r){let s=t.findDiffStart(e,n);if(s==null)return null;let{a:i,b:a}=t.findDiffEnd(e,n+t.size,n+e.size);if(r=="end"){let l=Math.max(0,s-Math.min(i,a));o-=i+l-s}if(i<s&&t.size<e.size){let l=o<=s&&o>=i?s-o:0;s-=l,s&&s<e.size&&Pp(e.textBetween(s-1,s+1))&&(s+=l?1:-1),a=s+(a-i),i=s}else if(a<s){let l=o<=s&&o>=a?s-o:0;s-=l,s&&s<t.size&&Pp(t.textBetween(s-1,s+1))&&(s+=l?1:-1),i=s+(i-a),a=s}return{start:s,endA:i,endB:a}}function Pp(t){if(t.length!=2)return!1;let e=t.charCodeAt(0),n=t.charCodeAt(1);return e>=56320&&e<=57343&&n>=55296&&n<=56319}class Qh{constructor(e,n){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new _k,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=n,this.state=n.state,this.directPlugins=n.plugins||[],this.directPlugins.forEach(Rp),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=Lp(this),Op(this),this.nodeViews=Dp(this),this.docView=pp(this.state.doc,Bp(this),dl(this),this.dom,this),this.domObserver=new cx(this,(o,r,s,i)=>gx(this,o,r,s,i)),this.domObserver.start(),$k(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let n in e)this._props[n]=e[n];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&yc(this);let n=this._props;this._props=e,e.plugins&&(e.plugins.forEach(Rp),this.directPlugins=e.plugins),this.updateStateInner(e.state,n)}setProps(e){let n={};for(let o in this._props)n[o]=this._props[o];n.state=this.state;for(let o in e)n[o]=e[o];this.update(n)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,n){var o;let r=this.state,s=!1,i=!1;e.storedMarks&&this.composing&&(Vh(this),i=!0),this.state=e;let a=r.plugins!=e.plugins||this._props.plugins!=n.plugins;if(a||this._props.plugins!=n.plugins||this._props.nodeViews!=n.nodeViews){let p=Dp(this);Sx(p,this.nodeViews)&&(this.nodeViews=p,s=!0)}(a||n.handleDOMEvents!=this._props.handleDOMEvents)&&yc(this),this.editable=Lp(this),Op(this);let l=dl(this),c=Bp(this),d=r.plugins!=e.plugins&&!r.doc.eq(e.doc)?"reset":e.scrollToSelection>r.scrollToSelection?"to selection":"preserve",u=s||!this.docView.matchesNode(e.doc,c,l);(u||!e.selection.eq(r.selection))&&(i=!0);let f=d=="preserve"&&i&&this.dom.style.overflowAnchor==null&&ZS(this);if(i){this.domObserver.stop();let p=u&&(ft||Xe)&&!this.composing&&!r.selection.empty&&!e.selection.empty&&vx(r.selection,e.selection);if(u){let m=Xe?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=Qk(this)),(s||!this.docView.update(e.doc,c,l,this))&&(this.docView.updateOuterDeco(c),this.docView.destroy(),this.docView=pp(e.doc,c,l,this.dom,this)),m&&!this.trackWrites&&(p=!0)}p||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&xk(this))?xn(this,p):(Oh(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(r),!((o=this.dragging)===null||o===void 0)&&o.node&&!r.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,r),d=="reset"?this.dom.scrollTop=0:d=="to selection"?this.scrollToSelection():f&&ek(f)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!(!e||!this.dom.contains(e.nodeType==1?e:e.parentNode))){if(!this.someProp("handleScrollToSelection",n=>n(this)))if(this.state.selection instanceof U){let n=this.docView.domAfterPos(this.state.selection.from);n.nodeType==1&&ip(this,n.getBoundingClientRect(),e)}else ip(this,this.coordsAtPos(this.state.selection.head,1),e)}}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let n=0;n<this.directPlugins.length;n++){let o=this.directPlugins[n];o.spec.view&&this.pluginViews.push(o.spec.view(this))}for(let n=0;n<this.state.plugins.length;n++){let o=this.state.plugins[n];o.spec.view&&this.pluginViews.push(o.spec.view(this))}}else for(let n=0;n<this.pluginViews.length;n++){let o=this.pluginViews[n];o.update&&o.update(this,e)}}updateDraggedNode(e,n){let o=e.node,r=-1;if(this.state.doc.nodeAt(o.from)==o.node)r=o.from;else{let s=o.from+(this.state.doc.content.size-n.doc.content.size);(s>0&&this.state.doc.nodeAt(s))==o.node&&(r=s)}this.dragging=new Kh(e.slice,e.move,r<0?void 0:U.create(this.state.doc,r))}someProp(e,n){let o=this._props&&this._props[e],r;if(o!=null&&(r=n?n(o):o))return r;for(let i=0;i<this.directPlugins.length;i++){let a=this.directPlugins[i].props[e];if(a!=null&&(r=n?n(a):a))return r}let s=this.state.plugins;if(s)for(let i=0;i<s.length;i++){let a=s[i].props[e];if(a!=null&&(r=n?n(a):a))return r}}hasFocus(){if(ft){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&tk(this.dom),xn(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let n=this.dom.parentNode;n;n=n.parentNode)if(n.nodeType==9||n.nodeType==11&&n.host)return n.getSelection||(Object.getPrototypeOf(n).getSelection=()=>n.ownerDocument.getSelection()),this._root=n}return e||document}updateRoot(){this._root=null}posAtCoords(e){return ik(this,e)}coordsAtPos(e,n=1){return Eh(this,e,n)}domAtPos(e,n=0){return this.docView.domFromPos(e,n)}nodeDOM(e){let n=this.docView.descAt(e);return n?n.nodeDOM:null}posAtDOM(e,n,o=-1){let r=this.docView.posFromDOM(e,n,o);if(r==null)throw new RangeError("DOM position not inside the editor");return r}endOfTextblock(e,n){return uk(this,n||this.state,e)}pasteHTML(e,n){return fs(this,"",e,!1,n||new ClipboardEvent("paste"))}pasteText(e,n){return fs(this,e,null,!0,n||new ClipboardEvent("paste"))}serializeForClipboard(e){return Ed(this,e)}destroy(){this.docView&&(Fk(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],dl(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,zS())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return zk(this,e)}domSelectionRange(){let e=this.domSelection();return e?rt&&this.root.nodeType===11&&KS(this.dom.ownerDocument)==this.dom&&ux(this,e)||e:{focusNode:null,focusOffset:0,anchorNode:null,anchorOffset:0}}domSelection(){return this.root.getSelection()}}Qh.prototype.dispatch=function(t){let e=this._props.dispatchTransaction;e?e.call(this,t):this.updateState(this.state.apply(t))};function Bp(t){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(t.editable),t.someProp("attributes",n=>{if(typeof n=="function"&&(n=n(t.state)),n)for(let o in n)o=="class"?e.class+=" "+n[o]:o=="style"?e.style=(e.style?e.style+";":"")+n[o]:!e[o]&&o!="contenteditable"&&o!="nodeName"&&(e[o]=String(n[o]))}),e.translate||(e.translate="no"),[nt.node(0,t.state.doc.content.size,e)]}function Op(t){if(t.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),t.cursorWrapper={dom:e,deco:nt.widget(t.state.selection.from,e,{raw:!0,marks:t.markCursor})}}else t.cursorWrapper=null}function Lp(t){return!t.someProp("editable",e=>e(t.state)===!1)}function vx(t,e){let n=Math.min(t.$anchor.sharedDepth(t.head),e.$anchor.sharedDepth(e.head));return t.$anchor.start(n)!=e.$anchor.start(n)}function Dp(t){let e=Object.create(null);function n(o){for(let r in o)Object.prototype.hasOwnProperty.call(e,r)||(e[r]=o[r])}return t.someProp("nodeViews",n),t.someProp("markViews",n),e}function Sx(t,e){let n=0,o=0;for(let r in t){if(t[r]!=e[r])return!0;n++}for(let r in e)o++;return n!=o}function Rp(t){if(t.spec.state||t.spec.filterTransaction||t.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}var to={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},Ni={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},kx=typeof navigator<"u"&&/Mac/.test(navigator.platform),xx=typeof navigator<"u"&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent);for(var Ge=0;Ge<10;Ge++)to[48+Ge]=to[96+Ge]=String(Ge);for(var Ge=1;Ge<=24;Ge++)to[Ge+111]="F"+Ge;for(var Ge=65;Ge<=90;Ge++)to[Ge]=String.fromCharCode(Ge+32),Ni[Ge]=String.fromCharCode(Ge);for(var pl in to)Ni.hasOwnProperty(pl)||(Ni[pl]=to[pl]);function Cx(t){var e=kx&&t.metaKey&&t.shiftKey&&!t.ctrlKey&&!t.altKey||xx&&t.shiftKey&&t.key&&t.key.length==1||t.key=="Unidentified",n=!e&&t.key||(t.shiftKey?Ni:to)[t.keyCode]||t.key||"Unidentified";return n=="Esc"&&(n="Escape"),n=="Del"&&(n="Delete"),n=="Left"&&(n="ArrowLeft"),n=="Up"&&(n="ArrowUp"),n=="Right"&&(n="ArrowRight"),n=="Down"&&(n="ArrowDown"),n}const Ex=typeof navigator<"u"&&/Mac|iP(hone|[oa]d)/.test(navigator.platform),Ix=typeof navigator<"u"&&/Win/.test(navigator.platform);function Ax(t){let e=t.split(/-(?!$)/),n=e[e.length-1];n=="Space"&&(n=" ");let o,r,s,i;for(let a=0;a<e.length-1;a++){let l=e[a];if(/^(cmd|meta|m)$/i.test(l))i=!0;else if(/^a(lt)?$/i.test(l))o=!0;else if(/^(c|ctrl|control)$/i.test(l))r=!0;else if(/^s(hift)?$/i.test(l))s=!0;else if(/^mod$/i.test(l))Ex?i=!0:r=!0;else throw new Error("Unrecognized modifier name: "+l)}return o&&(n="Alt-"+n),r&&(n="Ctrl-"+n),i&&(n="Meta-"+n),s&&(n="Shift-"+n),n}function Nx(t){let e=Object.create(null);for(let n in t)e[Ax(n)]=t[n];return e}function fl(t,e,n=!0){return e.altKey&&(t="Alt-"+t),e.ctrlKey&&(t="Ctrl-"+t),e.metaKey&&(t="Meta-"+t),n&&e.shiftKey&&(t="Shift-"+t),t}function Mx(t){return new Me({props:{handleKeyDown:Zh(t)}})}function Zh(t){let e=Nx(t);return function(n,o){let r=Cx(o),s,i=e[fl(r,o)];if(i&&i(n.state,n.dispatch,n))return!0;if(r.length==1&&r!=" "){if(o.shiftKey){let a=e[fl(r,o,!1)];if(a&&a(n.state,n.dispatch,n))return!0}if((o.altKey||o.metaKey||o.ctrlKey)&&!(Ix&&o.ctrlKey&&o.altKey)&&(s=to[o.keyCode])&&s!=r){let a=e[fl(s,o)];if(a&&a(n.state,n.dispatch,n))return!0}}return!1}}const Pd=(t,e)=>t.selection.empty?!1:(e&&e(t.tr.deleteSelection().scrollIntoView()),!0);function eg(t,e){let{$cursor:n}=t.selection;return!n||(e?!e.endOfTextblock("backward",t):n.parentOffset>0)?null:n}const tg=(t,e,n)=>{let o=eg(t,n);if(!o)return!1;let r=Bd(o);if(!r){let i=o.blockRange(),a=i&&wr(i);return a==null?!1:(e&&e(t.tr.lift(i,a).scrollIntoView()),!0)}let s=r.nodeBefore;if(dg(t,r,e,-1))return!0;if(o.parent.content.size==0&&(fr(s,"end")||U.isSelectable(s)))for(let i=o.depth;;i--){let a=Na(t.doc,o.before(i),o.after(i),R.empty);if(a&&a.slice.size<a.to-a.from){if(e){let l=t.tr.step(a);l.setSelection(fr(s,"end")?ne.findFrom(l.doc.resolve(l.mapping.map(r.pos,-1)),-1):U.create(l.doc,r.pos-s.nodeSize)),e(l.scrollIntoView())}return!0}if(i==1||o.node(i-1).childCount>1)break}return s.isAtom&&r.depth==o.depth-1?(e&&e(t.tr.delete(r.pos-s.nodeSize,r.pos).scrollIntoView()),!0):!1},Tx=(t,e,n)=>{let o=eg(t,n);if(!o)return!1;let r=Bd(o);return r?ng(t,r,e):!1},Px=(t,e,n)=>{let o=rg(t,n);if(!o)return!1;let r=Od(o);return r?ng(t,r,e):!1};function ng(t,e,n){let o=e.nodeBefore,r=o,s=e.pos-1;for(;!r.isTextblock;s--){if(r.type.spec.isolating)return!1;let d=r.lastChild;if(!d)return!1;r=d}let i=e.nodeAfter,a=i,l=e.pos+1;for(;!a.isTextblock;l++){if(a.type.spec.isolating)return!1;let d=a.firstChild;if(!d)return!1;a=d}let c=Na(t.doc,s,l,R.empty);if(!c||c.from!=s||c instanceof We&&c.slice.size>=l-s)return!1;if(n){let d=t.tr.step(c);d.setSelection(Z.create(d.doc,s)),n(d.scrollIntoView())}return!0}function fr(t,e,n=!1){for(let o=t;o;o=e=="start"?o.firstChild:o.lastChild){if(o.isTextblock)return!0;if(n&&o.childCount!=1)return!1}return!1}const og=(t,e,n)=>{let{$head:o,empty:r}=t.selection,s=o;if(!r)return!1;if(o.parent.isTextblock){if(n?!n.endOfTextblock("backward",t):o.parentOffset>0)return!1;s=Bd(o)}let i=s&&s.nodeBefore;return!i||!U.isSelectable(i)?!1:(e&&e(t.tr.setSelection(U.create(t.doc,s.pos-i.nodeSize)).scrollIntoView()),!0)};function Bd(t){if(!t.parent.type.spec.isolating)for(let e=t.depth-1;e>=0;e--){if(t.index(e)>0)return t.doc.resolve(t.before(e+1));if(t.node(e).type.spec.isolating)break}return null}function rg(t,e){let{$cursor:n}=t.selection;return!n||(e?!e.endOfTextblock("forward",t):n.parentOffset<n.parent.content.size)?null:n}const sg=(t,e,n)=>{let o=rg(t,n);if(!o)return!1;let r=Od(o);if(!r)return!1;let s=r.nodeAfter;if(dg(t,r,e,1))return!0;if(o.parent.content.size==0&&(fr(s,"start")||U.isSelectable(s))){let i=Na(t.doc,o.before(),o.after(),R.empty);if(i&&i.slice.size<i.to-i.from){if(e){let a=t.tr.step(i);a.setSelection(fr(s,"start")?ne.findFrom(a.doc.resolve(a.mapping.map(r.pos)),1):U.create(a.doc,a.mapping.map(r.pos))),e(a.scrollIntoView())}return!0}}return s.isAtom&&r.depth==o.depth-1?(e&&e(t.tr.delete(r.pos,r.pos+s.nodeSize).scrollIntoView()),!0):!1},ig=(t,e,n)=>{let{$head:o,empty:r}=t.selection,s=o;if(!r)return!1;if(o.parent.isTextblock){if(n?!n.endOfTextblock("forward",t):o.parentOffset<o.parent.content.size)return!1;s=Od(o)}let i=s&&s.nodeAfter;return!i||!U.isSelectable(i)?!1:(e&&e(t.tr.setSelection(U.create(t.doc,s.pos)).scrollIntoView()),!0)};function Od(t){if(!t.parent.type.spec.isolating)for(let e=t.depth-1;e>=0;e--){let n=t.node(e);if(t.index(e)+1<n.childCount)return t.doc.resolve(t.after(e+1));if(n.type.spec.isolating)break}return null}const Bx=(t,e)=>{let n=t.selection,o=n instanceof U,r;if(o){if(n.node.isTextblock||!lo(t.doc,n.from))return!1;r=n.from}else if(r=Aa(t.doc,n.from,-1),r==null)return!1;if(e){let s=t.tr.join(r);o&&s.setSelection(U.create(s.doc,r-t.doc.resolve(r).nodeBefore.nodeSize)),e(s.scrollIntoView())}return!0},Ox=(t,e)=>{let n=t.selection,o;if(n instanceof U){if(n.node.isTextblock||!lo(t.doc,n.to))return!1;o=n.to}else if(o=Aa(t.doc,n.to,1),o==null)return!1;return e&&e(t.tr.join(o).scrollIntoView()),!0},Lx=(t,e)=>{let{$from:n,$to:o}=t.selection,r=n.blockRange(o),s=r&&wr(r);return s==null?!1:(e&&e(t.tr.lift(r,s).scrollIntoView()),!0)},ag=(t,e)=>{let{$head:n,$anchor:o}=t.selection;return!n.parent.type.spec.code||!n.sameParent(o)?!1:(e&&e(t.tr.insertText(`
`).scrollIntoView()),!0)};function Ld(t){for(let e=0;e<t.edgeCount;e++){let{type:n}=t.edge(e);if(n.isTextblock&&!n.hasRequiredAttrs())return n}return null}const Dx=(t,e)=>{let{$head:n,$anchor:o}=t.selection;if(!n.parent.type.spec.code||!n.sameParent(o))return!1;let r=n.node(-1),s=n.indexAfter(-1),i=Ld(r.contentMatchAt(s));if(!i||!r.canReplaceWith(s,s,i))return!1;if(e){let a=n.after(),l=t.tr.replaceWith(a,a,i.createAndFill());l.setSelection(ne.near(l.doc.resolve(a),1)),e(l.scrollIntoView())}return!0},lg=(t,e)=>{let n=t.selection,{$from:o,$to:r}=n;if(n instanceof St||o.parent.inlineContent||r.parent.inlineContent)return!1;let s=Ld(r.parent.contentMatchAt(r.indexAfter()));if(!s||!s.isTextblock)return!1;if(e){let i=(!o.parentOffset&&r.index()<r.parent.childCount?o:r).pos,a=t.tr.insert(i,s.createAndFill());a.setSelection(Z.create(a.doc,i+1)),e(a.scrollIntoView())}return!0},cg=(t,e)=>{let{$cursor:n}=t.selection;if(!n||n.parent.content.size)return!1;if(n.depth>1&&n.after()!=n.end(-1)){let s=n.before();if(kn(t.doc,s))return e&&e(t.tr.split(s).scrollIntoView()),!0}let o=n.blockRange(),r=o&&wr(o);return r==null?!1:(e&&e(t.tr.lift(o,r).scrollIntoView()),!0)};function Rx(t){return(e,n)=>{let{$from:o,$to:r}=e.selection;if(e.selection instanceof U&&e.selection.node.isBlock)return!o.parentOffset||!kn(e.doc,o.pos)?!1:(n&&n(e.tr.split(o.pos).scrollIntoView()),!0);if(!o.depth)return!1;let s=[],i,a,l=!1,c=!1;for(let p=o.depth;;p--)if(o.node(p).isBlock){l=o.end(p)==o.pos+(o.depth-p),c=o.start(p)==o.pos-(o.depth-p),a=Ld(o.node(p-1).contentMatchAt(o.indexAfter(p-1))),s.unshift(l&&a?{type:a}:null),i=p;break}else{if(p==1)return!1;s.unshift(null)}let d=e.tr;(e.selection instanceof Z||e.selection instanceof St)&&d.deleteSelection();let u=d.mapping.map(o.pos),f=kn(d.doc,u,s.length,s);if(f||(s[0]=a?{type:a}:null,f=kn(d.doc,u,s.length,s)),!f)return!1;if(d.split(u,s.length,s),!l&&c&&o.node(i).type!=a){let p=d.mapping.map(o.before(i)),m=d.doc.resolve(p);a&&o.node(i-1).canReplaceWith(m.index(),m.index()+1,a)&&d.setNodeMarkup(d.mapping.map(o.before(i)),a)}return n&&n(d.scrollIntoView()),!0}}const jx=Rx(),_x=(t,e)=>{let{$from:n,to:o}=t.selection,r,s=n.sharedDepth(o);return s==0?!1:(r=n.before(s),e&&e(t.tr.setSelection(U.create(t.doc,r))),!0)};function $x(t,e,n){let o=e.nodeBefore,r=e.nodeAfter,s=e.index();return!o||!r||!o.type.compatibleContent(r.type)?!1:!o.content.size&&e.parent.canReplace(s-1,s)?(n&&n(t.tr.delete(e.pos-o.nodeSize,e.pos).scrollIntoView()),!0):!e.parent.canReplace(s,s+1)||!(r.isTextblock||lo(t.doc,e.pos))?!1:(n&&n(t.tr.join(e.pos).scrollIntoView()),!0)}function dg(t,e,n,o){let r=e.nodeBefore,s=e.nodeAfter,i,a,l=r.type.spec.isolating||s.type.spec.isolating;if(!l&&$x(t,e,n))return!0;let c=!l&&e.parent.canReplace(e.index(),e.index()+1);if(c&&(i=(a=r.contentMatchAt(r.childCount)).findWrapping(s.type))&&a.matchType(i[0]||s.type).validEnd){if(n){let p=e.pos+s.nodeSize,m=M.empty;for(let w=i.length-1;w>=0;w--)m=M.from(i[w].create(null,m));m=M.from(r.copy(m));let b=t.tr.step(new He(e.pos-1,p,e.pos,p,new R(m,1,0),i.length,!0)),y=b.doc.resolve(p+2*i.length);y.nodeAfter&&y.nodeAfter.type==r.type&&lo(b.doc,y.pos)&&b.join(y.pos),n(b.scrollIntoView())}return!0}let d=s.type.spec.isolating||o>0&&l?null:ne.findFrom(e,1),u=d&&d.$from.blockRange(d.$to),f=u&&wr(u);if(f!=null&&f>=e.depth)return n&&n(t.tr.lift(u,f).scrollIntoView()),!0;if(c&&fr(s,"start",!0)&&fr(r,"end")){let p=r,m=[];for(;m.push(p),!p.isTextblock;)p=p.lastChild;let b=s,y=1;for(;!b.isTextblock;b=b.firstChild)y++;if(p.canReplace(p.childCount,p.childCount,b.content)){if(n){let w=M.empty;for(let S=m.length-1;S>=0;S--)w=M.from(m[S].copy(w));let v=t.tr.step(new He(e.pos-m.length,e.pos+s.nodeSize,e.pos+y,e.pos+s.nodeSize-y,new R(w,m.length,0),0,!0));n(v.scrollIntoView())}return!0}}return!1}function ug(t){return function(e,n){let o=e.selection,r=t<0?o.$from:o.$to,s=r.depth;for(;r.node(s).isInline;){if(!s)return!1;s--}return r.node(s).isTextblock?(n&&n(e.tr.setSelection(Z.create(e.doc,t<0?r.start(s):r.end(s)))),!0):!1}}const Fx=ug(-1),Wx=ug(1);function zx(t,e=null){return function(n,o){let{$from:r,$to:s}=n.selection,i=r.blockRange(s),a=i&&vd(i,t,e);return a?(o&&o(n.tr.wrap(i,a).scrollIntoView()),!0):!1}}function jp(t,e=null){return function(n,o){let r=!1;for(let s=0;s<n.selection.ranges.length&&!r;s++){let{$from:{pos:i},$to:{pos:a}}=n.selection.ranges[s];n.doc.nodesBetween(i,a,(l,c)=>{if(r)return!1;if(!(!l.isTextblock||l.hasMarkup(t,e)))if(l.type==t)r=!0;else{let d=n.doc.resolve(c),u=d.index();r=d.parent.canReplaceWith(u,u+1,t)}})}if(!r)return!1;if(o){let s=n.tr;for(let i=0;i<n.selection.ranges.length;i++){let{$from:{pos:a},$to:{pos:l}}=n.selection.ranges[i];s.setBlockType(a,l,t,e)}o(s.scrollIntoView())}return!0}}function Dd(...t){return function(e,n,o){for(let r=0;r<t.length;r++)if(t[r](e,n,o))return!0;return!1}}Dd(Pd,tg,og);Dd(Pd,sg,ig);Dd(ag,lg,cg,jx);typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os<"u"&&os.platform&&os.platform()=="darwin";function Hx(t,e=null){return function(n,o){let{$from:r,$to:s}=n.selection,i=r.blockRange(s);if(!i)return!1;let a=o?n.tr:null;return Ux(a,i,t,e)?(o&&o(a.scrollIntoView()),!0):!1}}function Ux(t,e,n,o=null){let r=!1,s=e,i=e.$from.doc;if(e.depth>=2&&e.$from.node(e.depth-1).type.compatibleContent(n)&&e.startIndex==0){if(e.$from.index(e.depth-1)==0)return!1;let l=i.resolve(e.start-2);s=new Si(l,l,e.depth),e.endIndex<e.parent.childCount&&(e=new Si(e.$from,i.resolve(e.$to.end(e.depth)),e.depth)),r=!0}let a=vd(s,n,o,e);return a?(t&&Vx(t,e,a,r,n),!0):!1}function Vx(t,e,n,o,r){let s=M.empty;for(let d=n.length-1;d>=0;d--)s=M.from(n[d].type.create(n[d].attrs,s));t.step(new He(e.start-(o?2:0),e.end,e.start,e.end,new R(s,0,0),n.length,!0));let i=0;for(let d=0;d<n.length;d++)n[d].type==r&&(i=d+1);let a=n.length-i,l=e.start+n.length-(o?2:0),c=e.parent;for(let d=e.startIndex,u=e.endIndex,f=!0;d<u;d++,f=!1)!f&&kn(t.doc,l,a)&&(t.split(l,a),l+=2*a),l+=c.child(d).nodeSize;return t}function qx(t){return function(e,n){let{$from:o,$to:r}=e.selection,s=o.blockRange(r,i=>i.childCount>0&&i.firstChild.type==t);return s?n?o.node(s.depth-1).type==t?Kx(e,n,t,s):Gx(e,n,s):!0:!1}}function Kx(t,e,n,o){let r=t.tr,s=o.end,i=o.$to.end(o.depth);s<i&&(r.step(new He(s-1,i,s,i,new R(M.from(n.create(null,o.parent.copy())),1,0),1,!0)),o=new Si(r.doc.resolve(o.$from.pos),r.doc.resolve(i),o.depth));const a=wr(o);if(a==null)return!1;r.lift(o,a);let l=r.doc.resolve(r.mapping.map(s,-1)-1);return lo(r.doc,l.pos)&&l.nodeBefore.type==l.nodeAfter.type&&r.join(l.pos),e(r.scrollIntoView()),!0}function Gx(t,e,n){let o=t.tr,r=n.parent;for(let p=n.end,m=n.endIndex-1,b=n.startIndex;m>b;m--)p-=r.child(m).nodeSize,o.delete(p-1,p+1);let s=o.doc.resolve(n.start),i=s.nodeAfter;if(o.mapping.map(n.end)!=n.start+s.nodeAfter.nodeSize)return!1;let a=n.startIndex==0,l=n.endIndex==r.childCount,c=s.node(-1),d=s.index(-1);if(!c.canReplace(d+(a?0:1),d+1,i.content.append(l?M.empty:M.from(r))))return!1;let u=s.pos,f=u+i.nodeSize;return o.step(new He(u-(a?1:0),f+(l?1:0),u+1,f-1,new R((a?M.empty:M.from(r.copy(M.empty))).append(l?M.empty:M.from(r.copy(M.empty))),a?0:1,l?0:1),a?0:1)),e(o.scrollIntoView()),!0}function Jx(t){return function(e,n){let{$from:o,$to:r}=e.selection,s=o.blockRange(r,c=>c.childCount>0&&c.firstChild.type==t);if(!s)return!1;let i=s.startIndex;if(i==0)return!1;let a=s.parent,l=a.child(i-1);if(l.type!=t)return!1;if(n){let c=l.lastChild&&l.lastChild.type==a.type,d=M.from(c?t.create():null),u=new R(M.from(t.create(null,M.from(a.type.create(null,d)))),c?3:1,0),f=s.start,p=s.end;n(e.tr.step(new He(f-(c?3:1),p,f,p,u,1,!0)).scrollIntoView())}return!0}}var Yx=Object.defineProperty,pg=(t,e)=>{for(var n in e)Yx(t,n,{get:e[n],enumerable:!0})};function Oa(t){const{state:e,transaction:n}=t;let{selection:o}=n,{doc:r}=n,{storedMarks:s}=n;return{...e,apply:e.apply.bind(e),applyTransaction:e.applyTransaction.bind(e),plugins:e.plugins,schema:e.schema,reconfigure:e.reconfigure.bind(e),toJSON:e.toJSON.bind(e),get storedMarks(){return s},get selection(){return o},get doc(){return r},get tr(){return o=n.selection,r=n.doc,s=n.storedMarks,n}}}var La=class{constructor(t){this.editor=t.editor,this.rawCommands=this.editor.extensionManager.commands,this.customState=t.state}get hasCustomState(){return!!this.customState}get state(){return this.customState||this.editor.state}get commands(){const{rawCommands:t,editor:e,state:n}=this,{view:o}=e,{tr:r}=n,s=this.buildProps(r);return Object.fromEntries(Object.entries(t).map(([i,a])=>[i,(...c)=>{const d=a(...c)(s);return!r.getMeta("preventDispatch")&&!this.hasCustomState&&o.dispatch(r),d}]))}get chain(){return()=>this.createChain()}get can(){return()=>this.createCan()}createChain(t,e=!0){const{rawCommands:n,editor:o,state:r}=this,{view:s}=o,i=[],a=!!t,l=t||r.tr,c=()=>(!a&&e&&!l.getMeta("preventDispatch")&&!this.hasCustomState&&s.dispatch(l),i.every(u=>u===!0)),d={...Object.fromEntries(Object.entries(n).map(([u,f])=>[u,(...m)=>{const b=this.buildProps(l,e),y=f(...m)(b);return i.push(y),d}])),run:c};return d}createCan(t){const{rawCommands:e,state:n}=this,o=!1,r=t||n.tr,s=this.buildProps(r,o);return{...Object.fromEntries(Object.entries(e).map(([a,l])=>[a,(...c)=>l(...c)({...s,dispatch:void 0})])),chain:()=>this.createChain(r,o)}}buildProps(t,e=!0){const{rawCommands:n,editor:o,state:r}=this,{view:s}=o,i={tr:t,editor:o,view:s,state:Oa({state:r,transaction:t}),dispatch:e?()=>{}:void 0,chain:()=>this.createChain(t,e),can:()=>this.createCan(t),get commands(){return Object.fromEntries(Object.entries(n).map(([a,l])=>[a,(...c)=>l(...c)(i)]))}};return i}},Xx=class{constructor(){this.callbacks={}}on(t,e){return this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e),this}emit(t,...e){const n=this.callbacks[t];return n&&n.forEach(o=>o.apply(this,e)),this}off(t,e){const n=this.callbacks[t];return n&&(e?this.callbacks[t]=n.filter(o=>o!==e):delete this.callbacks[t]),this}once(t,e){const n=(...o)=>{this.off(t,n),e.apply(this,o)};return this.on(t,n)}removeAllListeners(){this.callbacks={}}};function fg(t,e){const n=new gh(t);return e.forEach(o=>{o.steps.forEach(r=>{n.step(r)})}),n}var mg=t=>{const e=t.childNodes;for(let n=e.length-1;n>=0;n-=1){const o=e[n];o.nodeType===3&&o.nodeValue&&/^(\n\s\s|\n)$/.test(o.nodeValue)?t.removeChild(o):o.nodeType===1&&mg(o)}return t};function Ls(t){if(typeof window>"u")throw new Error("[tiptap error]: there is no window object available, so this function cannot be used");const e=`<body>${t}</body>`,n=new window.DOMParser().parseFromString(e,"text/html").body;return mg(n)}function hs(t,e,n){if(t instanceof Gn||t instanceof M)return t;n={slice:!0,parseOptions:{},...n};const o=typeof t=="object"&&t!==null,r=typeof t=="string";if(o)try{if(Array.isArray(t)&&t.length>0)return M.fromArray(t.map(a=>e.nodeFromJSON(a)));const i=e.nodeFromJSON(t);return n.errorOnInvalidContent&&i.check(),i}catch(s){if(n.errorOnInvalidContent)throw new Error("[tiptap error]: Invalid JSON content",{cause:s});return console.warn("[tiptap warn]: Invalid content.","Passed value:",t,"Error:",s),hs("",e,n)}if(r){if(n.errorOnInvalidContent){let i=!1,a="";const l=new eh({topNode:e.spec.topNode,marks:e.spec.marks,nodes:e.spec.nodes.append({__tiptap__private__unknown__catch__all__node:{content:"inline*",group:"block",parseDOM:[{tag:"*",getAttrs:c=>(i=!0,a=typeof c=="string"?c:c.outerHTML,null)}]}})});if(n.slice?Jn.fromSchema(l).parseSlice(Ls(t),n.parseOptions):Jn.fromSchema(l).parse(Ls(t),n.parseOptions),n.errorOnInvalidContent&&i)throw new Error("[tiptap error]: Invalid HTML content",{cause:new Error(`Invalid element found: ${a}`)})}const s=Jn.fromSchema(e);return n.slice?s.parseSlice(Ls(t),n.parseOptions).content:s.parse(Ls(t),n.parseOptions)}return hs("",e,n)}function wc(t,e,n={},o={}){return hs(t,e,{slice:!1,parseOptions:n,errorOnInvalidContent:o.errorOnInvalidContent})}function Qx(t){for(let e=0;e<t.edgeCount;e+=1){const{type:n}=t.edge(e);if(n.isTextblock&&!n.hasRequiredAttrs())return n}return null}function Zx(t,e,n){const o=[];return t.nodesBetween(e.from,e.to,(r,s)=>{n(r)&&o.push({node:r,pos:s})}),o}function eC(t,e){for(let n=t.depth;n>0;n-=1){const o=t.node(n);if(e(o))return{pos:n>0?t.before(n):0,start:t.start(n),depth:n,node:o}}}function Da(t){return e=>eC(e.$from,t)}function z(t,e,n){return t.config[e]===void 0&&t.parent?z(t.parent,e,n):typeof t.config[e]=="function"?t.config[e].bind({...n,parent:t.parent?z(t.parent,e,n):null}):t.config[e]}function Rd(t){return t.map(e=>{const n={name:e.name,options:e.options,storage:e.storage},o=z(e,"addExtensions",n);return o?[e,...Rd(o())]:e}).flat(10)}function jd(t,e){const n=$o.fromSchema(e).serializeFragment(t),r=document.implementation.createHTMLDocument().createElement("div");return r.appendChild(n),r.innerHTML}function hg(t){return typeof t=="function"}function ye(t,e=void 0,...n){return hg(t)?e?t.bind(e)(...n):t(...n):t}function tC(t={}){return Object.keys(t).length===0&&t.constructor===Object}function gs(t){const e=t.filter(r=>r.type==="extension"),n=t.filter(r=>r.type==="node"),o=t.filter(r=>r.type==="mark");return{baseExtensions:e,nodeExtensions:n,markExtensions:o}}function gg(t){const e=[],{nodeExtensions:n,markExtensions:o}=gs(t),r=[...n,...o],s={default:null,validate:void 0,rendered:!0,renderHTML:null,parseHTML:null,keepOnSplit:!0,isRequired:!1};return t.forEach(i=>{const a={name:i.name,options:i.options,storage:i.storage,extensions:r},l=z(i,"addGlobalAttributes",a);if(!l)return;l().forEach(d=>{d.types.forEach(u=>{Object.entries(d.attributes).forEach(([f,p])=>{e.push({type:u,name:f,attribute:{...s,...p}})})})})}),r.forEach(i=>{const a={name:i.name,options:i.options,storage:i.storage},l=z(i,"addAttributes",a);if(!l)return;const c=l();Object.entries(c).forEach(([d,u])=>{const f={...s,...u};typeof f?.default=="function"&&(f.default=f.default()),f?.isRequired&&f?.default===void 0&&delete f.default,e.push({type:i.name,name:d,attribute:f})})}),e}function Ee(...t){return t.filter(e=>!!e).reduce((e,n)=>{const o={...e};return Object.entries(n).forEach(([r,s])=>{if(!o[r]){o[r]=s;return}if(r==="class"){const a=s?String(s).split(" "):[],l=o[r]?o[r].split(" "):[],c=a.filter(d=>!l.includes(d));o[r]=[...l,...c].join(" ")}else if(r==="style"){const a=s?s.split(";").map(d=>d.trim()).filter(Boolean):[],l=o[r]?o[r].split(";").map(d=>d.trim()).filter(Boolean):[],c=new Map;l.forEach(d=>{const[u,f]=d.split(":").map(p=>p.trim());c.set(u,f)}),a.forEach(d=>{const[u,f]=d.split(":").map(p=>p.trim());c.set(u,f)}),o[r]=Array.from(c.entries()).map(([d,u])=>`${d}: ${u}`).join("; ")}else o[r]=s}),o},{})}function Mi(t,e){return e.filter(n=>n.type===t.type.name).filter(n=>n.attribute.rendered).map(n=>n.attribute.renderHTML?n.attribute.renderHTML(t.attrs)||{}:{[n.name]:t.attrs[n.name]}).reduce((n,o)=>Ee(n,o),{})}function nC(t){return typeof t!="string"?t:t.match(/^[+-]?(?:\d*\.)?\d+$/)?Number(t):t==="true"?!0:t==="false"?!1:t}function _p(t,e){return"style"in t?t:{...t,getAttrs:n=>{const o=t.getAttrs?t.getAttrs(n):t.attrs;if(o===!1)return!1;const r=e.reduce((s,i)=>{const a=i.attribute.parseHTML?i.attribute.parseHTML(n):nC(n.getAttribute(i.name));return a==null?s:{...s,[i.name]:a}},{});return{...o,...r}}}}function $p(t){return Object.fromEntries(Object.entries(t).filter(([e,n])=>e==="attrs"&&tC(n)?!1:n!=null))}function oC(t,e){var n;const o=gg(t),{nodeExtensions:r,markExtensions:s}=gs(t),i=(n=r.find(c=>z(c,"topNode")))==null?void 0:n.name,a=Object.fromEntries(r.map(c=>{const d=o.filter(w=>w.type===c.name),u={name:c.name,options:c.options,storage:c.storage,editor:e},f=t.reduce((w,v)=>{const S=z(v,"extendNodeSchema",u);return{...w,...S?S(c):{}}},{}),p=$p({...f,content:ye(z(c,"content",u)),marks:ye(z(c,"marks",u)),group:ye(z(c,"group",u)),inline:ye(z(c,"inline",u)),atom:ye(z(c,"atom",u)),selectable:ye(z(c,"selectable",u)),draggable:ye(z(c,"draggable",u)),code:ye(z(c,"code",u)),whitespace:ye(z(c,"whitespace",u)),linebreakReplacement:ye(z(c,"linebreakReplacement",u)),defining:ye(z(c,"defining",u)),isolating:ye(z(c,"isolating",u)),attrs:Object.fromEntries(d.map(w=>{var v,S;return[w.name,{default:(v=w?.attribute)==null?void 0:v.default,validate:(S=w?.attribute)==null?void 0:S.validate}]}))}),m=ye(z(c,"parseHTML",u));m&&(p.parseDOM=m.map(w=>_p(w,d)));const b=z(c,"renderHTML",u);b&&(p.toDOM=w=>b({node:w,HTMLAttributes:Mi(w,d)}));const y=z(c,"renderText",u);return y&&(p.toText=y),[c.name,p]})),l=Object.fromEntries(s.map(c=>{const d=o.filter(y=>y.type===c.name),u={name:c.name,options:c.options,storage:c.storage,editor:e},f=t.reduce((y,w)=>{const v=z(w,"extendMarkSchema",u);return{...y,...v?v(c):{}}},{}),p=$p({...f,inclusive:ye(z(c,"inclusive",u)),excludes:ye(z(c,"excludes",u)),group:ye(z(c,"group",u)),spanning:ye(z(c,"spanning",u)),code:ye(z(c,"code",u)),attrs:Object.fromEntries(d.map(y=>{var w,v;return[y.name,{default:(w=y?.attribute)==null?void 0:w.default,validate:(v=y?.attribute)==null?void 0:v.validate}]}))}),m=ye(z(c,"parseHTML",u));m&&(p.parseDOM=m.map(y=>_p(y,d)));const b=z(c,"renderHTML",u);return b&&(p.toDOM=y=>b({mark:y,HTMLAttributes:Mi(y,d)})),[c.name,p]}));return new eh({topNode:i,nodes:a,marks:l})}function rC(t){const e=t.filter((n,o)=>t.indexOf(n)!==o);return Array.from(new Set(e))}function _d(t){return t.sort((n,o)=>{const r=z(n,"priority")||100,s=z(o,"priority")||100;return r>s?-1:r<s?1:0})}function bg(t){const e=_d(Rd(t)),n=rC(e.map(o=>o.name));return n.length&&console.warn(`[tiptap warn]: Duplicate extension names found: [${n.map(o=>`'${o}'`).join(", ")}]. This can lead to issues.`),e}function yg(t,e,n){const{from:o,to:r}=e,{blockSeparator:s=`

`,textSerializers:i={}}=n||{};let a="";return t.nodesBetween(o,r,(l,c,d,u)=>{var f;l.isBlock&&c>o&&(a+=s);const p=i?.[l.type.name];if(p)return d&&(a+=p({node:l,pos:c,parent:d,index:u,range:e})),!1;l.isText&&(a+=(f=l?.text)==null?void 0:f.slice(Math.max(o,c)-c,r-c))}),a}function sC(t,e){const n={from:0,to:t.content.size};return yg(t,n,e)}function wg(t){return Object.fromEntries(Object.entries(t.nodes).filter(([,e])=>e.spec.toText).map(([e,n])=>[e,n.spec.toText]))}function Mn(t,e){if(typeof t=="string"){if(!e.marks[t])throw Error(`There is no mark type named '${t}'. Maybe you forgot to add the extension?`);return e.marks[t]}return t}function vg(t,e){const n=Mn(e,t.schema),{from:o,to:r,empty:s}=t.selection,i=[];s?(t.storedMarks&&i.push(...t.storedMarks),i.push(...t.selection.$head.marks())):t.doc.nodesBetween(o,r,l=>{i.push(...l.marks)});const a=i.find(l=>l.type.name===n.name);return a?{...a.attrs}:{}}function $e(t,e){if(typeof t=="string"){if(!e.nodes[t])throw Error(`There is no node type named '${t}'. Maybe you forgot to add the extension?`);return e.nodes[t]}return t}function iC(t,e){const n=$e(e,t.schema),{from:o,to:r}=t.selection,s=[];t.doc.nodesBetween(o,r,a=>{s.push(a)});const i=s.reverse().find(a=>a.type.name===n.name);return i?{...i.attrs}:{}}function Ra(t,e){return e.nodes[t]?"node":e.marks[t]?"mark":null}function Sg(t,e){const n=Ra(typeof e=="string"?e:e.name,t.schema);return n==="node"?iC(t,e):n==="mark"?vg(t,e):{}}function aC(t,e=JSON.stringify){const n={};return t.filter(o=>{const r=e(o);return Object.prototype.hasOwnProperty.call(n,r)?!1:n[r]=!0})}function lC(t){const e=aC(t);return e.length===1?e:e.filter((n,o)=>!e.filter((s,i)=>i!==o).some(s=>n.oldRange.from>=s.oldRange.from&&n.oldRange.to<=s.oldRange.to&&n.newRange.from>=s.newRange.from&&n.newRange.to<=s.newRange.to))}function kg(t){const{mapping:e,steps:n}=t,o=[];return e.maps.forEach((r,s)=>{const i=[];if(r.ranges.length)r.forEach((a,l)=>{i.push({from:a,to:l})});else{const{from:a,to:l}=n[s];if(a===void 0||l===void 0)return;i.push({from:a,to:l})}i.forEach(({from:a,to:l})=>{const c=e.slice(s).map(a,-1),d=e.slice(s).map(l),u=e.invert().map(c,-1),f=e.invert().map(d);o.push({oldRange:{from:u,to:f},newRange:{from:c,to:d}})})}),lC(o)}function $d(t){return Object.prototype.toString.call(t)==="[object RegExp]"}function Ti(t,e,n={strict:!0}){const o=Object.keys(e);return o.length?o.every(r=>n.strict?e[r]===t[r]:$d(e[r])?e[r].test(t[r]):e[r]===t[r]):!0}function xg(t,e,n={}){return t.find(o=>o.type===e&&Ti(Object.fromEntries(Object.keys(n).map(r=>[r,o.attrs[r]])),n))}function Fp(t,e,n={}){return!!xg(t,e,n)}function Fd(t,e,n){var o;if(!t||!e)return;let r=t.parent.childAfter(t.parentOffset);if((!r.node||!r.node.marks.some(d=>d.type===e))&&(r=t.parent.childBefore(t.parentOffset)),!r.node||!r.node.marks.some(d=>d.type===e)||(n=n||((o=r.node.marks[0])==null?void 0:o.attrs),!xg([...r.node.marks],e,n)))return;let i=r.index,a=t.start()+r.offset,l=i+1,c=a+r.node.nodeSize;for(;i>0&&Fp([...t.parent.child(i-1).marks],e,n);)i-=1,a-=t.parent.child(i).nodeSize;for(;l<t.parent.childCount&&Fp([...t.parent.child(l).marks],e,n);)c+=t.parent.child(l).nodeSize,l+=1;return{from:a,to:c}}function Wd(t,e,n){const o=[];return t===e?n.resolve(t).marks().forEach(r=>{const s=n.resolve(t),i=Fd(s,r.type);i&&o.push({mark:r,...i})}):n.nodesBetween(t,e,(r,s)=>{!r||r?.nodeSize===void 0||o.push(...r.marks.map(i=>({from:s,to:s+r.nodeSize,mark:i})))}),o}var cC=(t,e,n,o=20)=>{const r=t.doc.resolve(n);let s=o,i=null;for(;s>0&&i===null;){const a=r.node(s);a?.type.name===e?i=a:s-=1}return[i,s]};function ml(t,e){return e.nodes[t]||e.marks[t]||null}function ti(t,e,n){return Object.fromEntries(Object.entries(n).filter(([o])=>{const r=t.find(s=>s.type===e&&s.name===o);return r?r.attribute.keepOnSplit:!1}))}var dC=(t,e=500)=>{let n="";const o=t.parentOffset;return t.parent.nodesBetween(Math.max(0,o-e),o,(r,s,i,a)=>{var l,c;const d=((c=(l=r.type.spec).toText)==null?void 0:c.call(l,{node:r,pos:s,parent:i,index:a}))||r.textContent||"%leaf%";n+=r.isAtom&&!r.isText?d:d.slice(0,Math.max(0,o-s))}),n};function vc(t,e,n={}){const{empty:o,ranges:r}=t.selection,s=e?Mn(e,t.schema):null;if(o)return!!(t.storedMarks||t.selection.$from.marks()).filter(u=>s?s.name===u.type.name:!0).find(u=>Ti(u.attrs,n,{strict:!1}));let i=0;const a=[];if(r.forEach(({$from:u,$to:f})=>{const p=u.pos,m=f.pos;t.doc.nodesBetween(p,m,(b,y)=>{if(!b.isText&&!b.marks.length)return;const w=Math.max(p,y),v=Math.min(m,y+b.nodeSize),S=v-w;i+=S,a.push(...b.marks.map(C=>({mark:C,from:w,to:v})))})}),i===0)return!1;const l=a.filter(u=>s?s.name===u.mark.type.name:!0).filter(u=>Ti(u.mark.attrs,n,{strict:!1})).reduce((u,f)=>u+f.to-f.from,0),c=a.filter(u=>s?u.mark.type!==s&&u.mark.type.excludes(s):!0).reduce((u,f)=>u+f.to-f.from,0);return(l>0?l+c:l)>=i}function no(t,e,n={}){const{from:o,to:r,empty:s}=t.selection,i=e?$e(e,t.schema):null,a=[];t.doc.nodesBetween(o,r,(u,f)=>{if(u.isText)return;const p=Math.max(o,f),m=Math.min(r,f+u.nodeSize);a.push({node:u,from:p,to:m})});const l=r-o,c=a.filter(u=>i?i.name===u.node.type.name:!0).filter(u=>Ti(u.node.attrs,n,{strict:!1}));return s?!!c.length:c.reduce((u,f)=>u+f.to-f.from,0)>=l}function uC(t,e,n={}){if(!e)return no(t,null,n)||vc(t,null,n);const o=Ra(e,t.schema);return o==="node"?no(t,e,n):o==="mark"?vc(t,e,n):!1}var pC=(t,e)=>{const{$from:n,$to:o,$anchor:r}=t.selection;if(e){const s=Da(a=>a.type.name===e)(t.selection);if(!s)return!1;const i=t.doc.resolve(s.pos+1);return r.pos+1===i.end()}return!(o.parentOffset<o.parent.nodeSize-2||n.pos!==o.pos)},fC=t=>{const{$from:e,$to:n}=t.selection;return!(e.parentOffset>0||e.pos!==n.pos)};function Wp(t,e){return Array.isArray(e)?e.some(n=>(typeof n=="string"?n:n.name)===t.name):e}function zp(t,e){const{nodeExtensions:n}=gs(e),o=n.find(i=>i.name===t);if(!o)return!1;const r={name:o.name,options:o.options,storage:o.storage},s=ye(z(o,"group",r));return typeof s!="string"?!1:s.split(" ").includes("list")}function ja(t,{checkChildren:e=!0,ignoreWhitespace:n=!1}={}){var o;if(n){if(t.type.name==="hardBreak")return!0;if(t.isText)return/^\s*$/m.test((o=t.text)!=null?o:"")}if(t.isText)return!t.text;if(t.isAtom||t.isLeaf)return!1;if(t.content.childCount===0)return!0;if(e){let r=!0;return t.content.forEach(s=>{r!==!1&&(ja(s,{ignoreWhitespace:n,checkChildren:e})||(r=!1))}),r}return!1}function Cg(t){return t instanceof U}function Eg(t){return t instanceof Z}function vo(t=0,e=0,n=0){return Math.min(Math.max(t,e),n)}function Ig(t,e=null){if(!e)return null;const n=ne.atStart(t),o=ne.atEnd(t);if(e==="start"||e===!0)return n;if(e==="end")return o;const r=n.from,s=o.to;return e==="all"?Z.create(t,vo(0,r,s),vo(t.content.size,r,s)):Z.create(t,vo(e,r,s),vo(e,r,s))}function mC(t,e,n){const o=t.steps.length-1;if(o<e)return;const r=t.steps[o];if(!(r instanceof We||r instanceof He))return;const s=t.mapping.maps[o];let i=0;s.forEach((a,l,c,d)=>{i===0&&(i=d)}),t.setSelection(ne.near(t.doc.resolve(i),n))}var _a=class{constructor(t){this.find=t.find,this.handler=t.handler}},hC=(t,e)=>{if($d(e))return e.exec(t);const n=e(t);if(!n)return null;const o=[n.text];return o.index=n.index,o.input=t,o.data=n.data,n.replaceWith&&(n.text.includes(n.replaceWith)||console.warn('[tiptap warn]: "inputRuleMatch.replaceWith" must be part of "inputRuleMatch.text".'),o.push(n.replaceWith)),o};function Ds(t){var e;const{editor:n,from:o,to:r,text:s,rules:i,plugin:a}=t,{view:l}=n;if(l.composing)return!1;const c=l.state.doc.resolve(o);if(c.parent.type.spec.code||(e=c.nodeBefore||c.nodeAfter)!=null&&e.marks.find(f=>f.type.spec.code))return!1;let d=!1;const u=dC(c)+s;return i.forEach(f=>{if(d)return;const p=hC(u,f.find);if(!p)return;const m=l.state.tr,b=Oa({state:l.state,transaction:m}),y={from:o-(p[0].length-s.length),to:r},{commands:w,chain:v,can:S}=new La({editor:n,state:b});f.handler({state:b,range:y,match:p,commands:w,chain:v,can:S})===null||!m.steps.length||(m.setMeta(a,{transform:m,from:o,to:r,text:s}),l.dispatch(m),d=!0)}),d}function gC(t){const{editor:e,rules:n}=t,o=new Me({state:{init(){return null},apply(r,s,i){const a=r.getMeta(o);if(a)return a;const l=r.getMeta("applyInputRules");return!!l&&setTimeout(()=>{let{text:d}=l;typeof d=="string"?d=d:d=jd(M.from(d),i.schema);const{from:u}=l,f=u+d.length;Ds({editor:e,from:u,to:f,text:d,rules:n,plugin:o})}),r.selectionSet||r.docChanged?null:s}},props:{handleTextInput(r,s,i,a){return Ds({editor:e,from:s,to:i,text:a,rules:n,plugin:o})},handleDOMEvents:{compositionend:r=>(setTimeout(()=>{const{$cursor:s}=r.state.selection;s&&Ds({editor:e,from:s.pos,to:s.pos,text:"",rules:n,plugin:o})}),!1)},handleKeyDown(r,s){if(s.key!=="Enter")return!1;const{$cursor:i}=r.state.selection;return i?Ds({editor:e,from:i.pos,to:i.pos,text:`
`,rules:n,plugin:o}):!1}},isInputRules:!0});return o}function bC(t){return Object.prototype.toString.call(t).slice(8,-1)}function Rs(t){return bC(t)!=="Object"?!1:t.constructor===Object&&Object.getPrototypeOf(t)===Object.prototype}function Ag(t,e){const n={...t};return Rs(t)&&Rs(e)&&Object.keys(e).forEach(o=>{Rs(e[o])&&Rs(t[o])?n[o]=Ag(t[o],e[o]):n[o]=e[o]}),n}var zd=class{constructor(t={}){this.type="extendable",this.parent=null,this.child=null,this.name="",this.config={name:this.name},this.config={...this.config,...t},this.name=this.config.name}get options(){return{...ye(z(this,"addOptions",{name:this.name}))||{}}}get storage(){return{...ye(z(this,"addStorage",{name:this.name,options:this.options}))||{}}}configure(t={}){const e=this.extend({...this.config,addOptions:()=>Ag(this.options,t)});return e.name=this.name,e.parent=this.parent,e}extend(t={}){const e=new this.constructor({...this.config,...t});return e.parent=this,this.child=e,e.name="name"in t?t.name:e.parent.name,e}},nn=class Ng extends zd{constructor(){super(...arguments),this.type="mark"}static create(e={}){const n=typeof e=="function"?e():e;return new Ng(n)}static handleExit({editor:e,mark:n}){const{tr:o}=e.state,r=e.state.selection.$from;if(r.pos===r.end()){const i=r.marks();if(!!!i.find(c=>c?.type.name===n.name))return!1;const l=i.find(c=>c?.type.name===n.name);return l&&o.removeStoredMark(l),o.insertText(" ",r.pos),e.view.dispatch(o),!0}return!1}configure(e){return super.configure(e)}extend(e){const n=typeof e=="function"?e():e;return super.extend(n)}};function yC(t){return typeof t=="number"}var wC=class{constructor(t){this.find=t.find,this.handler=t.handler}},vC=(t,e,n)=>{if($d(e))return[...t.matchAll(e)];const o=e(t,n);return o?o.map(r=>{const s=[r.text];return s.index=r.index,s.input=t,s.data=r.data,r.replaceWith&&(r.text.includes(r.replaceWith)||console.warn('[tiptap warn]: "pasteRuleMatch.replaceWith" must be part of "pasteRuleMatch.text".'),s.push(r.replaceWith)),s}):[]};function SC(t){const{editor:e,state:n,from:o,to:r,rule:s,pasteEvent:i,dropEvent:a}=t,{commands:l,chain:c,can:d}=new La({editor:e,state:n}),u=[];return n.doc.nodesBetween(o,r,(p,m)=>{if(!p.isTextblock||p.type.spec.code)return;const b=Math.max(o,m),y=Math.min(r,m+p.content.size),w=p.textBetween(b-m,y-m,void 0,"ï¿¼");vC(w,s.find,i).forEach(S=>{if(S.index===void 0)return;const C=b+S.index+1,x=C+S[0].length,I={from:n.tr.mapping.map(C),to:n.tr.mapping.map(x)},N=s.handler({state:n,range:I,match:S,commands:l,chain:c,can:d,pasteEvent:i,dropEvent:a});u.push(N)})}),u.every(p=>p!==null)}var js=null,kC=t=>{var e;const n=new ClipboardEvent("paste",{clipboardData:new DataTransfer});return(e=n.clipboardData)==null||e.setData("text/html",t),n};function xC(t){const{editor:e,rules:n}=t;let o=null,r=!1,s=!1,i=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,a;try{a=typeof DragEvent<"u"?new DragEvent("drop"):null}catch{a=null}const l=({state:d,from:u,to:f,rule:p,pasteEvt:m})=>{const b=d.tr,y=Oa({state:d,transaction:b});if(!(!SC({editor:e,state:y,from:Math.max(u-1,0),to:f.b-1,rule:p,pasteEvent:m,dropEvent:a})||!b.steps.length)){try{a=typeof DragEvent<"u"?new DragEvent("drop"):null}catch{a=null}return i=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,b}};return n.map(d=>new Me({view(u){const f=m=>{var b;o=(b=u.dom.parentElement)!=null&&b.contains(m.target)?u.dom.parentElement:null,o&&(js=e)},p=()=>{js&&(js=null)};return window.addEventListener("dragstart",f),window.addEventListener("dragend",p),{destroy(){window.removeEventListener("dragstart",f),window.removeEventListener("dragend",p)}}},props:{handleDOMEvents:{drop:(u,f)=>{if(s=o===u.dom.parentElement,a=f,!s){const p=js;p?.isEditable&&setTimeout(()=>{const m=p.state.selection;m&&p.commands.deleteRange({from:m.from,to:m.to})},10)}return!1},paste:(u,f)=>{var p;const m=(p=f.clipboardData)==null?void 0:p.getData("text/html");return i=f,r=!!m?.includes("data-pm-slice"),!1}}},appendTransaction:(u,f,p)=>{const m=u[0],b=m.getMeta("uiEvent")==="paste"&&!r,y=m.getMeta("uiEvent")==="drop"&&!s,w=m.getMeta("applyPasteRules"),v=!!w;if(!b&&!y&&!v)return;if(v){let{text:x}=w;typeof x=="string"?x=x:x=jd(M.from(x),p.schema);const{from:I}=w,N=I+x.length,E=kC(x);return l({rule:d,state:p,from:I,to:{b:N},pasteEvt:E})}const S=f.doc.content.findDiffStart(p.doc.content),C=f.doc.content.findDiffEnd(p.doc.content);if(!(!yC(S)||!C||S===C.b))return l({rule:d,state:p,from:S,to:C,pasteEvt:i})}}))}var $a=class{constructor(t,e){this.splittableMarks=[],this.editor=e,this.extensions=bg(t),this.schema=oC(this.extensions,e),this.setupExtensions()}get commands(){return this.extensions.reduce((t,e)=>{const n={name:e.name,options:e.options,storage:this.editor.extensionStorage[e.name],editor:this.editor,type:ml(e.name,this.schema)},o=z(e,"addCommands",n);return o?{...t,...o()}:t},{})}get plugins(){const{editor:t}=this,e=_d([...this.extensions].reverse()),n=[],o=[],r=e.map(s=>{const i={name:s.name,options:s.options,storage:this.editor.extensionStorage[s.name],editor:t,type:ml(s.name,this.schema)},a=[],l=z(s,"addKeyboardShortcuts",i);let c={};if(s.type==="mark"&&z(s,"exitable",i)&&(c.ArrowRight=()=>nn.handleExit({editor:t,mark:s})),l){const m=Object.fromEntries(Object.entries(l()).map(([b,y])=>[b,()=>y({editor:t})]));c={...c,...m}}const d=Mx(c);a.push(d);const u=z(s,"addInputRules",i);Wp(s,t.options.enableInputRules)&&u&&n.push(...u());const f=z(s,"addPasteRules",i);Wp(s,t.options.enablePasteRules)&&f&&o.push(...f());const p=z(s,"addProseMirrorPlugins",i);if(p){const m=p();a.push(...m)}return a}).flat();return[gC({editor:t,rules:n}),...xC({editor:t,rules:o}),...r]}get attributes(){return gg(this.extensions)}get nodeViews(){const{editor:t}=this,{nodeExtensions:e}=gs(this.extensions);return Object.fromEntries(e.filter(n=>!!z(n,"addNodeView")).map(n=>{const o=this.attributes.filter(a=>a.type===n.name),r={name:n.name,options:n.options,storage:this.editor.extensionStorage[n.name],editor:t,type:$e(n.name,this.schema)},s=z(n,"addNodeView",r);if(!s)return[];const i=(a,l,c,d,u)=>{const f=Mi(a,o);return s()({node:a,view:l,getPos:c,decorations:d,innerDecorations:u,editor:t,extension:n,HTMLAttributes:f})};return[n.name,i]}))}get markViews(){const{editor:t}=this,{markExtensions:e}=gs(this.extensions);return Object.fromEntries(e.filter(n=>!!z(n,"addMarkView")).map(n=>{const o=this.attributes.filter(a=>a.type===n.name),r={name:n.name,options:n.options,storage:this.editor.extensionStorage[n.name],editor:t,type:Mn(n.name,this.schema)},s=z(n,"addMarkView",r);if(!s)return[];const i=(a,l,c)=>{const d=Mi(a,o);return s()({mark:a,view:l,inline:c,editor:t,extension:n,HTMLAttributes:d,updateAttributes:u=>{$0(a,t,u)}})};return[n.name,i]}))}setupExtensions(){const t=this.extensions;this.editor.extensionStorage=Object.fromEntries(t.map(e=>[e.name,e.storage])),t.forEach(e=>{var n;const o={name:e.name,options:e.options,storage:this.editor.extensionStorage[e.name],editor:this.editor,type:ml(e.name,this.schema)};e.type==="mark"&&((n=ye(z(e,"keepOnSplit",o)))==null||n)&&this.splittableMarks.push(e.name);const r=z(e,"onBeforeCreate",o),s=z(e,"onCreate",o),i=z(e,"onUpdate",o),a=z(e,"onSelectionUpdate",o),l=z(e,"onTransaction",o),c=z(e,"onFocus",o),d=z(e,"onBlur",o),u=z(e,"onDestroy",o);r&&this.editor.on("beforeCreate",r),s&&this.editor.on("create",s),i&&this.editor.on("update",i),a&&this.editor.on("selectionUpdate",a),l&&this.editor.on("transaction",l),c&&this.editor.on("focus",c),d&&this.editor.on("blur",d),u&&this.editor.on("destroy",u)})}};$a.resolve=bg;$a.sort=_d;$a.flatten=Rd;var CC={};pg(CC,{ClipboardTextSerializer:()=>Tg,Commands:()=>Og,Delete:()=>Lg,Drop:()=>Dg,Editable:()=>Rg,FocusEvents:()=>_g,Keymap:()=>$g,Paste:()=>Fg,Tabindex:()=>Wg,focusEventsPluginKey:()=>jg});var ve=class Mg extends zd{constructor(){super(...arguments),this.type="extension"}static create(e={}){const n=typeof e=="function"?e():e;return new Mg(n)}configure(e){return super.configure(e)}extend(e){const n=typeof e=="function"?e():e;return super.extend(n)}},Tg=ve.create({name:"clipboardTextSerializer",addOptions(){return{blockSeparator:void 0}},addProseMirrorPlugins(){return[new Me({key:new Fe("clipboardTextSerializer"),props:{clipboardTextSerializer:()=>{const{editor:t}=this,{state:e,schema:n}=t,{doc:o,selection:r}=e,{ranges:s}=r,i=Math.min(...s.map(d=>d.$from.pos)),a=Math.max(...s.map(d=>d.$to.pos)),l=wg(n);return yg(o,{from:i,to:a},{...this.options.blockSeparator!==void 0?{blockSeparator:this.options.blockSeparator}:{},textSerializers:l})}}})]}}),Pg={};pg(Pg,{blur:()=>EC,clearContent:()=>IC,clearNodes:()=>AC,command:()=>NC,createParagraphNear:()=>MC,cut:()=>TC,deleteCurrentNode:()=>PC,deleteNode:()=>BC,deleteRange:()=>OC,deleteSelection:()=>LC,enter:()=>DC,exitCode:()=>RC,extendMarkRange:()=>jC,first:()=>_C,focus:()=>FC,forEach:()=>WC,insertContent:()=>zC,insertContentAt:()=>UC,joinBackward:()=>KC,joinDown:()=>qC,joinForward:()=>GC,joinItemBackward:()=>JC,joinItemForward:()=>YC,joinTextblockBackward:()=>XC,joinTextblockForward:()=>QC,joinUp:()=>VC,keyboardShortcut:()=>e0,lift:()=>t0,liftEmptyBlock:()=>n0,liftListItem:()=>o0,newlineInCode:()=>r0,resetAttributes:()=>s0,scrollIntoView:()=>i0,selectAll:()=>a0,selectNodeBackward:()=>l0,selectNodeForward:()=>c0,selectParentNode:()=>d0,selectTextblockEnd:()=>u0,selectTextblockStart:()=>p0,setContent:()=>f0,setMark:()=>h0,setMeta:()=>g0,setNode:()=>b0,setNodeSelection:()=>y0,setTextSelection:()=>w0,sinkListItem:()=>v0,splitBlock:()=>S0,splitListItem:()=>k0,toggleList:()=>x0,toggleMark:()=>C0,toggleNode:()=>E0,toggleWrap:()=>I0,undoInputRule:()=>A0,unsetAllMarks:()=>N0,unsetMark:()=>M0,updateAttributes:()=>T0,wrapIn:()=>P0,wrapInList:()=>B0});var EC=()=>({editor:t,view:e})=>(requestAnimationFrame(()=>{var n;t.isDestroyed||(e.dom.blur(),(n=window?.getSelection())==null||n.removeAllRanges())}),!0),IC=(t=!0)=>({commands:e})=>e.setContent("",{emitUpdate:t}),AC=()=>({state:t,tr:e,dispatch:n})=>{const{selection:o}=e,{ranges:r}=o;return n&&r.forEach(({$from:s,$to:i})=>{t.doc.nodesBetween(s.pos,i.pos,(a,l)=>{if(a.type.isText)return;const{doc:c,mapping:d}=e,u=c.resolve(d.map(l)),f=c.resolve(d.map(l+a.nodeSize)),p=u.blockRange(f);if(!p)return;const m=wr(p);if(a.type.isTextblock){const{defaultType:b}=u.parent.contentMatchAt(u.index());e.setNodeMarkup(p.start,b)}(m||m===0)&&e.lift(p,m)})}),!0},NC=t=>e=>t(e),MC=()=>({state:t,dispatch:e})=>lg(t,e),TC=(t,e)=>({editor:n,tr:o})=>{const{state:r}=n,s=r.doc.slice(t.from,t.to);o.deleteRange(t.from,t.to);const i=o.mapping.map(e);return o.insert(i,s.content),o.setSelection(new Z(o.doc.resolve(Math.max(i-1,0)))),!0},PC=()=>({tr:t,dispatch:e})=>{const{selection:n}=t,o=n.$anchor.node();if(o.content.size>0)return!1;const r=t.selection.$anchor;for(let s=r.depth;s>0;s-=1)if(r.node(s).type===o.type){if(e){const a=r.before(s),l=r.after(s);t.delete(a,l).scrollIntoView()}return!0}return!1},BC=t=>({tr:e,state:n,dispatch:o})=>{const r=$e(t,n.schema),s=e.selection.$anchor;for(let i=s.depth;i>0;i-=1)if(s.node(i).type===r){if(o){const l=s.before(i),c=s.after(i);e.delete(l,c).scrollIntoView()}return!0}return!1},OC=t=>({tr:e,dispatch:n})=>{const{from:o,to:r}=t;return n&&e.delete(o,r),!0},LC=()=>({state:t,dispatch:e})=>Pd(t,e),DC=()=>({commands:t})=>t.keyboardShortcut("Enter"),RC=()=>({state:t,dispatch:e})=>Dx(t,e),jC=(t,e={})=>({tr:n,state:o,dispatch:r})=>{const s=Mn(t,o.schema),{doc:i,selection:a}=n,{$from:l,from:c,to:d}=a;if(r){const u=Fd(l,s,e);if(u&&u.from<=c&&u.to>=d){const f=Z.create(i,u.from,u.to);n.setSelection(f)}}return!0},_C=t=>e=>{const n=typeof t=="function"?t(e):t;for(let o=0;o<n.length;o+=1)if(n[o](e))return!0;return!1};function $C(){return navigator.platform==="Android"||/android/i.test(navigator.userAgent)}function Hd(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}var FC=(t=null,e={})=>({editor:n,view:o,tr:r,dispatch:s})=>{e={scrollIntoView:!0,...e};const i=()=>{(Hd()||$C())&&o.dom.focus(),requestAnimationFrame(()=>{n.isDestroyed||(o.focus(),e?.scrollIntoView&&n.commands.scrollIntoView())})};if(o.hasFocus()&&t===null||t===!1)return!0;if(s&&t===null&&!Eg(n.state.selection))return i(),!0;const a=Ig(r.doc,t)||n.state.selection,l=n.state.selection.eq(a);return s&&(l||r.setSelection(a),l&&r.storedMarks&&r.setStoredMarks(r.storedMarks),i()),!0},WC=(t,e)=>n=>t.every((o,r)=>e(o,{...n,index:r})),zC=(t,e)=>({tr:n,commands:o})=>o.insertContentAt({from:n.selection.from,to:n.selection.to},t,e),HC=t=>!("type"in t),UC=(t,e,n)=>({tr:o,dispatch:r,editor:s})=>{var i;if(r){n={parseOptions:s.options.parseOptions,updateSelection:!0,applyInputRules:!1,applyPasteRules:!1,...n};let a;const{selection:l}=s.state,c=w=>{s.emit("contentError",{editor:s,error:w,disableCollaboration:()=>{"collaboration"in s.storage&&typeof s.storage.collaboration=="object"&&s.storage.collaboration&&(s.storage.collaboration.isDisabled=!0)}})},d={preserveWhitespace:"full",...n.parseOptions};if(!n.errorOnInvalidContent&&!s.options.enableContentCheck&&s.options.emitContentError)try{hs(e,s.schema,{parseOptions:d,errorOnInvalidContent:!0})}catch(w){c(w)}try{a=hs(e,s.schema,{parseOptions:d,errorOnInvalidContent:(i=n.errorOnInvalidContent)!=null?i:s.options.enableContentCheck})}catch(w){return c(w),!1}let{from:u,to:f}=typeof t=="number"?{from:t,to:t}:{from:t.from,to:t.to},p=!0,m=!0;if((HC(a)?a:[a]).forEach(w=>{w.check(),p=p?w.isText&&w.marks.length===0:!1,m=m?w.isBlock:!1}),u===f&&m){const{parent:w}=o.doc.resolve(u);w.isTextblock&&!w.type.spec.code&&!w.childCount&&(u-=1,f+=1)}let y;if(p){if(Array.isArray(e))y=e.map(w=>w.text||"").join("");else if(e instanceof M){let w="";e.forEach(v=>{v.text&&(w+=v.text)}),y=w}else typeof e=="object"&&e&&e.text?y=e.text:y=e;o.insertText(y,u,f)}else{y=a;const w=l.$from.parentOffset===0,v=l.$from.node().isText||l.$from.node().isTextblock,S=l.$from.node().content.size>0;w&&v&&S&&(u=Math.max(0,u-1)),o.replaceWith(u,f,y)}n.updateSelection&&mC(o,o.steps.length-1,-1),n.applyInputRules&&o.setMeta("applyInputRules",{from:u,text:y}),n.applyPasteRules&&o.setMeta("applyPasteRules",{from:u,text:y})}return!0},VC=()=>({state:t,dispatch:e})=>Bx(t,e),qC=()=>({state:t,dispatch:e})=>Ox(t,e),KC=()=>({state:t,dispatch:e})=>tg(t,e),GC=()=>({state:t,dispatch:e})=>sg(t,e),JC=()=>({state:t,dispatch:e,tr:n})=>{try{const o=Aa(t.doc,t.selection.$from.pos,-1);return o==null?!1:(n.join(o,2),e&&e(n),!0)}catch{return!1}},YC=()=>({state:t,dispatch:e,tr:n})=>{try{const o=Aa(t.doc,t.selection.$from.pos,1);return o==null?!1:(n.join(o,2),e&&e(n),!0)}catch{return!1}},XC=()=>({state:t,dispatch:e})=>Tx(t,e),QC=()=>({state:t,dispatch:e})=>Px(t,e);function Bg(){return typeof navigator<"u"?/Mac/.test(navigator.platform):!1}function ZC(t){const e=t.split(/-(?!$)/);let n=e[e.length-1];n==="Space"&&(n=" ");let o,r,s,i;for(let a=0;a<e.length-1;a+=1){const l=e[a];if(/^(cmd|meta|m)$/i.test(l))i=!0;else if(/^a(lt)?$/i.test(l))o=!0;else if(/^(c|ctrl|control)$/i.test(l))r=!0;else if(/^s(hift)?$/i.test(l))s=!0;else if(/^mod$/i.test(l))Hd()||Bg()?i=!0:r=!0;else throw new Error(`Unrecognized modifier name: ${l}`)}return o&&(n=`Alt-${n}`),r&&(n=`Ctrl-${n}`),i&&(n=`Meta-${n}`),s&&(n=`Shift-${n}`),n}var e0=t=>({editor:e,view:n,tr:o,dispatch:r})=>{const s=ZC(t).split(/-(?!$)/),i=s.find(c=>!["Alt","Ctrl","Meta","Shift"].includes(c)),a=new KeyboardEvent("keydown",{key:i==="Space"?" ":i,altKey:s.includes("Alt"),ctrlKey:s.includes("Ctrl"),metaKey:s.includes("Meta"),shiftKey:s.includes("Shift"),bubbles:!0,cancelable:!0}),l=e.captureTransaction(()=>{n.someProp("handleKeyDown",c=>c(n,a))});return l?.steps.forEach(c=>{const d=c.map(o.mapping);d&&r&&o.maybeStep(d)}),!0},t0=(t,e={})=>({state:n,dispatch:o})=>{const r=$e(t,n.schema);return no(n,r,e)?Lx(n,o):!1},n0=()=>({state:t,dispatch:e})=>cg(t,e),o0=t=>({state:e,dispatch:n})=>{const o=$e(t,e.schema);return qx(o)(e,n)},r0=()=>({state:t,dispatch:e})=>ag(t,e);function Hp(t,e){const n=typeof e=="string"?[e]:e;return Object.keys(t).reduce((o,r)=>(n.includes(r)||(o[r]=t[r]),o),{})}var s0=(t,e)=>({tr:n,state:o,dispatch:r})=>{let s=null,i=null;const a=Ra(typeof t=="string"?t:t.name,o.schema);return a?(a==="node"&&(s=$e(t,o.schema)),a==="mark"&&(i=Mn(t,o.schema)),r&&n.selection.ranges.forEach(l=>{o.doc.nodesBetween(l.$from.pos,l.$to.pos,(c,d)=>{s&&s===c.type&&n.setNodeMarkup(d,void 0,Hp(c.attrs,e)),i&&c.marks.length&&c.marks.forEach(u=>{i===u.type&&n.addMark(d,d+c.nodeSize,i.create(Hp(u.attrs,e)))})})}),!0):!1},i0=()=>({tr:t,dispatch:e})=>(e&&t.scrollIntoView(),!0),a0=()=>({tr:t,dispatch:e})=>{if(e){const n=new St(t.doc);t.setSelection(n)}return!0},l0=()=>({state:t,dispatch:e})=>og(t,e),c0=()=>({state:t,dispatch:e})=>ig(t,e),d0=()=>({state:t,dispatch:e})=>_x(t,e),u0=()=>({state:t,dispatch:e})=>Wx(t,e),p0=()=>({state:t,dispatch:e})=>Fx(t,e),f0=(t,{errorOnInvalidContent:e,emitUpdate:n=!0,parseOptions:o={}}={})=>({editor:r,tr:s,dispatch:i,commands:a})=>{const{doc:l}=s;if(o.preserveWhitespace!=="full"){const c=wc(t,r.schema,o,{errorOnInvalidContent:e??r.options.enableContentCheck});return i&&s.replaceWith(0,l.content.size,c).setMeta("preventUpdate",!n),!0}return i&&s.setMeta("preventUpdate",!n),a.insertContentAt({from:0,to:l.content.size},t,{parseOptions:o,errorOnInvalidContent:e??r.options.enableContentCheck})};function m0(t,e,n){var o;const{selection:r}=e;let s=null;if(Eg(r)&&(s=r.$cursor),s){const a=(o=t.storedMarks)!=null?o:s.marks();return!!n.isInSet(a)||!a.some(l=>l.type.excludes(n))}const{ranges:i}=r;return i.some(({$from:a,$to:l})=>{let c=a.depth===0?t.doc.inlineContent&&t.doc.type.allowsMarkType(n):!1;return t.doc.nodesBetween(a.pos,l.pos,(d,u,f)=>{if(c)return!1;if(d.isInline){const p=!f||f.type.allowsMarkType(n),m=!!n.isInSet(d.marks)||!d.marks.some(b=>b.type.excludes(n));c=p&&m}return!c}),c})}var h0=(t,e={})=>({tr:n,state:o,dispatch:r})=>{const{selection:s}=n,{empty:i,ranges:a}=s,l=Mn(t,o.schema);if(r)if(i){const c=vg(o,l);n.addStoredMark(l.create({...c,...e}))}else a.forEach(c=>{const d=c.$from.pos,u=c.$to.pos;o.doc.nodesBetween(d,u,(f,p)=>{const m=Math.max(p,d),b=Math.min(p+f.nodeSize,u);f.marks.find(w=>w.type===l)?f.marks.forEach(w=>{l===w.type&&n.addMark(m,b,l.create({...w.attrs,...e}))}):n.addMark(m,b,l.create(e))})});return m0(o,n,l)},g0=(t,e)=>({tr:n})=>(n.setMeta(t,e),!0),b0=(t,e={})=>({state:n,dispatch:o,chain:r})=>{const s=$e(t,n.schema);let i;return n.selection.$anchor.sameParent(n.selection.$head)&&(i=n.selection.$anchor.parent.attrs),s.isTextblock?r().command(({commands:a})=>jp(s,{...i,...e})(n)?!0:a.clearNodes()).command(({state:a})=>jp(s,{...i,...e})(a,o)).run():(console.warn('[tiptap warn]: Currently "setNode()" only supports text block nodes.'),!1)},y0=t=>({tr:e,dispatch:n})=>{if(n){const{doc:o}=e,r=vo(t,0,o.content.size),s=U.create(o,r);e.setSelection(s)}return!0},w0=t=>({tr:e,dispatch:n})=>{if(n){const{doc:o}=e,{from:r,to:s}=typeof t=="number"?{from:t,to:t}:t,i=Z.atStart(o).from,a=Z.atEnd(o).to,l=vo(r,i,a),c=vo(s,i,a),d=Z.create(o,l,c);e.setSelection(d)}return!0},v0=t=>({state:e,dispatch:n})=>{const o=$e(t,e.schema);return Jx(o)(e,n)};function Up(t,e){const n=t.storedMarks||t.selection.$to.parentOffset&&t.selection.$from.marks();if(n){const o=n.filter(r=>e?.includes(r.type.name));t.tr.ensureMarks(o)}}var S0=({keepMarks:t=!0}={})=>({tr:e,state:n,dispatch:o,editor:r})=>{const{selection:s,doc:i}=e,{$from:a,$to:l}=s,c=r.extensionManager.attributes,d=ti(c,a.node().type.name,a.node().attrs);if(s instanceof U&&s.node.isBlock)return!a.parentOffset||!kn(i,a.pos)?!1:(o&&(t&&Up(n,r.extensionManager.splittableMarks),e.split(a.pos).scrollIntoView()),!0);if(!a.parent.isBlock)return!1;const u=l.parentOffset===l.parent.content.size,f=a.depth===0?void 0:Qx(a.node(-1).contentMatchAt(a.indexAfter(-1)));let p=u&&f?[{type:f,attrs:d}]:void 0,m=kn(e.doc,e.mapping.map(a.pos),1,p);if(!p&&!m&&kn(e.doc,e.mapping.map(a.pos),1,f?[{type:f}]:void 0)&&(m=!0,p=f?[{type:f,attrs:d}]:void 0),o){if(m&&(s instanceof Z&&e.deleteSelection(),e.split(e.mapping.map(a.pos),1,p),f&&!u&&!a.parentOffset&&a.parent.type!==f)){const b=e.mapping.map(a.before()),y=e.doc.resolve(b);a.node(-1).canReplaceWith(y.index(),y.index()+1,f)&&e.setNodeMarkup(e.mapping.map(a.before()),f)}t&&Up(n,r.extensionManager.splittableMarks),e.scrollIntoView()}return m},k0=(t,e={})=>({tr:n,state:o,dispatch:r,editor:s})=>{var i;const a=$e(t,o.schema),{$from:l,$to:c}=o.selection,d=o.selection.node;if(d&&d.isBlock||l.depth<2||!l.sameParent(c))return!1;const u=l.node(-1);if(u.type!==a)return!1;const f=s.extensionManager.attributes;if(l.parent.content.size===0&&l.node(-1).childCount===l.indexAfter(-1)){if(l.depth===2||l.node(-3).type!==a||l.index(-2)!==l.node(-2).childCount-1)return!1;if(r){let w=M.empty;const v=l.index(-1)?1:l.index(-2)?2:3;for(let E=l.depth-v;E>=l.depth-3;E-=1)w=M.from(l.node(E).copy(w));const S=l.indexAfter(-1)<l.node(-2).childCount?1:l.indexAfter(-2)<l.node(-3).childCount?2:3,C={...ti(f,l.node().type.name,l.node().attrs),...e},x=((i=a.contentMatch.defaultType)==null?void 0:i.createAndFill(C))||void 0;w=w.append(M.from(a.createAndFill(null,x)||void 0));const I=l.before(l.depth-(v-1));n.replace(I,l.after(-S),new R(w,4-v,0));let N=-1;n.doc.nodesBetween(I,n.doc.content.size,(E,A)=>{if(N>-1)return!1;E.isTextblock&&E.content.size===0&&(N=A+1)}),N>-1&&n.setSelection(Z.near(n.doc.resolve(N))),n.scrollIntoView()}return!0}const p=c.pos===l.end()?u.contentMatchAt(0).defaultType:null,m={...ti(f,u.type.name,u.attrs),...e},b={...ti(f,l.node().type.name,l.node().attrs),...e};n.delete(l.pos,c.pos);const y=p?[{type:a,attrs:m},{type:p,attrs:b}]:[{type:a,attrs:m}];if(!kn(n.doc,l.pos,2))return!1;if(r){const{selection:w,storedMarks:v}=o,{splittableMarks:S}=s.extensionManager,C=v||w.$to.parentOffset&&w.$from.marks();if(n.split(l.pos,2,y).scrollIntoView(),!C||!r)return!0;const x=C.filter(I=>S.includes(I.type.name));n.ensureMarks(x)}return!0},hl=(t,e)=>{const n=Da(i=>i.type===e)(t.selection);if(!n)return!0;const o=t.doc.resolve(Math.max(0,n.pos-1)).before(n.depth);if(o===void 0)return!0;const r=t.doc.nodeAt(o);return n.node.type===r?.type&&lo(t.doc,n.pos)&&t.join(n.pos),!0},gl=(t,e)=>{const n=Da(i=>i.type===e)(t.selection);if(!n)return!0;const o=t.doc.resolve(n.start).after(n.depth);if(o===void 0)return!0;const r=t.doc.nodeAt(o);return n.node.type===r?.type&&lo(t.doc,o)&&t.join(o),!0},x0=(t,e,n,o={})=>({editor:r,tr:s,state:i,dispatch:a,chain:l,commands:c,can:d})=>{const{extensions:u,splittableMarks:f}=r.extensionManager,p=$e(t,i.schema),m=$e(e,i.schema),{selection:b,storedMarks:y}=i,{$from:w,$to:v}=b,S=w.blockRange(v),C=y||b.$to.parentOffset&&b.$from.marks();if(!S)return!1;const x=Da(I=>zp(I.type.name,u))(b);if(S.depth>=1&&x&&S.depth-x.depth<=1){if(x.node.type===p)return c.liftListItem(m);if(zp(x.node.type.name,u)&&p.validContent(x.node.content)&&a)return l().command(()=>(s.setNodeMarkup(x.pos,p),!0)).command(()=>hl(s,p)).command(()=>gl(s,p)).run()}return!n||!C||!a?l().command(()=>d().wrapInList(p,o)?!0:c.clearNodes()).wrapInList(p,o).command(()=>hl(s,p)).command(()=>gl(s,p)).run():l().command(()=>{const I=d().wrapInList(p,o),N=C.filter(E=>f.includes(E.type.name));return s.ensureMarks(N),I?!0:c.clearNodes()}).wrapInList(p,o).command(()=>hl(s,p)).command(()=>gl(s,p)).run()},C0=(t,e={},n={})=>({state:o,commands:r})=>{const{extendEmptyMarkRange:s=!1}=n,i=Mn(t,o.schema);return vc(o,i,e)?r.unsetMark(i,{extendEmptyMarkRange:s}):r.setMark(i,e)},E0=(t,e,n={})=>({state:o,commands:r})=>{const s=$e(t,o.schema),i=$e(e,o.schema),a=no(o,s,n);let l;return o.selection.$anchor.sameParent(o.selection.$head)&&(l=o.selection.$anchor.parent.attrs),a?r.setNode(i,l):r.setNode(s,{...l,...n})},I0=(t,e={})=>({state:n,commands:o})=>{const r=$e(t,n.schema);return no(n,r,e)?o.lift(r):o.wrapIn(r,e)},A0=()=>({state:t,dispatch:e})=>{const n=t.plugins;for(let o=0;o<n.length;o+=1){const r=n[o];let s;if(r.spec.isInputRules&&(s=r.getState(t))){if(e){const i=t.tr,a=s.transform;for(let l=a.steps.length-1;l>=0;l-=1)i.step(a.steps[l].invert(a.docs[l]));if(s.text){const l=i.doc.resolve(s.from).marks();i.replaceWith(s.from,s.to,t.schema.text(s.text,l))}else i.delete(s.from,s.to)}return!0}}return!1},N0=()=>({tr:t,dispatch:e})=>{const{selection:n}=t,{empty:o,ranges:r}=n;return o||e&&r.forEach(s=>{t.removeMark(s.$from.pos,s.$to.pos)}),!0},M0=(t,e={})=>({tr:n,state:o,dispatch:r})=>{var s;const{extendEmptyMarkRange:i=!1}=e,{selection:a}=n,l=Mn(t,o.schema),{$from:c,empty:d,ranges:u}=a;if(!r)return!0;if(d&&i){let{from:f,to:p}=a;const m=(s=c.marks().find(y=>y.type===l))==null?void 0:s.attrs,b=Fd(c,l,m);b&&(f=b.from,p=b.to),n.removeMark(f,p,l)}else u.forEach(f=>{n.removeMark(f.$from.pos,f.$to.pos,l)});return n.removeStoredMark(l),!0},T0=(t,e={})=>({tr:n,state:o,dispatch:r})=>{let s=null,i=null;const a=Ra(typeof t=="string"?t:t.name,o.schema);return a?(a==="node"&&(s=$e(t,o.schema)),a==="mark"&&(i=Mn(t,o.schema)),r&&n.selection.ranges.forEach(l=>{const c=l.$from.pos,d=l.$to.pos;let u,f,p,m;n.selection.empty?o.doc.nodesBetween(c,d,(b,y)=>{s&&s===b.type&&(p=Math.max(y,c),m=Math.min(y+b.nodeSize,d),u=y,f=b)}):o.doc.nodesBetween(c,d,(b,y)=>{y<c&&s&&s===b.type&&(p=Math.max(y,c),m=Math.min(y+b.nodeSize,d),u=y,f=b),y>=c&&y<=d&&(s&&s===b.type&&n.setNodeMarkup(y,void 0,{...b.attrs,...e}),i&&b.marks.length&&b.marks.forEach(w=>{if(i===w.type){const v=Math.max(y,c),S=Math.min(y+b.nodeSize,d);n.addMark(v,S,i.create({...w.attrs,...e}))}}))}),f&&(u!==void 0&&n.setNodeMarkup(u,void 0,{...f.attrs,...e}),i&&f.marks.length&&f.marks.forEach(b=>{i===b.type&&n.addMark(p,m,i.create({...b.attrs,...e}))}))}),!0):!1},P0=(t,e={})=>({state:n,dispatch:o})=>{const r=$e(t,n.schema);return zx(r,e)(n,o)},B0=(t,e={})=>({state:n,dispatch:o})=>{const r=$e(t,n.schema);return Hx(r,e)(n,o)},Og=ve.create({name:"commands",addCommands(){return{...Pg}}}),Lg=ve.create({name:"delete",onUpdate({transaction:t,appendedTransactions:e}){var n,o,r;const s=()=>{var i,a,l,c;if((c=(l=(a=(i=this.editor.options.coreExtensionOptions)==null?void 0:i.delete)==null?void 0:a.filterTransaction)==null?void 0:l.call(a,t))!=null?c:t.getMeta("y-sync$"))return;const d=fg(t.before,[t,...e]);kg(d).forEach(p=>{d.mapping.mapResult(p.oldRange.from).deletedAfter&&d.mapping.mapResult(p.oldRange.to).deletedBefore&&d.before.nodesBetween(p.oldRange.from,p.oldRange.to,(m,b)=>{const y=b+m.nodeSize-2,w=p.oldRange.from<=b&&y<=p.oldRange.to;this.editor.emit("delete",{type:"node",node:m,from:b,to:y,newFrom:d.mapping.map(b),newTo:d.mapping.map(y),deletedRange:p.oldRange,newRange:p.newRange,partial:!w,editor:this.editor,transaction:t,combinedTransform:d})})});const f=d.mapping;d.steps.forEach((p,m)=>{var b,y;if(p instanceof jt){const w=f.slice(m).map(p.from,-1),v=f.slice(m).map(p.to),S=f.invert().map(w,-1),C=f.invert().map(v),x=(b=d.doc.nodeAt(w-1))==null?void 0:b.marks.some(N=>N.eq(p.mark)),I=(y=d.doc.nodeAt(v))==null?void 0:y.marks.some(N=>N.eq(p.mark));this.editor.emit("delete",{type:"mark",mark:p.mark,from:p.from,to:p.to,deletedRange:{from:S,to:C},newRange:{from:w,to:v},partial:!!(I||x),editor:this.editor,transaction:t,combinedTransform:d})}})};(r=(o=(n=this.editor.options.coreExtensionOptions)==null?void 0:n.delete)==null?void 0:o.async)==null||r?setTimeout(s,0):s()}}),Dg=ve.create({name:"drop",addProseMirrorPlugins(){return[new Me({key:new Fe("tiptapDrop"),props:{handleDrop:(t,e,n,o)=>{this.editor.emit("drop",{editor:this.editor,event:e,slice:n,moved:o})}}})]}}),Rg=ve.create({name:"editable",addProseMirrorPlugins(){return[new Me({key:new Fe("editable"),props:{editable:()=>this.editor.options.editable}})]}}),jg=new Fe("focusEvents"),_g=ve.create({name:"focusEvents",addProseMirrorPlugins(){const{editor:t}=this;return[new Me({key:jg,props:{handleDOMEvents:{focus:(e,n)=>{t.isFocused=!0;const o=t.state.tr.setMeta("focus",{event:n}).setMeta("addToHistory",!1);return e.dispatch(o),!1},blur:(e,n)=>{t.isFocused=!1;const o=t.state.tr.setMeta("blur",{event:n}).setMeta("addToHistory",!1);return e.dispatch(o),!1}}}})]}}),$g=ve.create({name:"keymap",addKeyboardShortcuts(){const t=()=>this.editor.commands.first(({commands:i})=>[()=>i.undoInputRule(),()=>i.command(({tr:a})=>{const{selection:l,doc:c}=a,{empty:d,$anchor:u}=l,{pos:f,parent:p}=u,m=u.parent.isTextblock&&f>0?a.doc.resolve(f-1):u,b=m.parent.type.spec.isolating,y=u.pos-u.parentOffset,w=b&&m.parent.childCount===1?y===u.pos:ne.atStart(c).from===f;return!d||!p.type.isTextblock||p.textContent.length||!w||w&&u.parent.type.name==="paragraph"?!1:i.clearNodes()}),()=>i.deleteSelection(),()=>i.joinBackward(),()=>i.selectNodeBackward()]),e=()=>this.editor.commands.first(({commands:i})=>[()=>i.deleteSelection(),()=>i.deleteCurrentNode(),()=>i.joinForward(),()=>i.selectNodeForward()]),o={Enter:()=>this.editor.commands.first(({commands:i})=>[()=>i.newlineInCode(),()=>i.createParagraphNear(),()=>i.liftEmptyBlock(),()=>i.splitBlock()]),"Mod-Enter":()=>this.editor.commands.exitCode(),Backspace:t,"Mod-Backspace":t,"Shift-Backspace":t,Delete:e,"Mod-Delete":e,"Mod-a":()=>this.editor.commands.selectAll()},r={...o},s={...o,"Ctrl-h":t,"Alt-Backspace":t,"Ctrl-d":e,"Ctrl-Alt-Backspace":e,"Alt-Delete":e,"Alt-d":e,"Ctrl-a":()=>this.editor.commands.selectTextblockStart(),"Ctrl-e":()=>this.editor.commands.selectTextblockEnd()};return Hd()||Bg()?s:r},addProseMirrorPlugins(){return[new Me({key:new Fe("clearDocument"),appendTransaction:(t,e,n)=>{if(t.some(b=>b.getMeta("composition")))return;const o=t.some(b=>b.docChanged)&&!e.doc.eq(n.doc),r=t.some(b=>b.getMeta("preventClearDocument"));if(!o||r)return;const{empty:s,from:i,to:a}=e.selection,l=ne.atStart(e.doc).from,c=ne.atEnd(e.doc).to;if(s||!(i===l&&a===c)||!ja(n.doc))return;const f=n.tr,p=Oa({state:n,transaction:f}),{commands:m}=new La({editor:this.editor,state:p});if(m.clearNodes(),!!f.steps.length)return f}})]}}),Fg=ve.create({name:"paste",addProseMirrorPlugins(){return[new Me({key:new Fe("tiptapPaste"),props:{handlePaste:(t,e,n)=>{this.editor.emit("paste",{editor:this.editor,event:e,slice:n})}}})]}}),Wg=ve.create({name:"tabindex",addProseMirrorPlugins(){return[new Me({key:new Fe("tabindex"),props:{attributes:()=>this.editor.isEditable?{tabindex:"0"}:{}}})]}}),O0=class Zo{constructor(e,n,o=!1,r=null){this.currentNode=null,this.actualDepth=null,this.isBlock=o,this.resolvedPos=e,this.editor=n,this.currentNode=r}get name(){return this.node.type.name}get node(){return this.currentNode||this.resolvedPos.node()}get element(){return this.editor.view.domAtPos(this.pos).node}get depth(){var e;return(e=this.actualDepth)!=null?e:this.resolvedPos.depth}get pos(){return this.resolvedPos.pos}get content(){return this.node.content}set content(e){let n=this.from,o=this.to;if(this.isBlock){if(this.content.size===0){console.error(`You canâ€™t set content on a block node. Tried to set content on ${this.name} at ${this.pos}`);return}n=this.from+1,o=this.to-1}this.editor.commands.insertContentAt({from:n,to:o},e)}get attributes(){return this.node.attrs}get textContent(){return this.node.textContent}get size(){return this.node.nodeSize}get from(){return this.isBlock?this.pos:this.resolvedPos.start(this.resolvedPos.depth)}get range(){return{from:this.from,to:this.to}}get to(){return this.isBlock?this.pos+this.size:this.resolvedPos.end(this.resolvedPos.depth)+(this.node.isText?0:1)}get parent(){if(this.depth===0)return null;const e=this.resolvedPos.start(this.resolvedPos.depth-1),n=this.resolvedPos.doc.resolve(e);return new Zo(n,this.editor)}get before(){let e=this.resolvedPos.doc.resolve(this.from-(this.isBlock?1:2));return e.depth!==this.depth&&(e=this.resolvedPos.doc.resolve(this.from-3)),new Zo(e,this.editor)}get after(){let e=this.resolvedPos.doc.resolve(this.to+(this.isBlock?2:1));return e.depth!==this.depth&&(e=this.resolvedPos.doc.resolve(this.to+3)),new Zo(e,this.editor)}get children(){const e=[];return this.node.content.forEach((n,o)=>{const r=n.isBlock&&!n.isTextblock,s=n.isAtom&&!n.isText,i=this.pos+o+(s?0:1);if(i<0||i>this.resolvedPos.doc.nodeSize-2)return;const a=this.resolvedPos.doc.resolve(i);if(!r&&a.depth<=this.depth)return;const l=new Zo(a,this.editor,r,r?n:null);r&&(l.actualDepth=this.depth+1),e.push(new Zo(a,this.editor,r,r?n:null))}),e}get firstChild(){return this.children[0]||null}get lastChild(){const e=this.children;return e[e.length-1]||null}closest(e,n={}){let o=null,r=this.parent;for(;r&&!o;){if(r.node.type.name===e)if(Object.keys(n).length>0){const s=r.node.attrs,i=Object.keys(n);for(let a=0;a<i.length;a+=1){const l=i[a];if(s[l]!==n[l])break}}else o=r;r=r.parent}return o}querySelector(e,n={}){return this.querySelectorAll(e,n,!0)[0]||null}querySelectorAll(e,n={},o=!1){let r=[];if(!this.children||this.children.length===0)return r;const s=Object.keys(n);return this.children.forEach(i=>{o&&r.length>0||(i.node.type.name===e&&s.every(l=>n[l]===i.node.attrs[l])&&r.push(i),!(o&&r.length>0)&&(r=r.concat(i.querySelectorAll(e,n,o))))}),r}setAttribute(e){const{tr:n}=this.editor.state;n.setNodeMarkup(this.from,void 0,{...this.node.attrs,...e}),this.editor.view.dispatch(n)}},L0=`.ProseMirror {
  position: relative;
}

.ProseMirror {
  word-wrap: break-word;
  white-space: pre-wrap;
  white-space: break-spaces;
  -webkit-font-variant-ligatures: none;
  font-variant-ligatures: none;
  font-feature-settings: "liga" 0; /* the above doesn't seem to work in Edge */
}

.ProseMirror [contenteditable="false"] {
  white-space: normal;
}

.ProseMirror [contenteditable="false"] [contenteditable="true"] {
  white-space: pre-wrap;
}

.ProseMirror pre {
  white-space: pre-wrap;
}

img.ProseMirror-separator {
  display: inline !important;
  border: none !important;
  margin: 0 !important;
  width: 0 !important;
  height: 0 !important;
}

.ProseMirror-gapcursor {
  display: none;
  pointer-events: none;
  position: absolute;
  margin: 0;
}

.ProseMirror-gapcursor:after {
  content: "";
  display: block;
  position: absolute;
  top: -2px;
  width: 20px;
  border-top: 1px solid black;
  animation: ProseMirror-cursor-blink 1.1s steps(2, start) infinite;
}

@keyframes ProseMirror-cursor-blink {
  to {
    visibility: hidden;
  }
}

.ProseMirror-hideselection *::selection {
  background: transparent;
}

.ProseMirror-hideselection *::-moz-selection {
  background: transparent;
}

.ProseMirror-hideselection * {
  caret-color: transparent;
}

.ProseMirror-focused .ProseMirror-gapcursor {
  display: block;
}`;function D0(t,e,n){const o=document.querySelector("style[data-tiptap-style]");if(o!==null)return o;const r=document.createElement("style");return e&&r.setAttribute("nonce",e),r.setAttribute("data-tiptap-style",""),r.innerHTML=t,document.getElementsByTagName("head")[0].appendChild(r),r}var R0=class extends Xx{constructor(t={}){super(),this.css=null,this.editorView=null,this.isFocused=!1,this.isInitialized=!1,this.extensionStorage={},this.instanceId=Math.random().toString(36).slice(2,9),this.options={element:typeof document<"u"?document.createElement("div"):null,content:"",injectCSS:!0,injectNonce:void 0,extensions:[],autofocus:!1,editable:!0,editorProps:{},parseOptions:{},coreExtensionOptions:{},enableInputRules:!0,enablePasteRules:!0,enableCoreExtensions:!0,enableContentCheck:!1,emitContentError:!1,onBeforeCreate:()=>null,onCreate:()=>null,onUpdate:()=>null,onSelectionUpdate:()=>null,onTransaction:()=>null,onFocus:()=>null,onBlur:()=>null,onDestroy:()=>null,onContentError:({error:o})=>{throw o},onPaste:()=>null,onDrop:()=>null,onDelete:()=>null},this.isCapturingTransaction=!1,this.capturedTransaction=null,this.setOptions(t),this.createExtensionManager(),this.createCommandManager(),this.createSchema(),this.on("beforeCreate",this.options.onBeforeCreate),this.emit("beforeCreate",{editor:this}),this.on("contentError",this.options.onContentError),this.on("create",this.options.onCreate),this.on("update",this.options.onUpdate),this.on("selectionUpdate",this.options.onSelectionUpdate),this.on("transaction",this.options.onTransaction),this.on("focus",this.options.onFocus),this.on("blur",this.options.onBlur),this.on("destroy",this.options.onDestroy),this.on("drop",({event:o,slice:r,moved:s})=>this.options.onDrop(o,r,s)),this.on("paste",({event:o,slice:r})=>this.options.onPaste(o,r)),this.on("delete",this.options.onDelete);const e=this.createDoc(),n=Ig(e,this.options.autofocus);this.editorState=or.create({doc:e,schema:this.schema,selection:n||void 0}),this.options.element&&this.mount(this.options.element)}mount(t){if(typeof document>"u")throw new Error("[tiptap error]: The editor cannot be mounted because there is no 'document' defined in this environment.");this.createView(t),window.setTimeout(()=>{this.isDestroyed||(this.commands.focus(this.options.autofocus),this.emit("create",{editor:this}),this.isInitialized=!0)},0)}unmount(){if(this.editorView){const t=this.editorView.dom;t?.editor&&delete t.editor,this.editorView.destroy()}if(this.editorView=null,this.isInitialized=!1,this.css)try{typeof this.css.remove=="function"?this.css.remove():this.css.parentNode&&this.css.parentNode.removeChild(this.css)}catch(t){console.warn("Failed to remove CSS element:",t)}this.css=null}get storage(){return this.extensionStorage}get commands(){return this.commandManager.commands}chain(){return this.commandManager.chain()}can(){return this.commandManager.can()}injectCSS(){this.options.injectCSS&&typeof document<"u"&&(this.css=D0(L0,this.options.injectNonce))}setOptions(t={}){this.options={...this.options,...t},!(!this.editorView||!this.state||this.isDestroyed)&&(this.options.editorProps&&this.view.setProps(this.options.editorProps),this.view.updateState(this.state))}setEditable(t,e=!0){this.setOptions({editable:t}),e&&this.emit("update",{editor:this,transaction:this.state.tr,appendedTransactions:[]})}get isEditable(){return this.options.editable&&this.view&&this.view.editable}get view(){return this.editorView?this.editorView:new Proxy({state:this.editorState,updateState:t=>{this.editorState=t},dispatch:t=>{this.editorState=this.state.apply(t)},composing:!1,dragging:null,editable:!0,isDestroyed:!1},{get:(t,e)=>{if(e==="state")return this.editorState;if(e in t)return Reflect.get(t,e);throw new Error(`[tiptap error]: The editor view is not available. Cannot access view['${e}']. The editor may not be mounted yet.`)}})}get state(){return this.editorView&&(this.editorState=this.view.state),this.editorState}registerPlugin(t,e){const n=hg(e)?e(t,[...this.state.plugins]):[...this.state.plugins,t],o=this.state.reconfigure({plugins:n});return this.view.updateState(o),o}unregisterPlugin(t){if(this.isDestroyed)return;const e=this.state.plugins;let n=e;if([].concat(t).forEach(r=>{const s=typeof r=="string"?`${r}$`:r.key;n=n.filter(i=>!i.key.startsWith(s))}),e.length===n.length)return;const o=this.state.reconfigure({plugins:n});return this.view.updateState(o),o}createExtensionManager(){var t,e;const o=[...this.options.enableCoreExtensions?[Rg,Tg.configure({blockSeparator:(e=(t=this.options.coreExtensionOptions)==null?void 0:t.clipboardTextSerializer)==null?void 0:e.blockSeparator}),Og,_g,$g,Wg,Dg,Fg,Lg].filter(r=>typeof this.options.enableCoreExtensions=="object"?this.options.enableCoreExtensions[r.name]!==!1:!0):[],...this.options.extensions].filter(r=>["extension","node","mark"].includes(r?.type));this.extensionManager=new $a(o,this)}createCommandManager(){this.commandManager=new La({editor:this})}createSchema(){this.schema=this.extensionManager.schema}createDoc(){let t;try{t=wc(this.options.content,this.schema,this.options.parseOptions,{errorOnInvalidContent:this.options.enableContentCheck})}catch(e){if(!(e instanceof Error)||!["[tiptap error]: Invalid JSON content","[tiptap error]: Invalid HTML content"].includes(e.message))throw e;this.emit("contentError",{editor:this,error:e,disableCollaboration:()=>{"collaboration"in this.storage&&typeof this.storage.collaboration=="object"&&this.storage.collaboration&&(this.storage.collaboration.isDisabled=!0),this.options.extensions=this.options.extensions.filter(n=>n.name!=="collaboration"),this.createExtensionManager()}}),t=wc(this.options.content,this.schema,this.options.parseOptions,{errorOnInvalidContent:!1})}return t}createView(t){var e;this.editorView=new Qh(t,{...this.options.editorProps,attributes:{role:"textbox",...(e=this.options.editorProps)==null?void 0:e.attributes},dispatchTransaction:this.dispatchTransaction.bind(this),state:this.editorState});const n=this.state.reconfigure({plugins:this.extensionManager.plugins});this.view.updateState(n),this.createNodeViews(),this.prependClass(),this.injectCSS();const o=this.view.dom;o.editor=this}createNodeViews(){this.view.isDestroyed||this.view.setProps({markViews:this.extensionManager.markViews,nodeViews:this.extensionManager.nodeViews})}prependClass(){this.view.dom.className=`tiptap ${this.view.dom.className}`}captureTransaction(t){this.isCapturingTransaction=!0,t(),this.isCapturingTransaction=!1;const e=this.capturedTransaction;return this.capturedTransaction=null,e}dispatchTransaction(t){if(this.view.isDestroyed)return;if(this.isCapturingTransaction){if(!this.capturedTransaction){this.capturedTransaction=t;return}t.steps.forEach(c=>{var d;return(d=this.capturedTransaction)==null?void 0:d.step(c)});return}const{state:e,transactions:n}=this.state.applyTransaction(t),o=!this.state.selection.eq(e.selection),r=n.includes(t),s=this.state;if(this.emit("beforeTransaction",{editor:this,transaction:t,nextState:e}),!r)return;this.view.updateState(e),this.emit("transaction",{editor:this,transaction:t,appendedTransactions:n.slice(1)}),o&&this.emit("selectionUpdate",{editor:this,transaction:t});const i=n.findLast(c=>c.getMeta("focus")||c.getMeta("blur")),a=i?.getMeta("focus"),l=i?.getMeta("blur");a&&this.emit("focus",{editor:this,event:a.event,transaction:i}),l&&this.emit("blur",{editor:this,event:l.event,transaction:i}),!(t.getMeta("preventUpdate")||!n.some(c=>c.docChanged)||s.doc.eq(e.doc))&&this.emit("update",{editor:this,transaction:t,appendedTransactions:n.slice(1)})}getAttributes(t){return Sg(this.state,t)}isActive(t,e){const n=typeof t=="string"?t:null,o=typeof t=="string"?e:t;return uC(this.state,n,o)}getJSON(){return this.state.doc.toJSON()}getHTML(){return jd(this.state.doc.content,this.schema)}getText(t){const{blockSeparator:e=`

`,textSerializers:n={}}=t||{};return sC(this.state.doc,{blockSeparator:e,textSerializers:{...wg(this.schema),...n}})}get isEmpty(){return ja(this.state.doc)}destroy(){this.emit("destroy"),this.unmount(),this.removeAllListeners()}get isDestroyed(){var t,e;return(e=(t=this.editorView)==null?void 0:t.isDestroyed)!=null?e:!0}$node(t,e){var n;return((n=this.$doc)==null?void 0:n.querySelector(t,e))||null}$nodes(t,e){var n;return((n=this.$doc)==null?void 0:n.querySelectorAll(t,e))||null}$pos(t){const e=this.state.doc.resolve(t);return new O0(e,this)}get $doc(){return this.$pos(0)}};function Do(t){return new _a({find:t.find,handler:({state:e,range:n,match:o})=>{const r=ye(t.getAttributes,void 0,o);if(r===!1||r===null)return null;const{tr:s}=e,i=o[o.length-1],a=o[0];if(i){const l=a.search(/\S/),c=n.from+a.indexOf(i),d=c+i.length;if(Wd(n.from,n.to,e.doc).filter(p=>p.mark.type.excluded.find(b=>b===t.type&&b!==p.mark.type)).filter(p=>p.to>c).length)return null;d<n.to&&s.delete(d,n.to),c>n.from&&s.delete(n.from+l,c);const f=n.from+l+i.length;s.addMark(n.from+l,f,t.type.create(r||{})),s.removeStoredMark(t.type)}}})}function j0(t){return new _a({find:t.find,handler:({state:e,range:n,match:o})=>{const r=ye(t.getAttributes,void 0,o)||{},{tr:s}=e,i=n.from;let a=n.to;const l=t.type.create(r);if(o[1]){const c=o[0].lastIndexOf(o[1]);let d=i+c;d>a?d=a:a=d+o[1].length;const u=o[0][o[0].length-1];s.insertText(u,i+o[0].length-1),s.replaceWith(d,a,l)}else if(o[0]){const c=t.type.isInline?i:i-1;s.insert(c,t.type.create(r)).delete(s.mapping.map(i),s.mapping.map(a))}s.scrollIntoView()}})}function Sc(t){return new _a({find:t.find,handler:({state:e,range:n,match:o})=>{const r=e.doc.resolve(n.from),s=ye(t.getAttributes,void 0,o)||{};if(!r.node(-1).canReplaceWith(r.index(-1),r.indexAfter(-1),t.type))return null;e.tr.delete(n.from,n.to).setBlockType(n.from,n.from,t.type,s)}})}function mr(t){return new _a({find:t.find,handler:({state:e,range:n,match:o,chain:r})=>{const s=ye(t.getAttributes,void 0,o)||{},i=e.tr.delete(n.from,n.to),l=i.doc.resolve(n.from).blockRange(),c=l&&vd(l,t.type,s);if(!c)return null;if(i.wrap(l,c),t.keepMarks&&t.editor){const{selection:u,storedMarks:f}=e,{splittableMarks:p}=t.editor.extensionManager,m=f||u.$to.parentOffset&&u.$from.marks();if(m){const b=m.filter(y=>p.includes(y.type.name));i.ensureMarks(b)}}if(t.keepAttributes){const u=t.type.name==="bulletList"||t.type.name==="orderedList"?"listItem":"taskList";r().updateAttributes(u,s).run()}const d=i.doc.resolve(n.from-1).nodeBefore;d&&d.type===t.type&&lo(i.doc,n.from-1)&&(!t.joinPredicate||t.joinPredicate(o,d))&&i.join(n.from-1)}})}function _0(t,e){const{selection:n}=t,{$from:o}=n;if(n instanceof U){const s=o.index();return o.parent.canReplaceWith(s,s+1,e)}let r=o.depth;for(;r>=0;){const s=o.index(r);if(o.node(r).contentMatchAt(s).matchType(e))return!0;r-=1}return!1}function $0(t,e,n={}){const{state:o}=e,{doc:r,tr:s}=o,i=t;r.descendants((a,l)=>{const c=s.mapping.map(l),d=s.mapping.map(l)+a.nodeSize;let u=null;if(a.marks.forEach(p=>{if(p!==i)return!1;u=p}),!u)return;let f=!1;if(Object.keys(n).forEach(p=>{n[p]!==u.attrs[p]&&(f=!0)}),f){const p=t.type.create({...t.attrs,...n});s.removeMark(c,d,t.type),s.addMark(c,d,p)}}),s.docChanged&&e.view.dispatch(s)}var lt=class zg extends zd{constructor(){super(...arguments),this.type="node"}static create(e={}){const n=typeof e=="function"?e():e;return new zg(n)}configure(e){return super.configure(e)}extend(e){const n=typeof e=="function"?e():e;return super.extend(n)}};function oo(t){return new wC({find:t.find,handler:({state:e,range:n,match:o,pasteEvent:r})=>{const s=ye(t.getAttributes,void 0,o,r);if(s===!1||s===null)return null;const{tr:i}=e,a=o[o.length-1],l=o[0];let c=n.to;if(a){const d=l.search(/\S/),u=n.from+l.indexOf(a),f=u+a.length;if(Wd(n.from,n.to,e.doc).filter(m=>m.mark.type.excluded.find(y=>y===t.type&&y!==m.mark.type)).filter(m=>m.to>u).length)return null;f<n.to&&i.delete(f,n.to),u>n.from&&i.delete(n.from+d,u),c=n.from+d+a.length,i.addMark(n.from+d,c,t.type.create(s||{})),i.removeStoredMark(t.type)}}})}var bl,Vp;function F0(){return Vp||(Vp=1,bl=function t(e,n){if(e===n)return!0;if(e&&n&&typeof e=="object"&&typeof n=="object"){if(e.constructor!==n.constructor)return!1;var o,r,s;if(Array.isArray(e)){if(o=e.length,o!=n.length)return!1;for(r=o;r--!==0;)if(!t(e[r],n[r]))return!1;return!0}if(e instanceof Map&&n instanceof Map){if(e.size!==n.size)return!1;for(r of e.entries())if(!n.has(r[0]))return!1;for(r of e.entries())if(!t(r[1],n.get(r[0])))return!1;return!0}if(e instanceof Set&&n instanceof Set){if(e.size!==n.size)return!1;for(r of e.entries())if(!n.has(r[0]))return!1;return!0}if(ArrayBuffer.isView(e)&&ArrayBuffer.isView(n)){if(o=e.length,o!=n.length)return!1;for(r=o;r--!==0;)if(e[r]!==n[r])return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if(s=Object.keys(e),o=s.length,o!==Object.keys(n).length)return!1;for(r=o;r--!==0;)if(!Object.prototype.hasOwnProperty.call(n,s[r]))return!1;for(r=o;r--!==0;){var i=s[r];if(!(i==="_owner"&&e.$$typeof)&&!t(e[i],n[i]))return!1}return!0}return e!==e&&n!==n}),bl}var W0=F0();const z0=am(W0);var yl={exports:{}},wl={};/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var qp;function H0(){if(qp)return wl;qp=1;var t=lm(),e=jm();function n(c,d){return c===d&&(c!==0||1/c===1/d)||c!==c&&d!==d}var o=typeof Object.is=="function"?Object.is:n,r=e.useSyncExternalStore,s=t.useRef,i=t.useEffect,a=t.useMemo,l=t.useDebugValue;return wl.useSyncExternalStoreWithSelector=function(c,d,u,f,p){var m=s(null);if(m.current===null){var b={hasValue:!1,value:null};m.current=b}else b=m.current;m=a(function(){function w(I){if(!v){if(v=!0,S=I,I=f(I),p!==void 0&&b.hasValue){var N=b.value;if(p(N,I))return C=N}return C=I}if(N=C,o(S,I))return N;var E=f(I);return p!==void 0&&p(N,E)?(S=I,N):(S=I,C=E)}var v=!1,S,C,x=u===void 0?null:u;return[function(){return w(d())},x===null?void 0:function(){return w(x())}]},[d,u,f,p]);var y=r(c,m[0],m[1]);return i(function(){b.hasValue=!0,b.value=y},[y]),l(y),y},wl}var Kp;function U0(){return Kp||(Kp=1,yl.exports=H0()),yl.exports}var V0=U0(),q0=(...t)=>e=>{t.forEach(n=>{typeof n=="function"?n(e):n&&(n.current=e)})},K0=({contentComponent:t})=>{const e=_m.useSyncExternalStore(t.subscribe,t.getSnapshot,t.getServerSnapshot);return g.jsx(g.Fragment,{children:Object.values(e)})};function G0(){const t=new Set;let e={};return{subscribe(n){return t.add(n),()=>{t.delete(n)}},getSnapshot(){return e},getServerSnapshot(){return e},setRenderer(n,o){e={...e,[n]:Rm.createPortal(o.reactElement,o.element,n)},t.forEach(r=>r())},removeRenderer(n){const o={...e};delete o[n],e=o,t.forEach(r=>r())}}}var J0=class extends ot.Component{constructor(t){var e;super(t),this.editorContentRef=ot.createRef(),this.initialized=!1,this.state={hasContentComponentInitialized:!!((e=t.editor)!=null&&e.contentComponent)}}componentDidMount(){this.init()}componentDidUpdate(){this.init()}init(){const t=this.props.editor;if(t&&!t.isDestroyed&&t.options.element){if(t.contentComponent)return;const e=this.editorContentRef.current;e.append(...t.options.element.childNodes),t.setOptions({element:e}),t.contentComponent=G0(),this.state.hasContentComponentInitialized||(this.unsubscribeToContentComponent=t.contentComponent.subscribe(()=>{this.setState(n=>n.hasContentComponentInitialized?n:{hasContentComponentInitialized:!0}),this.unsubscribeToContentComponent&&this.unsubscribeToContentComponent()})),t.createNodeViews(),this.initialized=!0}}componentWillUnmount(){var t;const e=this.props.editor;if(!e||(this.initialized=!1,e.isDestroyed||e.view.setProps({nodeViews:{}}),this.unsubscribeToContentComponent&&this.unsubscribeToContentComponent(),e.contentComponent=null,!((t=e.options.element)!=null&&t.firstChild)))return;const n=document.createElement("div");n.append(...e.options.element.childNodes),e.setOptions({element:n})}render(){const{editor:t,innerRef:e,...n}=this.props;return g.jsxs(g.Fragment,{children:[g.jsx("div",{ref:q0(e,this.editorContentRef),...n}),t?.contentComponent&&g.jsx(K0,{contentComponent:t.contentComponent})]})}},Y0=T.forwardRef((t,e)=>{const n=ot.useMemo(()=>Math.floor(Math.random()*4294967295).toString(),[t.editor]);return ot.createElement(J0,{key:n,innerRef:e,...t})}),X0=ot.memo(Y0),Q0=typeof window<"u"?T.useLayoutEffect:T.useEffect,Z0=class{constructor(t){this.transactionNumber=0,this.lastTransactionNumber=0,this.subscribers=new Set,this.editor=t,this.lastSnapshot={editor:t,transactionNumber:0},this.getSnapshot=this.getSnapshot.bind(this),this.getServerSnapshot=this.getServerSnapshot.bind(this),this.watch=this.watch.bind(this),this.subscribe=this.subscribe.bind(this)}getSnapshot(){return this.transactionNumber===this.lastTransactionNumber?this.lastSnapshot:(this.lastTransactionNumber=this.transactionNumber,this.lastSnapshot={editor:this.editor,transactionNumber:this.transactionNumber},this.lastSnapshot)}getServerSnapshot(){return{editor:null,transactionNumber:0}}subscribe(t){return this.subscribers.add(t),()=>{this.subscribers.delete(t)}}watch(t){if(this.editor=t,this.editor){const e=()=>{this.transactionNumber+=1,this.subscribers.forEach(o=>o())},n=this.editor;return n.on("transaction",e),()=>{n.off("transaction",e)}}}};function eE(t){var e;const[n]=T.useState(()=>new Z0(t.editor)),o=V0.useSyncExternalStoreWithSelector(n.subscribe,n.getSnapshot,n.getServerSnapshot,t.selector,(e=t.equalityFn)!=null?e:z0);return Q0(()=>n.watch(t.editor),[t.editor,n]),T.useDebugValue(o),o}var tE=!1,kc=typeof window>"u",nE=kc||!!(typeof window<"u"&&window.next),oE=class Hg{constructor(e){this.editor=null,this.subscriptions=new Set,this.isComponentMounted=!1,this.previousDeps=null,this.instanceId="",this.options=e,this.subscriptions=new Set,this.setEditor(this.getInitialEditor()),this.scheduleDestroy(),this.getEditor=this.getEditor.bind(this),this.getServerSnapshot=this.getServerSnapshot.bind(this),this.subscribe=this.subscribe.bind(this),this.refreshEditorInstance=this.refreshEditorInstance.bind(this),this.scheduleDestroy=this.scheduleDestroy.bind(this),this.onRender=this.onRender.bind(this),this.createEditor=this.createEditor.bind(this)}setEditor(e){this.editor=e,this.instanceId=Math.random().toString(36).slice(2,9),this.subscriptions.forEach(n=>n())}getInitialEditor(){return this.options.current.immediatelyRender===void 0?kc||nE?null:this.createEditor():(this.options.current.immediatelyRender,this.options.current.immediatelyRender?this.createEditor():null)}createEditor(){const e={...this.options.current,onBeforeCreate:(...o)=>{var r,s;return(s=(r=this.options.current).onBeforeCreate)==null?void 0:s.call(r,...o)},onBlur:(...o)=>{var r,s;return(s=(r=this.options.current).onBlur)==null?void 0:s.call(r,...o)},onCreate:(...o)=>{var r,s;return(s=(r=this.options.current).onCreate)==null?void 0:s.call(r,...o)},onDestroy:(...o)=>{var r,s;return(s=(r=this.options.current).onDestroy)==null?void 0:s.call(r,...o)},onFocus:(...o)=>{var r,s;return(s=(r=this.options.current).onFocus)==null?void 0:s.call(r,...o)},onSelectionUpdate:(...o)=>{var r,s;return(s=(r=this.options.current).onSelectionUpdate)==null?void 0:s.call(r,...o)},onTransaction:(...o)=>{var r,s;return(s=(r=this.options.current).onTransaction)==null?void 0:s.call(r,...o)},onUpdate:(...o)=>{var r,s;return(s=(r=this.options.current).onUpdate)==null?void 0:s.call(r,...o)},onContentError:(...o)=>{var r,s;return(s=(r=this.options.current).onContentError)==null?void 0:s.call(r,...o)},onDrop:(...o)=>{var r,s;return(s=(r=this.options.current).onDrop)==null?void 0:s.call(r,...o)},onPaste:(...o)=>{var r,s;return(s=(r=this.options.current).onPaste)==null?void 0:s.call(r,...o)},onDelete:(...o)=>{var r,s;return(s=(r=this.options.current).onDelete)==null?void 0:s.call(r,...o)}};return new R0(e)}getEditor(){return this.editor}getServerSnapshot(){return null}subscribe(e){return this.subscriptions.add(e),()=>{this.subscriptions.delete(e)}}static compareOptions(e,n){return Object.keys(e).every(o=>["onCreate","onBeforeCreate","onDestroy","onUpdate","onTransaction","onFocus","onBlur","onSelectionUpdate","onContentError","onDrop","onPaste"].includes(o)?!0:o==="extensions"&&e.extensions&&n.extensions?e.extensions.length!==n.extensions.length?!1:e.extensions.every((r,s)=>{var i;return r===((i=n.extensions)==null?void 0:i[s])}):e[o]===n[o])}onRender(e){return()=>(this.isComponentMounted=!0,clearTimeout(this.scheduledDestructionTimeout),this.editor&&!this.editor.isDestroyed&&e.length===0?Hg.compareOptions(this.options.current,this.editor.options)||this.editor.setOptions({...this.options.current,editable:this.editor.isEditable}):this.refreshEditorInstance(e),()=>{this.isComponentMounted=!1,this.scheduleDestroy()})}refreshEditorInstance(e){if(this.editor&&!this.editor.isDestroyed){if(this.previousDeps===null){this.previousDeps=e;return}if(this.previousDeps.length===e.length&&this.previousDeps.every((o,r)=>o===e[r]))return}this.editor&&!this.editor.isDestroyed&&this.editor.destroy(),this.setEditor(this.createEditor()),this.previousDeps=e}scheduleDestroy(){const e=this.instanceId,n=this.editor;this.scheduledDestructionTimeout=setTimeout(()=>{if(this.isComponentMounted&&this.instanceId===e){n&&n.setOptions(this.options.current);return}n&&!n.isDestroyed&&(n.destroy(),this.instanceId===e&&this.setEditor(null))},1)}};function rE(t={},e=[]){const n=T.useRef(t);n.current=t;const[o]=T.useState(()=>new oE(n)),r=_m.useSyncExternalStore(o.subscribe,o.getEditor,o.getServerSnapshot);return T.useDebugValue(r),T.useEffect(o.onRender(e)),eE({editor:r,selector:({transactionNumber:s})=>t.shouldRerenderOnTransaction===!1||t.shouldRerenderOnTransaction===void 0?null:t.immediatelyRender&&s===0?0:s+1}),r}var sE=T.createContext({editor:null});sE.Consumer;var iE=T.createContext({onDragStart:()=>{},nodeViewContentChildren:void 0,nodeViewContentRef:()=>{}}),aE=()=>T.useContext(iE);ot.forwardRef((t,e)=>{const{onDragStart:n}=aE(),o=t.as||"div";return g.jsx(o,{...t,ref:e,"data-node-view-wrapper":"",onDragStart:n,style:{whiteSpace:"normal",...t.style}})});ot.createContext({markViewContentRef:()=>{}});let Gp=!1,hn=null,dt=null,Gt=null,Pr=null,xc=!1;const lE="chronological",Ug="updated",cE="created",dE="all",ni="relevant",uE=[{value:cd,label:"Manual (Drag Order)"},{value:gm,label:"Modified Date (Newest)"},{value:hm,label:"Modified Date (Oldest)"},{value:mm,label:"Created Date (Newest)"},{value:fm,label:"Created Date (Oldest)"},{value:pm,label:"Name (A-Z)"},{value:um,label:"Name (Z-A)"}];function Jp(t=""){return typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(t):String(t).replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function Pi(t,e=Ug){return Number(e===cE?t?.createdAt||0:t?.updatedAt||0)}function vl(t=[],e=Ug){return[...t].sort((n,o)=>{const r=Pi(o,e)-Pi(n,e);return r!==0?r:String(n?.name||"").localeCompare(String(o?.name||""),void 0,{sensitivity:"base"})})}function Yp(t=[],e,n=dE){if(n!==ni||!e?.activeSessionId)return t;const o=(e.chatSessions||[]).find(s=>s.id===e.activeSessionId);if(!o||Yy(o))return t;const r=o.folderId||null;return t.filter(s=>s.id===o.id||(s.folderId||null)===r)}function pE(t){const e=document.getElementById("session-organize-menu");if(!e||!t)return;const n=Ud(t);e.querySelectorAll(".session-organize-option").forEach(o=>{let r=!1;o.dataset.organizeBy?r=n.organizeBy===o.dataset.organizeBy:o.dataset.sortBy?r=n.sortBy===o.dataset.sortBy:o.dataset.showMode&&(r=n.showMode===o.dataset.showMode),o.classList.toggle("is-selected",r),o.setAttribute("aria-checked",r?"true":"false")})}function fE(){const t=document.querySelector(".sessions-panel");if(t){if(window.innerWidth<=1024){t.classList.add("is-open"),document.getElementById("mobile-overlay")?.classList.add("active");return}document.querySelector(".app-wrapper")?.classList.remove("sidebar-collapsed")}}function mE(t){t&&(t.classList.remove("session-locate-highlight"),t.offsetWidth,t.classList.add("session-locate-highlight"),window.setTimeout(()=>{t.classList.remove("session-locate-highlight")},1300))}function _s(){const t=h.getProject(),e=t?.activeSessionId;if(!t||!e)return;fE();let n=document.querySelector(`.session-item[data-session-id="${Jp(e)}"]`);if(n||(Ro(),n=document.querySelector(`.session-item[data-session-id="${Jp(e)}"]`)),!n)return;const o=n.closest(".session-folder[data-folder-id]");o&&!o.open&&(o.open=!0),requestAnimationFrame(()=>{n.scrollIntoView({behavior:"smooth",block:"center"}),mE(n)})}function Bi(){document.querySelectorAll(".session-folder > .folder-session-list").forEach(t=>{if(!(t instanceof HTMLElement))return;const e=t.closest(".session-folder"),n=!!e?.open;!n&&e&&(xc=!0,e.open=!0),t.style.maxHeight="none";const o=Math.max(0,Math.ceil(t.scrollHeight));t.style.maxHeight="",t.style.setProperty("--folder-content-height",`${o}px`),!n&&e&&(e.open=!1,xc=!1)})}function hE(t,e){const n=t?.querySelector(":scope > .folder-session-list"),o=()=>{const d=t?.dataset?.folderId;d&&h.bus.publish("folder:collapse",{folderId:d,collapsed:!e})};if(!t||!n){t&&(t.open=!!e,o());return}if(t.dataset.folderAnimating==="1")return;if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){t.open=!!e,o(),Bi();return}t.dataset.folderAnimating="1";const s=230,i=()=>{t.dataset.folderAnimating="0",n.style.removeProperty("max-height"),n.style.removeProperty("opacity"),n.style.removeProperty("overflow"),o(),Bi()};let a=null;const l=d=>{d.target!==n||d.propertyName!=="max-height"||(n.removeEventListener("transitionend",l),a&&window.clearTimeout(a),e||(t.open=!1),i())};if(n.addEventListener("transitionend",l),a=window.setTimeout(()=>{n.removeEventListener("transitionend",l),e||(t.open=!1),i()},s+90),e){t.open=!0;const d=Math.max(0,Math.ceil(n.scrollHeight));n.style.setProperty("--folder-content-height",`${d}px`),n.style.overflow="hidden",n.style.maxHeight="0px",n.style.opacity="0",requestAnimationFrame(()=>{n.style.maxHeight=`${d}px`,n.style.opacity="1"});return}const c=Math.max(Math.ceil(n.scrollHeight),Math.ceil(n.getBoundingClientRect().height));n.style.setProperty("--folder-content-height",`${c}px`),n.style.overflow="hidden",n.style.maxHeight=`${c}px`,n.style.opacity="1",requestAnimationFrame(()=>{n.style.maxHeight="0px",n.style.opacity="0"})}function Xp(t,e=0){const n=Number(t?.sortIndex);return Number.isFinite(n)?n:e}function gE(t,e){const n=Xp(t)-Xp(e);return n!==0?n:(e?.updatedAt||0)-(t?.updatedAt||0)}function Uo(t,e){return String(t?.name||"").localeCompare(String(e?.name||""),void 0,{sensitivity:"base"})}function bE(t=[],e){const n=ld(e?.sessionSortMode),o=[...t];switch(n){case gm:return o.sort((r,s)=>{const i=Number(s?.updatedAt||0)-Number(r?.updatedAt||0);return i!==0?i:Uo(r,s)});case hm:return o.sort((r,s)=>{const i=Number(r?.updatedAt||0)-Number(s?.updatedAt||0);return i!==0?i:Uo(r,s)});case mm:return o.sort((r,s)=>{const i=Number(s?.createdAt||0)-Number(r?.createdAt||0);return i!==0?i:Uo(r,s)});case fm:return o.sort((r,s)=>{const i=Number(r?.createdAt||0)-Number(s?.createdAt||0);return i!==0?i:Uo(r,s)});case pm:return o.sort((r,s)=>{const i=Uo(r,s);return i!==0?i:Number(s?.updatedAt||0)-Number(r?.updatedAt||0)});case um:return o.sort((r,s)=>{const i=Uo(s,r);return i!==0?i:Number(s?.updatedAt||0)-Number(r?.updatedAt||0)});case cd:default:return o.sort(gE)}}function Vn(){dt&&(dt.portal?.remove(),dt.dropdown?.classList.remove("open","portal-open"),dt=null,Oi())}function Vg(){if(!dt)return;const{button:t,portal:e}=dt;if(!t?.isConnected||!e?.isConnected){Vn();return}const n=t.getBoundingClientRect();e.style.left="0px",e.style.top="0px",e.style.visibility="hidden",e.style.display="block";const o=e.getBoundingClientRect(),r=8,s=n.bottom+6,i=n.top>=o.height+r,l=s+o.height>window.innerHeight-r&&i?Math.max(r,n.top-o.height-6):Math.min(window.innerHeight-o.height-r,s);let c=n.right-o.width;c<r&&(c=r),c+o.width>window.innerWidth-r&&(c=Math.max(r,window.innerWidth-o.width-r)),e.style.left=`${Math.round(c)}px`,e.style.top=`${Math.round(l)}px`,e.style.visibility="visible"}function yE(t,e){const n=t.closest(".session-item[data-session-id]"),o=t.closest(".session-folder[data-folder-id]"),r=t.closest("#new-session-menu"),s=t.closest("#session-organize-menu");n?.dataset.sessionId&&(e.dataset.sessionId=n.dataset.sessionId),o?.dataset.folderId&&(e.dataset.folderId=o.dataset.folderId),r&&(e.dataset.menuType="new-session"),s&&(e.dataset.menuType="session-organize")}function wE(t){const e=t?.closest(".dropdown");if(!e)return;const n=e.querySelector(":scope > .dropdown-content");if(!n)return;Vn();const o=document.createElement("div");o.className=`${n.className||"dropdown-content"} dropdown-content-portal`,o.innerHTML=n.innerHTML,yE(e,o),document.body.appendChild(o),e.classList.add("open","portal-open"),dt={dropdown:e,button:t,portal:o},Vg(),Oi()}function vE(t){const e=t?.closest(".dropdown");if(e){if(dt?.dropdown===e){Vn();return}wE(t)}}function SE(t){const e=t?.closest?.(".session-folder[data-folder-id]")||null;if(!e||e.open){Gt&&(clearTimeout(Gt),Gt=null,Pr=null);return}const n=e.dataset.folderId;!n||Pr===n||(Gt&&clearTimeout(Gt),Pr=n,Gt=window.setTimeout(()=>{const o=document.querySelector(`.session-folder[data-folder-id="${n}"]`);o&&!o.open&&(o.open=!0),Gt=null,Pr=null},450))}function Oi(){document.querySelectorAll(".session-folder.has-open-menu").forEach(t=>t.classList.remove("has-open-menu")),document.querySelectorAll(".session-folder .dropdown.open").forEach(t=>{const e=t.closest(".session-folder");e&&e.classList.add("has-open-menu")})}function kE(t,e){return e.linkedEntity?.type==="agent"&&t.agentPresets?.[e.linkedEntity.name]?t.agentPresets[e.linkedEntity.name].icon||"ðŸ¤–":e.linkedEntity?.type==="group"?"ðŸ¤":"ðŸ’¬"}function qg(t){return t==="session_only"?"Session only":"Folder aware"}function er(t,e){const n=ze(e,t.folderId),o=Nn(t.contextMode),s=Bt(t.ragSettings,{scopeSource:t.folderId?"folder":"session"}).scopeSource==="folder"?"Folder RAG":"Session RAG",i=document.createElement("div");i.className="item session-item",i.dataset.sessionId=t.id,i.draggable=!0,(t.pinned||t.isPinned)&&i.classList.add("pinned"),t.archived&&i.classList.add("archived");const a=ka(t,{fallback:"New Chat"}),l=qg(o),c=n?`Folder: ${n.name}`:"Main list",d=kE(e,t),u=t.bookId&&Array.isArray(e?.books)?e.books.find(m=>m.id===t.bookId):null,f=[];Number.isFinite(Number(t?.actNumber))&&f.push(`Act ${Math.round(Number(t.actNumber))}`),Number.isFinite(Number(t?.chapterNumber))&&f.push(`Ch ${Math.round(Number(t.chapterNumber))}`);const p=t.bookId?`Book: ${u?.name||"Unknown"}${f.length?` (${f.join(" / ")})`:""}`:null;return i.innerHTML=`
        <div class="item-header">
            <span class="item-name"><span class="item-icon">${d}</span> ${a}</span>
            <div class="item-actions">
                <div class="dropdown align-right">
                    <button class="btn-icon" data-action="toggle-menu" title="More options">&#8942;</button>
                    <div class="dropdown-content">
                        <a href="#" data-action="info">Session Info</a>
                        <a href="#" data-action="pin">${t.pinned||t.isPinned?"Unpin":"Pin"} Session</a>
                        <a href="#" data-action="rename">Rename</a>
                        <a href="#" data-action="move">Move to Folder...</a>
                        <a href="#" data-action="context-mode">Context Mode...</a>
                        <a href="#" data-action="clone">Clone Session</a>
                        <a href="#" data-action="archive">${t.archived?"Unarchive":"Archive"} Session</a>
                        <a href="#" data-action="download">Download Chat</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" data-action="delete" class="is-destructive">
                            <span class="material-symbols-outlined">delete</span> Delete Session
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="session-item-meta">${[p,c,l,s].filter(Boolean).join(" â€¢ ")}</div>
    `,i}function xE(t,e,n){const o=ld(t?.sessionSortMode),r=uE.map(l=>{const c=l.value===o;return`
            <a
                href="#"
                data-action="folder:sort-mode"
                data-folder-sort-mode="${l.value}"
                class="folder-session-sort-option${c?" is-selected":""}"
                role="menuitemradio"
                aria-checked="${c?"true":"false"}"
            >
                <span>${l.label}</span>
                <span class="folder-session-sort-check material-symbols-outlined" aria-hidden="true">check</span>
            </a>
        `}).join(""),s=document.createElement("details");s.className="session-folder",s.dataset.folderId=t.id,s.dataset.sessionDropTarget="folder",s.open=!t.collapsed;const i=document.createElement("summary");i.className="session-folder-summary",i.innerHTML=`
        <span class="session-folder-title">
            <span class="session-folder-caret material-symbols-outlined">chevron_right</span>
            <span class="session-folder-icon-closed material-symbols-outlined">folder</span>
            <span class="session-folder-icon-open material-symbols-outlined">folder_open</span>
            <span>${t.name}</span>
            <span class="session-folder-count">${e.length}</span>
        </span>
        <div class="item-actions">
            <div class="dropdown align-right">
                <button class="btn-icon" data-action="toggle-menu" title="Folder options">&#8942;</button>
                <div class="dropdown-content session-organize-dropdown folder-session-dropdown">
                    <a href="#" data-action="folder:new-chat">New Chat in Folder</a>
                    <a href="#" data-action="folder:rename">Rename Folder</a>
                    <a href="#" data-action="folder:settings">Folder Context Budget...</a>
                    <div class="dropdown-divider"></div>
                    <div class="session-organize-heading">Sort Chats</div>
                    ${r}
                    <div class="dropdown-divider"></div>
                    <a href="#" data-action="folder:delete" class="is-destructive">Delete Folder</a>
                </div>
            </div>
        </div>
    `,s.appendChild(i);const a=document.createElement("div");return a.className="item-list folder-session-list",a.dataset.sessionDropTarget="folder",a.dataset.folderId=t.id,e.length===0?a.innerHTML='<p class="no-items-message">Drop sessions here or create a new one.</p>':e.forEach(l=>{a.appendChild(er(l,n))}),s.appendChild(a),s}function Kg(t){document.querySelectorAll(".session-item").forEach(n=>{n.classList.toggle("active",n.dataset.sessionId===t)})}function CE(t=""){return t?Math.max(1,Math.round(String(t).length/4)):0}function cn(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function EE(t,e){ie(e);const n=t.linkedEntity||null,o=h.getStagedEntity(),r=e.activeEntity||null,s=ze(e,t.folderId),i=Nn(t.contextMode),a=Bt(t.ragSettings,{scopeSource:t.folderId?"folder":"session"}),l=s?so(s.ragSettings):null,c=a.scopeSource==="folder"&&l?l:a,d=Array.isArray(c.selectedFileIds)?[...new Set(c.selectedFileIds)]:[],u=Array.isArray(e.knowledgeFiles)?e.knowledgeFiles:[],f=new Map(u.map(A=>[A.id,A])),p=d.map(A=>f.get(A)).filter(Boolean),m=u.filter(A=>Number(A.chunkCount)>0),b=m.reduce((A,L)=>A+(Number(L.chunkCount)||0),0),y=Array.isArray(t.history)?t.history.length:0,w=(t.history||[]).map(A=>typeof A.content=="string"?A.content:Array.isArray(A.content)?A.content.filter(L=>L?.type==="text"&&L.text).map(L=>L.text).join(`
`):"").join(`
`),v=CE(w),S=(t.history||[]).reduce((A,L)=>{const B=L?.stats||{};return A.prompt+=Number(B.prompt_tokens||B.promptTokens||0),A.completion+=Number(B.completion_tokens||B.completionTokens||0),A},{prompt:0,completion:0}),C=n?.type==="agent"?e.agentPresets?.[n.name]:null,x=n?.type==="group"?e.agentGroups?.[n.name]:null,I=Array.isArray(C?.activeMemories)?C.activeMemories:[],N=Array.isArray(x?.agents)?x.agents:[],E=qg(i);return`
        <div class="info-grid">
            <strong>Session Name:</strong><span>${cn(t.name||"Untitled")}</span>
            <strong>Session ID:</strong><span>${cn(t.id||"-")}</span>
            <strong>Created:</strong><span>${new Date(t.createdAt||Date.now()).toLocaleString("th-TH")}</span>
            <strong>Updated:</strong><span>${new Date(t.updatedAt||Date.now()).toLocaleString("th-TH")}</span>
            <strong>Folder:</strong><span>${cn(s?.name||"Main list")}</span>
            <strong>Context Mode:</strong><span>${cn(E)}</span>
            <strong>Linked Entity:</strong><span>${cn(n?`${n.type}:${n.name}`:"None")}</span>
            <strong>Active Entity:</strong><span>${cn(r?`${r.type}:${r.name}`:"None")}</span>
            <strong>Staged Entity:</strong><span>${cn(o?`${o.type}:${o.name} (pending confirm)`:"None")}</span>
            <strong>Messages:</strong><span>${y.toLocaleString()}</span>
            <strong>Approx History Tokens:</strong><span>~${v.toLocaleString()}</span>
            <strong>Usage Prompt Tokens:</strong><span>${S.prompt.toLocaleString()}</span>
            <strong>Usage Completion Tokens:</strong><span>${S.completion.toLocaleString()}</span>
        </div>
        <h4>Agent / Group Detail</h4>
        <pre>${cn(n?.type==="agent"?`Agent: ${n.name}
Model: ${C?.model||"N/A"}
Active Memories: ${I.length?I.join(", "):"None"}`:n?.type==="group"?`Group: ${n.name}
Moderator: ${x?.moderatorAgent||"N/A"}
Members: ${N.length?N.join(", "):"None"}`:"No linked entity")}</pre>
        <h4>RAG Detail</h4>
        <pre>${cn([`RAG Source: ${a.scopeSource==="folder"?"folder":"session"}`,`Scope: ${c.scopeMode==="selected"?"selected":"all"}`,`Top-K: ${Number(c.retrievalTopK||0)}`,`Token Budget: ${Number(c.maxContextTokens||0)}`,`Selected Docs: ${p.length}`,p.length?`Selected Names: ${p.map(A=>A.name).join(", ")}`:"Selected Names: None",`Indexed Files in Project: ${m.length}/${u.length}`,`Total Indexed Chunks: ${b}`,s?.contextPolicy?`Folder Shared Context: ${s.contextPolicy.autoSharedContext===!1?"Disabled":"Enabled"} | Budget ${s.contextPolicy.sharedContextBudgetTokens} tokens, max ${s.contextPolicy.maxSharedSessions} sessions`:"Folder Shared Context Budget: N/A",s?.ragSettings?`Folder Auto RAG: ${s.ragSettings.autoRetrieve===!1?"Disabled":"Enabled"}`:"Folder Auto RAG: N/A"].join(`
`))}</pre>
    `}function IE(){const t=document.getElementById("session-info-modal");t&&(t.style.display="none")}function Gg(){const t=document.getElementById("folder-settings-modal");t&&(t.style.display="none")}function AE(t,e){const n=document.getElementById("folder-settings-file-list");if(!n)return;const o=Array.isArray(t?.knowledgeFiles)?t.knowledgeFiles:[],r=new Set(Array.isArray(e?.selectedFileIds)?e.selectedFileIds:[]);if(n.innerHTML="",o.length===0){n.innerHTML='<p class="no-items-message">No knowledge files uploaded yet.</p>';return}o.forEach(s=>{const i=document.createElement("label");i.className="folder-settings-file-item";const a=document.createElement("input");a.type="checkbox",a.dataset.fileId=s.id,a.checked=r.has(s.id);const l=document.createElement("span"),c=Number(s.chunkCount)||0;l.textContent=`${s.name} (${c} chunk${c===1?"":"s"})`,i.appendChild(a),i.appendChild(l),n.appendChild(i)})}function Jg(){const t=document.getElementById("folder-settings-auto-shared-context"),e=document.getElementById("folder-settings-auto-rag"),n=document.getElementById("folder-settings-shared-budget"),o=document.getElementById("folder-settings-max-sessions"),r=document.getElementById("folder-settings-rag-scope"),s=document.getElementById("folder-settings-rag-topk"),i=document.getElementById("folder-settings-rag-budget"),a=document.getElementById("folder-settings-file-list");if(!t||!e)return;const l=!!t.checked,c=!!e.checked,d=r?.value||"all",u=c&&d==="selected";[n,o].forEach(f=>{f&&(f.disabled=!l)}),[r,s,i].forEach(f=>{f&&(f.disabled=!c)}),a&&a.classList.toggle("is-disabled",!u)}function NE({folderId:t}={}){const e=h.getProject();if(!e)return;ie(e);const n=ze(e,t);if(!n){k("Folder not found.","Folder Settings");return}const o=ad(n.contextPolicy),r=so(n.ragSettings),s=document.getElementById("folder-settings-modal"),i=document.getElementById("folder-settings-id"),a=document.getElementById("folder-settings-name"),l=document.getElementById("folder-settings-auto-shared-context"),c=document.getElementById("folder-settings-shared-budget"),d=document.getElementById("folder-settings-max-sessions"),u=document.getElementById("folder-settings-auto-rag"),f=document.getElementById("folder-settings-rag-scope"),p=document.getElementById("folder-settings-rag-topk"),m=document.getElementById("folder-settings-rag-budget");!s||!i||!a||!l||!c||!d||!u||!f||!p||!m||(i.value=n.id,a.value=n.name||"",l.checked=o.autoSharedContext!==!1,c.value=String(o.sharedContextBudgetTokens),d.value=String(o.maxSharedSessions),u.checked=r.autoRetrieve!==!1,f.value=r.scopeMode,p.value=String(r.retrievalTopK),m.value=String(r.maxContextTokens),AE(e,r),Jg(),s.style.display="flex")}function ME(){const t=document.getElementById("folder-settings-id")?.value||"";if(!t)return;const e=document.getElementById("folder-settings-name")?.value?.trim()||"",n=!!document.getElementById("folder-settings-auto-shared-context")?.checked,o=Number(document.getElementById("folder-settings-shared-budget")?.value),r=Number(document.getElementById("folder-settings-max-sessions")?.value),s=!!document.getElementById("folder-settings-auto-rag")?.checked,i=document.getElementById("folder-settings-rag-scope")?.value||"all",a=Number(document.getElementById("folder-settings-rag-topk")?.value),l=Number(document.getElementById("folder-settings-rag-budget")?.value),c={autoSharedContext:n};Number.isFinite(o)&&(c.sharedContextBudgetTokens=o),Number.isFinite(r)&&(c.maxSharedSessions=r);const d={autoRetrieve:s,scopeMode:i==="selected"?"selected":"all"};Number.isFinite(a)&&(d.retrievalTopK=a),Number.isFinite(l)&&(d.maxContextTokens=l),d.selectedFileIds=Array.from(document.querySelectorAll('#folder-settings-file-list input[type="checkbox"][data-file-id]:checked')).map(u=>u.dataset.fileId).filter(Boolean),h.bus.publish("folder:updateSettings",{folderId:t,name:e,contextPolicy:c,ragSettings:d}),Gg()}function Yg(){const t=document.getElementById("folder-name-modal");t&&(t.style.display="none")}function Cc({mode:t="create",folderId:e="",defaultName:n=""}={}){const o=document.getElementById("folder-name-modal"),r=document.getElementById("folder-name-mode"),s=document.getElementById("folder-name-folder-id"),i=document.getElementById("folder-name-modal-title"),a=document.getElementById("folder-name-input");if(!o||!r||!s||!i||!a)return;const l=h.getProject();l&&(ie(l),r.value=t==="rename"?"rename":"create",s.value=e||"",i.textContent=t==="rename"?"Rename Folder":"Create Folder",a.value=n||(t==="rename"?"":"New Folder"),o.style.display="flex",requestAnimationFrame(()=>a.focus()))}function TE(){const t=document.getElementById("folder-name-mode")?.value||"create",e=document.getElementById("folder-name-folder-id")?.value||"",n=document.getElementById("folder-name-input")?.value?.trim()||"";n&&(t==="rename"?h.bus.publish("folder:rename",{folderId:e,name:n}):h.bus.publish("folder:new",{askName:!1,name:n}),Yg())}function Xg(){const t=document.getElementById("session-move-modal");t&&(t.style.display="none")}function PE({sessionId:t}={}){const e=h.getProject();if(!e)return;ie(e);const n=(e.chatSessions||[]).find(l=>l.id===t);if(!n)return;const o=document.getElementById("session-move-modal"),r=document.getElementById("session-move-session-id"),s=document.getElementById("session-move-folder-select"),i=document.getElementById("session-move-modal-title");if(!o||!r||!s||!i)return;r.value=n.id,i.textContent=`Move "${n.name||"Untitled"}"`,s.innerHTML='<option value="">Main list (no folder)</option>',(e.chatFolders||[]).forEach(l=>{const c=document.createElement("option");c.value=l.id,c.textContent=l.name,s.appendChild(c)}),s.value=n.folderId||"";const a=document.getElementById("session-move-new-folder-name");a&&(a.value=""),o.style.display="flex"}function BE(){const t=document.getElementById("session-move-session-id")?.value||"",e=document.getElementById("session-move-folder-select")?.value||null;t&&(h.bus.publish("session:move",{sessionId:t,folderId:e}),Xg())}function Qg(){const t=document.getElementById("session-context-mode-modal");t&&(t.style.display="none")}function OE({sessionId:t}={}){const e=h.getProject();if(!e)return;ie(e);const n=(e.chatSessions||[]).find(a=>a.id===t);if(!n)return;const o=document.getElementById("session-context-mode-modal"),r=document.getElementById("session-context-mode-session-id"),s=document.getElementById("session-context-mode-select"),i=document.getElementById("session-context-mode-title");!o||!r||!s||!i||(r.value=n.id,i.textContent=`Context Mode for "${n.name||"Untitled"}"`,s.value=Nn(n.contextMode),!n.folderId&&s.value==="folder_aware"&&(s.value="session_only"),o.style.display="flex")}function LE(){const t=document.getElementById("session-context-mode-session-id")?.value||"",e=document.getElementById("session-context-mode-select")?.value||"folder_aware";if(t){if(e==="folder_aware"&&!(h.getProject()?.chatSessions||[]).find(r=>r.id===t)?.folderId){k("This session is not in a folder yet. Move it into a folder first.","Context Mode");return}h.bus.publish("session:contextMode",{sessionId:t,mode:e}),Qg()}}function Sl(t=!0,e=!0){document.querySelectorAll("[data-session-drop-target].is-drop-target").forEach(n=>n.classList.remove("is-drop-target")),document.querySelectorAll(".session-item.is-drop-before, .session-item.is-drop-after").forEach(n=>{n.classList.remove("is-drop-before"),n.classList.remove("is-drop-after")}),e&&document.querySelectorAll(".session-item.is-dragging").forEach(n=>n.classList.remove("is-dragging")),t&&(Gt&&(clearTimeout(Gt),Gt=null),Pr=null)}function Qp(t){const e=h.getProject();if(!e||!hn)return null;const n=t.target.closest(".session-item[data-session-id]");if(n&&n.dataset.sessionId!==hn){const i=(e.chatSessions||[]).find(c=>c.id===n.dataset.sessionId);if(!i||i.archived)return null;const a=n.getBoundingClientRect(),l=t.clientY<a.top+a.height/2?"before":"after";return{folderId:i.folderId||null,targetSessionId:i.id,position:l,dropElement:n}}const o=t.target.closest(".folder-session-list[data-folder-id]");if(o)return{folderId:o.dataset.folderId||null,targetSessionId:null,position:"after",dropElement:o};const r=t.target.closest(".session-folder[data-folder-id]");if(r)return{folderId:r.dataset.folderId||null,targetSessionId:null,position:"after",dropElement:r.querySelector(".folder-session-list")||r};const s=t.target.closest('#sessionListContainer[data-session-drop-target="root"]');return s?{folderId:null,targetSessionId:null,position:"after",dropElement:s}:null}function Ro(){const t=h.getProject();if(!t)return;ie(t),Vn();const e=document.getElementById("pinnedSessionList"),n=document.getElementById("sessionListContainer"),o=document.getElementById("archivedSessionList"),r=document.getElementById("archivedSessionsSection");if(!e||!n||!o||!r)return;e.innerHTML="",n.innerHTML="",o.innerHTML="",n.dataset.sessionDropTarget="root",n.dataset.folderId="";const s=Ud(t),a=(Array.isArray(t.chatSessions)?t.chatSessions:[]).filter(f=>dm(f)),l=a.filter(f=>!f.archived),c=a.filter(f=>f.archived),d=Yp(l,t,s.showMode),u=Yp(c,t,s.showMode);if(s.organizeBy===lE){const f=vl(d,s.sortBy),p=f.filter(b=>(b.pinned||b.isPinned)&&!b.folderId),m=f.filter(b=>!(b.pinned||b.isPinned)||b.folderId);p.forEach(b=>{e.appendChild(er(b,t))}),m.forEach(b=>{n.appendChild(er(b,t))})}else{const f=vl(d.filter(v=>(v.pinned||v.isPinned)&&!v.folderId),s.sortBy),p=vl(d.filter(v=>!(v.pinned||v.isPinned)&&!v.folderId),s.sortBy);f.forEach(v=>{e.appendChild(er(v,t))});const m=Array.isArray(t.chatFolders)?t.chatFolders:[],y=((t.chatSessions||[]).find(v=>v.id===t.activeSessionId)||null)?.folderId||null;(s.showMode===ni?m.filter(v=>v.id===y):m).forEach(v=>{const S=bE(d.filter(C=>C.folderId===v.id),v);(s.showMode!==ni||S.length>0)&&n.appendChild(xE(v,S,t))}),p.forEach(v=>{n.appendChild(er(v,t))})}n.children.length===0&&(n.innerHTML=s.showMode===ni?'<p class="no-items-message">No relevant sessions for this chat.</p>':'<p class="no-items-message">No sessions yet. Create your first chat.</p>'),u.sort((f,p)=>Pi(p,s.sortBy)-Pi(f,s.sortBy)).forEach(f=>o.appendChild(er(f,t))),r.classList.toggle("hidden",u.length===0),pE(t),Kg(t.activeSessionId),requestAnimationFrame(Bi)}function DE({sessionId:t}={}){const e=h.getProject();if(!e)return;ie(e);const n=t||e.activeSessionId,o=e.chatSessions?.find(i=>i.id===n);if(!o)return;const r=document.getElementById("session-info-modal"),s=document.getElementById("session-info-content");!r||!s||(s.innerHTML=EE(o,e),r.style.display="flex")}function Zp(t,e,n){if(t==="move"){PE({sessionId:e});return}if(t==="context-mode"){OE({sessionId:e});return}h.bus.publish(`session:${t}`,{sessionId:e,event:n})}function ef(t,e,n={}){if(t==="folder:new-chat"){h.bus.publish("folder:newChat",{folderId:e});return}if(t==="folder:sort-mode"){h.bus.publish("folder:sortMode",{folderId:e,sortMode:n.folderSortMode});return}if(t==="folder:rename"){const o=h.getProject();if(!o)return;ie(o);const r=ze(o,e);Cc({mode:"rename",folderId:e,defaultName:r?.name||""});return}if(t==="folder:settings"){h.bus.publish("folder:settings",{folderId:e});return}t==="folder:delete"&&h.bus.publish("folder:delete",{folderId:e})}function tf(t){if(!t||t.dataset.action!=="session:organizeSet")return!1;const e={};return t.dataset.organizeBy&&(e.organizeBy=t.dataset.organizeBy),t.dataset.sortBy&&(e.sortBy=t.dataset.sortBy),t.dataset.showMode&&(e.showMode=t.dataset.showMode),h.bus.publish("session:organizeSet",e),!0}function RE(){if(Gp)return;Gp=!0,h.bus.subscribe("project:loaded",Ro),h.bus.subscribe("session:listChanged",Ro),h.bus.subscribe("session:loaded",()=>Kg(h.getProject()?.activeSessionId)),h.bus.subscribe("folder:settings",NE);const t=document.querySelector(".sessions-panel");t&&(t.addEventListener("click",i=>{const a=i.target,l=a.closest(".dropdown-content a[data-action]");if(l){i.preventDefault(),i.stopPropagation();const f=l.dataset.action,p=l.closest(".session-item[data-session-id]"),m=l.closest(".session-folder[data-folder-id]"),b=l.closest("#new-session-menu"),y=l.closest("#session-organize-menu"),w=l.dataset.folderSortMode||"";p?Zp(f,p.dataset.sessionId,i):m?ef(f,m.dataset.folderId,{folderSortMode:w}):b?f==="new-chat"?h.bus.publish("session:new"):f==="new-folder"&&Cc({mode:"create"}):y&&tf(l),l.closest(".dropdown.open")?.classList.remove("open","portal-open"),Oi();return}const c=a.closest('button[data-action="toggle-menu"]');if(c){i.preventDefault(),i.stopPropagation(),vE(c);return}if(a.closest("#new-chat-btn")&&!a.closest("#new-session-menu")){h.bus.publish("session:new");return}if(a.closest("#session-list-locate-trigger")){i.preventDefault(),_s();return}const d=a.closest(".session-folder-summary");if(d){const f=d.closest(".session-folder[data-folder-id]");if(f?.dataset.folderId){i.preventDefault(),h.bus.publish("folder:activate",{folderId:f.dataset.folderId}),hE(f,!f.open);return}}const u=a.closest(".session-item[data-session-id]");if(u){const f=u.dataset.sessionId;h.getProject().activeSessionId!==f&&_t(f)}}),t.addEventListener("dragstart",i=>{const a=i.target.closest(".session-item[data-session-id]");a&&(hn=a.dataset.sessionId,a.classList.add("is-dragging"),i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text/plain",hn))}),t.addEventListener("dragend",()=>{hn=null,Sl()}),t.addEventListener("dragover",i=>{const a=Qp(i);!hn||!a||(i.preventDefault(),Sl(!1,!1),a.targetSessionId&&a.dropElement?.classList.contains("session-item")?a.dropElement.classList.add(a.position==="before"?"is-drop-before":"is-drop-after"):a.dropElement?.classList.add("is-drop-target"),SE(i.target),i.dataTransfer.dropEffect="move")}),t.addEventListener("drop",i=>{const a=Qp(i);!hn||!a||(i.preventDefault(),h.bus.publish("session:move",{sessionId:hn,folderId:a.folderId,targetSessionId:a.targetSessionId,position:a.position}),hn=null,Sl())}),t.addEventListener("toggle",i=>{const a=i.target.closest(".session-folder[data-folder-id]");!a||i.target!==a||xc||a.dataset.folderAnimating==="1"||h.bus.publish("folder:collapse",{folderId:a.dataset.folderId,collapsed:!a.open})},!0)),document.addEventListener("click",i=>{const a=i.target.closest(".dropdown-content-portal a[data-action]");if(a){i.preventDefault(),i.stopPropagation();const l=a.closest(".dropdown-content-portal"),c=a.dataset.action,d=l?.dataset.sessionId||"",u=l?.dataset.folderId||"",f=l?.dataset.menuType||"",p=a.dataset.folderSortMode||"";d?Zp(c,d,i):u?ef(c,u,{folderSortMode:p}):f==="new-session"?c==="new-chat"?h.bus.publish("session:new"):c==="new-folder"&&Cc({mode:"create"}):f==="session-organize"&&tf(a),Vn();return}dt&&!dt.portal.contains(i.target)&&!dt.button.contains(i.target)&&Vn(),requestAnimationFrame(Oi)}),document.addEventListener("scroll",()=>{dt&&Vn()},!0),window.addEventListener("resize",()=>{dt&&Vg(),Bi()});const e=document.getElementById("session-info-modal");e?.addEventListener("click",i=>{(i.target===e||i.target.closest(".modal-close-btn"))&&IE()});const n=document.getElementById("folder-settings-modal");n?.addEventListener("click",i=>{const a=i.target;if(a===n||a.closest(".modal-close-btn")){Gg();return}a.closest("#folder-settings-save-btn")&&ME()}),n?.addEventListener("change",i=>{const a=i.target;(a?.id==="folder-settings-auto-shared-context"||a?.id==="folder-settings-auto-rag"||a?.id==="folder-settings-rag-scope")&&Jg()});const o=document.getElementById("folder-name-modal");o?.addEventListener("click",i=>{const a=i.target;if(a===o||a.closest(".modal-close-btn")){Yg();return}a.closest("#folder-name-save-btn")&&TE()});const r=document.getElementById("session-move-modal");r?.addEventListener("click",i=>{const a=i.target;if(a===r||a.closest(".modal-close-btn")){Xg();return}if(a.closest("#session-move-save-btn")){BE();return}if(a.closest("#session-move-create-folder-btn")){const c=(document.getElementById("session-move-new-folder-name")?.value||"").trim();if(!c){k("Please enter a folder name before creating.","Move Session");return}const d=qd({askName:!1,name:c});if(d?.id){const u=document.getElementById("session-move-folder-select");if(u){const p=document.createElement("option");p.value=d.id,p.textContent=d.name,u.insertBefore(p,u.children[1]||null),u.value=d.id}const f=document.getElementById("session-move-new-folder-name");f&&(f.value="")}}});const s=document.getElementById("session-context-mode-modal");s?.addEventListener("click",i=>{const a=i.target;if(a===s||a.closest(".modal-close-btn")){Qg();return}a.closest("#session-context-mode-save-btn")&&LE()}),document.addEventListener("keydown",i=>{if(i.key==="Escape"&&dt){Vn();return}(i.key==="Enter"||i.key===" ")&&i.target?.id==="session-list-locate-trigger"&&(i.preventDefault(),_s())}),document.getElementById("locate-active-session-btn")?.addEventListener("click",i=>{i.preventDefault(),_s()}),document.getElementById("chat-title")?.addEventListener("click",i=>{i.preventDefault(),_s()}),console.log("âœ… Session UI initialized with folder support.")}const jE=(t="sid")=>`${t}_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,_E="folder",nf="chronological",$E="updated",of="created",FE="all",rf="relevant",vr=()=>h.getProject();function Zg(t={}){return{organizeBy:t?.organizeBy===nf?nf:_E,sortBy:t?.sortBy===of?of:$E,showMode:t?.showMode===rf?rf:FE}}function Ud(t=vr()){return Zg(t?.globalSettings?.sessionListPreferences)}function WE({organizeBy:t,sortBy:e,showMode:n}={}){const o=vr();if(!o)return;const r=Ud(o),s=Zg({...r,organizeBy:t,sortBy:e,showMode:n});r.organizeBy===s.organizeBy&&r.sortBy===s.sortBy&&r.showMode===s.showMode||((!o.globalSettings||typeof o.globalSettings!="object")&&(o.globalSettings={}),o.globalSettings.sessionListPreferences=s,h.setProject(o),h.updateAndPersistState(),h.bus.publish("session:listChanged"))}function Cs(t,e){return!t||!e?null:t.chatSessions?.find(n=>n.id===e)||null}function zE(t,e=null){if(!t)return null;if(e&&ze(t,e))return e;const n=Cs(t,t.activeSessionId);return n?.folderId&&ze(t,n.folderId)?n.folderId:t.activeFolderId&&ze(t,t.activeFolderId)?t.activeFolderId:null}function Sr(){h.bus.publish("session:listChanged"),h.bus.publish("studio:contentShouldRender")}function HE(t,e){return!t||!e||!e.type||!e.name?!1:e.type==="agent"?!!t.agentPresets?.[e.name]:e.type==="group"?!!t.agentGroups?.[e.name]:!1}function UE(t){const e=Object.keys(t?.agentPresets||{})[0];if(e)return{type:"agent",name:e};const n=Object.keys(t?.agentGroups||{})[0];return n?{type:"group",name:n}:null}function eb(t,e){const o=[e?.linkedEntity,t?.activeEntity,UE(t)].find(i=>HE(t,i));if(!o)return{entity:null,changed:!1};const r={type:o.type,name:o.name};let s=!1;return e&&(!e.linkedEntity||e.linkedEntity.type!==r.type||e.linkedEntity.name!==r.name)&&(e.linkedEntity={...r},s=!0),(!t.activeEntity||t.activeEntity.type!==r.type||t.activeEntity.name!==r.name)&&(t.activeEntity={...r},s=!0),{entity:r,changed:s}}function Ec(t,e=0){const n=Number(t?.sortIndex);return Number.isFinite(n)?n:e}function VE(t,e){const n=Ec(t)-Ec(e);return n!==0?n:(e?.updatedAt||0)-(t?.updatedAt||0)}function Vd(t,e,n=null){return(t?.chatSessions||[]).filter(o=>!o||o.archived||n&&o.id===n?!1:(o.folderId||null)===(e||null)).sort(VE)}function tb(t,e){Vd(t,e).forEach((o,r)=>{o.sortIndex=r})}function nb(t,e){const n=Vd(t,e);return n.length===0?0:Math.min(...n.map((r,s)=>Ec(r,s)))-1}function qE(t,e,n,o=null,r="after"){const s=Vd(t,n,e.id);let i=s.length;if(o){const a=s.findIndex(l=>l.id===o);a>=0&&(i=r==="before"?a:a+1)}s.splice(i,0,e),s.forEach((a,l)=>{a.sortIndex=l})}function hr(t={}){const e=h.getProject();if(!e)return;ie(e),io(e);const n=eb(e,{linkedEntity:e.activeEntity}).entity;if(!n){k("Cannot create chat session: no valid Agent/Group is available.","Error");return}const o=bm(t),r=o===dd||o===ko,s=r?null:zE(e,t?.folderId||null),i=Nn(t?.contextMode||Xy),a=Bt({...Qy,scopeSource:s?"folder":"session",...t?.ragSettings||{}}),l=new Set((e.books||[]).map(u=>u.id)),c=_o(t,{validBookIds:l}),d={id:`sid_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:"New Chat",history:[],composerContent:"",workspaceView:"chat",composerViewMode:"maximized",composerHeight:null,createdAt:Date.now(),updatedAt:Date.now(),pinned:!1,archived:!1,kind:o,bookAgentBookId:o===ko&&t.bookAgentBookId||null,folderId:s,sortIndex:nb(e,s),contextMode:i,linkedEntity:{...n},...c,summaryState:{activeSummaryId:null,summarizedUntilIndex:-1},ragSettings:a,groupChatState:{isRunning:!1,awaitsUserInput:!1,turnQueue:[],currentJob:null,jobQueue:[],error:null}};e.chatSessions.unshift(d),e.activeSessionId=d.id,e.activeFolderId=r?null:s||null,h.setProject(e),_t(d.id)}function _t(t){const e=h.getProject();if(!e)return;if(ie(e),io(e),!t){e.activeSessionId=null,e.activeFolderId=null,h.setProject(e),h.bus.publish("session:cleared");return}const n=e.chatSessions.find(r=>r.id===t);if(!n){console.warn(`Session with ID ${t} not found. Loading most recent as fallback.`);const r=[...e.chatSessions].filter(s=>!s.archived).sort((s,i)=>i.updatedAt-s.updatedAt)[0];_t(r?r.id:null);return}const{entity:o}=eb(e,n);if(!o){k("Cannot load this session because it has no valid linked Agent/Group.","Error");return}n.contextMode=Nn(n.contextMode),n.ragSettings=Bt(n.ragSettings,{scopeSource:n.folderId?"folder":"session"}),Object.assign(n,_o(n,{validBookIds:new Set((e.books||[]).map(r=>r.id))})),n.kind=bm(n),!n.folderId&&n.ragSettings.scopeSource==="folder"&&(n.ragSettings.scopeSource="session"),e.activeSessionId=t,e.activeFolderId=n.folderId||null,h.setProject(e),h.updateAndPersistState(),h.bus.publish("session:loaded",{session:n})}function KE({sessionId:t}){const e=h.getProject(),n=e?.chatSessions.find(r=>r.id===t);if(!n)return;const o=prompt("Enter new name:",n.name);o&&o.trim()&&o.trim()!==n.name&&(n.name=o.trim(),n.updatedAt=Date.now(),h.updateAndPersistState(),h.bus.publish("session:listChanged"),t===e.activeSessionId&&h.bus.publish("ui:updateChatTitle",{title:n.name}))}function qd(t={}){const e=h.getProject();if(!e)return null;ie(e);const n=t?.name||mi(e.chatFolders,"New Folder"),r=t?.askName!==!1?prompt("Folder name:",n):n;if(!r||!r.trim())return null;const s=r.trim(),a=e.chatFolders.find(d=>d.name.toLowerCase()===s.toLowerCase())?mi(e.chatFolders,s):s,l=Date.now(),c={id:ew(),name:a,color:"",createdAt:l,updatedAt:l,collapsed:!1,ragSettings:so(t?.ragSettings),contextPolicy:ad(t?.contextPolicy)};return e.chatFolders.unshift(c),e.activeFolderId=c.id,h.setProject(e),h.updateAndPersistState(),Sr(),c}function GE({folderId:t,name:e}={}){const n=h.getProject();if(!n)return;ie(n);const o=ze(n,t);if(!o)return;const r=typeof e=="string"?e:prompt("Rename folder:",o.name);if(!r||!r.trim())return;const s=r.trim(),i=n.chatFolders.find(a=>a.id!==o.id&&a.name.toLowerCase()===s.toLowerCase());o.name=i?mi(n.chatFolders,s):s,o.updatedAt=Date.now(),h.setProject(n),h.updateAndPersistState(),Sr()}function JE({folderId:t}){const e=h.getProject();if(!e)return;ie(e);const n=ze(e,t);!n||!confirm(`Delete folder "${n.name}"? Sessions will be moved to the main list.`)||(e.chatFolders=e.chatFolders.filter(r=>r.id!==t),e.chatSessions=e.chatSessions.map(r=>{if(r.folderId!==t)return r;const s=Bt(r.ragSettings,{scopeSource:"session"});return s.scopeSource="session",{...r,folderId:null,ragSettings:s}}),e.activeFolderId===t&&(e.activeFolderId=null),h.setProject(e),h.updateAndPersistState(),Sr())}function YE({folderId:t,name:e,contextPolicy:n,ragSettings:o}={}){const r=h.getProject();if(!r)return;ie(r);const s=ze(r,t);if(s){if(typeof e=="string"&&e.trim()){const i=e.trim(),a=r.chatFolders.find(l=>l.id!==s.id&&l.name.toLowerCase()===i.toLowerCase());s.name=a?mi(r.chatFolders,i):i}n&&typeof n=="object"&&(s.contextPolicy=ad({...s.contextPolicy,...n})),o&&typeof o=="object"&&(s.ragSettings=so({...s.ragSettings,...o})),s.updatedAt=Date.now(),h.setProject(r),h.updateAndPersistState(),Sr()}}function XE({folderId:t}){const e=h.getProject();if(!e)return;ie(e);const n=ze(e,t);n&&(e.activeFolderId=n.id,h.setProject(e))}function QE({folderId:t,collapsed:e}){const n=h.getProject();if(!n)return;ie(n);const o=ze(n,t);o&&(o.collapsed=!!e,o.updatedAt=Date.now(),h.setProject(n))}function ZE({folderId:t,sortMode:e}){const n=h.getProject();if(!n)return;ie(n);const o=ze(n,t);if(!o)return;const r=ld(e);o.sessionSortMode!==r&&(o.sessionSortMode=r,o.updatedAt=Date.now(),h.setProject(n),h.updateAndPersistState(),Sr())}function eI({folderId:t}){hr({folderId:t})}function oi({sessionId:t,folderId:e=null,targetSessionId:n=null,position:o="after"}={}){const r=h.getProject();if(!r)return;ie(r);const s=Cs(r,t);if(!s)return;const i=s.folderId||null,a=e&&ze(r,e)?e:null;if(s.folderId=a,s.updatedAt=Date.now(),a&&(s.pinned=!1),s.ragSettings=Bt(s.ragSettings,{scopeSource:a?s.ragSettings?.scopeSource:"session"}),!a&&s.ragSettings.scopeSource==="folder"&&(s.ragSettings.scopeSource="session"),r.activeSessionId===t&&(r.activeFolderId=a),qE(r,s,a,n,o==="before"?"before":"after"),a&&n){const c=ze(r,a);c&&(c.sessionSortMode=cd)}i!==a&&tb(r,i),h.setProject(r),h.updateAndPersistState(),Sr()}function tI({sessionId:t}){const e=h.getProject();if(!e)return;ie(e);const n=Cs(e,t);if(!n)return;const o=e.chatFolders.map((l,c)=>`${c+1}. ${l.name}`).join(`
`),r=prompt([`Move "${n.name}" to:`,"0 = Main list (no folder)","n = Create new folder",o||"(No folders yet)"].join(`
`),n.folderId?String(e.chatFolders.findIndex(l=>l.id===n.folderId)+1):"0");if(r===null)return;const s=r.trim().toLowerCase();if(s==="n"){const l=qd({askName:!0});l&&oi({sessionId:t,folderId:l.id});return}const i=Number.parseInt(s,10);if(!Number.isFinite(i)){k("Invalid folder selection.","Session Folder");return}if(i<=0){oi({sessionId:t,folderId:null});return}const a=e.chatFolders[i-1];if(!a){k("Folder number not found.","Session Folder");return}oi({sessionId:t,folderId:a.id})}function Ic({sessionId:t,mode:e}){const n=h.getProject();if(!n)return;ie(n);const o=Cs(n,t);if(!o)return;const r=Nn(e);if(r==="folder_aware"&&!o.folderId){k("This session is not inside a folder yet. Move it into a folder first.","Context Mode");return}o.contextMode=r,o.updatedAt=Date.now(),h.setProject(n),h.updateAndPersistState(),h.bus.publish("session:listChanged")}function nI({sessionId:t}){const e=h.getProject();if(!e)return;ie(e);const n=Cs(e,t);if(!n)return;const r=Nn(n.contextMode)==="session_only"?"2":"1",s=prompt([`Context mode for "${n.name}"`,"1 = Folder aware (recommended for sessions inside folder)","2 = Session only"].join(`
`),r);if(s===null)return;const i=s.trim();if(i==="1"){if(!n.folderId){k("This session is not inside a folder yet. Move it into a folder first.","Context Mode");return}Ic({sessionId:t,mode:"folder_aware"})}else i==="2"?Ic({sessionId:t,mode:"session_only"}):k("Invalid mode selection.","Context Mode")}async function oI({sessionId:t}){if(!confirm("Are you sure you want to delete this chat session? This cannot be undone."))return;const e=h.getProject();ie(e);const n=e.chatSessions.findIndex(r=>r.id===t);if(n===-1)return;const o=e.chatSessions[n];if(e.chatSessions.splice(n,1),io(e),(e.books||[]).forEach(r=>{if(!r?.structure)return;const s=Array.isArray(r.structure.chapterSessionIds)?r.structure.chapterSessionIds:[],i=s.filter(a=>a!==t);i.length!==s.length&&(r.structure.chapterSessionIds=i,r.updatedAt=Date.now())}),tb(e,o?.folderId||null),await To(Zn,"readwrite","delete",t),e.activeSessionId===t){const r=[...e.chatSessions].filter(s=>!s.archived).sort((s,i)=>i.updatedAt-s.updatedAt)[0];e.activeSessionId=r?r.id:null,e.activeFolderId=r?.folderId||null,_t(e.activeSessionId)}else h.bus.publish("session:listChanged");h.updateAndPersistState()}function rI(t,e){e?.stopPropagation();const n=vr();ie(n);const o=n?.chatSessions.find(r=>r.id===t);o&&(o.pinned=!o.pinned,o.updatedAt=Date.now(),h.updateAndPersistState(n),Ro())}function sI(t,e){e?.stopPropagation();const n=vr();ie(n);const o=n?.chatSessions.find(s=>s.id===t);if(!o){k("Error: Could not find session to clone.","Error");return}const r=JSON.parse(JSON.stringify(o));r.id=jE(),r.name=`${o.name} (Copy)`,r.createdAt=Date.now(),r.updatedAt=Date.now(),r.pinned=!1,r.archived=!1,r.sortIndex=nb(n,r.folderId||null),r.contextMode=Nn(r.contextMode),r.ragSettings=Bt(r.ragSettings,{scopeSource:r.folderId?r.ragSettings?.scopeSource:"session"}),!r.folderId&&r.ragSettings.scopeSource==="folder"&&(r.ragSettings.scopeSource="session"),n.chatSessions.unshift(r),n.activeSessionId=r.id,n.activeFolderId=r.folderId||null,h.updateAndPersistState(n),_t(r.id)}function iI(t,e){e?.stopPropagation();const n=vr();ie(n);const o=n?.chatSessions.find(r=>r.id===t);if(o)if(o.archived=!o.archived,o.archived&&(o.pinned=!1),o.updatedAt=Date.now(),n.activeSessionId===t&&o.archived){const r=n.chatSessions.find(s=>!s.archived);n.activeSessionId=r?r.id:null,n.activeFolderId=r?.folderId||null,h.updateAndPersistState(n),_t(n.activeSessionId)}else h.updateAndPersistState(n),Ro()}async function ob(t){const e=t||vr()?.chatSessions;if(!e)return;const n=tw();if(!n){console.error("[SaveAllSessions] Cannot save, DB not available.");return}const o=n.transaction(Zn,"readwrite"),r=o.objectStore(Zn);for(const s of e)r.put(s);return new Promise((s,i)=>{o.oncomplete=()=>s(),o.onerror=()=>i(o.error)})}function aI(t){try{const e=h.getProject();if(!e)throw new Error("Project not found.");const n=t?.sessionId||e.activeSessionId;if(!n)throw new Error("No session is active or selected for download.");console.log(`Attempting to download session with ID: ${n}`);const o=e.chatSessions.find(d=>d.id===n);if(!o)throw new Error(`Session with ID ${n} could not be found.`);let r=`Chat Session: ${o.name||"Untitled Session"}
`;r+=`Exported on: ${new Date().toLocaleString()}
`,o.linkedEntity&&(r+=`Associated Entity: ${o.linkedEntity.name} (${o.linkedEntity.type})
`),r+=`============================================

`;const s=o.history||[];s.length===0?r+="[This session has no messages.]":s.forEach(d=>{const u=d.timestamp?Zy(d.timestamp):"No Timestamp",f=(d.speaker||d.role||"unknown").toUpperCase(),p=Array.isArray(d.content)?d.content.find(m=>m.type==="text")?.text||"[multimodal content]":d.content;r+=`[${u}] ${f}:
${p}

--------------------------------

`}),console.log(`Final text content length: ${r.length}`);const i=new Blob([r],{type:"text/plain;charset=utf-8"}),a=URL.createObjectURL(i),l=document.createElement("a"),c=(o.name||"untitled").replace(/[^a-z0-9]/gi,"_").toLowerCase();l.download=`session-export-${c}.txt`,l.href=a,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),URL.revokeObjectURL(a),console.log("Download initiated and cleanup complete.")},100)}catch(e){console.error("Download Chat Session failed:",e),k(`Failed to download chat: ${e.message}`,"Error")}}function lI({height:t}){const e=h.getProject(),n=e?.chatSessions.find(r=>r.id===e.activeSessionId),o=Number(t);n&&Number.isFinite(o)&&o>0&&(n.composerHeight=Math.round(o),h.setProject(e),h.updateAndPersistState())}async function cI(){const t=h.getProject(),e=t?.chatSessions.find(n=>n.id===t.activeSessionId);if(!e){console.warn("[AutoSave] Could not find active session to save.");return}try{await To(Zn,"readwrite","put",e)}catch(n){console.error(`[AutoSave] Failed to save active session (${e.id}):`,n)}}function dI({sessionId:t,newName:e}){const n=h.getProject();if(!n)return;const o=n.chatSessions.find(r=>r.id===t);if(o){if(!dm(o)){n.activeSessionId===t&&h.bus.publish("ui:updateChatTitle",{title:ka(o,{includeAct:!0})}),h.bus.publish("session:listChanged");return}o.name==="New Chat"&&(o.name=e,o.updatedAt=Date.now(),h.updateAndPersistState(),h.bus.publish("session:listChanged"),n.activeSessionId===t&&h.bus.publish("ui:updateChatTitle",{title:e}))}}const sf=1e4;let Vr=null,bs=null;function Fa(){Vr&&(clearTimeout(Vr),Vr=null),bs=null}function af(t,e){return!!(t&&e&&t.type===e.type&&t.name===e.name)}function uI(t){Fa(),bs=Date.now()+sf,h.setStagedEntity(t),Vr=setTimeout(()=>{Vr=null,bs=null,h.setStagedEntity(null)},sf)}function pI(){return bs?Math.max(0,Math.ceil((bs-Date.now())/1e3)):0}async function fI(){const t=h.getProject();if(!t||!t.id)return console.warn("[AutoSave] Aborted: Project not available for saving."),!1;console.log("[AutoSave] Persisting essential data to IndexedDB...");try{return await za(),await cI(),console.log("[AutoSave] Essential project state successfully persisted."),!0}catch(e){return console.error("[AutoSave] Failed to persist project state:",e),!1}}function mI(){let t;h.bus.subscribe("autosave:required",()=>{clearTimeout(t),t=setTimeout(async()=>{h.isAutoSaveDirty()&&await fI()&&h.setAutoSaveDirty(!1)},2e3)})}function hI(){h.isUserDirty()?(h.setState("pendingActionAfterSave",()=>{document.getElementById("load-project-input").click()}),ym()):document.getElementById("load-project-input").click()}async function Ac(){console.log("Proceeding with creating a new project...");try{const t=localStorage.getItem("lastActiveProjectId");t&&(await ow(t),localStorage.removeItem("lastActiveProjectId"));const e=await fetch("/PromptPrim/default-project.prim");if(!e.ok)throw new Error(`Could not fetch default project file. Status: ${e.status}`);const n=await e.json(),o=rw();o&&o.systemAgentDefaults&&(n.globalSettings.systemUtilityAgent=o.systemAgentDefaults.utilityAgent,n.globalSettings.summarizationPromptPresets=o.systemAgentDefaults.summarizationPresets),n.globalSettings.summarizationPromptPresets={...Ft},n.id=`proj_${Date.now()}`,await ud(n.id),await Wa(n,!0)}catch(t){console.error("Failed to proceed with creating a new project:",t),k("Could not create a new project. Please check the browser console for more details.","Error")}}function Nc(){h.isUserDirty()?(h.setState("pendingActionAfterSave",Ac),ym()):Ac()}function gI(t){const e=t.target.files[0];if(!e)return;console.log(`[OpenProject] File selected: ${e.name}. Reading file...`);const n=new FileReader;n.onload=async o=>{try{const r=o.target.result;console.log("[OpenProject] File read complete. Parsing JSON...");const s=JSON.parse(r);if(!s.id||!s.name)throw new Error("Invalid project file format.");console.log(`[OpenProject] JSON parsed successfully for project: ${s.name}. Loading data...`),await Wa(s,!0)}catch(r){console.error("[OpenProject] Failed to load project:",r),k(`Error loading project: ${r.message}`,"Error")}},n.onerror=()=>{console.error("[OpenProject] FileReader error."),k("Failed to read the selected file.","Error")},n.readAsText(e),t.target.value=""}function bI(){try{const t=h.getState().pendingFileToOpen;if(!t)return;vI(t),h.setState("pendingFileToOpen",null)}catch(t){console.error("Failed to proceed with opening project:",t),k("Could not open the project file.","Error")}}async function rb(t=!1){const e=h.getProject();t||e.name==="Untitled Project"?h.bus.publish("ui:showSaveAsModal"):await sb(e.name)}async function sb(t){const e=t?.trim();if(!e)return k("Please enter a project name."),!1;const n=h.getProject();n.name=e,h.bus.publish("project:nameChanged",e),h.setUserDirty(!1);const o=JSON.parse(JSON.stringify(h.getProject())),r=ib(o);try{const s=JSON.stringify(r,null,2),i=new Blob([s],{type:"application/json"}),a=URL.createObjectURL(i),l=document.createElement("a");return l.download=`${e.replace(/[^a-z0-9\u0E00-\u0E7F]/gi,"_").toLowerCase()}.prim`,l.href=a,document.body.appendChild(l),l.click(),URL.revokeObjectURL(a),document.body.removeChild(l),h.bus.publish("ui:hideSaveAsModal"),h.setAutoSaveDirty(!1),await xI(),h.getState().pendingActionAfterSave&&await wI(),!0}catch(s){return console.error("Failed to save project:",s),k("Failed to save project file.","Error"),h.setUserDirty(!0),!1}}async function yI(t){nw();const e=h.getState().pendingActionAfterSave;switch(h.setState("pendingActionAfterSave",null),t){case"save":await rb(!1);break;case"discard":typeof e=="function"&&await e();break}}async function wI(){const t=h.getState().pendingActionAfterSave;h.setState("pendingActionAfterSave",null),t==="open"?await bI():t==="new"&&await Ac()}async function vI(t){const e=new FileReader;e.onload=async n=>{try{const o=JSON.parse(n.target.result);if(o&&o.id&&o.name&&o.agentPresets)await Wa(o,!0),k(`Project '${o.name}' loaded successfully!`,"Project Loaded");else throw new Error("Invalid project file format.")}catch(o){k(`Error loading project: ${o.message}`,"Error"),console.error(o)}},e.readAsText(t)}async function SI(t){if(!t)throw new Error("Cannot load last project: Project ID is missing.");await ud(t);const e=await To(pd,"readonly","get",vm);if(e&&e.data&&e.data.id===t){const n=e.data,o=await To(Zn,"readonly","getAll"),r={...n,chatSessions:o||[]};await Wa(r,!1),console.log("Successfully loaded the last active project from IndexedDB.")}else throw new Error("Project data in DB is invalid or mismatched with last known ID.")}async function Wa(t,e=!1){let n=ib(t);await ud(n.id),e&&(n.isDirtyForUser=!1),n.globalSettings&&(n.globalSettings.summarizationPromptPresets={...Ft,...n.globalSettings.summarizationPromptPresets||{}}),h.setProject(n),await CI(),n.globalSettings.apiKey&&await is({apiKey:n.globalSettings.apiKey}),n=h.getProject(),(n.chatSessions||[]).filter(i=>!i.archived).length===0&&hr();const r=h.getProject();r.isDirtyForUser=!1,await kI(r);const s=r.chatSessions.find(i=>i.id===r.activeSessionId)||[...r.chatSessions].filter(i=>!i.archived).sort((i,a)=>a.updatedAt-i.updatedAt)[0];s&&_t(s.id),h.bus.publish("project:loaded",{projectData:r}),h.bus.publish("userDirty:changed",!1),h.setAutoSaveDirty(!1),localStorage.setItem("lastActiveProjectId",r.id)}async function kI(t){await sw([Zn,pd]),await za(t),await ob(t.chatSessions),console.log("Database has been rewritten with new project data.")}async function za(t){const e=t||h.getProject();if(!e||!e.id){console.warn("Cannot persist metadata: project or project ID is missing.");return}const n={...e};delete n.chatSessions,await To(pd,"readwrite","put",{id:vm,data:n})}async function xI(){const t=h.getProject();if(!t||!t.id)return!1;console.log("[AutoSave] Persisting project to IndexedDB...");try{return await za(),await ob(),console.log("[AutoSave] Project state successfully persisted."),!0}catch(e){return console.error("[AutoSave] Failed to persist project state:",e),!1}}async function CI(){const t=h.getProject();!t||!t.globalSettings||(h.bus.publish("ui:applyFontSettings"),console.log("Global settings loaded into state."))}function EI(t){const e=h.getProject();e.globalSettings.fontFamilySelect=t,h.setProject(e),h.updateAndPersistState(),h.bus.publish("ui:applyFontSettings")}function II(){const t=h.getProject();if(!t.globalSettings)return;const e=t.globalSettings.systemUtilityAgent;e.model=document.getElementById("system-utility-model-select").value,e.systemPrompt=document.getElementById("system-utility-prompt").value;const n=h.getState().systemParameterEditor,o=n?n.getValues():{};Object.assign(e,o),h.setProject(t),h.updateAndPersistState(),k("System Agent settings saved!","Success")}function ib(t){const n=wt()?.userName||"Unknown User";if(t.globalSettings.systemUtilityAgent=Object.assign({},$r,t.globalSettings.systemUtilityAgent),t.agentPresets)for(const i in t.agentPresets){const a=t.agentPresets[i],l=Object.assign({},xa,a);(!l.createdBy||l.createdBy==="Unknown User")&&(l.createdBy=n),l.createdAt||(l.createdAt=Date.now()),l.modifiedAt||(l.modifiedAt=l.createdAt),t.agentPresets[i]=l}if(t.isDirtyForUser===void 0&&(t.isDirtyForUser=!0),t.agentGroups)for(const i in t.agentGroups){const a=t.agentGroups[i];a&&!Array.isArray(a.agents)&&(a.agents=[])}if(Ca(t),wm(t),io(t),Array.isArray(t.chatSessions)){const i=Object.keys(t.agentPresets||{})[0]||null,a=Object.keys(t.agentGroups||{})[0]||null,l=new Set((t.books||[]).map(p=>p.id)),c=p=>p?.type==="agent"&&p?.name&&t.agentPresets?.[p.name]?{type:"agent",name:p.name}:p?.type==="group"&&p?.name&&t.agentGroups?.[p.name]?{type:"group",name:p.name}:i?{type:"agent",name:i}:a?{type:"group",name:a}:null,d=p=>p==="composer"?"composer":"chat",u=p=>p==="normal"?"normal":"maximized",f=p=>{const m=Number(p);return Number.isFinite(m)&&m>0?Math.round(m):null};if(t.chatSessions=t.chatSessions.map(p=>{const m=p?.ragSettings||{},b=c(p?.linkedEntity),y=_o(p,{validBookIds:l});return{...p,workspaceView:d(p?.workspaceView),composerViewMode:u(p?.composerViewMode),composerHeight:f(p?.composerHeight),linkedEntity:b,folderId:typeof p?.folderId=="string"&&p.folderId.trim()?p.folderId:null,contextMode:Nn(p?.contextMode),ragSettings:Bt(m),...y}}),t.chatSessions.length>0){const p=t.chatSessions.find(m=>m.id===t.activeSessionId)||t.chatSessions[0];p?.linkedEntity&&(t.activeEntity={...p.linkedEntity})}}ie(t),Array.isArray(t.knowledgeFiles)?t.knowledgeFiles=t.knowledgeFiles.map(i=>({id:i.id||`kf_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,name:i.name||"Untitled",type:i.type||"application/octet-stream",size:Number.isFinite(i.size)?i.size:0,uploadedAt:i.uploadedAt||Date.now(),source:i.source||"upload",status:i.status||"uploaded",textContent:typeof i.textContent=="string"?i.textContent:"",excerpt:typeof i.excerpt=="string"?i.excerpt:"",note:typeof i.note=="string"?i.note:"",lastModified:Number.isFinite(i.lastModified)?i.lastModified:0,chunkCount:Number.isFinite(i.chunkCount)?i.chunkCount:0,indexedAt:Number.isFinite(i.indexedAt)?i.indexedAt:null,embeddingModel:typeof i.embeddingModel=="string"?i.embeddingModel:""})):t.knowledgeFiles=[];const o=new Set(t.knowledgeFiles.map(i=>i.id));Array.isArray(t.chatSessions)&&(t.chatSessions=t.chatSessions.map(i=>({...i,ragSettings:{...i.ragSettings,selectedFileIds:(i.ragSettings?.selectedFileIds||[]).filter(a=>o.has(a))}}))),Array.isArray(t.chatFolders)&&(t.chatFolders=t.chatFolders.map(i=>({...i,ragSettings:{...i.ragSettings,selectedFileIds:(i.ragSettings?.selectedFileIds||[]).filter(a=>o.has(a))}})));const r={version:1,embeddingModel:"local-hash-v1",dimensions:128,updatedAt:Date.now(),chunks:[]};if(!t.knowledgeIndex||typeof t.knowledgeIndex!="object")t.knowledgeIndex={...r};else{const i=t.knowledgeIndex;t.knowledgeIndex={version:Number.isFinite(i.version)?i.version:r.version,embeddingModel:i.embeddingModel||r.embeddingModel,dimensions:Number.isFinite(i.dimensions)?i.dimensions:r.dimensions,updatedAt:Number.isFinite(i.updatedAt)?i.updatedAt:r.updatedAt,chunks:Array.isArray(i.chunks)?i.chunks.map((a,l)=>({id:a.id||`kc_${Date.now()}_${l}`,fileId:a.fileId||"",fileName:a.fileName||"Unknown",chunkIndex:Number.isFinite(a.chunkIndex)?a.chunkIndex:l,text:typeof a.text=="string"?a.text:"",charCount:Number.isFinite(a.charCount)?a.charCount:0,tokenEstimate:Number.isFinite(a.tokenEstimate)?a.tokenEstimate:0,vector:Array.isArray(a.vector)?a.vector:[],embeddingModel:a.embeddingModel||i.embeddingModel||r.embeddingModel,createdAt:Number.isFinite(a.createdAt)?a.createdAt:Date.now()})):[]}}const s=new Map;for(const i of t.knowledgeIndex.chunks)i.fileId&&s.set(i.fileId,(s.get(i.fileId)||0)+1);return t.knowledgeFiles=t.knowledgeFiles.map(i=>{const a=s.get(i.id)||0,l=i.status||"uploaded",c=l==="ready"?"indexed":l==="error"?"failed":l;return{...i,chunkCount:Number.isFinite(i.chunkCount)&&i.chunkCount>0?i.chunkCount:a,status:a>0&&!["failed","binary"].includes(c)?"indexed":c}}),t}async function AI(t,e){Fa(),h.setStagedEntity(null,!1);const n=h.getProject(),o=t==="agent"&&(e==="Media Studio"||e==="Visual Studio"||e.includes("KieAI")||e.includes("Veo")||e.includes("Flux")||e.includes("Wan")||e.includes("Seedance")),r=t==="agent"&&!!n.agentPresets?.[e]||t==="group"&&!!n.agentGroups?.[e];n.activeEntity={type:t,name:e};const s=n.chatSessions.find(i=>i.id===n.activeSessionId);s&&r&&(s.groupChatState&&(s.groupChatState.isRunning=!1),s.linkedEntity={...n.activeEntity},s.updatedAt=Date.now()),h.setProject(n),h.updateAndPersistState(),h.bus.publish("entity:selected",{type:t,name:e,isKieAI:o}),h.bus.publish("session:listChanged")}function ab(){const t=h.getStagedEntity();t&&(Fa(),h.setStagedEntity(null,!1),h.bus.publish("entity:select",t))}function Mc(){Fa(),h.setStagedEntity(null)}function NI({type:t,name:e}){const n={type:t,name:e},o=h.getStagedEntity(),r=h.getProject().activeEntity;if(af(r,n)){Mc();return}if(af(o,n)){ab();return}uI(n)}async function MI(){const t=document.getElementById("enhancer-prompt-input").value.trim();if(!t){k("Please describe the agent you want to create or enhance.","Error");return}const e=h.getProject().globalSettings.systemUtilityAgent;if(!e||!e.model){k("System Utility Model not configured in Settings.","Error");return}const n=document.getElementById("generate-agent-profile-btn");n&&n.classList.add("is-loading"),h.bus.publish("agent:enhancerStatus",{text:"Processing request...",color:"var(--text-dark)"});try{const o=!!h.getState().editingAgentName;let r="";o?r=`You are an expert in refining LLM system prompts. Your task is to modify an existing system prompt based on a user's new request. Do not replace the original prompt, but integrate the new instruction into it cohesively. Respond ONLY with the new, complete, and modified system prompt as a single block of text.

            EXISTING PROMPT:
            ---
            ${document.getElementById("agent-system-prompt").value}
            ---

            USER'S MODIFICATION REQUEST:
            ---
            ${t}
            ---

            NEW, MODIFIED SYSTEM PROMPT:`:r=`You are an expert in designing LLM agent profiles. Based on the user's request, create a complete agent profile.
            Your response MUST be ONLY a single, valid JSON object with these exact keys:
            - "agent_name": string
            - "agent_icon": string (a single emoji)
            - "system_prompt": string
            - "temperature": number (between 0 and 2)
            - "top_p": number (between 0 and 1)
            - "top_k": integer (0 or higher)
            - "max_tokens": integer (e.g., 4096)
            - "frequency_penalty": number (between -2 and 2)
            - "presence_penalty": number (between -2 and 2)
            - "seed": integer (-1 for random)

            User's Request: "${t}"`;const s=await iw(e,[{role:"user",content:r}]);if(!s||typeof s.content!="string")throw new Error("Received an invalid or empty response from the AI.");if(o)h.bus.publish("agent:promptEnhanced",{newPrompt:s.content}),h.bus.publish("agent:enhancerStatus",{text:"Prompt enhanced successfully!",color:"var(--success-color)"});else{const i=s.content.match(/{.*}/s);if(!i)throw new Error("LLM did not return a valid JSON object.");const a=JSON.parse(i[0]);h.bus.publish("agent:profileGenerated",a),h.bus.publish("agent:enhancerStatus",{text:"Profile generated successfully!",color:"var(--success-color)"})}}catch(o){console.error("Agent Profile Generation/Enhancement Error:",o);const r=`Error: ${o.message}`;h.bus.publish("agent:enhancerStatus",{text:r,color:"var(--error-color)"}),k(r,"Profile Generation Failed")}finally{n&&n.classList.remove("is-loading"),setTimeout(()=>h.bus.publish("agent:enhancerStatus",{text:""}),5e3)}}function TI(){const t=h.getProject(),e=h.getState().editingAgentName,n=document.getElementById("agent-name-input").value.trim();if(!n){k("Please enter a name for the agent.","Error");return}if(e!==n&&t.agentPresets[n]){k(`An agent named '${n}' already exists.`,"Error");return}if(!document.getElementById("agent-model-select").value){k("You must select a model for the agent before saving.","Model Required");const c=document.getElementById("agent-model-search-wrapper");c&&(c.classList.add("has-warning"),setTimeout(()=>c.classList.remove("has-warning"),2e3));return}const r={icon:document.getElementById("agent-icon-button").textContent,description:document.getElementById("agent-description").value,model:document.getElementById("agent-model-select").value,systemPrompt:document.getElementById("agent-system-prompt").value,useMarkdown:document.getElementById("agent-use-markdown").checked,enableWebSearch:document.getElementById("agent-enable-web-search").checked,profilePicture:document.getElementById("agent-profile-picture-preview").src,tags:Array.from(document.querySelectorAll("#agent-tags-container .tag-pill")).map(c=>c.dataset.tag),activeMemories:Array.from(document.querySelectorAll("#agent-memory-list .item input:checked")).map(c=>c.closest(".item").dataset.memoryName)},s=h.getState().activeParameterEditor,i=s?s.getValues():{},a={...r,...i},l=e&&t.agentPresets[e]?{...t.agentPresets[e]}:{...xa,id:`agent_${Date.now()}`,createdBy:UserService.getCurrentUserProfile().userName,createdAt:Date.now()};l.modifiedAt=Date.now(),l.createdBy=document.getElementById("agent-created-by-input").value,Object.assign(l,a),e&&e!==n&&delete t.agentPresets[e],t.agentPresets[n]=l,(!e||t.activeEntity&&t.activeEntity.name===e)&&(t.activeEntity={type:"agent",name:n}),h.setProject(t),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"),h.bus.publish("agent:editorShouldClose")}function PI(t){const e=h.getProject();if(!t||Object.keys(e.agentPresets).length<=1){k("Cannot delete the last agent.","Error");return}confirm(`Are you sure you want to delete the agent '${t}'? This action cannot be undone.`)&&(delete e.agentPresets[t],Object.values(e.agentGroups).forEach(n=>{n.agents=n.agents.filter(o=>o!==t),n.moderatorAgent===t&&(n.moderatorAgent=n.agents[0]||"")}),e.chatSessions.forEach(n=>{n.linkedEntity?.type==="agent"&&n.linkedEntity.name===t&&(n.linkedEntity={type:"agent",name:Object.keys(e.agentPresets)[0]})}),e.activeEntity.type==="agent"&&e.activeEntity.name===t&&(e.activeEntity={type:"agent",name:Object.keys(e.agentPresets)[0]}),h.setProject(e),h.updateAndPersistState(),h.bus.publish("agent:listChanged"),h.bus.publish("entity:selected",e.activeEntity))}function BI(t,e){const o=`${String(e||"").trim()||"Agent"} Copy`;if(!t.agentPresets?.[o])return o;let r=2,s=`${o} ${r}`;for(;t.agentPresets?.[s];)r+=1,s=`${o} ${r}`;return s}function OI(t){const e=h.getProject();if(!e||!t)return;const n=e.agentPresets?.[t];if(!n){k(`Agent "${t}" was not found.`,"Duplicate Agent");return}const o=BI(e,t),r=Date.now(),s=JSON.parse(JSON.stringify(n));s.id=`agent_${r}`,s.createdAt=r,s.modifiedAt=r,s.type=s.type||"custom",e.agentPresets[o]=s,h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"),k(`Created "${o}" from "${t}".`,"Agent Duplicated")}async function LI(t){const e=h.getProject();e&&(e.globalSettings||(e.globalSettings={}),e.globalSettings.inlineAgentConfig=t,await za(e),h.updateAndPersistState(),k("Inline Agent configuration saved!","Success"),console.log("Saved Inline Agent Config:",t))}const dn=({label:t,placeholder:e,value:n,onChange:o})=>g.jsxs("div",{children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-400 tw-mb-2",children:t}),g.jsx("textarea",{rows:"3",placeholder:e||`Enter prompt for ${t}...`,className:"tw-w-full tw-bg-gray-100 dark:tw-bg-slate-700 tw-border tw-border-gray-300 dark:tw-border-slate-600 tw-rounded-md tw-p-2 tw-text-gray-800 dark:tw-text-gray-200 placeholder-gray-400 focus:tw-ring-blue-500 focus:tw-border-blue-500 tw-transition",value:n,onChange:o})]}),lf=({label:t,options:e})=>g.jsxs("div",{className:"tw-text-center",children:[g.jsx("label",{className:"tw-block tw-text-sm tw-font-medium tw-text-gray-400 tw-mb-2",children:t}),g.jsx("select",{className:"tw-bg-gray-200 hover:tw-bg-gray-300 dark:tw-bg-slate-600 dark:hover:tw-bg-slate-500 tw-text-gray-800 dark:tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded-lg tw-border tw-border-gray-300 dark:tw-border-slate-500",children:e.map(n=>g.jsx("option",{value:n,children:n},n))})]});function DI({unmount:t,onSave:e,initialConfig:n={}}){const[o,r]=T.useState({system:n.system||"",continue:n.continue||"",revise:n.revise||"",expand:n.expand||"",shorten:n.shorten||"",rephrase:n.rephrase||"",styleTransfer:n.styleTransfer||"",translateTo:n.translateTo||"",userInstructions:n.userInstructions||""}),s=(a,l)=>{r(c=>({...c,[l]:a.target.value}))},i=()=>{typeof e=="function"&&e(o),t()};return Rm.createPortal(g.jsx("div",{className:"tw-fixed tw-inset-0 tw-z-[10000] tw-flex tw-items-center tw-justify-center tw-bg-gray-800 tw-bg-opacity-50 dark:tw-bg-opacity-70 tw-backdrop-blur-sm tw-p-4",children:g.jsxs("div",{className:"tw-bg-white dark:tw-bg-slate-800 tw-border tw-border-gray-200 dark:tw-border-slate-700 tw-rounded-xl tw-shadow-2xl tw-w-full tw-max-w-4xl tw-text-black dark:tw-text-white tw-flex tw-flex-col tw-max-h-[90vh]",children:[g.jsxs("div",{className:"tw-flex-shrink-0 tw-flex tw-items-center tw-justify-between tw-p-4 tw-border-b tw-border-gray-200 dark:tw-border-slate-700",children:[g.jsxs("h3",{className:"tw-text-lg tw-font-semibold tw-flex tw-items-center tw-gap-3",children:[g.jsx("span",{className:"material-symbols-outlined tw-text-blue-500 dark:tw-text-cyan-400",children:"smart_toy"}),"Configure Inline Agent"]}),g.jsx("button",{className:"tw-text-gray-400 hover:tw-text-gray-700 dark:hover:tw-text-white tw-transition-colors",onClick:t,children:"Ã—"})]}),g.jsxs("div",{className:"tw-flex-grow tw-p-6 tw-overflow-y-auto",children:[g.jsxs("div",{className:"tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-6",children:[g.jsxs("div",{className:"tw-flex tw-flex-col tw-gap-4",children:[g.jsx(dn,{label:"System Prompt",value:o.system,onChange:a=>s(a,"system")}),g.jsx(dn,{label:"Continue Prompt",value:o.continue,onChange:a=>s(a,"continue")}),g.jsx(dn,{label:"Revise Prompt",value:o.revise,onChange:a=>s(a,"revise")}),g.jsx(dn,{label:"Expand",value:o.expand,onChange:a=>s(a,"expand")}),g.jsx(dn,{label:"Shorten",value:o.shorten,onChange:a=>s(a,"shorten")})]}),g.jsxs("div",{className:"tw-flex tw-flex-col tw-gap-4",children:[g.jsx(dn,{label:"Rephrase",value:o.rephrase,onChange:a=>s(a,"rephrase")}),g.jsx(dn,{label:"Style Transfer",value:o.styleTransfer,onChange:a=>s(a,"styleTransfer")}),g.jsx(dn,{label:"Translate to",value:o.translateTo,onChange:a=>s(a,"translateTo")}),g.jsx(dn,{label:"User Instructions",placeholder:"Prefix instructions...",value:o.userInstructions,onChange:a=>s(a,"userInstructions")})]})]}),g.jsxs("div",{className:"tw-mt-6 tw-pt-5 tw-border-t tw-border-gray-200 dark:tw-border-slate-700 tw-flex tw-justify-center tw-gap-10 tw-items-center",children:[g.jsx(lf,{label:"Hotkey for LLM Request",options:["\\","/","|","F1"]}),g.jsx(lf,{label:"Hotkey for Confirm LLM",options:["=","END","INSERT",";"]}),"          "]})]}),g.jsxs("div",{className:"tw-flex-shrink-0 tw-flex tw-justify-end tw-gap-4 tw-p-4 tw-bg-gray-50 dark:tw-bg-slate-900/50 tw-rounded-b-xl tw-border-t tw-border-gray-200 dark:tw-border-slate-700",children:[g.jsx("button",{className:"tw-bg-white hover:tw-bg-gray-100 tw-text-gray-700 dark:tw-bg-slate-600 dark:hover:tw-bg-slate-500 dark:tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded-lg tw-border tw-border-gray-300 dark:tw-border-slate-500 tw-transition-colors",onClick:t,children:"Cancel"}),g.jsx("button",{className:"tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded-lg tw-transition-colors",onClick:i,children:"Save Configuration"})]})]})}),document.body)}var Li=(t,e)=>{if(t==="slot")return 0;if(t instanceof Function)return t(e);const{children:n,...o}=e??{};if(t==="svg")throw new Error("SVG elements are not supported in the JSX syntax, use the array syntax instead");return[t,o,n]},RI=/^\s*>\s$/,jI=lt.create({name:"blockquote",addOptions(){return{HTMLAttributes:{}}},content:"block+",group:"block",defining:!0,parseHTML(){return[{tag:"blockquote"}]},renderHTML({HTMLAttributes:t}){return Li("blockquote",{...Ee(this.options.HTMLAttributes,t),children:Li("slot",{})})},addCommands(){return{setBlockquote:()=>({commands:t})=>t.wrapIn(this.name),toggleBlockquote:()=>({commands:t})=>t.toggleWrap(this.name),unsetBlockquote:()=>({commands:t})=>t.lift(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-b":()=>this.editor.commands.toggleBlockquote()}},addInputRules(){return[mr({find:RI,type:this.type})]}}),_I=/(?:^|\s)(\*\*(?!\s+\*\*)((?:[^*]+))\*\*(?!\s+\*\*))$/,$I=/(?:^|\s)(\*\*(?!\s+\*\*)((?:[^*]+))\*\*(?!\s+\*\*))/g,FI=/(?:^|\s)(__(?!\s+__)((?:[^_]+))__(?!\s+__))$/,WI=/(?:^|\s)(__(?!\s+__)((?:[^_]+))__(?!\s+__))/g,zI=nn.create({name:"bold",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"strong"},{tag:"b",getAttrs:t=>t.style.fontWeight!=="normal"&&null},{style:"font-weight=400",clearMark:t=>t.type.name===this.name},{style:"font-weight",getAttrs:t=>/^(bold(er)?|[5-9]\d{2,})$/.test(t)&&null}]},renderHTML({HTMLAttributes:t}){return Li("strong",{...Ee(this.options.HTMLAttributes,t),children:Li("slot",{})})},addCommands(){return{setBold:()=>({commands:t})=>t.setMark(this.name),toggleBold:()=>({commands:t})=>t.toggleMark(this.name),unsetBold:()=>({commands:t})=>t.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-b":()=>this.editor.commands.toggleBold(),"Mod-B":()=>this.editor.commands.toggleBold()}},addInputRules(){return[Do({find:_I,type:this.type}),Do({find:FI,type:this.type})]},addPasteRules(){return[oo({find:$I,type:this.type}),oo({find:WI,type:this.type})]}}),HI=/(^|[^`])`([^`]+)`(?!`)/,UI=/(^|[^`])`([^`]+)`(?!`)/g,VI=nn.create({name:"code",addOptions(){return{HTMLAttributes:{}}},excludes:"_",code:!0,exitable:!0,parseHTML(){return[{tag:"code"}]},renderHTML({HTMLAttributes:t}){return["code",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{setCode:()=>({commands:t})=>t.setMark(this.name),toggleCode:()=>({commands:t})=>t.toggleMark(this.name),unsetCode:()=>({commands:t})=>t.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-e":()=>this.editor.commands.toggleCode()}},addInputRules(){return[Do({find:HI,type:this.type})]},addPasteRules(){return[oo({find:UI,type:this.type})]}}),qI=/^```([a-z]+)?[\s\n]$/,KI=/^~~~([a-z]+)?[\s\n]$/,GI=lt.create({name:"codeBlock",addOptions(){return{languageClassPrefix:"language-",exitOnTripleEnter:!0,exitOnArrowDown:!0,defaultLanguage:null,HTMLAttributes:{}}},content:"text*",marks:"",group:"block",code:!0,defining:!0,addAttributes(){return{language:{default:this.options.defaultLanguage,parseHTML:t=>{var e;const{languageClassPrefix:n}=this.options,s=[...((e=t.firstElementChild)==null?void 0:e.classList)||[]].filter(i=>i.startsWith(n)).map(i=>i.replace(n,""))[0];return s||null},rendered:!1}}},parseHTML(){return[{tag:"pre",preserveWhitespace:"full"}]},renderHTML({node:t,HTMLAttributes:e}){return["pre",Ee(this.options.HTMLAttributes,e),["code",{class:t.attrs.language?this.options.languageClassPrefix+t.attrs.language:null},0]]},addCommands(){return{setCodeBlock:t=>({commands:e})=>e.setNode(this.name,t),toggleCodeBlock:t=>({commands:e})=>e.toggleNode(this.name,"paragraph",t)}},addKeyboardShortcuts(){return{"Mod-Alt-c":()=>this.editor.commands.toggleCodeBlock(),Backspace:()=>{const{empty:t,$anchor:e}=this.editor.state.selection,n=e.pos===1;return!t||e.parent.type.name!==this.name?!1:n||!e.parent.textContent.length?this.editor.commands.clearNodes():!1},Enter:({editor:t})=>{if(!this.options.exitOnTripleEnter)return!1;const{state:e}=t,{selection:n}=e,{$from:o,empty:r}=n;if(!r||o.parent.type!==this.type)return!1;const s=o.parentOffset===o.parent.nodeSize-2,i=o.parent.textContent.endsWith(`

`);return!s||!i?!1:t.chain().command(({tr:a})=>(a.delete(o.pos-2,o.pos),!0)).exitCode().run()},ArrowDown:({editor:t})=>{if(!this.options.exitOnArrowDown)return!1;const{state:e}=t,{selection:n,doc:o}=e,{$from:r,empty:s}=n;if(!s||r.parent.type!==this.type||!(r.parentOffset===r.parent.nodeSize-2))return!1;const a=r.after();return a===void 0?!1:o.nodeAt(a)?t.commands.command(({tr:c})=>(c.setSelection(ne.near(o.resolve(a))),!0)):t.commands.exitCode()}}},addInputRules(){return[Sc({find:qI,type:this.type,getAttributes:t=>({language:t[1]})}),Sc({find:KI,type:this.type,getAttributes:t=>({language:t[1]})})]},addProseMirrorPlugins(){return[new Me({key:new Fe("codeBlockVSCodeHandler"),props:{handlePaste:(t,e)=>{if(!e.clipboardData||this.editor.isActive(this.type.name))return!1;const n=e.clipboardData.getData("text/plain"),o=e.clipboardData.getData("vscode-editor-data"),r=o?JSON.parse(o):void 0,s=r?.mode;if(!n||!s)return!1;const{tr:i,schema:a}=t.state,l=a.text(n.replace(/\r\n?/g,`
`));return i.replaceSelectionWith(this.type.create({language:s},l)),i.selection.$from.parent.type!==this.type&&i.setSelection(Z.near(i.doc.resolve(Math.max(0,i.selection.from-2)))),i.setMeta("paste",!0),t.dispatch(i),!0}}})]}}),JI=lt.create({name:"doc",topNode:!0,content:"block+"}),YI=lt.create({name:"hardBreak",addOptions(){return{keepMarks:!0,HTMLAttributes:{}}},inline:!0,group:"inline",selectable:!1,linebreakReplacement:!0,parseHTML(){return[{tag:"br"}]},renderHTML({HTMLAttributes:t}){return["br",Ee(this.options.HTMLAttributes,t)]},renderText(){return`
`},addCommands(){return{setHardBreak:()=>({commands:t,chain:e,state:n,editor:o})=>t.first([()=>t.exitCode(),()=>t.command(()=>{const{selection:r,storedMarks:s}=n;if(r.$from.parent.type.spec.isolating)return!1;const{keepMarks:i}=this.options,{splittableMarks:a}=o.extensionManager,l=s||r.$to.parentOffset&&r.$from.marks();return e().insertContent({type:this.name}).command(({tr:c,dispatch:d})=>{if(d&&l&&i){const u=l.filter(f=>a.includes(f.type.name));c.ensureMarks(u)}return!0}).run()})])}},addKeyboardShortcuts(){return{"Mod-Enter":()=>this.editor.commands.setHardBreak(),"Shift-Enter":()=>this.editor.commands.setHardBreak()}}}),XI=lt.create({name:"heading",addOptions(){return{levels:[1,2,3,4,5,6],HTMLAttributes:{}}},content:"inline*",group:"block",defining:!0,addAttributes(){return{level:{default:1,rendered:!1}}},parseHTML(){return this.options.levels.map(t=>({tag:`h${t}`,attrs:{level:t}}))},renderHTML({node:t,HTMLAttributes:e}){return[`h${this.options.levels.includes(t.attrs.level)?t.attrs.level:this.options.levels[0]}`,Ee(this.options.HTMLAttributes,e),0]},addCommands(){return{setHeading:t=>({commands:e})=>this.options.levels.includes(t.level)?e.setNode(this.name,t):!1,toggleHeading:t=>({commands:e})=>this.options.levels.includes(t.level)?e.toggleNode(this.name,"paragraph",t):!1}},addKeyboardShortcuts(){return this.options.levels.reduce((t,e)=>({...t,[`Mod-Alt-${e}`]:()=>this.editor.commands.toggleHeading({level:e})}),{})},addInputRules(){return this.options.levels.map(t=>Sc({find:new RegExp(`^(#{${Math.min(...this.options.levels)},${t}})\\s$`),type:this.type,getAttributes:{level:t}}))}}),QI=lt.create({name:"horizontalRule",addOptions(){return{HTMLAttributes:{}}},group:"block",parseHTML(){return[{tag:"hr"}]},renderHTML({HTMLAttributes:t}){return["hr",Ee(this.options.HTMLAttributes,t)]},addCommands(){return{setHorizontalRule:()=>({chain:t,state:e})=>{if(!_0(e,e.schema.nodes[this.name]))return!1;const{selection:n}=e,{$to:o}=n,r=t();return Cg(n)?r.insertContentAt(o.pos,{type:this.name}):r.insertContent({type:this.name}),r.command(({tr:s,dispatch:i})=>{var a;if(i){const{$to:l}=s.selection,c=l.end();if(l.nodeAfter)l.nodeAfter.isTextblock?s.setSelection(Z.create(s.doc,l.pos+1)):l.nodeAfter.isBlock?s.setSelection(U.create(s.doc,l.pos)):s.setSelection(Z.create(s.doc,l.pos));else{const d=(a=l.parent.type.contentMatch.defaultType)==null?void 0:a.create();d&&(s.insert(c,d),s.setSelection(Z.create(s.doc,c+1)))}s.scrollIntoView()}return!0}).run()}}},addInputRules(){return[j0({find:/^(?:---|â€”-|___\s|\*\*\*\s)$/,type:this.type})]}}),ZI=/(?:^|\s)(\*(?!\s+\*)((?:[^*]+))\*(?!\s+\*))$/,eA=/(?:^|\s)(\*(?!\s+\*)((?:[^*]+))\*(?!\s+\*))/g,tA=/(?:^|\s)(_(?!\s+_)((?:[^_]+))_(?!\s+_))$/,nA=/(?:^|\s)(_(?!\s+_)((?:[^_]+))_(?!\s+_))/g,oA=nn.create({name:"italic",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"em"},{tag:"i",getAttrs:t=>t.style.fontStyle!=="normal"&&null},{style:"font-style=normal",clearMark:t=>t.type.name===this.name},{style:"font-style=italic"}]},renderHTML({HTMLAttributes:t}){return["em",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{setItalic:()=>({commands:t})=>t.setMark(this.name),toggleItalic:()=>({commands:t})=>t.toggleMark(this.name),unsetItalic:()=>({commands:t})=>t.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-i":()=>this.editor.commands.toggleItalic(),"Mod-I":()=>this.editor.commands.toggleItalic()}},addInputRules(){return[Do({find:ZI,type:this.type}),Do({find:tA,type:this.type})]},addPasteRules(){return[oo({find:eA,type:this.type}),oo({find:nA,type:this.type})]}});const rA="aaa1rp3bb0ott3vie4c1le2ogado5udhabi7c0ademy5centure6ountant0s9o1tor4d0s1ult4e0g1ro2tna4f0l1rica5g0akhan5ency5i0g1rbus3force5tel5kdn3l0ibaba4pay4lfinanz6state5y2sace3tom5m0azon4ericanexpress7family11x2fam3ica3sterdam8nalytics7droid5quan4z2o0l2partments8p0le4q0uarelle8r0ab1mco4chi3my2pa2t0e3s0da2ia2sociates9t0hleta5torney7u0ction5di0ble3o3spost5thor3o0s4w0s2x0a2z0ure5ba0by2idu3namex4d1k2r0celona5laycard4s5efoot5gains6seball5ketball8uhaus5yern5b0c1t1va3cg1n2d1e0ats2uty4er2rlin4st0buy5t2f1g1h0arti5i0ble3d1ke2ng0o3o1z2j1lack0friday9ockbuster8g1omberg7ue3m0s1w2n0pparibas9o0ats3ehringer8fa2m1nd2o0k0ing5sch2tik2on4t1utique6x2r0adesco6idgestone9oadway5ker3ther5ussels7s1t1uild0ers6siness6y1zz3v1w1y1z0h3ca0b1fe2l0l1vinklein9m0era3p2non3petown5ital0one8r0avan4ds2e0er0s4s2sa1e1h1ino4t0ering5holic7ba1n1re3c1d1enter4o1rn3f0a1d2g1h0anel2nel4rity4se2t2eap3intai5ristmas6ome4urch5i0priani6rcle4sco3tadel4i0c2y3k1l0aims4eaning6ick2nic1que6othing5ud3ub0med6m1n1o0ach3des3ffee4llege4ogne5m0mbank4unity6pany2re3uter5sec4ndos3struction8ulting7tact3ractors9oking4l1p2rsica5untry4pon0s4rses6pa2r0edit0card4union9icket5own3s1uise0s6u0isinella9v1w1x1y0mru3ou3z2dad1nce3ta1e1ing3sun4y2clk3ds2e0al0er2s3gree4livery5l1oitte5ta3mocrat6ntal2ist5si0gn4v2hl2iamonds6et2gital5rect0ory7scount3ver5h2y2j1k1m1np2o0cs1tor4g1mains5t1wnload7rive4tv2ubai3nlop4pont4rban5vag2r2z2earth3t2c0o2deka3u0cation8e1g1mail3erck5nergy4gineer0ing9terprises10pson4quipment8r0icsson6ni3s0q1tate5t1u0rovision8s2vents5xchange6pert3osed4ress5traspace10fage2il1rwinds6th3mily4n0s2rm0ers5shion4t3edex3edback6rrari3ero6i0delity5o2lm2nal1nce1ial7re0stone6mdale6sh0ing5t0ness6j1k1lickr3ghts4r2orist4wers5y2m1o0o0d1tball6rd1ex2sale4um3undation8x2r0ee1senius7l1ogans4ntier7tr2ujitsu5n0d2rniture7tbol5yi3ga0l0lery3o1up4me0s3p1rden4y2b0iz3d0n2e0a1nt0ing5orge5f1g0ee3h1i0ft0s3ves2ing5l0ass3e1obal2o4m0ail3bh2o1x2n1odaddy5ld0point6f2o0dyear5g0le4p1t1v2p1q1r0ainger5phics5tis4een3ipe3ocery4up4s1t1u0cci3ge2ide2tars5ru3w1y2hair2mburg5ngout5us3bo2dfc0bank7ealth0care8lp1sinki6re1mes5iphop4samitsu7tachi5v2k0t2m1n1ockey4ldings5iday5medepot5goods5s0ense7nda3rse3spital5t0ing5t0els3mail5use3w2r1sbc3t1u0ghes5yatt3undai7ibm2cbc2e1u2d1e0ee3fm2kano4l1m0amat4db2mo0bilien9n0c1dustries8finiti5o2g1k1stitute6urance4e4t0ernational10uit4vestments10o1piranga7q1r0ish4s0maili5t0anbul7t0au2v3jaguar4va3cb2e0ep2tzt3welry6io2ll2m0p2nj2o0bs1urg4t1y2p0morgan6rs3uegos4niper7kaufen5ddi3e0rryhotels6properties14fh2g1h1i0a1ds2m1ndle4tchen5wi3m1n1oeln3matsu5sher5p0mg2n2r0d1ed3uokgroup8w1y0oto4z2la0caixa5mborghini8er3nd0rover6xess5salle5t0ino3robe5w0yer5b1c1ds2ease3clerc5frak4gal2o2xus4gbt3i0dl2fe0insurance9style7ghting6ke2lly3mited4o2ncoln4k2ve1ing5k1lc1p2oan0s3cker3us3l1ndon4tte1o3ve3pl0financial11r1s1t0d0a3u0ndbeck6xe1ury5v1y2ma0drid4if1son4keup4n0agement7go3p1rket0ing3s4riott5shalls7ttel5ba2c0kinsey7d1e0d0ia3et2lbourne7me1orial6n0u2rckmsd7g1h1iami3crosoft7l1ni1t2t0subishi9k1l0b1s2m0a2n1o0bi0le4da2e1i1m1nash3ey2ster5rmon3tgage6scow4to0rcycles9v0ie4p1q1r1s0d2t0n1r2u0seum3ic4v1w1x1y1z2na0b1goya4me2vy3ba2c1e0c1t0bank4flix4work5ustar5w0s2xt0direct7us4f0l2g0o2hk2i0co2ke1on3nja3ssan1y5l1o0kia3rton4w0ruz3tv4p1r0a1w2tt2u1yc2z2obi1server7ffice5kinawa6layan0group9lo3m0ega4ne1g1l0ine5oo2pen3racle3nge4g0anic5igins6saka4tsuka4t2vh3pa0ge2nasonic7ris2s1tners4s1y3y2ccw3e0t2f0izer5g1h0armacy6d1ilips5one2to0graphy6s4ysio5ics1tet2ures6d1n0g1k2oneer5zza4k1l0ace2y0station9umbing5s3m1n0c2ohl2ker3litie5rn2st3r0axi3ess3ime3o0d0uctions8f1gressive8mo2perties3y5tection8u0dential9s1t1ub2w0c2y2qa1pon3uebec3st5racing4dio4e0ad1lestate6tor2y4cipes5d0stone5umbrella9hab3ise0n3t2liance6n0t0als5pair3ort3ublican8st0aurant8view0s5xroth6ich0ardli6oh3l1o1p2o0cks3deo3gers4om3s0vp3u0gby3hr2n2w0e2yukyu6sa0arland6fe0ty4kura4le1on3msclub4ung5ndvik0coromant12ofi4p1rl2s1ve2xo3b0i1s2c0b1haeffler7midt4olarships8ol3ule3warz5ience5ot3d1e0arch3t2cure1ity6ek2lect4ner3rvices6ven3w1x0y3fr2g1h0angrila6rp3ell3ia1ksha5oes2p0ping5uji3w3i0lk2na1gles5te3j1k0i0n2y0pe4l0ing4m0art3ile4n0cf3o0ccer3ial4ftbank4ware6hu2lar2utions7ng1y2y2pa0ce3ort2t3r0l2s1t0ada2ples4r1tebank4farm7c0group6ockholm6rage3e3ream4udio2y3yle4u0cks3pplies3y2ort5rf1gery5zuki5v1watch4iss4x1y0dney4stems6z2tab1ipei4lk2obao4rget4tamotors6r2too4x0i3c0i2d0k2eam2ch0nology8l1masek5nnis4va3f1g1h0d1eater2re6iaa2ckets5enda4ps2res2ol4j0maxx4x2k0maxx5l1m0all4n1o0day3kyo3ols3p1ray3shiba5tal3urs3wn2yota3s3r0ade1ing4ining5vel0ers0insurance16ust3v2t1ube2i1nes3shu4v0s2w1z2ua1bank3s2g1k1nicom3versity8o2ol2ps2s1y1z2va0cations7na1guard7c1e0gas3ntures6risign5mÃ¶gensberater2ung14sicherung10t2g1i0ajes4deo3g1king4llas4n1p1rgin4sa1ion4va1o3laanderen9n1odka3lvo3te1ing3o2yage5u2wales2mart4ter4ng0gou5tch0es6eather0channel12bcam3er2site5d0ding5ibo2r3f1hoswho6ien2ki2lliamhill9n0dows4e1ners6me2olterskluwer11odside6rk0s2ld3w2s1tc1f3xbox3erox4ihuan4n2xx2yz3yachts4hoo3maxun5ndex5e1odobashi7ga2kohama6u0tube6t1un3za0ppos4ra3ero3ip2m1one3uerich6w2",sA="ÎµÎ»1Ï…2Ð±Ð³1ÐµÐ»3Ð´ÐµÑ‚Ð¸4ÐµÑŽ2ÐºÐ°Ñ‚Ð¾Ð»Ð¸Ðº6Ð¾Ð¼3Ð¼ÐºÐ´2Ð¾Ð½1ÑÐºÐ²Ð°6Ð¾Ð½Ð»Ð°Ð¹Ð½5Ñ€Ð³3Ñ€ÑƒÑ2Ñ„2ÑÐ°Ð¹Ñ‚3Ñ€Ð±3ÑƒÐºÑ€3Ò›Ð°Ð·3Õ°Õ¡Õµ3×™×©×¨××œ5×§×•×3Ø§Ø¨ÙˆØ¸Ø¨ÙŠ5Ø±Ø§Ù…ÙƒÙˆ5Ù„Ø§Ø±Ø¯Ù†4Ø¨Ø­Ø±ÙŠÙ†5Ø¬Ø²Ø§Ø¦Ø±5Ø³Ø¹ÙˆØ¯ÙŠØ©6Ø¹Ù„ÙŠØ§Ù†5Ù…ØºØ±Ø¨5Ù…Ø§Ø±Ø§Øª5ÛŒØ±Ø§Ù†5Ø¨Ø§Ø±Øª2Ø²Ø§Ø±4ÙŠØªÙƒ3Ú¾Ø§Ø±Øª5ØªÙˆÙ†Ø³4Ø³ÙˆØ¯Ø§Ù†3Ø±ÙŠØ©5Ø´Ø¨ÙƒØ©4Ø¹Ø±Ø§Ù‚2Ø¨2Ù…Ø§Ù†4ÙÙ„Ø³Ø·ÙŠÙ†6Ù‚Ø·Ø±3ÙƒØ§Ø«ÙˆÙ„ÙŠÙƒ6ÙˆÙ…3Ù…ØµØ±2Ù„ÙŠØ³ÙŠØ§5ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§7Ù‚Ø¹4Ù‡Ù…Ø±Ø§Ù‡5Ù¾Ø§Ú©Ø³ØªØ§Ù†7Ú€Ø§Ø±Øª4à¤•à¥‰à¤®3à¤¨à¥‡à¤Ÿ3à¤­à¤¾à¤°à¤¤0à¤®à¥3à¥‹à¤¤5à¤¸à¤‚à¤—à¤ à¤¨5à¦¬à¦¾à¦‚à¦²à¦¾5à¦­à¦¾à¦°à¦¤2à§°à¦¤4à¨­à¨¾à¨°à¨¤4àª­àª¾àª°àª¤4à¬­à¬¾à¬°à¬¤4à®‡à®¨à¯à®¤à®¿à®¯à®¾6à®²à®™à¯à®•à¯ˆ6à®šà®¿à®™à¯à®•à®ªà¯à®ªà¯‚à®°à¯11à°­à°¾à°°à°¤à±5à²­à²¾à²°à²¤4à´­à´¾à´°à´¤à´‚5à¶½à¶‚à¶šà·4à¸„à¸­à¸¡3à¹„à¸—à¸¢3àº¥àº²àº§3áƒ’áƒ”2ã¿ã‚“ãª3ã‚¢ãƒžã‚¾ãƒ³4ã‚¯ãƒ©ã‚¦ãƒ‰4ã‚°ãƒ¼ã‚°ãƒ«4ã‚³ãƒ 2ã‚¹ãƒˆã‚¢3ã‚»ãƒ¼ãƒ«3ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³6ãƒã‚¤ãƒ³ãƒˆ4ä¸–ç•Œ2ä¸­ä¿¡1å›½1åœ‹1æ–‡ç½‘3äºšé©¬é€Š3ä¼ä¸š2ä½›å±±2ä¿¡æ¯2å¥åº·2å…«å¦2å…¬å¸1ç›Š2å°æ¹¾1ç£2å•†åŸŽ1åº—1æ ‡2å˜‰é‡Œ0å¤§é…’åº—5åœ¨çº¿2å¤§æ‹¿2å¤©ä¸»æ•™3å¨±ä¹2å®¶é›»2å¹¿ä¸œ2å¾®åš2æ…ˆå–„2æˆ‘çˆ±ä½ 3æ‰‹æœº2æ‹›è˜2æ”¿åŠ¡1åºœ2æ–°åŠ å¡2é—»2æ—¶å°š2æ›¸ç±2æœºæž„2æ·¡é©¬é”¡3æ¸¸æˆ2æ¾³é–€2ç‚¹çœ‹2ç§»åŠ¨2ç»„ç»‡æœºæž„4ç½‘å€1åº—1ç«™1ç»œ2è”é€š2è°·æ­Œ2è´­ç‰©2é€šè²©2é›†å›¢2é›»è¨Šç›ˆç§‘4é£žåˆ©æµ¦3é£Ÿå“2é¤åŽ…2é¦™æ ¼é‡Œæ‹‰3æ¸¯2ë‹·ë„·1ì»´2ì‚¼ì„±2í•œêµ­2",Tc="numeric",Pc="ascii",Bc="alpha",qr="asciinumeric",Br="alphanumeric",Oc="domain",lb="emoji",iA="scheme",aA="slashscheme",kl="whitespace";function lA(t,e){return t in e||(e[t]=[]),e[t]}function So(t,e,n){e[Tc]&&(e[qr]=!0,e[Br]=!0),e[Pc]&&(e[qr]=!0,e[Bc]=!0),e[qr]&&(e[Br]=!0),e[Bc]&&(e[Br]=!0),e[Br]&&(e[Oc]=!0),e[lb]&&(e[Oc]=!0);for(const o in e){const r=lA(o,n);r.indexOf(t)<0&&r.push(t)}}function cA(t,e){const n={};for(const o in e)e[o].indexOf(t)>=0&&(n[o]=!0);return n}function ut(t=null){this.j={},this.jr=[],this.jd=null,this.t=t}ut.groups={};ut.prototype={accepts(){return!!this.t},go(t){const e=this,n=e.j[t];if(n)return n;for(let o=0;o<e.jr.length;o++){const r=e.jr[o][0],s=e.jr[o][1];if(s&&r.test(t))return s}return e.jd},has(t,e=!1){return e?t in this.j:!!this.go(t)},ta(t,e,n,o){for(let r=0;r<t.length;r++)this.tt(t[r],e,n,o)},tr(t,e,n,o){o=o||ut.groups;let r;return e&&e.j?r=e:(r=new ut(e),n&&o&&So(e,n,o)),this.jr.push([t,r]),r},ts(t,e,n,o){let r=this;const s=t.length;if(!s)return r;for(let i=0;i<s-1;i++)r=r.tt(t[i]);return r.tt(t[s-1],e,n,o)},tt(t,e,n,o){o=o||ut.groups;const r=this;if(e&&e.j)return r.j[t]=e,e;const s=e;let i,a=r.go(t);if(a?(i=new ut,Object.assign(i.j,a.j),i.jr.push.apply(i.jr,a.jr),i.jd=a.jd,i.t=a.t):i=new ut,s){if(o)if(i.t&&typeof i.t=="string"){const l=Object.assign(cA(i.t,o),n);So(s,l,o)}else n&&So(s,n,o);i.t=s}return r.j[t]=i,i}};const re=(t,e,n,o,r)=>t.ta(e,n,o,r),Te=(t,e,n,o,r)=>t.tr(e,n,o,r),cf=(t,e,n,o,r)=>t.ts(e,n,o,r),P=(t,e,n,o,r)=>t.tt(e,n,o,r),fn="WORD",Lc="UWORD",cb="ASCIINUMERICAL",db="ALPHANUMERICAL",ys="LOCALHOST",Dc="TLD",Rc="UTLD",ri="SCHEME",tr="SLASH_SCHEME",Kd="NUM",jc="WS",Gd="NL",Kr="OPENBRACE",Gr="CLOSEBRACE",Di="OPENBRACKET",Ri="CLOSEBRACKET",ji="OPENPAREN",_i="CLOSEPAREN",$i="OPENANGLEBRACKET",Fi="CLOSEANGLEBRACKET",Wi="FULLWIDTHLEFTPAREN",zi="FULLWIDTHRIGHTPAREN",Hi="LEFTCORNERBRACKET",Ui="RIGHTCORNERBRACKET",Vi="LEFTWHITECORNERBRACKET",qi="RIGHTWHITECORNERBRACKET",Ki="FULLWIDTHLESSTHAN",Gi="FULLWIDTHGREATERTHAN",Ji="AMPERSAND",Yi="APOSTROPHE",Xi="ASTERISK",Dn="AT",Qi="BACKSLASH",Zi="BACKTICK",ea="CARET",Fn="COLON",Jd="COMMA",ta="DOLLAR",Vt="DOT",na="EQUALS",Yd="EXCLAMATION",Ct="HYPHEN",Jr="PERCENT",oa="PIPE",ra="PLUS",sa="POUND",Yr="QUERY",Xd="QUOTE",ub="FULLWIDTHMIDDLEDOT",Qd="SEMI",qt="SLASH",Xr="TILDE",ia="UNDERSCORE",pb="EMOJI",aa="SYM";var fb=Object.freeze({__proto__:null,ALPHANUMERICAL:db,AMPERSAND:Ji,APOSTROPHE:Yi,ASCIINUMERICAL:cb,ASTERISK:Xi,AT:Dn,BACKSLASH:Qi,BACKTICK:Zi,CARET:ea,CLOSEANGLEBRACKET:Fi,CLOSEBRACE:Gr,CLOSEBRACKET:Ri,CLOSEPAREN:_i,COLON:Fn,COMMA:Jd,DOLLAR:ta,DOT:Vt,EMOJI:pb,EQUALS:na,EXCLAMATION:Yd,FULLWIDTHGREATERTHAN:Gi,FULLWIDTHLEFTPAREN:Wi,FULLWIDTHLESSTHAN:Ki,FULLWIDTHMIDDLEDOT:ub,FULLWIDTHRIGHTPAREN:zi,HYPHEN:Ct,LEFTCORNERBRACKET:Hi,LEFTWHITECORNERBRACKET:Vi,LOCALHOST:ys,NL:Gd,NUM:Kd,OPENANGLEBRACKET:$i,OPENBRACE:Kr,OPENBRACKET:Di,OPENPAREN:ji,PERCENT:Jr,PIPE:oa,PLUS:ra,POUND:sa,QUERY:Yr,QUOTE:Xd,RIGHTCORNERBRACKET:Ui,RIGHTWHITECORNERBRACKET:qi,SCHEME:ri,SEMI:Qd,SLASH:qt,SLASH_SCHEME:tr,SYM:aa,TILDE:Xr,TLD:Dc,UNDERSCORE:ia,UTLD:Rc,UWORD:Lc,WORD:fn,WS:jc});const un=/[a-z]/,Er=new RegExp("\\p{L}","u"),xl=new RegExp("\\p{Emoji}","u"),pn=/\d/,Cl=/\s/,df="\r",El=`
`,dA="ï¸",uA="â€",Il="ï¿¼";let $s=null,Fs=null;function pA(t=[]){const e={};ut.groups=e;const n=new ut;$s==null&&($s=uf(rA)),Fs==null&&(Fs=uf(sA)),P(n,"'",Yi),P(n,"{",Kr),P(n,"}",Gr),P(n,"[",Di),P(n,"]",Ri),P(n,"(",ji),P(n,")",_i),P(n,"<",$i),P(n,">",Fi),P(n,"ï¼ˆ",Wi),P(n,"ï¼‰",zi),P(n,"ã€Œ",Hi),P(n,"ã€",Ui),P(n,"ã€Ž",Vi),P(n,"ã€",qi),P(n,"ï¼œ",Ki),P(n,"ï¼ž",Gi),P(n,"&",Ji),P(n,"*",Xi),P(n,"@",Dn),P(n,"`",Zi),P(n,"^",ea),P(n,":",Fn),P(n,",",Jd),P(n,"$",ta),P(n,".",Vt),P(n,"=",na),P(n,"!",Yd),P(n,"-",Ct),P(n,"%",Jr),P(n,"|",oa),P(n,"+",ra),P(n,"#",sa),P(n,"?",Yr),P(n,'"',Xd),P(n,"/",qt),P(n,";",Qd),P(n,"~",Xr),P(n,"_",ia),P(n,"\\",Qi),P(n,"ãƒ»",ub);const o=Te(n,pn,Kd,{[Tc]:!0});Te(o,pn,o);const r=Te(o,un,cb,{[qr]:!0}),s=Te(o,Er,db,{[Br]:!0}),i=Te(n,un,fn,{[Pc]:!0});Te(i,pn,r),Te(i,un,i),Te(r,pn,r),Te(r,un,r);const a=Te(n,Er,Lc,{[Bc]:!0});Te(a,un),Te(a,pn,s),Te(a,Er,a),Te(s,pn,s),Te(s,un),Te(s,Er,s);const l=P(n,El,Gd,{[kl]:!0}),c=P(n,df,jc,{[kl]:!0}),d=Te(n,Cl,jc,{[kl]:!0});P(n,Il,d),P(c,El,l),P(c,Il,d),Te(c,Cl,d),P(d,df),P(d,El),Te(d,Cl,d),P(d,Il,d);const u=Te(n,xl,pb,{[lb]:!0});P(u,"#"),Te(u,xl,u),P(u,dA,u);const f=P(u,uA);P(f,"#"),Te(f,xl,u);const p=[[un,i],[pn,r]],m=[[un,null],[Er,a],[pn,s]];for(let b=0;b<$s.length;b++)Bn(n,$s[b],Dc,fn,p);for(let b=0;b<Fs.length;b++)Bn(n,Fs[b],Rc,Lc,m);So(Dc,{tld:!0,ascii:!0},e),So(Rc,{utld:!0,alpha:!0},e),Bn(n,"file",ri,fn,p),Bn(n,"mailto",ri,fn,p),Bn(n,"http",tr,fn,p),Bn(n,"https",tr,fn,p),Bn(n,"ftp",tr,fn,p),Bn(n,"ftps",tr,fn,p),So(ri,{scheme:!0,ascii:!0},e),So(tr,{slashscheme:!0,ascii:!0},e),t=t.sort((b,y)=>b[0]>y[0]?1:-1);for(let b=0;b<t.length;b++){const y=t[b][0],v=t[b][1]?{[iA]:!0}:{[aA]:!0};y.indexOf("-")>=0?v[Oc]=!0:un.test(y)?pn.test(y)?v[qr]=!0:v[Pc]=!0:v[Tc]=!0,cf(n,y,y,v)}return cf(n,"localhost",ys,{ascii:!0}),n.jd=new ut(aa),{start:n,tokens:Object.assign({groups:e},fb)}}function mb(t,e){const n=fA(e.replace(/[A-Z]/g,a=>a.toLowerCase())),o=n.length,r=[];let s=0,i=0;for(;i<o;){let a=t,l=null,c=0,d=null,u=-1,f=-1;for(;i<o&&(l=a.go(n[i]));)a=l,a.accepts()?(u=0,f=0,d=a):u>=0&&(u+=n[i].length,f++),c+=n[i].length,s+=n[i].length,i++;s-=u,i-=f,c-=u,r.push({t:d.t,v:e.slice(s-c,s),s:s-c,e:s})}return r}function fA(t){const e=[],n=t.length;let o=0;for(;o<n;){let r=t.charCodeAt(o),s,i=r<55296||r>56319||o+1===n||(s=t.charCodeAt(o+1))<56320||s>57343?t[o]:t.slice(o,o+2);e.push(i),o+=i.length}return e}function Bn(t,e,n,o,r){let s;const i=e.length;for(let a=0;a<i-1;a++){const l=e[a];t.j[l]?s=t.j[l]:(s=new ut(o),s.jr=r.slice(),t.j[l]=s),t=s}return s=new ut(n),s.jr=r.slice(),t.j[e[i-1]]=s,s}function uf(t){const e=[],n=[];let o=0,r="0123456789";for(;o<t.length;){let s=0;for(;r.indexOf(t[o+s])>=0;)s++;if(s>0){e.push(n.join(""));for(let i=parseInt(t.substring(o,o+s),10);i>0;i--)n.pop();o+=s}else n.push(t[o]),o++}return e}const ws={defaultProtocol:"http",events:null,format:pf,formatHref:pf,nl2br:!1,tagName:"a",target:null,rel:null,validate:!0,truncate:1/0,className:null,attributes:null,ignoreTags:[],render:null};function Zd(t,e=null){let n=Object.assign({},ws);t&&(n=Object.assign(n,t instanceof Zd?t.o:t));const o=n.ignoreTags,r=[];for(let s=0;s<o.length;s++)r.push(o[s].toUpperCase());this.o=n,e&&(this.defaultRender=e),this.ignoreTags=r}Zd.prototype={o:ws,ignoreTags:[],defaultRender(t){return t},check(t){return this.get("validate",t.toString(),t)},get(t,e,n){const o=e!=null;let r=this.o[t];return r&&(typeof r=="object"?(r=n.t in r?r[n.t]:ws[t],typeof r=="function"&&o&&(r=r(e,n))):typeof r=="function"&&o&&(r=r(e,n.t,n)),r)},getObj(t,e,n){let o=this.o[t];return typeof o=="function"&&e!=null&&(o=o(e,n.t,n)),o},render(t){const e=t.render(this);return(this.get("render",null,t)||this.defaultRender)(e,t.t,t)}};function pf(t){return t}function hb(t,e){this.t="token",this.v=t,this.tk=e}hb.prototype={isLink:!1,toString(){return this.v},toHref(t){return this.toString()},toFormattedString(t){const e=this.toString(),n=t.get("truncate",e,this),o=t.get("format",e,this);return n&&o.length>n?o.substring(0,n)+"â€¦":o},toFormattedHref(t){return t.get("formatHref",this.toHref(t.get("defaultProtocol")),this)},startIndex(){return this.tk[0].s},endIndex(){return this.tk[this.tk.length-1].e},toObject(t=ws.defaultProtocol){return{type:this.t,value:this.toString(),isLink:this.isLink,href:this.toHref(t),start:this.startIndex(),end:this.endIndex()}},toFormattedObject(t){return{type:this.t,value:this.toFormattedString(t),isLink:this.isLink,href:this.toFormattedHref(t),start:this.startIndex(),end:this.endIndex()}},validate(t){return t.get("validate",this.toString(),this)},render(t){const e=this,n=this.toHref(t.get("defaultProtocol")),o=t.get("formatHref",n,this),r=t.get("tagName",n,e),s=this.toFormattedString(t),i={},a=t.get("className",n,e),l=t.get("target",n,e),c=t.get("rel",n,e),d=t.getObj("attributes",n,e),u=t.getObj("events",n,e);return i.href=o,a&&(i.class=a),l&&(i.target=l),c&&(i.rel=c),d&&Object.assign(i,d),{tagName:r,attributes:i,content:s,eventListeners:u}}};function Ha(t,e){class n extends hb{constructor(r,s){super(r,s),this.t=t}}for(const o in e)n.prototype[o]=e[o];return n.t=t,n}const ff=Ha("email",{isLink:!0,toHref(){return"mailto:"+this.toString()}}),mf=Ha("text"),mA=Ha("nl"),Ws=Ha("url",{isLink:!0,toHref(t=ws.defaultProtocol){return this.hasProtocol()?this.v:`${t}://${this.v}`},hasProtocol(){const t=this.tk;return t.length>=2&&t[0].t!==ys&&t[1].t===Fn}}),xt=t=>new ut(t);function hA({groups:t}){const e=t.domain.concat([Ji,Xi,Dn,Qi,Zi,ea,ta,na,Ct,Kd,Jr,oa,ra,sa,qt,aa,Xr,ia]),n=[Yi,Fn,Jd,Vt,Yd,Jr,Yr,Xd,Qd,$i,Fi,Kr,Gr,Ri,Di,ji,_i,Wi,zi,Hi,Ui,Vi,qi,Ki,Gi],o=[Ji,Yi,Xi,Qi,Zi,ea,ta,na,Ct,Kr,Gr,Jr,oa,ra,sa,Yr,qt,aa,Xr,ia],r=xt(),s=P(r,Xr);re(s,o,s),re(s,t.domain,s);const i=xt(),a=xt(),l=xt();re(r,t.domain,i),re(r,t.scheme,a),re(r,t.slashscheme,l),re(i,o,s),re(i,t.domain,i);const c=P(i,Dn);P(s,Dn,c),P(a,Dn,c),P(l,Dn,c);const d=P(s,Vt);re(d,o,s),re(d,t.domain,s);const u=xt();re(c,t.domain,u),re(u,t.domain,u);const f=P(u,Vt);re(f,t.domain,u);const p=xt(ff);re(f,t.tld,p),re(f,t.utld,p),P(c,ys,p);const m=P(u,Ct);P(m,Ct,m),re(m,t.domain,u),re(p,t.domain,u),P(p,Vt,f),P(p,Ct,m);const b=P(p,Fn);re(b,t.numeric,ff);const y=P(i,Ct),w=P(i,Vt);P(y,Ct,y),re(y,t.domain,i),re(w,o,s),re(w,t.domain,i);const v=xt(Ws);re(w,t.tld,v),re(w,t.utld,v),re(v,t.domain,i),re(v,o,s),P(v,Vt,w),P(v,Ct,y),P(v,Dn,c);const S=P(v,Fn),C=xt(Ws);re(S,t.numeric,C);const x=xt(Ws),I=xt();re(x,e,x),re(x,n,I),re(I,e,x),re(I,n,I),P(v,qt,x),P(C,qt,x);const N=P(a,Fn),E=P(l,Fn),A=P(E,qt),L=P(A,qt);re(a,t.domain,i),P(a,Vt,w),P(a,Ct,y),re(l,t.domain,i),P(l,Vt,w),P(l,Ct,y),re(N,t.domain,x),P(N,qt,x),P(N,Yr,x),re(L,t.domain,x),re(L,e,x),P(L,qt,x);const B=[[Kr,Gr],[Di,Ri],[ji,_i],[$i,Fi],[Wi,zi],[Hi,Ui],[Vi,qi],[Ki,Gi]];for(let G=0;G<B.length;G++){const[K,_]=B[G],me=P(x,K);P(I,K,me),P(me,_,x);const Q=xt(Ws);re(me,e,Q);const Oe=xt();re(me,n),re(Q,e,Q),re(Q,n,Oe),re(Oe,e,Q),re(Oe,n,Oe),P(Q,_,x),P(Oe,_,x)}return P(r,ys,v),P(r,Gd,mA),{start:r,tokens:fb}}function gA(t,e,n){let o=n.length,r=0,s=[],i=[];for(;r<o;){let a=t,l=null,c=null,d=0,u=null,f=-1;for(;r<o&&!(l=a.go(n[r].t));)i.push(n[r++]);for(;r<o&&(c=l||a.go(n[r].t));)l=null,a=c,a.accepts()?(f=0,u=a):f>=0&&f++,r++,d++;if(f<0)r-=d,r<o&&(i.push(n[r]),r++);else{i.length>0&&(s.push(Al(mf,e,i)),i=[]),r-=f,d-=f;const p=u.t,m=n.slice(r-d,r);s.push(Al(p,e,m))}}return i.length>0&&s.push(Al(mf,e,i)),s}function Al(t,e,n){const o=n[0].s,r=n[n.length-1].e,s=e.slice(o,r);return new t(s,n)}const bA=typeof console<"u"&&console&&console.warn||(()=>{}),yA="until manual call of linkify.init(). Register all schemes and plugins before invoking linkify the first time.",Ce={scanner:null,parser:null,tokenQueue:[],pluginQueue:[],customSchemes:[],initialized:!1};function wA(){return ut.groups={},Ce.scanner=null,Ce.parser=null,Ce.tokenQueue=[],Ce.pluginQueue=[],Ce.customSchemes=[],Ce.initialized=!1,Ce}function hf(t,e=!1){if(Ce.initialized&&bA(`linkifyjs: already initialized - will not register custom scheme "${t}" ${yA}`),!/^[0-9a-z]+(-[0-9a-z]+)*$/.test(t))throw new Error(`linkifyjs: incorrect scheme format.
1. Must only contain digits, lowercase ASCII letters or "-"
2. Cannot start or end with "-"
3. "-" cannot repeat`);Ce.customSchemes.push([t,e])}function vA(){Ce.scanner=pA(Ce.customSchemes);for(let t=0;t<Ce.tokenQueue.length;t++)Ce.tokenQueue[t][1]({scanner:Ce.scanner});Ce.parser=hA(Ce.scanner.tokens);for(let t=0;t<Ce.pluginQueue.length;t++)Ce.pluginQueue[t][1]({scanner:Ce.scanner,parser:Ce.parser});return Ce.initialized=!0,Ce}function eu(t){return Ce.initialized||vA(),gA(Ce.parser.start,t,mb(Ce.scanner.start,t))}eu.scan=mb;function gb(t,e=null,n=null){if(e&&typeof e=="object"){if(n)throw Error(`linkifyjs: Invalid link type ${e}; must be a string`);n=e,e=null}const o=new Zd(n),r=eu(t),s=[];for(let i=0;i<r.length;i++){const a=r[i];a.isLink&&(!e||a.t===e)&&o.check(a)&&s.push(a.toFormattedObject(o))}return s}var tu="[\0- Â áš€á Žâ€€-\u2029âŸã€€]",SA=new RegExp(tu),kA=new RegExp(`${tu}$`),xA=new RegExp(tu,"g");function CA(t){return t.length===1?t[0].isLink:t.length===3&&t[1].isLink?["()","[]"].includes(t[0].value+t[2].value):!1}function EA(t){return new Me({key:new Fe("autolink"),appendTransaction:(e,n,o)=>{const r=e.some(c=>c.docChanged)&&!n.doc.eq(o.doc),s=e.some(c=>c.getMeta("preventAutolink"));if(!r||s)return;const{tr:i}=o,a=fg(n.doc,[...e]);if(kg(a).forEach(({newRange:c})=>{const d=Zx(o.doc,c,p=>p.isTextblock);let u,f;if(d.length>1)u=d[0],f=o.doc.textBetween(u.pos,u.pos+u.node.nodeSize,void 0," ");else if(d.length){const p=o.doc.textBetween(c.from,c.to," "," ");if(!kA.test(p))return;u=d[0],f=o.doc.textBetween(u.pos,c.to,void 0," ")}if(u&&f){const p=f.split(SA).filter(Boolean);if(p.length<=0)return!1;const m=p[p.length-1],b=u.pos+f.lastIndexOf(m);if(!m)return!1;const y=eu(m).map(w=>w.toObject(t.defaultProtocol));if(!CA(y))return!1;y.filter(w=>w.isLink).map(w=>({...w,from:b+w.start+1,to:b+w.end+1})).filter(w=>o.schema.marks.code?!o.doc.rangeHasMark(w.from,w.to,o.schema.marks.code):!0).filter(w=>t.validate(w.value)).filter(w=>t.shouldAutoLink(w.value)).forEach(w=>{Wd(w.from,w.to,o.doc).some(v=>v.mark.type===t.type)||i.addMark(w.from,w.to,t.type.create({href:w.href}))})}}),!!i.steps.length)return i}})}function IA(t){return new Me({key:new Fe("handleClickLink"),props:{handleClick:(e,n,o)=>{var r,s;if(o.button!==0||!e.editable)return!1;let i=null;if(o.target instanceof HTMLAnchorElement)i=o.target;else{let d=o.target;const u=[];for(;d.nodeName!=="DIV";)u.push(d),d=d.parentNode;i=u.find(f=>f.nodeName==="A")}if(!i)return!1;const a=Sg(e.state,t.type.name),l=(r=i?.href)!=null?r:a.href,c=(s=i?.target)!=null?s:a.target;return t.enableClickSelection&&t.editor.commands.extendMarkRange(t.type.name),i&&l?(window.open(l,c),!0):!1}}})}function AA(t){return new Me({key:new Fe("handlePasteLink"),props:{handlePaste:(e,n,o)=>{const{state:r}=e,{selection:s}=r,{empty:i}=s;if(i)return!1;let a="";o.content.forEach(c=>{a+=c.textContent});const l=gb(a,{defaultProtocol:t.defaultProtocol}).find(c=>c.isLink&&c.value===a);return!a||!l?!1:t.editor.commands.setMark(t.type,{href:l.href})}}})}function uo(t,e){const n=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];return e&&e.forEach(o=>{const r=typeof o=="string"?o:o.scheme;r&&n.push(r)}),!t||t.replace(xA,"").match(new RegExp(`^(?:(?:${n.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}var NA=nn.create({name:"link",priority:1e3,keepOnSplit:!1,exitable:!0,onCreate(){this.options.validate&&!this.options.shouldAutoLink&&(this.options.shouldAutoLink=this.options.validate,console.warn("The `validate` option is deprecated. Rename to the `shouldAutoLink` option instead.")),this.options.protocols.forEach(t=>{if(typeof t=="string"){hf(t);return}hf(t.scheme,t.optionalSlashes)})},onDestroy(){wA()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:!0,enableClickSelection:!1,linkOnPaste:!0,autolink:!0,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(t,e)=>!!uo(t,e.protocols),validate:t=>!!t,shouldAutoLink:t=>!!t}},addAttributes(){return{href:{default:null,parseHTML(t){return t.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:t=>{const e=t.getAttribute("href");return!e||!this.options.isAllowedUri(e,{defaultValidate:n=>!!uo(n,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:null}}]},renderHTML({HTMLAttributes:t}){return this.options.isAllowedUri(t.href,{defaultValidate:e=>!!uo(e,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",Ee(this.options.HTMLAttributes,t),0]:["a",Ee(this.options.HTMLAttributes,{...t,href:""}),0]},addCommands(){return{setLink:t=>({chain:e})=>{const{href:n}=t;return this.options.isAllowedUri(n,{defaultValidate:o=>!!uo(o,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?e().setMark(this.name,t).setMeta("preventAutolink",!0).run():!1},toggleLink:t=>({chain:e})=>{const{href:n}=t||{};return n&&!this.options.isAllowedUri(n,{defaultValidate:o=>!!uo(o,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:e().toggleMark(this.name,t,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()},unsetLink:()=>({chain:t})=>t().unsetMark(this.name,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()}},addPasteRules(){return[oo({find:t=>{const e=[];if(t){const{protocols:n,defaultProtocol:o}=this.options,r=gb(t).filter(s=>s.isLink&&this.options.isAllowedUri(s.value,{defaultValidate:i=>!!uo(i,n),protocols:n,defaultProtocol:o}));r.length&&r.forEach(s=>e.push({text:s.value,data:{href:s.href},index:s.start}))}return e},type:this.type,getAttributes:t=>{var e;return{href:(e=t.data)==null?void 0:e.href}}})]},addProseMirrorPlugins(){const t=[],{protocols:e,defaultProtocol:n}=this.options;return this.options.autolink&&t.push(EA({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:o=>this.options.isAllowedUri(o,{defaultValidate:r=>!!uo(r,e),protocols:e,defaultProtocol:n}),shouldAutoLink:this.options.shouldAutoLink})),this.options.openOnClick===!0&&t.push(IA({type:this.type,editor:this.editor,enableClickSelection:this.options.enableClickSelection})),this.options.linkOnPaste&&t.push(AA({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type})),t}}),MA=Object.defineProperty,TA=(t,e)=>{for(var n in e)MA(t,n,{get:e[n],enumerable:!0})},PA="listItem",gf="textStyle",bf=/^\s*([-+*])\s$/,bb=lt.create({name:"bulletList",addOptions(){return{itemTypeName:"listItem",HTMLAttributes:{},keepMarks:!1,keepAttributes:!1}},group:"block list",content(){return`${this.options.itemTypeName}+`},parseHTML(){return[{tag:"ul"}]},renderHTML({HTMLAttributes:t}){return["ul",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{toggleBulletList:()=>({commands:t,chain:e})=>this.options.keepAttributes?e().toggleList(this.name,this.options.itemTypeName,this.options.keepMarks).updateAttributes(PA,this.editor.getAttributes(gf)).run():t.toggleList(this.name,this.options.itemTypeName,this.options.keepMarks)}},addKeyboardShortcuts(){return{"Mod-Shift-8":()=>this.editor.commands.toggleBulletList()}},addInputRules(){let t=mr({find:bf,type:this.type});return(this.options.keepMarks||this.options.keepAttributes)&&(t=mr({find:bf,type:this.type,keepMarks:this.options.keepMarks,keepAttributes:this.options.keepAttributes,getAttributes:()=>this.editor.getAttributes(gf),editor:this.editor})),[t]}}),yb=lt.create({name:"listItem",addOptions(){return{HTMLAttributes:{},bulletListTypeName:"bulletList",orderedListTypeName:"orderedList"}},content:"paragraph block*",defining:!0,parseHTML(){return[{tag:"li"}]},renderHTML({HTMLAttributes:t}){return["li",Ee(this.options.HTMLAttributes,t),0]},addKeyboardShortcuts(){return{Enter:()=>this.editor.commands.splitListItem(this.name),Tab:()=>this.editor.commands.sinkListItem(this.name),"Shift-Tab":()=>this.editor.commands.liftListItem(this.name)}}}),BA={};TA(BA,{findListItemPos:()=>Es,getNextListDepth:()=>nu,handleBackspace:()=>_c,handleDelete:()=>$c,hasListBefore:()=>wb,hasListItemAfter:()=>OA,hasListItemBefore:()=>vb,listItemHasSubList:()=>Sb,nextListIsDeeper:()=>kb,nextListIsHigher:()=>xb});var Es=(t,e)=>{const{$from:n}=e.selection,o=$e(t,e.schema);let r=null,s=n.depth,i=n.pos,a=null;for(;s>0&&a===null;)r=n.node(s),r.type===o?a=s:(s-=1,i-=1);return a===null?null:{$pos:e.doc.resolve(i),depth:a}},nu=(t,e)=>{const n=Es(t,e);if(!n)return!1;const[,o]=cC(e,t,n.$pos.pos+4);return o},wb=(t,e,n)=>{const{$anchor:o}=t.selection,r=Math.max(0,o.pos-2),s=t.doc.resolve(r).node();return!(!s||!n.includes(s.type.name))},vb=(t,e)=>{var n;const{$anchor:o}=e.selection,r=e.doc.resolve(o.pos-2);return!(r.index()===0||((n=r.nodeBefore)==null?void 0:n.type.name)!==t)},Sb=(t,e,n)=>{if(!n)return!1;const o=$e(t,e.schema);let r=!1;return n.descendants(s=>{s.type===o&&(r=!0)}),r},_c=(t,e,n)=>{if(t.commands.undoInputRule())return!0;if(t.state.selection.from!==t.state.selection.to)return!1;if(!no(t.state,e)&&wb(t.state,e,n)){const{$anchor:a}=t.state.selection,l=t.state.doc.resolve(a.before()-1),c=[];l.node().descendants((f,p)=>{f.type.name===e&&c.push({node:f,pos:p})});const d=c.at(-1);if(!d)return!1;const u=t.state.doc.resolve(l.start()+d.pos+1);return t.chain().cut({from:a.start()-1,to:a.end()+1},u.end()).joinForward().run()}if(!no(t.state,e)||!fC(t.state))return!1;const o=Es(e,t.state);if(!o)return!1;const s=t.state.doc.resolve(o.$pos.pos-2).node(o.depth),i=Sb(e,t.state,s);return vb(e,t.state)&&!i?t.commands.joinItemBackward():t.chain().liftListItem(e).run()},kb=(t,e)=>{const n=nu(t,e),o=Es(t,e);return!o||!n?!1:n>o.depth},xb=(t,e)=>{const n=nu(t,e),o=Es(t,e);return!o||!n?!1:n<o.depth},$c=(t,e)=>{if(!no(t.state,e)||!pC(t.state,e))return!1;const{selection:n}=t.state,{$from:o,$to:r}=n;return!n.empty&&o.sameParent(r)?!1:kb(e,t.state)?t.chain().focus(t.state.selection.from+4).lift(e).joinBackward().run():xb(e,t.state)?t.chain().joinForward().joinBackward().run():t.commands.joinItemForward()},OA=(t,e)=>{var n;const{$anchor:o}=e.selection,r=e.doc.resolve(o.pos-o.parentOffset-2);return!(r.index()===r.parent.childCount-1||((n=r.nodeAfter)==null?void 0:n.type.name)!==t)},Cb=ve.create({name:"listKeymap",addOptions(){return{listTypes:[{itemName:"listItem",wrapperNames:["bulletList","orderedList"]},{itemName:"taskItem",wrapperNames:["taskList"]}]}},addKeyboardShortcuts(){return{Delete:({editor:t})=>{let e=!1;return this.options.listTypes.forEach(({itemName:n})=>{t.state.schema.nodes[n]!==void 0&&$c(t,n)&&(e=!0)}),e},"Mod-Delete":({editor:t})=>{let e=!1;return this.options.listTypes.forEach(({itemName:n})=>{t.state.schema.nodes[n]!==void 0&&$c(t,n)&&(e=!0)}),e},Backspace:({editor:t})=>{let e=!1;return this.options.listTypes.forEach(({itemName:n,wrapperNames:o})=>{t.state.schema.nodes[n]!==void 0&&_c(t,n,o)&&(e=!0)}),e},"Mod-Backspace":({editor:t})=>{let e=!1;return this.options.listTypes.forEach(({itemName:n,wrapperNames:o})=>{t.state.schema.nodes[n]!==void 0&&_c(t,n,o)&&(e=!0)}),e}}}}),LA="listItem",yf="textStyle",wf=/^(\d+)\.\s$/,Eb=lt.create({name:"orderedList",addOptions(){return{itemTypeName:"listItem",HTMLAttributes:{},keepMarks:!1,keepAttributes:!1}},group:"block list",content(){return`${this.options.itemTypeName}+`},addAttributes(){return{start:{default:1,parseHTML:t=>t.hasAttribute("start")?parseInt(t.getAttribute("start")||"",10):1},type:{default:null,parseHTML:t=>t.getAttribute("type")}}},parseHTML(){return[{tag:"ol"}]},renderHTML({HTMLAttributes:t}){const{start:e,...n}=t;return e===1?["ol",Ee(this.options.HTMLAttributes,n),0]:["ol",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{toggleOrderedList:()=>({commands:t,chain:e})=>this.options.keepAttributes?e().toggleList(this.name,this.options.itemTypeName,this.options.keepMarks).updateAttributes(LA,this.editor.getAttributes(yf)).run():t.toggleList(this.name,this.options.itemTypeName,this.options.keepMarks)}},addKeyboardShortcuts(){return{"Mod-Shift-7":()=>this.editor.commands.toggleOrderedList()}},addInputRules(){let t=mr({find:wf,type:this.type,getAttributes:e=>({start:+e[1]}),joinPredicate:(e,n)=>n.childCount+n.attrs.start===+e[1]});return(this.options.keepMarks||this.options.keepAttributes)&&(t=mr({find:wf,type:this.type,keepMarks:this.options.keepMarks,keepAttributes:this.options.keepAttributes,getAttributes:e=>({start:+e[1],...this.editor.getAttributes(yf)}),joinPredicate:(e,n)=>n.childCount+n.attrs.start===+e[1],editor:this.editor})),[t]}}),DA=/^\s*(\[([( |x])?\])\s$/,RA=lt.create({name:"taskItem",addOptions(){return{nested:!1,HTMLAttributes:{},taskListTypeName:"taskList",a11y:void 0}},content(){return this.options.nested?"paragraph block*":"paragraph+"},defining:!0,addAttributes(){return{checked:{default:!1,keepOnSplit:!1,parseHTML:t=>{const e=t.getAttribute("data-checked");return e===""||e==="true"},renderHTML:t=>({"data-checked":t.checked})}}},parseHTML(){return[{tag:`li[data-type="${this.name}"]`,priority:51}]},renderHTML({node:t,HTMLAttributes:e}){return["li",Ee(this.options.HTMLAttributes,e,{"data-type":this.name}),["label",["input",{type:"checkbox",checked:t.attrs.checked?"checked":null}],["span"]],["div",0]]},addKeyboardShortcuts(){const t={Enter:()=>this.editor.commands.splitListItem(this.name),"Shift-Tab":()=>this.editor.commands.liftListItem(this.name)};return this.options.nested?{...t,Tab:()=>this.editor.commands.sinkListItem(this.name)}:t},addNodeView(){return({node:t,HTMLAttributes:e,getPos:n,editor:o})=>{const r=document.createElement("li"),s=document.createElement("label"),i=document.createElement("span"),a=document.createElement("input"),l=document.createElement("div"),c=d=>{var u,f;a.ariaLabel=((f=(u=this.options.a11y)==null?void 0:u.checkboxLabel)==null?void 0:f.call(u,d,a.checked))||`Task item checkbox for ${d.textContent||"empty task item"}`};return c(t),s.contentEditable="false",a.type="checkbox",a.addEventListener("mousedown",d=>d.preventDefault()),a.addEventListener("change",d=>{if(!o.isEditable&&!this.options.onReadOnlyChecked){a.checked=!a.checked;return}const{checked:u}=d.target;o.isEditable&&typeof n=="function"&&o.chain().focus(void 0,{scrollIntoView:!1}).command(({tr:f})=>{const p=n();if(typeof p!="number")return!1;const m=f.doc.nodeAt(p);return f.setNodeMarkup(p,void 0,{...m?.attrs,checked:u}),!0}).run(),!o.isEditable&&this.options.onReadOnlyChecked&&(this.options.onReadOnlyChecked(t,u)||(a.checked=!a.checked))}),Object.entries(this.options.HTMLAttributes).forEach(([d,u])=>{r.setAttribute(d,u)}),r.dataset.checked=t.attrs.checked,a.checked=t.attrs.checked,s.append(a,i),r.append(s,l),Object.entries(e).forEach(([d,u])=>{r.setAttribute(d,u)}),{dom:r,contentDOM:l,update:d=>d.type!==this.type?!1:(r.dataset.checked=d.attrs.checked,a.checked=d.attrs.checked,c(d),!0)}}},addInputRules(){return[mr({find:DA,type:this.type,getAttributes:t=>({checked:t[t.length-1]==="x"})})]}}),jA=lt.create({name:"taskList",addOptions(){return{itemTypeName:"taskItem",HTMLAttributes:{}}},group:"block list",content(){return`${this.options.itemTypeName}+`},parseHTML(){return[{tag:`ul[data-type="${this.name}"]`,priority:51}]},renderHTML({HTMLAttributes:t}){return["ul",Ee(this.options.HTMLAttributes,t,{"data-type":this.name}),0]},addCommands(){return{toggleTaskList:()=>({commands:t})=>t.toggleList(this.name,this.options.itemTypeName)}},addKeyboardShortcuts(){return{"Mod-Shift-9":()=>this.editor.commands.toggleTaskList()}}});ve.create({name:"listKit",addExtensions(){const t=[];return this.options.bulletList!==!1&&t.push(bb.configure(this.options.bulletList)),this.options.listItem!==!1&&t.push(yb.configure(this.options.listItem)),this.options.listKeymap!==!1&&t.push(Cb.configure(this.options.listKeymap)),this.options.orderedList!==!1&&t.push(Eb.configure(this.options.orderedList)),this.options.taskItem!==!1&&t.push(RA.configure(this.options.taskItem)),this.options.taskList!==!1&&t.push(jA.configure(this.options.taskList)),t}});var _A=lt.create({name:"paragraph",priority:1e3,addOptions(){return{HTMLAttributes:{}}},group:"block",content:"inline*",parseHTML(){return[{tag:"p"}]},renderHTML({HTMLAttributes:t}){return["p",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{setParagraph:()=>({commands:t})=>t.setNode(this.name)}},addKeyboardShortcuts(){return{"Mod-Alt-0":()=>this.editor.commands.setParagraph()}}}),$A=/(?:^|\s)(~~(?!\s+~~)((?:[^~]+))~~(?!\s+~~))$/,FA=/(?:^|\s)(~~(?!\s+~~)((?:[^~]+))~~(?!\s+~~))/g,WA=nn.create({name:"strike",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"s"},{tag:"del"},{tag:"strike"},{style:"text-decoration",consuming:!1,getAttrs:t=>t.includes("line-through")?{}:!1}]},renderHTML({HTMLAttributes:t}){return["s",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{setStrike:()=>({commands:t})=>t.setMark(this.name),toggleStrike:()=>({commands:t})=>t.toggleMark(this.name),unsetStrike:()=>({commands:t})=>t.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-s":()=>this.editor.commands.toggleStrike()}},addInputRules(){return[Do({find:$A,type:this.type})]},addPasteRules(){return[oo({find:FA,type:this.type})]}}),zA=lt.create({name:"text",group:"inline"}),HA=nn.create({name:"underline",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"u"},{style:"text-decoration",consuming:!1,getAttrs:t=>t.includes("underline")?{}:!1}]},renderHTML({HTMLAttributes:t}){return["u",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{setUnderline:()=>({commands:t})=>t.setMark(this.name),toggleUnderline:()=>({commands:t})=>t.toggleMark(this.name),unsetUnderline:()=>({commands:t})=>t.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-u":()=>this.editor.commands.toggleUnderline(),"Mod-U":()=>this.editor.commands.toggleUnderline()}}});function UA(t={}){return new Me({view(e){return new VA(e,t)}})}class VA{constructor(e,n){var o;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(o=n.width)!==null&&o!==void 0?o:1,this.color=n.color===!1?void 0:n.color||"black",this.class=n.class,this.handlers=["dragover","dragend","drop","dragleave"].map(r=>{let s=i=>{this[r](i)};return e.dom.addEventListener(r,s),{name:r,handler:s}})}destroy(){this.handlers.forEach(({name:e,handler:n})=>this.editorView.dom.removeEventListener(e,n))}update(e,n){this.cursorPos!=null&&n.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),n=!e.parent.inlineContent,o,r=this.editorView.dom,s=r.getBoundingClientRect(),i=s.width/r.offsetWidth,a=s.height/r.offsetHeight;if(n){let u=e.nodeBefore,f=e.nodeAfter;if(u||f){let p=this.editorView.nodeDOM(this.cursorPos-(u?u.nodeSize:0));if(p){let m=p.getBoundingClientRect(),b=u?m.bottom:m.top;u&&f&&(b=(b+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2);let y=this.width/2*a;o={left:m.left,right:m.right,top:b-y,bottom:b+y}}}}if(!o){let u=this.editorView.coordsAtPos(this.cursorPos),f=this.width/2*i;o={left:u.left-f,right:u.left+f,top:u.top,bottom:u.bottom}}let l=this.editorView.dom.offsetParent;this.element||(this.element=l.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",n),this.element.classList.toggle("prosemirror-dropcursor-inline",!n);let c,d;if(!l||l==document.body&&getComputedStyle(l).position=="static")c=-pageXOffset,d=-pageYOffset;else{let u=l.getBoundingClientRect(),f=u.width/l.offsetWidth,p=u.height/l.offsetHeight;c=u.left-l.scrollLeft*f,d=u.top-l.scrollTop*p}this.element.style.left=(o.left-c)/i+"px",this.element.style.top=(o.top-d)/a+"px",this.element.style.width=(o.right-o.left)/i+"px",this.element.style.height=(o.bottom-o.top)/a+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let n=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),o=n&&n.inside>=0&&this.editorView.state.doc.nodeAt(n.inside),r=o&&o.type.spec.disableDropCursor,s=typeof r=="function"?r(this.editorView,n,e):r;if(n&&!s){let i=n.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=uh(this.editorView.state.doc,i,this.editorView.dragging.slice);a!=null&&(i=a)}this.setCursor(i),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){this.editorView.dom.contains(e.relatedTarget)||this.setCursor(null)}}class Be extends ne{constructor(e){super(e,e)}map(e,n){let o=e.resolve(n.map(this.head));return Be.valid(o)?new Be(o):ne.near(o)}content(){return R.empty}eq(e){return e instanceof Be&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,n){if(typeof n.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new Be(e.resolve(n.pos))}getBookmark(){return new ou(this.anchor)}static valid(e){let n=e.parent;if(n.isTextblock||!qA(e)||!KA(e))return!1;let o=n.type.spec.allowGapCursor;if(o!=null)return o;let r=n.contentMatchAt(e.index()).defaultType;return r&&r.isTextblock}static findGapCursorFrom(e,n,o=!1){e:for(;;){if(!o&&Be.valid(e))return e;let r=e.pos,s=null;for(let i=e.depth;;i--){let a=e.node(i);if(n>0?e.indexAfter(i)<a.childCount:e.index(i)>0){s=a.child(n>0?e.indexAfter(i):e.index(i)-1);break}else if(i==0)return null;r+=n;let l=e.doc.resolve(r);if(Be.valid(l))return l}for(;;){let i=n>0?s.firstChild:s.lastChild;if(!i){if(s.isAtom&&!s.isText&&!U.isSelectable(s)){e=e.doc.resolve(r+s.nodeSize*n),o=!1;continue e}break}s=i,r+=n;let a=e.doc.resolve(r);if(Be.valid(a))return a}return null}}}Be.prototype.visible=!1;Be.findFrom=Be.findGapCursorFrom;ne.jsonID("gapcursor",Be);class ou{constructor(e){this.pos=e}map(e){return new ou(e.map(this.pos))}resolve(e){let n=e.resolve(this.pos);return Be.valid(n)?new Be(n):ne.near(n)}}function qA(t){for(let e=t.depth;e>=0;e--){let n=t.index(e),o=t.node(e);if(n==0){if(o.type.spec.isolating)return!0;continue}for(let r=o.child(n-1);;r=r.lastChild){if(r.childCount==0&&!r.inlineContent||r.isAtom||r.type.spec.isolating)return!0;if(r.inlineContent)return!1}}return!0}function KA(t){for(let e=t.depth;e>=0;e--){let n=t.indexAfter(e),o=t.node(e);if(n==o.childCount){if(o.type.spec.isolating)return!0;continue}for(let r=o.child(n);;r=r.firstChild){if(r.childCount==0&&!r.inlineContent||r.isAtom||r.type.spec.isolating)return!0;if(r.inlineContent)return!1}}return!0}function GA(){return new Me({props:{decorations:QA,createSelectionBetween(t,e,n){return e.pos==n.pos&&Be.valid(n)?new Be(n):null},handleClick:YA,handleKeyDown:JA,handleDOMEvents:{beforeinput:XA}}})}const JA=Zh({ArrowLeft:zs("horiz",-1),ArrowRight:zs("horiz",1),ArrowUp:zs("vert",-1),ArrowDown:zs("vert",1)});function zs(t,e){const n=t=="vert"?e>0?"down":"up":e>0?"right":"left";return function(o,r,s){let i=o.selection,a=e>0?i.$to:i.$from,l=i.empty;if(i instanceof Z){if(!s.endOfTextblock(n)||a.depth==0)return!1;l=!1,a=o.doc.resolve(e>0?a.after():a.before())}let c=Be.findGapCursorFrom(a,e,l);return c?(r&&r(o.tr.setSelection(new Be(c))),!0):!1}}function YA(t,e,n){if(!t||!t.editable)return!1;let o=t.state.doc.resolve(e);if(!Be.valid(o))return!1;let r=t.posAtCoords({left:n.clientX,top:n.clientY});return r&&r.inside>-1&&U.isSelectable(t.state.doc.nodeAt(r.inside))?!1:(t.dispatch(t.state.tr.setSelection(new Be(o))),!0)}function XA(t,e){if(e.inputType!="insertCompositionText"||!(t.state.selection instanceof Be))return!1;let{$from:n}=t.state.selection,o=n.parent.contentMatchAt(n.index()).findWrapping(t.state.schema.nodes.text);if(!o)return!1;let r=M.empty;for(let i=o.length-1;i>=0;i--)r=M.from(o[i].createAndFill(null,r));let s=t.state.tr.replace(n.pos,n.pos,new R(r,0,0));return s.setSelection(Z.near(s.doc.resolve(n.pos+1))),t.dispatch(s),!1}function QA(t){if(!(t.selection instanceof Be))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",Ne.create(t.doc,[nt.widget(t.selection.head,e,{key:"gapcursor"})])}var la=200,Ue=function(){};Ue.prototype.append=function(e){return e.length?(e=Ue.from(e),!this.length&&e||e.length<la&&this.leafAppend(e)||this.length<la&&e.leafPrepend(this)||this.appendInner(e)):this};Ue.prototype.prepend=function(e){return e.length?Ue.from(e).append(this):this};Ue.prototype.appendInner=function(e){return new ZA(this,e)};Ue.prototype.slice=function(e,n){return e===void 0&&(e=0),n===void 0&&(n=this.length),e>=n?Ue.empty:this.sliceInner(Math.max(0,e),Math.min(this.length,n))};Ue.prototype.get=function(e){if(!(e<0||e>=this.length))return this.getInner(e)};Ue.prototype.forEach=function(e,n,o){n===void 0&&(n=0),o===void 0&&(o=this.length),n<=o?this.forEachInner(e,n,o,0):this.forEachInvertedInner(e,n,o,0)};Ue.prototype.map=function(e,n,o){n===void 0&&(n=0),o===void 0&&(o=this.length);var r=[];return this.forEach(function(s,i){return r.push(e(s,i))},n,o),r};Ue.from=function(e){return e instanceof Ue?e:e&&e.length?new Ib(e):Ue.empty};var Ib=(function(t){function e(o){t.call(this),this.values=o}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(r,s){return r==0&&s==this.length?this:new e(this.values.slice(r,s))},e.prototype.getInner=function(r){return this.values[r]},e.prototype.forEachInner=function(r,s,i,a){for(var l=s;l<i;l++)if(r(this.values[l],a+l)===!1)return!1},e.prototype.forEachInvertedInner=function(r,s,i,a){for(var l=s-1;l>=i;l--)if(r(this.values[l],a+l)===!1)return!1},e.prototype.leafAppend=function(r){if(this.length+r.length<=la)return new e(this.values.concat(r.flatten()))},e.prototype.leafPrepend=function(r){if(this.length+r.length<=la)return new e(r.flatten().concat(this.values))},n.length.get=function(){return this.values.length},n.depth.get=function(){return 0},Object.defineProperties(e.prototype,n),e})(Ue);Ue.empty=new Ib([]);var ZA=(function(t){function e(n,o){t.call(this),this.left=n,this.right=o,this.length=n.length+o.length,this.depth=Math.max(n.depth,o.depth)+1}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(o){return o<this.left.length?this.left.get(o):this.right.get(o-this.left.length)},e.prototype.forEachInner=function(o,r,s,i){var a=this.left.length;if(r<a&&this.left.forEachInner(o,r,Math.min(s,a),i)===!1||s>a&&this.right.forEachInner(o,Math.max(r-a,0),Math.min(this.length,s)-a,i+a)===!1)return!1},e.prototype.forEachInvertedInner=function(o,r,s,i){var a=this.left.length;if(r>a&&this.right.forEachInvertedInner(o,r-a,Math.max(s,a)-a,i+a)===!1||s<a&&this.left.forEachInvertedInner(o,Math.min(r,a),s,i)===!1)return!1},e.prototype.sliceInner=function(o,r){if(o==0&&r==this.length)return this;var s=this.left.length;return r<=s?this.left.slice(o,r):o>=s?this.right.slice(o-s,r-s):this.left.slice(o,s).append(this.right.slice(0,r-s))},e.prototype.leafAppend=function(o){var r=this.right.leafAppend(o);if(r)return new e(this.left,r)},e.prototype.leafPrepend=function(o){var r=this.left.leafPrepend(o);if(r)return new e(r,this.right)},e.prototype.appendInner=function(o){return this.left.depth>=Math.max(this.right.depth,o.depth)+1?new e(this.left,new e(this.right,o)):new e(this,o)},e})(Ue);const eN=500;class Rt{constructor(e,n){this.items=e,this.eventCount=n}popEvent(e,n){if(this.eventCount==0)return null;let o=this.items.length;for(;;o--)if(this.items.get(o-1).selection){--o;break}let r,s;n&&(r=this.remapping(o,this.items.length),s=r.maps.length);let i=e.tr,a,l,c=[],d=[];return this.items.forEach((u,f)=>{if(!u.step){r||(r=this.remapping(o,f+1),s=r.maps.length),s--,d.push(u);return}if(r){d.push(new Kt(u.map));let p=u.step.map(r.slice(s)),m;p&&i.maybeStep(p).doc&&(m=i.mapping.maps[i.mapping.maps.length-1],c.push(new Kt(m,void 0,void 0,c.length+d.length))),s--,m&&r.appendMap(m,s)}else i.maybeStep(u.step);if(u.selection)return a=r?u.selection.map(r.slice(s)):u.selection,l=new Rt(this.items.slice(0,o).append(d.reverse().concat(c)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:i,selection:a}}addTransform(e,n,o,r){let s=[],i=this.eventCount,a=this.items,l=!r&&a.length?a.get(a.length-1):null;for(let d=0;d<e.steps.length;d++){let u=e.steps[d].invert(e.docs[d]),f=new Kt(e.mapping.maps[d],u,n),p;(p=l&&l.merge(f))&&(f=p,d?s.pop():a=a.slice(0,a.length-1)),s.push(f),n&&(i++,n=void 0),r||(l=f)}let c=i-o.depth;return c>nN&&(a=tN(a,c),i-=c),new Rt(a.append(s),i)}remapping(e,n){let o=new ds;return this.items.forEach((r,s)=>{let i=r.mirrorOffset!=null&&s-r.mirrorOffset>=e?o.maps.length-r.mirrorOffset:void 0;o.appendMap(r.map,i)},e,n),o}addMaps(e){return this.eventCount==0?this:new Rt(this.items.append(e.map(n=>new Kt(n))),this.eventCount)}rebased(e,n){if(!this.eventCount)return this;let o=[],r=Math.max(0,this.items.length-n),s=e.mapping,i=e.steps.length,a=this.eventCount;this.items.forEach(f=>{f.selection&&a--},r);let l=n;this.items.forEach(f=>{let p=s.getMirror(--l);if(p==null)return;i=Math.min(i,p);let m=s.maps[p];if(f.step){let b=e.steps[p].invert(e.docs[p]),y=f.selection&&f.selection.map(s.slice(l+1,p));y&&a++,o.push(new Kt(m,b,y))}else o.push(new Kt(m))},r);let c=[];for(let f=n;f<i;f++)c.push(new Kt(s.maps[f]));let d=this.items.slice(0,r).append(c).append(o),u=new Rt(d,a);return u.emptyItemCount()>eN&&(u=u.compress(this.items.length-o.length)),u}emptyItemCount(){let e=0;return this.items.forEach(n=>{n.step||e++}),e}compress(e=this.items.length){let n=this.remapping(0,e),o=n.maps.length,r=[],s=0;return this.items.forEach((i,a)=>{if(a>=e)r.push(i),i.selection&&s++;else if(i.step){let l=i.step.map(n.slice(o)),c=l&&l.getMap();if(o--,c&&n.appendMap(c,o),l){let d=i.selection&&i.selection.map(n.slice(o));d&&s++;let u=new Kt(c.invert(),l,d),f,p=r.length-1;(f=r.length&&r[p].merge(u))?r[p]=f:r.push(u)}}else i.map&&o--},this.items.length,0),new Rt(Ue.from(r.reverse()),s)}}Rt.empty=new Rt(Ue.empty,0);function tN(t,e){let n;return t.forEach((o,r)=>{if(o.selection&&e--==0)return n=r,!1}),t.slice(n)}class Kt{constructor(e,n,o,r){this.map=e,this.step=n,this.selection=o,this.mirrorOffset=r}merge(e){if(this.step&&e.step&&!e.selection){let n=e.step.merge(this.step);if(n)return new Kt(n.getMap().invert(),n,this.selection)}}}class Rn{constructor(e,n,o,r,s){this.done=e,this.undone=n,this.prevRanges=o,this.prevTime=r,this.prevComposition=s}}const nN=20;function oN(t,e,n,o){let r=n.getMeta(Ao),s;if(r)return r.historyState;n.getMeta(iN)&&(t=new Rn(t.done,t.undone,null,0,-1));let i=n.getMeta("appendedTransaction");if(n.steps.length==0)return t;if(i&&i.getMeta(Ao))return i.getMeta(Ao).redo?new Rn(t.done.addTransform(n,void 0,o,si(e)),t.undone,vf(n.mapping.maps),t.prevTime,t.prevComposition):new Rn(t.done,t.undone.addTransform(n,void 0,o,si(e)),null,t.prevTime,t.prevComposition);if(n.getMeta("addToHistory")!==!1&&!(i&&i.getMeta("addToHistory")===!1)){let a=n.getMeta("composition"),l=t.prevTime==0||!i&&t.prevComposition!=a&&(t.prevTime<(n.time||0)-o.newGroupDelay||!rN(n,t.prevRanges)),c=i?Nl(t.prevRanges,n.mapping):vf(n.mapping.maps);return new Rn(t.done.addTransform(n,l?e.selection.getBookmark():void 0,o,si(e)),Rt.empty,c,n.time,a??t.prevComposition)}else return(s=n.getMeta("rebased"))?new Rn(t.done.rebased(n,s),t.undone.rebased(n,s),Nl(t.prevRanges,n.mapping),t.prevTime,t.prevComposition):new Rn(t.done.addMaps(n.mapping.maps),t.undone.addMaps(n.mapping.maps),Nl(t.prevRanges,n.mapping),t.prevTime,t.prevComposition)}function rN(t,e){if(!e)return!1;if(!t.docChanged)return!0;let n=!1;return t.mapping.maps[0].forEach((o,r)=>{for(let s=0;s<e.length;s+=2)o<=e[s+1]&&r>=e[s]&&(n=!0)}),n}function vf(t){let e=[];for(let n=t.length-1;n>=0&&e.length==0;n--)t[n].forEach((o,r,s,i)=>e.push(s,i));return e}function Nl(t,e){if(!t)return null;let n=[];for(let o=0;o<t.length;o+=2){let r=e.map(t[o],1),s=e.map(t[o+1],-1);r<=s&&n.push(r,s)}return n}function sN(t,e,n){let o=si(e),r=Ao.get(e).spec.config,s=(n?t.undone:t.done).popEvent(e,o);if(!s)return null;let i=s.selection.resolve(s.transform.doc),a=(n?t.done:t.undone).addTransform(s.transform,e.selection.getBookmark(),r,o),l=new Rn(n?a:s.remaining,n?s.remaining:a,null,0,-1);return s.transform.setSelection(i).setMeta(Ao,{redo:n,historyState:l})}let Ml=!1,Sf=null;function si(t){let e=t.plugins;if(Sf!=e){Ml=!1,Sf=e;for(let n=0;n<e.length;n++)if(e[n].spec.historyPreserveItems){Ml=!0;break}}return Ml}const Ao=new Fe("history"),iN=new Fe("closeHistory");function aN(t={}){return t={depth:t.depth||100,newGroupDelay:t.newGroupDelay||500},new Me({key:Ao,state:{init(){return new Rn(Rt.empty,Rt.empty,null,0,-1)},apply(e,n,o){return oN(n,o,e,t)}},config:t,props:{handleDOMEvents:{beforeinput(e,n){let o=n.inputType,r=o=="historyUndo"?Nb:o=="historyRedo"?Mb:null;return r?(n.preventDefault(),r(e.state,e.dispatch)):!1}}}})}function Ab(t,e){return(n,o)=>{let r=Ao.getState(n);if(!r||(t?r.undone:r.done).eventCount==0)return!1;if(o){let s=sN(r,n,t);s&&o(e?s.scrollIntoView():s)}return!0}}const Nb=Ab(!1,!0),Mb=Ab(!0,!0);ve.create({name:"characterCount",addOptions(){return{limit:null,mode:"textSize",textCounter:t=>t.length,wordCounter:t=>t.split(" ").filter(e=>e!=="").length}},addStorage(){return{characters:()=>0,words:()=>0}},onBeforeCreate(){this.storage.characters=t=>{const e=t?.node||this.editor.state.doc;if((t?.mode||this.options.mode)==="textSize"){const o=e.textBetween(0,e.content.size,void 0," ");return this.options.textCounter(o)}return e.nodeSize},this.storage.words=t=>{const e=t?.node||this.editor.state.doc,n=e.textBetween(0,e.content.size," "," ");return this.options.wordCounter(n)}},addProseMirrorPlugins(){let t=!1;return[new Me({key:new Fe("characterCount"),appendTransaction:(e,n,o)=>{if(t)return;const r=this.options.limit;if(r==null||r===0){t=!0;return}const s=this.storage.characters({node:o.doc});if(s>r){const i=s-r,a=0,l=i;console.warn(`[CharacterCount] Initial content exceeded limit of ${r} characters. Content was automatically trimmed.`);const c=o.tr.deleteRange(a,l);return t=!0,c}t=!0},filterTransaction:(e,n)=>{const o=this.options.limit;if(!e.docChanged||o===0||o===null||o===void 0)return!0;const r=this.storage.characters({node:n.doc}),s=this.storage.characters({node:e.doc});if(s<=o||r>o&&s>o&&s<=r)return!0;if(r>o&&s>o&&s>r||!e.getMeta("paste"))return!1;const a=e.selection.$head.pos,l=s-o,c=a-l,d=a;return e.deleteRange(c,d),!(this.storage.characters({node:e.doc})>o)}})]}});var lN=ve.create({name:"dropCursor",addOptions(){return{color:"currentColor",width:1,class:void 0}},addProseMirrorPlugins(){return[UA(this.options)]}});ve.create({name:"focus",addOptions(){return{className:"has-focus",mode:"all"}},addProseMirrorPlugins(){return[new Me({key:new Fe("focus"),props:{decorations:({doc:t,selection:e})=>{const{isEditable:n,isFocused:o}=this.editor,{anchor:r}=e,s=[];if(!n||!o)return Ne.create(t,[]);let i=0;this.options.mode==="deepest"&&t.descendants((l,c)=>{if(l.isText)return;if(!(r>=c&&r<=c+l.nodeSize-1))return!1;i+=1});let a=0;return t.descendants((l,c)=>{if(l.isText||!(r>=c&&r<=c+l.nodeSize-1))return!1;if(a+=1,this.options.mode==="deepest"&&i-a>0||this.options.mode==="shallowest"&&a>1)return this.options.mode==="deepest";s.push(nt.node(c,c+l.nodeSize,{class:this.options.className}))}),Ne.create(t,s)}}})]}});var cN=ve.create({name:"gapCursor",addProseMirrorPlugins(){return[GA()]},extendNodeSchema(t){var e;const n={name:t.name,options:t.options,storage:t.storage};return{allowGapCursor:(e=ye(z(t,"allowGapCursor",n)))!=null?e:null}}}),dN=ve.create({name:"placeholder",addOptions(){return{emptyEditorClass:"is-editor-empty",emptyNodeClass:"is-empty",placeholder:"Write something â€¦",showOnlyWhenEditable:!0,showOnlyCurrent:!0,includeChildren:!1}},addProseMirrorPlugins(){return[new Me({key:new Fe("placeholder"),props:{decorations:({doc:t,selection:e})=>{const n=this.editor.isEditable||!this.options.showOnlyWhenEditable,{anchor:o}=e,r=[];if(!n)return null;const s=this.editor.isEmpty;return t.descendants((i,a)=>{const l=o>=a&&o<=a+i.nodeSize,c=!i.isLeaf&&ja(i);if((l||!this.options.showOnlyCurrent)&&c){const d=[this.options.emptyNodeClass];s&&d.push(this.options.emptyEditorClass);const u=nt.node(a,a+i.nodeSize,{class:d.join(" "),"data-placeholder":typeof this.options.placeholder=="function"?this.options.placeholder({editor:this.editor,node:i,pos:a,hasAnchor:l}):this.options.placeholder});r.push(u)}return this.options.includeChildren}),Ne.create(t,r)}}})]}});ve.create({name:"selection",addOptions(){return{className:"selection"}},addProseMirrorPlugins(){const{editor:t,options:e}=this;return[new Me({key:new Fe("selection"),props:{decorations(n){return n.selection.empty||t.isFocused||!t.isEditable||Cg(n.selection)||t.view.dragging?null:Ne.create(n.doc,[nt.inline(n.selection.from,n.selection.to,{class:e.className})])}}})]}});function kf({types:t,node:e}){return e&&Array.isArray(t)&&t.includes(e.type)||e?.type===t}var uN=ve.create({name:"trailingNode",addOptions(){return{node:"paragraph",notAfter:[]}},addProseMirrorPlugins(){const t=new Fe(this.name),e=Object.entries(this.editor.schema.nodes).map(([,n])=>n).filter(n=>(this.options.notAfter||[]).concat(this.options.node).includes(n.name));return[new Me({key:t,appendTransaction:(n,o,r)=>{const{doc:s,tr:i,schema:a}=r,l=t.getState(r),c=s.content.size,d=a.nodes[this.options.node];if(l)return i.insert(c,d.create())},state:{init:(n,o)=>{const r=o.tr.doc.lastChild;return!kf({node:r,types:e})},apply:(n,o)=>{if(!n.docChanged)return o;const r=n.doc.lastChild;return!kf({node:r,types:e})}}})]}}),pN=ve.create({name:"undoRedo",addOptions(){return{depth:100,newGroupDelay:500}},addCommands(){return{undo:()=>({state:t,dispatch:e})=>Nb(t,e),redo:()=>({state:t,dispatch:e})=>Mb(t,e)}},addProseMirrorPlugins(){return[aN(this.options)]},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Shift-Mod-z":()=>this.editor.commands.redo(),"Mod-y":()=>this.editor.commands.redo(),"Mod-Ñ":()=>this.editor.commands.undo(),"Shift-Mod-Ñ":()=>this.editor.commands.redo()}}}),fN=ve.create({name:"starterKit",addExtensions(){var t,e,n,o;const r=[];return this.options.bold!==!1&&r.push(zI.configure(this.options.bold)),this.options.blockquote!==!1&&r.push(jI.configure(this.options.blockquote)),this.options.bulletList!==!1&&r.push(bb.configure(this.options.bulletList)),this.options.code!==!1&&r.push(VI.configure(this.options.code)),this.options.codeBlock!==!1&&r.push(GI.configure(this.options.codeBlock)),this.options.document!==!1&&r.push(JI.configure(this.options.document)),this.options.dropcursor!==!1&&r.push(lN.configure(this.options.dropcursor)),this.options.gapcursor!==!1&&r.push(cN.configure(this.options.gapcursor)),this.options.hardBreak!==!1&&r.push(YI.configure(this.options.hardBreak)),this.options.heading!==!1&&r.push(XI.configure(this.options.heading)),this.options.undoRedo!==!1&&r.push(pN.configure(this.options.undoRedo)),this.options.horizontalRule!==!1&&r.push(QI.configure(this.options.horizontalRule)),this.options.italic!==!1&&r.push(oA.configure(this.options.italic)),this.options.listItem!==!1&&r.push(yb.configure(this.options.listItem)),this.options.listKeymap!==!1&&r.push(Cb.configure((t=this.options)==null?void 0:t.listKeymap)),this.options.link!==!1&&r.push(NA.configure((e=this.options)==null?void 0:e.link)),this.options.orderedList!==!1&&r.push(Eb.configure(this.options.orderedList)),this.options.paragraph!==!1&&r.push(_A.configure(this.options.paragraph)),this.options.strike!==!1&&r.push(WA.configure(this.options.strike)),this.options.text!==!1&&r.push(zA.configure(this.options.text)),this.options.underline!==!1&&r.push(HA.configure((n=this.options)==null?void 0:n.underline)),this.options.trailingNode!==!1&&r.push(uN.configure((o=this.options)==null?void 0:o.trailingNode)),r}}),mN=fN,hN=dN,gN=ve.create({name:"textAlign",addOptions(){return{types:[],alignments:["left","center","right","justify"],defaultAlignment:null}},addGlobalAttributes(){return[{types:this.options.types,attributes:{textAlign:{default:this.options.defaultAlignment,parseHTML:t=>{const e=t.style.textAlign;return this.options.alignments.includes(e)?e:this.options.defaultAlignment},renderHTML:t=>t.textAlign?{style:`text-align: ${t.textAlign}`}:{}}}}]},addCommands(){return{setTextAlign:t=>({commands:e})=>this.options.alignments.includes(t)?this.options.types.map(n=>e.updateAttributes(n,{textAlign:t})).every(n=>n):!1,unsetTextAlign:()=>({commands:t})=>this.options.types.map(e=>t.resetAttributes(e,"textAlign")).every(e=>e),toggleTextAlign:t=>({editor:e,commands:n})=>this.options.alignments.includes(t)?e.isActive({textAlign:t})?n.unsetTextAlign():n.setTextAlign(t):!1}},addKeyboardShortcuts(){return{"Mod-Shift-l":()=>this.editor.commands.setTextAlign("left"),"Mod-Shift-e":()=>this.editor.commands.setTextAlign("center"),"Mod-Shift-r":()=>this.editor.commands.setTextAlign("right"),"Mod-Shift-j":()=>this.editor.commands.setTextAlign("justify")}}}),bN=gN,yN=t=>{if(!t.children.length)return;const e=t.querySelectorAll("span");e&&e.forEach(n=>{var o,r;const s=n.getAttribute("style"),i=(r=(o=n.parentElement)==null?void 0:o.closest("span"))==null?void 0:r.getAttribute("style");n.setAttribute("style",`${i};${s}`)})},Tb=nn.create({name:"textStyle",priority:101,addOptions(){return{HTMLAttributes:{},mergeNestedSpanStyles:!0}},parseHTML(){return[{tag:"span",consuming:!1,getAttrs:t=>t.hasAttribute("style")?(this.options.mergeNestedSpanStyles&&yN(t),{}):!1}]},renderHTML({HTMLAttributes:t}){return["span",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{toggleTextStyle:t=>({commands:e})=>e.toggleMark(this.name,t),removeEmptyTextStyle:()=>({tr:t})=>{const{selection:e}=t;return t.doc.nodesBetween(e.from,e.to,(n,o)=>{if(n.isTextblock)return!0;n.marks.filter(r=>r.type===this.type).some(r=>Object.values(r.attrs).some(s=>!!s))||t.removeMark(o,o+n.nodeSize,this.type)}),!0}}}}),wN=ve.create({name:"backgroundColor",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{backgroundColor:{default:null,parseHTML:t=>{var e;return(e=t.style.backgroundColor)==null?void 0:e.replace(/['"]+/g,"")},renderHTML:t=>t.backgroundColor?{style:`background-color: ${t.backgroundColor}`}:{}}}}]},addCommands(){return{setBackgroundColor:t=>({chain:e})=>e().setMark("textStyle",{backgroundColor:t}).run(),unsetBackgroundColor:()=>({chain:t})=>t().setMark("textStyle",{backgroundColor:null}).removeEmptyTextStyle().run()}}}),Pb=ve.create({name:"color",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{color:{default:null,parseHTML:t=>{var e;return(e=t.style.color)==null?void 0:e.replace(/['"]+/g,"")},renderHTML:t=>t.color?{style:`color: ${t.color}`}:{}}}}]},addCommands(){return{setColor:t=>({chain:e})=>e().setMark("textStyle",{color:t}).run(),unsetColor:()=>({chain:t})=>t().setMark("textStyle",{color:null}).removeEmptyTextStyle().run()}}}),vN=ve.create({name:"fontFamily",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontFamily:{default:null,parseHTML:t=>t.style.fontFamily,renderHTML:t=>t.fontFamily?{style:`font-family: ${t.fontFamily}`}:{}}}}]},addCommands(){return{setFontFamily:t=>({chain:e})=>e().setMark("textStyle",{fontFamily:t}).run(),unsetFontFamily:()=>({chain:t})=>t().setMark("textStyle",{fontFamily:null}).removeEmptyTextStyle().run()}}}),SN=ve.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:t=>t.style.fontSize,renderHTML:t=>t.fontSize?{style:`font-size: ${t.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:t=>({chain:e})=>e().setMark("textStyle",{fontSize:t}).run(),unsetFontSize:()=>({chain:t})=>t().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),kN=ve.create({name:"lineHeight",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:null,parseHTML:t=>t.style.lineHeight,renderHTML:t=>t.lineHeight?{style:`line-height: ${t.lineHeight}`}:{}}}}]},addCommands(){return{setLineHeight:t=>({chain:e})=>e().setMark("textStyle",{lineHeight:t}).run(),unsetLineHeight:()=>({chain:t})=>t().setMark("textStyle",{lineHeight:null}).removeEmptyTextStyle().run()}}});ve.create({name:"textStyleKit",addExtensions(){const t=[];return this.options.backgroundColor!==!1&&t.push(wN.configure(this.options.backgroundColor)),this.options.color!==!1&&t.push(Pb.configure(this.options.color)),this.options.fontFamily!==!1&&t.push(vN.configure(this.options.fontFamily)),this.options.fontSize!==!1&&t.push(SN.configure(this.options.fontSize)),this.options.lineHeight!==!1&&t.push(kN.configure(this.options.lineHeight)),this.options.textStyle!==!1&&t.push(Tb.configure(this.options.textStyle)),t}});var xN=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))$/,CN=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))/g,EN=nn.create({name:"highlight",addOptions(){return{multicolor:!1,HTMLAttributes:{}}},addAttributes(){return this.options.multicolor?{color:{default:null,parseHTML:t=>t.getAttribute("data-color")||t.style.backgroundColor,renderHTML:t=>t.color?{"data-color":t.color,style:`background-color: ${t.color}; color: inherit`}:{}}}:{}},parseHTML(){return[{tag:"mark"}]},renderHTML({HTMLAttributes:t}){return["mark",Ee(this.options.HTMLAttributes,t),0]},addCommands(){return{setHighlight:t=>({commands:e})=>e.setMark(this.name,t),toggleHighlight:t=>({commands:e})=>e.toggleMark(this.name,t),unsetHighlight:()=>({commands:t})=>t.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-h":()=>this.editor.commands.toggleHighlight()}},addInputRules(){return[Do({find:xN,type:this.type})]},addPasteRules(){return[oo({find:CN,type:this.type})]}}),IN=EN;const AN=ve.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:t=>t.style.fontSize.replace(/['"]+/g,""),renderHTML:t=>t.fontSize?{style:`font-size: ${t.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:t=>({chain:e})=>e().setMark("textStyle",{fontSize:t+"px"}).run(),unsetFontSize:()=>({chain:t})=>t().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),NN=nn.create({name:"pendingHighlight",addAttributes(){return{}},parseHTML(){return[{tag:"mark","data-pending":"true"}]},renderHTML({HTMLAttributes:t}){return["mark",Ee(t,{"data-pending":"true"}),0]},addCommands(){return{setPendingHighlight:()=>({commands:t})=>t.setMark(this.name),togglePendingHighlight:()=>({commands:t})=>t.toggleMark(this.name),unsetPendingHighlight:()=>({commands:t})=>t.unsetMark(this.name)}}});function MN(){const t="Processing...",[e,n]=T.useState(0);return T.useEffect(()=>{const o=setInterval(()=>{n(r=>(r+1)%t.length)},150);return()=>clearInterval(o)},[t.length]),g.jsx("div",{className:"tw-fixed tw-inset-0 tw-z-[12000] tw-flex tw-items-center tw-justify-center tw-bg-slate-900/60 tw-backdrop-blur-sm",children:g.jsxs("div",{className:"tw-flex tw-items-center tw-gap-2 tw-bg-slate-800/80 tw-text-white tw-px-4 tw-py-2 tw-rounded-lg tw-shadow-xl",children:[g.jsx("div",{className:"tw-w-4 tw-h-4 tw-border-2 tw-border-white tw-border-t-transparent tw-rounded-full tw-animate-spin"}),g.jsx("div",{className:"tw-text-lg tw-font-semibold tw-flex",children:t.split("").map((o,r)=>g.jsxs("span",{className:`tw-transition-transform tw-duration-150 ${e===r?"tw-scale-125 tw-text-cyan-300":"tw-scale-100"}`,style:{display:"inline-block"},children:[o===" "?"Â ":o," "]},r))})]})})}const TN=ve.create({name:"hotkey",addOptions(){return{shortcuts:[]}},addKeyboardShortcuts(){const t={};return this.options.shortcuts.forEach(({hotkey:e,command:n})=>{e&&n&&(t[e]=()=>(n({editor:this.editor}),!0))}),t}}),ii={continue:`Instructions:
Continue the story below without repeating the story unless it is for literary effect. Include only the text you are adding. You should read what is before the tag and match the same style and tone, so the next text fits into the narrative properly.

Story: {{selection}}`,revise:`You will be doing a revision of text within the passage tags [passage][/passage]. You will include only text and not tags. Follow any instructions found in between [ ] inside of the passage.

[passage]{{selection}}[/passage]

Additional instructions for the revision if available (Ignore if not found):
{{instructions}}`,expand:`You are an expert prose editor...

<instructions>{#if instructions}{instructions}{#else}Expand the text further by fleshing out the details...{/if}</instructions>

Only return the expanded text, nothing else.

[passage]{{selection}}[/passage]`,shorten:`You are an expert prose editor...

{#if instructions}Shorten the prose to the following length: <instructions>{instructions}</instructions>{#else}Halve the length of the given prose.{/if}

Only return the condensed text, nothing else.

[passage]{{selection}}[/passage]`,rephrase:`You are an expert prose editor...

Rephrase it using the following instructions: <instructions>{instructions}</instructions>

Only return the rephrased text, nothing else.

[passage]{{selection}}[/passage]`,fromInstruction:`{{user_instructions}}

Read the story so far for context:
[STORY_CONTEXT]
{{story_context}}
[/STORY_CONTEXT]

Now, expand on the following scene beat:
[SCENE_BEAT]
{{selection}}
[/SCENE_BEAT]`};function PN(t){return t?.activeSessionId&&Array.isArray(t.chatSessions)&&t.chatSessions.find(e=>e?.id===t.activeSessionId)||null}function BN(t){if(typeof t=="string")return t;if(Array.isArray(t))return t.map(e=>e?.type==="text"&&e.text||"").filter(Boolean).join(`
`);if(t&&typeof t=="object")try{return JSON.stringify(t)}catch{return String(t)}return""}function ON(t,e,{action:n,selectionText:o,instructions:r}){if(!t||!e?.bookId)return{injected:!1,text:"",itemCount:0,mode:null,asOfChapter:null,worldName:null,bookName:null};const s=Array.isArray(e.history)?e.history.filter(l=>l&&(l.role==="user"||l.role==="assistant")).slice(-6).map(l=>BN(l.content)).filter(Boolean).join(`
`):"",i=String(o||""),a=[`inline-agent action: ${String(n||"")}`,String(r||""),i.length>1600?i.slice(-1600):i,s.length>1200?s.slice(-1200):s].filter(Boolean).join(`
`);try{const l=fd(t,e,{queryText:a,maxItems:10});return!l?.enabled||!l?.contextText?{injected:!1,text:"",itemCount:0,mode:l?.access?.mode||null,asOfChapter:l?.access?.asOfChapter??null,worldName:l?.world?.name||null,bookName:l?.book?.name||null}:{injected:!0,text:String(l.contextText||""),itemCount:Number(l?.diagnostics?.selectedItemCount)||0,mode:l?.access?.mode||null,asOfChapter:l?.access?.asOfChapter??null,worldName:l?.world?.name||null,bookName:l?.book?.name||null}}catch(l){return console.warn("Inline Agent world context build failed:",l),{injected:!1,text:"",itemCount:0,mode:null,asOfChapter:null,worldName:null,bookName:null}}}function LN(t){if(!t?.state?.selection)return null;const{state:e}=t,{selection:n,doc:o}=e,{$from:r}=n,s=(l,c)=>{if(!l||l.type?.name!=="instructionNode")return null;const d=Number(c),u=d+l.nodeSize,f=o.textBetween(d+1,u-1,`

`).trim()||String(l.textContent||"").trim();return f?{source:"instructionNode",instructionText:f,storyContext:o.textBetween(0,d,`

`),insertRange:{from:u,to:u},instructionRange:{from:d,to:u}}:null};for(let l=r.depth;l>0;l-=1){const c=r.node(l);if(c?.type?.name==="instructionNode")return s(c,r.before(l))}const i=r.nodeBefore;if(i?.type?.name==="instructionNode")return s(i,n.from-i.nodeSize);const a=r.nodeAfter;return a?.type?.name==="instructionNode"?s(a,n.from):null}function DN(t){const{finalAction:e,selectionText:n,storyContext:o,instructions:r,config:s}=t,i=ii[e];if(!i)return"";const a=s.userInstructions||"Expand the following scene beat into a full narrative scene. Match the existing tone and style.";return i.replace("{{selection}}",n).replace("{{story_context}}",o).replace("{{user_instructions}}",a).replace("{{instructions}}",r)}async function xf({action:t,editor:e,instructions:n=""}){if(!e)return;const{from:o,to:r,empty:s}=e.state.selection,i=h.getProject();if(!i){alert("No project is loaded.");return}let a=t,l="",c=e.state.doc.textBetween(o,r," "),d={from:o,to:r};if(t==="continue"){const C=LN(e);if(C)a="fromInstruction",c=C.instructionText,l=C.storyContext,d=C.insertRange;else{if(o<=1){alert("Please type something first to continue.");return}c=e.state.doc.textBetween(0,o,`

`),l=c,d={from:o,to:o}}}else if(s){alert(`Please select text to ${t}.`);return}const u=i.activeEntity?.name,f=i.agentPresets[u];if(!f){alert("Please select an active agent first.");return}const p=i.globalSettings?.inlineAgentConfig||{},m=f.systemPrompt,b=ii[a]||ii[t];let y=DN({finalAction:a,selectionText:c,storyContext:l,instructions:n,config:p});y||(y=(ii[t]||"").replace("{{selection}}",c).replace("{{instructions}}",n));const w=PN(i),v=ON(i,w,{action:a,selectionText:c,instructions:n}),S=String(v?.text||"");S&&(y=`${y}

[WORLD_CONTEXT]
${S}
[/WORLD_CONTEXT]

Use the WORLD_CONTEXT as canonical chapter/book context. Do not contradict it.`),h.bus.publish("composer:promptConstructed",{systemPrompt:m,actionPrompt:b,userText:a==="fromInstruction"?`[SCENE_BEAT]
${c}

[STORY_CONTEXT]
${l}`:c,finalAction:a,worldContextInjected:v?.injected===!0,worldContextText:S,worldContextItemCount:Number(v?.itemCount)||0,worldContextMode:v?.mode||null,worldContextAsOfChapter:v?.asOfChapter??null,worldContextWorldName:v?.worldName||null,worldContextBookName:v?.bookName||null}),h.bus.publish("composer:setLoading",{isLoading:!0});try{const I=(await Sa(f,[{role:"user",content:`${m}

${y}`}])).content.trim().split(`
`).map(A=>A.trimEnd()).filter(A=>A.trim()!=="").map(A=>({type:"paragraph",content:[{type:"text",text:A}]})),N=I.length>0?I:[{type:"paragraph"}];if(e.chain().focus().insertContentAt(d,{type:"suggestionNode",attrs:{"data-status":"pending"},content:N}).run(),e.state.doc.nodeAt(d.from)?.type?.name==="suggestionNode"){const A=Math.min(d.from+2,Math.max(1,e.state.doc.content.size));e.chain().focus().setTextSelection(A).run()}}catch(C){console.error("Inline Agent Error:",C),alert(`An error occurred: ${C.message}`)}finally{h.bus.publish("composer:setLoading",{isLoading:!1})}}function RN({x:t,y:e,onSelectAction:n,hasPendingSuggestion:o}){const r=["Continue","Revise","Expand","Shorten","Rephrase","more..."],s=["Accept","Reject","Rerun"],i=(a,l)=>{a.stopPropagation(),n(l)};return g.jsxs("div",{className:"tw-fixed tw-bg-gray-200 dark:tw-bg-gray-700 tw-text-black dark:tw-text-white tw-rounded-md tw-shadow-lg tw-p-2 tw-flex tw-gap-4 tw-select-none",style:{top:e,left:t,zIndex:11e3},onClick:a=>a.stopPropagation(),children:[g.jsxs("div",{className:`tw-flex tw-flex-col ${o?"tw-opacity-40 tw-pointer-events-none":""}`,children:[g.jsx("div",{className:"tw-px-2 tw-py-1 tw-bg-blue-500 tw-text-white tw-font-bold tw-rounded-t-sm tw-text-sm",children:"Action"}),g.jsx("ul",{className:"tw-bg-white dark:tw-bg-gray-600 tw-p-1 tw-rounded-b-sm",children:r.map(a=>g.jsx("li",{className:"tw-px-3 tw-py-1 hover:tw-bg-blue-500 hover:tw-text-white tw-rounded tw-cursor-pointer tw-text-sm",onClick:l=>i(l,a),children:a},a))})]}),g.jsxs("div",{className:`tw-flex tw-flex-col ${o?"":"tw-opacity-40 tw-pointer-events-none"}`,children:[g.jsx("div",{className:"tw-px-2 tw-py-1 tw-bg-yellow-400 tw-text-black tw-font-bold tw-rounded-t-sm tw-text-sm",children:"Decisions"}),g.jsx("ul",{className:"tw-bg-white dark:tw-bg-gray-600 tw-p-1 tw-rounded-b-sm",children:s.map(a=>g.jsx("li",{className:"tw-px-3 tw-py-1 hover:tw-bg-blue-500 hover:tw-text-white tw-rounded tw-cursor-pointer tw-text-sm",onClick:l=>i(l,a),children:a},a))})]})]})}function jN({systemPrompt:t,actionPrompt:e,userText:n,worldContextInjected:o,worldContextText:r,worldContextItemCount:s,worldContextMode:i,worldContextAsOfChapter:a,worldContextWorldName:l,worldContextBookName:c,isVisible:d,onClose:u}){return d?g.jsxs("div",{className:"inline-agent-inspector tw-absolute tw-top-4 tw-right-4 tw-z-[12000] tw-w-80 tw-rounded-lg tw-shadow-xl tw-flex tw-flex-col",children:[g.jsxs("div",{className:"inline-agent-inspector__header tw-flex tw-items-center tw-justify-between tw-p-2 tw-rounded-t-lg",children:[g.jsxs("h4",{className:"inline-agent-inspector__title tw-text-sm tw-font-bold tw-flex tw-items-center tw-gap-2",children:[g.jsx("span",{className:"material-symbols-outlined inline-agent-inspector__title-icon",children:"bug_report"}),"Inline Agent Inspector"]}),g.jsx("button",{onClick:u,className:"inline-agent-inspector__close-btn",type:"button","aria-label":"Close Inspector",children:"Ã—"})]}),g.jsxs("div",{className:"inline-agent-inspector__body tw-p-3 tw-text-xs tw-overflow-y-auto tw-max-h-80",children:[g.jsxs("div",{className:"inline-agent-inspector__section tw-mb-3",children:[g.jsx("p",{className:"inline-agent-inspector__label tw-font-bold tw-mb-1",children:"1. System Prompt:"}),g.jsx("pre",{className:"inline-agent-inspector__prompt",dir:"auto",children:t||"(Not available)"})]}),g.jsxs("div",{className:"inline-agent-inspector__section tw-mb-3",children:[g.jsx("p",{className:"inline-agent-inspector__label tw-font-bold tw-mb-1",children:"2. Action Prompt (e.g., Continue):"}),g.jsx("pre",{className:"inline-agent-inspector__prompt",dir:"auto",children:e||"(Not available)"})]}),g.jsxs("div",{className:"inline-agent-inspector__section",children:[g.jsx("p",{className:"inline-agent-inspector__label tw-font-bold tw-mb-1",children:"3. User Text (Selection/Context):"}),g.jsx("pre",{className:"inline-agent-inspector__prompt",dir:"auto",children:n||"(No text selected/available)"})]}),g.jsxs("div",{className:"inline-agent-inspector__section tw-mt-3",children:[g.jsx("p",{className:"inline-agent-inspector__label tw-font-bold tw-mb-1",children:"4. World Context (Chapter/Codex):"}),g.jsx("div",{className:"inline-agent-inspector__prompt",dir:"auto",children:o?g.jsxs(g.Fragment,{children:[g.jsxs("div",{className:"tw-mb-2",children:["Injected: Yes",Number.isFinite(Number(s))?` â€¢ ${Math.max(0,Math.round(Number(s)))} item(s)`:"",i?` â€¢ mode: ${i}`:"",Number.isFinite(Number(a))?` â€¢ as-of Ch.${Math.round(Number(a))}`:"",c?` â€¢ book: ${c}`:"",l?` â€¢ world: ${l}`:""]}),g.jsx("pre",{className:"inline-agent-inspector__prompt tw-m-0",dir:"auto",children:r||"(No world context text)"})]}):g.jsxs("span",{children:["Not injected",c?` â€¢ book: ${c}`:"",l?` â€¢ world: ${l}`:""," ","(",r?"context unavailable after filtering":"no chapter/book world context for this composer run",")"]})})]})]})]}):null}const _N=lt.create({name:"instructionNode",group:"block",content:"block+",parseHTML(){return[{tag:'div[data-type="instruction-chunk"]'}]},renderHTML({HTMLAttributes:t}){return["div",Ee(t,{"data-type":"instruction-chunk"}),0]},addCommands(){return{setInstructionNode:()=>({commands:t})=>t.insertContent({type:this.name,content:[{type:"paragraph"}]})}}});function Cf(t,e){const{selection:n}=t;if(!n)return null;if(n.node&&n.node.type?.name===e)return{node:n.node,from:n.from,to:n.to,pos:n.from};const o=n.$from;for(let i=o.depth;i>0;i-=1){const a=o.node(i);if(a?.type?.name!==e)continue;const l=o.before(i);return{node:a,from:l,to:l+a.nodeSize,pos:l}}const r=o.nodeBefore;if(r?.type?.name===e){const i=n.from-r.nodeSize;return{node:r,from:i,to:n.from,pos:i}}const s=o.nodeAfter;return s?.type?.name===e?{node:s,from:n.from,to:n.from+s.nodeSize,pos:n.from}:null}const $N=lt.create({name:"suggestionNode",group:"block",content:"block+",addAttributes(){return{"data-status":{default:"pending"}}},parseHTML(){return[{tag:'div[data-type="suggestion-chunk"]',getAttrs:t=>({"data-status":t.getAttribute("data-status")||"pending"})}]},renderHTML({HTMLAttributes:t}){return["div",Ee(t,{"data-type":"suggestion-chunk"}),0]},addProseMirrorPlugins(){return[new Me({key:new Fe("suggestionAutoAccept"),appendTransaction:(t,e,n)=>{let o=n.tr,r=!1;return t.some(s=>s.docChanged)?(n.doc.nodesBetween(0,n.doc.content.size,(s,i)=>{if(s.type.name===this.name&&s.attrs["data-status"]==="pending"){const a=e.doc.nodeAt(i),l=!a||a.type.name!==this.name,c=!a||!a.content.eq(s.content);!l&&c&&(console.log("Change detected inside a pending suggestion. Accepting it."),o.setNodeMarkup(i,null,{...s.attrs,"data-status":"accepted"}),r=!0)}}),r?o:null):null}})]},addCommands(){return{setSuggestionNode:t=>({commands:e})=>e.insertContent({type:this.name,attrs:{"data-status":"pending"},content:t}),acceptSuggestion:()=>({state:t,dispatch:e})=>{const n=Cf(t,this.name);if(!n?.node)return!1;const o=t.tr.replaceWith(n.from,n.to,n.node.content);return e(o.scrollIntoView()),!0},rejectSuggestion:()=>({state:t,dispatch:e})=>{const n=Cf(t,this.name);if(!n?.node)return!1;const o=t.tr.delete(n.from,n.to);return e(o.scrollIntoView()),!0}}}}),FN=({editor:t,onCollapse:e,onToggleMaximize:n,isMaximized:o,onExport:r,onToggleInspector:s,onTogglePeekChat:i,isPeekChat:a})=>{if(!t)return null;const[l,c]=ot.useState(0),[d,u]=T.useState(!1),[f,p]=T.useState(!1);ot.useEffect(()=>{const y=()=>c(w=>w+1);return t.on("transaction",y),t.on("selectionUpdate",y),()=>{t.off("transaction",y),t.off("selectionUpdate",y)}},[t]);const m=y=>{const w=y.target.value;w?t.chain().focus().setFontSize(w).run():t.chain().focus().unsetFontSize().run()},b=t.getAttributes("textStyle").fontSize?.replace("px","")||"";return g.jsxs(g.Fragment,{children:[g.jsxs("div",{className:"composer-header tw-flex tw-items-center tw-justify-between tw-p-2 tw-border-b tw-border-gray-700 tw-flex-wrap tw-gap-y-2",children:[g.jsx("div",{className:"composer-title-area",children:g.jsxs("h3",{children:[g.jsx("span",{className:"material-symbols-outlined",children:"edit_square"})," Composer"]})}),g.jsxs("div",{className:"composer-tools-area tw-flex tw-flex-wrap",children:[g.jsxs("div",{className:"tw-flex tw-items-center tw-gap-x-1",children:[g.jsx("button",{onClick:()=>t.chain().focus().setParagraph().run(),className:t.isActive("paragraph")?"is-active":"",title:"Paragraph",children:"P"}),g.jsx("button",{onClick:()=>t.chain().focus().toggleHeading({level:1}).run(),className:t.isActive("heading",{level:1})?"is-active":"",title:"Heading 1",children:"H1"}),g.jsx("button",{onClick:()=>t.chain().focus().toggleHeading({level:2}).run(),className:t.isActive("heading",{level:2})?"is-active":"",title:"Heading 2",children:"H2"}),g.jsx("button",{onClick:()=>t.chain().focus().toggleHeading({level:1}).run(),className:t.isActive("heading",{level:3})?"is-active":"",title:"Heading 3",children:"H3"}),g.jsx("button",{onClick:()=>t.chain().focus().toggleHeading({level:2}).run(),className:t.isActive("heading",{level:4})?"is-active":"",title:"Heading 4",children:"H4"})]}),g.jsx("div",{className:"toolbar-divider"}),g.jsxs("div",{className:"tw-flex tw-items-center tw-gap-x-1",children:[g.jsxs("select",{onChange:m,value:b,className:"font-size-selector",children:[g.jsx("option",{value:"",children:"Default"}),g.jsx("option",{value:"12",children:"12px"}),g.jsx("option",{value:"14",children:"14px"}),g.jsx("option",{value:"16",children:"16px"}),g.jsx("option",{value:"18",children:"18px"}),g.jsx("option",{value:"20",children:"20px"}),g.jsx("option",{value:"24",children:"24px"}),g.jsx("option",{value:"32",children:"32px"})]}),g.jsx("button",{onClick:()=>t.chain().focus().toggleHighlight().run(),className:t.isActive("highlight")?"btn-icon small is-active":"btn-icon small",title:"Highlight Text",children:g.jsx("span",{className:"material-symbols-outlined",children:"ink_highlighter"})}),g.jsx("input",{type:"color",onInput:y=>t.chain().focus().setColor(y.target.value).run(),value:t.getAttributes("textStyle").color||"#000000",title:"Text Color"})]}),g.jsx("div",{className:"toolbar-divider"}),g.jsx("button",{onClick:()=>t.chain().focus().unsetColor().run(),title:"Reset Color",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_clear"})}),g.jsx("div",{className:"toolbar-divider"}),g.jsxs("div",{className:"tw-flex tw-items-center",children:[g.jsx("button",{onClick:()=>t.chain().focus().toggleBold().run(),className:t.isActive("bold")?"btn-icon small is-active":"btn-icon small",title:"Bold",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_bold"})}),g.jsx("button",{onClick:()=>t.chain().focus().toggleItalic().run(),className:t.isActive("italic")?"btn-icon small is-active":"btn-icon small",title:"Italic",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_italic"})}),g.jsx("button",{onClick:()=>t.chain().focus().toggleUnderline().run(),className:t.isActive("underline")?"btn-icon small is-active":"btn-icon small",title:"Underline",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_underlined"})}),g.jsx("button",{onClick:()=>t.chain().focus().toggleStrike().run(),className:t.isActive("strike")?"btn-icon small is-active":"btn-icon small",title:"Strikethrough",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_strikethrough"})})]}),g.jsx("div",{className:"toolbar-divider"}),g.jsx("button",{onClick:()=>t.chain().focus().setTextAlign("left").run(),className:t.isActive({textAlign:"left"})?"btn-icon small is-active":"btn-icon small",title:"Align Left",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_align_left"})}),g.jsx("button",{onClick:()=>t.chain().focus().setTextAlign("center").run(),className:t.isActive({textAlign:"center"})?"btn-icon small is-active":"btn-icon small",title:"Align Center",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_align_center"})}),g.jsx("button",{onClick:()=>t.chain().focus().setTextAlign("right").run(),className:t.isActive({textAlign:"right"})?"btn-icon small is-active":"btn-icon small",title:"Align Right",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_align_right"})}),g.jsx("div",{className:"toolbar-divider"}),g.jsx("button",{onClick:()=>t.chain().focus().toggleBlockquote().run(),className:t.isActive("blockquote")?"btn-icon small is-active":"btn-icon small",title:"Blockquote",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_quote"})}),g.jsx("button",{onClick:()=>t.chain().focus().toggleBulletList().run(),className:t.isActive("bulletList")?"btn-icon small is-active":"btn-icon small",title:"Bulleted List",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_list_bulleted"})}),g.jsx("button",{onClick:()=>t.chain().focus().toggleOrderedList().run(),className:t.isActive("orderedList")?"btn-icon small is-active":"btn-icon small",title:"Numbered List",children:g.jsx("span",{className:"material-symbols-outlined",children:"format_list_numbered"})})]}),g.jsxs("div",{className:"composer-actions tw-flex-shrink-0",children:[g.jsx("button",{className:"btn-icon",onClick:s,title:"Toggle Prompt Inspector",children:g.jsx("span",{className:"material-symbols-outlined",children:"bug_report"})}),o&&g.jsx("button",{className:a?"btn-icon is-active":"btn-icon",onClick:i,title:a?"Hide Chat Peek":"Peek Chat",children:g.jsx("span",{className:"material-symbols-outlined",children:"splitscreen"})}),g.jsx("button",{className:"btn-icon",onClick:e,title:"Collapse",children:g.jsx("span",{className:"material-symbols-outlined",children:"keyboard_arrow_down"})}),g.jsx("button",{className:"btn-icon",onClick:n,title:o?"Restore":"Maximize",children:g.jsx("span",{className:"material-symbols-outlined",children:o?"close_fullscreen":"fullscreen"})}),g.jsxs("div",{className:"dropdown align-right",children:[g.jsx("button",{className:"btn-icon",onClick:y=>y.currentTarget.parentElement.classList.toggle("open"),title:"More Actions",children:g.jsx("span",{className:"material-symbols-outlined",children:"more_vert"})}),g.jsxs("div",{className:"dropdown-content",children:[g.jsxs("a",{href:"#",onClick:y=>{y.preventDefault(),u(!0)},children:[g.jsx("span",{className:"material-symbols-outlined",children:"smart_toy"}),"Configure Inline Agent"]}),g.jsx("div",{className:"dropdown-divider"}),g.jsxs("a",{href:"#",onClick:y=>{y.preventDefault(),typeof r=="function"?r({html:t.getHTML(),text:t.getText(),editor:t}):console.warn("onExport is not a function")},children:[g.jsx("span",{className:"material-symbols-outlined",children:"save"}),"Export Content..."]})]})]})]})]}),d&&g.jsx(DI,{unmount:()=>u(!1),onSave:LI,initialConfig:h.getProject()?.globalSettings?.inlineAgentConfig})]})};function WN({initialContent:t,onContentChange:e,onCollapse:n,onToggleMaximize:o,isMaximized:r,onExport:s,onReady:i,onTogglePeekChat:a,isPeekChat:l=!1}){const[c,d]=T.useState({visible:!1,x:0,y:0}),u=T.useRef(null),[f,p]=T.useState({visible:!1,x:0,y:0,text:"",sessionId:null}),[m,b]=T.useState("note"),[y,w]=T.useState({isLoading:!1}),[v,S]=T.useState(!1),[C,x]=T.useState({isVisible:!1,systemPrompt:"",actionPrompt:"",userText:"",worldContextInjected:!1,worldContextText:"",worldContextItemCount:0,worldContextMode:null,worldContextAsOfChapter:null,worldContextWorldName:null,worldContextBookName:null}),[I,N]=T.useState(!1),[E,A]=T.useState(!!l),L=j=>{j&&j.chain().focus().acceptSuggestion().run()},B=j=>{j&&j.chain().focus().rejectSuggestion().run()},G=()=>{p(j=>j.visible?{...j,visible:!1,text:""}:j)},K=(j=Q)=>{if(!j?.view?.dom)return null;const V=window.getSelection?.();if(!V||V.rangeCount===0||V.isCollapsed)return null;const W=String(V.toString()||"").trim();if(!W)return null;const O=V.getRangeAt(0),q=O.commonAncestorContainer instanceof Element?O.commonAncestorContainer:O.commonAncestorContainer?.parentElement;if(!q||!j.view.dom.contains(q))return null;const $=O.getBoundingClientRect();return!$||!$.width&&!$.height?null:{text:W,rect:$,sessionId:h.getProject()?.activeSessionId||null}},_=(j=Q)=>{if(c.visible){G();return}const V=K(j);if(!V){G();return}const W=340,O=44,q=8;let $=V.rect.left+V.rect.width/2-W/2;$=Math.max(10,Math.min($,window.innerWidth-W-10));let le=V.rect.top-O-q;le<10&&(le=V.rect.bottom+q),le=Math.max(10,Math.min(le,window.innerHeight-O-10)),p({visible:!0,x:Math.round($),y:Math.round(le),text:V.text,sessionId:V.sessionId||null})},me=()=>{const j=String(f.text||"").trim();j&&(h.bus.publish("world:addSelectionVerbatim",{text:j,type:m,sourceKind:"composer",sessionId:f.sessionId||null}),G())},Q=rE({extensions:[mN.configure({heading:{levels:[1,2,3,4]}}),IN,hN.configure({placeholder:"à¸žà¸´à¸¡à¸žà¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸—à¸µà¹ˆà¸™à¸µà¹ˆ..."}),bN.configure({types:["heading","paragraph"]}),Tb,Pb,AN,NN,_N,$N,TN.configure({shortcuts:[{hotkey:"\\",command:({editor:j})=>xf({action:"continue",editor:j})},{hotkey:"=",command:({editor:j})=>L(j)},{hotkey:"Mod-Shift-i",command:({editor:j})=>j.chain().focus().setInstructionNode().run()}]})],content:t||"",onUpdate:({editor:j})=>e(j.getHTML()),onTransaction:({editor:j})=>{S(j.isActive("suggestionNode",{"data-status":"pending"}))},onSelectionUpdate:({editor:j})=>{S(j.isActive("suggestionNode",{"data-status":"pending"})),window.requestAnimationFrame(()=>_(j))},editorProps:{handleDOMEvents:{contextmenu:(j,V)=>(V.preventDefault(),G(),d({visible:!0,x:V.clientX,y:V.clientY}),!0)}}});T.useEffect(()=>{const j=q=>x($=>({...$,...q})),V=({isLoading:q})=>w({isLoading:q}),W=h.bus.subscribe("composer:promptConstructed",j),O=h.bus.subscribe("composer:setLoading",V);return()=>{W(),O()}},[]);const Oe=()=>{d({...c,visible:!1})};T.useEffect(()=>(c.visible&&document.addEventListener("click",Oe,{once:!0}),()=>document.removeEventListener("click",Oe)),[c.visible]),T.useEffect(()=>{if(!Q)return;const j=()=>{const W=document.activeElement;u.current&&(u.current.contains(W)||u.current.contains(document.activeElement))||window.requestAnimationFrame(()=>_())},V=()=>{f.visible&&window.requestAnimationFrame(()=>_())};return document.addEventListener("mouseup",j),document.addEventListener("keyup",j),window.addEventListener("resize",V),window.addEventListener("scroll",V,!0),()=>{document.removeEventListener("mouseup",j),document.removeEventListener("keyup",j),window.removeEventListener("resize",V),window.removeEventListener("scroll",V,!0)}},[Q,c.visible,f.visible]),T.useEffect(()=>{Q&&t!==void 0&&Q.getHTML()!==t&&Q.commands.setContent(t||"",!1)},[t,Q]),T.useEffect(()=>{A(!!l)},[l,r]);const ae=()=>{if(typeof a!="function")return;const j=a();A(typeof j=="boolean"?j:V=>!V)};return T.useEffect(()=>{Q&&i&&i({appendContent:V=>{Q&&(Q.getText().trim().length>0&&Q.chain().focus().insertContent("<hr>").run(),Q.chain().focus().insertContent(V).run())}})},[Q,i]),g.jsxs("div",{id:"composer-panel",className:"composer-panel tw-relative",children:[g.jsx(FN,{editor:Q,onCollapse:n,onToggleMaximize:o,isMaximized:r,onExport:s,onToggleInspector:()=>x(j=>({...j,isVisible:!j.isVisible})),onTogglePeekChat:ae,isPeekChat:E}),g.jsx(X0,{editor:Q,className:"composer-editor"}),y.isLoading&&g.jsx(MN,{}),g.jsxs("div",{ref:u,className:`selection-action-bar ${f.visible?"is-visible":""}`,"aria-hidden":f.visible?"false":"true",style:{left:f.x,top:f.y},onMouseDown:j=>{j.target.closest(".selection-action-btn")&&j.preventDefault()},onClick:j=>j.stopPropagation(),children:[g.jsx("div",{className:"selection-action-bar__label",children:"Selected text"}),g.jsxs("select",{className:"selection-action-select",value:m,onChange:j=>b(j.target.value),"aria-label":"Codex item type",children:[g.jsx("option",{value:"note",children:"Note"}),g.jsx("option",{value:"entity",children:"Entity"}),g.jsx("option",{value:"place",children:"Place"}),g.jsx("option",{value:"rule",children:"Rule"}),g.jsx("option",{value:"event",children:"Event"})]}),g.jsx("button",{type:"button",className:"selection-action-btn",onClick:me,children:"Add to Codex"})]}),c.visible&&g.jsx(RN,{x:c.x,y:c.y,hasPendingSuggestion:v,onSelectAction:j=>{const V=j.toLowerCase();["accept","reject","rerun"].includes(V)?(V==="accept"&&L(Q),V==="reject"&&B(Q)):xf({action:V.replace("...",""),editor:Q}),Oe()}}),g.jsx(jN,{...C,onClose:()=>x(j=>({...j,isVisible:!1}))})]})}const zN=new Set(["black","#000","#000000","rgb(0,0,0)","rgba(0,0,0,1)","hsl(0,0%,0%)"]),HN=new Set(["transparent","rgba(0,0,0,0)","initial","inherit","unset","none"]);function UN(t=""){return String(t).trim().toLowerCase().replace(/\s+/g,"")}function Bb(t="",{forExport:e=!1}={}){if(!t||typeof t!="string")return"";const n=document.createElement("div");return n.innerHTML=t,n.querySelectorAll("*").forEach(o=>{const r=o.getAttribute("style");if(r){const s=[];r.split(";").forEach(i=>{const[a,...l]=i.split(":"),c=l.join(":");if(!a||!c)return;const d=a.trim().toLowerCase(),u=c.trim(),f=UN(u);e&&(d==="color"||d==="background-color")||!e&&d==="color"&&zN.has(f)||!e&&d==="background-color"&&HN.has(f)||s.push(`${d}: ${u}`)}),s.length?o.setAttribute("style",s.join("; ")):o.removeAttribute("style")}e&&(o.removeAttribute("color"),o.removeAttribute("bgcolor"))}),n.innerHTML}function ca(t=""){return Bb(t,{forExport:!1})}function Ef(t="",e=""){if(String(e||"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim())return!0;if(!t||typeof t!="string")return!1;const o=document.createElement("div");return o.innerHTML=t,String(o.textContent||"").replace(/\u00A0/g," ").replace(/[\u200B-\u200D\uFEFF]/g,"").trim()?!0:!!o.querySelector("img,video,audio,iframe,canvas,svg,math,hr,table,pre,code,blockquote,ul,ol,li")}function VN(t){const e=h.getProject(),n=e?.chatSessions.find(r=>r.id===e.activeSessionId),o=ca(t);n&&n.composerContent!==o&&(n.composerContent=o,h.updateAndPersistState())}function qN(t){const e=document.createElement("div");e.innerHTML=Bb(t||"",{forExport:!0});const n=new Set(["font-size","text-align"]);return e.querySelectorAll("*").forEach(o=>{const r=o.getAttribute("style");if(r){const s=[];r.split(";").forEach(i=>{const[a,l]=i.split(":");if(!a||!l)return;const c=a.trim().toLowerCase(),d=l.trim();n.has(c)&&d&&s.push(`${c}: ${d}`)}),s.length?o.setAttribute("style",s.join("; ")):o.removeAttribute("style")}if(o.classList&&o.classList.length>0){const s=[];o.classList.forEach(i=>{(i.startsWith("hljs")||i.startsWith("language-"))&&s.push(i)}),o.className=s.join(" ")}}),e.innerHTML}function Ob({html:t="",text:e=""}={}){try{const n=typeof t=="string"?t:"",o=typeof e=="string"?e:"",r=h.getProject(),s=r?.chatSessions.find(v=>v.id===r.activeSessionId),i=s?.name||"Untitled Composer",a=typeof s?.composerContent=="string"?s.composerContent:"";if(!Ef(n,o)){Ef(a,"")||k("Composer is empty. Nothing to export.","Export Composer");return}const l=n.trim(),c=new Date,d=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}-${String(c.getDate()).padStart(2,"0")}_${String(c.getHours()).padStart(2,"0")}${String(c.getMinutes()).padStart(2,"0")}`,f=`${i.replace(/[^a-z0-9\u0E00-\u0E7F]/gi,"_").toLowerCase()}_${d}.html`,m=`<!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8">
    <title>Composer Export</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.65;
            padding: 24px;
            max-width: 860px;
            margin: auto;
            background: #ffffff;
            color: #111827;
        }
            .composer-export-content {
                background: #ffffff;
                color: #111827;
            }
            h1,h2,h3 { line-height: 1.25; margin: 1.2em 0 0.6em; }
            p { margin: 0.6em 0; }
            blockquote { margin: 1em 0; padding-left: 0.9rem; border-left: 3px solid #999; font-style: italic; opacity: .95; }
            ul,ol { padding-left: 1.2em; margin: 0.6em 0; }
            pre {
                background-color: #f6f8fa;
                padding: 16px;
                border-radius: 6px;
                overflow-x: auto;
            }
            code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
            mark { background-color: #ffeb3b; padding: 0 2px; border-radius: 2px; }
    </style>
        </head>
        <body>
        <article class="composer-export-content">${qN(l)}</article>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script>
            <script>
            if (window.hljs && typeof window.hljs.highlightAll === 'function') {
                window.hljs.highlightAll();
            }
            <\/script>
        </body>
    </html>`,b=new Blob([m],{type:"text/html;charset=utf-8"}),y=URL.createObjectURL(b),w=document.createElement("a");w.href=y,w.download=f,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(y)}catch(n){console.error("exportComposerContent error:",n),k("Export failed. See console for details.","Error")}}const lr=document.getElementById("composer-panel"),Jt=document.querySelector(".main-content-wrapper"),Tl=document.querySelector(".main-chat-area");function Fc(){return!!Jt?.classList.contains("composer-peek-chat")}function KN(t){return Jt?Jt.classList.contains("composer-maximized")?(Jt.classList.toggle("composer-peek-chat",!!t),Fc()):(Jt.classList.remove("composer-peek-chat"),!1):!1}function GN(t,e){if(!lr)return;const n={initialContent:t,isMaximized:e,onContentChange:VN,onCollapse:()=>Et("collapsed"),onToggleMaximize:()=>{const o=Jt.classList.contains("composer-maximized");Et(o?"normal":"maximized")},onTogglePeekChat:()=>KN(!Fc()),isPeekChat:Fc(),onExport:o=>{const r=typeof o?.html=="string"?o.html:"",s=typeof o?.text=="string"?o.text:"";Ob({html:r,text:s}),h.bus.publish("composer:export")},onReady:o=>{h.setState("composerApi",o)}};ao.mount(WN,n,lr)}function JN(){ao.unmount(lr),h.setState("composerApi",null)}function Et(t){if(!lr||!Jt||!Tl)return;Jt.classList.remove("composer-maximized"),Jt.classList.remove("composer-peek-chat"),Tl.classList.remove("composer-is-active"),lr.classList.remove("collapsed");const e=h.getProject(),n=e?.chatSessions.find(s=>s.id===e.activeSessionId),o=n?.composerContent||"",r=ca(o);switch(n&&o!==r&&(n.composerContent=r,h.updateAndPersistState()),t){case"collapsed":JN(),lr.classList.add("collapsed");break;case"normal":case"maximized":Tl.classList.add("composer-is-active"),t==="maximized"&&Jt.classList.add("composer-maximized"),GN(r,t==="maximized");break}localStorage.setItem("promptPrimComposerState",t),h.bus.publish("composer:visibilityChanged")}document.getElementById("mobile-composer-toggle");function YN(t){const e=document.querySelector("#composer-editor .composer-content-area");e&&(e.innerHTML="")}const XN=768;function Lb(){return window.matchMedia(`(max-width: ${XN}px)`).matches}function Or(t){const n={newProject:{name:"project:new"},openProject:{name:"project:open"},saveProject:{name:"project:save",data:!1},saveProjectAs:{name:"project:save",data:!0},exportChat:{name:"project:exportChat"}}[t];return n?(h.bus.publish(n.name,n.data),!0):!1}function QN(){return[{label:"New...",action:()=>Or("newProject")},{label:"Open...",action:()=>Or("openProject")},{label:"Save",action:()=>Or("saveProject")},{label:"Save As...",action:()=>Or("saveProjectAs")}]}function ZN(t){const e=t?.getBoundingClientRect(),n=Math.round(e?e.left+Math.min(e.width,56):window.innerWidth/2),o=e?Math.round(e.bottom+8):56;return{clientX:n,clientY:o,preventDefault(){},stopPropagation(){}}}function If(t,e){if(!Lb())return!1;const n=t&&typeof t.clientX=="number"&&typeof t.clientY=="number"?t:ZN(e);return aw(QN(),n),!0}function ai(t){const e=document.getElementById("project-title");if(e){const n=h.isUserDirty(),o=t||h.getProject()?.name||"Untitled";e.textContent=n?`${o} *`:o}}function eM(){const t=document.getElementById("save-project-modal"),e=document.getElementById("project-name-input"),n=h.getProject();e.value=n?`${n.name} - Copy`:"Untitled Project",t.style.display="flex",e.focus(),e.select()}function Af(){const t=document.getElementById("save-project-modal");t.style.display="none"}function tM(){h.bus.subscribe("project:loaded",o=>{ai(o.projectData.name)}),h.bus.subscribe("project:nameChanged",o=>ai(o)),h.bus.subscribe("userDirty:changed",()=>ai()),h.bus.subscribe("ui:showSaveAsModal",eM);const t=document.querySelector("#project-menu-dropdown")||document.querySelector(".sidebar-bottom-row .dropdown");if(t){const o=t.querySelector("button");o&&o.addEventListener("click",Ea),t.addEventListener("click",r=>{const s=r.target.closest("a");if(!s)return;const i=s.dataset.action;i&&(r.preventDefault(),Or(i),t.classList.remove("open"))})}const e=document.querySelector(".chat-header .app-main-title");e&&(e.classList.add("project-menu-mobile-trigger"),e.setAttribute("role","button"),e.setAttribute("tabindex","0"),e.setAttribute("aria-label","Open project menu"),e.title="Project menu",e.addEventListener("click",o=>{If(o,e)}),e.addEventListener("keydown",o=>{Lb()&&(o.key!=="Enter"&&o.key!==" "||(o.preventDefault(),If(null,e)))}));const n=document.getElementById("save-project-modal");n&&n.addEventListener("click",o=>{if(o.target.matches(".btn:not(.btn-secondary)")){const r=document.getElementById("project-name-input").value.trim();r?(h.bus.publish("project:saveConfirm",{projectName:r}),Af()):k("Please enter a project name.")}else(o.target.matches(".btn-secondary")||o.target===n)&&Af()}),document.getElementById("load-project-input")?.addEventListener("change",o=>h.bus.publish("project:fileSelectedForOpen",o)),console.log("Project UI Initialized with definitive listeners.")}const Hs={temperature:{label:"Temperature",provider:"all",type:"range",min:0,max:2,step:.01,default:1,tooltip:"Controls randomness. Higher is more creative."},top_p:{label:"Top P",provider:"all",type:"range",min:0,max:1,step:.01,default:1,tooltip:"Controls diversity via nucleus sampling."},top_k:{label:"Top K",provider:"all",type:"range",min:0,max:100,step:1,default:0,tooltip:"Limits sampling to the K most likely tokens."},max_tokens:{label:"Max Tokens",provider:"all",type:"range",min:1,max:32768,step:1,default:4096,tooltip:"The maximum number of tokens to generate."},frequency_penalty:{label:"Frequency Penalty",provider:"all",type:"range",min:-2,max:2,step:.01,default:0,tooltip:"Reduces the likelihood of repeating the same lines."},presence_penalty:{label:"Presence Penalty",provider:"all",type:"range",min:-2,max:2,step:.01,default:0,tooltip:"Reduces the likelihood of repeating existing topics."},seed:{label:"Seed",provider:"all",type:"number",default:-1,tooltip:"Use -1 for random output, or a specific number for deterministic output."},stop_sequences:{label:"Stop Sequences",provider:"all",type:"text",default:"",tooltip:"Comma-separated list of sequences to stop generation."},logit_bias:{label:"Logit Bias",provider:"openrouter",type:"textarea",default:"",tooltip:'Advanced: Enter "token:bias" pairs (e.g., "123:-1, 456:1.5").'},mirostat:{label:"Mirostat",provider:"ollama",type:"select",options:[0,1,2],default:0,tooltip:"Enables Mirostat sampling (0 = disabled, 1 = v1, 2 = v2)."},mirostat_tau:{label:"Mirostat Tau",provider:"ollama",type:"range",min:0,max:10,step:.1,default:5,tooltip:"Controls the balance between coherence and diversity for Mirostat."},mirostat_eta:{label:"Mirostat Eta",provider:"ollama",type:"range",min:0,max:1,step:.01,default:.1,tooltip:"Controls the learning rate for Mirostat."},repeat_penalty:{label:"Repeat Penalty",provider:"ollama",type:"range",min:0,max:2,step:.01,default:1.1,tooltip:"Strongly penalizes repeating tokens. A higher value reduces repetition more."}};function nM(t,e,n){const o=n===void 0||n===""||n===null||n===e.default,r=o?"Default":n,s=o?"param-value":"param-value custom";let i="";const a=n==null||n===""?e.default:n;switch(e.type){case"range":i=`
                <input type="range" class="param-slider" data-control="slider"
                       min="${e.min}" max="${e.max}" 
                       step="${e.step}" value="${a}">
                <input type="number" class="param-input" data-control="input"
                       min="${e.min}" max="${e.max}" 
                       step="${e.step}" value="${a}">
                <button type="button" class="btn-link param-reset-btn" data-action="reset">Reset</button>
            `;break;case"number":i=`<input type="number" class="param-input-full" data-control="input" value="${a}" placeholder="${e.default}">`;break;case"text":i=`<input type="text" class="param-input-full" data-control="input" value="${a}" placeholder="${e.default}">`;break;case"textarea":i=`<textarea class="param-input-full" data-control="input" rows="3">${a}</textarea>`;break;case"select":i=`<select class="param-input-full" data-control="input">${e.options.map(c=>`<option value="${c}" ${c==a?"selected":""}>${c}</option>`).join("")}</select>`;break}return`
        <div class="param-wrapper" data-param-name="${t}">
            <div class="param-row" data-action="toggle">
                <span class="param-label" title="${e.tooltip}">${e.label}</span>
                <span class="${s}">${r}</span>
            </div>
            <div class="param-control hidden">
                ${i}
            </div>
        </div>
    `}function Db(t,e,n){if(!t)return null;let o="<h4>Core Parameters</h4>",r='<div id="ollama-section"><h4>Advanced (Ollama only)</h4>',s=!1;for(const c in Hs){const d=Hs[c],u=e?e[c]:void 0;if(d.provider==="all"||d.provider===n){const f=nM(c,d,u);d.provider==="ollama"?(r+=f,s=!0):o+=f}}console.log("Generated Core HTML:",o),console.log("Generated Ollama HTML:",r),r+="</div>",t.innerHTML=o+r;const i=t.querySelector("#ollama-section");i&&(i.style.display=n==="ollama"&&s?"block":"none");const a=c=>{const d=c.target.closest("[data-action]");if(!d)return;const u=d.closest(".param-wrapper");if(u){if(d.dataset.action==="toggle"){const f=u.querySelector(".param-control"),p=f.classList.contains("hidden");t.querySelectorAll(".param-control:not(.hidden)").forEach(m=>m.classList.add("hidden")),p&&f.classList.remove("hidden")}else if(d.dataset.action==="reset"){const f=u.dataset.paramName,p=Hs[f];u.querySelector(".param-value").textContent="Default",u.querySelector(".param-value").classList.remove("custom"),u.querySelectorAll("input, select, textarea").forEach(m=>m.value=p.default)}}},l=c=>{const d=c.target.closest("[data-control]");if(!d)return;const u=d.closest(".param-wrapper");if(!u)return;const f=u.querySelector(".param-value"),p=u.querySelector(".param-slider"),m=u.querySelector(".param-input");p&&m&&(d.dataset.control==="slider"?m.value=c.target.value:p.value=c.target.value),f.textContent=c.target.value,f.classList.add("custom")};return t.addEventListener("click",a),t.addEventListener("input",l),{getValues:()=>{const c={};return t.querySelectorAll(".param-wrapper").forEach(d=>{const u=d.dataset.paramName;if(d.querySelector(".param-value.custom")){const f=d.querySelector('[data-control="input"], .param-input-full');if(f){const p=Hs[u];c[u]=p.type==="range"||p.type==="number"?parseFloat(f.value):f.value}}}),c},destroy:()=>{t.removeEventListener("click",a),t.removeEventListener("input",l),t.innerHTML=""}}}function Wc(t){const e=t?.apiSettings?.providerEnabled||{};return{openrouter:e.openrouter!==!1,ollama:e.ollama!==!1,kieai:e.kieai!==!1}}function zc({isMaster:t,providerEnabled:e}){const n=document.getElementById("api-provider-switches"),o=document.getElementById("api-key-group"),r=document.getElementById("ollama-url-group"),s=document.getElementById("kieai-key-group"),i=document.getElementById("load-models-btn");if(n&&(n.style.display=t?"block":"none"),o&&(o.style.display=t&&e.openrouter?"block":"none"),r&&(r.style.display=t&&e.ollama?"block":"none"),s&&(s.style.display=t&&e.kieai?"block":"none"),i){const a=t&&(e.openrouter||e.ollama);i.style.display=a?"inline-block":"none",i.disabled=!a}}function oM(t){const e=h.getState().userProviderModels||[],n=e.filter(o=>o.provider==="openrouter"?t.openrouter:o.provider==="ollama"?t.ollama:!0);n.length!==e.length&&h.setUserModels(n)}function rM(){const t=document.getElementById("settings-modal");if(!t)return;const e=t.querySelector(".tab-buttons"),n=t.querySelectorAll(".tab-content"),o=document.getElementById("settings-mobile-menu-trigger"),r=t.querySelector(".mobile-menu-popup");console.log("--- 1. initTabs: Finding elements ---"),console.log("Mobile Trigger Button:",o),console.log("Mobile Popup Container:",r),console.log("Tab Buttons inside Popup:",r?.querySelector(".tab-buttons")),o?.addEventListener("click",s=>{s.stopPropagation();const i=t.querySelector(".mobile-menu-popup");i?i.classList.toggle("is-open"):console.error("Could not find '.mobile-menu-popup' inside the settings modal on click.")}),e?.addEventListener("click",s=>{const i=s.target.closest(".tab-btn");if(!i)return;const a=i.dataset.tab;e.querySelectorAll(".tab-btn").forEach(d=>d.classList.remove("active")),i.classList.add("active"),n.forEach(d=>{d.classList.toggle("active",d.dataset.tabContent===a)});const l=document.getElementById("settings-current-tab-name"),c=o.querySelector(".material-symbols-outlined");if(l&&c){const d=i.querySelector(".material-symbols-outlined").textContent,u=i.querySelector(".tab-btn-text");u&&(l.textContent=u.textContent.trim()),d&&(c.textContent=d)}r?.classList.remove("is-open")}),document.addEventListener("click",s=>{r?.classList.contains("is-open")&&!r.contains(s.target)&&!o.contains(s.target)&&r.classList.remove("is-open")})}function Lr(){const t=wt(),e=h.getProject();if(!e||!e.globalSettings)return;if(!t){zc({isMaster:!1,providerEnabled:{openrouter:!1,ollama:!1,kieai:!1}});return}const n=Sn(t),o=Wc(t),r=document.getElementById("kieAiApiKey"),s=document.getElementById("openrouter-enabled-toggle"),i=document.getElementById("ollama-enabled-toggle"),a=document.getElementById("kieai-enabled-toggle");r&&(r.value=t.apiSettings?.kieAiApiKey||""),s&&(s.checked=o.openrouter,s.disabled=!n),i&&(i.checked=o.ollama,i.disabled=!n),a&&(a.checked=o.kieai,a.disabled=!n),n&&(document.getElementById("apiKey").value=t.apiSettings?.openrouterKey||"",document.getElementById("ollamaBaseUrl").value=t.apiSettings?.ollamaBaseUrl||""),zc({isMaster:n,providerEnabled:o});const l=e.globalSettings.systemUtilityAgent||{};document.getElementById("system-utility-prompt").value=l.systemPrompt||"",Sm("settings-system-model-wrapper",l.model,Kn()),document.getElementById("system-utility-prompt").value=l.systemPrompt||"";const c=document.getElementById("system-utility-temperature"),d=document.getElementById("system-utility-topP");c&&(c.value=l.temperature??1),d&&(d.value=l.topP??1),Qs()}function sM(){Lr(),cw()}function iM(){rM();const t=h.bus;document.getElementById("load-models-btn")?.addEventListener("click",()=>{const o=wt();if(!o){k("User profile is not ready yet. Please reload the app and try again.","Settings");return}if(!Sn(o))return;const r=Wc(o),s=r.openrouter?document.getElementById("apiKey").value:"",i=r.ollama?document.getElementById("ollamaBaseUrl").value:"";t.publish("api:loadUserModels",{apiKey:s,ollamaBaseUrl:i,isUserKey:!0})}),[{inputId:"openrouter-enabled-toggle",key:"openrouter"},{inputId:"ollama-enabled-toggle",key:"ollama"},{inputId:"kieai-enabled-toggle",key:"kieai"}].forEach(({inputId:o,key:r})=>{document.getElementById(o)?.addEventListener("change",s=>{const i=wt();if(!i||!Sn(i))return;ss({providerEnabled:{[r]:s.target.checked}});const a=wt(),l=Wc(a);oM(l),zc({isMaster:!0,providerEnabled:l})})}),document.getElementById("apiKey")?.addEventListener("input",Tu(o=>{const r=wt();r&&Sn(r)&&ss({openrouterKey:o.target.value})},500)),t.subscribe("user:modelsLoaded",()=>{document.getElementById("settings-modal")?.style.display==="flex"&&Lr()}),document.getElementById("ollamaBaseUrl")?.addEventListener("input",Tu(o=>t.publish("settings:ollamaUrlChanged",o.target.value),500)),["system-utility-model-select","system-utility-prompt","system-utility-temperature","system-utility-topP"].forEach(o=>{document.getElementById(o)?.addEventListener("change",()=>t.publish("settings:systemAgentChanged"))}),document.querySelector("#settings-panel .modal-close-btn")?.addEventListener("click",lw),h.bus.subscribe("project:loaded",()=>{console.log("Project loaded. Re-rendering settings panel data."),Lr()}),h.bus.subscribe("models:loaded",()=>{const o=document.getElementById("settings-modal");o&&o.style.display==="flex"&&Lr()}),h.bus.subscribe("app:settingsChanged",()=>{const o=document.getElementById("settings-modal");o&&o.style.display==="flex"&&Lr()}),console.log("âœ… Settings UI Initialized.")}const Rb="agent-emoji-picker",aM="agent-emoji-picker-host",bo="emoji-picker-collapsed",lM="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js";let Ir=null;function cM(t,e){const o=h.getProject().activeEntity,r=h.getStagedEntity(),s=document.createElement("div");s.className="item agent-item",s.dataset.agentName=t,o?.type==="agent"&&o.name===t?s.classList.add("active"):r?.type==="agent"&&r.name===t&&s.classList.add("staged");const i=document.createElement("div");i.className="item-header";const a=document.createElement("span");a.className="item-name";const l=document.createElement("span");l.className="item-icon",l.textContent=e.icon||"ðŸ¤–",a.appendChild(l),a.appendChild(document.createTextNode(` ${t}`));const d=at([{label:"Edit...",action:"agent:edit"},{label:"Duplicate",action:"agent:duplicate"},{label:"Delete",action:"agent:delete",isDestructive:!0}]);return d.querySelector("button")?.setAttribute("title","Agent actions"),i.append(a,d),s.appendChild(i),s}function dM(t,e){if(!t)return;const n=t.querySelector(".agent-presets-section");n&&n.remove();const o=document.createElement("details");o.className="collapsible-section agent-presets-section",o.open=!0;const r=document.createElement("summary");r.className="section-header";const s=document.createElement("h3");s.textContent="ðŸ¤– Agent Presets";const i=document.createElement("div");i.className="section-header-actions";const a=document.createElement("button");a.className="btn-icon",a.dataset.action="agent:create",a.title="Create New Agent",a.textContent="+";const l=at([{label:"New Agent...",action:"agent:create"},{label:"Import Agent(s)...",action:"agent:import"},{label:"Export All Agents...",action:"agent:exportAll"}]);l.classList.add("section-mini-menu"),l.querySelector("button")?.setAttribute("title","Agent section menu"),i.append(a,l),r.append(s,i);const c=document.createElement("div");c.className="section-box";const d=document.createElement("div");if(d.id="agentPresetList",d.className="item-list",c.appendChild(d),o.append(r,c),t.appendChild(o),!!d){if(!e||e.length===0){d.innerHTML='<p class="no-items-message">No agents found.</p>';return}e.forEach(u=>{d.appendChild(cM(u.name,u))})}}function jb(t=[]){const e=document.getElementById("agent-tags-container"),n=document.getElementById("agent-tags-input");!e||!n||(e.querySelectorAll(".tag-pill").forEach(o=>o.remove()),(t||[]).forEach(o=>{const r=document.createElement("div");r.className="tag-pill",r.textContent=o,r.dataset.tag=o;const s=document.createElement("span");s.className="remove-tag",s.innerHTML="&times;",s.onclick=()=>r.remove(),r.appendChild(s),e.insertBefore(r,n)}))}function uM(t=[]){const n=h.getProject().memories||[],o=document.getElementById("agent-memory-list");if(o){if(o.innerHTML="",n.length===0){o.innerHTML='<p class="no-items-message">Create memories first.</p>';return}n.forEach(r=>{const s=(t||[]).includes(r.name),i=document.createElement("div");i.className="item",i.dataset.memoryName=r.name,i.innerHTML=`<span class="item-name">${r.name}</span><label class="switch"><input type="checkbox" ${s?"checked":""}><span class="slider round"></span></label>`,o.appendChild(i)})}}function pM(t){const e=document.querySelector('#agent-editor-modal .tab-content[data-tab-content="system"]');e&&e.classList.toggle("is-locked",t)}function _b(){const t=document.getElementById("enhancer-model-name"),e=h.getProject();if(!t||!e)return;const n=e.globalSettings.systemUtilityAgent;if(n&&n.model){const o=[...h.getState().systemProviderModels||[],...h.getState().userProviderModels||[]];if(o.length===0){t.textContent=n.model;return}const r=o.find(s=>s.id===n.model);t.textContent=r?r.name:n.model}else t.textContent="N/A"}function ru(){return document.getElementById(Rb)}function fM(){return window.customElements?.get("emoji-picker")?Promise.resolve(!0):Ir||(Ir=new Promise((t,e)=>{const n=document.createElement("script");n.type="module",n.src=lM,n.onload=()=>t(!0),n.onerror=()=>e(new Error("Could not load emoji picker library.")),document.body.appendChild(n)}).catch(t=>{throw Ir=null,t}),Ir)}function mM(t){t&&(document.body.classList.contains("dark-mode")?(t.classList.add("dark"),t.classList.remove("light")):(t.classList.add("light"),t.classList.remove("dark")))}function $b(){ru()?.classList.add(bo)}async function hM(t){await fM();let e=ru();if(!e){const n=document.getElementById(aM);if(!n)return null;e=document.createElement("emoji-picker"),e.id=Rb,e.className=`light ${bo}`,n.appendChild(e)}return e.dataset.listenerAttached!=="true"&&(e.addEventListener("emoji-click",n=>{const o=n?.detail?.emoji?.unicode;o&&(t.textContent=o,$b())}),e.dataset.listenerAttached="true"),e}function Nf(){const t=h.getState().activeParameterEditor;t&&typeof t.destroy=="function"&&(t.destroy(),h.setState("activeParameterEditor",null)),$b(),document.getElementById("agent-editor-modal").style.display="none",h.setState("editingAgentName",null)}function Mf(t=!1,e=null){const n=document.getElementById("agent-editor-modal");if(!n)return;h.setState("editingAgentName",t?e:null);const o=h.getProject(),r=t&&o.agentPresets[e]?o.agentPresets[e]:xa;n.querySelectorAll(".tab-btn, .tab-content").forEach(m=>m.classList.remove("active")),n.querySelector('.tab-btn[data-tab="config"]')?.classList.add("active"),n.querySelector('.tab-content[data-tab-content="config"]')?.classList.add("active");const s=n.querySelector('.tab-content[data-tab-content="system"]');s&&(s.dataset.rendered="false");const i=document.getElementById("agent-profile-picture-preview");i&&(i.src=r.profilePicture||"/PromptPrim/icon.png"),document.getElementById("agent-name-input").value=t?e:"New Agent",document.getElementById("agent-icon-button").textContent=r.icon||"ðŸ¤–",document.getElementById("agent-id-display").value=r.id||`agent_${Date.now()}`,document.getElementById("agent-description").value=r.description||"",Sm("agent-model-search-wrapper",r.model,Kn()),document.getElementById("agent-system-prompt").value=r.systemPrompt,document.getElementById("agent-use-markdown").checked=r.useMarkdown,document.getElementById("agent-enable-web-search").checked=r.enableWebSearch;const a=document.getElementById("agent-params-container");if(a){const b=Kn().find(v=>v.id===r.model),y=b?b.provider:"openrouter",w=Db(a,r,y);h.setState("activeParameterEditor",w)}const l=document.getElementById("agent-created-by-input");l&&(l.value=t?r.createdBy||"Unknown":wt().userName);const c=document.getElementById("agent-created-date");c&&(c.textContent=r.createdAt?new Date(r.createdAt).toLocaleString():"Not saved yet");const d=document.getElementById("agent-modified-date");d&&(d.textContent=r.modifiedAt?new Date(r.modifiedAt).toLocaleString():"Not saved yet"),jb(r.tags),uM(r.activeMemories),pM(r.type==="third-party"),_b();const u=document.getElementById("agent-model-warning"),f=document.getElementById("agent-model-warning-text"),p=document.getElementById("agent-model-search-wrapper");if(u&&f&&p){const b=Kn().some(y=>y.id===r.model);t&&r.model&&!b?(f.innerHTML=`<strong>Model Not Found:</strong> The original model (<code>${r.model}</code>) could not be found. Please select a new model.`,u.classList.remove("hidden"),p.classList.add("has-warning")):(u.classList.add("hidden"),p.classList.remove("has-warning"))}n.style.display="flex"}function gM(){const t=document.getElementById("agent-editor-modal");if(!t)return;t.querySelector(".tab-buttons")?.addEventListener("click",a=>{const l=a.target.closest(".tab-btn");if(!l)return;const c=l.dataset.tab;t.querySelectorAll(".tab-btn, .tab-content").forEach(d=>d.classList.remove("active")),l.classList.add("active"),t.querySelector(`.tab-content[data-tab-content="${c}"]`)?.classList.add("active")}),t.addEventListener("click",a=>{const l=a.target;if(l.matches(".modal-actions .btn:not(.btn-secondary)"))h.bus.publish("agent:save");else if(l.closest("#generate-agent-profile-btn"))h.bus.publish("agent:generateProfile");else if(l.matches(".btn-secondary")||l.closest(".modal-close-btn"))Nf();else if(l.closest("#agent-id-copy-btn")){const c=document.getElementById("agent-id-display");navigator.clipboard.writeText(c.value)}});const n=document.getElementById("agent-tags-input");n?.addEventListener("keydown",a=>{if(a.key==="Enter"){a.preventDefault(),a.stopPropagation();const l=n.value.trim();if(l){const c=Array.from(document.querySelectorAll("#agent-tags-container .tag-pill")).map(d=>d.dataset.tag);c.includes(l)||jb([...c,l]),n.value=""}}});const o=document.getElementById("agent-icon-button");o&&(o.addEventListener("click",async a=>{a.stopPropagation();let l=null;try{l=await hM(o)}catch(d){console.error(d),k("Failed to load emoji picker. Please try again.","Error");return}if(!l)return;mM(l),l.classList.contains(bo)?requestAnimationFrame(()=>{l.classList.remove(bo)}):l.classList.add(bo)}),document.addEventListener("click",a=>{const l=ru();l&&!l.classList.contains(bo)&&!l.contains(a.target)&&a.target!==o&&l.classList.add(bo)}));const r=document.getElementById("agent-profile-picture-upload"),s=document.getElementById("agent-profile-picture-preview");r&&s&&r.addEventListener("change",a=>{const l=a.target.files?.[0];if(!l)return;if(!l.type.startsWith("image/")){k("Please select an image file (e.g., PNG, JPG, WEBP).","Unsupported File");return}const c=2*1024*1024;if(l.size>c){k("The selected image is too large. Please select a file smaller than 2MB.","File Too Large");return}const d=new FileReader;d.onload=u=>{s.src=u.target?.result||""},d.readAsDataURL(l)}),h.bus.subscribe("agent:editorShouldClose",Nf);const i=()=>{t&&t.style.display==="flex"&&_b()};h.bus.subscribe("models:loaded",i),h.bus.subscribe("user:modelsLoaded",i),h.bus.subscribe("agent:profileGenerated",a=>{if(!a)return;document.getElementById("agent-name-input").value=a.agent_name||"",document.getElementById("agent-icon-button").textContent=a.agent_icon||"ðŸ¤–",document.getElementById("agent-system-prompt").value=a.system_prompt||"";const l=h.getState().editingAgentName,c=h.getProject(),d=l?c.agentPresets[l]:xa,u={...d,temperature:a.temperature??d.temperature,topP:a.top_p??d.topP,topK:a.top_k??d.topK,max_tokens:a.max_tokens??d.max_tokens,frequency_penalty:a.frequency_penalty??d.frequency_penalty,presence_penalty:a.presence_penalty??d.presence_penalty,seed:a.seed??d.seed},f=document.getElementById("agent-params-container");if(f){const p=h.getState().activeParameterEditor;p&&p.destroy();const b=Db(f,u,"openrouter");h.setState("activeParameterEditor",b)}}),h.bus.subscribe("agent:promptEnhanced",({newPrompt:a})=>{const l=document.getElementById("agent-system-prompt");l&&(l.value=a)}),console.log("âœ… Agent UI Initialized with Full Profile Generation Logic.")}/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */function Tf(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,o)}return n}function en(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Tf(Object(n),!0).forEach(function(o){bM(t,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Tf(Object(n)).forEach(function(o){Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(n,o))})}return t}function li(t){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?li=function(e){return typeof e}:li=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},li(t)}function bM(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function In(){return In=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},In.apply(this,arguments)}function yM(t,e){if(t==null)return{};var n={},o=Object.keys(t),r,s;for(s=0;s<o.length;s++)r=o[s],!(e.indexOf(r)>=0)&&(n[r]=t[r]);return n}function wM(t,e){if(t==null)return{};var n=yM(t,e),o,r;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(r=0;r<s.length;r++)o=s[r],!(e.indexOf(o)>=0)&&Object.prototype.propertyIsEnumerable.call(t,o)&&(n[o]=t[o])}return n}var vM="1.15.6";function Cn(t){if(typeof window<"u"&&window.navigator)return!!navigator.userAgent.match(t)}var Tn=Cn(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),Is=Cn(/Edge/i),Pf=Cn(/firefox/i),Qr=Cn(/safari/i)&&!Cn(/chrome/i)&&!Cn(/android/i),su=Cn(/iP(ad|od|hone)/i),Fb=Cn(/chrome/i)&&Cn(/android/i),Wb={capture:!1,passive:!1};function de(t,e,n){t.addEventListener(e,n,!Tn&&Wb)}function ce(t,e,n){t.removeEventListener(e,n,!Tn&&Wb)}function da(t,e){if(e){if(e[0]===">"&&(e=e.substring(1)),t)try{if(t.matches)return t.matches(e);if(t.msMatchesSelector)return t.msMatchesSelector(e);if(t.webkitMatchesSelector)return t.webkitMatchesSelector(e)}catch{return!1}return!1}}function zb(t){return t.host&&t!==document&&t.host.nodeType?t.host:t.parentNode}function Dt(t,e,n,o){if(t){n=n||document;do{if(e!=null&&(e[0]===">"?t.parentNode===n&&da(t,e):da(t,e))||o&&t===n)return t;if(t===n)break}while(t=zb(t))}return null}var Bf=/\s+/g;function ht(t,e,n){if(t&&e)if(t.classList)t.classList[n?"add":"remove"](e);else{var o=(" "+t.className+" ").replace(Bf," ").replace(" "+e+" "," ");t.className=(o+(n?" "+e:"")).replace(Bf," ")}}function Y(t,e,n){var o=t&&t.style;if(o){if(n===void 0)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(t,""):t.currentStyle&&(n=t.currentStyle),e===void 0?n:n[e];!(e in o)&&e.indexOf("webkit")===-1&&(e="-webkit-"+e),o[e]=n+(typeof n=="string"?"":"px")}}function cr(t,e){var n="";if(typeof t=="string")n=t;else do{var o=Y(t,"transform");o&&o!=="none"&&(n=o+" "+n)}while(!e&&(t=t.parentNode));var r=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return r&&new r(n)}function Hb(t,e,n){if(t){var o=t.getElementsByTagName(e),r=0,s=o.length;if(n)for(;r<s;r++)n(o[r],r);return o}return[]}function Yt(){var t=document.scrollingElement;return t||document.documentElement}function je(t,e,n,o,r){if(!(!t.getBoundingClientRect&&t!==window)){var s,i,a,l,c,d,u;if(t!==window&&t.parentNode&&t!==Yt()?(s=t.getBoundingClientRect(),i=s.top,a=s.left,l=s.bottom,c=s.right,d=s.height,u=s.width):(i=0,a=0,l=window.innerHeight,c=window.innerWidth,d=window.innerHeight,u=window.innerWidth),(e||n)&&t!==window&&(r=r||t.parentNode,!Tn))do if(r&&r.getBoundingClientRect&&(Y(r,"transform")!=="none"||n&&Y(r,"position")!=="static")){var f=r.getBoundingClientRect();i-=f.top+parseInt(Y(r,"border-top-width")),a-=f.left+parseInt(Y(r,"border-left-width")),l=i+s.height,c=a+s.width;break}while(r=r.parentNode);if(o&&t!==window){var p=cr(r||t),m=p&&p.a,b=p&&p.d;p&&(i/=b,a/=m,u/=m,d/=b,l=i+d,c=a+u)}return{top:i,left:a,bottom:l,right:c,width:u,height:d}}}function Of(t,e,n){for(var o=qn(t,!0),r=je(t)[e];o;){var s=je(o)[n],i=void 0;if(i=r>=s,!i)return o;if(o===Yt())break;o=qn(o,!1)}return!1}function gr(t,e,n,o){for(var r=0,s=0,i=t.children;s<i.length;){if(i[s].style.display!=="none"&&i[s]!==X.ghost&&(o||i[s]!==X.dragged)&&Dt(i[s],n.draggable,t,!1)){if(r===e)return i[s];r++}s++}return null}function iu(t,e){for(var n=t.lastElementChild;n&&(n===X.ghost||Y(n,"display")==="none"||e&&!da(n,e));)n=n.previousElementSibling;return n||null}function It(t,e){var n=0;if(!t||!t.parentNode)return-1;for(;t=t.previousElementSibling;)t.nodeName.toUpperCase()!=="TEMPLATE"&&t!==X.clone&&(!e||da(t,e))&&n++;return n}function Lf(t){var e=0,n=0,o=Yt();if(t)do{var r=cr(t),s=r.a,i=r.d;e+=t.scrollLeft*s,n+=t.scrollTop*i}while(t!==o&&(t=t.parentNode));return[e,n]}function SM(t,e){for(var n in t)if(t.hasOwnProperty(n)){for(var o in e)if(e.hasOwnProperty(o)&&e[o]===t[n][o])return Number(n)}return-1}function qn(t,e){if(!t||!t.getBoundingClientRect)return Yt();var n=t,o=!1;do if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var r=Y(n);if(n.clientWidth<n.scrollWidth&&(r.overflowX=="auto"||r.overflowX=="scroll")||n.clientHeight<n.scrollHeight&&(r.overflowY=="auto"||r.overflowY=="scroll")){if(!n.getBoundingClientRect||n===document.body)return Yt();if(o||e)return n;o=!0}}while(n=n.parentNode);return Yt()}function kM(t,e){if(t&&e)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function Pl(t,e){return Math.round(t.top)===Math.round(e.top)&&Math.round(t.left)===Math.round(e.left)&&Math.round(t.height)===Math.round(e.height)&&Math.round(t.width)===Math.round(e.width)}var Zr;function Ub(t,e){return function(){if(!Zr){var n=arguments,o=this;n.length===1?t.call(o,n[0]):t.apply(o,n),Zr=setTimeout(function(){Zr=void 0},e)}}}function xM(){clearTimeout(Zr),Zr=void 0}function Vb(t,e,n){t.scrollLeft+=e,t.scrollTop+=n}function qb(t){var e=window.Polymer,n=window.jQuery||window.Zepto;return e&&e.dom?e.dom(t).cloneNode(!0):n?n(t).clone(!0)[0]:t.cloneNode(!0)}function Kb(t,e,n){var o={};return Array.from(t.children).forEach(function(r){var s,i,a,l;if(!(!Dt(r,e.draggable,t,!1)||r.animated||r===n)){var c=je(r);o.left=Math.min((s=o.left)!==null&&s!==void 0?s:1/0,c.left),o.top=Math.min((i=o.top)!==null&&i!==void 0?i:1/0,c.top),o.right=Math.max((a=o.right)!==null&&a!==void 0?a:-1/0,c.right),o.bottom=Math.max((l=o.bottom)!==null&&l!==void 0?l:-1/0,c.bottom)}}),o.width=o.right-o.left,o.height=o.bottom-o.top,o.x=o.left,o.y=o.top,o}var pt="Sortable"+new Date().getTime();function CM(){var t=[],e;return{captureAnimationState:function(){if(t=[],!!this.options.animation){var o=[].slice.call(this.el.children);o.forEach(function(r){if(!(Y(r,"display")==="none"||r===X.ghost)){t.push({target:r,rect:je(r)});var s=en({},t[t.length-1].rect);if(r.thisAnimationDuration){var i=cr(r,!0);i&&(s.top-=i.f,s.left-=i.e)}r.fromRect=s}})}},addAnimationState:function(o){t.push(o)},removeAnimationState:function(o){t.splice(SM(t,{target:o}),1)},animateAll:function(o){var r=this;if(!this.options.animation){clearTimeout(e),typeof o=="function"&&o();return}var s=!1,i=0;t.forEach(function(a){var l=0,c=a.target,d=c.fromRect,u=je(c),f=c.prevFromRect,p=c.prevToRect,m=a.rect,b=cr(c,!0);b&&(u.top-=b.f,u.left-=b.e),c.toRect=u,c.thisAnimationDuration&&Pl(f,u)&&!Pl(d,u)&&(m.top-u.top)/(m.left-u.left)===(d.top-u.top)/(d.left-u.left)&&(l=IM(m,f,p,r.options)),Pl(u,d)||(c.prevFromRect=d,c.prevToRect=u,l||(l=r.options.animation),r.animate(c,m,u,l)),l&&(s=!0,i=Math.max(i,l),clearTimeout(c.animationResetTimer),c.animationResetTimer=setTimeout(function(){c.animationTime=0,c.prevFromRect=null,c.fromRect=null,c.prevToRect=null,c.thisAnimationDuration=null},l),c.thisAnimationDuration=l)}),clearTimeout(e),s?e=setTimeout(function(){typeof o=="function"&&o()},i):typeof o=="function"&&o(),t=[]},animate:function(o,r,s,i){if(i){Y(o,"transition",""),Y(o,"transform","");var a=cr(this.el),l=a&&a.a,c=a&&a.d,d=(r.left-s.left)/(l||1),u=(r.top-s.top)/(c||1);o.animatingX=!!d,o.animatingY=!!u,Y(o,"transform","translate3d("+d+"px,"+u+"px,0)"),this.forRepaintDummy=EM(o),Y(o,"transition","transform "+i+"ms"+(this.options.easing?" "+this.options.easing:"")),Y(o,"transform","translate3d(0,0,0)"),typeof o.animated=="number"&&clearTimeout(o.animated),o.animated=setTimeout(function(){Y(o,"transition",""),Y(o,"transform",""),o.animated=!1,o.animatingX=!1,o.animatingY=!1},i)}}}}function EM(t){return t.offsetWidth}function IM(t,e,n,o){return Math.sqrt(Math.pow(e.top-t.top,2)+Math.pow(e.left-t.left,2))/Math.sqrt(Math.pow(e.top-n.top,2)+Math.pow(e.left-n.left,2))*o.animation}var Vo=[],Bl={initializeByDefault:!0},As={mount:function(e){for(var n in Bl)Bl.hasOwnProperty(n)&&!(n in e)&&(e[n]=Bl[n]);Vo.forEach(function(o){if(o.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),Vo.push(e)},pluginEvent:function(e,n,o){var r=this;this.eventCanceled=!1,o.cancel=function(){r.eventCanceled=!0};var s=e+"Global";Vo.forEach(function(i){n[i.pluginName]&&(n[i.pluginName][s]&&n[i.pluginName][s](en({sortable:n},o)),n.options[i.pluginName]&&n[i.pluginName][e]&&n[i.pluginName][e](en({sortable:n},o)))})},initializePlugins:function(e,n,o,r){Vo.forEach(function(a){var l=a.pluginName;if(!(!e.options[l]&&!a.initializeByDefault)){var c=new a(e,n,e.options);c.sortable=e,c.options=e.options,e[l]=c,In(o,c.defaults)}});for(var s in e.options)if(e.options.hasOwnProperty(s)){var i=this.modifyOption(e,s,e.options[s]);typeof i<"u"&&(e.options[s]=i)}},getEventProperties:function(e,n){var o={};return Vo.forEach(function(r){typeof r.eventProperties=="function"&&In(o,r.eventProperties.call(n[r.pluginName],e))}),o},modifyOption:function(e,n,o){var r;return Vo.forEach(function(s){e[s.pluginName]&&s.optionListeners&&typeof s.optionListeners[n]=="function"&&(r=s.optionListeners[n].call(e[s.pluginName],o))}),r}};function AM(t){var e=t.sortable,n=t.rootEl,o=t.name,r=t.targetEl,s=t.cloneEl,i=t.toEl,a=t.fromEl,l=t.oldIndex,c=t.newIndex,d=t.oldDraggableIndex,u=t.newDraggableIndex,f=t.originalEvent,p=t.putSortable,m=t.extraEventProperties;if(e=e||n&&n[pt],!!e){var b,y=e.options,w="on"+o.charAt(0).toUpperCase()+o.substr(1);window.CustomEvent&&!Tn&&!Is?b=new CustomEvent(o,{bubbles:!0,cancelable:!0}):(b=document.createEvent("Event"),b.initEvent(o,!0,!0)),b.to=i||n,b.from=a||n,b.item=r||n,b.clone=s,b.oldIndex=l,b.newIndex=c,b.oldDraggableIndex=d,b.newDraggableIndex=u,b.originalEvent=f,b.pullMode=p?p.lastPutMode:void 0;var v=en(en({},m),As.getEventProperties(o,e));for(var S in v)b[S]=v[S];n&&n.dispatchEvent(b),y[w]&&y[w].call(e,b)}}var NM=["evt"],ct=function(e,n){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=o.evt,s=wM(o,NM);As.pluginEvent.bind(X)(e,n,en({dragEl:D,parentEl:Pe,ghostEl:ee,rootEl:Ie,nextEl:mo,lastDownEl:ci,cloneEl:Ae,cloneHidden:Wn,dragStarted:Dr,putSortable:Ve,activeSortable:X.active,originalEvent:r,oldIndex:rr,oldDraggableIndex:es,newIndex:bt,newDraggableIndex:jn,hideGhostForTarget:Xb,unhideGhostForTarget:Qb,cloneNowHidden:function(){Wn=!0},cloneNowShown:function(){Wn=!1},dispatchSortableEvent:function(a){tt({sortable:n,name:a,originalEvent:r})}},s))};function tt(t){AM(en({putSortable:Ve,cloneEl:Ae,targetEl:D,rootEl:Ie,oldIndex:rr,oldDraggableIndex:es,newIndex:bt,newDraggableIndex:jn},t))}var D,Pe,ee,Ie,mo,ci,Ae,Wn,rr,bt,es,jn,Us,Ve,nr=!1,ua=!1,pa=[],po,Ot,Ol,Ll,Df,Rf,Dr,qo,ts,ns=!1,Vs=!1,di,Je,Dl=[],Hc=!1,fa=[],Ua=typeof document<"u",qs=su,jf=Is||Tn?"cssFloat":"float",MM=Ua&&!Fb&&!su&&"draggable"in document.createElement("div"),Gb=(function(){if(Ua){if(Tn)return!1;var t=document.createElement("x");return t.style.cssText="pointer-events:auto",t.style.pointerEvents==="auto"}})(),Jb=function(e,n){var o=Y(e),r=parseInt(o.width)-parseInt(o.paddingLeft)-parseInt(o.paddingRight)-parseInt(o.borderLeftWidth)-parseInt(o.borderRightWidth),s=gr(e,0,n),i=gr(e,1,n),a=s&&Y(s),l=i&&Y(i),c=a&&parseInt(a.marginLeft)+parseInt(a.marginRight)+je(s).width,d=l&&parseInt(l.marginLeft)+parseInt(l.marginRight)+je(i).width;if(o.display==="flex")return o.flexDirection==="column"||o.flexDirection==="column-reverse"?"vertical":"horizontal";if(o.display==="grid")return o.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(s&&a.float&&a.float!=="none"){var u=a.float==="left"?"left":"right";return i&&(l.clear==="both"||l.clear===u)?"vertical":"horizontal"}return s&&(a.display==="block"||a.display==="flex"||a.display==="table"||a.display==="grid"||c>=r&&o[jf]==="none"||i&&o[jf]==="none"&&c+d>r)?"vertical":"horizontal"},TM=function(e,n,o){var r=o?e.left:e.top,s=o?e.right:e.bottom,i=o?e.width:e.height,a=o?n.left:n.top,l=o?n.right:n.bottom,c=o?n.width:n.height;return r===a||s===l||r+i/2===a+c/2},PM=function(e,n){var o;return pa.some(function(r){var s=r[pt].options.emptyInsertThreshold;if(!(!s||iu(r))){var i=je(r),a=e>=i.left-s&&e<=i.right+s,l=n>=i.top-s&&n<=i.bottom+s;if(a&&l)return o=r}}),o},Yb=function(e){function n(s,i){return function(a,l,c,d){var u=a.options.group.name&&l.options.group.name&&a.options.group.name===l.options.group.name;if(s==null&&(i||u))return!0;if(s==null||s===!1)return!1;if(i&&s==="clone")return s;if(typeof s=="function")return n(s(a,l,c,d),i)(a,l,c,d);var f=(i?a:l).options.group.name;return s===!0||typeof s=="string"&&s===f||s.join&&s.indexOf(f)>-1}}var o={},r=e.group;(!r||li(r)!="object")&&(r={name:r}),o.name=r.name,o.checkPull=n(r.pull,!0),o.checkPut=n(r.put),o.revertClone=r.revertClone,e.group=o},Xb=function(){!Gb&&ee&&Y(ee,"display","none")},Qb=function(){!Gb&&ee&&Y(ee,"display","")};Ua&&!Fb&&document.addEventListener("click",function(t){if(ua)return t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.stopImmediatePropagation&&t.stopImmediatePropagation(),ua=!1,!1},!0);var fo=function(e){if(D){e=e.touches?e.touches[0]:e;var n=PM(e.clientX,e.clientY);if(n){var o={};for(var r in e)e.hasOwnProperty(r)&&(o[r]=e[r]);o.target=o.rootEl=n,o.preventDefault=void 0,o.stopPropagation=void 0,n[pt]._onDragOver(o)}}},BM=function(e){D&&D.parentNode[pt]._isOutsideThisEl(e.target)};function X(t,e){if(!(t&&t.nodeType&&t.nodeType===1))throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(t));this.el=t,this.options=e=In({},e),t[pt]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(t.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return Jb(t,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(i,a){i.setData("Text",a.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:X.supportPointer!==!1&&"PointerEvent"in window&&(!Qr||su),emptyInsertThreshold:5};As.initializePlugins(this,t,n);for(var o in n)!(o in e)&&(e[o]=n[o]);Yb(e);for(var r in this)r.charAt(0)==="_"&&typeof this[r]=="function"&&(this[r]=this[r].bind(this));this.nativeDraggable=e.forceFallback?!1:MM,this.nativeDraggable&&(this.options.touchStartThreshold=1),e.supportPointer?de(t,"pointerdown",this._onTapStart):(de(t,"mousedown",this._onTapStart),de(t,"touchstart",this._onTapStart)),this.nativeDraggable&&(de(t,"dragover",this),de(t,"dragenter",this)),pa.push(this.el),e.store&&e.store.get&&this.sort(e.store.get(this)||[]),In(this,CM())}X.prototype={constructor:X,_isOutsideThisEl:function(e){!this.el.contains(e)&&e!==this.el&&(qo=null)},_getDirection:function(e,n){return typeof this.options.direction=="function"?this.options.direction.call(this,e,n,D):this.options.direction},_onTapStart:function(e){if(e.cancelable){var n=this,o=this.el,r=this.options,s=r.preventOnFilter,i=e.type,a=e.touches&&e.touches[0]||e.pointerType&&e.pointerType==="touch"&&e,l=(a||e).target,c=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||l,d=r.filter;if(FM(o),!D&&!(/mousedown|pointerdown/.test(i)&&e.button!==0||r.disabled)&&!c.isContentEditable&&!(!this.nativeDraggable&&Qr&&l&&l.tagName.toUpperCase()==="SELECT")&&(l=Dt(l,r.draggable,o,!1),!(l&&l.animated)&&ci!==l)){if(rr=It(l),es=It(l,r.draggable),typeof d=="function"){if(d.call(this,e,l,this)){tt({sortable:n,rootEl:c,name:"filter",targetEl:l,toEl:o,fromEl:o}),ct("filter",n,{evt:e}),s&&e.preventDefault();return}}else if(d&&(d=d.split(",").some(function(u){if(u=Dt(c,u.trim(),o,!1),u)return tt({sortable:n,rootEl:u,name:"filter",targetEl:l,fromEl:o,toEl:o}),ct("filter",n,{evt:e}),!0}),d)){s&&e.preventDefault();return}r.handle&&!Dt(c,r.handle,o,!1)||this._prepareDragStart(e,a,l)}}},_prepareDragStart:function(e,n,o){var r=this,s=r.el,i=r.options,a=s.ownerDocument,l;if(o&&!D&&o.parentNode===s){var c=je(o);if(Ie=s,D=o,Pe=D.parentNode,mo=D.nextSibling,ci=o,Us=i.group,X.dragged=D,po={target:D,clientX:(n||e).clientX,clientY:(n||e).clientY},Df=po.clientX-c.left,Rf=po.clientY-c.top,this._lastX=(n||e).clientX,this._lastY=(n||e).clientY,D.style["will-change"]="all",l=function(){if(ct("delayEnded",r,{evt:e}),X.eventCanceled){r._onDrop();return}r._disableDelayedDragEvents(),!Pf&&r.nativeDraggable&&(D.draggable=!0),r._triggerDragStart(e,n),tt({sortable:r,name:"choose",originalEvent:e}),ht(D,i.chosenClass,!0)},i.ignore.split(",").forEach(function(d){Hb(D,d.trim(),Rl)}),de(a,"dragover",fo),de(a,"mousemove",fo),de(a,"touchmove",fo),i.supportPointer?(de(a,"pointerup",r._onDrop),!this.nativeDraggable&&de(a,"pointercancel",r._onDrop)):(de(a,"mouseup",r._onDrop),de(a,"touchend",r._onDrop),de(a,"touchcancel",r._onDrop)),Pf&&this.nativeDraggable&&(this.options.touchStartThreshold=4,D.draggable=!0),ct("delayStart",this,{evt:e}),i.delay&&(!i.delayOnTouchOnly||n)&&(!this.nativeDraggable||!(Is||Tn))){if(X.eventCanceled){this._onDrop();return}i.supportPointer?(de(a,"pointerup",r._disableDelayedDrag),de(a,"pointercancel",r._disableDelayedDrag)):(de(a,"mouseup",r._disableDelayedDrag),de(a,"touchend",r._disableDelayedDrag),de(a,"touchcancel",r._disableDelayedDrag)),de(a,"mousemove",r._delayedDragTouchMoveHandler),de(a,"touchmove",r._delayedDragTouchMoveHandler),i.supportPointer&&de(a,"pointermove",r._delayedDragTouchMoveHandler),r._dragStartTimer=setTimeout(l,i.delay)}else l()}},_delayedDragTouchMoveHandler:function(e){var n=e.touches?e.touches[0]:e;Math.max(Math.abs(n.clientX-this._lastX),Math.abs(n.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){D&&Rl(D),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;ce(e,"mouseup",this._disableDelayedDrag),ce(e,"touchend",this._disableDelayedDrag),ce(e,"touchcancel",this._disableDelayedDrag),ce(e,"pointerup",this._disableDelayedDrag),ce(e,"pointercancel",this._disableDelayedDrag),ce(e,"mousemove",this._delayedDragTouchMoveHandler),ce(e,"touchmove",this._delayedDragTouchMoveHandler),ce(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,n){n=n||e.pointerType=="touch"&&e,!this.nativeDraggable||n?this.options.supportPointer?de(document,"pointermove",this._onTouchMove):n?de(document,"touchmove",this._onTouchMove):de(document,"mousemove",this._onTouchMove):(de(D,"dragend",this),de(Ie,"dragstart",this._onDragStart));try{document.selection?ui(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch{}},_dragStarted:function(e,n){if(nr=!1,Ie&&D){ct("dragStarted",this,{evt:n}),this.nativeDraggable&&de(document,"dragover",BM);var o=this.options;!e&&ht(D,o.dragClass,!1),ht(D,o.ghostClass,!0),X.active=this,e&&this._appendGhost(),tt({sortable:this,name:"start",originalEvent:n})}else this._nulling()},_emulateDragOver:function(){if(Ot){this._lastX=Ot.clientX,this._lastY=Ot.clientY,Xb();for(var e=document.elementFromPoint(Ot.clientX,Ot.clientY),n=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(Ot.clientX,Ot.clientY),e!==n);)n=e;if(D.parentNode[pt]._isOutsideThisEl(e),n)do{if(n[pt]){var o=void 0;if(o=n[pt]._onDragOver({clientX:Ot.clientX,clientY:Ot.clientY,target:e,rootEl:n}),o&&!this.options.dragoverBubble)break}e=n}while(n=zb(n));Qb()}},_onTouchMove:function(e){if(po){var n=this.options,o=n.fallbackTolerance,r=n.fallbackOffset,s=e.touches?e.touches[0]:e,i=ee&&cr(ee,!0),a=ee&&i&&i.a,l=ee&&i&&i.d,c=qs&&Je&&Lf(Je),d=(s.clientX-po.clientX+r.x)/(a||1)+(c?c[0]-Dl[0]:0)/(a||1),u=(s.clientY-po.clientY+r.y)/(l||1)+(c?c[1]-Dl[1]:0)/(l||1);if(!X.active&&!nr){if(o&&Math.max(Math.abs(s.clientX-this._lastX),Math.abs(s.clientY-this._lastY))<o)return;this._onDragStart(e,!0)}if(ee){i?(i.e+=d-(Ol||0),i.f+=u-(Ll||0)):i={a:1,b:0,c:0,d:1,e:d,f:u};var f="matrix(".concat(i.a,",").concat(i.b,",").concat(i.c,",").concat(i.d,",").concat(i.e,",").concat(i.f,")");Y(ee,"webkitTransform",f),Y(ee,"mozTransform",f),Y(ee,"msTransform",f),Y(ee,"transform",f),Ol=d,Ll=u,Ot=s}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!ee){var e=this.options.fallbackOnBody?document.body:Ie,n=je(D,!0,qs,!0,e),o=this.options;if(qs){for(Je=e;Y(Je,"position")==="static"&&Y(Je,"transform")==="none"&&Je!==document;)Je=Je.parentNode;Je!==document.body&&Je!==document.documentElement?(Je===document&&(Je=Yt()),n.top+=Je.scrollTop,n.left+=Je.scrollLeft):Je=Yt(),Dl=Lf(Je)}ee=D.cloneNode(!0),ht(ee,o.ghostClass,!1),ht(ee,o.fallbackClass,!0),ht(ee,o.dragClass,!0),Y(ee,"transition",""),Y(ee,"transform",""),Y(ee,"box-sizing","border-box"),Y(ee,"margin",0),Y(ee,"top",n.top),Y(ee,"left",n.left),Y(ee,"width",n.width),Y(ee,"height",n.height),Y(ee,"opacity","0.8"),Y(ee,"position",qs?"absolute":"fixed"),Y(ee,"zIndex","100000"),Y(ee,"pointerEvents","none"),X.ghost=ee,e.appendChild(ee),Y(ee,"transform-origin",Df/parseInt(ee.style.width)*100+"% "+Rf/parseInt(ee.style.height)*100+"%")}},_onDragStart:function(e,n){var o=this,r=e.dataTransfer,s=o.options;if(ct("dragStart",this,{evt:e}),X.eventCanceled){this._onDrop();return}ct("setupClone",this),X.eventCanceled||(Ae=qb(D),Ae.removeAttribute("id"),Ae.draggable=!1,Ae.style["will-change"]="",this._hideClone(),ht(Ae,this.options.chosenClass,!1),X.clone=Ae),o.cloneId=ui(function(){ct("clone",o),!X.eventCanceled&&(o.options.removeCloneOnHide||Ie.insertBefore(Ae,D),o._hideClone(),tt({sortable:o,name:"clone"}))}),!n&&ht(D,s.dragClass,!0),n?(ua=!0,o._loopId=setInterval(o._emulateDragOver,50)):(ce(document,"mouseup",o._onDrop),ce(document,"touchend",o._onDrop),ce(document,"touchcancel",o._onDrop),r&&(r.effectAllowed="move",s.setData&&s.setData.call(o,r,D)),de(document,"drop",o),Y(D,"transform","translateZ(0)")),nr=!0,o._dragStartId=ui(o._dragStarted.bind(o,n,e)),de(document,"selectstart",o),Dr=!0,window.getSelection().removeAllRanges(),Qr&&Y(document.body,"user-select","none")},_onDragOver:function(e){var n=this.el,o=e.target,r,s,i,a=this.options,l=a.group,c=X.active,d=Us===l,u=a.sort,f=Ve||c,p,m=this,b=!1;if(Hc)return;function y(ae,j){ct(ae,m,en({evt:e,isOwner:d,axis:p?"vertical":"horizontal",revert:i,dragRect:r,targetRect:s,canSort:u,fromSortable:f,target:o,completed:v,onMove:function(W,O){return Ks(Ie,n,D,r,W,je(W),e,O)},changed:S},j))}function w(){y("dragOverAnimationCapture"),m.captureAnimationState(),m!==f&&f.captureAnimationState()}function v(ae){return y("dragOverCompleted",{insertion:ae}),ae&&(d?c._hideClone():c._showClone(m),m!==f&&(ht(D,Ve?Ve.options.ghostClass:c.options.ghostClass,!1),ht(D,a.ghostClass,!0)),Ve!==m&&m!==X.active?Ve=m:m===X.active&&Ve&&(Ve=null),f===m&&(m._ignoreWhileAnimating=o),m.animateAll(function(){y("dragOverAnimationComplete"),m._ignoreWhileAnimating=null}),m!==f&&(f.animateAll(),f._ignoreWhileAnimating=null)),(o===D&&!D.animated||o===n&&!o.animated)&&(qo=null),!a.dragoverBubble&&!e.rootEl&&o!==document&&(D.parentNode[pt]._isOutsideThisEl(e.target),!ae&&fo(e)),!a.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),b=!0}function S(){bt=It(D),jn=It(D,a.draggable),tt({sortable:m,name:"change",toEl:n,newIndex:bt,newDraggableIndex:jn,originalEvent:e})}if(e.preventDefault!==void 0&&e.cancelable&&e.preventDefault(),o=Dt(o,a.draggable,n,!0),y("dragOver"),X.eventCanceled)return b;if(D.contains(e.target)||o.animated&&o.animatingX&&o.animatingY||m._ignoreWhileAnimating===o)return v(!1);if(ua=!1,c&&!a.disabled&&(d?u||(i=Pe!==Ie):Ve===this||(this.lastPutMode=Us.checkPull(this,c,D,e))&&l.checkPut(this,c,D,e))){if(p=this._getDirection(e,o)==="vertical",r=je(D),y("dragOverValid"),X.eventCanceled)return b;if(i)return Pe=Ie,w(),this._hideClone(),y("revert"),X.eventCanceled||(mo?Ie.insertBefore(D,mo):Ie.appendChild(D)),v(!0);var C=iu(n,a.draggable);if(!C||RM(e,p,this)&&!C.animated){if(C===D)return v(!1);if(C&&n===e.target&&(o=C),o&&(s=je(o)),Ks(Ie,n,D,r,o,s,e,!!o)!==!1)return w(),C&&C.nextSibling?n.insertBefore(D,C.nextSibling):n.appendChild(D),Pe=n,S(),v(!0)}else if(C&&DM(e,p,this)){var x=gr(n,0,a,!0);if(x===D)return v(!1);if(o=x,s=je(o),Ks(Ie,n,D,r,o,s,e,!1)!==!1)return w(),n.insertBefore(D,x),Pe=n,S(),v(!0)}else if(o.parentNode===n){s=je(o);var I=0,N,E=D.parentNode!==n,A=!TM(D.animated&&D.toRect||r,o.animated&&o.toRect||s,p),L=p?"top":"left",B=Of(o,"top","top")||Of(D,"top","top"),G=B?B.scrollTop:void 0;qo!==o&&(N=s[L],ns=!1,Vs=!A&&a.invertSwap||E),I=jM(e,o,s,p,A?1:a.swapThreshold,a.invertedSwapThreshold==null?a.swapThreshold:a.invertedSwapThreshold,Vs,qo===o);var K;if(I!==0){var _=It(D);do _-=I,K=Pe.children[_];while(K&&(Y(K,"display")==="none"||K===ee))}if(I===0||K===o)return v(!1);qo=o,ts=I;var me=o.nextElementSibling,Q=!1;Q=I===1;var Oe=Ks(Ie,n,D,r,o,s,e,Q);if(Oe!==!1)return(Oe===1||Oe===-1)&&(Q=Oe===1),Hc=!0,setTimeout(LM,30),w(),Q&&!me?n.appendChild(D):o.parentNode.insertBefore(D,Q?me:o),B&&Vb(B,0,G-B.scrollTop),Pe=D.parentNode,N!==void 0&&!Vs&&(di=Math.abs(N-je(o)[L])),S(),v(!0)}if(n.contains(D))return v(!1)}return!1},_ignoreWhileAnimating:null,_offMoveEvents:function(){ce(document,"mousemove",this._onTouchMove),ce(document,"touchmove",this._onTouchMove),ce(document,"pointermove",this._onTouchMove),ce(document,"dragover",fo),ce(document,"mousemove",fo),ce(document,"touchmove",fo)},_offUpEvents:function(){var e=this.el.ownerDocument;ce(e,"mouseup",this._onDrop),ce(e,"touchend",this._onDrop),ce(e,"pointerup",this._onDrop),ce(e,"pointercancel",this._onDrop),ce(e,"touchcancel",this._onDrop),ce(document,"selectstart",this)},_onDrop:function(e){var n=this.el,o=this.options;if(bt=It(D),jn=It(D,o.draggable),ct("drop",this,{evt:e}),Pe=D&&D.parentNode,bt=It(D),jn=It(D,o.draggable),X.eventCanceled){this._nulling();return}nr=!1,Vs=!1,ns=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),Uc(this.cloneId),Uc(this._dragStartId),this.nativeDraggable&&(ce(document,"drop",this),ce(n,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),Qr&&Y(document.body,"user-select",""),Y(D,"transform",""),e&&(Dr&&(e.cancelable&&e.preventDefault(),!o.dropBubble&&e.stopPropagation()),ee&&ee.parentNode&&ee.parentNode.removeChild(ee),(Ie===Pe||Ve&&Ve.lastPutMode!=="clone")&&Ae&&Ae.parentNode&&Ae.parentNode.removeChild(Ae),D&&(this.nativeDraggable&&ce(D,"dragend",this),Rl(D),D.style["will-change"]="",Dr&&!nr&&ht(D,Ve?Ve.options.ghostClass:this.options.ghostClass,!1),ht(D,this.options.chosenClass,!1),tt({sortable:this,name:"unchoose",toEl:Pe,newIndex:null,newDraggableIndex:null,originalEvent:e}),Ie!==Pe?(bt>=0&&(tt({rootEl:Pe,name:"add",toEl:Pe,fromEl:Ie,originalEvent:e}),tt({sortable:this,name:"remove",toEl:Pe,originalEvent:e}),tt({rootEl:Pe,name:"sort",toEl:Pe,fromEl:Ie,originalEvent:e}),tt({sortable:this,name:"sort",toEl:Pe,originalEvent:e})),Ve&&Ve.save()):bt!==rr&&bt>=0&&(tt({sortable:this,name:"update",toEl:Pe,originalEvent:e}),tt({sortable:this,name:"sort",toEl:Pe,originalEvent:e})),X.active&&((bt==null||bt===-1)&&(bt=rr,jn=es),tt({sortable:this,name:"end",toEl:Pe,originalEvent:e}),this.save()))),this._nulling()},_nulling:function(){ct("nulling",this),Ie=D=Pe=ee=mo=Ae=ci=Wn=po=Ot=Dr=bt=jn=rr=es=qo=ts=Ve=Us=X.dragged=X.ghost=X.clone=X.active=null,fa.forEach(function(e){e.checked=!0}),fa.length=Ol=Ll=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":D&&(this._onDragOver(e),OM(e));break;case"selectstart":e.preventDefault();break}},toArray:function(){for(var e=[],n,o=this.el.children,r=0,s=o.length,i=this.options;r<s;r++)n=o[r],Dt(n,i.draggable,this.el,!1)&&e.push(n.getAttribute(i.dataIdAttr)||$M(n));return e},sort:function(e,n){var o={},r=this.el;this.toArray().forEach(function(s,i){var a=r.children[i];Dt(a,this.options.draggable,r,!1)&&(o[s]=a)},this),n&&this.captureAnimationState(),e.forEach(function(s){o[s]&&(r.removeChild(o[s]),r.appendChild(o[s]))}),n&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,n){return Dt(e,n||this.options.draggable,this.el,!1)},option:function(e,n){var o=this.options;if(n===void 0)return o[e];var r=As.modifyOption(this,e,n);typeof r<"u"?o[e]=r:o[e]=n,e==="group"&&Yb(o)},destroy:function(){ct("destroy",this);var e=this.el;e[pt]=null,ce(e,"mousedown",this._onTapStart),ce(e,"touchstart",this._onTapStart),ce(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(ce(e,"dragover",this),ce(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),function(n){n.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),pa.splice(pa.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!Wn){if(ct("hideClone",this),X.eventCanceled)return;Y(Ae,"display","none"),this.options.removeCloneOnHide&&Ae.parentNode&&Ae.parentNode.removeChild(Ae),Wn=!0}},_showClone:function(e){if(e.lastPutMode!=="clone"){this._hideClone();return}if(Wn){if(ct("showClone",this),X.eventCanceled)return;D.parentNode==Ie&&!this.options.group.revertClone?Ie.insertBefore(Ae,D):mo?Ie.insertBefore(Ae,mo):Ie.appendChild(Ae),this.options.group.revertClone&&this.animate(D,Ae),Y(Ae,"display",""),Wn=!1}}};function OM(t){t.dataTransfer&&(t.dataTransfer.dropEffect="move"),t.cancelable&&t.preventDefault()}function Ks(t,e,n,o,r,s,i,a){var l,c=t[pt],d=c.options.onMove,u;return window.CustomEvent&&!Tn&&!Is?l=new CustomEvent("move",{bubbles:!0,cancelable:!0}):(l=document.createEvent("Event"),l.initEvent("move",!0,!0)),l.to=e,l.from=t,l.dragged=n,l.draggedRect=o,l.related=r||e,l.relatedRect=s||je(e),l.willInsertAfter=a,l.originalEvent=i,t.dispatchEvent(l),d&&(u=d.call(c,l,i)),u}function Rl(t){t.draggable=!1}function LM(){Hc=!1}function DM(t,e,n){var o=je(gr(n.el,0,n.options,!0)),r=Kb(n.el,n.options,ee),s=10;return e?t.clientX<r.left-s||t.clientY<o.top&&t.clientX<o.right:t.clientY<r.top-s||t.clientY<o.bottom&&t.clientX<o.left}function RM(t,e,n){var o=je(iu(n.el,n.options.draggable)),r=Kb(n.el,n.options,ee),s=10;return e?t.clientX>r.right+s||t.clientY>o.bottom&&t.clientX>o.left:t.clientY>r.bottom+s||t.clientX>o.right&&t.clientY>o.top}function jM(t,e,n,o,r,s,i,a){var l=o?t.clientY:t.clientX,c=o?n.height:n.width,d=o?n.top:n.left,u=o?n.bottom:n.right,f=!1;if(!i){if(a&&di<c*r){if(!ns&&(ts===1?l>d+c*s/2:l<u-c*s/2)&&(ns=!0),ns)f=!0;else if(ts===1?l<d+di:l>u-di)return-ts}else if(l>d+c*(1-r)/2&&l<u-c*(1-r)/2)return _M(e)}return f=f||i,f&&(l<d+c*s/2||l>u-c*s/2)?l>d+c/2?1:-1:0}function _M(t){return It(D)<It(t)?1:-1}function $M(t){for(var e=t.tagName+t.className+t.src+t.href+t.textContent,n=e.length,o=0;n--;)o+=e.charCodeAt(n);return o.toString(36)}function FM(t){fa.length=0;for(var e=t.getElementsByTagName("input"),n=e.length;n--;){var o=e[n];o.checked&&fa.push(o)}}function ui(t){return setTimeout(t,0)}function Uc(t){return clearTimeout(t)}Ua&&de(document,"touchmove",function(t){(X.active||nr)&&t.cancelable&&t.preventDefault()});X.utils={on:de,off:ce,css:Y,find:Hb,is:function(e,n){return!!Dt(e,n,e,!1)},extend:kM,throttle:Ub,closest:Dt,toggleClass:ht,clone:qb,index:It,nextTick:ui,cancelNextTick:Uc,detectDirection:Jb,getChild:gr,expando:pt};X.get=function(t){return t[pt]};X.mount=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];e[0].constructor===Array&&(e=e[0]),e.forEach(function(o){if(!o.prototype||!o.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(o));o.utils&&(X.utils=en(en({},X.utils),o.utils)),As.mount(o)})};X.create=function(t,e){return new X(t,e)};X.version=vM;var Re=[],Rr,Vc,qc=!1,jl,_l,ma,jr;function WM(){function t(){this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0};for(var e in this)e.charAt(0)==="_"&&typeof this[e]=="function"&&(this[e]=this[e].bind(this))}return t.prototype={dragStarted:function(n){var o=n.originalEvent;this.sortable.nativeDraggable?de(document,"dragover",this._handleAutoScroll):this.options.supportPointer?de(document,"pointermove",this._handleFallbackAutoScroll):o.touches?de(document,"touchmove",this._handleFallbackAutoScroll):de(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(n){var o=n.originalEvent;!this.options.dragOverBubble&&!o.rootEl&&this._handleAutoScroll(o)},drop:function(){this.sortable.nativeDraggable?ce(document,"dragover",this._handleAutoScroll):(ce(document,"pointermove",this._handleFallbackAutoScroll),ce(document,"touchmove",this._handleFallbackAutoScroll),ce(document,"mousemove",this._handleFallbackAutoScroll)),_f(),pi(),xM()},nulling:function(){ma=Vc=Rr=qc=jr=jl=_l=null,Re.length=0},_handleFallbackAutoScroll:function(n){this._handleAutoScroll(n,!0)},_handleAutoScroll:function(n,o){var r=this,s=(n.touches?n.touches[0]:n).clientX,i=(n.touches?n.touches[0]:n).clientY,a=document.elementFromPoint(s,i);if(ma=n,o||this.options.forceAutoScrollFallback||Is||Tn||Qr){$l(n,this.options,a,o);var l=qn(a,!0);qc&&(!jr||s!==jl||i!==_l)&&(jr&&_f(),jr=setInterval(function(){var c=qn(document.elementFromPoint(s,i),!0);c!==l&&(l=c,pi()),$l(n,r.options,c,o)},10),jl=s,_l=i)}else{if(!this.options.bubbleScroll||qn(a,!0)===Yt()){pi();return}$l(n,this.options,qn(a,!1),!1)}}},In(t,{pluginName:"scroll",initializeByDefault:!0})}function pi(){Re.forEach(function(t){clearInterval(t.pid)}),Re=[]}function _f(){clearInterval(jr)}var $l=Ub(function(t,e,n,o){if(e.scroll){var r=(t.touches?t.touches[0]:t).clientX,s=(t.touches?t.touches[0]:t).clientY,i=e.scrollSensitivity,a=e.scrollSpeed,l=Yt(),c=!1,d;Vc!==n&&(Vc=n,pi(),Rr=e.scroll,d=e.scrollFn,Rr===!0&&(Rr=qn(n,!0)));var u=0,f=Rr;do{var p=f,m=je(p),b=m.top,y=m.bottom,w=m.left,v=m.right,S=m.width,C=m.height,x=void 0,I=void 0,N=p.scrollWidth,E=p.scrollHeight,A=Y(p),L=p.scrollLeft,B=p.scrollTop;p===l?(x=S<N&&(A.overflowX==="auto"||A.overflowX==="scroll"||A.overflowX==="visible"),I=C<E&&(A.overflowY==="auto"||A.overflowY==="scroll"||A.overflowY==="visible")):(x=S<N&&(A.overflowX==="auto"||A.overflowX==="scroll"),I=C<E&&(A.overflowY==="auto"||A.overflowY==="scroll"));var G=x&&(Math.abs(v-r)<=i&&L+S<N)-(Math.abs(w-r)<=i&&!!L),K=I&&(Math.abs(y-s)<=i&&B+C<E)-(Math.abs(b-s)<=i&&!!B);if(!Re[u])for(var _=0;_<=u;_++)Re[_]||(Re[_]={});(Re[u].vx!=G||Re[u].vy!=K||Re[u].el!==p)&&(Re[u].el=p,Re[u].vx=G,Re[u].vy=K,clearInterval(Re[u].pid),(G!=0||K!=0)&&(c=!0,Re[u].pid=setInterval((function(){o&&this.layer===0&&X.active._onTouchMove(ma);var me=Re[this.layer].vy?Re[this.layer].vy*a:0,Q=Re[this.layer].vx?Re[this.layer].vx*a:0;typeof d=="function"&&d.call(X.dragged.parentNode[pt],Q,me,t,ma,Re[this.layer].el)!=="continue"||Vb(Re[this.layer].el,Q,me)}).bind({layer:u}),24))),u++}while(e.bubbleScroll&&f!==l&&(f=qn(f,!1)));qc=c}},30),Zb=function(e){var n=e.originalEvent,o=e.putSortable,r=e.dragEl,s=e.activeSortable,i=e.dispatchSortableEvent,a=e.hideGhostForTarget,l=e.unhideGhostForTarget;if(n){var c=o||s;a();var d=n.changedTouches&&n.changedTouches.length?n.changedTouches[0]:n,u=document.elementFromPoint(d.clientX,d.clientY);l(),c&&!c.el.contains(u)&&(i("spill"),this.onSpill({dragEl:r,putSortable:o}))}};function au(){}au.prototype={startIndex:null,dragStart:function(e){var n=e.oldDraggableIndex;this.startIndex=n},onSpill:function(e){var n=e.dragEl,o=e.putSortable;this.sortable.captureAnimationState(),o&&o.captureAnimationState();var r=gr(this.sortable.el,this.startIndex,this.options);r?this.sortable.el.insertBefore(n,r):this.sortable.el.appendChild(n),this.sortable.animateAll(),o&&o.animateAll()},drop:Zb};In(au,{pluginName:"revertOnSpill"});function lu(){}lu.prototype={onSpill:function(e){var n=e.dragEl,o=e.putSortable,r=o||this.sortable;r.captureAnimationState(),n.parentNode&&n.parentNode.removeChild(n),r.animateAll()},drop:Zb};In(lu,{pluginName:"removeOnSpill"});X.mount(new WM);X.mount(lu,au);function zM({unmount:t,groupData:e,allAgents:n,onSave:o}){const[r,s]=T.useState(""),[i,a]=T.useState([]),[l,c]=T.useState("manual"),[d,u]=T.useState(""),[f,p]=T.useState(""),[m,b]=T.useState(1),[y,w]=T.useState(0),v=T.useRef(null);T.useEffect(()=>{if(e){s(e.name||"");const E=(e.agents||[]).filter(A=>n&&n.hasOwnProperty(A));a(E),c(e.flowType||"manual"),u(e.moderatorAgent||""),b(e.maxTurns||1),w(e.timerInSeconds||0)}else s("New Group"),a([]),c("manual"),u(""),b(1),w(0)},[e,n]),T.useEffect(()=>{d&&!i.includes(d)&&u("")},[i,d]),T.useEffect(()=>{if(v.current){const E=X.create(v.current,{animation:150,handle:".agent-sortable-item",onEnd:A=>{const L=[...i],[B]=L.splice(A.oldIndex,1);L.splice(A.newIndex,0,B),a(L)}});return()=>E.destroy()}},[i]);const S=E=>{const A=i.includes(E);a(A?L=>L.filter(B=>B!==E):L=>[...L,E])},C=()=>{o({name:r,members:i,flowType:l,moderator:d,maxTurns:m,timerInSeconds:y})},{selectedList:x,availableList:I}=T.useMemo(()=>{const E=f.toLowerCase(),A=Object.keys(n),L=new Set(i),B=i.filter(K=>K.toLowerCase().includes(E)),G=A.filter(K=>!L.has(K)&&K.toLowerCase().includes(E)).sort();return{selectedList:B,availableList:G}},[f,n,i]),N=i.map(E=>g.jsx("option",{value:E,children:E},E));return g.jsx("div",{id:"agent-group-editor-modal",className:"modal-overlay",style:{display:"flex"},children:g.jsxs("div",{className:"modal-box is-resizable",children:[g.jsxs("div",{className:"modal-header",children:[g.jsx("h3",{id:"agent-group-modal-title",children:e?`Edit Group: ${r}`:"Create New Agent Group"}),g.jsx("button",{type:"button",className:"modal-close-btn",title:"Close",onClick:t,children:"Ã—"})]}),g.jsxs("div",{className:"modal-body",style:{display:"flex",flexDirection:"column"},children:[g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-name-input",children:"Group Name"}),g.jsx("input",{type:"text",id:"group-name-input",value:r,onChange:E=>s(E.target.value)})]}),g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-flow-select",children:"Conversation Flow"}),g.jsxs("select",{id:"group-flow-select",value:l,onChange:E=>c(E.target.value),children:[g.jsx("option",{value:"manual",children:"Manual Selection"}),g.jsx("option",{value:"round-robin",children:"Round Robin"}),g.jsx("option",{value:"auto-moderator",children:"Automated Moderator"})]})]}),l==="round-robin"&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-max-turns-input",children:"Rounds (1-8)"}),g.jsx("input",{type:"number",id:"group-max-turns-input",value:m,onChange:E=>b(Math.max(1,Math.min(8,parseInt(E.target.value,10)))),min:"1",max:"8"})]}),l==="auto-moderator"&&g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-timer-input",children:"Timer (0-180 seconds)"}),g.jsx("input",{type:"number",id:"group-timer-input",value:y,onChange:E=>w(parseInt(E.target.value,10)),min:"0",max:"180",step:"10"}),g.jsx("p",{className:"modal-warning",children:"à¹ƒà¸ªà¹ˆ 0 à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ Moderator à¸—à¸³à¸‡à¸²à¸™à¸£à¸­à¸šà¹€à¸”à¸µà¸¢à¸§à¹à¸¥à¹‰à¸§à¸«à¸¢à¸¸à¸” (à¹‚à¸«à¸¡à¸”à¸›à¸à¸•à¸´)"})]}),g.jsxs("div",{className:"form-group",children:[g.jsx("label",{htmlFor:"group-moderator-select",children:"Moderator Agent"}),g.jsxs("select",{id:"group-moderator-select",value:d,onChange:E=>u(E.target.value),disabled:i.length===0,children:[g.jsx("option",{value:"",children:"-- Select from members --"}),N]})]}),g.jsxs("div",{className:"form-group",style:{display:"flex",flexDirection:"column"},children:[g.jsxs("label",{children:["Group Members (",i.length," selected)"]}),g.jsx("input",{type:"text",placeholder:"Search agents...",value:f,onChange:E=>p(E.target.value),style:{marginBottom:"10px"}}),g.jsxs("div",{id:"group-member-list",children:[g.jsx("div",{ref:v,children:x.map(E=>g.jsxs("div",{className:"agent-sortable-item","data-id":E,children:[g.jsx("input",{type:"checkbox",id:`agent-cb-${E}`,checked:!0,onChange:()=>S(E)}),g.jsxs("label",{htmlFor:`agent-cb-${E}`,children:[n[E]?.icon||"ðŸ¤–"," ",E]})]},E))}),x.length>0&&I.length>0&&g.jsx("hr",{style:{margin:"10px 0"}}),g.jsx("div",{children:I.map(E=>g.jsxs("div",{className:"agent-sortable-item",children:[g.jsx("input",{type:"checkbox",id:`agent-cb-${E}`,checked:!1,onChange:()=>S(E)}),g.jsxs("label",{htmlFor:`agent-cb-${E}`,children:[n[E]?.icon||"ðŸ¤–"," ",E]})]},E))})]})]})]}),g.jsxs("div",{className:"modal-actions",children:[g.jsx("button",{className:"btn btn-secondary",onClick:t,children:"à¸¢à¸à¹€à¸¥à¸´à¸"}),g.jsx("button",{className:"btn",onClick:C,children:"à¸šà¸±à¸™à¸—à¸¶à¸ Group"})]})]})})}function HM(){console.warn("saveAgentGroup is deprecated and should not be called from the new UI.");const t=h.getProject(),e=h.getState().editingGroupName,n=document.getElementById("group-name-input").value.trim();if(!n){k("Group name cannot be empty.","Error");return}if(n!==e&&t.agentGroups[n]){k(`A group named "${n}" already exists.`,"Error");return}const o=document.getElementById("group-moderator-select").value;if(!o){k("Please select a Moderator for the group.","Error");return}const r=window.groupSortable?window.groupSortable.toArray():[],s=document.querySelectorAll("#group-member-list .agent-sortable-item"),i=Array.from(s).filter(c=>c.querySelector('input[type="checkbox"]').checked).map(c=>c.dataset.agentName),a=r.filter(c=>i.includes(c));if(a.length===0){k("A group must have at least one member.","Error");return}const l={agents:a,moderatorAgent:o,flowType:document.getElementById("group-flow-select").value,maxTurns:parseInt(document.getElementById("group-max-turns-input").value,10),timerInSeconds:parseInt(document.getElementById("group-timer-input").value,10)};e&&e!==n&&(delete t.agentGroups[e],t.chatSessions.forEach(c=>{c.linkedEntity?.type==="group"&&c.linkedEntity.name===e&&(c.linkedEntity.name=n)})),t.agentGroups[n]=l,h.setProject(t),h.updateAndPersistState(),h.bus.publish("group:editorShouldClose"),k(`Group "${n}" saved successfully.`,"Success"),h.bus.publish("studio:contentShouldRender")}function UM({groupName:t}){if(!confirm(`Are you sure you want to delete the group "${t}"? This cannot be undone.`))return;const e=h.getProject();delete e.agentGroups[t],h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"),k(`Group "${t}" has been deleted.`,"Success")}function VM(t,e){const n=h.getProject(),o=t.name.trim();if(!o){k("Group name cannot be empty.","Error");return}if(o!==e&&n.agentGroups[o]){k(`A group named "${o}" already exists.`,"Error");return}e&&e!==o&&delete n.agentGroups[e],n.agentGroups[o]={agents:t.members,moderatorAgent:t.moderator,flowType:t.flowType,maxTurns:t.maxTurns,timerInSeconds:t.timerInSeconds},h.setProject(n),h.updateAndPersistState(),k(`Group "${o}" saved successfully.`,"Success"),h.bus.publish("studio:contentShouldRender")}const Kc="group-editor-container";function qM(t){const n=h.getProject().activeEntity,o=h.getStagedEntity(),r=document.createElement("div");r.className="item group-item",r.dataset.groupName=t,n?.type==="group"&&n.name===t?r.classList.add("active"):o?.type==="group"&&o.name===t&&r.classList.add("staged");const s=document.createElement("div");s.className="item-header";const i=document.createElement("span");i.className="item-name";const a=document.createElement("span");a.className="item-icon",a.textContent="ðŸ¤",i.appendChild(a),i.appendChild(document.createTextNode(` ${t}`));const c=at([{label:"Edit...",action:"group:edit"},{label:"Delete",action:"group:delete",isDestructive:!0}]);return c.querySelector("button")?.setAttribute("title","Group actions"),s.append(i,c),r.appendChild(s),r}function KM(t){if(!t)return;const e=h.getProject();if(!e||!e.agentGroups)return;const n=document.createElement("details");n.className="collapsible-section agent-groups-section",n.open=!0;const o=document.createElement("summary");o.className="section-header";const r=document.createElement("h3");r.textContent="ðŸ¤ Agent Groups";const s=document.createElement("div");s.className="section-header-actions";const i=document.createElement("button");i.className="btn-icon",i.dataset.action="group:create",i.title="Create New Group",i.textContent="+";const a=at([{label:"New Group...",action:"group:create"}]);a.classList.add("section-mini-menu"),a.querySelector("button")?.setAttribute("title","Group section menu"),s.append(i,a),o.append(r,s);const l=document.createElement("div");l.className="section-box";const c=document.createElement("div");if(c.id="agentGroupList",c.className="item-list",l.appendChild(c),n.append(o,l),t.appendChild(n),!c)return;const d=e.agentGroups,u=Object.keys(d||{});if(u.length===0){c.innerHTML='<p class="no-items-message">No groups yet.</p>';return}for(const f of u)c.appendChild(qM(f))}function GM(){let t=document.getElementById(Kc);return t||(t=document.createElement("div"),t.id=Kc,document.body.appendChild(t)),t}function JM(){const t=document.getElementById(Kc);t&&(ao.unmount(t),t.remove())}function $f(t=!1,e=null){const n=h.getProject(),o=t?{name:e,...n.agentGroups[e]}:null,r=n.agentPresets||{},s=GM(),a={groupData:o,allAgents:r,onSave:l=>{VM(l,e),Ff()},unmount:Ff};ao.mount(zM,a,s)}function Ff(){console.log("ðŸ“ hideAgentGroupEditor called"),JM(),h.setState("editingGroupName",null)}function YM(){console.log("âœ… Group UI Initialized")}let Fl=null;function XM(t,e,n){const o=document.createElement("div");o.className=`item memory-item ${e?"":"inactive"}`,o.dataset.name=t.name,o.dataset.memoryIndex=n;const s=at([{label:"Edit...",action:"memory:edit",data:{index:n}},{label:"Delete",action:"memory:delete",data:{index:n},isDestructive:!0}]),i=document.createElement("div");i.className=`memory-toggle ${e?"active":""}`,i.title=`Click to ${e?"deactivate":"activate"}`,i.onclick=c=>{c.stopPropagation(),h.bus.publish("memory:toggle",{name:t.name})};const a=document.createElement("span");a.className="item-name",a.textContent=t.name;const l=document.createElement("div");return l.className="item-header",l.appendChild(i),l.appendChild(a),l.appendChild(s),o.appendChild(l),o}function QM(t){if(!t)return;const e=h.getProject();if(!e)return;const n=document.createElement("details");n.className="collapsible-section memory-section",n.open=!0;const o=document.createElement("summary");o.className="section-header";const r=document.createElement("h3");r.textContent="ðŸ§  Command Memories";const s=document.createElement("div");s.className="section-header-actions";const i=document.createElement("button");i.className="btn-icon",i.dataset.action="memory:create",i.title="Create New Memory",i.textContent="+";const l=at([{label:"New Memory...",action:"memory:create"},{label:"Export Package...",action:"memory:exportPackage"},{label:"Import Package...",action:"memory:importPackage"}]);l.classList.add("section-mini-menu"),l.querySelector("button")?.setAttribute("title","Memory section menu"),s.append(i,l),o.append(r,s),n.appendChild(o);const c=document.createElement("div");c.className="section-box",n.appendChild(c);const d=e.agentPresets?.[e.activeEntity?.name];if(!d)c.innerHTML='<p class="no-items-message">Select an Agent to see memories.</p>';else{c.innerHTML=`
            <details id="active-memories-details" open><summary>Active Memories</summary><div id="activeMemoriesList" class="item-list"></div></details>
            <details id="inactiveMemoriesSection" open><summary>Inactive Memories</summary><div id="inactiveMemoriesList" class="item-list"></div></details>
        `;const u=c.querySelector("#activeMemoriesList"),f=c.querySelector("#inactiveMemoriesList"),p=d.activeMemories||[];(e.memories||[]).forEach((b,y)=>{const w=p.includes(b.name);(w?u:f).appendChild(XM(b,w,y))}),Fl&&Fl.destroy(),Fl=new Sortable(u,{animation:150,onEnd:b=>{const y=h.getProject().agentPresets[h.getProject().activeEntity.name];if(!y)return;const w=b.item.dataset.name;y.activeMemories.splice(b.oldDraggableIndex,1),y.activeMemories.splice(b.newDraggableIndex,0,w),h.bus.publish("studio:contentShouldRender")}})}t.appendChild(n)}function Wf(t=null){const e=h.getProject(),n=document.getElementById("memory-editor-modal");if(!n)return;const o=e.memories||[];if(t!==null&&o[t]){const r=o[t];console.log("Editing memory at",t,r),n.querySelector("#memory-modal-title").textContent="Edit Memory",n.querySelector("#memory-name-input").value=r.name,n.querySelector("#memory-content-input").value=r.content,n.querySelector("#memory-edit-index").value=t}else console.log("Create new memory",t,o),n.querySelector("#memory-modal-title").textContent="Create New Memory",n.querySelector("#memory-name-input").value="",n.querySelector("#memory-content-input").value="",n.querySelector("#memory-edit-index").value="";n.style.display="flex"}function zf(){document.getElementById("memory-editor-modal").style.display="none"}function ZM(){h.bus.subscribe("memory:editorShouldClose",zf);const t=document.getElementById("memory-editor-modal");t&&t.addEventListener("click",e=>{const n=e.target;n.matches(".modal-actions .btn:not(.btn-secondary)")&&h.bus.publish("memory:save"),(n.matches(".btn-secondary")||n.closest(".modal-close-btn")||n===t)&&zf()})}let Hf=0;function eT(t=0){return t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(2)} MB`}function tT(t){switch(t){case"uploaded":return"Uploaded";case"indexing":return"Indexing";case"indexed":return"Indexed";case"failed":return"Failed";case"ready":return"Ready";case"binary":return"Binary";case"error":return"Error";default:return"Uploaded"}}function nT(t){const e=(t.type||"").toLowerCase();return e.includes("json")?"ðŸ§©":e.includes("csv")?"ðŸ“Š":e.includes("pdf")?"ðŸ“•":e.includes("word")||e.includes("doc")?"ðŸ“":e.startsWith("text/")?"ðŸ“„":"ðŸ“"}function oT(t){ie(t);const e=t.chatSessions?.find(a=>a.id===t.activeSessionId)||null,n=Bt(e?.ragSettings,{scopeSource:e?.folderId?"folder":"session"}),o=e?.folderId?ze(t,e.folderId):null,r=o?so(o.ragSettings):null,s=n.scopeSource==="folder"&&o?"folder":"session";return{session:e,folder:o,scopeSource:s,settings:s==="folder"&&r?r:n,sessionSettings:n,folderSettings:r}}function rT(t,e){const n=oT(t),{session:o,folder:r,scopeSource:s,settings:i}=n,a=document.createElement("div");a.className="knowledge-rag-controls";const l=i.selectedFileIds.filter(y=>e.some(w=>w.id===y)).length;if(o&&r){const y=document.createElement("label");y.className="knowledge-control",y.innerHTML="<span>RAG Source</span>";const w=document.createElement("select");w.innerHTML=`
            <option value="session">Session</option>
            <option value="folder">Folder</option>
        `,w.value=s,w.addEventListener("change",()=>{h.bus.publish("knowledge:setScopeSource",{scopeSource:w.value})}),y.appendChild(w),a.appendChild(y)}const c=document.createElement("label");c.className="knowledge-control",c.innerHTML="<span>Scope</span>";const d=document.createElement("select");d.innerHTML=`
        <option value="all">All files</option>
        <option value="selected">Selected files only</option>
    `,d.value=i.scopeMode,d.addEventListener("change",()=>{h.bus.publish("knowledge:updateSessionRagSettings",{scopeMode:d.value})}),c.appendChild(d);const u=document.createElement("label");u.className="knowledge-control",u.innerHTML="<span>Top-K</span>";const f=document.createElement("input");f.type="number",f.min="1",f.max="12",f.value=i.retrievalTopK,f.addEventListener("change",()=>{h.bus.publish("knowledge:updateSessionRagSettings",{retrievalTopK:Number(f.value)})}),u.appendChild(f);const p=document.createElement("label");p.className="knowledge-control",p.innerHTML="<span>Token Budget</span>";const m=document.createElement("input");m.type="number",m.min="200",m.max="10000",m.step="100",m.value=i.maxContextTokens,m.addEventListener("change",()=>{h.bus.publish("knowledge:updateSessionRagSettings",{maxContextTokens:Number(m.value)})}),p.appendChild(m);const b=document.createElement("div");return b.className="knowledge-scope-info",s==="folder"&&r?b.textContent=`Selected files: ${l} (using folder "${r.name}")`:b.textContent=`Selected files: ${l} (using current session)`,a.append(c,u,p,b),{controls:a,settings:i,scopeSource:s}}function sT(t){const e=Array.isArray(t?.knowledgeIndex?.chunks)?t.knowledgeIndex.chunks:[],n=new Map;return e.forEach(o=>{o?.fileId&&(n.has(o.fileId)||n.set(o.fileId,[]),n.get(o.fileId).push(o))}),n.forEach(o=>{o.sort((r,s)=>{const i=Number.isFinite(r?.chunkIndex)?r.chunkIndex:0,a=Number.isFinite(s?.chunkIndex)?s.chunkIndex:0;return i-a})}),n}function iT(t,{isSelected:e=!1,isFocused:n=!1,focusedChunk:o=null}={}){const r=document.createElement("div");r.className="item knowledge-item",e&&r.classList.add("selected-for-rag"),n&&r.classList.add("source-focused"),r.dataset.fileId=t.id;const s=document.createElement("div");s.className="item-header";const i=document.createElement("span");i.className="item-name",i.textContent=`${nT(t)} ${t.name}`;const a=document.createElement("div");if(a.className="item-actions",t.textContent){const f=document.createElement("button");f.className=`btn-icon ${e?"is-active":""}`,f.title=e?"Remove from selected scope":"Add to selected scope",f.dataset.action="knowledge:toggleSelection",f.innerHTML=`<span class="material-symbols-outlined">${e?"check_circle":"radio_button_unchecked"}</span>`,a.appendChild(f);const p=document.createElement("button");p.className="btn-icon",p.title="Re-index file",p.dataset.action="knowledge:reindex",p.innerHTML='<span class="material-symbols-outlined">refresh</span>',a.appendChild(p)}const l=document.createElement("button");l.className="btn-icon danger",l.title="Delete file",l.dataset.action="knowledge:delete",l.innerHTML='<span class="material-symbols-outlined">delete</span>',a.appendChild(l),s.append(i,a);const c=document.createElement("div");c.className="knowledge-file-meta";const d=Number.isFinite(t.chunkCount)?`${t.chunkCount} chunk(s)`:"0 chunk(s)";c.textContent=`${eT(t.size||0)} â€¢ ${tT(t.status)} â€¢ ${d} â€¢ ${new Date(t.uploadedAt).toLocaleString("th-TH")}`;const u=document.createElement("div");if(u.className="knowledge-file-excerpt",u.textContent=t.excerpt||"No preview available.",r.append(s,c,u),o){const f=document.createElement("div");f.className="knowledge-focus-preview";const p=document.createElement("div");p.className="knowledge-focus-preview-header";const m=document.createElement("span");m.className="knowledge-focus-preview-title";const b=Number.isFinite(o.chunkIndex)?o.chunkIndex+1:1;m.textContent=`Focused source: #chunk${b}`;const y=document.createElement("button");y.type="button",y.className="btn-icon knowledge-focus-clear",y.title="Clear focused source",y.dataset.action="knowledge:clearFocus",y.innerHTML='<span class="material-symbols-outlined">close</span>';const w=document.createElement("div");w.className="knowledge-focus-preview-text",w.textContent=o.text||"No text available for this chunk.",p.append(m,y),f.append(p,w),r.appendChild(f)}if(t.note){const f=document.createElement("div");f.className="knowledge-file-note",f.textContent=t.note,r.appendChild(f)}return r}function aT(t){if(!t)return;const e=h.getProject();if(!e)return;ie(e);const n=document.createElement("details");n.className="collapsible-section knowledge-files-section",n.open=!0;const o=document.createElement("summary");o.className="section-header";const r=document.createElement("h3");r.textContent="ðŸ“š Knowledge Files";const s=document.createElement("div");s.className="section-header-actions";const i=document.createElement("button");i.className="btn-icon",i.dataset.action="knowledge:upload",i.title="Upload Files",i.textContent="+";const a=at([{label:"Upload Files...",action:"knowledge:upload"},{label:"Re-index All",action:"knowledge:reindexAll"},{label:"Clear All",action:"knowledge:clearAll",isDestructive:!0}]);a.classList.add("section-mini-menu"),a.querySelector("button")?.setAttribute("title","Knowledge section menu"),s.append(i,a),o.append(r,s);const l=document.createElement("div");l.className="section-box";const c=Array.isArray(e.knowledgeFiles)?e.knowledgeFiles:[],d=sT(e),u=h.getState().knowledgeFocus||null,{controls:f,settings:p}=rT(e,c),m=document.createElement("div");m.className="item-list";const b=new Set(p.selectedFileIds||[]);c.length===0?m.innerHTML='<p class="no-items-message">No knowledge files yet.</p>':c.forEach(w=>{const v=d.get(w.id)||[],S=!!(u?.fileId&&u.fileId===w.id),C=S&&(v.find(x=>x.chunkIndex===u.chunkIndex)||v[0])||null;m.appendChild(iT(w,{isSelected:b.has(w.id),isFocused:S,focusedChunk:C}))}),l.append(f,m),n.append(o,l),t.appendChild(n);const y=Number(u?.requestedAt)||0;if(u?.fileId&&y>Hf){const w=Array.from(m.querySelectorAll(".knowledge-item")).find(v=>v.dataset.fileId===u.fileId);w&&(Hf=y,requestAnimationFrame(()=>{w.scrollIntoView({behavior:"smooth",block:"center"})}))}}function kr(t){t&&(Ca(t),io(t),as(t),vs(t),cu(t),ey(t))}const H={editingBookId:null,editingWorldItemId:null,editingChapterMetaSessionId:null,creatingBook:!1,creatingWorld:!1,creatingWorldItem:null},F={modal:null,collapsedBookIds:new Set,collapsedActKeys:new Set},xe={activeBookId:null,tabByBookId:new Map,composerDocByBookId:new Map},ro={activeSessionIds:new Set,batchByBookId:new Map},gt={draggingSessionId:null,draggingBookId:null,justDroppedAt:0};function Uf(t){if(!Array.isArray(t))return[];const e=new Set,n=[];return t.forEach(o=>{const r=String(o??"").trim();!r||e.has(r)||(e.add(r),n.push(r))}),n}function vs(t){if(!t||typeof t!="object")return null;(!t.worldUiState||typeof t.worldUiState!="object")&&(t.worldUiState={}),(!t.worldUiState.bookTree||typeof t.worldUiState.bookTree!="object")&&(t.worldUiState.bookTree={});const e=t.worldUiState.bookTree;return e.collapsedBookIds=Uf(e.collapsedBookIds),e.collapsedActKeys=Uf(e.collapsedActKeys),e}function cu(t){if(!t||typeof t!="object")return null;(!t.worldUiState||typeof t.worldUiState!="object")&&(t.worldUiState={}),(!t.worldUiState.bookChanges||typeof t.worldUiState.bookChanges!="object")&&(t.worldUiState.bookChanges={});const e=t.worldUiState.bookChanges;return(!e.lastViewedAtByBookId||typeof e.lastViewedAtByBookId!="object"||Array.isArray(e.lastViewedAtByBookId))&&(e.lastViewedAtByBookId={}),Object.keys(e.lastViewedAtByBookId).forEach(n=>{const o=Number(e.lastViewedAtByBookId[n]);Number.isFinite(o)&&o>0?e.lastViewedAtByBookId[n]=Math.round(o):delete e.lastViewedAtByBookId[n]}),e}function lT(t,e){if(!t||!e)return 0;const n=cu(t),o=Number(n?.lastViewedAtByBookId?.[e]);return Number.isFinite(o)&&o>0?Math.round(o):0}function Gc(t,e){if(!t||!e)return!1;const n=cu(t);return n?(n.lastViewedAtByBookId[e]=Date.now(),h.setProject(t),h.setAutoSaveDirty(!0),h.bus.publish("world:dataChanged",{bookId:e,reason:"bookChanges:viewed"}),!0):!1}function cT(t){const e=String(t||"").trim().toLowerCase();return e==="both"?"Chat + Composer":e==="composer"?"Composer":e==="chat"?"Chat":"â€”"}function dT(t){const e=String(t||"").trim().toLowerCase();return e==="delta"?"Auto (Delta)":e==="manual"?"Manual":"â€”"}function uT(t){const e=Number(t);if(!Number.isFinite(e)||e<=0)return"Unknown time";try{return new Date(e).toLocaleString()}catch{return"Unknown time"}}function ey(t){const e=vs(t);if(!e){F.collapsedBookIds.clear(),F.collapsedActKeys.clear();return}F.collapsedBookIds=new Set(e.collapsedBookIds),F.collapsedActKeys=new Set(e.collapsedActKeys)}function Vf(t){if(!t)return;const e=vs(t);e&&(e.collapsedBookIds=Array.from(F.collapsedBookIds).sort(),e.collapsedActKeys=Array.from(F.collapsedActKeys).sort(),h.setProject(t),h.setAutoSaveDirty(!0))}function pT(){H.editingBookId=null,H.editingWorldItemId=null,H.editingChapterMetaSessionId=null,H.creatingBook=!1,H.creatingWorld=!1,H.creatingWorldItem=null,F.modal=null,F.collapsedBookIds.clear(),F.collapsedActKeys.clear(),xe.activeBookId=null,xe.tabByBookId.clear(),xe.composerDocByBookId.clear(),ro.activeSessionIds.clear(),ro.batchByBookId.clear()}function fT(t={}){const e=String(t.sessionId||"").trim();if(!e)return;String(t.state||"").trim().toLowerCase()==="start"?ro.activeSessionIds.add(e):ro.activeSessionIds.delete(e),he()}function mT(t={}){const e=String(t.bookId||"").trim();if(!e)return;String(t.state||"").trim().toLowerCase()==="start"?ro.batchByBookId.set(e,{source:String(t.source||"composer").trim().toLowerCase()==="chat"?"chat":"composer",startedAt:Date.now(),total:Number.isFinite(Number(t.total))?Math.max(0,Math.round(Number(t.total))):0}):ro.batchByBookId.delete(e),he()}function Ut(t){const e=String(t??"").trim();if(!e)return null;const n=Number(e);if(!Number.isFinite(n))return null;const o=Math.round(n);return o>0?o:null}function J(t,e,n=""){if(!t)return n;const o=t.querySelector(e);return!(o instanceof HTMLInputElement)&&!(o instanceof HTMLTextAreaElement)&&!(o instanceof HTMLSelectElement)?n:o.value}function Ko(t,e,n=!1){if(!t)return n;const o=t.querySelector(e);return!(o instanceof HTMLInputElement)||o.type!=="checkbox"?n:o.checked}function hT(t,e,n="text/plain;charset=utf-8"){const o=String(t||"").trim()||"download.txt",r=new Blob([String(e??"")],{type:n}),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s,i.download=o,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}function gT(t,e="book-export"){return String(t||"").trim().replace(/[^\w\u0E00-\u0E7F\s-]/g,"").replace(/\s+/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"").toLowerCase()||e}function br(t){const e=String(t||"").trim().toLowerCase();switch(e){case"agent":case"composer":case"blueprint":case"world":case"codex":case"changes":case"settings":return e==="blueprint"?"composer":e==="codex"?"world":e;default:return"overview"}}function du(t){switch(String(t||"").trim()){case"treatment":case"synopsis":case"outline":case"sceneBeats":return String(t).trim();default:return"treatment"}}function ty(t){return t?br(xe.tabByBookId.get(t)):"overview"}function Lt(t,e){t&&xe.tabByBookId.set(t,br(e))}function ny(t){return t?du(xe.composerDocByBookId.get(t)):"treatment"}function qf(t,e){t&&xe.composerDocByBookId.set(t,du(e))}function oy(){let t=document.getElementById("book-sidebar-slot");if(t)return t;const e=document.querySelector("#sessions-panel .sessions-frame");return e?(t=document.createElement("div"),t.id="book-sidebar-slot",e.insertBefore(t,e.firstChild||null),t):null}function Kf(){const t=document.createElement("div");return t.id="world-workspace",t.className="workspace hidden",t.innerHTML=`
        <div class="world-workspace-shell">
            <div class="world-workspace-header">
                <div class="world-workspace-heading">
                    <h2 id="world-workspace-title">World</h2>
                    <p id="world-workspace-meta">Open a project to start building worlds.</p>
                </div>
                <div class="world-workspace-header-actions">
                    <button type="button" class="btn btn-small btn-secondary" data-action="world:proposeFromCurrentChat">Propose Updates</button>
                </div>
            </div>
            <div id="world-workspace-content" class="world-workspace-content"></div>
        </div>
    `,t}function Gf(){const t=document.createElement("div");return t.id="book-workspace",t.className="workspace hidden",t.innerHTML=`
        <div class="book-workspace-shell">
            <div class="book-workspace-header">
                <div class="book-workspace-heading">
                    <h2 id="book-workspace-title">Book</h2>
                    <p id="book-workspace-meta">Select a Book to open its overview, agent, and planning tools.</p>
                </div>
                <div id="book-workspace-header-actions" class="book-workspace-header-actions"></div>
            </div>
            <div id="book-workspace-tabs" class="book-workspace-tabs"></div>
            <div id="book-workspace-content" class="book-workspace-content"></div>
        </div>
    `,t}function uu(){let t=document.getElementById("world-workspace");if(t&&document.getElementById("world-workspace-content"))return t;const e=document.querySelector("#main-chat-panel .main-content-wrapper");return e?t?(document.getElementById("world-workspace-content")||(t.replaceWith(Kf()),t=document.getElementById("world-workspace")),t):(t=Kf(),e.appendChild(t),t):t||null}function pu(){let t=document.getElementById("book-workspace");if(t&&document.getElementById("book-workspace-content")&&document.getElementById("book-workspace-header-actions"))return t;const e=document.querySelector("#main-chat-panel .main-content-wrapper");return e?t?((!document.getElementById("book-workspace-content")||!document.getElementById("book-workspace-header-actions"))&&(t.replaceWith(Gf()),t=document.getElementById("book-workspace")),t):(t=Gf(),e.appendChild(t),t):t||null}function bT(){const t=oy(),e=pu(),n=uu();return{bookSlot:t,bookWorkspace:e,worldWorkspace:n}}function ry(){let t=document.getElementById("book-sidebar-settings-modal");return t||(t=document.createElement("div"),t.id="book-sidebar-settings-modal",t.className="modal-overlay",t.style.display="none",t.innerHTML=`
        <div class="modal-box world-book-settings-modal-box">
            <div class="world-book-settings-modal-header">
                <h3 id="book-sidebar-settings-modal-title">Book Settings</h3>
                <button type="button" class="modal-close-btn" data-action="worldui:bookSidebarModalClose" title="Close">&times;</button>
            </div>
            <div id="book-sidebar-settings-modal-meta" class="world-book-settings-modal-meta"></div>
            <div id="book-sidebar-settings-modal-body" class="world-book-settings-modal-body"></div>
        </div>
    `,t.addEventListener("click",e=>{const n=e.target;n instanceof Element&&(n===t||n.closest(".modal-close-btn"))&&(H.creatingBook=!1,H.editingBookId=null,H.editingChapterMetaSessionId=null,F.modal=null,he())}),document.body.appendChild(t),t)}function Ns(t){return t?.activeSessionId&&(t.chatSessions||[]).find(e=>e.id===t.activeSessionId)||null}function on(t,e){return!t||!e?null:(t.worlds||[]).find(n=>n.id===e)||null}function be(t,e){return!t||!e?null:(t.books||[]).find(n=>n.id===e)||null}function En(t,e){return!t||!e?null:(t.chatSessions||[]).find(n=>n.id===e)||null}function fu(t){return Object.keys(t?.agentPresets||{})}function yr(t){return t?.activeEntity?.type==="agent"&&t.activeEntity.name&&t.agentPresets?.[t.activeEntity.name]?t.activeEntity.name:fu(t)[0]||""}function Pt(t,e){const n=String(e?.bookAgentConfig?.agentPresetName||"").trim();return n&&t?.agentPresets?.[n]?n:""}function jo(t,e){const n=e?.codexAgentConfig&&typeof e.codexAgentConfig=="object"?e.codexAgentConfig:{};if(n.useBookAgent!==!1)return Pt(t,e);const o=String(n.agentPresetName||"").trim();return o&&t?.agentPresets?.[o]?o:""}function Jf(t,e){if(!t||!e)return{project:t,book:e,seeded:!1,presetName:""};const n=!!Pt(t,e),o=!!jo(t,e);if(n||o)return{project:t,book:e,seeded:!1,presetName:o?jo(t,e):Pt(t,e)};const r=yr(t);if(!r)return{project:t,book:e,seeded:!1,presetName:""};ge("book:update",{bookId:e.id,bookAgentConfig:{agentPresetName:r},codexAgentConfig:{useBookAgent:!0}});const s=h.getProject()||t,i=be(s,e.id)||e;return{project:s,book:i,seeded:!0,presetName:r}}function yT(t){if(typeof t=="string")return t;if(Array.isArray(t))return t.map(e=>typeof e=="string"?e:!e||typeof e!="object"?"":typeof e.text=="string"?e.text:typeof e.content=="string"?e.content:"").filter(Boolean).join(`
`);if(t&&typeof t=="object"){if(typeof t.text=="string")return t.text;if(typeof t.content=="string")return t.content}return""}function sy(t,{maxMessages:e=12}={}){return(Array.isArray(t?.messages)?t.messages:[]).slice(-Math.max(1,e)).filter(o=>o&&o.role!=="system").map(o=>yT(o.content)).filter(Boolean).join(`
`).toLowerCase()}function wT(t,e){const n=[];if(!t||!e)return n;const o=e.bookId?be(t,e.bookId):null,r=o?.linkedWorldId?on(t,o.linkedWorldId):null,s=e.writingMode===Pu?Pu:Ms,i=Number.isFinite(e.chapterNumber)?e.chapterNumber:null,a=Number.isFinite(e?.revealScope?.asOfChapter)?e.revealScope.asOfChapter:null;if(!e.bookId)return n.push({level:"info",code:"not_linked",message:"Current chat is not linked to a Book yet, so chapter continuity checks are limited."}),n;if(!o)return n.push({level:"warning",code:"book_missing",message:"Chat references a missing Book. Reassign this chat to a valid Book."}),n;if(o.linkedWorldId?r||n.push({level:"warning",code:"world_missing",message:"This Book links to a World that no longer exists."}):n.push({level:"warning",code:"book_no_world",message:"This Book has no linked World. Canon retrieval and spoiler gating will not run."}),i||n.push({level:"warning",code:"chapter_number_missing",message:"Chapter number is missing. Reveal scope and chapter ordering may drift."}),s===Ms&&!a&&!i&&n.push({level:"warning",code:"reveal_scope_missing",message:"Writing mode is active but reveal scope is not set. Add chapter number or reveal as-of chapter."}),s===Ms&&i&&a&&a>i&&n.push({level:"warning",code:"reveal_ahead",message:`Reveal scope is ahead of this chapter (as-of Ch.${a} > Ch.${i}), which can leak future canon.`}),o&&i){const l=(t.chatSessions||[]).filter(c=>c&&c.id!==e.id&&c.bookId===o.id&&Number(c.chapterNumber)===Number(i)).slice(0,3);l.length>0&&n.push({level:"warning",code:"duplicate_chapter_number",message:`Chapter number Ch.${i} is also used by ${l.map(c=>`"${c.name||"Untitled chat"}"`).join(", ")}.`})}if(r&&Array.isArray(r.items)){const l={mode:s,asOfChapter:a||i||null},c=r.items.filter(u=>!dw(u,l));s===Ms&&c.length>0&&n.push({level:"info",code:"spoiler_guard_active",message:`Spoiler guard is active: ${c.length} gated world item(s) hidden at this chapter scope.`});const d=sy(e);if(d&&c.length>0){const u=c.map(f=>String(f?.title||"").trim()).filter(f=>f.length>=3).filter(f=>d.includes(f.toLowerCase())).slice(0,3);u.length>0&&n.push({level:"warning",code:"mentions_gated_item",message:`Recent chat mentions gated canon before reveal scope: ${u.join(", ")}.`})}}return n}function vT(t=[]){const e=document.createElement("div");e.className="studio-world-continuity-block";const n=document.createElement("div");if(n.className="studio-world-continuity-heading",n.textContent="Continuity Warnings (Basic)",e.appendChild(n),!Array.isArray(t)||t.length===0){const r=document.createElement("div");return r.className="studio-world-inline-note",r.textContent="No basic continuity warnings detected for the current chapter setup.",e.appendChild(r),e}const o=document.createElement("div");return o.className="studio-world-continuity-list",t.forEach(r=>{const s=document.createElement("div");s.className=`studio-world-continuity-row is-${r.level==="warning"?"warning":"info"}`;const i=pe(r.level==="warning"?"Warning":"Info",r.level==="warning"?"pending":"muted"),a=document.createElement("div");a.className="studio-world-continuity-text",a.textContent=r.message||"Continuity signal",s.append(i,a),o.appendChild(s)}),e.appendChild(o),e}function ha(t,e){if(!e)return 0;const n=Array.isArray(e?.structure?.chapterSessionIds)?e.structure.chapterSessionIds:[];return n.length>0?n.length:(t?.chatSessions||[]).filter(o=>o?.bookId===e.id).length}function ST(t){return Array.isArray(t?.history)?t.history.filter(e=>e&&(e.role==="user"||e.role==="assistant")).length:0}function iy(t,e){if(!t||!e)return[];const n=Array.isArray(t.chatSessions)?t.chatSessions:[],o=new Map(n.map(a=>[a?.id,a])),r=Array.isArray(e?.structure?.chapterSessionIds)?e.structure.chapterSessionIds:[],s=[],i=new Set;return r.forEach(a=>{const l=o.get(a);!l||l.bookId!==e.id||l.archived===!0||i.has(a)||(s.push(l),i.add(a))}),n.forEach(a=>{!a||a.bookId!==e.id||a.archived===!0||i.has(a.id)||(s.push(a),i.add(a.id))}),s}function Va(t,e){const n=iy(t,e),o=new Map;return(Array.isArray(e?.structure?.acts)?e.structure.acts:[]).forEach((s,i)=>{const a=Number(s?.order),l=Number.isFinite(a)&&Math.round(a)>0?Math.round(a):i+1,c=`act:${l}`;o.set(c,{key:c,actNumber:l,title:String(s?.title||"").trim()||`Act ${l}`,summary:String(s?.summary||""),label:String(s?.title||"").trim()||`Act ${l}`,sessions:[]})}),n.forEach(s=>{const i=Number.isFinite(s?.actNumber)?s.actNumber:null,a=i?`act:${i}`:"act:unassigned";o.has(a)||o.set(a,{key:a,actNumber:i,title:i?`Act ${i}`:"Unassigned",summary:"",label:i?`Act ${i}`:"Unassigned",sessions:[]}),o.get(a).sessions.push(s)}),Array.from(o.values()).sort((s,i)=>s.actNumber===null&&i.actNumber!==null?1:i.actNumber===null&&s.actNumber!==null?-1:s.actNumber!==i.actNumber?(s.actNumber||0)-(i.actNumber||0):String(s.label||"").localeCompare(String(i.label||"")))}function _r(t=""){return String(t||"").replace(/\r\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Wl(t=""){return String(t||"").replace(/\u00A0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n[ \t]+/g,`
`).replace(/[ \t]{2,}/g," ").trim()}function Ar(t=""){return String(t||"").replace(/\\/g,"\\\\").replace(/([`*_{}\[\]()#+\-!>])/g,"\\$1")}function kT(t=""){const e=String(t||"").trim();if(!e)return"";const n=document.createElement("div");n.innerHTML=e;const o=(s,i={})=>{if(!s)return"";if(s.nodeType===Node.TEXT_NODE)return s.textContent||"";if(s.nodeType!==Node.ELEMENT_NODE)return"";const a=String(s.tagName||"").toLowerCase(),l=()=>Array.from(s.childNodes).map(d=>o(d,i)).join(""),c=()=>Wl(l());if(a==="br")return`
`;if(a==="hr")return`

***

`;if(a==="p"){const d=c();return d?`${d}

`:`
`}if(/^h[1-6]$/.test(a)){const d=Number(a[1])||2,u=c();return u?`${"#".repeat(d)} ${u}

`:""}if(a==="blockquote"){const d=_r(l());return d?`${d.split(`
`).map(f=>f?`> ${f}`:">").join(`
`)}

`:""}if(a==="pre"){const d=(s.textContent||"").replace(/\r\n/g,`
`).trimEnd();return d?`
\`\`\`
${d}
\`\`\`

`:""}if(a==="code"){if(String(s.parentElement?.tagName||"").toLowerCase()==="pre")return"";const d=Wl(s.textContent||"");return d?`\`${d.replace(/`/g,"\\`")}\``:""}if(a==="a"){const d=c()||Wl(s.getAttribute("href")||""),u=String(s.getAttribute("href")||"").trim();return u?`[${d}](${u})`:d}if(a==="strong"||a==="b"){const d=c();return d?`**${d}**`:""}if(a==="em"||a==="i"){const d=c();return d?`*${d}*`:""}if(a==="ul"||a==="ol"){const d=a==="ol",u=Array.from(s.children).filter(f=>String(f.tagName||"").toLowerCase()==="li").map((f,p)=>{const m=d?`${p+1}. `:"- ",b=_r(o(f,{...i,listDepth:(i.listDepth||0)+1}));if(!b)return"";const y="  ".repeat(i.listDepth||0),w=b.split(`
`);return[`${y}${m}${w[0]||""}`,...w.slice(1).map(v=>`${y}  ${v}`)].join(`
`)}).filter(Boolean);return u.length?`${u.join(`
`)}

`:""}return a==="li"?_r(l()):a==="div"||a==="section"||a==="article"?`${Array.from(s.childNodes).map(d=>o(d,i)).join("")}`:l()},r=Array.from(n.childNodes).map(s=>o(s)).join("");return _r(r)}function xT(t,e={}){const n=String(e?.chapterTitleMode||"number_and_title").trim(),o=Number.isFinite(t?.chapterNumber)?t.chapterNumber:null,r=String(t?.chapterTitle||"").trim(),s=String(t?.name||"").trim()||"Untitled Chapter";return n==="title_only"?r||(o?`Chapter ${o}`:s):o&&r?`Chapter ${o}: ${r}`:o?`Chapter ${o}`:r||s}function CT(t,e,n={}){if(!t||!e)return{markdown:"",fileName:"book-export.md",chapterCount:0,exportedChapters:0,missingContentCount:0};const r={...e&&typeof e.exportProfile=="object"&&e.exportProfile?e.exportProfile:{},...n?.exportProfile&&typeof n.exportProfile=="object"?n.exportProfile:{}},s=Va(t,e),i=iy(t,e),a=String(r.title||e.name||"Untitled Book").trim(),l=String(r.subtitle||"").trim(),c=String(r.author||"").trim(),d=String(r.frontMatterNotes||"").trim(),u=r.includeChapterSummaries===!0,f=new Date().toISOString(),p=[];p.push(`# ${Ar(a)}`),l&&p.push(`
_${Ar(l)}_`),c&&p.push(`
Author: ${Ar(c)}`),p.push(`
<!-- Exported from PromptPrim Book Workspace on ${f} -->`),d&&(p.push(`
## Front Matter Notes
`),p.push(d));let m=0,b=0;s.forEach(S=>{const C=S.actNumber?`${S.title||`Act ${S.actNumber}`}`:`${S.title||"Unassigned"}`;p.push(`
## ${Ar(C)}
`),String(S.summary||"").trim()&&p.push(`${String(S.summary||"").trim()}
`),(S.sessions||[]).forEach(x=>{m+=1;const I=xT(x,r);if(p.push(`### ${Ar(I)}
`),u){const A=String(x?.chapterSummary||"").trim();A&&p.push(`> Summary: ${A}
`)}const N=typeof x?.composerContent=="string"?x.composerContent.trim():"";let E=kT(N);if(!E){const A=String(x?.chapterSummary||"").trim();E=A||"_No chapter composer content yet._",A||(b+=1)}p.push(E),p.push("")})}),i.length===0&&p.push(`
_No chapters in this book yet._
`);const y=`${_r(p.join(`
`))}
`,w=new Date().toISOString().slice(0,10),v=`${gT(a,"book-export")}_${w}.md`;return{markdown:y,fileName:v,chapterCount:i.length,exportedChapters:m,missingContentCount:b}}function ET(t,e){return!t||!Number.isFinite(e)?null:(Array.isArray(t?.structure?.acts)?t.structure.acts:[]).find(o=>Number(o?.order)===Math.round(e))||null}function IT(t,e){const n=(t?.chatSessions||[]).filter(r=>r?.bookId===e?.id).reduce((r,s)=>{const i=Number(s?.actNumber);return Number.isFinite(i)&&i>r?Math.round(i):r},0),o=(Array.isArray(e?.structure?.acts)?e.structure.acts:[]).reduce((r,s)=>{const i=Number(s?.order);return Number.isFinite(i)&&i>r?Math.round(i):r},0);return Math.max(1,n,o)+(Math.max(n,o)>0?1:0)}function ga(t){const e=Number.isFinite(t?.chapterNumber)?t.chapterNumber:null,n=String(t?.chapterTitle||"").trim(),o=String(t?.name||"").trim();return e&&n?`Chapter ${e}: ${n}`:e?`Chapter ${e}`:n||o||"Untitled Chapter"}function ay(t=""){const e=String(t||"").trim();switch(e){case"create_item":return"Create Item";case"edit_item":return"Edit Item";case"delete_item":return"Delete Item";case"create_event":return"Create Event";case"update_relationship":return"Update Relationship";case"mark_conflict":return"Mark Conflict";case"suggest_reveal_change":return"Reveal Change";default:return e||"Proposal"}}function AT(t=""){switch(String(t||"").trim().toLowerCase()){case"approved":return"Approved";case"rejected":return"Rejected";case"edited":return"Edited";default:return"Pending"}}function Gs(t={}){const e=t?.afterPayload||{},n=t?.beforePayload||{};return e?.title?e.title:e?.name?e.name:n?.title?n.title:n?.name?n.name:t.targetItemId?`Item ${t.targetItemId}`:"Untitled change"}function NT(t={}){const e=String(t?.proposalType||""),n=t?.afterPayload||{};return e==="create_item"?`Create ${n.type||"item"} "${Gs(t)}"`:e==="edit_item"?`Edit "${Gs(t)}"`:e==="delete_item"?`Delete "${Gs(t)}"`:`${ay(e)} â€¢ ${Gs(t)}`}function Jc(t){try{return JSON.stringify(t)}catch{return null}}function Yf(t){return!!t&&typeof t=="object"&&!Array.isArray(t)}function zl(t,{maxLen:e=180}={}){if(t===void 0)return"â€”";if(t===null)return"null";if(typeof t=="string"){const o=t.replace(/\s+/g," ").trim();return o?o.length>e?`${o.slice(0,e-1)}â€¦`:o:"(empty)"}if(typeof t=="number"||typeof t=="boolean")return String(t);const n=Jc(t);return n?n.length>e?`${n.slice(0,e-1)}â€¦`:n:String(t)}function MT(t,e){return Jc(t)===Jc(e)}function TT(t={}){const e=String(t?.proposalType||"").trim(),n=Yf(t?.beforePayload)?t.beforePayload:{},o=Yf(t?.afterPayload)?t.afterPayload:{},r=["type","title","summary","description","status","visibility","revealGate","tags","sourceRefs","content"],s=Array.from(new Set([...r,...Object.keys(n),...Object.keys(o)]));return e==="create_item"?s.filter(i=>o[i]!==void 0).map(i=>({key:i,before:void 0,after:o[i],kind:"added"})):e==="delete_item"?s.filter(i=>n[i]!==void 0).map(i=>({key:i,before:n[i],after:void 0,kind:"removed"})):e==="edit_item"?s.filter(i=>n[i]!==void 0||o[i]!==void 0).filter(i=>!MT(n[i],o[i])).map(i=>({key:i,before:n[i],after:o[i],kind:n[i]===void 0?"added":o[i]===void 0?"removed":"changed"})):[]}function PT(t,e={}){const n=TT(e),o=e?.beforePayload,r=e?.afterPayload;if(!(o!=null||r!=null)&&n.length===0)return;const i=document.createElement("details");i.className="studio-world-change-diff",i.open=String(e.status||"pending").toLowerCase()==="pending";const a=document.createElement("summary"),l=n.length>0?`${n.length} field${n.length===1?"":"s"}`:"payload";a.textContent=`Diff â€¢ ${l}`,i.appendChild(a);const c=document.createElement("div");if(c.className="studio-world-change-diff-body",n.length>0)n.forEach(d=>{const u=document.createElement("div");u.className=`studio-world-change-diff-row is-${d.kind}`;const f=document.createElement("div");f.className="studio-world-change-diff-key",f.textContent=d.key;const p=document.createElement("div");p.className="studio-world-change-diff-value is-before",p.textContent=zl(d.before);const m=document.createElement("div");m.className="studio-world-change-diff-value is-after",m.textContent=zl(d.after),u.append(f,p,m),c.appendChild(u)});else{const d=document.createElement("div");d.className="studio-world-inline-note",d.textContent="No field-level diff available for this proposal type yet.",c.appendChild(d)}if(Array.isArray(e.evidenceRefs)&&e.evidenceRefs.length>0){const d=document.createElement("div");d.className="studio-world-change-evidence",d.textContent=`Evidence refs: ${e.evidenceRefs.slice(0,4).map(u=>typeof u=="string"?u:u?.type&&u?.id?`${u.type}:${u.id}`:u?.id?String(u.id):zl(u,{maxLen:48})).join(", ")}${e.evidenceRefs.length>4?"â€¦":""}`,c.appendChild(d)}i.appendChild(c),t.appendChild(i)}function ly(t){if(!Number.isFinite(t))return"Unknown time";const e=Date.now()-t;if(!Number.isFinite(e))return"Unknown time";const n=Math.abs(e),o=6e4,r=60*o,s=24*r;return n<o?"just now":n<r?`${Math.round(n/o)}m ago`:n<s?`${Math.round(n/r)}h ago`:`${Math.round(n/s)}d ago`}function BT(t,e){return e?(t?.books||[]).filter(n=>n.linkedWorldId===e).length:0}function cy(t,e){if(!e)return{mode:"unassigned",ownerBook:null,linkedBooks:[]};const n=(t?.books||[]).filter(i=>i?.linkedWorldId===e.id),o=e?.ownerBookId?be(t,e.ownerBookId):null,r=n.length,s=String(e?.scope||"").trim().toLowerCase();return s==="shared"||r>1?{mode:"shared",ownerBook:o,linkedBooks:n}:s==="book"||o||r===1?{mode:"book",ownerBook:o||n[0]||null,linkedBooks:n}:{mode:"unassigned",ownerBook:null,linkedBooks:n}}function qa(t,{sectionClassName:e="",createAction:n=null,createTitle:o="Create",dropdownOptions:r=[]}={}){const s=document.createElement("details");s.className=`collapsible-section ${e}`.trim(),s.open=!0;const i=document.createElement("summary");i.className="section-header";const a=document.createElement("h3");a.textContent=t;const l=document.createElement("div");if(l.className="section-header-actions",n){const d=document.createElement("button");d.type="button",d.className="btn-icon",d.dataset.action=n,d.title=o,d.textContent="+",l.appendChild(d)}if(Array.isArray(r)&&r.length>0){const d=at(r);d.classList.add("section-mini-menu"),l.appendChild(d)}i.append(a,l);const c=document.createElement("div");return c.className="section-box",s.append(i,c),{section:s,box:c}}function pe(t,e="default"){const n=document.createElement("span");return n.className=`studio-world-pill ${e!=="default"?`is-${e}`:""}`.trim(),n.textContent=t,n}function Ka(t=[]){const e=document.createElement("div");return e.className="studio-world-item-meta",t.filter(Boolean).forEach((n,o)=>{const r=document.createElement("span");if(r.textContent=n,e.appendChild(r),o<t.filter(Boolean).length-1){const s=document.createElement("span");s.className="studio-world-meta-sep",s.textContent="â€¢",e.appendChild(s)}}),e}function te(t,e){const n=document.createElement("label");n.className="studio-world-inline-field";const o=document.createElement("span");return o.className="studio-world-inline-field-label",o.textContent=t,n.append(o,e),n}function vt({className:t="studio-world-inline-input",name:e="",value:n="",placeholder:o=""}={}){const r=document.createElement("input");return r.type="text",r.className=t,e&&(r.name=e),r.value=n??"",o&&(r.placeholder=o),r}function No({name:t="",value:e="",min:n=1,placeholder:o=""}={}){const r=document.createElement("input");return r.type="number",r.className="studio-world-inline-input",t&&(r.name=t),r.min=String(n),r.step="1",r.value=e??"",o&&(r.placeholder=o),r}function zt({name:t="",value:e="",rows:n=3,placeholder:o=""}={}){const r=document.createElement("textarea");return r.className="studio-world-inline-textarea",t&&(r.name=t),r.rows=n,r.value=e??"",o&&(r.placeholder=o),r}function $t({name:t="",value:e="",options:n=[]}={}){const o=document.createElement("select");return o.className="studio-world-inline-select",t&&(o.name=t),n.forEach(r=>{const s=document.createElement("option");typeof r=="string"?(s.value=r,s.textContent=r):(s.value=r.value,s.textContent=r.label||r.value),String(s.value)===String(e??"")&&(s.selected=!0),o.appendChild(s)}),o}function Ht({saveAction:t,cancelAction:e,saveLabel:n="Save",cancelLabel:o="Cancel",dataset:r={}}){const s=document.createElement("div");s.className="studio-world-inline-editor-actions";const i=document.createElement("button");i.type="button",i.className="btn btn-small",i.dataset.action=t,Object.entries(r||{}).forEach(([l,c])=>{c!=null&&(i.dataset[l]=String(c))}),i.textContent=n;const a=document.createElement("button");return a.type="button",a.className="btn btn-small btn-secondary",a.dataset.action=e,Object.entries(r||{}).forEach(([l,c])=>{c!=null&&(a.dataset[l]=String(c))}),a.textContent=o,s.append(i,a),s}function dy(t,e){const n=document.createElement("div");n.className="studio-world-inline-editor",n.dataset.rowActionShield="true",n.dataset.bookId=e.id;const o=document.createElement("div");o.className="studio-world-inline-grid",o.appendChild(te("Book name",vt({name:"bookName",value:e.name||"",placeholder:"Book name"})));const r=[{value:"",label:"(No linked world)"}].concat((t.worlds||[]).map(a=>({value:a.id,label:a.name||a.id})));o.appendChild(te("Linked world",$t({name:"linkedWorldId",value:e.linkedWorldId||"",options:r}))),o.appendChild(te("Description",zt({name:"bookDescription",value:e.description||"",rows:2,placeholder:"Optional book description"})));const s=document.createElement("label");s.className="studio-world-inline-checkbox";const i=document.createElement("input");return i.type="checkbox",i.name="autoNumberChapters",i.checked=e.autoNumberChapters!==!1,s.append(i,document.createTextNode(" Auto-number chapters")),o.appendChild(s),n.appendChild(o),n.appendChild(Ht({saveAction:"worldui:bookEditSave",cancelAction:"worldui:bookEditCancel",dataset:{bookId:e.id}})),n}function OT(t){const e=document.createElement("div");e.className="studio-world-inline-editor",e.dataset.rowActionShield="true";const n=document.createElement("div");n.className="studio-world-inline-grid",n.appendChild(te("Book name",vt({name:"newBookName",value:"",placeholder:`Book ${(t?.books?.length||0)+1}`})));const o=H.creatingBook&&typeof H.creatingBook=="object"&&H.creatingBook.linkedWorldId||"",r=[{value:"",label:"Create new Book World (Recommended)"}].concat((t?.worlds||[]).map(l=>({value:l.id,label:l.name||l.id})));n.appendChild(te("Use existing world (optional)",$t({name:"newBookLinkedWorldId",value:o,options:r})));const s=document.createElement("div");s.className="studio-world-inline-note",s.style.gridColumn="1 / -1",s.textContent="Leave the recommended option to create a dedicated Book World. Choose an existing world only when this Book should share a codex (e.g. a series).",n.appendChild(s),n.appendChild(te("Description",zt({name:"newBookDescription",value:"",rows:2,placeholder:"Optional book description"})));const i=document.createElement("label");i.className="studio-world-inline-checkbox";const a=document.createElement("input");return a.type="checkbox",a.name="newBookAutoNumber",a.checked=!0,i.append(a,document.createTextNode(" Auto-number chapters")),n.appendChild(i),e.appendChild(n),e.appendChild(Ht({saveAction:"worldui:bookCreateSave",cancelAction:"worldui:bookCreateCancel",saveLabel:"Create Book"})),e}function LT(t){const e=document.createElement("div");e.className="studio-world-inline-editor",e.dataset.rowActionShield="true";const n=document.createElement("div");n.className="studio-world-inline-grid";const o=H.creatingWorld&&typeof H.creatingWorld=="object"&&String(H.creatingWorld.scope||"").trim().toLowerCase()==="shared"?"shared":"unassigned";if(n.appendChild(te(o==="shared"?"Shared world name":"World name",vt({name:"newWorldName",value:"",placeholder:`World ${(t?.worlds?.length||0)+1}`}))),n.appendChild(te("Description",zt({name:"newWorldDescription",value:"",rows:2,placeholder:"Optional world description"}))),o==="shared"){const r=document.createElement("div");r.className="studio-world-inline-note",r.style.gridColumn="1 / -1",r.textContent="Shared Worlds can be linked to multiple Books (useful for a series or shared universe).",n.appendChild(r)}return e.appendChild(n),e.appendChild(Ht({saveAction:"worldui:worldCreateSave",cancelAction:"worldui:worldCreateCancel",saveLabel:o==="shared"?"Create Shared World":"Create World"})),e}function DT(t){const e=document.createElement("div");e.className="studio-world-inline-editor",e.dataset.rowActionShield="true";const n=H.creatingWorldItem&&typeof H.creatingWorldItem=="object"?H.creatingWorldItem:{},o=document.createElement("div");o.className="studio-world-inline-grid";const r=(t?.worlds||[]).map(s=>({value:s.id,label:s.name||s.id}));return o.appendChild(te("World",$t({name:"newItemWorldId",value:n.worldId||t?.activeWorldId||"",options:r}))),o.appendChild(te("Type",$t({name:"newItemType",value:n.type||"entity",options:["entity","place","rule","event","note","source","relationship"]}))),o.appendChild(te("Title",vt({name:"newItemTitle",value:"",placeholder:"Item title"}))),o.appendChild(te("Summary",zt({name:"newItemSummary",value:"",rows:3,placeholder:"Summary / note"}))),o.appendChild(te("Tags",vt({name:"newItemTags",value:"",placeholder:"comma, separated, tags"}))),o.appendChild(te("Visibility",$t({name:"newItemVisibility",value:"revealed",options:[{value:"revealed",label:"revealed"},{value:"gated",label:"gated"}]}))),o.appendChild(te("Reveal @ chapter",No({name:"newItemRevealChapter",value:"",placeholder:"optional"}))),e.appendChild(o),e.appendChild(Ht({saveAction:"worldui:itemCreateSave",cancelAction:"worldui:itemCreateCancel",saveLabel:"Create Item"})),e}function RT(t){const e=document.createElement("div");e.className="studio-world-inline-editor",e.dataset.rowActionShield="true",e.dataset.sessionId=t.id;const n=document.createElement("div");return n.className="studio-world-inline-grid is-compact",n.appendChild(te("Act",No({name:"actNumber",value:t.actNumber?String(t.actNumber):"",placeholder:"e.g. 1"}))),n.appendChild(te("Chapter",No({name:"chapterNumber",value:t.chapterNumber?String(t.chapterNumber):"",placeholder:"e.g. 3"}))),n.appendChild(te("Reveal as-of Ch.",No({name:"asOfChapter",value:t.revealScope?.asOfChapter?String(t.revealScope.asOfChapter):"",placeholder:"blank = follow chapter"}))),n.appendChild(te("Writing mode",$t({name:"writingMode",value:t.writingMode||"writing",options:[{value:"writing",label:"writing"},{value:"author",label:"author"}]}))),n.appendChild(te("Chapter title",vt({name:"chapterTitle",value:t.chapterTitle||"",placeholder:"Optional chapter title"}))),n.appendChild(te("Chapter summary",zt({name:"chapterSummary",value:t.chapterSummary||"",rows:4,placeholder:"Short summary for Book overview cards"}))),e.appendChild(n),e.appendChild(Ht({saveAction:"worldui:chapterMetaSave",cancelAction:"worldui:chapterMetaCancel",dataset:{sessionId:t.id}})),e}function jT(t,e,n=null){const o=document.createElement("div");o.className="studio-world-inline-editor",o.dataset.rowActionShield="true",o.dataset.bookId=t.id,o.dataset.actNumber=String(e);const r=document.createElement("div");return r.className="studio-world-inline-grid is-compact",r.appendChild(te("Act number",No({name:"actNumber",value:String(e||""),min:1}))),r.appendChild(te("Act title",vt({name:"actTitle",value:String(n?.title||`Act ${e}`),placeholder:`Act ${e}`}))),r.appendChild(te("Act summary",zt({name:"actSummary",value:String(n?.summary||""),rows:3,placeholder:"Optional arc / section note"}))),o.appendChild(r),o.appendChild(Ht({saveAction:"worldui:actEditSave",cancelAction:"worldui:actEditCancel",dataset:{bookId:t.id,actNumber:e}})),o}function _T(t,e){const n=document.createElement("div");n.className="studio-world-inline-editor",n.dataset.rowActionShield="true",n.dataset.sessionId=e.id;const o=document.createElement("div");o.className="studio-world-inline-grid is-compact";const r=e?.bookId?be(t,e.bookId):null,s=Number.isFinite(Number(e?.actNumber))?Math.round(Number(e.actNumber)):null;if(o.appendChild(te("Act number (blank = Unassigned)",No({name:"moveActNumber",value:s?String(s):"",placeholder:"e.g. 2"}))),r){const i=Array.isArray(r?.structure?.acts)?r.structure.acts:[],a=document.createElement("div");a.className="world-book-settings-modal-quick-actions";const l=document.createElement("button");if(l.type="button",l.className="btn btn-small btn-secondary",l.dataset.action="worldui:chapterMoveToActChoose",l.dataset.sessionId=e.id,l.dataset.actNumber="",l.textContent="Unassigned",a.appendChild(l),i.slice().sort((c,d)=>Number(c?.order||0)-Number(d?.order||0)).forEach(c=>{const d=Number.isFinite(Number(c?.order))?Math.round(Number(c.order)):null;if(!d)return;const u=document.createElement("button");u.type="button",u.className="btn btn-small btn-secondary",u.dataset.action="worldui:chapterMoveToActChoose",u.dataset.sessionId=e.id,u.dataset.actNumber=String(d),u.textContent=String(c?.title||`Act ${d}`),a.appendChild(u)}),a.childNodes.length>0){const c=document.createElement("div");c.className="world-book-settings-modal-helper",c.innerHTML='<div class="studio-world-inline-note">Quick choose:</div>',c.appendChild(a),o.appendChild(c)}}return n.appendChild(o),n.appendChild(Ht({saveAction:"worldui:chapterMoveToActSave",cancelAction:"worldui:chapterMoveToActCancel",saveLabel:"Move Chapter",dataset:{sessionId:e.id}})),n}function $T(t,e){const n=document.createElement("div");n.className="studio-world-inline-editor",n.dataset.rowActionShield="true",n.dataset.worldId=t,n.dataset.itemId=e.id;const o=document.createElement("div");if(o.className="studio-world-inline-grid",o.appendChild(te("Type",$t({name:"itemType",value:e.type||"note",options:["entity","place","rule","event","note","source","relationship"]}))),o.appendChild(te("Title",vt({name:"itemTitle",value:e.title||"",placeholder:"Item title"}))),o.appendChild(te("Summary",zt({name:"itemSummary",value:e.summary||"",rows:3,placeholder:"Summary / note"}))),o.appendChild(te("Tags",vt({name:"itemTags",value:Array.isArray(e.tags)?e.tags.join(", "):"",placeholder:"comma, separated, tags"}))),o.appendChild(te("Visibility",$t({name:"itemVisibility",value:e.visibility||"revealed",options:[{value:"revealed",label:"revealed"},{value:"gated",label:"gated"}]}))),o.appendChild(te("Reveal @ chapter",No({name:"itemRevealChapter",value:e.revealGate?.kind==="chapter_threshold"&&Number.isFinite(e.revealGate?.value)?String(e.revealGate.value):"",placeholder:"blank = manual gate / none"}))),e.revealGate?.kind==="manual_unlock"){const r=document.createElement("label");r.className="studio-world-inline-checkbox";const s=document.createElement("input");s.type="checkbox",s.name="itemManualUnlocked",s.checked=e.revealGate?.unlocked===!0,r.append(s,document.createTextNode(" Manual gate unlocked")),o.appendChild(r)}return n.appendChild(o),n.appendChild(Ht({saveAction:"worldui:itemEditSave",cancelAction:"worldui:itemEditCancel",dataset:{worldId:t,itemId:e.id}})),n}function uy(t,e=[]){if(!Array.isArray(e)||e.length===0)return;const n=document.createElement("div");n.className="item-actions";const o=at(e);n.appendChild(o),t.appendChild(n)}function mu(t,{secondary:e=null}={}){const n=document.createElement("div");n.className="book-tree-row-label";const o=document.createElement("div");if(o.className="book-tree-row-primary",o.textContent=t,n.appendChild(o),e){const r=document.createElement("div");r.className="book-tree-row-secondary",r.textContent=e,n.appendChild(r)}return n}function hu(t,e){const n=String(t||"").trim(),o=Number.isFinite(Number(e))?String(Math.round(Number(e))):"unassigned";return`${n}::${o}`}function FT(t,e,n,o){const r=document.createElement("div");r.className="book-tree-row is-chapter",r.draggable=!0,o?.id===n.id&&r.classList.add("active"),r.dataset.action="worldui:bookChapterOpen",r.dataset.bookId=e.id,r.dataset.sessionId=n.id;const s=mu(ga(n),n.name&&n.name!==ga(n)?n.name:null);r.appendChild(s);const i=document.createElement("div");i.className="book-tree-row-actions";const a=at([{label:"Open Chapter",action:"worldui:bookChapterOpen",data:{bookId:e.id,sessionId:n.id}},{label:"Chapter Settings...",action:"worldui:chapterSettingsOpen",data:{sessionId:n.id}},{label:"Move Up",action:"chapter:moveInBookOrder",data:{sessionId:n.id,direction:"up"}},{label:"Move Down",action:"chapter:moveInBookOrder",data:{sessionId:n.id,direction:"down"}},{label:"Move to Act...",action:"worldui:chapterMoveToActOpen",data:{sessionId:n.id}},{label:"Remove from Book (Keep Chat)",action:"chapter:detachFromBook",data:{sessionId:n.id}},{label:"Delete Chapter + Chat",action:"session:delete",data:{sessionId:n.id},isDestructive:!0}]);return i.appendChild(a),r.appendChild(i),r}function WT(t,e,n,o){const r=document.createElement("div");r.className="book-tree-act-block",r.dataset.bookId=e.id;const s=Number.isFinite(n?.actNumber)?n.actNumber:null;s&&(r.dataset.actNumber=String(s));const i=hu(e.id,s),a=F.collapsedActKeys.has(i);a&&r.classList.add("is-collapsed"),r.dataset.actCollapseKey=i;const l=document.createElement("div");l.className="book-tree-row is-act";const c=String(n?.title||n?.label||"Act").trim()||"Act",d=s?`Act ${s}`:"Unassigned",u=c!==d?c:d,f=c!==d?d:null,p=document.createElement("button");p.type="button",p.className="book-tree-collapse-toggle is-act-toggle",p.dataset.action="worldui:actToggleOpen",p.dataset.bookId=e.id,s&&(p.dataset.actNumber=String(s)),p.dataset.open=a?"true":"false",p.setAttribute("aria-expanded",String(!a)),p.setAttribute("aria-label",a?`Expand ${d}`:`Collapse ${d}`),p.title=a?`Expand ${d}`:`Collapse ${d}`,p.innerHTML=`<span aria-hidden="true">${a?"â–¸":"â–¾"}</span>`,l.appendChild(p),l.appendChild(mu(u,{secondary:f}));const m=document.createElement("div");m.className="book-tree-row-actions";const b=[{label:a?"Expand Act":"Collapse Act",action:"worldui:actToggleOpen",data:{bookId:e.id,actNumber:s,open:a}}];s&&b.push({label:"New Chapter in Act",action:"worldui:bookChapterCreate",data:{bookId:e.id,actNumber:s}},{label:"Act Settings...",action:"worldui:actSettingsOpen",data:{bookId:e.id,actNumber:s}}),b.length>0&&(m.appendChild(at(b)),l.appendChild(m)),r.appendChild(l);const y=document.createElement("div");return y.className="book-tree-children",(n.sessions||[]).forEach(w=>{y.appendChild(FT(t,e,w,o))}),r.appendChild(y),r}function zT(t,e,n){const o=document.createElement("div");o.className="book-tree-book-block",t.activeBookId===e.id&&o.classList.add("is-active-book");const r=F.collapsedBookIds.has(e.id);r&&o.classList.add("is-collapsed"),o.dataset.bookId=e.id;const s=document.createElement("div");s.className="book-tree-row is-book",t.activeBookId===e.id&&s.classList.add("active"),s.dataset.action="worldui:bookOpenWorkspace",s.dataset.bookId=e.id;const i=document.createElement("button");i.type="button",i.className="book-tree-collapse-toggle",i.dataset.action="worldui:bookToggleOpen",i.dataset.bookId=e.id,i.dataset.open=r?"true":"false",i.setAttribute("aria-expanded",String(!r)),i.setAttribute("aria-label",r?"Expand Book":"Collapse Book"),i.title=r?"Expand Book":"Collapse Book",i.innerHTML=`<span aria-hidden="true">${r?"â–¸":"â–¾"}</span>`,s.appendChild(i);const a=on(t,e.linkedWorldId),l=ha(t,e);s.appendChild(mu(e.name||"Untitled Book",[a?`World: ${a.name}`:null,`${l} chapter${l===1?"":"s"}`].filter(Boolean).join(" â€¢ ")));const c=document.createElement("div");c.className="book-tree-row-actions";const d=document.createElement("button");d.type="button",d.className="btn-icon book-tree-quick-agent-btn",d.dataset.action="worldui:bookAgentOpen",d.dataset.bookId=e.id,d.title="Open Book Agent",d.setAttribute("aria-label","Open Book Agent"),d.textContent="AI",c.appendChild(d);const u=at([{label:"Open Book Workspace",action:"worldui:bookOpenWorkspace",data:{bookId:e.id,tab:"overview"}},{label:"Open Book Agent",action:"worldui:bookAgentOpen",data:{bookId:e.id}},{label:r?"Expand Book":"Collapse Book",action:"worldui:bookToggleOpen",data:{bookId:e.id,open:r}},{label:"Book Settings...",action:"worldui:bookSettingsOpen",data:{bookId:e.id}},{label:"New Chapter",action:"worldui:bookChapterCreate",data:{bookId:e.id}},{label:"New Act...",action:"worldui:bookActCreate",data:{bookId:e.id}},{label:"Re-number Chapters",action:"book:renumberChapters",data:{bookId:e.id}},{label:"Set Active",action:"book:setActive",data:{bookId:e.id}},{label:"Import Current Chat as Chapter",action:"chapter:assignToBook",data:{bookId:e.id}},{label:"Delete Book",action:"book:delete",data:{bookId:e.id},isDestructive:!0}]);c.appendChild(u),s.appendChild(c),o.appendChild(s);const f=Va(t,e),p=document.createElement("div");if(p.className="book-tree-children is-book-root",f.length===0){const m=document.createElement("div");m.className="book-tree-empty",m.innerHTML=`
            <div>No chapters in this Book yet.</div>
            <div class="book-tree-empty-actions">
                <button type="button" class="btn btn-small" data-action="worldui:bookChapterCreate" data-book-id="${e.id}">New Chapter</button>
                <button type="button" class="btn btn-small btn-secondary" data-action="chapter:assignToBook" data-book-id="${e.id}">Import Current Chat</button>
                <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookActCreate" data-book-id="${e.id}">New Act</button>
            </div>
        `,p.appendChild(m)}else f.forEach(m=>{p.appendChild(WT(t,e,m,n))});return o.appendChild(p),o}function HT(){const t=ry(),e=t?.querySelector("#book-sidebar-settings-modal-title"),n=t?.querySelector("#book-sidebar-settings-modal-meta"),o=t?.querySelector("#book-sidebar-settings-modal-body");if(!t||!e||!n||!o)return;const r=F.modal,s=h.getProject();if(!r||!s){t.style.display="none",o.innerHTML="",n.textContent="";return}if(kr(s),o.innerHTML="",r.type==="book-create")e.textContent="Create Book",n.textContent="Set up the book and optionally link it to a World.",o.appendChild(OT(s));else if(r.type==="book-settings"){const i=be(s,r.bookId);if(!i)e.textContent="Book Settings",n.textContent="Book not found.";else{const a=on(s,i.linkedWorldId);e.textContent="Book Settings",n.textContent=[i.name||"Untitled Book",a?`World: ${a.name}`:"No linked world",`${ha(s,i)} chapter${ha(s,i)===1?"":"s"}`].join(" â€¢ ");const l=document.createElement("div");l.className="world-book-settings-modal-quick-actions",l.innerHTML=`
                <button type="button" class="btn btn-small btn-secondary" data-action="book:setActive" data-book-id="${i.id}">Set Active</button>
                <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookChapterCreate" data-book-id="${i.id}">New Chapter</button>
                <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookActCreate" data-book-id="${i.id}">New Act</button>
                <button type="button" class="btn btn-small btn-secondary" data-action="chapter:assignToBook" data-book-id="${i.id}">Import Current Chat</button>
            `,o.appendChild(l),o.appendChild(dy(s,i))}}else if(r.type==="act-settings"){const i=be(s,r.bookId),a=Number.isFinite(Number(r.actNumber))?Math.round(Number(r.actNumber)):null,l=i&&a?ET(i,a):null;if(e.textContent="Act Settings",n.textContent=[i?.name||null,a?`Act ${a}`:null].filter(Boolean).join(" â€¢ ")||"Act settings",!i||!a){const c=document.createElement("div");c.className="studio-world-inline-note",c.textContent="Act not found.",o.appendChild(c)}else{const c=document.createElement("div");c.className="world-book-settings-modal-quick-actions",c.innerHTML=`
                <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookChapterCreate" data-book-id="${i.id}" data-act-number="${a}">New Chapter in Act</button>
                <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookSettingsOpen" data-book-id="${i.id}">Back to Book Settings</button>
            `,o.appendChild(c),o.appendChild(jT(i,a,l))}}else if(r.type==="chapter-settings"){const i=En(s,r.sessionId),a=i?.bookId?be(s,i.bookId):null;if(e.textContent="Chapter Settings",n.textContent=[a?a.name:null,i?.name||null].filter(Boolean).join(" â€¢ ")||"Chapter settings",i){const l=document.createElement("div");l.className="world-book-settings-modal-quick-actions",l.innerHTML=`<button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookChapterOpen" data-session-id="${i.id}" ${a?`data-book-id="${a.id}"`:""}>Open Chapter Chat</button>`,o.appendChild(l),o.appendChild(RT(i))}else{const l=document.createElement("div");l.className="studio-world-inline-note",l.textContent="Chapter session not found.",o.appendChild(l)}}else if(r.type==="chapter-move-act"){const i=En(s,r.sessionId),a=i?.bookId?be(s,i.bookId):null;if(e.textContent="Move Chapter to Act",n.textContent=[a?.name||null,i?ga(i):null].filter(Boolean).join(" â€¢ ")||"Move chapter",!i||!a){const l=document.createElement("div");l.className="studio-world-inline-note",l.textContent="Chapter or Book not found.",o.appendChild(l)}else o.appendChild(_T(s,i))}else e.textContent="Book Settings",n.textContent="";t.style.display="flex"}function UT(t,e){vs(e),ey(e);const n=Ns(e),o=on(e,e.activeWorldId),{section:r,box:s}=qa("ðŸ“– Books",{sectionClassName:"book-projects-section",createAction:"worldui:bookCreateStart",createTitle:"Create Book",dropdownOptions:[{label:"New Book...",action:"worldui:bookCreateStart"},o?{label:"New Book (link active world)",action:"worldui:bookCreateStart",data:{linkedWorldId:o.id}}:null,{label:"Import Current Chat as Chapter...",action:"chapter:assignToBookPrompt"}].filter(Boolean)});r.open=!0;const i=document.createElement("div");i.className="book-tree-list";const a=Array.isArray(e.books)?e.books:[],l=new Set(a.map(u=>String(u?.id||"")).filter(Boolean));let c=!1;Array.from(F.collapsedBookIds).forEach(u=>{l.has(u)||(F.collapsedBookIds.delete(u),c=!0)});const d=new Set;if(a.forEach(u=>{Va(e,u).forEach(p=>d.add(hu(u.id,Number.isFinite(p?.actNumber)?p.actNumber:null)))}),Array.from(F.collapsedActKeys).forEach(u=>{d.has(u)||(F.collapsedActKeys.delete(u),c=!0)}),c){const u=vs(e);u&&(u.collapsedBookIds=Array.from(F.collapsedBookIds).sort(),u.collapsedActKeys=Array.from(F.collapsedActKeys).sort())}if(a.length===0){const u=document.createElement("div");u.className="book-tree-empty",u.innerHTML=`
            <div>No books yet.</div>
            <button type="button" class="btn btn-small" data-action="worldui:bookCreateStart">Create Book</button>
        `,i.appendChild(u)}else a.forEach(u=>{i.appendChild(zT(e,u,n))});s.appendChild(i),t.appendChild(r)}function py(t,e){const n=document.createElement("div");n.className="item world-entry-item";const o=document.createElement("div");o.className="item-header";const r=document.createElement("div");r.className="item-name",r.textContent=`${e.title||"Untitled"} (${e.type||"note"})`,o.appendChild(r),uy(o,[{label:"Edit Inline",action:"worldui:itemEditStart",data:{worldId:t,itemId:e.id}},{label:"Edit...",action:"world:itemEditPrompt",data:{worldId:t,itemId:e.id}},{label:"Delete",action:"world:itemDelete",data:{worldId:t,itemId:e.id},isDestructive:!0}]),n.appendChild(o),(e.summary||e.visibility==="gated")&&n.appendChild(Ka([e.summary?String(e.summary).slice(0,80):null,e.visibility==="gated"?`Gated${e.revealGate?.value?` @ch${e.revealGate.value}`:""}`:"Revealed"]));const s=document.createElement("div");s.className="studio-world-item-footer";const i=document.createElement("button");return i.type="button",i.className="btn btn-small btn-secondary",i.dataset.action=H.editingWorldItemId===e.id?"worldui:itemEditCancel":"worldui:itemEditStart",i.dataset.worldId=t,i.dataset.itemId=e.id,i.textContent=H.editingWorldItemId===e.id?"Close Editor":"Edit",s.appendChild(i),n.appendChild(s),H.editingWorldItemId===e.id&&n.appendChild($T(t,e)),n}function VT(t){const e=document.createElement("div");e.className="item world-entry-item";const n=document.createElement("div");n.className="item-header";const o=document.createElement("div");o.className="item-name",o.textContent=`${t.title||"Untitled"} (${t.type||"note"})`,n.appendChild(o),e.appendChild(n),e.appendChild(Ka([t.summary?String(t.summary).slice(0,90):null,t.visibility==="gated"?"Gated":"Visible"]));const r=document.createElement("div");return r.className="studio-world-item-footer",t.status&&r.appendChild(pe(t.status,"muted")),Array.isArray(t.tags)&&t.tags.length>0&&r.appendChild(pe(`#${t.tags[0]}`,"muted")),r.childNodes.length>0&&e.appendChild(r),e}function qT(t){const e=document.createElement("div");e.className="studio-world-quick-actions";const n=document.createElement("div");n.className="studio-world-inline-note",n.textContent=t?`Quick add to "${t.name}"`:"Select or create a World to add canon items.",e.appendChild(n);const o=document.createElement("div");return o.className="studio-world-quick-button-row",[["entity","Entity"],["place","Place"],["rule","Rule"],["event","Event"],["note","Note"]].forEach(([s,i])=>{const a=document.createElement("button");a.type="button",a.className="btn btn-small btn-secondary",a.textContent=`+ ${i}`,a.disabled=!t,a.dataset.action="worldui:itemCreateStart",t&&(a.dataset.worldId=t.id,a.dataset.type=s),o.appendChild(a)}),e.appendChild(o),e}function KT(t,e){const n=document.createElement("div");n.className="item world-library-item",e.activeWorldId===t.id&&n.classList.add("active"),n.dataset.action="world:setActive",n.dataset.worldId=t.id;const o=cy(e,t),r=document.createElement("div");r.className="item-header";const s=document.createElement("div");if(s.className="item-name",s.textContent=t.name||"Untitled World",r.appendChild(s),uy(r,[{label:"Set Active",action:"world:setActive",data:{worldId:t.id}},{label:"Rename...",action:"world:renamePrompt",data:{worldId:t.id}},{label:"Add Item...",action:"worldui:itemCreateStart",data:{worldId:t.id}},{label:"Delete World",action:"world:delete",data:{worldId:t.id},isDestructive:!0}]),n.appendChild(r),n.appendChild(Ka([`${(t.items||[]).length} items`,`${BT(e,t.id)} linked books`,o.mode==="shared"?`Shared${o.ownerBook?` (owner: ${o.ownerBook.name})`:""}`:o.mode==="book"?`Book-owned${o.ownerBook?` (${o.ownerBook.name})`:""}`:"Unassigned"])),e.activeWorldId===t.id){const i=document.createElement("div");i.className="studio-world-item-footer",i.appendChild(pe("Active World","active")),o.mode==="shared"?i.appendChild(pe("Shared World","linked")):o.mode==="book"&&i.appendChild(pe("Book World","muted")),n.appendChild(i)}return n}function GT(t,e){const n=on(e,e.activeWorldId),o=be(e,e.activeBookId),{section:r,box:s}=qa("ðŸŒ Worlds",{sectionClassName:"world-library-section",createAction:null,dropdownOptions:[{label:"Create Shared World...",action:"worldui:worldCreateStart",data:{scope:"shared"}},{label:"New Item in Active World...",action:"worldui:itemCreateStart"},o?{label:"Link Active Book to World...",action:"book:linkWorldPrompt",data:{bookId:o.id}}:null].filter(Boolean)});s.appendChild(qT(n)),H.creatingWorld&&s.appendChild(LT(e)),H.creatingWorldItem&&s.appendChild(DT(e));const i=document.createElement("div");i.className="item-list";const a=Array.isArray(e.worlds)?e.worlds:[];a.length===0?i.innerHTML='<p class="no-items-message">No worlds yet. Create a Book from the left (recommended) or use the section menu to create a shared world.</p>':a.forEach(u=>{i.appendChild(KT(u,e))}),s.appendChild(i);const l=document.createElement("div");l.className="studio-world-preview";const c=document.createElement("div");c.className="studio-world-focus-title",c.textContent=n?`Active World Items: ${n.name}`:"Active World Items",l.appendChild(c);const d=document.createElement("div");if(d.className="item-list",!n)d.innerHTML='<p class="no-items-message">Select a world to inspect its items.</p>';else if(!Array.isArray(n.items)||n.items.length===0)d.innerHTML='<p class="no-items-message">No items yet in this world.</p>';else{const u=[...n.items].sort((f,p)=>(p.updatedAt||0)-(f.updatedAt||0)).slice(0,8);if(u.forEach(f=>{d.appendChild(py(n.id,f))}),n.items.length>u.length){const f=document.createElement("p");f.className="no-items-message",f.textContent=`Showing ${u.length} of ${n.items.length} items (most recently updated).`,d.appendChild(f)}}l.appendChild(d),s.appendChild(l),t.appendChild(r)}function JT(t,e,n){const o=document.createElement("div");o.className="studio-world-focus-card";const r=document.createElement("div");r.className="studio-world-focus-title",r.textContent="World Peek";const s=document.createElement("div");if(s.className="studio-world-focus-meta",!e)return s.textContent="Open a chat session to preview chapter-aware world context.",o.append(r,s),o;if(!n?.enabled){const f=[e.bookId?"Book linked":"No Book link",e.chapterNumber?`Chapter ${e.chapterNumber}`:"No chapter number"];return s.textContent=`${f.join(" â€¢ ")} â€¢ World context unavailable`,o.append(r,s),o}const i=n.diagnostics||{},a=n.access||{},l=[n.book?.name?`Book: ${n.book.name}`:null,n.world?.name?`World: ${n.world.name}`:null,a.mode?`Mode: ${a.mode}`:null,Number.isFinite(a.asOfChapter)?`As-of Ch.${a.asOfChapter}`:null,`${i.selectedItemCount||0} selected`,`${i.hiddenItemCount||0} gated hidden`].filter(Boolean);s.textContent=l.join(" â€¢ ");const c=document.createElement("div");c.className="studio-world-focus-actions";const d=document.createElement("button");d.type="button",d.className="btn btn-small btn-secondary",d.dataset.action="ui:openWorldWorkspace",d.textContent="Open World";const u=document.createElement("button");return u.type="button",u.className="btn btn-small btn-secondary",u.dataset.action="world:proposeFromCurrentChat",u.textContent="Propose Updates",c.append(d,u),o.append(r,s,c),o}function YT(t,e){if(!t||!e)return;kr(e);const n=Ns(e),o=n?fd(e,n,{queryText:sy(n,{maxMessages:8}),maxItems:6}):null,{section:r,box:s}=qa("ðŸ§­ World Peek",{sectionClassName:"world-peek-section"});r.open=!0,s.appendChild(JT(e,n,o)),n&&s.appendChild(vT(wT(e,n)));const i=document.createElement("div");if(i.className="item-list",!n)i.innerHTML='<p class="no-items-message">Open a chat session to preview selected world context.</p>';else if(o?.enabled)!Array.isArray(o.selectedItems)||o.selectedItems.length===0?i.innerHTML='<p class="no-items-message">No visible world items selected for the current prompt scope.</p>':o.selectedItems.slice(0,6).forEach(a=>{i.appendChild(VT(a))});else{const a=document.createElement("p");a.className="no-items-message";const l=String(o?.reason||"no_world");l==="no_world"?a.textContent="No linked World found for the current chat/book.":l==="no_book"?a.textContent="Current chat is not linked to a Book yet.":a.textContent=`World context unavailable (${l}).`,i.appendChild(a)}s.appendChild(i),t.appendChild(r)}function Yc(t,e){const n=document.createElement("div");n.className="item world-change-item",n.dataset.changeId=e.id;const o=String(e.status||"pending").toLowerCase();o==="pending"&&n.classList.add("is-pending");const r=on(t,e.worldId),s=be(t,e.bookId),i=En(t,e.chapterSessionId),a=document.createElement("div");a.className="item-header";const l=document.createElement("div");l.className="item-name",l.textContent=NT(e),a.appendChild(l);const c=document.createElement("div");if(c.className="item-actions",o==="pending"){const p=document.createElement("button");p.type="button",p.className="btn btn-small",p.dataset.action="world:changeReview",p.dataset.status="approved",p.textContent="Approve";const m=document.createElement("button");m.type="button",m.className="btn btn-small btn-secondary",m.dataset.action="world:changeReview",m.dataset.status="rejected",m.textContent="Reject",c.append(p,m)}if(o==="pending"){const p=at([{label:"Approve",action:"world:changeReview",data:{changeId:e.id,status:"approved"}},{label:"Reject",action:"world:changeReview",data:{changeId:e.id,status:"rejected"}}]);c.appendChild(p)}a.appendChild(c),n.appendChild(a);const d=[r?`World: ${r.name}`:e.worldId?`World: ${e.worldId}`:null,s?`Book: ${s.name}`:null,i?`Chat: ${i.name}`:null,ly(e.createdAt)];n.appendChild(Ka(d));const u=document.createElement("div");u.className="studio-world-item-footer";const f=o==="approved"?"active":o==="rejected"?"danger":o==="edited"?"linked":"pending";if(u.appendChild(pe(AT(o),f)),u.appendChild(pe(ay(e.proposalType),"muted")),Array.isArray(e.evidenceRefs)&&e.evidenceRefs.length>0&&u.appendChild(pe(`${e.evidenceRefs.length} evidence`,"muted")),n.appendChild(u),e.reason){const p=document.createElement("div");p.className="studio-world-inline-note studio-world-change-reason",p.textContent=e.reason,n.appendChild(p)}return PT(n,e),n}function XT(t,e){const{section:n,box:o}=qa("ðŸ§¾ World Changes",{sectionClassName:"world-changes-section"}),r=Array.isArray(e.worldChanges)?e.worldChanges:[],s=r.filter(c=>String(c.status||"pending")==="pending"),i=r.filter(c=>String(c.status||"pending")!=="pending"),a=document.createElement("div");a.className="studio-world-focus-card",a.innerHTML=`
        <div class="studio-world-focus-title">Review Queue</div>
        <div class="studio-world-focus-meta">${s.length} pending â€¢ ${i.length} reviewed</div>
    `,o.appendChild(a);const l=document.createElement("div");if(l.className="item-list",s.length===0)l.innerHTML='<p class="no-items-message">No pending world changes.</p>';else if(s.slice(0,12).forEach(c=>{l.appendChild(Yc(e,c))}),s.length>12){const c=document.createElement("p");c.className="no-items-message",c.textContent=`Showing 12 of ${s.length} pending proposals.`,l.appendChild(c)}if(o.appendChild(l),i.length>0){const c=document.createElement("details");c.className="studio-world-reviewed-block",c.open=!1;const d=document.createElement("summary");d.textContent=`Recent Reviewed (${Math.min(i.length,8)})`,c.appendChild(d);const u=document.createElement("div");u.className="item-list",i.slice(0,8).forEach(f=>{u.appendChild(Yc(e,f))}),c.appendChild(u),o.appendChild(c)}t.appendChild(n)}function fy(t){const n=(typeof t?.composerContent=="string"?t.composerContent.trim():"")||(Array.isArray(t?.history)?t.history.map(o=>{const r=o?.content;return typeof r=="string"?r:Array.isArray(r)?r.filter(s=>s?.type==="text").map(s=>s.text||"").join(" "):""}).join(" ").trim():"");return n?n.split(/\s+/).filter(Boolean).length:0}function gu(t){const e=Number.isFinite(Number(t))?Math.max(0,Math.round(Number(t))):0;return`${e.toLocaleString()} word${e===1?"":"s"}`}function QT(t,e,n,o){const r=document.createElement("div");r.className="book-overview-chapter-card",o?.id===n.id&&r.classList.add("is-active"),r.dataset.sessionId=n.id,r.dataset.bookId=e.id;const s=document.createElement("div");s.className="book-overview-chapter-card-header";const i=document.createElement("button");i.type="button",i.className="book-overview-chapter-open",i.dataset.action="worldui:bookChapterOpen",i.dataset.sessionId=n.id,i.dataset.bookId=e.id,i.innerHTML=`
        <div class="book-overview-chapter-kicker">${gu(fy(n))}</div>
        <div class="book-overview-chapter-title">${ga(n)}</div>
    `,s.appendChild(i);const a=document.createElement("div");a.className="book-overview-chapter-actions",a.appendChild(at([{label:"Open Chapter",action:"worldui:bookChapterOpen",data:{sessionId:n.id,bookId:e.id}},{label:"Chapter Settings...",action:"worldui:chapterSettingsOpen",data:{sessionId:n.id}},{label:"Summarize Bubble from Chat",action:"chapter:summarizeOverview",data:{sessionId:n.id,source:"chat"}},{label:"Summarize Bubble from Composer",action:"chapter:summarizeOverview",data:{sessionId:n.id,source:"composer"}}])),s.appendChild(a),r.appendChild(s);const l=document.createElement("div");l.className="book-overview-chapter-summary";const c=ro.activeSessionIds.has(String(n?.id||"")),d=String(n?.chapterSummary||"").trim(),u=n?.chapterSummaryMeta&&typeof n.chapterSummaryMeta=="object"?n.chapterSummaryMeta:null;if(d&&u?.source){const b=document.createElement("div");b.className="book-overview-chapter-summary-badges";const y=pe(u.source==="composer"?"Summary: Composer":"Summary: Chat",u.source==="composer"?"linked":"muted"),w=String(u?.presetName||"").trim(),v=Number(u?.updatedAt),S=[];w&&S.push(`Preset: ${w}`),Number.isFinite(v)&&v>0&&S.push(`Updated: ${new Date(v).toLocaleString()}`),S.length>0&&(y.title=S.join(" â€¢ ")),b.appendChild(y),l.appendChild(b)}if(c){const b=document.createElement("div");b.className="book-overview-chapter-summary-badges",b.appendChild(pe("Summarizingâ€¦","linked")),l.appendChild(b)}const f=document.createElement("div");f.className="book-overview-chapter-summary-text",f.textContent=d||"No chapter summary yet.",l.appendChild(f),r.appendChild(l);const p=document.createElement("div");p.className="book-overview-chapter-meta";const m=[];return Number.isFinite(Number(n?.chapterNumber))&&m.push(pe(`Chapter ${Math.round(Number(n.chapterNumber))}`,"muted")),n?.writingMode&&m.push(pe(`Mode: ${n.writingMode}`,n.writingMode==="author"?"linked":"muted")),Number.isFinite(Number(n?.revealScope?.asOfChapter))&&m.push(pe(`Reveal as-of Ch. ${Math.round(Number(n.revealScope.asOfChapter))}`,"muted")),m.forEach(b=>p.appendChild(b)),m.length>0&&r.appendChild(p),r}function ZT(t,e,n,o){const r=document.createElement("section");r.className="book-overview-act-column",r.dataset.bookId=e.id,Number.isFinite(n?.actNumber)&&(r.dataset.actNumber=String(n.actNumber));const s=document.createElement("div");s.className="book-overview-act-heading";const i=Number.isFinite(n?.actNumber)?`Act ${n.actNumber}`:"Unassigned",a=String(n?.title||"").trim(),l=document.createElement("div");l.className="book-overview-act-title",l.textContent=a&&a!==i?a:i,s.appendChild(l);const c=document.createElement("div");c.className="book-overview-act-meta";const d=(n.sessions||[]).reduce((f,p)=>f+fy(p),0);c.textContent=[a&&a!==i?i:null,`${(n.sessions||[]).length} chapter${(n.sessions||[]).length===1?"":"s"}`,gu(d)].filter(Boolean).join(" â€¢ "),s.appendChild(c),r.appendChild(s);const u=document.createElement("div");if(u.className="book-overview-chapter-list",(n.sessions||[]).forEach(f=>{u.appendChild(QT(t,e,f,o))}),(n.sessions||[]).length===0){const f=document.createElement("div");f.className="book-overview-empty",f.textContent="No chapters in this Act yet.",u.appendChild(f)}return r.appendChild(u),r}function e1(t,e){const n=document.createElement("div");n.className="book-workspace-pane";const o=Ns(t),r=Va(t,e),s=r.reduce((y,w)=>y+(Array.isArray(w?.sessions)?w.sessions.length:0),0),i=r.reduce((y,w)=>{const v=Array.isArray(w?.sessions)?w.sessions:[];return y+v.filter(S=>!String(S?.chapterSummary||"").trim()).length},0),a=document.createElement("div");a.className="book-overview-toolbar";const l=document.createElement("div");l.className="book-overview-toolbar-meta",l.textContent=`${s} chapter${s===1?"":"s"} â€¢ ${i} missing summaries`,a.appendChild(l);const c=document.createElement("div");c.className="book-overview-toolbar-actions";const d=ro.batchByBookId.get(e.id)||null,u=!!d,f=d?.source==="chat"?"chat":"composer",p=document.createElement("button");p.type="button",p.className="btn btn-small",p.dataset.action="book:summarizeMissingOverview",p.dataset.bookId=e.id,p.dataset.source="composer",p.textContent=u&&f==="composer"?"Summarizing...":"Summarize Missing (Composer)",(i===0||u)&&(p.disabled=!0,p.title=i===0?"All chapters already have summary bubbles.":"A batch summarize job is currently running."),c.appendChild(p);const m=document.createElement("button");m.type="button",m.className="btn btn-small btn-secondary",m.dataset.action="book:summarizeMissingOverview",m.dataset.bookId=e.id,m.dataset.source="chat",m.textContent=u&&f==="chat"?"Summarizing...":"Summarize Missing (Chat)",(i===0||u)&&(m.disabled=!0,m.title=i===0?"All chapters already have summary bubbles.":"A batch summarize job is currently running."),c.appendChild(m),a.appendChild(c),n.appendChild(a);const b=document.createElement("div");if(b.className="book-overview-board",r.length===0){const y=document.createElement("div");y.className="book-overview-empty large",y.innerHTML=`
            <div>No chapters yet in this Book.</div>
            <div class="book-tree-empty-actions">
                <button type="button" class="btn btn-small" data-action="worldui:bookChapterCreate" data-book-id="${e.id}">New Chapter</button>
            </div>
        `,b.appendChild(y)}else r.forEach(y=>b.appendChild(ZT(t,e,y,o)));return n.appendChild(b),n}function t1(t,e){const n=document.createElement("div");n.className="book-workspace-pane";const o=Pt(t,e),r=yr(t),s=fu(t),i=String(e?.bookAgentConfig?.systemPromptOverride||""),a=document.createElement("div");a.className="studio-world-focus-card";const l=e?.bookAgentSessionId?En(t,e.bookAgentSessionId):null,c=Array.isArray(l?.history)?l.history.length:0;a.innerHTML=`
        <div class="studio-world-focus-title">Book Agent</div>
        <div class="studio-world-focus-meta">
            ${l?`${l.name||"Book Agent"} â€¢ ${c} message${c===1?"":"s"}`:"No Book Agent chat yet for this book"}
        </div>
    `;const d=document.createElement("div");d.className="studio-world-focus-actions",d.innerHTML=`
        <button type="button" class="btn btn-small" data-action="worldui:bookAgentOpen" data-book-id="${e.id}" ${o?"":"disabled"}>${l?"Open Book Agent Chat":"Create & Open Book Agent"}</button>
    `,a.appendChild(d),n.appendChild(a);const u=document.createElement("div");u.className="studio-world-inline-editor",u.dataset.rowActionShield="true",u.dataset.bookId=e.id,u.innerHTML=`
        <div class="book-composer-active-doc-header">
            <div class="book-composer-active-doc-title">Book Agent Preset</div>
            <div class="book-composer-active-doc-meta">${o?`Bound to Agent preset: ${o}`:"Select which Agent preset this Book Agent chat should use."}</div>
        </div>
    `;const f=document.createElement("div");f.className="studio-world-inline-grid is-compact",f.appendChild(te("Agent preset",$t({name:"bookAgentPresetName",value:o||r||"",options:[{value:"",label:s.length>0?"Select agent presetâ€¦":"No agent presets available"},...s.map(b=>({value:b,label:b}))]}))),f.appendChild(te("Book Agent prompt override",zt({name:"bookAgentSystemPromptOverride",value:i,rows:4,placeholder:"Optional extra system prompt for this Book Agent only (kept on top of the selected Agent preset)."}))),u.appendChild(f),u.appendChild(Ht({saveAction:"worldui:bookAgentConfigSave",cancelAction:"worldui:bookAgentTabRefresh",cancelLabel:"Reset",dataset:{bookId:e.id,tab:"agent"}}));const p=document.createElement("div");p.className="studio-world-focus-actions",p.innerHTML=`
        <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookAgentBindCurrentAgent" data-book-id="${e.id}">Use Selected Agent Preset</button>
    `,u.appendChild(p),n.appendChild(u);const m=document.createElement("div");return m.className="studio-world-inline-note",m.textContent="Use Book Agent to brainstorm the whole project. Runtime prompt = Agent preset system prompt + optional Book Agent override above.",n.appendChild(m),n}function n1(t,e){const n=document.createElement("div");n.className="book-workspace-pane";const o=e?.composerDocs||{},r=e?.exportProfile||{},s=ny(e.id),i=[{key:"treatment",label:"Treatment",placeholder:"High-level treatment of the book."},{key:"synopsis",label:"Synopsis",placeholder:"Concise story summary / pitch."},{key:"outline",label:"Outline",placeholder:"Act and chapter outline."},{key:"sceneBeats",label:"Scene Beats",placeholder:"Cross-chapter beats / sequencing notes."}],a=i.find(I=>I.key===s)||i[0],l=typeof o?.[a.key]=="string"?o[a.key]:"",c=document.createElement("div");c.className="studio-world-focus-card",c.innerHTML=`
        <div class="studio-world-focus-title">Blueprint</div>
        <div class="studio-world-focus-meta">Core story setup docs for this book (treatment, synopsis, outline, scene beats) plus export prep.</div>
    `,n.appendChild(c);const d=document.createElement("div");d.className="book-composer-doc-list",i.forEach(I=>{const N=document.createElement("button");N.type="button",N.className="book-composer-doc-card is-selectable",I.key===a.key&&N.classList.add("active"),N.dataset.action="worldui:bookComposerDocSelect",N.dataset.bookId=e.id,N.dataset.docKey=I.key;const E=typeof o?.[I.key]=="string"?o[I.key].trim():"";N.innerHTML=`
            <div class="book-composer-doc-title">${I.label}</div>
            <div class="book-composer-doc-meta">${E?gu(E.split(/\\s+/).filter(Boolean).length):"Empty"}</div>
        `,d.appendChild(N)}),n.appendChild(d);const u=document.createElement("div");u.className="studio-world-inline-editor book-composer-editor",u.dataset.rowActionShield="true",u.dataset.bookId=e.id,u.dataset.activeDocKey=a.key;const f=document.createElement("div");f.className="book-composer-active-doc-header",f.innerHTML=`
        <div class="book-composer-active-doc-title">${a.label}</div>
        <div class="book-composer-active-doc-meta">Saved to this Book Blueprint and planned to be exportable later as part of the manuscript package.</div>
    `,u.appendChild(f);const p=document.createElement("div");p.className="studio-world-inline-grid",p.appendChild(te(`${a.label} content`,zt({name:"bookComposerDocContent",value:l,rows:14,placeholder:a.placeholder}))),u.appendChild(p);const m=document.createElement("div");m.className="book-composer-export-card",m.innerHTML='<div class="book-composer-export-title">Export Prep (for future Book Export)</div>';const b=document.createElement("div");b.className="studio-world-inline-grid is-compact",b.appendChild(te("Export title",vt({name:"exportTitle",value:r.title||e.name||"",placeholder:e.name||"Book title"}))),b.appendChild(te("Subtitle",vt({name:"exportSubtitle",value:r.subtitle||"",placeholder:"Optional subtitle"}))),b.appendChild(te("Author",vt({name:"exportAuthor",value:r.author||"",placeholder:"Author name"}))),b.appendChild(te("Chapter title format",$t({name:"exportChapterTitleMode",value:r.chapterTitleMode||"number_and_title",options:[{value:"number_and_title",label:"Number + Title"},{value:"title_only",label:"Title only"}]}))),b.appendChild(te("Scene break marker",vt({name:"exportSceneBreakMarker",value:r.sceneBreakMarker||"***",placeholder:"***"}))),b.appendChild(te("Front matter notes",zt({name:"exportFrontMatterNotes",value:r.frontMatterNotes||"",rows:3,placeholder:"Notes for cover page, dedication, foreword, etc."})));const y=document.createElement("label");y.className="studio-world-inline-checkbox";const w=document.createElement("input");w.type="checkbox",w.name="exportIncludeChapterSummaries",w.checked=r.includeChapterSummaries===!0,y.append(w,document.createTextNode(" Include chapter summaries in export package metadata")),b.appendChild(y),m.appendChild(b);const v=document.createElement("div");v.className="studio-world-focus-actions",v.innerHTML=`
        <button type="button" class="btn btn-small" data-action="worldui:bookExportMarkdown" data-book-id="${e.id}">Export Book (.md)</button>
        <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookComposerSave" data-book-id="${e.id}" data-doc-key="${a.key}">Save Export Prep</button>
    `,m.appendChild(v),u.appendChild(m);const S=document.createElement("div");S.className="studio-world-inline-note";const C=(t.chatSessions||[]).filter(I=>I?.bookId===e.id).length,x=(t.chatSessions||[]).filter(I=>I?.bookId===e.id&&String(I?.chapterSummary||"").trim()).length;return S.textContent=`Export preview readiness: ${C} chapters â€¢ ${x} chapter summaries â€¢ Markdown export available now â€¢ DOCX/EPUB pending.`,u.appendChild(S),u.appendChild(Ht({saveAction:"worldui:bookComposerSave",cancelAction:"worldui:bookWorkspaceTabOpen",cancelLabel:"Reset",dataset:{bookId:e.id,tab:"composer"}})),n.appendChild(u),n}function o1(t,e){const n=document.createElement("div");n.className="book-workspace-pane";const o=Pt(t,e),r=e?.codexAgentConfig?.useBookAgent!==!1,s=String(e?.codexAgentConfig?.agentPresetName||"").trim(),i=jo(t,e),a=yr(t),l=fu(t),c=document.createElement("div");c.className="studio-world-inline-editor",c.dataset.rowActionShield="true",c.dataset.bookId=e.id,c.innerHTML=`
        <div class="book-composer-active-doc-header">
            <div class="book-composer-active-doc-title">Codex Agent Setup</div>
            <div class="book-composer-active-doc-meta">${i?`Codex actions will use Agent preset: ${i}`:"Configure which Agent preset should run Codex/World proposal extraction and generation."}</div>
        </div>
    `;const d=document.createElement("div");d.className="studio-world-inline-grid is-compact";const u=document.createElement("label");u.className="studio-world-inline-checkbox";const f=document.createElement("input");f.type="checkbox",f.name="codexUseBookAgent",f.checked=r,u.append(f,document.createTextNode(" Use same Agent preset as Book Agent")),d.appendChild(u);const p=$t({name:"codexAgentPresetName",value:s||a||"",options:[{value:"",label:l.length>0?"Select agent presetâ€¦":"No agent presets available"},...l.map(x=>({value:x,label:x}))]});p.disabled=r,d.appendChild(te("Codex agent preset",p)),d.appendChild(te("Codex prompt override",zt({name:"codexSystemPromptOverride",value:String(e?.codexAgentConfig?.systemPromptOverride||""),rows:4,placeholder:"Optional extra instruction for Codex tasks (proposal extraction, world generation)."}))),c.appendChild(d),c.appendChild(Ht({saveAction:"worldui:codexAgentConfigSave",cancelAction:"worldui:bookWorkspaceTabOpen",cancelLabel:"Reset",dataset:{bookId:e.id,tab:"world"}}));const m=document.createElement("div");if(m.className="studio-world-focus-actions",m.innerHTML=`
        <button type="button" class="btn btn-small btn-secondary" data-action="worldui:codexAgentBindCurrentAgent" data-book-id="${e.id}">Use Selected Agent Preset</button>
    `,c.appendChild(m),!i){const x=document.createElement("div");x.className="studio-world-inline-note",x.textContent=r&&!o?'Codex Agent is waiting for a Book Agent preset. Set Book Agent preset first or uncheck "Use same Agent".':"Codex Agent is not configured yet. Codex proposal scan/generation actions will be blocked until you save this setup.",c.appendChild(x)}n.appendChild(c);const b=on(t,e?.linkedWorldId);if(!b){const x=document.createElement("div");return x.className="studio-world-focus-card",x.innerHTML=`
            <div class="studio-world-focus-title">Codex (Book World)</div>
            <div class="studio-world-focus-meta">No world linked to this Book yet.</div>
            <div class="studio-world-focus-actions">
                <button type="button" class="btn btn-small" data-action="book:ensureWorld" data-book-id="${e.id}">Create Book World</button>
                <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookSettingsOpen" data-book-id="${e.id}">Link World in Book Settings</button>
            </div>
        `,n.appendChild(x),n}const y=document.createElement("div");y.className="studio-world-focus-card";const w=Array.isArray(b.items)?b.items:[],v=cy(t,b);y.innerHTML=`
        <div class="studio-world-focus-title">Codex: ${b.name}</div>
        <div class="studio-world-focus-meta">Book-level canon and references â€¢ ${w.length} item${w.length===1?"":"s"} â€¢ ${v.mode==="shared"?"Shared World":v.mode==="book"?"Book-owned World":"World"}</div>
        <div class="studio-world-focus-actions">
            <button type="button" class="btn btn-small btn-secondary" data-action="world:setActive" data-world-id="${b.id}">Set Active World</button>
            <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookWorldFocus" data-book-id="${e.id}">Focus Book World</button>
            <button type="button" class="btn btn-small btn-secondary" data-action="worldui:openWorldWorkspace">Open World Hub</button>
        </div>
    `,n.appendChild(y);const S=document.createElement("div");S.className="studio-world-item-footer",v.mode==="shared"?(S.appendChild(pe("Shared World","linked")),v.ownerBook&&S.appendChild(pe(`Owner: ${v.ownerBook.name}`,"muted")),S.appendChild(pe(`${v.linkedBooks.length} linked books`,"muted"))):v.mode==="book"?(S.appendChild(pe("Book-owned World","muted")),v.ownerBook&&S.appendChild(pe(`Owner: ${v.ownerBook.name}`,"muted"))):S.appendChild(pe("Unassigned World","pending")),n.appendChild(S);const C=document.createElement("div");if(C.className="item-list",w.slice(0,12).forEach(x=>C.appendChild(py(b.id,x))),w.length===0)C.innerHTML='<p class="no-items-message">No world items yet.</p>';else if(w.length>12){const x=document.createElement("p");x.className="no-items-message",x.textContent=`Showing 12 of ${w.length} items.`,C.appendChild(x)}return n.appendChild(C),n}function r1(t,e){const n=document.createElement("div");n.className="book-workspace-pane";const o=(t.worldChanges||[]).filter(_=>_?.bookId===e.id),r=o.filter(_=>String(_.status||"pending")==="pending"),s=o.filter(_=>String(_.status||"pending")!=="pending"),i=lT(t,e.id),a=r.filter(_=>Number(_?.createdAt)>i).length,l=e?.agentAutomation?.worldProposals&&typeof e.agentAutomation.worldProposals=="object"?e.agentAutomation.worldProposals:{},c=l.autoProposeEnabled===!0,u=!!jo(t,e),p=!!Pt(t,e),m=Number.isFinite(Number(l.lastScannedMessageCount))?Math.max(0,Math.round(Number(l.lastScannedMessageCount))):0,b=cT(l.lastScanSourceKind),y=dT(l.lastScanMode),w=Number.isFinite(Number(l.lastScanCreatedCount))?Math.max(0,Math.round(Number(l.lastScanCreatedCount))):0,v=Number.isFinite(Number(l.lastScanAttemptAt))?Math.round(Number(l.lastScanAttemptAt)):0,S=v>0,C=String(l.lastScanResult||"").trim().toLowerCase(),x=S?ly(v):"â€”",I=S?uT(v):"Unknown time",N=S&&C==="no_delta"&&String(l.lastScanMode||"").trim().toLowerCase()==="delta",E=document.createElement("div");E.className="studio-world-focus-card book-changes-card";const A=document.createElement("div");A.className="studio-world-focus-title",A.textContent="Book Changes",E.appendChild(A);const L=document.createElement("div");L.className="studio-world-focus-meta",L.textContent="Review proposals created from Book Agent and Codex workflows before they become canon.",E.appendChild(L);const B=document.createElement("div");if(B.className="book-changes-status-pills",B.appendChild(pe(`${r.length} Pending`,r.length>0?"pending":"muted")),B.appendChild(pe(`${s.length} Reviewed`,s.length>0?"linked":"muted")),B.appendChild(pe(`${a} New`,a>0?"danger":"muted")),B.appendChild(pe(`Auto ${c?"On":"Off"}`,c?"linked":"muted")),B.appendChild(pe(`Cursor ${m}`,"muted")),B.appendChild(pe(`Last Scan: ${b}`,S?"linked":"muted")),B.appendChild(pe(`Mode: ${y}`,"muted")),B.appendChild(pe(`At ${x}`,"muted")),N&&B.appendChild(pe("No new delta","pending")),E.appendChild(B),S){const _=document.createElement("div");_.className="studio-world-focus-meta";const me=N?"no new delta":`${w} proposal${w===1?"":"s"} created`;_.textContent=`Last scan at ${I} (${x}) â€¢ used ${b.toLowerCase()} â€¢ ${y.toLowerCase()} â€¢ ${me}.`,E.appendChild(_)}const G=document.createElement("div");if(G.className="studio-world-focus-actions book-changes-actions",G.innerHTML=`
        <button type="button" class="btn btn-small ${c?"btn-secondary":""}" data-action="worldui:bookAgentAutoProposeToggle" data-book-id="${e.id}" data-enabled="${c?"false":"true"}" data-seed-cursor="${c?"false":"true"}">${c?"Disable Auto Propose":"Enable Auto Propose"}</button>
        <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookAgentScanNow" data-book-id="${e.id}">Scan Book Agent Chat</button>
        <button type="button" class="btn btn-small btn-secondary" data-action="worldui:bookAgentResetScanCursor" data-book-id="${e.id}">Reset Cursor</button>
    `,E.appendChild(G),!p||!u){const _=document.createElement("div");_.className="studio-world-inline-note book-changes-setup-note";const me=[];p||me.push("Book Agent not set"),u||me.push("Codex Agent not set"),_.textContent=`${me.join(" â€¢ ")}. Use the Agent and Codex tabs above to finish setup, then return here to scan or enable auto-propose.`,E.appendChild(_)}n.appendChild(E);const K=document.createElement("div");if(K.className="item-list",o.length===0){const _=document.createElement("div");_.className="studio-world-focus-card book-changes-empty-card",_.innerHTML=`
            <div class="studio-world-focus-title">No changes yet</div>
            <div class="studio-world-focus-meta">Chat in the Agent tab, then use the actions above to scan and create proposals for this Book's Codex.</div>
        `,K.appendChild(_)}else o.slice(0,10).forEach(_=>K.appendChild(Yc(t,_)));return n.appendChild(K),n}function s1(t,e){const n=document.createElement("div");return n.className="book-workspace-pane",n.appendChild(dy(t,e)),n}function i1(t,e,n){switch(br(n)){case"agent":return t1(t,e);case"composer":return n1(t,e);case"world":return o1(t,e);case"changes":return r1(t,e);case"settings":return s1(t,e);default:return e1(t,e)}}function a1(t,e){const n=document.getElementById("book-workspace-title"),o=document.getElementById("book-workspace-meta"),r=document.getElementById("book-workspace-tabs"),s=document.getElementById("book-workspace-header-actions");if(!document.getElementById("book-workspace"))return;if(!t||!e){n&&(n.textContent="Book"),o&&(o.textContent="Select a Book to open its overview, agent, and planning tools."),r&&(r.innerHTML=""),s&&(s.innerHTML="");return}const a=on(t,e.linkedWorldId),l=ha(t,e),c=Pt(t,e),d=jo(t,e),u=e?.agentAutomation?.worldProposals?.autoProposeEnabled===!0,f=Number.isFinite(Number(e?.agentAutomation?.worldProposals?.lastScannedMessageCount))?Math.max(0,Math.round(Number(e.agentAutomation.worldProposals.lastScannedMessageCount))):0;if(n&&(n.textContent=e.name||"Untitled Book"),o&&(o.textContent=[`${l} chapter${l===1?"":"s"}`,a?`Codex: ${a.name}`:"No linked codex",c?`Agent: ${c}`:"Agent: Not set",d?`Codex Agent: ${d}`:"Codex Agent: Not set",e.bookAgentSessionId?"Book Agent chat ready":"No Book Agent chat yet"].join(" â€¢ ")),s){s.innerHTML="";const p=document.createElement("button");p.type="button",p.className="btn btn-small",p.dataset.action="worldui:bookChapterCreate",p.dataset.bookId=e.id,p.textContent="New Chapter",s.appendChild(p);const m=at([{label:"Open Book Agent Chat",action:"worldui:bookAgentOpen",data:{bookId:e.id}},{label:"Bind Book Agent to Selected Agent Preset",action:"worldui:bookAgentBindCurrentAgent",data:{bookId:e.id}},{label:"Book Settings...",action:"worldui:bookSettingsOpen",data:{bookId:e.id}},{label:"New Act...",action:"worldui:bookActCreate",data:{bookId:e.id}},{label:"Import Current Chat as Chapter",action:"chapter:assignToBook",data:{bookId:e.id}},{label:"Re-number Chapters",action:"book:renumberChapters",data:{bookId:e.id}},{label:u?"Disable Auto Propose (Book Agent)":"Enable Auto Propose (Book Agent)",action:"worldui:bookAgentAutoProposeToggle",data:{bookId:e.id,enabled:!u,seedCursor:!u}},{label:`Scan Book Agent Chat -> Propose (${f} scanned)`,action:"worldui:bookAgentScanNow",data:{bookId:e.id}},{label:"Reset Book Agent Scan Cursor",action:"worldui:bookAgentResetScanCursor",data:{bookId:e.id}},{label:"Export Book (.md)",action:"worldui:bookExportMarkdown",data:{bookId:e.id}}]);s.appendChild(m)}if(r){const p=ty(e.id);r.innerHTML="",[["overview","Overview"],["agent","Agent"],["composer","Blueprint"],["world","Codex"],["changes","Changes"]].forEach(([m,b])=>{const y=document.createElement("button");y.type="button",y.className="book-workspace-tab-btn",p===m&&y.classList.add("active"),y.dataset.action="worldui:bookWorkspaceTabOpen",y.dataset.bookId=e.id,y.dataset.tab=m,y.textContent=b,r.appendChild(y)})}}function gn(){const t=pu(),e=document.getElementById("book-workspace-content");if(!t||!e)return;e.innerHTML="";const n=h.getProject(),o=xe.activeBookId||n?.activeBookId||null,r=n?be(n,o)||be(n,n.activeBookId):null;if(a1(n,r||null),!n||!r){const a=document.createElement("p");a.className="no-items-message",a.textContent="Select a Book from the left sidebar to open Book Workspace.",e.appendChild(a);return}xe.activeBookId=r.id;const s=ty(r.id),i=s==="settings"?"overview":s;Lt(r.id,i),e.appendChild(i1(n,r,i))}function l1(t){const e=document.createElement("div");e.className="studio-world-focus-card world-workspace-overview-card";const n=on(t,t.activeWorldId),o=be(t,t.activeBookId),r=Ns(t),s=Array.isArray(t.worldChanges)?t.worldChanges.filter(c=>String(c.status||"pending")==="pending").length:0,i=document.createElement("div");i.className="studio-world-focus-title",i.textContent="World Workspace";const a=document.createElement("div");a.className="studio-world-focus-meta",a.textContent="World hub for codex review and shared-world management. Create Books from the Books section on the left.";const l=document.createElement("div");return l.className="world-workspace-status-pills",l.appendChild(pe(n?`World: ${n.name}`:"No active world",n?"active":"muted")),l.appendChild(pe(o?`Book: ${o.name}`:"No active book",o?"linked":"muted")),l.appendChild(pe(r?`Chat: ${r.name}`:"No active chat","muted")),l.appendChild(pe(`${s} pending`,s>0?"pending":"muted")),e.append(i,a,l),e}function c1(t){const e=document.getElementById("world-workspace-title"),n=document.getElementById("world-workspace-meta");if(!e&&!n)return;if(!t){e&&(e.textContent="World"),n&&(n.textContent="Open a project to start building worlds.");return}kr(t);const o=on(t,t.activeWorldId),r=be(t,t.activeBookId),s=Ns(t);if(e&&(e.textContent=o?`World: ${o.name}`:"World"),n){const i=[`${(t.worlds||[]).length} world${(t.worlds||[]).length===1?"":"s"}`,`${(t.books||[]).length} book${(t.books||[]).length===1?"":"s"}`,r?`Book: ${r.name}`:null,s?`Chat: ${s.name}`:null].filter(Boolean);n.textContent=i.join(" â€¢ ")}}function Xc(){const t=oy();if(!t)return;t.innerHTML="";const e=h.getProject();if(!e){t.classList.add("hidden");return}t.classList.remove("hidden"),kr(e),UT(t,e)}function bu(){const t=uu(),e=document.getElementById("world-workspace-content");if(!t||!e)return;e.innerHTML="";const n=h.getProject();if(c1(n),!n){const o=document.createElement("p");o.className="no-items-message",o.textContent="Open a project to create Worlds and review World Changes.",e.appendChild(o);return}kr(n),e.appendChild(l1(n)),GT(e,n),XT(e,n)}function Xf(t,e){if(!t||!e)return null;let n=!1,o=Pt(t,e);if(!o){const d=yr(t);d&&((!e.bookAgentConfig||typeof e.bookAgentConfig!="object")&&(e.bookAgentConfig={}),e.bookAgentConfig.agentPresetName=d,!e.codexAgentConfig||typeof e.codexAgentConfig!="object"?e.codexAgentConfig={useBookAgent:!0,agentPresetName:null,systemPromptOverride:""}:e.codexAgentConfig.useBookAgent===void 0&&(e.codexAgentConfig.useBookAgent=!0),e.updatedAt=Date.now(),n=!0,o=d)}let r=e.bookAgentSessionId?En(t,e.bookAgentSessionId):null;if(r)return r.kind=ko,r.bookAgentBookId=e.id,o&&(r.linkedEntity={type:"agent",name:o}),(!r.name||r.name==="New Chat")&&(r.name=`Book Agent â€” ${e.name||"Untitled Book"}`),r.updatedAt=Date.now(),h.setProject(t),h.updateAndPersistState(),r;const s=t.activeSessionId||null;hr({kind:ko,bookAgentBookId:e.id});const i=h.getProject(),a=i?.activeSessionId||null;if(!a||a===s||(r=En(i,a),!r))return null;r.kind=ko,r.bookAgentBookId=e.id;const l=be(i,e.id),c=Pt(i,l||e)||o;return c&&(r.linkedEntity={type:"agent",name:c}),r.name=`Book Agent â€” ${e.name||"Untitled Book"}`,r.updatedAt=Date.now(),h.setProject(i),h.updateAndPersistState(),ge("book:update",{bookId:e.id,bookAgentSessionId:r.id,...n&&e.bookAgentConfig?{bookAgentConfig:{...e.bookAgentConfig}}:{}}),r}function ge(t,e){h.bus.publish(t,e||{})}function d1(t,e){const n=String(t?.dataset?.action||"").trim();if(!n.startsWith("worldui:"))return!1;const o=h.getProject();if(n==="worldui:bookSidebarModalClose")return H.creatingBook=!1,H.editingBookId=null,H.editingChapterMetaSessionId=null,F.modal=null,he(),!0;if(n==="worldui:bookToggleOpen"){const r=String(e.bookId||"").trim();if(!r)return!0;const s=String(e.open??"").trim().toLowerCase();return s==="true"?F.collapsedBookIds.delete(r):s==="false"?F.collapsedBookIds.add(r):F.collapsedBookIds.has(r)?F.collapsedBookIds.delete(r):F.collapsedBookIds.add(r),o?Vf(o):Xc(),!0}if(n==="worldui:bookOpenWorkspace"){const r=String(e.bookId||"").trim();if(!r)return!0;const s=br(e.tab||"overview");return xe.activeBookId=r,Lt(r,s),ge("book:setActive",{bookId:r}),s==="changes"&&o&&Gc(o,r),ho(r,{tab:s}),!0}if(n==="worldui:bookWorkspaceTabOpen"){const r=String(e.bookId||o?.activeBookId||xe.activeBookId||"").trim();if(!r)return k("Select a Book first.","Book"),!0;const s=br(e.tab||"overview");if(xe.activeBookId=r,ge("book:setActive",{bookId:r}),s==="agent"){const i=h.getProject(),a=i?be(i,r):null;if(!!!(a&&Pt(i,a)))return Lt(r,"agent"),ho(r,{tab:"agent"}),!0;const c=Xf(i,a);return c?(_t(c.id),Ys(),!0):(k("Could not create Book Agent chat.","Book"),!0)}if(Lt(r,s),s==="changes"){const i=h.getProject();i&&Gc(i,r)}if(s==="world"){const i=h.getProject(),a=i?be(i,r):null;a?.linkedWorldId&&ge("world:setActive",{worldId:a.linkedWorldId})}return ho(r,{tab:s}),!0}if(n==="worldui:bookComposerDocSelect"){const r=String(e.bookId||xe.activeBookId||"").trim();return r&&(qf(r,e.docKey),Lt(r,"composer"),gn()),!0}if(n==="worldui:bookExportMarkdown"){const r=String(e.bookId||o?.activeBookId||xe.activeBookId||"").trim();if(!o||!r)return k("Select a Book first.","Book Export"),!0;const s=be(o,r);if(!s)return k("Book not found.","Book Export"),!0;let i=null;const a=document.querySelector(`.book-composer-editor[data-book-id="${CSS.escape(r)}"]`);a&&(i={title:String(J(a,'[name="exportTitle"]',s?.exportProfile?.title||s.name||"")||""),subtitle:String(J(a,'[name="exportSubtitle"]',s?.exportProfile?.subtitle||"")||""),author:String(J(a,'[name="exportAuthor"]',s?.exportProfile?.author||"")||""),chapterTitleMode:String(J(a,'[name="exportChapterTitleMode"]',s?.exportProfile?.chapterTitleMode||"number_and_title")||"number_and_title"),sceneBreakMarker:String(J(a,'[name="exportSceneBreakMarker"]',s?.exportProfile?.sceneBreakMarker||"***")||"***"),frontMatterNotes:String(J(a,'[name="exportFrontMatterNotes"]',s?.exportProfile?.frontMatterNotes||"")||""),includeChapterSummaries:Ko(a,'[name="exportIncludeChapterSummaries"]',s?.exportProfile?.includeChapterSummaries===!0)});const l=CT(o,s,{exportProfile:i||void 0});if(!l?.markdown)return k("Nothing to export yet for this Book.","Book Export"),!0;hT(l.fileName,l.markdown,"text/markdown;charset=utf-8");const c=l.missingContentCount>0?` â€¢ ${l.missingContentCount} chapter${l.missingContentCount===1?"":"s"} missing composer content`:"";return k(`Exported Markdown for ${l.exportedChapters} chapter${l.exportedChapters===1?"":"s"}${c}.`,"Book Export"),!0}if(n==="worldui:bookComposerSave"){const r=t.closest(".studio-world-inline-editor"),s=String(e.bookId||r?.dataset?.bookId||"").trim();if(!r||!s)return!0;const i=du(e.docKey||r.dataset.activeDocKey||ny(s)),a=String(J(r,'[name="bookComposerDocContent"]',"")||""),l=String(J(r,'[name="exportTitle"]',"")||""),c=String(J(r,'[name="exportSubtitle"]',"")||""),d=String(J(r,'[name="exportAuthor"]',"")||""),u=String(J(r,'[name="exportChapterTitleMode"]',"number_and_title")||"number_and_title"),f=String(J(r,'[name="exportSceneBreakMarker"]',"***")||"***"),p=String(J(r,'[name="exportFrontMatterNotes"]',"")||""),m=Ko(r,'[name="exportIncludeChapterSummaries"]',!1);return qf(s,i),ge("book:update",{bookId:s,composerDocs:{[i]:a},exportProfile:{title:l,subtitle:c,author:d,chapterTitleMode:u,sceneBreakMarker:f,frontMatterNotes:p,includeChapterSummaries:m}}),Lt(s,"composer"),gn(),!0}if(n==="worldui:bookAgentOpen"){const r=String(e.bookId||o?.activeBookId||xe.activeBookId||"").trim();if(!r||!o)return!0;const s=be(o,r);if(!s)return k("Book not found.","Book"),!0;if(!Pt(o,s))return Lt(s.id,"agent"),ho(s.id,{tab:"agent"}),k("Set a Book Agent preset first (Agent tab) before opening the Book Agent chat.","Book Agent"),!0;const i=Xf(o,s);return i?(ge("book:setActive",{bookId:s.id}),_t(i.id),Ys(),!0):(k("Could not create Book Agent chat.","Book"),!0)}if(n==="worldui:bookAgentTabRefresh"){const r=String(e.bookId||o?.activeBookId||xe.activeBookId||"").trim();return r&&(Lt(r,"agent"),ho(r,{tab:"agent"})),!0}if(n==="worldui:bookAgentBindCurrentAgent"){if(!o)return!0;const r=String(e.bookId||o.activeBookId||xe.activeBookId||"").trim();if(!be(o,r))return k("Book not found.","Book Agent"),!0;const i=yr(o);if(!i)return k("No Agent preset available. Create one in Agent & Asset Studio first.","Book Agent"),!0;ge("book:update",{bookId:r,bookAgentConfig:{agentPresetName:i}});const a=h.getProject(),l=be(a,r),c=l?.bookAgentSessionId?En(a,l.bookAgentSessionId):null;return c&&(c.linkedEntity={type:"agent",name:i},c.updatedAt=Date.now(),h.setProject(a),h.updateAndPersistState()),k(`Book Agent is now bound to "${i}".`,"Book Agent"),gn(),!0}if(n==="worldui:bookAgentConfigSave"){const r=t.closest(".studio-world-inline-editor");if(!r||!o)return!0;const s=String(e.bookId||r.dataset.bookId||"").trim();if(!be(o,s))return k("Book not found.","Book Agent"),!0;const a=String(J(r,'[name="bookAgentPresetName"]',"")||"").trim(),l=String(J(r,'[name="bookAgentSystemPromptOverride"]',"")||"");if(!a||!o.agentPresets?.[a])return k("Please select a valid Agent preset for Book Agent.","Book Agent"),!0;ge("book:update",{bookId:s,bookAgentConfig:{agentPresetName:a,systemPromptOverride:l}});const c=h.getProject(),d=be(c,s),u=d?.bookAgentSessionId?En(c,d.bookAgentSessionId):null;return u&&(u.linkedEntity={type:"agent",name:a},u.updatedAt=Date.now(),h.setProject(c),h.updateAndPersistState()),k(`Saved Book Agent settings (${a}).`,"Book Agent"),gn(),!0}if(n==="worldui:codexAgentBindCurrentAgent"){if(!o)return!0;const r=String(e.bookId||o.activeBookId||xe.activeBookId||"").trim();if(!be(o,r))return k("Book not found.","Codex Agent"),!0;const i=yr(o);return i?(ge("book:update",{bookId:r,codexAgentConfig:{useBookAgent:!1,agentPresetName:i}}),k(`Codex Agent is now bound to "${i}".`,"Codex Agent"),gn(),!0):(k("No Agent preset available. Create one in Agent & Asset Studio first.","Codex Agent"),!0)}if(n==="worldui:codexAgentConfigSave"){const r=t.closest(".studio-world-inline-editor");if(!r||!o)return!0;const s=String(e.bookId||r.dataset.bookId||"").trim(),i=be(o,s);if(!i)return k("Book not found.","Codex Agent"),!0;const a=Ko(r,'[name="codexUseBookAgent"]',!0),l=String(J(r,'[name="codexAgentPresetName"]',"")||"").trim(),c=String(J(r,'[name="codexSystemPromptOverride"]',"")||"");return!a&&(!l||!o.agentPresets?.[l])?(k("Please select a valid Agent preset for Codex Agent.","Codex Agent"),!0):a&&!Pt(o,i)?(k('Book Agent preset is not set yet. Set it first or uncheck "Use same Agent".',"Codex Agent"),!0):(ge("book:update",{bookId:s,codexAgentConfig:{useBookAgent:a,agentPresetName:a?null:l,systemPromptOverride:c}}),k("Codex Agent settings saved.","Codex Agent"),gn(),!0)}if(n==="worldui:bookAgentAutoProposeToggle"){const r=String(e.bookId||o?.activeBookId||xe.activeBookId||"").trim();if(!r||!o)return!0;let s=be(o,r);if(!s)return!0;const i=Jf(o,s);i.seeded&&(s=i.book);const a=s?.agentAutomation?.worldProposals?.autoProposeEnabled===!0,l=String(e.enabled??"").trim().toLowerCase(),c=l==="true"?!0:l==="false"?!1:!a;if(c&&!jo(o,s))return k("Set a Codex Agent in the Codex tab before enabling Auto Propose.","Book Agent"),!0;const d=s?.bookAgentSessionId?En(o,s.bookAgentSessionId):null,u=ST(d),f=Number(s?.agentAutomation?.worldProposals?.lastScannedMessageCount),p=c&&!Number.isFinite(f)||c&&a===!1&&(e.seedCursor==="true"||e.seedCursor===!0)?u:Number.isFinite(f)?Math.max(0,Math.round(f)):0;return ge("book:update",{bookId:r,agentAutomation:{worldProposals:{autoProposeEnabled:c,lastScannedMessageCount:p,lastScannedAt:Date.now()}}}),k(c?`Auto Propose from Book Agent enabled${i.seeded?` (using ${i.presetName})`:""}${d?" (starting from current point)":""}.`:"Auto Propose from Book Agent disabled.","Book Agent"),!0}if(n==="worldui:bookAgentScanNow"){const r=String(e.bookId||o?.activeBookId||xe.activeBookId||"").trim();if(!r||!o)return!0;let s=be(o,r);if(!s)return!0;const i=Jf(o,s);return i.seeded&&(s=i.book),jo(o,s)?(ge("world:bookAgentScanProposals",{bookId:r,delta:!1,requireAutoEnabled:!1,silent:!1}),!0):(k("Set a Codex Agent in the Codex tab before scanning Book Agent chat.","World Proposals"),!0)}if(n==="worldui:bookAgentResetScanCursor"){const r=String(e.bookId||o?.activeBookId||xe.activeBookId||"").trim();return r&&ge("world:bookAgentResetScanCursor",{bookId:r}),!0}if(n==="worldui:bookWorldFocus"){const r=String(e.bookId||o?.activeBookId||xe.activeBookId||"").trim();return r&&(ge("book:ensureWorld",{bookId:r,setActive:!0}),xe.activeBookId=r,Lt(r,"world"),gn()),!0}if(n==="worldui:openWorldWorkspace")return my(),!0;if(n==="worldui:actToggleOpen"){const r=String(e.bookId||"").trim();if(!r)return!0;const s=String(e.actNumber??"").trim(),i=s?Ut(s):null,a=hu(r,i),l=String(e.open??"").trim().toLowerCase();return l==="true"?F.collapsedActKeys.delete(a):l==="false"?F.collapsedActKeys.add(a):F.collapsedActKeys.has(a)?F.collapsedActKeys.delete(a):F.collapsedActKeys.add(a),o?Vf(o):Xc(),!0}if(n==="worldui:bookSettingsOpen")return e.bookId&&(H.editingBookId=null,F.modal={type:"book-settings",bookId:e.bookId},he()),!0;if(n==="worldui:chapterSettingsOpen")return e.sessionId&&(H.editingChapterMetaSessionId=null,F.modal={type:"chapter-settings",sessionId:e.sessionId},he()),!0;if(n==="worldui:chapterMoveToActOpen"){const r=String(e.sessionId||"").trim();return r&&(F.modal={type:"chapter-move-act",sessionId:r},he()),!0}if(n==="worldui:chapterMoveToActCancel")return F.modal?.type==="chapter-move-act"&&(F.modal=null),he(),!0;if(n==="worldui:chapterMoveToActChoose"){const r=t.closest(".studio-world-inline-editor");if(!r)return!0;const s=r.querySelector('[name="moveActNumber"]');return s instanceof HTMLInputElement&&(s.value=String(e.actNumber||""),s.focus(),s.select?.()),!0}if(n==="worldui:chapterMoveToActSave"){const r=t.closest(".studio-world-inline-editor"),s=String(e.sessionId||r?.dataset?.sessionId||"").trim();if(!r||!s)return!0;const i=String(J(r,'[name="moveActNumber"]',"")||"").trim();if(!i)return ge("chapter:moveToAct",{sessionId:s,actNumber:null}),F.modal=null,he(),!0;const a=Ut(i);return a?(F.modal=null,ge("chapter:moveToAct",{sessionId:s,actNumber:a}),!0):(k("Please enter a valid positive act number.","Book"),!0)}if(n==="worldui:actSettingsOpen"){const r=String(e.bookId||"").trim(),s=Ut(e.actNumber);return!r||!s||(F.modal={type:"act-settings",bookId:r,actNumber:s},he()),!0}if(n==="worldui:bookActCreate"){if(!o)return!0;const r=String(e.bookId||o.activeBookId||"").trim(),s=be(o,r);if(!s)return k("Book not found.","Book"),!0;const i=IT(o,s);return F.modal={type:"act-settings",bookId:s.id,actNumber:i},he(),!0}if(n==="worldui:actEditCancel")return F.modal?.type==="act-settings"&&(F.modal=null),he(),!0;if(n==="worldui:actEditSave"){const r=t.closest(".studio-world-inline-editor"),s=String(e.bookId||r?.dataset?.bookId||"").trim(),i=Ut(e.actNumber||J(r,'[name="actNumber"]',""));if(!s||!i)return k("Act number is required.","Book"),!0;const a=String(J(r,'[name="actTitle"]',"")||"").trim(),l=String(J(r,'[name="actSummary"]',"")||"");return ge("book:actUpsert",{bookId:s,actNumber:i,title:a,summary:l}),F.modal=null,he(),!0}if(n==="worldui:bookChapterCreate"){if(!o)return!0;const r=String(e.bookId||o.activeBookId||"").trim(),s=be(o,r);if(!s)return k("Book not found.","Book"),!0;const i=Ut(e.actNumber);try{ge("book:setActive",{bookId:s.id});const a=h.getProject()?.activeSessionId||null;hr({kind:"chapter"});const c=h.getProject()?.activeSessionId||null;if(!c||c===a)return k("Could not create a new chapter chat.","Book"),!0;ge("chapter:assignToBook",{sessionId:c,bookId:s.id,...i?{actNumber:i}:{}}),Ys(),F.modal={type:"chapter-settings",sessionId:c},he()}catch(a){console.error("Failed to create chapter from Book tree:",a),k("Failed to create chapter.","Book")}return!0}if(n==="worldui:bookChapterOpen"){const r=String(e.sessionId||"").trim(),s=String(e.bookId||"").trim()||null;if(!r||!o)return!0;s&&ge("book:setActive",{bookId:s}),F.modal=null;try{_t(r),Ys()}catch(i){console.error("Failed to open chapter session from Book tree:",i),k("Could not open chapter chat.","Book")}return!0}if(n==="worldui:bookCreateStart")return H.creatingBook={linkedWorldId:e.linkedWorldId||null},H.creatingWorld=!1,F.modal={type:"book-create"},he(),!0;if(n==="worldui:bookCreateCancel")return H.creatingBook=!1,F.modal?.type==="book-create"&&(F.modal=null),he(),!0;if(n==="worldui:bookCreateSave"){const r=t.closest(".studio-world-inline-editor");if(!r||!o)return!0;const s=String(J(r,'[name="newBookName"]',"")||"").trim();if(!s)return k("Book name is required.","Info"),!0;const i=String(J(r,'[name="newBookDescription"]',"")||""),l=String(J(r,'[name="newBookLinkedWorldId"]',"")||"").trim()||null,c=Ko(r,'[name="newBookAutoNumber"]',!0);H.creatingBook=!1,F.modal?.type==="book-create"&&(F.modal=null),ge("book:create",{name:s,description:i,linkedWorldId:l,autoNumberChapters:c});const d=h.getProject(),u=String(d?.activeBookId||"").trim(),f=u?be(d,u):null;if(f){ge("book:actUpsert",{bookId:f.id,actNumber:1,title:"Act 1",summary:""});const p=h.getProject()?.activeSessionId||null;hr({kind:"chapter"});const b=h.getProject()?.activeSessionId||null;b&&b!==p&&ge("chapter:assignToBook",{sessionId:b,bookId:f.id,actNumber:1,chapterNumber:1,revealScope:{asOfChapter:1},writingMode:"writing"}),xe.activeBookId=f.id,Lt(f.id,"overview"),ho(f.id,{tab:"overview"}),k("Created Book with Act 1 / Chapter 1.","Book")}return!0}if(n==="worldui:worldCreateStart")return H.creatingWorld={scope:String(e.scope||"").trim().toLowerCase()==="shared"?"shared":"unassigned"},he(),!0;if(n==="worldui:worldCreateCancel")return H.creatingWorld=!1,he(),!0;if(n==="worldui:worldCreateSave"){const r=t.closest(".studio-world-inline-editor");if(!r||!o)return!0;const s=String(J(r,'[name="newWorldName"]',"")||"").trim();if(!s)return k("World name is required.","Info"),!0;const i=String(J(r,'[name="newWorldDescription"]',"")||""),a=H.creatingWorld&&typeof H.creatingWorld=="object"&&String(H.creatingWorld.scope||"").trim().toLowerCase()==="shared"?"shared":"unassigned";return H.creatingWorld=!1,ge("world:create",{name:s,description:i,scope:a}),!0}if(n==="worldui:itemCreateStart")return!o||!Array.isArray(o.worlds)||o.worlds.length===0?(k("Create a World first before adding items.","Info"),!0):(H.creatingWorldItem={worldId:e.worldId||o.activeWorldId||o.worlds[0]?.id||null,type:e.type||"entity"},he(),!0);if(n==="worldui:itemCreateCancel")return H.creatingWorldItem=null,he(),!0;if(n==="worldui:itemCreateSave"){const r=t.closest(".studio-world-inline-editor");if(!r||!o)return!0;const s=String(J(r,'[name="newItemWorldId"]',"")||"").trim(),i=String(J(r,'[name="newItemType"]',"entity")||"entity").trim().toLowerCase()||"entity",a=String(J(r,'[name="newItemTitle"]',"")||"").trim();if(!s)return k("Select a World for the new item.","Info"),!0;if(!a)return k("Item title is required.","Info"),!0;const l=String(J(r,'[name="newItemSummary"]',"")||""),c=String(J(r,'[name="newItemTags"]',"")||"").split(",").map(p=>p.trim()).filter(Boolean),d=String(J(r,'[name="newItemVisibility"]',"revealed")||"revealed").trim().toLowerCase()==="gated"?"gated":"revealed",u=Ut(J(r,'[name="newItemRevealChapter"]',"")),f=d==="gated"?u?{kind:"chapter_threshold",value:u}:{kind:"manual_unlock",unlocked:!1}:null;return H.creatingWorldItem=null,ge("world:itemCreate",{worldId:s,type:i,title:a,summary:l,tags:c,status:"canon",visibility:d,revealGate:f}),!0}if(n==="worldui:bookEditStart")return H.editingBookId=e.bookId||null,H.editingWorldItemId=null,e.bookId&&(F.modal={type:"book-settings",bookId:e.bookId}),he(),!0;if(n==="worldui:bookEditCancel")return(!e.bookId||H.editingBookId===e.bookId)&&(H.editingBookId=null),(!e.bookId||F.modal?.bookId===e.bookId)&&(F.modal=null),he(),!0;if(n==="worldui:bookEditSave"){const r=t.closest(".studio-world-inline-editor"),s=e.bookId||r?.dataset?.bookId||null;if(!s||!o)return!0;const i=String(J(r,'[name="bookName"]',"")||"").trim(),a=String(J(r,'[name="bookDescription"]',"")||""),c=String(J(r,'[name="linkedWorldId"]',"")||"").trim()||null,d=Ko(r,'[name="autoNumberChapters"]',!0);return i&&(H.editingBookId=null,(!F.modal||F.modal.type==="book-settings")&&(F.modal=null),ge("book:update",{bookId:s,name:i,description:a,autoNumberChapters:d}),ge("book:linkWorld",{bookId:s,worldId:c})),!0}if(n==="worldui:chapterMetaEditStart")return H.editingChapterMetaSessionId=e.sessionId||null,e.sessionId&&(F.modal={type:"chapter-settings",sessionId:e.sessionId}),he(),!0;if(n==="worldui:chapterMetaCancel")return(!e.sessionId||H.editingChapterMetaSessionId===e.sessionId)&&(H.editingChapterMetaSessionId=null),(!e.sessionId||F.modal?.sessionId===e.sessionId)&&(F.modal=null),he(),!0;if(n==="worldui:chapterMetaSave"){const r=t.closest(".studio-world-inline-editor"),s=e.sessionId||r?.dataset?.sessionId||null;if(!s)return!0;const i=Ut(J(r,'[name="actNumber"]',"")),a=Ut(J(r,'[name="chapterNumber"]',"")),l=Ut(J(r,'[name="asOfChapter"]',"")),c=String(J(r,'[name="chapterTitle"]',"")||""),d=String(J(r,'[name="chapterSummary"]',"")||""),u=String(J(r,'[name="writingMode"]',"writing")||"writing").trim().toLowerCase()==="author"?"author":"writing";return H.editingChapterMetaSessionId=null,(!F.modal||F.modal.type==="chapter-settings")&&(F.modal=null),ge("chapter:updateMeta",{sessionId:s,actNumber:i,chapterNumber:a,chapterTitle:c,chapterSummary:d,writingMode:u,revealScope:{asOfChapter:l}}),!0}if(n==="worldui:itemEditStart")return H.editingWorldItemId=e.itemId||null,he(),!0;if(n==="worldui:itemEditCancel")return(!e.itemId||H.editingWorldItemId===e.itemId)&&(H.editingWorldItemId=null),he(),!0;if(n==="worldui:itemEditSave"){const r=t.closest(".studio-world-inline-editor"),s=e.worldId||r?.dataset?.worldId||null,i=e.itemId||r?.dataset?.itemId||null;if(!s||!i||!o)return!0;const a=String(J(r,'[name="itemTitle"]',"")||"").trim();if(!a)return!0;const l=String(J(r,'[name="itemType"]',"note")||"note").trim().toLowerCase()||"note",c=String(J(r,'[name="itemSummary"]',"")||""),d=String(J(r,'[name="itemTags"]',"")||"").split(",").map(b=>b.trim()).filter(Boolean),u=String(J(r,'[name="itemVisibility"]',"revealed")||"revealed").trim().toLowerCase()==="gated"?"gated":"revealed",f=Ut(J(r,'[name="itemRevealChapter"]',"")),p=Ko(r,'[name="itemManualUnlocked"]',!1);let m=null;return u==="gated"&&(f?m={kind:"chapter_threshold",value:f}:m={kind:"manual_unlock",unlocked:p}),H.editingWorldItemId=null,ge("world:itemUpdate",{worldId:s,itemId:i,patch:{type:l,title:a,summary:c,tags:d,visibility:u,revealGate:m}}),!0}return!1}function u1(t,e){if(!t)return!1;const n=String(t.dataset.action||"").trim();if(!n)return!1;e.preventDefault(),e.stopPropagation();const r={...t.closest(".item")?.dataset||{}};if(Object.entries(t.dataset||{}).forEach(([s,i])=>{s==="action"||s==="data"||(r[s]=i)}),t.dataset.data)try{Object.assign(r,JSON.parse(t.dataset.data))}catch(s){console.error("Failed to parse world UI action payload:",s)}return n==="toggle-menu"?(Ea(e),!0):d1(t,r)?(t.closest(".dropdown.open")?.classList.remove("open","portal-open"),!0):(h.bus.publish(n,r),t.closest(".dropdown.open")?.classList.remove("open","portal-open"),!0)}function Hl(t){t&&t.querySelectorAll(".book-tree-row.is-drop-before, .book-tree-row.is-drop-after, .book-tree-row.is-dragging").forEach(e=>e.classList.remove("is-drop-before","is-drop-after","is-dragging"))}function Ul(t){return t instanceof Element?t.closest("#book-sidebar-slot .book-tree-row.is-chapter"):null}function p1(t){!t||t.dataset.bookTreeDragBound==="true"||(t.dataset.bookTreeDragBound="true",t.addEventListener("dragstart",e=>{const n=e.target;if(!(n instanceof Element)||n.closest(".dropdown"))return;const o=Ul(n);!o||!t.contains(o)||(gt.draggingSessionId=String(o.dataset.sessionId||""),gt.draggingBookId=String(o.dataset.bookId||""),o.classList.add("is-dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",gt.draggingSessionId)))}),t.addEventListener("dragover",e=>{const n=e.target,o=Ul(n);if(!o||!t.contains(o))return;const r=gt.draggingSessionId,s=gt.draggingBookId;if(!r||!s||o.dataset.sessionId===r||String(o.dataset.bookId||"")!==s)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");const i=o.getBoundingClientRect(),a=i.top+i.height/2,l=e.clientY>=a?"after":"before";Hl(t),o.classList.add(l==="after"?"is-drop-after":"is-drop-before")}),t.addEventListener("drop",e=>{const n=e.target,o=Ul(n);if(!o||!t.contains(o))return;const r=gt.draggingSessionId,s=gt.draggingBookId;if(!r||!s||o.dataset.sessionId===r||String(o.dataset.bookId||"")!==s)return;e.preventDefault();const i=o.getBoundingClientRect(),a=i.top+i.height/2,l=e.clientY>=a?"after":"before";h.bus.publish("chapter:reorderInBook",{sessionId:r,targetSessionId:o.dataset.sessionId,position:l,adoptTargetAct:!0}),gt.justDroppedAt=Date.now(),gt.draggingSessionId=null,gt.draggingBookId=null,Hl(t)}),t.addEventListener("dragend",()=>{gt.draggingSessionId=null,gt.draggingBookId=null,Hl(t)}))}function Js(t){!t||t.dataset.worldUiListenerAttached==="true"||(t.dataset.worldUiListenerAttached="true",t.id==="book-sidebar-slot"&&p1(t),t.addEventListener("click",e=>{const n=e.target;if(!(n instanceof Element))return;if(t.id==="book-sidebar-slot"&&Date.now()-(gt.justDroppedAt||0)<250){e.preventDefault(),e.stopPropagation();return}const o=n.closest("[data-action]");if(!o||!t.contains(o))return;const r=n.closest(".studio-world-inline-editor");r&&o===r.closest(".item[data-action]")||u1(o,e)}))}let Qf=!1;function yu(t="world"){document.querySelectorAll(".header-center .menu-toggle-btn").forEach(e=>e.classList.remove("active")),t==="world"?document.getElementById("switch-to-world-btn")?.classList.add("active"):t==="photo"?document.getElementById("switch-to-photo-btn")?.classList.add("active"):t==="composer"?document.getElementById("switch-to-composer-btn")?.classList.add("active"):document.getElementById("switch-to-chat-btn")?.classList.add("active")}function Ys(){const t=document.querySelector("#main-chat-panel .main-content-wrapper");t&&(t.classList.remove("photo-studio-active"),t.classList.remove("world-workspace-active")),document.getElementById("world-workspace")?.classList.add("hidden"),document.getElementById("book-workspace")?.classList.add("hidden"),yu("chat")}function my(){uu(),bu();const t=document.querySelector("#main-chat-panel .main-content-wrapper");t&&(t.classList.remove("photo-studio-active"),t.classList.add("world-workspace-active")),document.getElementById("kieai-studio-workspace")?.classList.add("hidden"),document.getElementById("book-workspace")?.classList.add("hidden"),document.getElementById("world-workspace")?.classList.remove("hidden"),yu("world")}function ho(t=null,{tab:e="overview"}={}){pu(),t&&(xe.activeBookId=String(t),Lt(xe.activeBookId,e)),gn();const n=document.querySelector("#main-chat-panel .main-content-wrapper");n&&(n.classList.remove("photo-studio-active"),n.classList.add("world-workspace-active")),document.getElementById("kieai-studio-workspace")?.classList.add("hidden"),document.getElementById("world-workspace")?.classList.add("hidden"),document.getElementById("book-workspace")?.classList.remove("hidden"),yu("world")}function f1({bookId:t=null,tab:e="overview"}={}){const n=typeof t=="string"?t.trim():"";if(!n)return!1;const o=br(e);if(o==="changes"){const r=h.getProject();r&&(kr(r),Gc(r,n))}return ho(n,{tab:o}),!0}function m1(){const t=document.getElementById("switch-to-world-btn");!t||t.dataset.worldUiFallbackBound==="true"||(t.dataset.worldUiFallbackBound="true",t.addEventListener("click",()=>{try{my()}catch(e){console.error("World workspace fallback open failed:",e)}}))}function he(){Xc(),gn(),bu(),HT()}function Qc(){if(Qf)return;Qf=!0;const{bookSlot:t,bookWorkspace:e,worldWorkspace:n}=bT(),o=ry();Js(t),Js(e),Js(n),Js(o),m1(),h.bus.subscribe("project:loaded",()=>{pT(),he()}),h.bus.subscribe("project:stateChanged",he),h.bus.subscribe("world:dataChanged",he),h.bus.subscribe("session:loaded",he),h.bus.subscribe("session:listChanged",he),h.bus.subscribe("chapter:overviewSummaryProgress",fT),h.bus.subscribe("book:overviewSummaryBatchProgress",mT);try{he()}catch(r){console.error("World UI initial render failed:",r)}}typeof document<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{try{Qc()}catch(t){console.error("World UI auto-init failed:",t)}},{once:!0}):setTimeout(()=>{try{Qc()}catch(t){console.error("World UI auto-init failed:",t)}},0));const h1=Object.freeze({search:!0,worldPeek:!0,agentPresets:!0,agentGroups:!0,commandMemories:!0,knowledgeFiles:!0}),g1=Object.keys(h1);function b1(t={}){return{search:t?.search!==!1,worldPeek:t?.worldPeek!==!1,agentPresets:t?.agentPresets!==!1,agentGroups:t?.agentGroups!==!1,commandMemories:t?.commandMemories!==!1,knowledgeFiles:t?.knowledgeFiles!==!1}}function wu(t=h.getProject()){return b1(t?.globalSettings?.studioSectionVisibility)}function Zc({sectionKey:t}={}){const e=String(t||"").trim();if(!g1.includes(e))return;const n=h.getProject();if(!n)return;const o=wu(n),r={...o,[e]:!o[e]};if((!n.globalSettings||typeof n.globalSettings!="object")&&(n.globalSettings={}),n.globalSettings.studioSectionVisibility=r,e==="search"&&!r.search){const s=document.getElementById("asset-search-input");s&&(s.value="")}h.setProject(n),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}function y1({visibilityMode:t}={}){const e=String(t||"").trim();if(e!=="show"&&e!=="hide")return;const n=h.getProject();if(!n)return;const o=e==="show",r={search:o,worldPeek:o,agentPresets:o,agentGroups:o,commandMemories:o,knowledgeFiles:o};if((!n.globalSettings||typeof n.globalSettings!="object")&&(n.globalSettings={}),n.globalSettings.studioSectionVisibility=r,!o){const s=document.getElementById("asset-search-input");s&&(s.value="")}h.setProject(n),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}function w1(){const t=h.getProject();if(!t||!t.agentPresets)return[];const e=document.getElementById("asset-search-input")?.value.toLowerCase()||"",n=document.getElementById("asset-sort-select")?.value||"modified-desc";let o=Object.entries(t.agentPresets).map(([r,s])=>({name:r,...s}));return e&&(o=o.filter(r=>[r.name,r.id,r.description,r.model,...r.tags||[]].join(" ").toLowerCase().includes(e))),o.sort((r,s)=>{switch(n){case"modified-desc":return s.modifiedAt-r.modifiedAt;case"modified-asc":return r.modifiedAt-s.modifiedAt;case"created-desc":return s.createdAt-r.createdAt;case"created-asc":return r.createdAt-s.createdAt;case"name-asc":return r.name.localeCompare(s.name);case"name-desc":return s.name.localeCompare(r.name);default:return 0}}),o}function v1(){try{const e=h.getProject().agentPresets;if(Object.keys(e).length===0){k("No agents to export.","Info");return}const n=JSON.stringify(e,null,2),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),s=document.createElement("a");s.href=r,s.download=`promptprim_agents_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}catch(t){console.error("Failed to export agents:",t),k(`Error exporting agents: ${t.message}`,"Error")}}function S1(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=o=>{try{const r=JSON.parse(o.target.result);if(typeof r!="object"||r===null||Array.isArray(r))throw new Error("Invalid file format. Expected a JSON object of agents.");const s=h.getProject();let i=0,a=0;for(const l in r)s.agentPresets[l]?confirm(`Agent "${l}" already exists. Overwrite?`)&&(s.agentPresets[l]=r[l],a++):(s.agentPresets[l]=r[l],i++);h.setProject(s),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"),k(`Import complete! Added: ${i}, Overwritten: ${a}.`,"Success")}catch(r){console.error("Failed to import agents:",r),k(`Error importing agents: ${r.message}`,"Error")}},n.readAsText(e),t.target.value=""}let rs=null;function k1(t=""){return typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(t):String(t).replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function x1(t,e){const n=t?.querySelector(":scope > .section-box");if(!t||!n){t&&(t.open=!!e);return}if(t.dataset.sectionAnimating==="1")return;if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){t.open=!!e;return}t.dataset.sectionAnimating="1";const r=180,s=()=>{t.dataset.sectionAnimating="0",n.style.removeProperty("max-height"),n.style.removeProperty("opacity"),n.style.removeProperty("transform"),n.style.removeProperty("overflow"),n.style.removeProperty("transition")},i=()=>{e||(t.open=!1),s()};let a=!1,l=0;const c=u=>{u.target!==n||u.propertyName!=="max-height"||(a=!0,n.removeEventListener("transitionend",c),l&&(window.clearTimeout(l),l=0),i())};if(n.addEventListener("transitionend",c),l=window.setTimeout(()=>{a||(n.removeEventListener("transitionend",c),i())},r+90),n.style.transition=`max-height ${r}ms cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 140ms ease, transform ${r}ms ease`,n.style.overflow="hidden",e){t.open=!0;const u=Math.max(0,Math.ceil(n.scrollHeight));n.style.maxHeight="0px",n.style.opacity="0",n.style.transform="translateY(-3px)",requestAnimationFrame(()=>{n.style.maxHeight=`${u}px`,n.style.opacity="1",n.style.transform="translateY(0)"});return}const d=Math.max(Math.ceil(n.scrollHeight),Math.ceil(n.getBoundingClientRect().height));n.style.maxHeight=`${d}px`,n.style.opacity="1",n.style.transform="translateY(0)",requestAnimationFrame(()=>{n.style.maxHeight="0px",n.style.opacity="0",n.style.transform="translateY(-3px)"})}function Vl(t){if(!t?.type||!t?.name)return null;const e=k1(t.name),n=t.type==="group"?`#studio-panel #agentGroupList .item[data-group-name="${e}"]`:`#studio-panel #agentPresetList .item[data-agent-name="${e}"]`;return document.querySelector(n)}function C1(t={}){const e={type:t.entityType||t.type||"",name:t.entityName||t.name||""};if(!e.type||!e.name)return;const n=wu();e.type==="agent"&&!n.agentPresets?Zc({sectionKey:"agentPresets"}):e.type==="group"&&!n.agentGroups&&Zc({sectionKey:"agentGroups"});const o=document.getElementById("asset-search-input");let r=Vl(e);if(!r&&e.type==="agent"&&o){const i=e.name;(o.value||"").trim()!==i&&(o.value=i,bn(),r=Vl(e))}if(!r&&e.type==="agent"&&o&&(o.value||"").trim()!==""&&(o.value="",bn(),r=Vl(e)),!r)return;const s=r.closest("details.collapsible-section");s&&(s.open=!0),r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.remove("selected-entity-jump-highlight"),r.offsetWidth,r.classList.add("selected-entity-jump-highlight"),setTimeout(()=>{r.classList.remove("selected-entity-jump-highlight")},1200)}function E1(t){const e=document.getElementById("studio-visibility-menu");if(!e)return;const o=["search","agentPresets","worldPeek","agentGroups","commandMemories","knowledgeFiles"].every(r=>t?.[r]!==!1);e.querySelectorAll(".studio-visibility-option[data-visibility-mode]").forEach(r=>{const s=r.dataset.visibilityMode||"",i=s==="hide"&&o||s==="show"&&!o;r.classList.toggle("hidden",!i),r.setAttribute("aria-hidden",i?"false":"true")}),e.querySelectorAll(".studio-visibility-option").forEach(r=>{const s=r.dataset.sectionKey||"";if(!s)return;const i=!!t?.[s];r.classList.toggle("is-selected",i),r.setAttribute("aria-checked",i?"true":"false")})}function hy(t){const e=pI();return`Switch to ${t.icon} ${t.name} in ${e}s`}function ed(){rs&&(clearInterval(rs),rs=null)}function Zf(){const t=document.querySelector("#studio-selected-entity-slot .selected-entity-pending-text");if(!t){ed();return}const e=h.getProject(),n=h.getStagedEntity(),o=td(e,n);if(!e||!o){ed();return}t.textContent=hy(o)}function em(){if(!!!document.querySelector("#studio-selected-entity-slot .selected-entity-pending-text")){ed();return}Zf(),!rs&&(rs=setInterval(()=>{Zf()},250))}function I1(t){return t?.activeSessionId&&t.chatSessions?.find(e=>e.id===t.activeSessionId)||null}function td(t,e){if(!e?.type||!e?.name)return null;if(e.type==="agent"){const n=t.agentPresets?.[e.name];return{type:"agent",name:e.name,icon:n?.icon||"ðŸ¤–",detail:n?.model?`Model: ${n.model}`:"Model is not configured",exists:!!n}}if(e.type==="group"){const n=t.agentGroups?.[e.name];return{type:"group",name:e.name,icon:"ðŸ¤",detail:n?.moderatorAgent?`Moderator: ${n.moderatorAgent}`:"Moderator is not configured",exists:!!n}}return null}function A1(t){const e=document.createElement("section");e.className="selected-entity-section is-compact";const n=I1(t),o=n?.linkedEntity||null,r=t.activeEntity||null,s=h.getStagedEntity(),i=td(t,o||r),a=td(t,s),l=!!(s&&(!i||s.type!==i.type||s.name!==i.name)),c=document.createElement("div");c.className="selected-entity-heading";const d=document.createElement("div");d.className="selected-entity-title";const u=document.createElement("h4");if(u.textContent="Selected Agent",d.appendChild(u),i){const m=document.createElement("span");m.className="selected-entity-badge is-active",m.textContent="Active",d.appendChild(m)}c.appendChild(d);const f=document.createElement("span");f.className="selected-entity-source",f.textContent=n?.name?`Chat: ${n.name}`:"No active chat",c.appendChild(f),e.appendChild(c);const p=document.createElement("div");if(p.className="selected-entity-current",i&&!i.exists?p.classList.add("is-missing"):i?.exists&&p.classList.add("is-active-entity"),i){const m=document.createElement("span");m.className="selected-entity-icon",m.textContent=i.icon;const b=document.createElement("div");b.className="selected-entity-info";const y=document.createElement("button");y.type="button",y.className="selected-entity-name selected-entity-name-btn",y.dataset.action="studio:focusSelectedEntity",y.dataset.entityType=i.type,y.dataset.entityName=i.name,y.textContent=i.name,y.title="Show in list";const w=document.createElement("div");w.className="selected-entity-meta",w.textContent=i.exists?i.type==="group"?"Group":"Agent":"This linked entity no longer exists. Open another chat or reselect.",b.append(y,w),p.append(m,b)}else{const m=document.createElement("div");m.className="selected-entity-empty",m.textContent="No linked Agent/Group found for this chat.",p.appendChild(m)}if(e.appendChild(p),l&&a){const m=document.createElement("div");m.className="selected-entity-pending";const b=document.createElement("div");b.className="selected-entity-pending-header";const y=document.createElement("span");y.className="selected-entity-badge is-pending",y.textContent="Pending";const w=document.createElement("div");w.className="selected-entity-pending-text",w.textContent=hy(a),b.append(y,w);const v=document.createElement("div");v.className="selected-entity-actions";const S=document.createElement("button");S.type="button",S.className="btn btn-small",S.dataset.action="entity:stagedApply",S.textContent="Apply";const C=document.createElement("button");C.type="button",C.className="btn btn-secondary btn-small",C.dataset.action="entity:stagedCancel",C.textContent="Cancel",v.append(S,C),m.append(b,v),e.appendChild(m)}return e}function bn(){const t=document.querySelector("#studio-panel .studio-assets-container"),e=document.getElementById("studio-selected-entity-slot");if(!t)return;t.innerHTML="";const n=h.getProject(),o=wu(n),r=document.querySelector("#studio-panel .studio-toolbar");if(r&&r.classList.toggle("hidden",!o.search),E1(o),e&&(e.innerHTML=""),n&&e&&e.appendChild(A1(n)),!n){em();return}const s=w1();o.worldPeek||o.agentPresets||o.agentGroups||o.commandMemories||o.knowledgeFiles?(o.agentPresets&&dM(t,s),o.worldPeek&&YT(t,n),o.agentGroups&&KM(t),o.commandMemories&&QM(t),o.knowledgeFiles&&aT(t)):t.innerHTML='<p class="no-items-message">No sections selected. Use filter menu to show sections.</p>',em()}function N1(){const t=document.getElementById("studio-panel");if(!t||t.dataset.listenerAttached==="true")return;t.dataset.listenerAttached="true",t.addEventListener("click",r=>{const s=r.target,i=s.closest(".memory-toggle");if(i){r.stopPropagation();const d=i.closest(".item[data-name]");d&&h.bus.publish("memory:toggle",{name:d.dataset.name});return}const a=s.closest(".studio-assets-container > .collapsible-section > summary.section-header");if(a&&!s.closest(".section-header-actions")){const d=a.closest(".collapsible-section");if(d){r.preventDefault(),r.stopPropagation(),x1(d,!d.open);return}}const l=s.closest("[data-action]");if(l){r.preventDefault(),r.stopPropagation();const d=l.dataset.action;let f={...s.closest(".item")?.dataset};if(Object.entries(l.dataset||{}).forEach(([p,m])=>{p==="action"||p==="data"||(f[p]=m)}),l.dataset.data)try{const p=JSON.parse(l.dataset.data);Object.assign(f,p)}catch(p){console.error("Failed to parse data attribute JSON",p)}d==="toggle-menu"?Ea(r):(h.bus.publish(d,f),l.closest(".dropdown.open")?.classList.remove("open"));return}const c=s.closest(".item");if(c){r.preventDefault();const{agentName:d,groupName:u}=c.dataset;d?h.bus.publish("studio:itemClicked",{type:"agent",name:d}):u&&h.bus.publish("studio:itemClicked",{type:"group",name:u});return}});const e=document.getElementById("asset-search-input"),n=document.getElementById("asset-sort-select");e?.addEventListener("input",bn),n?.addEventListener("change",bn),document.getElementById("import-agents-input")?.addEventListener("change",S1),h.bus.subscribe("project:loaded",bn),h.bus.subscribe("studio:contentShouldRender",bn),h.bus.subscribe("session:loaded",bn),h.bus.subscribe("entity:selected",bn),h.bus.subscribe("entity:staged",bn),h.bus.subscribe("studio:focusSelectedEntity",C1),console.log("âœ… Studio UI Initialized with definitive, robust event listeners.")}function M1({name:t}){const e=h.getProject(),n=e.activeEntity?.name;if(!n)return;const o=e.agentPresets[n];if(!o)return;o.activeMemories||(o.activeMemories=[]),o.activeMemories.includes(t)?o.activeMemories=o.activeMemories.filter(s=>s!==t):o.activeMemories.push(t),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}function T1(){const t=h.getProject(),e=document.getElementById("memory-name-input").value.trim(),n=document.getElementById("memory-content-input").value,o=document.getElementById("memory-edit-index").value;if(!e){k("Memory name cannot be empty.","Error");return}if(o!==""){const r=t.memories[o].name;t.memories[o]={name:e,content:n},Object.values(t.agentPresets).forEach(s=>{if(s.activeMemories){const i=s.activeMemories.indexOf(r);i>-1&&(s.activeMemories[i]=e)}})}else{if(t.memories.some(r=>r.name===e)){k(`A memory named "${e}" already exists.`,"Error");return}t.memories.push({name:e,content:n})}h.setProject(t),h.updateAndPersistState(),h.bus.publish("memory:editorShouldClose"),h.bus.publish("studio:contentShouldRender"),k(`Memory "${e}" saved successfully.`,"Success")}function P1({index:t}){if(!confirm("Are you sure you want to permanently delete this memory? This cannot be undone."))return;const e=h.getProject();if(!e.memories[t])return;const n=e.memories[t].name;e.memories.splice(t,1),Object.values(e.agentPresets).forEach(o=>{o.activeMemories&&(o.activeMemories=o.activeMemories.filter(r=>r!==n))}),h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}function B1(){const e={memories:h.getProject().memories},n=JSON.stringify(e,null,2),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),s=document.createElement("a");s.href=r,s.download=`promptprim_memories_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}function O1(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=o=>{try{const r=JSON.parse(o.target.result);if(r&&Array.isArray(r.memories)){const s=h.getProject(),i=new Set(s.memories.map(l=>l.name)),a=r.memories.filter(l=>!i.has(l.name));s.memories.push(...a),h.setProject(s),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"),k("Memory package imported successfully!","Success")}else throw new Error("Invalid memory package file.")}catch(r){k(`Error loading memory package: ${r.message}`,"Error")}},n.readAsText(e),t.target.value=""}const L1=25*1024*1024,ql=5e5,tm=280,D1=1200,R1=180,j1=500,_1="local-hash-v1",vu=128,$1=new Set(["application/json","application/xml","application/yaml","application/x-yaml"]),F1=new Set(["txt","md","markdown","csv","json","log","xml","yaml","yml"]);function W1(t=""){const e=t.lastIndexOf(".");return e<0?"":t.slice(e+1).toLowerCase()}function z1(t){const e=(t.type||"").toLowerCase();return e.startsWith("text/")||$1.has(e)?!0:F1.has(W1(t.name))}function Su(){return`kf_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function H1(t=0){return t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(2)} MB`}function U1(t=""){const e=t.replace(/\s+/g," ").trim();return e?e.length<=tm?e:`${e.slice(0,tm)}...`:"No text preview available."}function gy(t){Array.isArray(t.knowledgeFiles)||(t.knowledgeFiles=[])}function Fo(t){(!t.knowledgeIndex||typeof t.knowledgeIndex!="object")&&(t.knowledgeIndex={}),Array.isArray(t.knowledgeIndex.chunks)||(t.knowledgeIndex.chunks=[]),Number.isFinite(t.knowledgeIndex.version)||(t.knowledgeIndex.version=1),Number.isFinite(t.knowledgeIndex.dimensions)||(t.knowledgeIndex.dimensions=vu),t.knowledgeIndex.embeddingModel||(t.knowledgeIndex.embeddingModel=_1),Number.isFinite(t.knowledgeIndex.updatedAt)||(t.knowledgeIndex.updatedAt=Date.now())}function ku(t){t&&(t.ragSettings=Bt(t.ragSettings,{scopeSource:t.folderId?"folder":"session"}))}function by(t){t&&(t.ragSettings=so(t.ragSettings))}function yy(t,e){!t?.chatSessions||!e||t.chatSessions.forEach(n=>{ku(n),n.ragSettings.selectedFileIds=n.ragSettings.selectedFileIds.filter(o=>o!==e)})}function wy(t,e){!t?.chatFolders||!e||t.chatFolders.forEach(n=>{by(n),n.ragSettings.selectedFileIds=n.ragSettings.selectedFileIds.filter(o=>o!==e)})}function V1(t){let e=2166136261;for(let n=0;n<t.length;n+=1)e^=t.charCodeAt(n),e=Math.imul(e,16777619);return e>>>0}function q1(t=""){return t.toLowerCase().match(/[\p{L}\p{N}_-]{2,}/gu)||[]}function K1(t,e=vu){const n=Array.from({length:e},()=>0),o=q1(t);if(o.length===0)return n;for(const s of o){const i=V1(s)%e;n[i]+=1}const r=Math.sqrt(n.reduce((s,i)=>s+i*i,0));return r?n.map(s=>Number((s/r).toFixed(6))):n}function G1(t=""){return t?Math.max(1,Math.round(t.length/4)):0}function J1(t,e,n){const o=Math.min(t.length,e+n);if(o>=t.length)return t.length;const r=e+Math.floor(n*.6),s=t.slice(r,o),i=s.lastIndexOf(`
`);if(i>=0)return r+i+1;const a=Math.max(s.lastIndexOf(". "),s.lastIndexOf("! "),s.lastIndexOf("? "));if(a>=0)return r+a+2;const l=s.lastIndexOf(" ");return l>=0?r+l+1:o}function Y1(t,{targetChars:e=D1,overlapChars:n=R1,maxChunks:o=j1}={}){const r=(t||"").replace(/\r\n/g,`
`).replace(/\u0000/g,"").trim();if(!r)return[];const s=[];let i=0,a=0;const l=o*5;for(;i<r.length&&s.length<o&&a<l;){a+=1;const c=J1(r,i,e),d=r.slice(i,c).trim();if(d&&s.push(d),c>=r.length)break;i=Math.max(c-n,i+1)}return s}function ba(t,e){Fo(t),t.knowledgeIndex.chunks=t.knowledgeIndex.chunks.filter(n=>n.fileId!==e)}function xu(t,e){if(Fo(t),!e?.textContent?.trim())return e.status="failed",e.chunkCount=0,e.note="No text content available for indexing.",ba(t,e.id),0;e.status="indexing",ba(t,e.id);const n=Y1(e.textContent),o=Date.now(),r=n.map((s,i)=>({id:`kc_${e.id}_${i}_${o}`,fileId:e.id,fileName:e.name,chunkIndex:i,text:s,charCount:s.length,tokenEstimate:G1(s),vector:K1(s,t.knowledgeIndex.dimensions||vu),embeddingModel:t.knowledgeIndex.embeddingModel,createdAt:o}));return t.knowledgeIndex.chunks.push(...r),t.knowledgeIndex.updatedAt=o,e.status=r.length>0?"indexed":"failed",e.chunkCount=r.length,e.indexedAt=o,e.embeddingModel=t.knowledgeIndex.embeddingModel,r.length}function X1(t){return`${t.name}__${t.size}__${t.lastModified||0}`}function Q1(t){return{id:Su(),name:t.name,type:t.type||"application/octet-stream",size:t.size||0,uploadedAt:Date.now(),source:"upload",status:"binary",chunkCount:0,indexedAt:null,embeddingModel:"",textContent:"",excerpt:"Preview not available for this file type yet."}}async function Z1(t){const e=await t.text(),n=e.length>ql,o=n?e.slice(0,ql):e,r=n?`Text was truncated at ${ql.toLocaleString()} characters.`:"";return{id:Su(),name:t.name,type:t.type||"text/plain",size:t.size||0,uploadedAt:Date.now(),source:"upload",status:"uploaded",chunkCount:0,indexedAt:null,embeddingModel:"",textContent:o,excerpt:U1(o),note:r}}function eP(t,e){return{id:Su(),name:t.name,type:t.type||"application/octet-stream",size:t.size||0,uploadedAt:Date.now(),source:"upload",status:"failed",chunkCount:0,indexedAt:null,embeddingModel:"",textContent:"",excerpt:`Could not read file: ${e.message||"Unknown error"}`}}function tP(){document.getElementById("knowledge-file-input")?.click()}async function nP(t){const e=Array.from(t||[]);if(e.length===0)return;const n=h.getProject();if(!n)return;ie(n),gy(n),Fo(n);const o=new Set(n.knowledgeFiles.map(u=>`${u.name}__${u.size}__${u.lastModified||0}`));let r=0,s=0,i=0,a=0,l=0,c=0;for(const u of e){const f=X1(u);if(o.has(f)){s+=1;continue}if((u.size||0)>L1){i+=1;continue}let p;if(z1(u))try{p=await Z1(u)}catch(m){p=eP(u,m),a+=1}else p=Q1(u);if(p.lastModified=u.lastModified||0,p.sizeLabel=H1(p.size),p.textContent)try{const m=xu(n,p);c+=m,m>0&&(l+=1)}catch(m){p.status="failed",p.note=`Indexing failed: ${m.message||"Unknown error"}`,p.chunkCount=0,ba(n,p.id),a+=1}n.knowledgeFiles.unshift(p),o.add(f),r+=1}r>0&&(h.setProject(n),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"));const d=[];r>0&&d.push(`Added ${r} file(s).`),l>0&&d.push(`Indexed ${l} file(s) into ${c} chunk(s).`),s>0&&d.push(`Skipped ${s} duplicate file(s).`),i>0&&d.push(`Skipped ${i} file(s) larger than 25 MB.`),a>0&&d.push(`${a} file(s) were added with read errors.`),d.length>0&&k(d.join(`
`),"Knowledge Files")}function oP({fileId:t}){if(!t)return;const e=h.getProject();if(!e||!Array.isArray(e.knowledgeFiles))return;ie(e);const n=e.knowledgeFiles.find(s=>s.id===t);if(!n||!confirm(`Delete "${n.name}" from Knowledge Files?`))return;e.knowledgeFiles=e.knowledgeFiles.filter(s=>s.id!==t),yy(e,t),wy(e,t),ba(e,t),h.getState().knowledgeFocus?.fileId===t&&h.setState("knowledgeFocus",null),h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}function rP(){const t=h.getProject();if(!t||!Array.isArray(t.knowledgeFiles)||t.knowledgeFiles.length===0||(ie(t),!confirm("Delete all knowledge files in this project?")))return;const n=t.knowledgeFiles.map(o=>o.id);t.knowledgeFiles=[],Fo(t),t.knowledgeIndex.chunks=[],t.knowledgeIndex.updatedAt=Date.now(),n.forEach(o=>{yy(t,o),wy(t,o)}),h.setState("knowledgeFocus",null),h.setProject(t),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}function sP({fileId:t}){if(!t)return;const e=h.getProject();if(!e||!Array.isArray(e.knowledgeFiles))return;ie(e),Fo(e);const n=e.knowledgeFiles.find(o=>o.id===t);if(n){if(!n.textContent){k("This file has no text content to index.","Knowledge Files");return}try{const o=xu(e,n);h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"),k(`Re-indexed "${n.name}" (${o} chunk(s)).`,"Knowledge Files")}catch(o){n.status="failed",n.note=`Indexing failed: ${o.message||"Unknown error"}`,h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"),k(`Could not re-index "${n.name}".`,"Knowledge Files")}}}function iP(){const t=h.getProject();if(!t||!Array.isArray(t.knowledgeFiles))return;ie(t),Fo(t);let e=0,n=0;for(const o of t.knowledgeFiles){if(!o.textContent)continue;const r=xu(t,o);n+=r,e+=1}h.setProject(t),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender"),k(`Re-indexed ${e} file(s) into ${n} chunk(s).`,"Knowledge Files")}function aP({fileId:t,chunkIndex:e,fileName:n}={}){const o=h.getProject();if(!o)return;ie(o),gy(o),Fo(o);let r=t||"";if(!r&&n&&(r=o.knowledgeFiles.find(d=>d.name===n)?.id||""),!r){k("Could not locate source file for this citation.","Knowledge Files");return}const s=Number.isFinite(Number(e))?Math.max(0,Math.round(Number(e))):0,i=o.knowledgeIndex.chunks.find(c=>c.fileId===r&&c.chunkIndex===s),a=o.knowledgeIndex.chunks.find(c=>c.fileId===r),l=i||a;h.setState("knowledgeFocus",{fileId:r,chunkIndex:Number.isFinite(l?.chunkIndex)?l.chunkIndex:0,requestedAt:Date.now()}),h.bus.publish("studio:contentShouldRender")}function lP(){h.setState("knowledgeFocus",null),h.bus.publish("studio:contentShouldRender")}function Cu(t){return t?.chatSessions?.find(e=>e.id===t.activeSessionId)||null}function vy(t,e){ku(e);const n=e.ragSettings.scopeSource==="folder",o=e.folderId?ze(t,e.folderId):null;return n&&o?(by(o),{target:"folder",settings:o.ragSettings,folder:o}):(e.ragSettings.scopeSource==="folder"&&!o&&(e.ragSettings.scopeSource="session"),{target:"session",settings:e.ragSettings,folder:null})}function cP({scopeSource:t}={}){const e=h.getProject();if(!e)return;ie(e);const n=Cu(e);if(!n)return;ku(n);const o=t==="folder"?"folder":"session";o==="folder"&&!ze(e,n.folderId)?(k("This session is not in a folder. Move the session into a folder first.","Knowledge Files"),n.ragSettings.scopeSource="session"):n.ragSettings.scopeSource=o,n.updatedAt=Date.now(),h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}function dP(t={}){const e=h.getProject();if(!e)return;ie(e);const n=Cu(e);if(!n)return;const{target:o,settings:r,folder:s}=vy(e,n),i={...r};if(t.scopeMode!==void 0&&(i.scopeMode=t.scopeMode==="selected"?"selected":"all"),t.retrievalTopK!==void 0){const a=Number(t.retrievalTopK);Number.isFinite(a)&&(i.retrievalTopK=Math.min(12,Math.max(1,Math.round(a))))}if(t.maxContextTokens!==void 0){const a=Number(t.maxContextTokens);Number.isFinite(a)&&(i.maxContextTokens=Math.min(1e4,Math.max(200,Math.round(a))))}o==="folder"&&s?(s.ragSettings=so(i),s.updatedAt=Date.now()):(n.ragSettings=Bt(i,{scopeSource:"session"}),n.ragSettings.scopeSource="session"),n.updatedAt=Date.now(),h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}function uP({fileId:t}){if(!t)return;const e=h.getProject();if(!e)return;ie(e);const n=Cu(e);if(!n)return;const{target:o,settings:r,folder:s}=vy(e,n),i=new Set(r.selectedFileIds||[]);i.has(t)?i.delete(t):i.add(t);const a=Array.from(i);o==="folder"&&s?(s.ragSettings=so({...s.ragSettings,selectedFileIds:a}),s.updatedAt=Date.now()):(n.ragSettings=Bt({...n.ragSettings,selectedFileIds:a,scopeSource:"session"}),n.ragSettings.scopeSource="session"),n.updatedAt=Date.now(),h.setProject(e),h.updateAndPersistState(),h.bus.publish("studio:contentShouldRender")}const pP=1;function oe(){return h.getProject()}function se(t){!t||typeof t!="object"||(Ca(t),wm(t),io(t),as(t))}function fP({worldId:t=null,bookId:e=null,reason:n="update"}={}){h.bus.publish("world:dataChanged",{worldId:t,bookId:e,reason:n}),h.bus.publish("studio:contentShouldRender")}function we({worldId:t=null,bookId:e=null,reason:n="update",includeSessionListRefresh:o=!1}={}){const r=oe();r&&(h.setProject(r),h.updateAndPersistState(),o&&h.bus.publish("session:listChanged"),fP({worldId:t,bookId:e,reason:n}))}function An(t,e){!t||!e||t.activeSessionId===e.id&&h.bus.publish("ui:updateChatTitle",{title:ka(e,{includeAct:!0,fallback:e.name||"AI Assistant"})})}function et(t,e){return!t||!e?null:(t.worlds||[]).find(n=>n.id===e)||null}function Le(t,e){return!t||!e?null:(t.books||[]).find(n=>n.id===e)||null}function Qe(t,e){return!t||!e?null:(t.chatSessions||[]).find(n=>n.id===e)||null}function mP(t){if(!t||typeof t!="object")return null;const e=t.agentPresets||{},n=Object.keys(e);if(n.length===0)return null;const o=t.activeEntity;return o?.type==="agent"&&o?.name&&e[o.name]?o.name:n[0]||null}function hP(t="",e="Selection"){const n=String(t||"").replace(/\s+/g," ").trim();if(!n)return e;const o=n.split(new RegExp("(?<=[.!?])\\s+"))[0]||n,r=72;return o.length>r?`${o.slice(0,r-1).trimEnd()}â€¦`:o}function ke(t){return Array.isArray(t)?t:[]}function Xt(t,e){return!Array.isArray(t)||!e||t.includes(e)||t.push(e),t}function Sy(t,e){return!Array.isArray(t)||!e?t:t.filter(n=>n!==e)}function xr(t,e){if(!e?.structure)return;const n=new Set((t.chatSessions||[]).map(o=>o.id));e.structure.chapterSessionIds=ke(e.structure.chapterSessionIds).filter(o=>n.has(o))}function gP(t,e){const n=`${String(e?.name||"Book").trim()||"Book"} World`,o=new Set((t?.worlds||[]).map(i=>String(i?.name||"").trim().toLowerCase()).filter(Boolean));if(!o.has(n.toLowerCase()))return n;let r=2,s=`${n} ${r}`;for(;o.has(s.toLowerCase());)r+=1,s=`${n} ${r}`;return s}function ky(t,e,n={}){if(!t||!e)return null;const o=Date.now(),r=km({id:Cm(),name:(n.name||"").trim()||gP(t,e),description:n.description||"",scope:hi,ownerBookId:e.id,sharedBookIds:[e.id],createdAt:o,updatedAt:o,version:1,items:[]});return t.worlds.unshift(r),e.linkedWorldId=r.id,e.updatedAt=o,t.activeWorldId=r.id,r}function bP(t,e){const n=(t?.chatSessions||[]).filter(r=>r?.bookId===e);if(n.length===0)return 1;const o=n.reduce((r,s)=>{const i=Number(s?.chapterNumber);return Number.isFinite(i)&&i>r?Math.round(i):r},0);return Math.max(1,o+1)}function yP(t,e){const n=(t?.chatSessions||[]).filter(r=>r?.bookId===e);if(n.length===0)return 1;const o=n.reduce((r,s)=>{const i=Number(s?.actNumber);return Number.isFinite(i)&&i>r?Math.round(i):r},0);return Math.max(1,o||1)}function Ga(t){return!t||typeof t!="object"?null:((!t.structure||typeof t.structure!="object")&&(t.structure={acts:[],chapterSessionIds:[]}),t.structure.acts=ke(t.structure.acts),t.structure.chapterSessionIds=ke(t.structure.chapterSessionIds),t.structure)}function Eu(t,e){if(!t||!e)return[];const n=(t.chatSessions||[]).filter(a=>a&&a.bookId===e.id&&a.archived!==!0),o=new Map(n.map(a=>[a.id,a])),r=ke(e?.structure?.chapterSessionIds),s=[],i=new Set;return r.forEach(a=>{const l=o.get(a);!l||i.has(a)||(s.push(l),i.add(a))}),n.forEach(a=>{i.has(a.id)||(s.push(a),i.add(a.id),e?.structure&&Xt(e.structure.chapterSessionIds,a.id))}),s}function wP(t=[]){return[...t].sort((e,n)=>{const o=Number.isFinite(Number(e?.actNumber))?Math.round(Number(e.actNumber)):Number.MAX_SAFE_INTEGER,r=Number.isFinite(Number(n?.actNumber))?Math.round(Number(n.actNumber)):Number.MAX_SAFE_INTEGER;return o!==r?o-r:0})}function Ja(t,e){if(!t||!e)return[];Ga(e),xr(t,e);const n=wP(Eu(t,e));let o=1;return n.forEach(r=>{const s=Number.isFinite(Number(r?.chapterNumber))?Math.round(Number(r.chapterNumber)):null,i=Number.isFinite(Number(r?.revealScope?.asOfChapter))?Math.round(Number(r.revealScope.asOfChapter)):null,a=i===null||i===s;r.chapterNumber=o,!r.revealScope||typeof r.revealScope!="object"?r.revealScope={asOfChapter:o}:a&&(r.revealScope.asOfChapter=o),r.updatedAt=Date.now(),o+=1}),n}function vP(t,e,n){if(!Array.isArray(t)||e<0||e>=t.length)return!1;const o=Math.max(0,Math.min(t.length-1,n));if(o===e)return!1;const[r]=t.splice(e,1);return t.splice(o,0,r),!0}function rn(t={}){return t.sessionId?t.sessionId:oe()?.activeSessionId||null}function fe(t){if(t==null||typeof t!="object")return t;try{return JSON.parse(JSON.stringify(t))}catch{return Array.isArray(t)?[...t]:{...t}}}function Iu(t){const e=new WeakSet,n=o=>o==null||typeof o!="object"?o:e.has(o)?null:(e.add(o),Array.isArray(o)?o.map(n):Object.keys(o).sort().reduce((r,s)=>(r[s]=n(o[s]),r),{}));try{return JSON.stringify(n(t))}catch{try{return JSON.stringify(t)}catch{return String(t)}}}function sr(t,{lowercase:e=!0}={}){const n=String(t??"").replace(/\s+/g," ").trim();return e?n.toLowerCase():n}function SP(t){return Array.isArray(t)?[...new Set(t.map(e=>sr(e)).filter(Boolean))].sort():[]}function kP(t){if(!t||typeof t!="object")return null;const e=String(t.kind||"").trim();if(e==="chapter_threshold"){const n=Number(t.value);return Number.isFinite(n)&&Math.round(n)>0?{kind:e,value:Math.round(n)}:null}return e==="manual_unlock"?{kind:e,unlocked:t.unlocked===!0||t.value===!0}:null}function xy(t){return!t||typeof t!="object"?null:{type:sr(t.type||"note"),title:sr(t.title||""),summary:sr(t.summary||""),tags:SP(t.tags),visibility:sr(t.visibility||"revealed"),revealGate:kP(t.revealGate)}}function nm(t={}){return Iu({worldId:t?.worldId||null,bookId:t?.bookId||null,proposalType:String(t?.proposalType||""),targetItemId:t?.targetItemId||null,afterPayload:xy(t?.afterPayload??null)})}function om(t={}){const e=String(t?.proposalType||"").trim();if(e!=="create_item"&&e!=="edit_item")return null;const n=xy(t?.afterPayload??null);return n?.title?Iu({worldId:t?.worldId||null,bookId:t?.bookId||null,proposalType:e,targetItemId:t?.targetItemId||null,type:n.type||"note",title:n.title}):null}function xP(t){if(typeof t=="string")return t;if(Array.isArray(t))return t.map(e=>e?.type==="text"?e.text||"":e?.type==="image_url"?"[image]":"").filter(Boolean).join(`
`);if(t&&typeof t=="object")try{return JSON.stringify(t)}catch{return String(t)}return""}function ya(t,e=5e3){const n=String(t||"").trim();return n?n.length<=e?n:`${n.slice(0,e)}
...[trimmed]`:""}function CP(t,e=5e3){const n=String(t||"").trim();return n?n.length<=e?n:`...[trimmed]
${n.slice(-e)}`:""}function Cy(t=""){const e=String(t||"").trim();if(!e)return"";const n=e.replace(/<\s*br\s*\/?>/gi,`
`).replace(/<\/(p|div|li|ul|ol|h[1-6]|blockquote|section|article)>/gi,`$&
`);if(typeof document<"u"&&document.createElement){const o=document.createElement("div");return o.innerHTML=n,(o.textContent||o.innerText||"").replace(/\r\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}return n.replace(/<[^>]+>/g," ").replace(/&nbsp;/gi," ").replace(/\s+\n/g,`
`).replace(/\n{3,}/g,`

`).replace(/[ \t]{2,}/g," ").trim()}function Ey(t,{maxChars:e=7e3}={}){const n=typeof t?.composerContent=="string"?t.composerContent:"";if(!n.trim())return"";const o=Cy(n);return CP(o,Math.max(1e3,Number(e)||7e3))}function EP(t=""){const e=String(t||"").trim();if(!e)return null;const o=e.match(/```(?:json)?\s*([\s\S]*?)```/i)?.[1]?.trim()||e;try{return JSON.parse(o)}catch{const s=e.match(/\{[\s\S]*\}$/);if(s)try{return JSON.parse(s[0])}catch{return null}return null}}function IP(t){const e=String(t?.globalSettings?.activeSummarizationPreset||"Standard").trim()||"Standard",n=t?.globalSettings?.summarizationPromptPresets&&typeof t.globalSettings.summarizationPromptPresets=="object"?t.globalSettings.summarizationPromptPresets:{},o={...Ft,...n},r=String(o[e]||t?.globalSettings?.systemUtilityAgent?.summarizationPrompt||$r?.summarizationPrompt||Ft.Standard||"");return{presetName:e,promptTemplate:r}}function AP(t){const e=t?.globalSettings?.systemUtilityAgent;return e?.model?{...fe(e),model:e.model}:$r?.model?{...fe($r),model:$r.model}:null}function NP(t,e){if(!t||!e)return null;const n=String(e?.bookAgentConfig?.agentPresetName||"").trim();return n&&t.agentPresets?.[n]?n:null}function MP(t,e){if(!t||!e)return null;const n=e?.codexAgentConfig&&typeof e.codexAgentConfig=="object"?e.codexAgentConfig:{};if(n.useBookAgent!==!1)return NP(t,e);const o=String(n.agentPresetName||"").trim();return o&&t.agentPresets?.[o]?o:null}function TP(t,e,{taskSystemPrompt:n="",defaultTemperature:o=.1}={}){if(!t||!e)return{agent:null,presetName:null,error:"Book not found."};const r=MP(t,e);if(!r)return{agent:null,presetName:null,error:"Codex Agent is not configured for this Book. Set it in Book > Codex first."};const s=t.agentPresets?.[r];if(!s||!s.model)return{agent:null,presetName:null,error:`Selected Codex Agent preset "${r}" is missing or has no model.`};const i=String(e?.codexAgentConfig?.systemPromptOverride||"").trim(),a=String(s.systemPrompt||"").trim(),l=[a,i,String(n||"").trim()].filter(Boolean).join(`

`);return{agent:{...fe(s),systemPrompt:l||a||"",temperature:Number.isFinite(Number(s.temperature))?s.temperature:o},presetName:r,error:null}}function Iy(t,e=8){const n=ke(t?.history).filter(o=>o&&(o.role==="user"||o.role==="assistant")).slice(-Math.max(2,e));return Au(n)}function PP(t={}){const e=ke(t?.history).filter(n=>n&&(n.role==="user"||n.role==="assistant"));return Au(e,{startIndex:0})}function Ay(t,e="chat"){if(String(e||"chat").trim().toLowerCase()==="composer"){const o=Cy(typeof t?.composerContent=="string"?t.composerContent:"");return ya(o,22e3)}return ya(PP(t),22e3)}function BP({promptTemplate:t="",sourceText:e="",sourceKind:n="chat",previousSummary:o=""}={}){const r=n==="composer"?"Chapter draft from Composer":"Chapter conversation from Chat",s=String(t||"").trim()||String(Ft.Standard||""),i=String(o||"").trim()||"No previous chapter summary.";return[s.replace(/\$\{previousSummary\}/g,i).replace(/\$\{newMessages\}/g,e),"","Additional constraints for Book Overview chapter bubble:","- Summarize this single chapter only (not the whole book).","- Keep it concise but specific (roughly 3-7 sentences).",`- Source used: ${r}.`,"- Preserve character names, places, key events, and important objects.","- Return only the summary text."].join(`
`)}function Au(t=[],{startIndex:e=0}={}){return ke(t).filter(o=>o&&(o.role==="user"||o.role==="assistant")).map((o,r)=>{const s=o.speaker||o.role||"unknown",i=ya(xP(o.content),1800)||"(no text)";return`[${e+r+1}] ${s}
${i}`}).join(`

`)}function OP(t,{lastScannedMessageCount:e=0,maxMessages:n=12}={}){const o=ke(t?.history).filter(d=>d&&(d.role==="user"||d.role==="assistant")),r=o.length,s=Number.isFinite(Number(e))?Math.max(0,Math.round(Number(e))):0,i=Math.min(s,r),a=o.slice(i);if(a.length===0)return{totalUsable:r,startIndex:i,deltaMessages:a,transcriptText:""};const l=a.slice(-Math.max(1,n)),c=r-l.length;return{totalUsable:r,startIndex:i,deltaMessages:l,transcriptText:Au(l,{startIndex:c})}}function LP({session:t,world:e,worldContextPack:n,latestMessagesText:o,composerDraftText:r}){const s=Array.isArray(n?.selectedItems)?n.selectedItems:[],i=s.length>0?s.map(a=>`- id=${a.id} | type=${a.type} | title=${a.title}`).join(`
`):"- (none)";return["You are a continuity scribe for a writing app.","Extract proposed updates to the World from the recent chat conversation.","Return JSON only (no markdown).","",`Schema version: ${pP}`,"Output format:","{",'  "schemaVersion": 1,','  "proposals": [',"    {",'      "proposalType": "create_item" | "edit_item",','      "targetItemId": "required for edit_item, omit for create_item",','      "afterPayload": {','        "type": "entity|place|rule|event|note|source|relationship",','        "title": "string",','        "summary": "string",','        "tags": ["optional", "tags"],','        "visibility": "revealed|gated",','        "revealGate": { "kind": "chapter_threshold", "value": number } | null',"      },",'      "reason": "short reason based on the conversation"',"    }","  ]","}","","Rules:","- Only propose changes that are explicitly stated or strongly implied in the recent messages.","- Prefer create_item unless an existing visible item clearly matches and should be edited.","- Do not delete items.","- Keep proposals concise and specific.",'- If no useful world updates are found, return {"schemaVersion":1,"proposals":[]}.',"",`Current session: ${t?.name||"Untitled"} (Act ${t?.actNumber||"-"}, Chapter ${t?.chapterNumber||"-"})`,`World: ${e?.name||"Unknown"}`,"","Visible world items already in context (you may edit these by targetItemId):",i,"","World Context Pack (spoiler-safe canonical context):",ya(n?.contextText||"(none)",6e3),"","Current chapter draft from Composer (latest excerpt, plain text):",r||"(none)","","Recent chat messages:",o||"(none)"].join(`
`)}function DP(t){return String(t||"").trim()==="edit_item"?"edit_item":"create_item"}function RP(t={}){const e={type:String(t?.type||"note").trim().toLowerCase()||"note",title:String(t?.title||"").trim(),summary:typeof t?.summary=="string"?t.summary:"",tags:Array.isArray(t?.tags)?t.tags.map(o=>String(o||"").trim()).filter(Boolean):[],visibility:String(t?.visibility||"").trim().toLowerCase()==="gated"?"gated":"revealed",revealGate:null},n=t?.revealGate;if(e.visibility==="gated"&&n&&typeof n=="object"&&n.kind==="chapter_threshold"){const o=Number(n.value);Number.isFinite(o)&&Math.round(o)>0?e.revealGate={kind:"chapter_threshold",value:Math.round(o)}:e.visibility="revealed"}return e}function Ny(t,{label:e="item",getName:n=s=>s?.name||s?.title||"Untitled",getExtra:o=()=>"",includeNoneOption:r=!1}={}){const s=[`Select ${e}:`];return r&&s.push("0. (None)"),t.forEach((i,a)=>{const l=String(o(i)||"").trim(),c=l?` â€” ${l}`:"";s.push(`${a+1}. ${n(i)}${c}`)}),s.join(`
`)}function jP(t,{defaultWorldId:e=null,allowNone:n=!1,title:o="World"}={}){const r=ke(t?.worlds);if(r.length===0){k("No worlds available yet.","Info");return}const s=Math.max(0,r.findIndex(c=>c.id===e)),i=prompt(`${Ny(r,{label:o,getName:c=>c.name,getExtra:c=>`${ke(c.items).length} items`,includeNoneOption:n})}

Enter number:`,String(n?e?s+1:0:s+1));if(i===null)return;const a=Number(i);if(!Number.isFinite(a))return;if(n&&Math.round(a)===0)return null;const l=Math.round(a)-1;if(!(l<0||l>=r.length))return r[l].id}function _P(t,{defaultBookId:e=null,title:n="Book"}={}){const o=ke(t?.books);if(o.length===0){k("No books available yet.","Info");return}const r=Math.max(0,o.findIndex(l=>l.id===e)),s=prompt(`${Ny(o,{label:n,getName:l=>l.name,getExtra:l=>`${ke(l?.structure?.chapterSessionIds).length} chapters${l?.linkedWorldId?", linked world":""}`})}

Enter number:`,String(r+1));if(s===null)return;const i=Number(s);if(!Number.isFinite(i))return;const a=Math.round(i)-1;if(!(a<0||a>=o.length))return o[a].id}function My(t,e={}){const n={...t,...e,content:e.content!==void 0?fe(e.content):fe(t.content),tags:e.tags!==void 0?fe(e.tags):fe(t.tags),sourceRefs:e.sourceRefs!==void 0?fe(e.sourceRefs):fe(t.sourceRefs)};return md({...n,updatedAt:Date.now()})}function $P(){const t=oe();if(!t)return null;const e=prompt("World name:",`World ${ke(t.worlds).length+1}`);return!e||!e.trim()?null:Ty({name:e.trim()})}function FP(t={}){const e=oe();if(!e)return null;se(e);const n=et(e,t.worldId||e.activeWorldId);if(!n)return null;const o=prompt("Rename world:",n.name);return!o||!o.trim()?null:Py({worldId:n.id,name:o.trim()})}function Ty(t={}){const e=oe();if(!e)return null;se(e);const n=Date.now(),o=km({id:Cm(),name:(t.name||"").trim()||`World ${e.worlds.length+1}`,description:t.description||"",scope:t.scope||(t.ownerBookId?hi:xm),ownerBookId:t.ownerBookId||null,sharedBookIds:Array.isArray(t.sharedBookIds)?t.sharedBookIds:t.ownerBookId?[t.ownerBookId]:[],createdAt:n,updatedAt:n,version:1,items:[]});return e.worlds.unshift(o),(t.setActive!==!1||!e.activeWorldId)&&(e.activeWorldId=o.id),we({worldId:o.id,reason:"world:create"}),o}function Py(t={}){const e=oe();if(!e)return null;se(e);const n=et(e,t.worldId);if(!n)return k("World not found.","Error"),null;if(typeof t.name=="string"&&t.name.trim()&&(n.name=t.name.trim()),typeof t.description=="string"&&(n.description=t.description),Object.prototype.hasOwnProperty.call(t,"ownerBookId")&&(n.ownerBookId=typeof t.ownerBookId=="string"&&t.ownerBookId.trim()?t.ownerBookId.trim():null),Array.isArray(t.sharedBookIds)&&(n.sharedBookIds=[...new Set(t.sharedBookIds.map(o=>String(o||"").trim()).filter(Boolean))]),typeof t.scope=="string"){const o=String(t.scope).trim().toLowerCase();n.scope=o===Bu?Bu:o===hi?hi:xm}return n.updatedAt=Date.now(),we({worldId:n.id,reason:"world:update"}),n}function WP(t={}){const e=oe();if(!e)return!1;se(e);const n=et(e,t.worldId);return n?(e.activeWorldId===n.id||(e.activeWorldId=n.id,we({worldId:n.id,reason:"world:setActive"})),!0):!1}function zP(t={}){const e=oe();if(!e)return!1;se(e);const n=t.worldId,o=et(e,n);return!o||t.confirm!==!1&&!confirm(`Delete world "${o.name}"?`)?!1:(e.worlds=(e.worlds||[]).filter(r=>r.id!==n),e.worldChanges=(e.worldChanges||[]).filter(r=>r.worldId!==n),(e.books||[]).forEach(r=>{r.linkedWorldId===n&&(r.linkedWorldId=null,r.updatedAt=Date.now())}),Ca(e),io(e),we({reason:"world:delete"}),!0)}function HP(t={}){const e=oe();if(!e)return null;se(e);const n=prompt("Book name:",`Book ${ke(e.books).length+1}`);return!n||!n.trim()?null:By({...t,name:n.trim(),linkedWorldId:t.linkedWorldId||e.activeWorldId||null})}function UP(t={}){const e=oe();if(!e)return null;se(e);const n=Le(e,t.bookId||e.activeBookId);if(!n)return null;const o=prompt("Rename book:",n.name);return!o||!o.trim()?null:Oy({bookId:n.id,name:o.trim()})}function By(t={}){const e=oe();if(!e)return null;se(e);const n=mP(e),o=Object.prototype.hasOwnProperty.call(t,"linkedWorldId")?t.linkedWorldId||null:e.activeWorldId||null,r=o&&et(e,o)?o:null,s=Date.now(),i=fw({id:mw(),name:(t.name||"").trim()||`Book ${e.books.length+1}`,description:t.description||"",linkedWorldId:r,bookAgentSessionId:t.bookAgentSessionId||null,autoNumberChapters:t.autoNumberChapters!==!1,constraints:typeof t.constraints=="object"&&t.constraints?fe(t.constraints):{},composerDocs:typeof t.composerDocs=="object"&&t.composerDocs?fe(t.composerDocs):{treatment:"",synopsis:"",outline:"",sceneBeats:""},exportProfile:typeof t.exportProfile=="object"&&t.exportProfile?fe(t.exportProfile):{title:(t.name||"").trim()||`Book ${e.books.length+1}`,subtitle:"",author:"",chapterTitleMode:"number_and_title",includeChapterSummaries:!1,sceneBreakMarker:"***",frontMatterNotes:""},bookAgentConfig:typeof t.bookAgentConfig=="object"&&t.bookAgentConfig?fe(t.bookAgentConfig):{agentPresetName:n,systemPromptOverride:""},codexAgentConfig:typeof t.codexAgentConfig=="object"&&t.codexAgentConfig?fe(t.codexAgentConfig):{useBookAgent:!0,agentPresetName:null,systemPromptOverride:""},agentAutomation:typeof t.agentAutomation=="object"&&t.agentAutomation?fe(t.agentAutomation):{worldProposals:{autoProposeEnabled:!1,lastScannedMessageCount:0,lastScannedAt:null}},structure:{acts:[],chapterSessionIds:[]},createdAt:s,updatedAt:s},{validWorldIds:new Set((e.worlds||[]).map(a=>a.id))});return e.books.unshift(i),(t.setActive!==!1||!e.activeBookId)&&(e.activeBookId=i.id),!i.linkedWorldId&&t.createBookWorld!==!1&&ky(e,i,{name:t.bookWorldName||"",description:t.bookWorldDescription||""}),we({bookId:i.id,reason:"book:create"}),i}function Oy(t={}){const e=oe();if(!e)return null;se(e);const n=Le(e,t.bookId);return n?(typeof t.name=="string"&&t.name.trim()&&(n.name=t.name.trim()),typeof t.description=="string"&&(n.description=t.description),t.constraints&&typeof t.constraints=="object"&&(n.constraints={...n.constraints||{},...fe(t.constraints)}),t.composerDocs&&typeof t.composerDocs=="object"&&(n.composerDocs={...n.composerDocs||{},...fe(t.composerDocs)}),t.exportProfile&&typeof t.exportProfile=="object"&&(n.exportProfile={...n.exportProfile||{},...fe(t.exportProfile)}),t.bookAgentConfig&&typeof t.bookAgentConfig=="object"&&(n.bookAgentConfig={...n.bookAgentConfig||{},...fe(t.bookAgentConfig)}),t.codexAgentConfig&&typeof t.codexAgentConfig=="object"&&(n.codexAgentConfig={...n.codexAgentConfig||{},...fe(t.codexAgentConfig)}),t.agentAutomation&&typeof t.agentAutomation=="object"&&(n.agentAutomation={...n.agentAutomation||{},...fe(t.agentAutomation)},t.agentAutomation.worldProposals&&typeof t.agentAutomation.worldProposals=="object"&&(n.agentAutomation.worldProposals={...n.agentAutomation&&n.agentAutomation.worldProposals||{},...fe(t.agentAutomation.worldProposals)})),Object.prototype.hasOwnProperty.call(t,"bookAgentSessionId")&&(n.bookAgentSessionId=typeof t.bookAgentSessionId=="string"&&t.bookAgentSessionId.trim()?t.bookAgentSessionId.trim():null),t.autoNumberChapters!==void 0&&(n.autoNumberChapters=t.autoNumberChapters!==!1),n.updatedAt=Date.now(),we({bookId:n.id,reason:"book:update"}),n):(k("Book not found.","Error"),null)}function VP(t={}){const e=oe();if(!e)return null;se(e);const n=Le(e,t.bookId);if(!n)return k("Book not found.","Error"),null;const o=Number(t.actNumber),r=Number.isFinite(o)&&Math.round(o)>0?Math.round(o):null;if(!r)return k("Valid act number is required.","Error"),null;(!n.structure||typeof n.structure!="object")&&(n.structure={acts:[],chapterSessionIds:[]}),n.structure.acts=ke(n.structure.acts);let s=n.structure.acts.find(i=>Number(i?.order)===r)||null;if(s||(s={id:`act_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,order:r,title:`Act ${r}`,summary:""},n.structure.acts.push(s)),typeof t.title=="string"){const i=t.title.trim();s.title=i||`Act ${r}`}return typeof t.summary=="string"&&(s.summary=t.summary),s.order=r,n.structure.acts=n.structure.acts.filter(Boolean).sort((i,a)=>{const l=Number.isFinite(Number(i?.order))?Math.round(Number(i.order)):Number.MAX_SAFE_INTEGER,c=Number.isFinite(Number(a?.order))?Math.round(Number(a.order)):Number.MAX_SAFE_INTEGER;return l!==c?l-c:String(i?.title||"").localeCompare(String(a?.title||""))}),n.updatedAt=Date.now(),we({bookId:n.id,reason:"book:actUpsert"}),s}function qP(t={}){const e=oe();if(!e)return!1;se(e);const n=Le(e,t.bookId);return n?(e.activeBookId===n.id||(e.activeBookId=n.id,we({bookId:n.id,reason:"book:setActive"})),!0):!1}function KP(t={}){const e=oe();if(!e)return!1;se(e);const n=Le(e,t.bookId||e.activeBookId);if(!n)return k("Book not found.","Error"),!1;const o=jP(e,{defaultWorldId:n.linkedWorldId||e.activeWorldId,allowNone:!0,title:"world to link"});return o===void 0?!1:Ly({bookId:n.id,worldId:o})}function Ly(t={}){const e=oe();if(!e)return!1;se(e);const n=Le(e,t.bookId);if(!n)return k("Book not found.","Error"),!1;const o=t.worldId&&et(e,t.worldId)?.id||null;return n.linkedWorldId===o||(n.linkedWorldId=o,n.updatedAt=Date.now(),as(e),we({worldId:o,bookId:n.id,reason:"book:linkWorld"})),!0}function GP(t={}){const e=oe();if(!e)return null;se(e);const n=Le(e,t.bookId||e.activeBookId);if(!n)return k("Book not found.","Book"),null;let o=n.linkedWorldId?et(e,n.linkedWorldId):null;return o?(t.setActive!==!1&&e.activeWorldId!==o.id&&(e.activeWorldId=o.id,as(e),we({worldId:o.id,bookId:n.id,reason:"book:ensureWorld:setActive"})),o):(o=ky(e,n,{name:t.name||"",description:t.description||""}),o?(as(e),we({worldId:o.id,bookId:n.id,reason:"book:ensureWorld:create"}),o):(k("Could not create Book World.","Book"),null))}function JP(t={}){const e=oe();if(!e)return!1;se(e);const n=t.bookId,o=Le(e,n);return!o||t.confirm!==!1&&!confirm(`Delete book "${o.name}"? Chapter metadata links will be cleared.`)?!1:(e.books=(e.books||[]).filter(r=>r.id!==n),(e.chatSessions||[]).forEach(r=>{r.bookId===n&&(Object.assign(r,_o({...r,bookId:null,actNumber:null,chapterNumber:null,chapterTitle:"",revealScope:{asOfChapter:null}},{validBookIds:new Set})),r.kind=gi)}),(e.chatSessions||[]).forEach(r=>{r?.bookAgentBookId===n&&(r.bookAgentBookId=null,r.kind=gi,r.updatedAt=Date.now())}),e.worldChanges=(e.worldChanges||[]).filter(r=>r.bookId!==n),io(e),we({reason:"book:delete",includeSessionListRefresh:!0}),!0)}function YP(t={}){const e=oe();if(!e)return null;se(e);const n=rn(t),o=Qe(e,n);if(!o)return k("No active chat session to assign.","Info"),null;const r=_P(e,{defaultBookId:o.bookId||e.activeBookId,title:"book for this chat"});return r?Dy({...t,sessionId:n,bookId:r}):null}function XP(t={}){const e=oe();if(!e)return null;se(e);const n=rn(t),o=Qe(e,n);if(!o)return k("Chat session not found.","Error"),null;const r=prompt("Act number (blank to keep):",o.actNumber?String(o.actNumber):"");if(r===null)return null;const s=prompt("Chapter number (blank to keep):",o.chapterNumber?String(o.chapterNumber):"");if(s===null)return null;const i=prompt("Reveal scope as-of chapter (blank = use chapter number):",o.revealScope?.asOfChapter?String(o.revealScope.asOfChapter):"");if(i===null)return null;const a=prompt("Chapter title (optional):",o.chapterTitle||"");if(a===null)return null;const l=prompt('Writing mode ("writing" or "author"):',o.writingMode||"writing");if(l===null)return null;const c=d=>{const u=String(d||"").trim();if(!u)return null;const f=Number(u);return Number.isFinite(f)?Math.round(f):null};return Ry({sessionId:n,actNumber:c(r),chapterNumber:c(s),chapterTitle:String(a||""),writingMode:String(l||"").trim().toLowerCase()==="author"?"author":"writing",revealScope:{asOfChapter:c(i)}})}function Dy(t={}){const e=oe();if(!e)return null;se(e);const n=rn(t),o=Qe(e,n);if(!o)return k("Chat session not found.","Error"),null;const r=Le(e,t.bookId||e.activeBookId);if(!r)return k("Book not found.","Error"),null;const s=t.actNumber??o.actNumber??yP(e,r.id),i=t.autoNumber!==!1&&r.autoNumberChapters!==!1,a=t.chapterNumber??o.chapterNumber??(i?bP(e,r.id):null),l={...o,bookId:r.id,actNumber:s,chapterNumber:a,chapterTitle:t.chapterTitle??o.chapterTitle,chapterSummary:t.chapterSummary??o.chapterSummary,chapterStatus:t.chapterStatus??o.chapterStatus,revealScope:t.revealScope??o.revealScope,writingMode:t.writingMode??o.writingMode},c=new Set((e.books||[]).map(d=>d.id));return Object.assign(o,_o(l,{validBookIds:c})),t.revealScope&&typeof t.revealScope=="object"&&(o.revealScope={...o.revealScope||{},...fe(t.revealScope)}),o.kind=dd,o.updatedAt=Date.now(),(e.books||[]).forEach(d=>{d?.structure&&(d.structure.chapterSessionIds=Sy(ke(d.structure.chapterSessionIds),o.id),xr(e,d))}),(!r.structure||typeof r.structure!="object")&&(r.structure={acts:[],chapterSessionIds:[]}),r.structure.chapterSessionIds=ke(r.structure.chapterSessionIds),Xt(r.structure.chapterSessionIds,o.id),r.updatedAt=Date.now(),e.activeBookId=r.id,r.linkedWorldId&&(e.activeWorldId=r.linkedWorldId),An(e,o),we({worldId:r.linkedWorldId||null,bookId:r.id,reason:"chapter:assignToBook",includeSessionListRefresh:!0}),o}function QP(t={}){const e=oe();if(!e)return!1;se(e);const n=rn(t),o=Qe(e,n);if(!o)return!1;if(!o.bookId)return!0;const r=o.bookId,s=Le(e,r);return Object.assign(o,_o({...o,bookId:null,actNumber:null,chapterNumber:null,chapterTitle:"",revealScope:{asOfChapter:null}},{validBookIds:new Set((e.books||[]).map(i=>i.id))})),o.kind=gi,o.updatedAt=Date.now(),s?.structure&&(s.structure.chapterSessionIds=Sy(ke(s.structure.chapterSessionIds),o.id),s.updatedAt=Date.now()),An(e,o),we({bookId:r,reason:"chapter:detachFromBook",includeSessionListRefresh:!0}),!0}function Ry(t={}){const e=oe();if(!e)return null;se(e);const n=rn(t),o=Qe(e,n);if(!o)return k("Chat session not found.","Error"),null;const r=new Set((e.books||[]).map(i=>i.id)),s={...o,...fe(t),revealScope:{...o.revealScope||{},...t.revealScope&&typeof t.revealScope=="object"?t.revealScope:{}}};if(delete s.sessionId,Object.assign(o,_o(s,{validBookIds:r})),o.kind=o.bookId?dd:gi,o.updatedAt=Date.now(),o.bookId){const i=Le(e,o.bookId);i&&((!i.structure||typeof i.structure!="object")&&(i.structure={acts:[],chapterSessionIds:[]}),i.structure.chapterSessionIds=ke(i.structure.chapterSessionIds),Xt(i.structure.chapterSessionIds,o.id),xr(e,i),i.updatedAt=Date.now())}return An(e,o),we({bookId:o.bookId,reason:"chapter:updateMeta",includeSessionListRefresh:!0}),o}async function jy(t={}){const e=oe();if(!e)return null;se(e);const n=rn(t),o=Qe(e,n),r=t.silent===!0;if(!o)return r||k("Chapter session not found.","Chapter Summary"),null;if(!o.bookId)return r||k("This chat is not linked to a Book chapter.","Chapter Summary"),null;const s=String(t.source||"chat").trim().toLowerCase()==="composer"?"composer":"chat",i=Ay(o,s);if(!i)return r||k(s==="composer"?"No Composer draft found for this chapter.":"Not enough Chat content to summarize for this chapter.","Chapter Summary"),null;const a=AP(e);if(!a?.model)return r||k("No summarization model configured. Check Summary settings.","Chapter Summary"),null;const{presetName:l,promptTemplate:c}=IP(e),d=BP({promptTemplate:c,sourceText:i,sourceKind:s,previousSummary:String(o.chapterSummary||"")});try{h.bus.publish("chapter:overviewSummaryProgress",{sessionId:o.id,bookId:o.bookId,source:s,state:"start",batch:t.batch===!0}),r||h.bus.publish("status:update",{message:`Summarizing chapter from ${s==="composer"?"Composer":"Chat"}...`,state:"loading"});const u=await Sa(a,[{role:"user",content:d}]),f=String(u?.content||"").trim();if(!f)throw new Error("Received an empty summary response.");return o.chapterSummary=f,o.chapterSummaryMeta={source:s,presetName:l,model:a.model,updatedAt:Date.now()},o.updatedAt=Date.now(),we({bookId:o.bookId,reason:"chapter:overviewSummary",includeSessionListRefresh:!1}),r||(h.bus.publish("status:update",{message:"Chapter summary updated.",state:"success"}),k(`Chapter summary updated from ${s==="composer"?"Composer":"Chat"} (preset: ${l}).`,"Chapter Summary")),f}catch(u){return console.error("Failed to summarize chapter for overview:",u),r||(h.bus.publish("status:update",{message:"Failed to summarize chapter.",state:"error"}),k(`Failed to summarize chapter: ${u.message||u}`,"Chapter Summary")),null}finally{h.bus.publish("chapter:overviewSummaryProgress",{sessionId:o.id,bookId:o.bookId,source:s,state:"done",batch:t.batch===!0})}}async function ZP(t={}){const e=oe();if(!e)return null;se(e);const n=Le(e,t.bookId||e.activeBookId);if(!n)return k("Book not found.","Chapter Summary"),null;const o=String(t.source||"composer").trim().toLowerCase()==="chat"?"chat":"composer",s=Eu(e,n).filter(c=>!String(c?.chapterSummary||"").trim());if(s.length===0)return k("No missing chapter summaries in this Book.","Chapter Summary"),{total:0,summarized:0,skippedNoSource:0,failed:0};h.bus.publish("book:overviewSummaryBatchProgress",{bookId:n.id,source:o,state:"start",total:s.length}),h.bus.publish("status:update",{message:`Summarizing ${s.length} chapter(s) from ${o==="composer"?"Composer":"Chat"}...`,state:"loading"});let i=0,a=0,l=0;try{for(const d of s){if(!Ay(d,o)){a+=1;continue}const f=await jy({sessionId:d.id,source:o,silent:!0,batch:!0});typeof f=="string"&&f.trim()?i+=1:l+=1}const c=[];return c.push(`Updated ${i} chapter summary${i===1?"":"ies"}`),a>0&&c.push(`${a} skipped (no ${o==="composer"?"Composer draft":"Chat content"})`),l>0&&c.push(`${l} failed`),h.bus.publish("status:update",{message:"Batch chapter summary complete.",state:l>0?"warning":"success"}),k(c.join(" â€¢ "),"Chapter Summary"),{total:s.length,summarized:i,skippedNoSource:a,failed:l}}finally{h.bus.publish("book:overviewSummaryBatchProgress",{bookId:n.id,source:o,state:"done",total:s.length,summarized:i,skippedNoSource:a,failed:l})}}function eB(t={}){const e=oe();if(!e)return!1;se(e);const n=rn(t),o=Qe(e,n);if(!o?.bookId)return k("This chat is not linked to a Book chapter.","Book"),!1;const r=Le(e,o.bookId);if(!r)return k("Book not found.","Book"),!1;Ga(r),xr(e,r),Xt(r.structure.chapterSessionIds,o.id);const s=String(t.direction||"").trim().toLowerCase();if(s!=="up"&&s!=="down")return!1;const a=Eu(e,r).filter(p=>(p.actNumber||null)===(o.actNumber||null)),l=a.findIndex(p=>p.id===o.id);if(l<0)return!1;const c=s==="up"?a[l-1]:a[l+1];if(!c)return!1;const d=r.structure.chapterSessionIds,u=d.indexOf(o.id),f=d.indexOf(c.id);return u<0||f<0?!1:(vP(d,u,f),r.autoNumberChapters!==!1&&t.renumber!==!1&&Ja(e,r),r.updatedAt=Date.now(),An(e,o),An(e,c),we({bookId:r.id,reason:"chapter:moveOrder",includeSessionListRefresh:!0}),!0)}function tB(t={}){const e=oe();if(!e)return!1;se(e);const n=rn(t),o=String(t.targetSessionId||"").trim(),r=String(t.position||"before").trim().toLowerCase()==="after"?"after":"before";if(!n||!o||n===o)return!1;const s=Qe(e,n),i=Qe(e,o);if(!s?.bookId||!i?.bookId||s.bookId!==i.bookId)return k("Chapters must be in the same Book to reorder.","Book"),!1;const a=Le(e,s.bookId);if(!a)return k("Book not found.","Book"),!1;Ga(a),xr(e,a),Xt(a.structure.chapterSessionIds,s.id),Xt(a.structure.chapterSessionIds,i.id);const l=a.structure.chapterSessionIds,c=l.indexOf(s.id);let d=l.indexOf(i.id);if(c<0||d<0)return!1;const[u]=l.splice(c,1);c<d&&(d-=1);const f=r==="after"?d+1:d;return l.splice(Math.max(0,Math.min(l.length,f)),0,u),t.adoptTargetAct!==!1&&(s.actNumber=Number.isFinite(Number(i.actNumber))?Math.round(Number(i.actNumber)):null),s.updatedAt=Date.now(),a.autoNumberChapters!==!1&&t.renumber!==!1&&Ja(e,a),a.updatedAt=Date.now(),An(e,s),An(e,i),we({bookId:a.id,reason:"chapter:reorderInBook",includeSessionListRefresh:!0}),!0}function nB(t={}){const e=oe();if(!e)return!1;se(e);const n=rn(t),o=Qe(e,n);if(!o?.bookId)return k("This chat is not linked to a Book chapter.","Book"),!1;const r=Le(e,o.bookId);if(!r)return k("Book not found.","Book"),!1;Ga(r),xr(e,r),Xt(r.structure.chapterSessionIds,o.id);const s=t.actNumber===null||t.actNumber===void 0||String(t.actNumber).trim?.()===""?null:Math.max(1,Math.round(Number(t.actNumber)));if(t.actNumber!==null&&t.actNumber!==void 0&&!Number.isFinite(Number(t.actNumber)))return k("Invalid act number.","Book"),!1;s&&(ke(r.structure.acts).find(f=>Number(f?.order)===s)||(r.structure.acts.push({id:`act_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,order:s,title:`Act ${s}`,summary:""}),r.structure.acts.sort((f,p)=>Number(f?.order||0)-Number(p?.order||0)))),o.actNumber=s,o.updatedAt=Date.now();const i=r.structure.chapterSessionIds,a=i.indexOf(o.id);a>=0&&i.splice(a,1);const l=ke(r.structure.chapterSessionIds).map(u=>Qe(e,u)).filter(u=>u&&u.id!==o.id&&u.bookId===r.id&&u.archived!==!0);let c=null,d=null;if(s===null)c=null;else for(const u of l){const f=Number.isFinite(Number(u?.actNumber))?Math.round(Number(u.actNumber)):null;if(f===s){d=u.id;continue}if(f!==null&&f>s){c=u.id;break}if(f===null){c=u.id;break}}if(d){const u=i.indexOf(d);i.splice(u+1,0,o.id)}else if(c){const u=i.indexOf(c);i.splice(Math.max(0,u),0,o.id)}else i.push(o.id);return r.autoNumberChapters!==!1&&t.renumber!==!1&&Ja(e,r),r.updatedAt=Date.now(),An(e,o),we({bookId:r.id,reason:"chapter:moveToAct",includeSessionListRefresh:!0}),!0}function oB(t={}){const e=oe();if(!e)return!1;se(e);const n=Le(e,t.bookId||e.activeBookId);if(!n)return k("Book not found.","Book"),!1;Ja(e,n),n.updatedAt=Date.now();const o=Qe(e,e.activeSessionId);return An(e,o),we({bookId:n.id,reason:"book:renumberChapters",includeSessionListRefresh:!0}),k(`Re-numbered chapters in "${n.name}".`,"Book"),!0}function rB(t={}){const e=oe();if(!e)return null;se(e);const n=t.worldId||e.activeWorldId,o=et(e,n);if(!o)return k("No active world selected.","Info"),null;const r=String(t.type||"entity"),s=t.type?r:prompt("Item type (entity/place/rule/event/note/source/relationship):",r);if(s===null)return null;const i=String(s||"").trim().toLowerCase()||"entity",a=prompt("Item title:","");if(!a||!a.trim())return null;const l=prompt("Summary / note (optional):","")??"",c=prompt("Tags (comma-separated, optional):","")??"",d=prompt("Reveal gate chapter number (blank for revealed now):","")??"",u=Number(d),f=String(d).trim()&&Number.isFinite(u)&&Math.round(u)>0;return Nu({worldId:o.id,type:i,title:a.trim(),summary:String(l||""),tags:String(c||"").split(",").map(p=>p.trim()).filter(Boolean),status:"canon",visibility:f?"gated":"revealed",revealGate:f?{kind:"chapter_threshold",value:Math.round(u)}:null})}function sB(t={}){const e=oe();if(!e)return null;se(e);const n=et(e,t.worldId||e.activeWorldId);if(!n)return null;const o=ke(n.items).find(d=>d.id===t.itemId);if(!o)return k("World item not found.","Error"),null;const r=prompt("Item title:",o.title||"");if(r===null||!r.trim())return null;const s=prompt("Summary / note:",o.summary||"")??"",i=prompt("Tags (comma-separated):",ke(o.tags).join(", "))??"",a=prompt('Visibility ("revealed" or "gated"):',o.visibility||"revealed");if(a===null)return null;let l=fe(o.revealGate),c=String(a||"").trim().toLowerCase()==="gated"?"gated":"revealed";if(c==="gated"){const d=o.revealGate?.kind==="chapter_threshold"?o.revealGate.value:"",u=prompt("Reveal at chapter number (blank to keep manual lock/none):",d?String(d):"");if(u===null)return null;const f=Number(u);String(u).trim()&&Number.isFinite(f)&&Math.round(f)>0&&(l={kind:"chapter_threshold",value:Math.round(f)})}else l=null;return _y({worldId:n.id,itemId:o.id,patch:{title:r.trim(),summary:String(s||""),tags:String(i||"").split(",").map(d=>d.trim()).filter(Boolean),visibility:c,revealGate:l}})}function Nu(t={}){const e=oe();if(!e)return null;se(e);const n=t.worldId||e.activeWorldId,o=et(e,n);if(!o)return k("World not found.","Error"),null;const r=Date.now(),s=md({...fe(t.item||{}),...fe(t),status:t.status||t.item?.status||"canon",createdBy:"user",updatedBy:"user",approvedAt:r,createdAt:r,updatedAt:r,version:1});return Array.isArray(o.items)||(o.items=[]),o.items.unshift(s),o.updatedAt=r,o.version=Number.isFinite(o.version)?o.version+1:1,we({worldId:o.id,reason:"worldItem:create"}),s}function iB(t={}){const e=oe();if(!e)return k("No project loaded.","Codex"),null;se(e);const n=String(t.text||"").trim();if(!n)return k("Please select text first.","Codex"),null;const o=Qe(e,t.sessionId||e.activeSessionId),r=Le(e,t.bookId||null),s=o?.bookId?Le(e,o.bookId):null,i=e.activeBookId?Le(e,e.activeBookId):null,a=r||s||i||null,l=t.worldId||a?.linkedWorldId||e.activeWorldId||null,c=et(e,l);if(!c?.id)return k("No active Codex/World found. Open a Book with a linked Codex first.","Codex"),null;const d=String(t.sourceKind||"chat").trim().toLowerCase()||"chat",u=String(t.type||"note").trim().toLowerCase()||"note",p=new Set(["note","entity","place","rule","event"]).has(u)?u:"note",m=Math.max(80,Number(t.summaryLimit)||280),b=n.length>m?`${n.slice(0,m).trimEnd()}â€¦`:n,y=[];Xt(y,"verbatim"),Xt(y,`${d}-selection`),ke(t.tags).forEach(x=>{const I=String(x||"").trim().toLowerCase();I&&Xt(y,I)});const w=[];ke(t.sourceRefs).forEach(x=>{const I=String(x||"").trim();I&&w.push(I)}),o?.id&&(w.push(`chat_session:${o.id}`),d==="composer"&&w.push(`composer_session:${o.id}`)),d==="chat"&&t.messageId&&w.push(`chat_message:${o?.id||"unknown"}:${String(t.messageId)}`);const v={note:"Chat Selection",entity:"Character / Entity Draft",place:"Place Draft",rule:"Rule Draft",event:"Event Draft"},S=Nu({worldId:c.id,type:p,title:String(t.title||"").trim()||hP(n,v[p]||"Selection"),summary:b,content:n,status:"draft",visibility:"revealed",tags:y,sourceRefs:w});if(!S)return null;const C=d==="composer"?"Composer":"Chat";return k(`Added selection to Codex as a draft ${p} (${c.name}) from ${C}.`,"Codex"),S}function _y(t={}){const e=oe();if(!e)return null;se(e);const n=t.worldId||e.activeWorldId,o=et(e,n);if(!o)return k("World not found.","Error"),null;Array.isArray(o.items)||(o.items=[]);const r=o.items.findIndex(a=>a.id===t.itemId);if(r<0)return k("World item not found.","Error"),null;const s=t.patch&&typeof t.patch=="object"?t.patch:t,i=My(o.items[r],{...fe(s),updatedBy:"user"});return o.items[r]=i,o.updatedAt=Date.now(),o.version=Number.isFinite(o.version)?o.version+1:1,we({worldId:o.id,reason:"worldItem:update"}),i}function aB(t={}){const e=oe();if(!e)return!1;se(e);const n=t.worldId||e.activeWorldId,o=et(e,n);if(!o||!Array.isArray(o.items))return!1;const r=o.items.find(s=>s.id===t.itemId);return!r||t.confirm!==!1&&!confirm(`Delete world item "${r.title}"?`)?!1:(o.items=o.items.filter(s=>s.id!==t.itemId),o.updatedAt=Date.now(),o.version=Number.isFinite(o.version)?o.version+1:1,we({worldId:o.id,reason:"worldItem:delete"}),!0)}function $y(t={}){const e=oe();if(!e)return null;se(e);const n=Date.now(),o=uw({id:pw(),...fe(t),status:"pending",createdAt:n,updatedAt:n}),r=nm(o),s=om(o);return ke(e.worldChanges).find(a=>{if(!a||String(a.status||"pending")!=="pending")return!1;if(nm(a)===r)return!0;if(!s)return!1;const c=om(a);return!!c&&c===s})?null:(e.worldChanges.unshift(o),we({worldId:o.worldId,bookId:o.bookId,reason:"worldChange:create"}),o)}function lB(t,e,n={}){if(!e||!e.worldId)throw new Error("Proposal is missing worldId.");const o=et(t,e.worldId);if(!o)throw new Error("Target world not found.");Array.isArray(o.items)||(o.items=[]);const r=String(e.proposalType||"").trim(),s=n.afterPayload!==void 0?fe(n.afterPayload):fe(e.afterPayload),i=n.targetItemId||e.targetItemId||s?.id||null;if(r==="create_item"){const a=md({...s,id:s?.id||i||void 0,createdBy:"agent",updatedBy:"agent",approvedAt:Date.now(),status:s?.status||"canon"}),l=o.items.findIndex(c=>c.id===a.id);l>=0?o.items[l]=a:o.items.unshift(a)}else if(r==="edit_item"){const a=o.items.findIndex(l=>l.id===i);if(a<0)throw new Error("Target world item not found for edit proposal.");o.items[a]=My(o.items[a],{...s,updatedBy:"agent",approvedAt:Date.now()})}else if(r==="delete_item"){const a=o.items.findIndex(l=>l.id===i);a>=0&&o.items.splice(a,1)}else throw new Error(`Unsupported proposal type for auto-apply: ${r||"(empty)"}`);return o.updatedAt=Date.now(),o.version=Number.isFinite(o.version)?o.version+1:1,o}function cB(t={}){const e=oe();if(!e)return null;se(e);const n=(e.worldChanges||[]).find(s=>s.id===t.changeId);if(!n)return k("World proposal not found.","Error"),null;const o=t.status==="approved"?"approved":t.status==="rejected"?"rejected":"edited";if(o!=="rejected"&&t.apply!==!1)try{lB(e,n,t)}catch(s){return console.error("[World] Failed to apply proposal:",s),k(s.message||"Failed to apply world proposal.","Error"),null}return n.status=o,t.afterPayload!==void 0&&(n.afterPayload=fe(t.afterPayload)),t.reason!==void 0&&typeof t.reason=="string"&&(n.reason=t.reason),n.reviewedBy=t.reviewedBy||"user",n.reviewedAt=Date.now(),n.updatedAt=Date.now(),we({worldId:n.worldId,bookId:n.bookId,reason:"worldChange:review"}),n}async function Fy(t={}){const e=oe();if(!e)return[];se(e);const n=t.silent===!0,o=rn(t),r=Qe(e,o);if(!r)return n||k("No active chat session found.","World Proposals"),null;const s=Le(e,t.bookId||r.bookId||e.activeBookId);if(!s)return n||k("World proposals require a Book context. Open this chat from a Book and configure Codex Agent.","World Proposals"),null;const i=et(e,t.worldId||s?.linkedWorldId||e.activeWorldId);if(!i)return n||k("No World is linked to this chat/book yet.","World Proposals"),null;const{agent:a,presetName:l,error:c}=TP(e,s);if(!a?.model)return n||k(c||"Codex Agent is not configured for this Book.","World Proposals"),null;const d=typeof t.recentMessagesText=="string"?t.recentMessagesText.trim():Iy(r,Number(t.maxMessages)||8),u=t.includeComposerDraft!==!1,f=Object.prototype.hasOwnProperty.call(t,"composerDraftText"),p=u?f?String(t.composerDraftText||"").trim():Ey(r,{maxChars:Number(t.maxComposerChars)||7e3}):"";if(!d.trim()&&!p.trim())return n||k("Not enough chapter content (chat/composer) to extract proposals.","World Proposals"),[];const m=[p?`[COMPOSER_DRAFT]
${p}`:"",d?`[RECENT_CHAT]
${d}`:""].filter(Boolean).join(`

`),b=fd(e,r,{queryText:m||d,maxItems:Number(t.maxWorldItems)||14}),y=LP({session:r,world:i,worldContextPack:b,latestMessagesText:d,composerDraftText:p});n||h.bus.publish("status:update",{message:"Extracting World proposals...",state:"loading"});try{const w=await Sa(a,[{role:"user",content:y}]),v=EP(w?.content||""),S=Array.isArray(v?.proposals)?v.proposals:[],C=[],x=[];if(S.forEach((N,E)=>{const A=DP(N?.proposalType),L=RP(N?.afterPayload||{}),B=String(N?.targetItemId||"").trim()||null;if(!L.title){x.push(`#${E+1}: missing title`);return}let G=null;if(A==="edit_item"){if(!B){x.push(`#${E+1}: edit_item missing targetItemId`);return}const _=ke(i.items).find(me=>me.id===B);if(!_){x.push(`#${E+1}: target item not found (${B})`);return}G=fe(_),L.type||(L.type=_.type||"note")}const K=$y({worldId:i.id,bookId:s?.id||r.bookId||null,chapterSessionId:r.id,proposalType:A,targetItemId:A==="edit_item"?B:null,beforePayload:G,afterPayload:L,reason:String(N?.reason||"").trim()||"Extracted from recent chat conversation.",evidenceRefs:[{type:"chat_session",sessionId:r.id,sessionName:r.name||"Untitled"}],createdByAgentId:l||a.model});K?C.push(K):x.push(`#${E+1}: duplicate pending proposal`)}),C.length===0){const N=x.length>0?`

Skipped:
${x.slice(0,5).join(`
`)}`:"";return n||k(`No world proposals were created.${N}`,"World Proposals"),[]}const I=x.length>0?` (${x.length} skipped)`:"";return n||k(`Created ${C.length} world proposal(s)${I}. Review them in World > Changes.`,"World Proposals"),C}catch(w){return console.error("[World] Proposal extraction failed:",w),n||k(`Failed to extract World proposals: ${w.message||"Unknown error"}`,"World Proposals"),null}finally{n||h.bus.publish("status:update",{message:"Ready",state:"connected"})}}function dB(t){if(!t||typeof t!="object")return null;(!t.agentAutomation||typeof t.agentAutomation!="object")&&(t.agentAutomation={}),(!t.agentAutomation.worldProposals||typeof t.agentAutomation.worldProposals!="object")&&(t.agentAutomation.worldProposals={});const e=t.agentAutomation.worldProposals;e.autoProposeEnabled=e.autoProposeEnabled===!0;const n=Number(e.lastScannedMessageCount);return e.lastScannedMessageCount=Number.isFinite(n)?Math.max(0,Math.round(n)):0,e.lastScannedComposerFingerprint=typeof e.lastScannedComposerFingerprint=="string"?e.lastScannedComposerFingerprint:null,e.lastScanSourceKind=typeof e.lastScanSourceKind=="string"?e.lastScanSourceKind:null,e.lastScanMode=typeof e.lastScanMode=="string"?e.lastScanMode:null,e.lastScanResult=typeof e.lastScanResult=="string"?e.lastScanResult:null,e.lastScanCreatedCount=Number.isFinite(Number(e.lastScanCreatedCount))?Math.max(0,Math.round(Number(e.lastScanCreatedCount))):0,e.lastScanAttemptAt=Number.isFinite(Number(e.lastScanAttemptAt))?Math.round(Number(e.lastScanAttemptAt)):null,e.lastScannedAt=Number.isFinite(e.lastScannedAt)?e.lastScannedAt:null,e}function Wy(t,e={}){const n=Le(t,e.bookId||t?.activeBookId);if(!n)return{error:"Book not found."};const o=Qe(t,e.sessionId||n.bookAgentSessionId||t?.activeSessionId);if(!o)return{error:"Book Agent chat not found."};if(o.kind!==ko&&o.bookAgentBookId!==n.id)return{error:"Target chat is not this Book Agent session."};const r=et(t,e.worldId||n.linkedWorldId||t?.activeWorldId);if(!r)return{error:"No Book World linked yet."};const s=dB(n);return{book:n,session:o,world:r,automation:s}}function uB(t={}){const e=oe();if(!e)return null;se(e);const{book:n,automation:o,error:r}=Wy(e,t);return r||!n||!o?(k(r||"Book Agent context not found.","Book Agent"),null):(o.lastScannedMessageCount=0,o.lastScannedComposerFingerprint=null,o.lastScannedAt=Date.now(),n.updatedAt=Date.now(),we({bookId:n.id,reason:"bookAgent:autoProposeCursorReset"}),k("Book Agent scan cursor reset. Next scan will re-read the full conversation window.","Book Agent"),{bookId:n.id,lastScannedMessageCount:0})}async function zy(t={}){const e=oe();if(!e)return null;se(e);const n=t.silent===!0,{book:o,session:r,world:s,automation:i,error:a}=Wy(e,t);if(a||!o||!r||!s||!i)return n||k(a||"Book Agent context not found.","World Proposals"),null;if(t.requireAutoEnabled===!0&&i.autoProposeEnabled!==!0)return{proposals:[],skipped:"auto_disabled"};const l=t.delta!==!1,c=t.includeComposerDraft!==!1;let d="",u=i.lastScannedMessageCount,f="",p=null,m=!1;if(c&&(f=Ey(r,{maxChars:Number(t.maxComposerChars)||7e3}),p=f?Iu({composerDraft:sr(f)}):null,m=p!==i.lastScannedComposerFingerprint),l){const I=OP(r,{lastScannedMessageCount:i.lastScannedMessageCount,maxMessages:Number(t.maxMessages)||12});if(d=I.transcriptText||"",u=I.totalUsable,!d.trim()&&!m)return i.lastScanSourceKind="none",i.lastScanMode=l?"delta":"manual",i.lastScanResult="no_delta",i.lastScanCreatedCount=0,i.lastScanAttemptAt=Date.now(),t.advanceCursorOnEmpty===!0?(i.lastScannedMessageCount=u,i.lastScannedAt=Date.now(),o.updatedAt=Date.now(),we({bookId:o.id,reason:"bookAgent:autoProposeNoDelta"})):h.bus.publish("world:dataChanged",{bookId:o.id,reason:"bookAgent:autoProposeNoDelta"}),h.bus.publish("world:bookAgentAutoProposeResult",{bookId:o.id,sessionId:r.id,createdCount:0,sourceKind:"none",usedChatSource:!1,usedComposerSource:!1,scanMode:l?"delta":"manual",usedDelta:l,autoTriggered:t.requireAutoEnabled===!0,noDelta:!0}),n||k("No new Book Agent messages or Composer draft changes since the last scan. Continue drafting/chatting or use Reset Cursor to scan older messages again.","World Proposals"),{proposals:[],skipped:"no_delta"}}const b=typeof t.recentMessagesText=="string"?String(t.recentMessagesText||"").trim():l?String(d||"").trim():Iy(r,Number(t.maxMessages)||8),y=c?l&&!m?"":String(f||"").trim():"",w=!!b,v=!!y,S=w&&v?"both":v?"composer":w?"chat":"none",C=await Fy({sessionId:r.id,bookId:o.id,worldId:s.id,recentMessagesText:b||void 0,includeComposerDraft:c&&(l?m:!0),composerDraftText:c&&m?f:void 0,maxComposerChars:Number(t.maxComposerChars)||7e3,maxMessages:Number(t.maxMessages)||8,maxWorldItems:Number(t.maxWorldItems)||14,silent:n});if(C===null)return null;const x=Array.isArray(C)?C.length:0;return i.lastScanSourceKind=S,i.lastScanMode=l?"delta":"manual",i.lastScanResult="success",i.lastScanCreatedCount=x,i.lastScanAttemptAt=Date.now(),c&&t.recordComposerFingerprint!==!1&&(i.lastScannedComposerFingerprint=p),l||(i.lastScannedAt=Date.now(),o.updatedAt=Date.now(),we({bookId:o.id,reason:"bookAgent:manualProposeScan"})),l&&t.advanceCursor!==!1&&(i.lastScannedMessageCount=u,i.lastScannedAt=Date.now(),o.updatedAt=Date.now(),we({bookId:o.id,reason:"bookAgent:autoProposeScan"})),h.bus.publish("world:bookAgentAutoProposeResult",{bookId:o.id,sessionId:r.id,createdCount:x,sourceKind:S,usedChatSource:w,usedComposerSource:v,scanMode:l?"delta":"manual",usedDelta:l,autoTriggered:t.requireAutoEnabled===!0}),{proposals:Array.isArray(C)?C:[],scannedMessageCount:u,usedDelta:l}}async function pB(t={}){const e=oe();if(!e)return null;se(e);const n=Qe(e,t.sessionId||e.activeSessionId);if(!n||n.kind!==ko&&!n.bookAgentBookId)return null;const o=n.bookAgentBookId||t.bookId||null;return o?zy({bookId:o,sessionId:n.id,delta:!0,requireAutoEnabled:!0,silent:!0,maxMessages:12,maxWorldItems:16}):null}function fB(t){ss({openrouterKey:t}),h.bus.publish("api:loadModels")}function mB(t){ss({ollamaBaseUrl:t})}function hB(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=o=>{try{const r=JSON.parse(o.target.result);if(r&&r.userProfile&&r.appSettings&&r.modelPresets)confirm("This will overwrite your current settings and reload the application. Are you sure?")&&(localStorage.setItem("promptPrimUserSettings_v1",JSON.stringify(r)),k("Settings imported! The app will now reload.","Success"),setTimeout(()=>window.location.reload(),1500));else throw new Error("Invalid settings file format.")}catch(r){k(`Error importing settings: ${r.message}`,"Error")}},n.readAsText(e),t.target.value=""}function Kl(){const t=wt();if(!t)return;const e=Sn(t),n=document.querySelector("#user-profile-menu .user-name"),o=document.querySelector("#user-profile-menu .user-plan"),r=document.getElementById("user-userCredits"),s=r?.querySelector("span:last-child"),i=document.querySelector("#user-profile-btn span");if(i&&t.userName&&(i.textContent=t.userName.charAt(0).toUpperCase()),n&&(n.textContent=t.userName||"User"),o){let a="Unknown",l="status-blocked";e?(a=t.planStatus==="active"?"Master Plan":"Subscription Expired",l=t.planStatus==="active"?"status-master":"status-blocked"):t.plan==="pro"?t.planStatus==="active"&&t.credits.current>0?(a="Pro Plan",l="status-active"):t.planStatus==="grace_period"?(a="Pro (Grace Period)",l="status-grace"):(a="Account Blocked",l="status-blocked"):t.plan==="free"&&(a=t.credits.current>0?"Free Plan":"Credits Depleted",l=t.credits.current>0?"status-free":"status-blocked"),o.textContent=a,o.className=`user-plan ${l}`}if(r&&s)if(e)r.style.display="none";else{r.style.display="flex";const a=Em(t.credits?.current??0);s.textContent=`$${a.toFixed(2)}`}}function gB(){const t=document.querySelector(".user-profile-container"),e=document.getElementById("user-switcher-modal");!t||!e||(t.addEventListener("click",n=>{const o=n.target.closest("[data-action]");if(!o)return;const r=o.dataset.action;switch(r!=="toggle-menu"&&n.preventDefault(),r){case"toggle-menu":Ea(n);break;case"user:account":h.bus.publish("ui:showAccountModal"),t.classList.remove("open");break;case"user:settings":sM(),t.classList.remove("open");break;case"user:logout":e.style.display="flex",t.classList.remove("open");break}}),e.addEventListener("click",n=>{const o=n.target,r=o.closest("button[data-user-id]");if(r){const s=r.dataset.userId,i=hw(s);if(!i){k(`Could not switch to ${s}. Please try again.`,"Switch Failed");return}const a=Sn(i)?"Admin (Master)":i.userName||i.userId||s;k(`Switched to ${a}. Reloading app...`,"Success"),e.style.display="none",setTimeout(()=>window.location.reload(),350)}(o.matches(".modal-close-btn")||o===e)&&(e.style.display="none")}),gw("theme-switcher-dropdown"),h.bus.subscribe("user:settingsLoaded",Kl),h.bus.subscribe("user:settingsUpdated",Kl),Kl())}function bB(t){const e=wt();if(e){if(Sn(e)){k("Master profile plan is fixed and cannot be changed here.","Plan Locked");return}confirm(`Are you sure you want to switch to the ${t} plan?`)&&(console.log(`HANDLER: Changing plan for ${e.userId} to ${t}`),bw(e.userId,t),k(`Successfully switched to ${t} plan!`,"Success"))}}function yB(t){const e=wt();e&&(console.log(`HANDLER: Refilling $${t} for ${e.userId}`),yw(e.userId,t),k(`Successfully added credits worth $${t}!`,"Success"))}const Mo=document.getElementById("account-modal"),Gl=document.getElementById("account-modal-body");function wB(){Mo&&(Hy(),Mo.style.display="flex")}function vB(){Mo&&(Mo.style.display="none")}function Hy(){const t=wt();if(!Gl||!t){Gl.innerHTML="<p>Could not load user data.</p>";return}const e=Sn(t);let n="";e?n="<p>Master profile is fixed for API management.</p>":t.plan==="free"?n='<button class="btn" data-action="switch-plan" data-plan="pro">Upgrade to Pro</button>':t.plan==="pro"&&(n=`
            <button class="btn btn-secondary" data-action="switch-plan" data-plan="free">Downgrade to Free</button>
            <button class="btn" data-action="switch-plan" data-plan="master">Upgrade to Master</button>
        `);const r=[10,30,50,100].map(i=>`<button class="btn btn-small btn-secondary" data-action="refill" data-amount="${i}">$${i}</button>`).join(""),s=Em(t.credits.current);Gl.innerHTML=`
        <div class="user-detail-grid">
            <div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" value="${t.userName}" readonly>
                </div>
                <div class="form-group">
                    <label>Current Plan</label>
                    <input type="text" value="${e?"Master":t.plan.charAt(0).toUpperCase()+t.plan.slice(1)}" readonly>
                </div>
                <div class="form-group">
                    <label>Credits</label>
                    <input type="text" value="${Math.floor(t.credits.current).toLocaleString()}" readonly>
                </div>
                <div class="form-group">
                    <label>Balance</label> 
                    <input type="text" value="$${s.toFixed(2)}" readonly>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>Change Plan</label>
                    <div>${n||"<p>No plan changes available.</p>"}</div>
                </div>
                <div class="form-group">
                    <label>Refill Credits (USD)</label>
                    <div class="refill-presets">${e?"<p>Not applicable.</p>":r}</div>
                </div>
            </div>
        </div>
    `}function SB(){h.bus.subscribe("ui:showAccountModal",wB),Mo?.addEventListener("click",t=>{if(t.target.matches(".modal-close-btn")){vB();return}const n=t.target.closest("[data-action]");if(!n)return;const o=n.dataset.action;o==="switch-plan"?bB(n.dataset.plan):o==="refill"&&yB(parseInt(n.dataset.amount,10))}),h.bus.subscribe("user:settingsUpdated",()=>{Mo&&Mo.style.display==="flex"&&Hy()})}const wa=new marked.Renderer,kB=wa.link;wa.link=(t,e,n)=>kB.call(wa,t,e,n).replace(/^<a /,'<a target="_blank" rel="noopener noreferrer" ');marked.setOptions({renderer:wa,gfm:!0,breaks:!1});function xB(){window.addEventListener("storage",t=>{t.key==="promptPrimUserDatabase_v1"&&Aw()})}function CB(){if(!("ontouchstart"in window))return;const t=document.querySelector(".sessions-panel");if(!t)return;const e=60,n=80;let o=0,r=0,s=!1;document.body.addEventListener("touchstart",i=>{!t.classList.contains("visible")&&i.touches.length===2&&i.touches[0].clientX<e&&(o=i.touches[0].clientX,r=i.touches[0].clientY,s=!0)},{passive:!0}),document.body.addEventListener("touchmove",i=>{if(!s||i.touches.length!==2){s=!1;return}const a=i.touches[0].clientX,l=i.touches[0].clientY;Math.abs(l-r)>Math.abs(a-o)&&(s=!1)},{passive:!0}),document.body.addEventListener("touchend",i=>{if(!s)return;const a=i.changedTouches[0].clientX;s=!1,a-o>n&&document.getElementById("hamburger-btn")?.click()})}function yn(t="chat"){if(document.querySelectorAll(".header-center .menu-toggle-btn").forEach(e=>e.classList.remove("active")),t==="world"){document.getElementById("switch-to-world-btn")?.classList.add("active");return}if(t==="photo"){document.getElementById("switch-to-photo-btn")?.classList.add("active");return}if(t==="composer"){document.getElementById("switch-to-composer-btn")?.classList.add("active");return}document.getElementById("switch-to-chat-btn")?.classList.add("active")}const fi="chat",_n="composer",wn="normal",Mu="maximized";let nd=!1;function od(t){return t===_n?_n:fi}function EB(t){return od(t?.workspaceView)}function rd(t){return t===wn?wn:Mu}function rm(t){return rd(t?.composerViewMode)}function sm(t){const e=Number(t?.composerHeight);if(Number.isFinite(e)&&e>0)return e;const n=Number(localStorage.getItem("promptPrimComposerHeight"));return Number.isFinite(n)&&n>0?n:null}function sd(){return va()?document.querySelector(".main-content-wrapper")?.classList.contains("composer-maximized")?Mu:wn:null}function IB(t=""){if(!t||typeof t!="string")return!1;const e=document.createElement("div");return e.innerHTML=t,String(e.textContent||"").replace(/\u00A0/g," ").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0}function AB(t){const e=typeof t=="string"?t:"";if(!e.trim())return!1;const n=h.getProject();if(!n?.activeSessionId||!Array.isArray(n.chatSessions))return!1;const o=n.chatSessions.find(l=>l.id===n.activeSessionId);if(!o)return!1;const r=typeof o.composerContent=="string"?o.composerContent:"",s=ca(r);let i=s;IB(s)&&(i+="<hr>"),i+=e;const a=ca(i);return a===r||(o.composerContent=a,h.setProject(n),h.updateAndPersistState()),!0}function Go(t,e=null){const n=od(t),o=h.getProject();if(!o?.activeSessionId||!Array.isArray(o.chatSessions))return;const r=o.chatSessions.find(c=>c.id===o.activeSessionId);if(!r)return;const s=e||sd()||r.composerViewMode||Mu,i=rd(s),a=od(r.workspaceView),l=rd(r.composerViewMode);a===n&&l===i||(r.workspaceView=n,r.composerViewMode=i,h.setProject(o),h.updateAndPersistState())}function Jl(t){nd=!0;try{t()}finally{nd=!1}}function va(){const t=document.getElementById("composer-panel");return!!(t&&!t.classList.contains("collapsed"))}function Uy(){const t=document.getElementById("kieai-studio-workspace");return!!(t&&!t.classList.contains("hidden"))}function Vy(){const t=document.getElementById("world-workspace"),e=document.getElementById("book-workspace");return!!(t&&!t.classList.contains("hidden")||e&&!e.classList.contains("hidden"))}function qy(t){const e=document.querySelector("#main-chat-panel .main-content-wrapper");e&&e.classList.toggle("world-workspace-active",!!t)}function Jo(){const t=document.getElementById("world-workspace"),e=document.getElementById("book-workspace");!t&&!e||(qy(!1),t?.classList.add("hidden"),e?.classList.add("hidden"))}function im(){try{bu()}catch{}const t=document.getElementById("world-workspace");t&&(document.getElementById("book-workspace")?.classList.add("hidden"),t.classList.remove("hidden"),qy(!0))}function Yo(){if(Vy()){yn("world");return}if(Uy()){yn("photo");return}yn(va()?"composer":"chat")}function NB(){const t=h.bus;t.subscribe("project:new",Nc),t.subscribe("project:open",hI),t.subscribe("project:fileSelectedForOpen",gI),t.subscribe("project:save",e=>rb(e)),t.subscribe("project:saveConfirm",({projectName:e})=>sb(e)),t.subscribe("project:unsavedChangesChoice",yI),t.subscribe("project:loaded",e=>{ai(e.projectData.name),Yo()}),t.subscribe("session:new",hr),t.subscribe("session:loaded",({session:e})=>{Nw(ka(e,{fallback:e?.name||"AI Assistant",includeAct:!0})),Mw(),Ro();const n=h.getState().preventPhotoStudioAutoMount,o=e.linkedEntity||h.getProject()?.activeEntity||null;if(!n)o&&h.bus.publish("entity:selected",o);else{const i=h.getProject();o&&(i.activeEntity={...o},h.setProject(i))}const r=EB(e),s=rm(e);try{if(r===_n){Et(s);const i=sm(e),a=document.getElementById("composer-panel");i&&a&&s===wn&&(a.style.flexBasis=`${Math.round(i)}px`)}else Et("collapsed")}catch(i){console.error("Could not set composer state on session load:",i)}Go(va()?_n:fi,sd());try{Pn()}catch{}Yo()}),t.subscribe("composer:append",({content:e})=>{const n=h.getState().composerApi;if(n&&n.appendContent){n.appendContent(e);return}AB(e)||console.warn("Composer is not ready and no active session to store appended content.")}),t.subscribe("session:cleared",()=>{Tw(),YN(),Ro()}),t.subscribe("session:autoRename",dI),t.subscribe("session:info",e=>DE(e)),t.subscribe("session:rename",e=>KE(e)),t.subscribe("session:move",e=>oi(e)),t.subscribe("session:movePrompt",e=>tI(e)),t.subscribe("session:contextMode",e=>Ic(e)),t.subscribe("session:contextModePrompt",e=>nI(e)),t.subscribe("session:organizeSet",e=>WE(e)),t.subscribe("session:clone",({sessionId:e,event:n})=>sI(e,n)),t.subscribe("session:archive",({sessionId:e,event:n})=>iI(e,n)),t.subscribe("session:pin",({sessionId:e,event:n})=>rI(e,n)),t.subscribe("session:delete",e=>oI(e)),t.subscribe("session:download",({sessionId:e})=>aI({sessionId:e})),t.subscribe("folder:new",e=>qd(e)),t.subscribe("folder:rename",e=>GE(e)),t.subscribe("folder:delete",e=>JE(e)),t.subscribe("folder:updateSettings",e=>YE(e)),t.subscribe("folder:newChat",e=>eI(e)),t.subscribe("folder:activate",e=>XE(e)),t.subscribe("folder:collapse",e=>QE(e)),t.subscribe("folder:sortMode",e=>ZE(e)),t.subscribe("agent:create",()=>Mf(!1)),t.subscribe("agent:save",TI),t.subscribe("agent:edit",({agentName:e})=>Mf(!0,e)),t.subscribe("agent:delete",({agentName:e})=>PI(e)),t.subscribe("agent:duplicate",({agentName:e})=>OI(e)),t.subscribe("agent:import",()=>document.getElementById("import-agents-input")?.click()),t.subscribe("agent:exportAll",v1),t.subscribe("agent:generateProfile",MI),t.subscribe("group:create",()=>$f(!1)),t.subscribe("group:save",HM),t.subscribe("group:edit",({groupName:e})=>$f(!0,e)),t.subscribe("group:delete",({groupName:e})=>UM({groupName:e})),t.subscribe("memory:create",()=>Wf(null)),t.subscribe("memory:save",T1),t.subscribe("memory:edit",({index:e})=>Wf(e)),t.subscribe("memory:delete",({index:e})=>P1({index:e})),t.subscribe("memory:toggle",e=>{M1(e)}),t.subscribe("memory:exportPackage",B1),t.subscribe("memory:importPackage",()=>{document.getElementById("load-memory-package-input").click()}),t.subscribe("studio:itemClicked",NI),t.subscribe("studio:toggleSectionVisibility",e=>Zc(e)),t.subscribe("studio:setAllSectionVisibility",e=>y1(e)),t.subscribe("entity:stagedApply",ab),t.subscribe("entity:stagedCancel",Mc),t.subscribe("session:loaded",()=>Mc()),t.subscribe("summary:editFromChat",({logId:e})=>{Lu(),setTimeout(()=>Am(e),50)}),t.subscribe("summary:generateNew",Mm),t.subscribe("summary:saveEdit",Yw),t.subscribe("summary:deleteLog",({logId:e})=>Xw({logId:e})),t.subscribe("summary:loadToContext",({logId:e})=>Qw({logId:e})),t.subscribe("settings:saveSummaryPreset",e=>Zw(e)),t.subscribe("settings:renameSummaryPreset",e=>ev(e)),t.subscribe("settings:deleteSummaryPreset",e=>tv(e)),t.subscribe("chat:clearSummaryContext",Pw),t.subscribe("summary:saveNewLog",e=>Jw(e)),t.subscribe("entity:select",({type:e,name:n})=>AI(e,n)),t.subscribe("open-composer",()=>{h.bus.publish("ui:toggleComposer")}),t.subscribe("composer:heightChanged",lI),t.subscribe("ui:requestComposerOpen",()=>{Jo(),Pn(),Et(wn),Go(_n,wn),Yo()}),t.subscribe("ui:toggleComposer",()=>{Jo(),Pn(),Et(wn),Go(_n,wn),Yo()}),t.subscribe("ui:openWorldWorkspace",()=>{Jl(()=>{try{Et("collapsed")}catch{}}),Pn(),im(),yn("world")}),t.subscribe("composer:visibilityChanged",()=>{!nd&&!Uy()&&!Vy()&&Go(va()?_n:fi,sd()),Yo()}),t.subscribe("composer:export",Ob),t.subscribe("chat:deleteMessage",e=>Bw(e)),t.subscribe("chat:sendMessage",Ow),t.subscribe("chat:stopGeneration",Lw),t.subscribe("chat:assistantTurnCompleted",e=>pB(e)),t.subscribe("chat:editMessage",({index:e})=>Dw({index:e})),t.subscribe("chat:copyMessage",({index:e,event:n})=>Rw({index:e,event:n})),t.subscribe("chat:regenerateMessage",({index:e})=>jw({index:e})),t.subscribe("chat:fileUpload",e=>Ou(e)),t.subscribe("chat:filesSelected",e=>Ou(e)),t.subscribe("chat:removeFile",({index:e})=>_w({index:e})),t.subscribe("knowledge:upload",tP),t.subscribe("knowledge:filesSelected",e=>nP(e)),t.subscribe("knowledge:delete",({fileId:e})=>oP({fileId:e})),t.subscribe("knowledge:reindex",({fileId:e})=>sP({fileId:e})),t.subscribe("knowledge:reindexAll",iP),t.subscribe("knowledge:clearAll",rP),t.subscribe("knowledge:updateSessionRagSettings",e=>dP(e)),t.subscribe("knowledge:toggleSelection",({fileId:e})=>uP({fileId:e})),t.subscribe("knowledge:setScopeSource",e=>cP(e)),t.subscribe("knowledge:focusChunk",e=>aP(e)),t.subscribe("knowledge:clearFocus",lP),t.subscribe("world:create",e=>Ty(e)),t.subscribe("world:createPrompt",e=>$P()),t.subscribe("world:update",e=>Py(e)),t.subscribe("world:renamePrompt",e=>FP(e)),t.subscribe("world:delete",e=>zP(e)),t.subscribe("world:setActive",e=>WP(e)),t.subscribe("world:itemCreate",e=>Nu(e)),t.subscribe("world:addSelectionVerbatim",e=>iB(e)),t.subscribe("world:itemCreatePrompt",e=>rB(e)),t.subscribe("world:itemUpdate",e=>_y(e)),t.subscribe("world:itemEditPrompt",e=>sB(e)),t.subscribe("world:itemDelete",e=>aB(e)),t.subscribe("world:changeCreate",e=>$y(e)),t.subscribe("world:changeReview",e=>cB(e)),t.subscribe("world:proposeFromCurrentChat",e=>Fy(e)),t.subscribe("world:bookAgentScanProposals",e=>zy(e)),t.subscribe("world:bookAgentResetScanCursor",e=>uB(e)),t.subscribe("book:create",e=>By(e)),t.subscribe("book:createPrompt",e=>HP(e)),t.subscribe("book:update",e=>Oy(e)),t.subscribe("book:actUpsert",e=>VP(e)),t.subscribe("book:renumberChapters",e=>oB(e)),t.subscribe("book:renamePrompt",e=>UP(e)),t.subscribe("book:delete",e=>JP(e)),t.subscribe("book:ensureWorld",e=>GP(e)),t.subscribe("book:setActive",e=>qP(e)),t.subscribe("book:linkWorld",e=>Ly(e)),t.subscribe("book:linkWorldPrompt",e=>KP(e)),t.subscribe("book:openWorkspace",e=>f1(e)),t.subscribe("chapter:assignToBook",e=>Dy(e)),t.subscribe("chapter:assignToBookPrompt",e=>YP(e)),t.subscribe("chapter:detachFromBook",e=>QP(e)),t.subscribe("chapter:moveInBookOrder",e=>eB(e)),t.subscribe("chapter:reorderInBook",e=>tB(e)),t.subscribe("chapter:moveToAct",e=>nB(e)),t.subscribe("chapter:updateMeta",e=>Ry(e)),t.subscribe("chapter:summarizeOverview",e=>jy(e)),t.subscribe("book:summarizeMissingOverview",e=>ZP(e)),t.subscribe("chapter:updateMetaPrompt",e=>XP(e)),t.subscribe("chat:summarize",Lu),t.subscribe("chat:clearSummary",$w),t.subscribe("upload-file",()=>{document.getElementById("file-input")?.click()}),t.subscribe("api:loadModels",is),t.subscribe("api:loadUserModels",({apiKey:e,ollamaBaseUrl:n,isUserKey:o})=>{is({apiKey:e,ollamaBaseUrl:n,isUserKey:o})}),t.subscribe("settings:apiKeyChanged",fB),t.subscribe("settings:ollamaUrlChanged",mB),t.subscribe("settings:fontChanged",EI),t.subscribe("settings:systemAgentChanged",II),t.subscribe("group:manualSelectAgent",({agentName:e})=>{const n=h.getProject(),o=n.chatSessions.find(i=>i.id===n.activeSessionId),r=n.agentGroups[n.activeEntity.name];if(!o||!r)return;const s={type:"agent_turn",agentName:e};o.groupChatState.turnQueue.push(s),o.groupChatState.awaitsUserInput=!1,h.bus.publish("ui:renderAgentSelector"),Fw(n,o,r)}),t.subscribe("kieai:generate",Om),document.getElementById("switch-to-photo-btn")?.addEventListener("click",()=>{Jl(()=>{try{Et("collapsed")}catch{}}),Jo();const e=h.getProject(),n=e?.agentPresets?.["Media Studio"]?"Media Studio":e?.agentPresets?.["Visual Studio"]?"Visual Studio":"Media Studio";h.bus.publish("entity:select",{type:"agent",name:n}),yn("photo")}),document.getElementById("switch-to-chat-btn")?.addEventListener("click",()=>{try{Et("collapsed")}catch{}Go(fi),Jo(),Pn(),h.setState("preventPhotoStudioAutoMount",!0);const e=h.getProject();_t(e.activeSessionId),setTimeout(()=>{h.setState("preventPhotoStudioAutoMount",!1)},100),yn("chat")}),document.getElementById("switch-to-composer-btn")?.addEventListener("click",()=>{Jo(),Pn();const e=h.getProject(),n=e?.chatSessions?.find(r=>r.id===e.activeSessionId),o=rm(n);try{Et(o)}catch{try{Et(o)}catch{}}if(o===wn){const r=sm(n),s=document.getElementById("composer-panel");r&&s&&(s.style.flexBasis=`${Math.round(r)}px`)}Go(_n,o),yn("composer")}),document.getElementById("switch-to-world-btn")?.addEventListener("click",()=>{Jl(()=>{try{Et("collapsed")}catch{}}),Pn(),im(),yn("world")}),t.subscribe("entity:selected",e=>{const{type:n,name:o}=e,r=h.getState().preventPhotoStudioAutoMount;n==="agent"&&(o==="Media Studio"||o==="Visual Studio"||o.includes("KieAI")||o.includes("Wan")||o.includes("Seedance")||o.includes("Veo")||o.includes("Flux"))&&!r?(Jo(),Rv(o),yn("photo")):r||(Pn(),Yo())}),console.log("âœ… Central Event Bus ready.")}function MB(){kw(),Uv(),zv(),xw(),Cw(),jv(),tM(),RE(),Qc(),Ew(),iM(),N1(),gM(),YM(),ZM(),Hw(),Gw(),Iw(),gB(),SB(),document.getElementById("import-settings-input")?.addEventListener("change",hB),console.log("âœ… All UI modules initialized.")}document.addEventListener("DOMContentLoaded",async()=>{const t=document.getElementById("loading-overlay");try{try{localStorage.removeItem("promptPrimComposerState"),localStorage.removeItem("promptPrimComposerHeight")}catch{}await ww();const e=wt(),n=Sn(e),o=vw(),r=o.providerEnabled||{};if(n||await is({apiKey:r.openrouter!==!1?o.openrouterKey:"",ollamaBaseUrl:r.ollama!==!1?o.ollamaBaseUrl:"",isUserKey:!1}),n&&e){const i=e.apiSettings?.providerEnabled||{};await is({apiKey:i.openrouter!==!1?e.apiSettings?.openrouterKey:"",ollamaBaseUrl:i.ollama!==!1?e.apiSettings?.ollamaBaseUrl:"",isUserKey:!0})}console.log("ðŸš€ Application starting..."),MB(),xB(),NB(),mI(),document.getElementById("load-memory-package-input").addEventListener("change",O1),document.getElementById("knowledge-file-input")?.addEventListener("change",i=>{h.bus.publish("knowledge:filesSelected",i.target.files),i.target.value=""});const s=localStorage.getItem("lastActiveProjectId");if(s){console.log(`Attempting to load last project with ID: ${s}`);try{await SI(s)}catch(i){console.error(`[RECOVERY] Failed to load last project (ID: ${s}). This is likely due to corrupted data.`,i),alert("Could not load your last project due to an error. A new project will be created."),localStorage.removeItem("lastActiveProjectId"),console.log("[RECOVERY] Creating a new project as a fallback."),await Nc()}}else await Nc();t?.classList.remove("active"),console.log("ðŸŽ‰ Application initialized successfully.")}catch(e){console.error("[FATAL STARTUP ERROR]",e),t.querySelector("p").textContent=`A critical error occurred: ${e.message}`}});CB();window.UserService=Sw;
