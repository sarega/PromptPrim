const Xe="AIChatbotDB_Project_",Ze="chatSessions",xt="projectMetadata",xr="projectInfo",Vn={Standard:`You are a professional summarizer. Your task is to create a dense, context-rich summary of a conversation. Include all key entities, character names, locations, critical events, and important emotional states. The summary should be detailed enough for another AI to pick up the conversation and understand all necessary context.

Here is the summary of the conversation so far:
--- PREVIOUS SUMMARY ---
\${previousSummary}
--- END PREVIOUS SUMMARY ---

Now, here are the new messages that have occurred since that summary:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide a new, single, cohesive summary that integrates the key points from the new messages into the previous one. Respond with ONLY the new, complete summary text.`,"Literary Analyst":`You are a meticulous literary analyst tasked with creating a detailed narrative digest. Your primary goal is to preserve the story's integrity, character development, and emotional nuances. Do NOT sacrifice important details for the sake of brevity.

Your digest must include:
- Plot Progression: Every significant event and the causal links between them.
- Character Arcs: Any changes in a character's state of mind, motivation, decisions, or relationships.
- Key Dialogue: Capture the essence and subtext of crucial conversations.
- Atmosphere & Setting: Mention key descriptions of the environment if they contribute to the mood or plot.
- New Elements: Note the introduction of any new characters, significant objects, or unresolved questions (foreshadowing).

Here is the narrative digest so far:
--- PREVIOUS DIGEST ---
\${previousSummary}
--- END PREVIOUS DIGEST ---

Now, here are the new scenes and dialogues that have occurred:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide a new, single, cohesive narrative digest that seamlessly integrates the key points from the new messages into the previous one. Write in a third-person, past-tense narrative style. Respond with ONLY the new, complete digest text.`,"Continuity Editor":`You are a continuity editor for a novel series. Your job is to create a 'Previously On...' document that ensures no plot points are ever lost. The output must be extremely detailed, acting as a perfect memory for another AI to continue the story without missing a single beat.

The document must retain:
- All character actions and their immediate consequences.
- The full names of any character or location mentioned.
- The specifics of any plans made or secrets revealed.
- Emotional state of each character at the end of the scene.
- Any objects that were acquired, lost, or noted as important.

The goal is maximum information retention, not summarization. Think of this as expanding upon the previous summary with new, detailed information.

Here is the continuity document so far:
--- PREVIOUS SUMMARY ---
\${previousSummary}
--- END PREVIOUS SUMMARY ---

Now, here are the new events to be added:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide the updated, complete continuity document, integrating the new events chronologically. Your response should be a single block of text containing only the updated document.`},Ar={model:"openai/gpt-4o-mini",systemPrompt:"You are a highly efficient assistant that processes user requests and responds in a structured JSON format when required. You are objective and precise.",summarizationPrompt:Vn.Standard,temperature:.2,topP:1,topK:0,presence_penalty:0,frequency_penalty:0,max_tokens:2048,seed:-1,stop_sequences:""},Mr={id:`agent_${Date.now()}`,createdBy:"Unknown User",createdAt:Date.now(),modifiedAt:Date.now(),type:"custom",author:"",version:"1.0.0",description:"",tags:[],activeMemories:[],actions:[],icon:"ðŸ¤–",model:"",systemPrompt:"You are a helpful assistant.",useMarkdown:!0,enableWebSearch:!1,temperature:1,topP:1,topK:0,presence_penalty:0,frequency_penalty:0,max_tokens:4096,seed:-1,stop_sequences:""},M={currentProject:{},systemProviderModels:[],userProviderModels:[],isLoading:!1,allProviderModels:[],isLoading:!1,isDirtyForAutoSave:!1,abortController:null,editingAgentName:null,editingGroupName:null,stagedEntity:null,pendingFileToOpen:null,pendingActionAfterSave:null},Ee={events:{},subscribe(e,t){return typeof t!="function"?(console.warn(`Attempted to subscribe to "${e}" with a non-function.`,t),()=>{}):(this.events[e]=this.events[e]||[],this.events[e].push(t),()=>{this.events[e]=this.events[e].filter(n=>t!==n)})},publish(e,t){this.events[e]&&this.events[e].slice().forEach(n=>{if(typeof n=="function")try{n(t)}catch(o){console.error(`Error in subscriber for event "${e}":`,o)}})}},u={getState:()=>M,getProject:()=>M.currentProject,isLoading:()=>M.isLoading,getStagedEntity:()=>M.stagedEntity,setStagedEntity:(e,t=!0)=>{JSON.stringify(M.stagedEntity)!==JSON.stringify(e)&&(console.log("ðŸŸ  [STATE] Staged entity changing to:",e),M.stagedEntity=e,t&&u.bus.publish("entity:staged",e))},isUserDirty:()=>M.currentProject?.isDirtyForUser||!1,isAutoSaveDirty:()=>M.isDirtyForAutoSave,setState:(e,t)=>{M[e]=t},setProject:e=>{M.currentProject=e,Ee.publish("project:stateChanged",M.currentProject)},setLoading:e=>{M.isLoading!==e&&(M.isLoading=e,Ee.publish("loading:changed",e))},setUserDirty:e=>{M.currentProject&&M.currentProject.isDirtyForUser!==e&&(M.currentProject.isDirtyForUser=e,Ee.publish("userDirty:changed",e))},setAutoSaveDirty:e=>{M.isDirtyForAutoSave!==e&&(M.isDirtyForAutoSave=e,e&&Ee.publish("autosave:required"))},updateAndPersistState:()=>{u.setUserDirty(!0),u.setAutoSaveDirty(!0)},setSystemModels:e=>{M.systemProviderModels=e.sort((t,n)=>t.name.localeCompare(n.name)),u.bus.publish("models:loaded",M.systemProviderModels)},setUserModels:e=>{M.userProviderModels=e.sort((t,n)=>t.name.localeCompare(n.name)),u.bus.publish("user:modelsLoaded",M.userProviderModels)},newAbortController:()=>(M.abortController=new AbortController,M.abortController),abort:()=>{M.abortController&&(M.abortController.abort(),M.abortController=null)},bus:Ee};let O;function Qn(){return O}async function Tr(e){return O&&O.name===`${Xe}${e}`?Promise.resolve(O):(O&&(O.close(),O=null),new Promise((t,n)=>{const o=indexedDB.open(`${Xe}${e}`,5);o.onupgradeneeded=s=>{const r=s.target.result;r.objectStoreNames.contains(Ze)||r.createObjectStore(Ze,{keyPath:"id"}),r.objectStoreNames.contains(xt)||r.createObjectStore(xt,{keyPath:"id"})},o.onsuccess=s=>{O=s.target.result,console.log(`IndexedDB '${O.name}' opened successfully.`),t(O)},o.onerror=s=>{console.error("IndexedDB error:",s.target.error),n(s.target.error)}}))}async function Xn(e,t,n,o){return new Promise((s,r)=>{if(!O)return console.error("dbRequest called before DB was opened."),r("Database is not open.");try{const l=O.transaction(e,t).objectStore(e)[n](o);l.onsuccess=c=>s(c.target.result||(n==="getAll"?[]:null)),l.onerror=c=>r(c.target.error)}catch(a){console.error(`Error performing dbRequest (${n} on ${e}):`,a),r(a)}})}async function Lr(e){return new Promise((t,n)=>{if(!O)return n("Database is not open.");try{const o=O.transaction(e,"readwrite");o.oncomplete=()=>{console.log(`Stores cleared: ${e.join(", ")}`),t()},o.onerror=s=>n(o.error),e.forEach(s=>{O.objectStoreNames.contains(s)&&o.objectStore(s).clear()})}catch(o){n(o)}})}async function Nr(e){const t=`${Xe}${e}`,n=Qn();return n&&n.name===t&&n.close(),new Promise((o,s)=>{console.log(`[DB] Attempting to delete database: ${t}`);const r=indexedDB.deleteDatabase(t);r.onsuccess=()=>{console.log("[DB] Successfully deleted database."),o()},r.onerror=a=>{console.error("[DB] Error deleting database:",a.target.error),s(a.target.error)},r.onblocked=()=>{console.warn("[DB] Database delete was blocked. Please reload the application."),showCustomAlert("Could not clear old project data because a connection is still open. Please reload the page and try again.","Error"),s("Database blocked")}})}function Zn(e,t){let n;return function(...s){const r=()=>{clearTimeout(n),e(...s)};clearTimeout(n),n=setTimeout(r,t)}}function Pr(e){if(!e)return"N/A";const t=new Date,n=new Date(e),o=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1),r={hour:"2-digit",minute:"2-digit",hour12:!1},a=n.toLocaleTimeString("th-TH",r);if(n>=o)return`Today ${a}`;if(n>=s)return`Yesterday ${a}`;{const i={day:"2-digit",month:"2-digit",year:"numeric"};return`${n.toLocaleDateString("th-TH",i)} ${a}`}}class Ht{constructor(t){if(this.contentDiv=t.querySelector(".message-content .streaming-content"),this.accumulatedMarkdown="",this.isInsideCodeBlock=!1,this.renderTimeout=null,this.debounceDelay=40,this.isFinished=!1,!this.contentDiv)throw new Error("Target content element for rendering not found.")}streamChunk=t=>{this.isFinished||(this.accumulatedMarkdown+=t,clearTimeout(this.renderTimeout),this.renderTimeout=setTimeout(this.render,this.debounceDelay))};render=()=>{if(!this.isFinished)try{if((this.accumulatedMarkdown.match(/```/g)||[]).length%2===1){const n=this.accumulatedMarkdown.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.contentDiv.innerHTML=`<pre class="streaming-code-preview">${n}</pre>`}else this.contentDiv.innerHTML=marked.parse(this.accumulatedMarkdown,{gfm:!0,breaks:!1})}catch{this.contentDiv.textContent=this.accumulatedMarkdown}};getFinalContent(){return this.isFinished=!0,clearTimeout(this.renderTimeout),this.accumulatedMarkdown}}function jt(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}const eo="canon",Gt="draft",to="conflict",no="deprecated",oo="revealed",Be="gated",Ue="book",et="shared",Jt="unassigned",tt="chapter_threshold",nt="manual_unlock",ut="writing",X="author",so="outline",Yt="drafting",ro="revising",ao="done",De="chat",Fe="chapter",Oe="book_agent",io=new Set(["entity","place","rule","event","relationship","note","source"]),lo=new Set([eo,Gt,to,no]),co=new Set([so,Yt,ro,ao]),xe=e=>`${e}_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,K=e=>!!e&&typeof e=="object"&&!Array.isArray(e),me=e=>{if(e==null||typeof e!="object")return e;try{return JSON.parse(JSON.stringify(e))}catch{return Array.isArray(e)?[...e]:{...e}}},te=(e,t)=>Number.isFinite(e)?e:t,Z=(e,t=null)=>{const n=Number(e);if(!Number.isFinite(n))return t;const o=Math.round(n);return o>0?o:t},N=e=>typeof e!="string"?null:e.trim()||null,$=(e,t="")=>typeof e!="string"?t:e,re=e=>Array.isArray(e)?[...new Set(e.filter(t=>typeof t=="string"&&t.trim()))]:[];function Vt(e){if(!K(e))return null;if(e.kind===nt)return{kind:nt,unlocked:e.unlocked===!0||e.value===!0};if(e.kind===tt){const t=Z(e.value,null);return t?{kind:tt,value:t}:null}return null}function uo(){return xe("wld")}function mo(){return xe("wi")}function po(){return xe("book")}function fo(){return xe("wchg")}function go(e={}){const t=Date.now(),n=Vt(e?.revealGate),o=n?Be:oo,s=e?.visibility===Be?Be:o,r=N(e?.subtype),a=N(e?.thumbnailUrl??e?.imageUrl??e?.portraitUrl);return{id:N(e?.id)||mo(),type:io.has(e?.type)?e.type:"note",subtype:r?r.toLowerCase():null,title:$(e?.title,"Untitled"),summary:$(e?.summary,""),aliases:re(e?.aliases),thumbnailUrl:a,content:me(e?.content??""),status:lo.has(e?.status)?e.status:Gt,visibility:s,revealGate:n,tags:re(e?.tags),sourceRefs:re(e?.sourceRefs),createdBy:e?.createdBy==="agent"?"agent":"user",updatedBy:e?.updatedBy==="agent"?"agent":"user",approvedAt:Number.isFinite(e?.approvedAt)?e.approvedAt:null,createdAt:te(e?.createdAt,t),updatedAt:te(e?.updatedAt,t),version:Z(e?.version,1)}}function ho(e={}){const t=Date.now(),n=Array.isArray(e?.items)?e.items.map(go):[],o=N(e?.ownerBookId),s=re(e?.sharedBookIds),r=String(e?.scope||"").trim().toLowerCase(),a=r===et?et:r===Ue?Ue:Jt;return{id:N(e?.id)||uo(),name:$(e?.name,"New World"),description:$(e?.description,""),scope:a,ownerBookId:o,sharedBookIds:s,version:Z(e?.version,1),createdAt:te(e?.createdAt,t),updatedAt:te(e?.updatedAt,t),items:n}}function yo(e){switch(e){case"approved":case"rejected":case"edited":return e;default:return"pending"}}function bo(e){return Array.isArray(e)?e.filter(Boolean).map(t=>me(t)).filter(Boolean):[]}function So(e={}){const t=Date.now();return{id:N(e?.id)||fo(),worldId:N(e?.worldId),bookId:N(e?.bookId),chapterSessionId:N(e?.chapterSessionId),proposalType:$(e?.proposalType,"edit_item"),targetItemId:N(e?.targetItemId),beforePayload:me(e?.beforePayload??null),afterPayload:me(e?.afterPayload??null),reason:$(e?.reason,""),evidenceRefs:bo(e?.evidenceRefs),status:yo(e?.status),createdByAgentId:N(e?.createdByAgentId),reviewedBy:N(e?.reviewedBy),reviewedAt:Number.isFinite(e?.reviewedAt)?e.reviewedAt:null,createdAt:te(e?.createdAt,t),updatedAt:te(e?.updatedAt,t)}}function vo(e={},t=0){return{id:N(e?.id)||xe("act"),title:$(e?.title,`Act ${t+1}`),order:Z(e?.order,t+1),summary:$(e?.summary,"")}}function Eo(e={},t="New Book"){const n=K(e)?e:{},o=String(n.chapterTitleMode||"").trim().toLowerCase(),s=o==="title_only"?"title_only":"number_and_title",r=String(n.sceneBreakMarker||"").trim();return{title:$(n.title,$(t,"New Book")),subtitle:$(n.subtitle,""),author:$(n.author,""),chapterTitleMode:s,includeChapterSummaries:n.includeChapterSummaries===!0,sceneBreakMarker:r||"***",frontMatterNotes:$(n.frontMatterNotes,"")}}function Co(e={}){const t=K(e)?e:{},n=K(t.worldProposals)?t.worldProposals:{},o=Number(n.lastScannedMessageCount),s=Number.isFinite(o)?Math.max(0,Math.round(o)):0;return{worldProposals:{autoProposeEnabled:n.autoProposeEnabled===!0,lastScannedMessageCount:s,lastScannedAt:Number.isFinite(n.lastScannedAt)?n.lastScannedAt:null}}}function Qt(e={},{defaults:t={}}={}){const n=K(e)?e:{};return{agentPresetName:N(n.agentPresetName??n.agentName)||null,systemPromptOverride:$(n.systemPromptOverride,$(t.systemPromptOverride,""))}}function Io(e={}){const t=K(e)?e:{};return{...Qt(t,{defaults:{systemPromptOverride:""}}),useBookAgent:t.useBookAgent!==!1}}function ko(e={},t={}){const n=Date.now(),o=t?.validWorldIds instanceof Set?t.validWorldIds:null,s=N(e?.linkedWorldId??e?.worldId),r=s&&(!o||o.has(s))?s:null,a=K(e?.structure)?e.structure:{},i=Array.isArray(a.acts)?a.acts.map((y,S)=>vo(y,S)):[],l=re(a.chapterSessionIds||e?.chapterSessionIds||[]),c=K(e?.composerDocs)?e.composerDocs:{},m={treatment:$(c.treatment,""),synopsis:$(c.synopsis,""),outline:$(c.outline,""),sceneBeats:$(c.sceneBeats,"")},f=N(e?.bookAgentSessionId),d=Eo(e?.exportProfile,e?.name),b=Co(e?.agentAutomation),g=Qt(e?.bookAgentConfig),h=Io(e?.codexAgentConfig),p=K(e?.chapterStructureDefaults)?me(e.chapterStructureDefaults):{};return{id:N(e?.id)||po(),name:$(e?.name,"New Book"),description:$(e?.description,""),linkedWorldId:r,bookAgentSessionId:f,createdAt:te(e?.createdAt,n),updatedAt:te(e?.updatedAt,n),autoNumberChapters:e?.autoNumberChapters!==!1,constraints:K(e?.constraints)?me(e.constraints):{},composerDocs:m,exportProfile:d,bookAgentConfig:g,codexAgentConfig:h,chapterStructureDefaults:p,agentAutomation:b,structure:{acts:i,chapterSessionIds:l}}}function Xt(e){if(!e||typeof e!="object")return;e.worlds=Array.isArray(e.worlds)?e.worlds.map(ho):[];const t=new Set(e.worlds.map(o=>o.id)),n=N(e.activeWorldId);e.activeWorldId=n&&t.has(n)?n:e.worlds[0]?.id||null}function wo(e){if(!e||typeof e!="object")return;const t=Array.isArray(e.worlds)?e.worlds:[],n=Array.isArray(e.books)?e.books:[],o=new Set(n.map(r=>N(r?.id)).filter(Boolean)),s=new Map;n.forEach(r=>{const a=N(r?.id),i=N(r?.linkedWorldId);if(!a||!i)return;s.has(i)||s.set(i,[]);const l=s.get(i);l.includes(a)||l.push(a)}),t.forEach(r=>{const a=re(s.get(r.id)||[]);let i=N(r?.ownerBookId);i&&!o.has(i)&&(i=null);let l=re(r?.sharedBookIds).filter(m=>o.has(m));if(a.forEach(m=>{l.includes(m)||l.push(m)}),a.length===0){l=[],r.scope=i?Ue:Jt,r.ownerBookId=i,r.sharedBookIds=l;return}if(a.length===1){const m=a[0];r.ownerBookId=i||m,r.sharedBookIds=[r.ownerBookId],r.scope=Ue;return}const c=i&&a.includes(i)?i:a[0];r.ownerBookId=c||null,r.sharedBookIds=a,r.scope=et})}function _r(e){!e||typeof e!="object"||(e.worldChanges=Array.isArray(e.worldChanges)?e.worldChanges.map(So):[])}function Zt(e){if(!e||typeof e!="object")return;const t=new Set((e.worlds||[]).map(s=>s.id));e.books=Array.isArray(e.books)?e.books.map(s=>ko(s,{validWorldIds:t})):[];const n=new Set(e.books.map(s=>s.id)),o=N(e.activeBookId);e.activeBookId=o&&n.has(o)?o:e.books[0]?.id||null,wo(e)}function xo(e){return co.has(e)?e:Yt}function $r(e={},t={}){const n=t?.validBookIds instanceof Set?t.validBookIds:null,o=N(e?.bookId),s=o&&(!n||n.has(o))?o:null,r=Z(e?.actNumber,null),a=Z(e?.chapterNumber,null),i=K(e?.revealScope)?e.revealScope:{},l=a||null,c=Z(i.asOfChapter??e?.asOfChapter,l);return{bookId:s,actNumber:r,chapterNumber:a,chapterTitle:$(e?.chapterTitle,""),chapterSummary:$(e?.chapterSummary,""),chapterStatus:xo(e?.chapterStatus),revealScope:{asOfChapter:c},writingMode:e?.writingMode===X?X:ut}}function mt(e={}){const t=String(e?.kind||"").trim().toLowerCase();return t===Fe?Fe:t===Oe?Oe:t===De?De:N(e?.bookAgentBookId)?Oe:e?.bookId?Fe:De}function Br(e={}){return mt(e)===Fe}function en(e={}){return mt(e)===Oe}function ot(e={}){return mt(e)===De}function Ao(e={},t={}){const n=typeof t?.fallback=="string"&&t.fallback?t.fallback:"New Chat";if(!e||typeof e!="object")return n;const o=!!e.bookId,s=Number.isFinite(Number(e?.actNumber))?Math.round(Number(e.actNumber)):null,r=Number.isFinite(Number(e?.chapterNumber))?Math.round(Number(e.chapterNumber)):null,a=String(e?.chapterTitle||"").trim(),i=t?.includeAct===!0;if(!o)return String(e?.name||"").trim()||n;let l="";if(r&&a?l=`Chapter ${r}: ${a}`:r?l=`Chapter ${r}`:a?l=`Chapter: ${a}`:s?l=`Act ${s} Chapter`:l="Chapter",i&&s){const c=`Act ${s}`;if(!l.toLowerCase().startsWith(c.toLowerCase()))return`${c} â€¢ ${l}`}return l}function Mo(e,t={}){if(!e)return!1;if((t?.mode===X?X:ut)===X)return!0;const o=Vt(e?.revealGate);if(!o)return e?.visibility!==Be;if(o.kind===nt)return o.unlocked===!0;if(o.kind===tt){const s=Z(t?.asOfChapter??t?.revealScope?.asOfChapter,null);return s?s>=o.value:!1}return!1}let pe=null,fe=null;const st=new Set;let tn=0;function To(){const e=document.getElementById("chat-title");if(!e)return null;let t=document.getElementById("book-agent-header-badge");return t||(t=document.createElement("button"),t.type="button",t.id="book-agent-header-badge",t.className="book-agent-header-badge hidden",t.title="Open Book > Changes",t.setAttribute("aria-label","Open Book Changes"),t.addEventListener("click",()=>{const n=String(t.dataset.bookId||"").trim();n&&u.bus.publish("book:openWorkspace",{bookId:n,tab:"changes"})}),e.insertAdjacentElement("afterend",t),t)}function Lo(){const e=u.getProject();if(!e)return null;const t=(e.chatSessions||[]).find(c=>c?.id===e.activeSessionId);if(!t||!en(t))return null;const n=(e.books||[]).find(c=>c?.id===t.bookAgentBookId||c?.bookAgentSessionId===t.id);if(!n)return null;const o=(e.worldChanges||[]).filter(c=>c?.bookId===n.id&&String(c.status||"pending")==="pending").length,s=Number(e?.worldUiState?.bookChanges?.lastViewedAtByBookId?.[n.id]),r=Number.isFinite(s)&&s>0?Math.round(s):0,a=(e.worldChanges||[]).filter(c=>c?.bookId===n.id&&String(c.status||"pending")==="pending"&&Number(c?.createdAt)>r).length,i=n?.agentAutomation?.worldProposals?.autoProposeEnabled===!0,l=Number.isFinite(Number(n?.agentAutomation?.worldProposals?.lastScannedMessageCount))?Math.max(0,Math.round(Number(n.agentAutomation.worldProposals.lastScannedMessageCount))):0;return{bookId:n.id,bookName:n.name||"Book",pendingChanges:o,newPendingChanges:a,autoEnabled:i,cursor:l}}function Q(){const e=To();if(!e)return;const t=Lo();if(!t){e.classList.add("hidden"),e.textContent="",e.dataset.bookId="",e.classList.remove("has-pending","is-auto-on","is-flash");return}e.dataset.bookId=t.bookId,e.classList.remove("hidden"),e.classList.toggle("has-pending",t.pendingChanges>0),e.classList.toggle("has-new",t.newPendingChanges>0),e.classList.toggle("is-auto-on",t.autoEnabled);const n=t.newPendingChanges>0?` â€¢ ${t.newPendingChanges} new`:"";e.textContent=`Book Agent â€¢ ${t.autoEnabled?"Auto On":"Auto Off"} â€¢ ${t.pendingChanges} pending${n}`,e.title=`${t.bookName} â€¢ Open Book > Changes â€¢ ${t.newPendingChanges} new pending â€¢ Scan cursor ${t.cursor}`,Date.now()-tn<3e3?e.classList.add("is-flash"):e.classList.remove("is-flash")}function No(e){e.querySelectorAll("pre > code").forEach(t=>{if(t.dataset.enhanced==="true")return;const n=t.parentNode,o=document.createElement("div");o.className="code-block-wrapper",n.parentNode.replaceChild(o,n);const s=document.createElement("div");s.className="code-block-header";const r=Array.from(t.classList).find(f=>f.startsWith("language-")),a=r?r.replace("language-",""):"text",i=String(a||"").trim().toLowerCase(),l=["text","plain","plaintext","txt"].includes(i);o.dataset.language=i||"text",l&&(o.classList.add("is-plain-text"),n.classList.add("is-plain-text-pre"));const c=document.createElement("span");c.className="language-name",c.textContent=a,s.appendChild(c);const m=document.createElement("button");m.className="copy-code-btn",m.innerHTML='<span class="material-symbols-outlined">content_copy</span> Copy',s.appendChild(m),m.addEventListener("click",()=>{navigator.clipboard.writeText(t.textContent).then(()=>{m.innerHTML='<span class="material-symbols-outlined">check</span> Copied!',setTimeout(()=>{m.innerHTML='<span class="material-symbols-outlined">content_copy</span> Copy'},2e3)})}),o.appendChild(s),o.appendChild(n),window.hljs&&!l&&hljs.highlightElement(t),t.dataset.enhanced="true"})}function Po(e){e&&(No(e),e.querySelectorAll("a[href]").forEach(t=>{(t.getAttribute("href")||"").startsWith("#")||(t.setAttribute("target","_blank"),t.setAttribute("rel","noopener noreferrer"))}),e.querySelectorAll("table").forEach(t=>{if(t.closest(".message-table-wrapper"))return;const n=document.createElement("div");n.className="message-table-wrapper",t.parentNode.insertBefore(n,t),n.appendChild(t)}))}function _o(e){return typeof e=="string"?e:Array.isArray(e)?e.filter(t=>t?.type==="text"&&typeof t.text=="string").map(t=>t.text).join(`
`):""}function $o(e,t){const n=_o(e),o=Array.isArray(e)&&e.some(l=>l?.type==="image_url"&&l.url),s=n?n.split(/\r?\n/).length:0,r=n.trim().length,a=!o&&(r>320||s>6),i=a&&!st.has(String(t));return{plainText:n,hasMedia:o,lineCount:s,isCollapsible:a,isCollapsed:i}}function At(e){if(!e)return"";const t=new Date,n=new Date(e),o=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1);return n>=o?n.toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit",hour12:!1}):n>=s?"Yesterday":n.toLocaleDateString("th-TH",{day:"2-digit",month:"2-digit",year:"numeric"})}function nn(e){return typeof e=="string"?e:Array.isArray(e)?e.map(t=>t?.type==="text"?t.text||"":t?.type==="image_url"?"[image]":"").filter(Boolean).join(`
`):e&&typeof e=="object"&&typeof e.text=="string"?e.text:""}function Bo(e,t){if(t?.groupChatState?.isRunning&&t?.groupChatState?.currentJob?.agentName)return t.groupChatState.currentJob.agentName;const n=e?.activeEntity;if(n?.type==="agent"&&n.name)return n.name;if(n?.type==="group"&&n.name){const o=e.agentGroups?.[n.name];if(o?.moderatorAgent)return o.moderatorAgent}if(t?.linkedEntity?.type==="agent"&&t?.linkedEntity?.name)return t.linkedEntity.name;if(t?.linkedEntity?.type==="group"&&t?.linkedEntity?.name){const o=e.agentGroups?.[t.linkedEntity.name];if(o?.moderatorAgent)return o.moderatorAgent}return Object.keys(e?.agentPresets||{})[0]||""}function on(){const e=u.getProject();if(!e)return null;const t=(e.chatSessions||[]).find(c=>c.id===e.activeSessionId);if(!t)return null;const n=t.folderId&&(e.chatFolders||[]).find(c=>c.id===t.folderId)||null,o=Bo(e,t),s={__collect:!0},r=It(t.history||[],o,s),a=j(JSON.stringify(r||[])),i=gt(),l=(t.history||[]).map((c,m)=>{const f=nn(c?.content||"");return{index:m,role:c?.role||"unknown",speaker:c?.speaker||"",timestamp:c?.timestamp||null,text:f,tokenEstimate:j(f||JSON.stringify(c?.content||"")),hasRag:!!c?.rag,hasFolderContext:!!c?.folderContext,hasWorldContext:!!c?.worldContext,rag:c?.rag||null,folderContext:c?.folderContext||null,worldContext:c?.worldContext||null}});return{generatedAt:Date.now(),project:e,session:t,folder:n,payloadMessages:r,payloadMeta:s,payloadTokenEstimate:a,contextData:i,turns:l}}function k(e){return Number.isFinite(e)?e.toLocaleString():"-"}function Do(e){const t=document.getElementById("context-debugger-session-name"),n=document.getElementById("context-debugger-folder-mode"),o=document.getElementById("context-debugger-folder-budget"),s=document.getElementById("context-debugger-rag-budget"),r=document.getElementById("context-debugger-world-budget"),a=document.getElementById("context-debugger-payload-meta");if(!t||!n||!o||!s||!r||!a)return;const i=e.session?.contextMode==="session_only"?"Session only":"Folder aware",l=e.folder?.name||"Main list",c=e.payloadMeta?.folderContext||null,m=e.payloadMeta?.rag||null,f=e.payloadMeta?.worldContext||null;if(t.textContent=e.session?.name||"Untitled",n.textContent=`${i} â€¢ ${l}`,c?c.enabled===!1?o.textContent=`Disabled â€¢ ${dn(c.reason)}`:o.textContent=`${k(c.usedTokens)} / ${k(c.budgetTokens)} tokens â€¢ ${k(c.usedSessionCount)}/${k(c.maxSharedSessions)} sessions`:o.textContent="No folder context",m)if(m.enabled===!1)s.textContent=`Disabled â€¢ ${cn(m.reason)}`;else{const d=m.settings||{};s.textContent=`${k(m.totalUsedTokens)} / ${k(d.maxContextTokens)} tokens â€¢ ${k(m.usedChunks?.length||0)}/${k(m.totalCandidateChunks)} chunks`}else s.textContent="No RAG metadata";if(f){const d=f.diagnostics||{};if(f.enabled===!1)r.textContent=`Disabled â€¢ ${rt(f.reason)}`;else{const b=Number.isFinite(d.selectedItemCount)?d.selectedItemCount:f.selectedItems?.length||0,g=Number.isFinite(d.visibleItemCount)?d.visibleItemCount:f.selectedItems?.length||0,h=Number.isFinite(d.hiddenItemCount)?d.hiddenItemCount:0,p=d.mode||f.access?.mode||"writing",y=Number.isFinite(d.asOfChapter)?d.asOfChapter:Number.isFinite(f.access?.asOfChapter)?f.access.asOfChapter:null;r.textContent=`${k(b)}/${k(g)} items â€¢ ${k(h)} gated out â€¢ ${p}${y?` â€¢ as-of ch${y}`:""}`}}else r.textContent="No World metadata";a.textContent=`${k(e.payloadMessages?.length||0)} messages â€¢ ~${k(e.payloadTokenEstimate)} tokens`}function Fo(e){const t=document.getElementById("context-debugger-turn-list");if(t){if(t.innerHTML="",!Array.isArray(e.turns)||e.turns.length===0){t.innerHTML='<p class="no-items-message">No turns in this session.</p>';return}e.turns.forEach(n=>{const o=document.createElement("div");o.className="context-debugger-turn-item",n.index===fe&&o.classList.add("active"),o.dataset.turnIndex=String(n.index);const s=n.role==="assistant"?n.speaker?`assistant â€¢ ${n.speaker}`:"assistant":n.role,r=(n.text||"(no text)").replace(/\s+/g," ").slice(0,120),a=[n.hasFolderContext?"folder-context":"",n.hasRag?"rag":"",n.hasWorldContext?"world-context":""].filter(Boolean).join(", ");o.innerHTML=`
            <div class="context-debugger-turn-item-role">#${n.index+1} â€¢ ${s}</div>
            <div class="context-debugger-turn-item-title">${r}</div>
            <div class="context-debugger-turn-item-meta">~${k(n.tokenEstimate)} tokens${a?` â€¢ ${a}`:""}</div>
        `,t.appendChild(o)})}}function Oo(e){const t=document.getElementById("context-debugger-turn-detail"),n=document.getElementById("context-debugger-assembly");if(!t||!n)return;const o=e.turns.find(r=>r.index===fe)||null;if(!o)t.innerHTML='<p class="context-debugger-empty">Select a turn to inspect detail.</p>';else{const r=[`Turn #${o.index+1}`,`Role: ${o.role}${o.speaker?` (${o.speaker})`:""}`,`Timestamp: ${o.timestamp?new Date(o.timestamp).toLocaleString("th-TH"):"-"}`,`Approx tokens: ${k(o.tokenEstimate)}`,""];if(o.folderContext&&(r.push("Folder Context (turn metadata):"),r.push(`- Reason: ${o.folderContext.reason||"-"}`),r.push(`- Budget: ${k(o.folderContext.usedTokens)} / ${k(o.folderContext.budgetTokens)} tokens`),r.push(`- Sessions: ${k(o.folderContext.usedSessionCount)} / ${k(o.folderContext.maxSharedSessions)}`),r.push("")),o.rag){const i=o.rag.settings||{};r.push("RAG (turn metadata):"),r.push(`- Source: ${i.scopeSource||"-"}`),r.push(`- Scope: ${i.scopeMode||"-"}`),r.push(`- Reason: ${o.rag.reason||"-"}`),r.push(`- Budget: ${k(o.rag.totalUsedTokens)} / ${k(i.maxContextTokens)} tokens`),r.push(`- Chunks: ${k(o.rag.usedChunks?.length||0)} / ${k(o.rag.totalCandidateChunks)}`),Array.isArray(o.rag.usedChunks)&&o.rag.usedChunks.length>0&&(r.push("- Selected chunks:"),o.rag.usedChunks.forEach((l,c)=>{r.push(`  ${c+1}. ${l.fileName||"Unknown"} #chunk${Number.isFinite(l.chunkIndex)?l.chunkIndex+1:1} â€¢ score ${l.score||0}`)})),r.push("")}if(o.worldContext){const i=o.worldContext,l=i.diagnostics||{};r.push("World Context (turn metadata):"),r.push(`- Reason: ${rt(i.reason||"")}`),r.push(`- World: ${l.worldName||i.world?.name||"-"}`),r.push(`- Book: ${l.bookName||i.book?.name||"-"}`),r.push(`- Mode: ${l.mode||i.access?.mode||"-"}`),r.push(`- As-of chapter: ${k(Number(l.asOfChapter??i.access?.asOfChapter))}`),r.push(`- Visible/Total: ${k(Number(l.visibleItemCount))} / ${k(Number(l.totalItemCount))}`),r.push(`- Selected items: ${k(Number(l.selectedItemCount))} (gated excluded: ${k(Number(l.hiddenItemCount))})`),Array.isArray(i.selectedItems)&&i.selectedItems.length>0&&(r.push("- Selected world items:"),i.selectedItems.forEach((c,m)=>{r.push(`  ${m+1}. [${c.type||"item"}] ${c.title||c.id||"Untitled"}`)})),r.push("")}r.push("Turn content:"),r.push(o.text||"(no text)"),t.innerHTML="";const a=document.createElement("pre");a.textContent=r.join(`
`),t.appendChild(a)}const s=[];if(s.push(`Generated at: ${new Date(e.generatedAt).toLocaleString("th-TH")}`),s.push(`Agent: ${e.contextData?.agentNameForDisplay||"-"}`),s.push(`Model: ${e.contextData?.model||"-"}`),s.push(`System prompt tokens (approx): ${k(j(e.contextData?.finalSystemPrompt||""))}`),s.push(`Payload messages: ${k(e.payloadMessages?.length||0)} (~${k(e.payloadTokenEstimate)} tokens)`),s.push(""),e.payloadMeta?.folderContext){const r=e.payloadMeta.folderContext;s.push("Folder Context (current assembly):"),s.push(`- Reason: ${r.reason||"-"}`),s.push(`- Folder: ${r.folderName||"-"}`),s.push(`- Budget: ${k(r.usedTokens)} / ${k(r.budgetTokens)} tokens`),s.push(`- Sessions: ${k(r.usedSessionCount)} / ${k(r.maxSharedSessions)}`),Array.isArray(r.usedSessions)&&r.usedSessions.length>0&&r.usedSessions.forEach((a,i)=>{const l=Number.isFinite(Number(a.relevanceScore))?` â€¢ rel ${Number(a.relevanceScore).toFixed(3)}`:"";s.push(`  ${i+1}. ${a.sessionName||a.sessionId||"-"} â€¢ ${a.source||"-"}${l} â€¢ ~${k(a.tokenEstimate)} tokens`)}),s.push("")}if(e.payloadMeta?.rag){const r=e.payloadMeta.rag,a=r.settings||{};s.push("RAG (current assembly):"),s.push(`- Source: ${a.scopeSource||"-"}`),s.push(`- Scope: ${a.scopeMode||"-"}`),s.push(`- Reason: ${r.reason||"-"}`),s.push(`- Budget: ${k(r.totalUsedTokens)} / ${k(a.maxContextTokens)} tokens`),s.push(`- Chunks: ${k(r.usedChunks?.length||0)} / ${k(r.totalCandidateChunks)}`),Array.isArray(r.usedChunks)&&r.usedChunks.length>0&&r.usedChunks.forEach((i,l)=>{s.push(`  ${l+1}. ${i.fileName||"Unknown"} #chunk${Number.isFinite(i.chunkIndex)?i.chunkIndex+1:1} â€¢ score ${i.score||0}`)}),s.push("")}if(e.payloadMeta?.worldContext){const r=e.payloadMeta.worldContext,a=r.diagnostics||{};s.push("World Context (current assembly):"),s.push(`- Reason: ${rt(r.reason||"")}`),s.push(`- Enabled: ${r.enabled===!1?"no":"yes"}`),s.push(`- World: ${a.worldName||r.world?.name||"-"}`),s.push(`- Book: ${a.bookName||r.book?.name||"-"}`),s.push(`- Mode: ${a.mode||r.access?.mode||"-"}`),s.push(`- As-of chapter: ${k(Number(a.asOfChapter??r.access?.asOfChapter))}`),s.push(`- Visible/Total: ${k(Number(a.visibleItemCount))} / ${k(Number(a.totalItemCount))}`),s.push(`- Selected/Max: ${k(Number(a.selectedItemCount))} / ${k(Number(a.maxItems))}`),s.push(`- Gated excluded: ${k(Number(a.hiddenItemCount))}`),Array.isArray(r.selectedItems)&&r.selectedItems.length>0&&r.selectedItems.forEach((i,l)=>{const c=typeof i.summary=="string"&&i.summary.trim()?` â€¢ ${i.summary.trim().slice(0,90)}`:"";s.push(`  ${l+1}. [${i.type||"item"}] ${i.title||i.id||"Untitled"}${c}`)}),s.push("")}s.push("Payload roles:"),(e.payloadMessages||[]).forEach((r,a)=>{const i=nn(r.content||""),l=r.name?`${r.role} (${r.name})`:r.role;s.push(`- [${a+1}] ${l} â€¢ ~${k(j(i||JSON.stringify(r.content||"")))} tokens`)}),n.textContent=s.join(`
`)}function pt(e){if(!e){const t=document.getElementById("context-debugger-session-name"),n=document.getElementById("context-debugger-folder-mode"),o=document.getElementById("context-debugger-folder-budget"),s=document.getElementById("context-debugger-rag-budget"),r=document.getElementById("context-debugger-world-budget"),a=document.getElementById("context-debugger-payload-meta"),i=document.getElementById("context-debugger-turn-list"),l=document.getElementById("context-debugger-turn-detail"),c=document.getElementById("context-debugger-assembly");t&&(t.textContent="-"),n&&(n.textContent="-"),o&&(o.textContent="-"),s&&(s.textContent="-"),r&&(r.textContent="-"),a&&(a.textContent="-"),i&&(i.innerHTML='<p class="no-items-message">No active session.</p>'),l&&(l.innerHTML='<p class="context-debugger-empty">No active session.</p>'),c&&(c.textContent="No active session.");return}Number.isFinite(fe)||(fe=e.turns.length>0?e.turns.length-1:null),Do(e),Fo(e),Oo(e)}function sn(){const e=document.getElementById("context-debugger-page");return!!(e&&!e.classList.contains("hidden"))}function rn(e){const t=document.getElementById("context-debugger-page"),n=document.getElementById("content-columns-wrapper"),o=document.getElementById("status-panel");!t||!n||!o||(t.classList.toggle("hidden",!e),n.classList.toggle("hidden",e),o.classList.toggle("hidden",e))}function an(){document.getElementById("context-debugger-page")&&(pe=on(),fe=null,pt(pe),rn(!0))}function Mt(){rn(!1)}function ln(){sn()&&(pe=on(),pt(pe))}function cn(e=""){switch(e){case"ok":return"Retrieved context successfully.";case"empty_query":return"No suitable query text was found in recent history.";case"no_index":return"Knowledge index is empty.";case"scope_has_no_chunks":return"Current session scope has no indexed chunks.";case"no_similarity_match":return"No chunk matched the query similarity threshold.";case"budget_limited":return"Context budget prevented any chunk from being included.";case"folder_rag_disabled":return"Folder auto RAG is disabled in Folder Settings.";default:return e||"No retrieval diagnostics available."}}function dn(e=""){switch(e){case"ok":return"shared context included";case"session_only":return"session-only mode";case"no_active_session":return"no active session";case"no_folder":return"session has no folder";case"missing_folder":return"folder not found";case"no_related_sessions":return"no related sessions";case"no_context_snippets":return"no usable snippets";case"budget_limited":return"budget limited";case"folder_auto_disabled":return"auto shared context disabled in folder settings";default:return e||"not available"}}function rt(e=""){switch(e){case"ok":return"world context included";case"no_world":return"no linked world";case"no_visible_items":return"no visible items matched current reveal scope/query";default:return e||"not available"}}function Uo(){const e=document.getElementById("studio-panel"),t=document.getElementById("right-sidebar-overlay"),n=document.querySelector(".app-wrapper");if(!e)return;window.innerWidth<=900?(e.classList.add("open"),t?.classList.add("active"),document.body.style.overflow="hidden"):(e.classList.remove("collapsed"),n?.classList.remove("with-right-collapsed"),n?.classList.remove("right-sidebar-collapsed"))}function Ro(e,t=null){if((!e||typeof e!="object")&&!t)return null;const n=e&&typeof e=="object"?e:{},o=Array.isArray(n.usedChunks)?n.usedChunks:[],s=document.createElement("div");s.className="rag-debug-panel hidden";const r=document.createElement("div");r.className="rag-debug-summary";const a=n.queryText?`"${n.queryText}"`:"N/A",i=n.settings?.scopeMode||n.scopeMode||"all",l=n.settings?.retrievalTopK||0,c=n.settings?.maxContextTokens||0,m=n.settings?.scopeSource||"session",f=o.length,d=Number.isFinite(n.totalCandidateChunks)?n.totalCandidateChunks:0,b=Number.isFinite(n.totalUsedTokens)?n.totalUsedTokens:0;r.textContent=`Query: ${a} | Source: ${m} | Scope: ${i} | Top-K: ${l} | Budget: ${c} | Used: ${f}/${d} chunks (${b} tokens)`;const g=document.createElement("div");if(g.className="rag-debug-reason",g.textContent=cn(n.reason),s.append(r,g),t&&typeof t=="object"){const S=document.createElement("div");S.className="rag-debug-reason";const v=t.folderName||"N/A",I=Number.isFinite(t.usedSessionCount)?t.usedSessionCount:0,x=Number.isFinite(t.candidateCount)?t.candidateCount:0,A=Number.isFinite(t.budgetTokens)?t.budgetTokens:0,L=Number.isFinite(t.usedTokens)?t.usedTokens:0;S.textContent=`Folder context: ${v} | Sessions: ${I}/${x} | Budget: ${L}/${A} tokens (${dn(t.reason)})`,s.appendChild(S)}if(o.length>0){const S=document.createElement("div");S.className="rag-debug-list",o.forEach((v,I)=>{const x=document.createElement("div");x.className="rag-debug-item";const A=v.fileName||"Unknown file",L=Number.isFinite(v.chunkIndex)?v.chunkIndex+1:1,D=Number.isFinite(v.score)?v.score.toFixed(3):"0.000",P=document.createElement("div");P.className="rag-debug-item-title",P.textContent=`[${I+1}] ${A} #chunk${L} â€¢ score ${D}`;const H=document.createElement("div");H.className="rag-debug-item-excerpt",H.textContent=v.excerpt||"",x.append(P,H),S.appendChild(x)}),s.appendChild(S)}if(o.length===0)return{sourceStrip:null,debugPanel:s};const h=document.createElement("div");h.className="rag-source-strip";const p=document.createElement("span");p.className="rag-source-title",p.textContent="Sources:",h.appendChild(p);const y=new Set;return o.forEach(S=>{const v=S.fileName||"Unknown file",I=Number.isFinite(S.chunkIndex)?S.chunkIndex+1:1,x=Number.isFinite(S.chunkIndex)?S.chunkIndex:0,A=`${v} #chunk${I}`,L=`${S.fileId||v}::${x}`;if(y.has(L))return;y.add(L);const D=document.createElement("button");D.type="button",D.className="rag-source-chip",D.textContent=A,D.title="Open source chunk in Knowledge Files",D.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),Uo(),u.bus.publish("knowledge:focusChunk",{fileId:S.fileId||"",fileName:v,chunkIndex:Number.isFinite(S.chunkIndex)?S.chunkIndex:0})}),h.appendChild(D)}),{sourceStrip:h,debugPanel:s}}function un(e,t,n){const{role:o,content:s,speaker:r,isLoading:a,isError:i,isSummary:l}=e,c=u.getProject(),m=document.createElement("div");m.className=`message-turn-wrapper ${o}-turn`,m.dataset.index=t,m.dataset.messageId=e.id||`msg_idx_${t}`;const f=o==="user"?$o(s,m.dataset.messageId):null,d=document.createElement("div");if(d.className=`message ${o}`,i&&d.classList.add("error"),l&&d.classList.add("system-summary-message"),o==="user"&&f?.isCollapsible&&(d.classList.add("user-collapsible"),f.isCollapsed&&d.classList.add("is-user-collapsed")),o==="assistant"&&r){const b=c.agentPresets?.[r],g=b?b.icon:"ðŸ¤–",h=document.createElement("div");h.className="speaker-label-wrapper";const p=document.createElement("span");if(p.className="speaker-label",p.innerHTML=`${g} ${r}`,e.timestamp){const y=document.createElement("span");y.className="message-timestamp",y.innerHTML=`&nbsp;â€¢ ${At(e.timestamp)}`,p.appendChild(y)}h.appendChild(p),m.appendChild(h)}else if(o==="user"&&e.timestamp){const b=document.createElement("span");b.className="message-timestamp",b.textContent=At(e.timestamp),m.appendChild(b)}if(e.isSummaryMarker||e.isSummary){d.classList.add("summary-marker");const b=document.createElement("span");b.textContent=e.content;const g=document.createElement("div");g.className="summary-marker-actions";const h=document.createElement("button");h.className="btn-icon small",h.title="Edit this Summary",h.innerHTML='<span class="material-symbols-outlined">edit_note</span>';const p=e.summaryLogId||n.summaryState?.activeSummaryId;p&&(h.onclick=()=>u.bus.publish("summary:editFromChat",{logId:p}));const y=document.createElement("button");y.className="btn-icon small danger",y.title="Remove Marker from Chat",y.innerHTML='<span class="material-symbols-outlined">delete</span>',y.onclick=()=>u.bus.publish("chat:clearSummaryContext",{index:t}),g.append(h,y),d.append(b,g)}else if(o==="system"){const b=document.createElement("div");b.className="message-content",b.textContent=e.content,d.appendChild(b);const g=document.createElement("div");g.className="message-actions";const h=document.createElement("button");h.innerHTML='<span class="material-symbols-outlined" style="font-size: 18px;">delete_forever</span>',h.title="Delete",h.onclick=p=>u.bus.publish("chat:deleteMessage",{index:t,event:p}),g.appendChild(h),d.appendChild(g)}else{const b=document.createElement("div");b.className="message-content",d.appendChild(b);let g=null;const h=document.createElement("span");if(h.className="streaming-content",o==="user"&&h.classList.add("user-content-stream"),a)h.innerHTML='<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';else try{if(o==="assistant")h.innerHTML=marked.parse(s||"",{gfm:!0,breaks:!1}),Po(h),g=Ro(e.rag,e.folderContext);else if(o==="user"){if(Array.isArray(s))s.forEach(p=>{if(p.type==="text"&&p.text){const y=document.createElement("p");y.className="user-text-paragraph",y.textContent=p.text,h.appendChild(y)}else if(p.type==="image_url"&&p.url){const y=document.createElement("img");y.src=p.url,y.className="multimodal-image",h.appendChild(y)}});else if(typeof s=="string"){const p=document.createElement("p");p.className="user-text-paragraph",p.textContent=s,h.appendChild(p)}}}catch(p){console.error("Content rendering failed:",p),h.textContent="Error displaying content"}if(b.appendChild(h),!a&&o==="assistant"&&g?.sourceStrip&&d.appendChild(g.sourceStrip),!a&&o==="assistant"&&g?.debugPanel&&d.appendChild(g.debugPanel),a||i){const p=document.createElement("div");p.className="message-actions";const y='style="font-size: 18px;"',S=document.createElement("button");S.innerHTML=`<span class="material-symbols-outlined" ${y}>delete_forever</span>`,S.title="Delete Incomplete Message",S.onclick=v=>u.bus.publish("chat:deleteMessage",{index:t,event:v}),p.appendChild(S),d.appendChild(p)}else if(!a&&!i){const p=document.createElement("div");p.className="message-actions";const y='style="font-size: 18px;"';if(o==="user"&&f?.isCollapsible){const x=document.createElement("button"),A=document.createElement("span");A.className="material-symbols-outlined",A.style.fontSize="18px";const L=()=>{const D=d.classList.contains("is-user-collapsed");A.textContent=D?"unfold_more":"unfold_less",x.title=D?"Expand message":"Collapse message",x.setAttribute("aria-expanded",String(!D)),x.classList.toggle("active",!D)};x.appendChild(A),x.onclick=D=>{D.stopPropagation();const P=m.dataset.messageId,H=!d.classList.contains("is-user-collapsed");d.classList.toggle("is-user-collapsed",H),H?st.delete(String(P)):st.add(String(P)),L()},L(),p.appendChild(x)}const S=document.createElement("button");S.innerHTML=`<span class="material-symbols-outlined" ${y}>edit</span>`,S.title="Edit",S.onclick=x=>u.bus.publish("chat:editMessage",{index:t,event:x}),p.appendChild(S);const v=document.createElement("button");if(v.innerHTML=`<span class="material-symbols-outlined" ${y}>content_copy</span>`,v.title="Copy",v.onclick=x=>u.bus.publish("chat:copyMessage",{index:t,event:x}),p.appendChild(v),o==="assistant"){if(g?.debugPanel){const A=document.createElement("button");A.innerHTML=`<span class="material-symbols-outlined" ${y}>dataset</span>`,A.title="RAG Debug",A.onclick=L=>{L.stopPropagation(),g.debugPanel.classList.toggle("hidden"),A.classList.toggle("active",!g.debugPanel.classList.contains("hidden"))},p.appendChild(A)}const x=document.createElement("button");x.innerHTML=`<span class="material-symbols-outlined" ${y}>refresh</span>`,x.title="Regenerate",x.onclick=A=>u.bus.publish("chat:regenerateMessage",{index:t,event:A}),p.appendChild(x)}const I=document.createElement("button");I.innerHTML=`<span class="material-symbols-outlined" ${y}>delete_forever</span>`,I.title="Delete",I.onclick=x=>u.bus.publish("chat:deleteMessage",{index:t,event:x}),p.appendChild(I),d.appendChild(p)}}return m.appendChild(d),m}function ee(){const e=u.getProject(),t=e.chatSessions.find(o=>o.id===e.activeSessionId);if(!t){console.error("[UI] renderMessages: No active session found!");return}const n=document.getElementById("chatMessages");if(!n){console.error("[UI] renderMessages: Chat container not found!");return}n.innerHTML="",t.history&&t.history.length>0&&t.history.forEach((o,s)=>{const r=un(o,s,t);n.appendChild(r)}),Wo(),ln(),Q()}function Wo(){const e=document.getElementById("chatMessages");e&&(e.scrollTop=e.scrollHeight)}function Dr(){document.getElementById("chatMessages").innerHTML="",mn("AI Assistant"),Q()}function mn(e){document.getElementById("chat-title").textContent=e||"AI Assistant",Q()}function qo(e){const t=document.getElementById("file-preview-container");t.classList.toggle("hidden",!e||e.length===0),t.innerHTML="",!(!e||e.length===0)&&e.forEach((n,o)=>{const s=document.createElement("div");s.className="file-preview-item";let r="";n.type.startsWith("image/")?r=`<img src="${n.data||""}" class="file-preview-thumbnail" alt="${n.name}">`:r='<div class="file-preview-thumbnail file-icon">ðŸ“„</div>',s.innerHTML=`${r}<span class="file-preview-name">${n.name}</span><button class="remove-file-btn" data-action="chat:removeFile" data-index="${o}">&times;</button>`,t.appendChild(s)})}function zo(){document.getElementById("context-inspector-modal").style.display="none"}function Ko(){const e=document.getElementById("chat-actions-container"),t=document.getElementById("chat-actions-btn"),n=document.getElementById("chat-actions-menu");!e||!t||!n||(t.addEventListener("click",o=>{o.stopPropagation(),n.innerHTML="",n.innerHTML=`
            <a href="#" data-action="open-composer"><span class="material-symbols-outlined">edit_square</span> Composer</a>
            <a href="#" data-action="chat:contextDebugger"><span class="material-symbols-outlined">dataset</span> Context Debugger</a>
            <a href="#" data-action="chat:summarize"><span class="material-symbols-outlined">psychology</span> Summarize</a>
            <a href="#" data-action="upload-file"><span class="material-symbols-outlined">attach_file</span> Upload files</a>
            <a href="#" data-action="knowledge:upload"><span class="material-symbols-outlined">library_books</span> Upload to Knowledge</a>
        `;const s=u.getProject(),r=s.chatSessions.find(a=>a.id===s.activeSessionId);r&&r.summaryState?.activeSummaryId&&(n.innerHTML+=`
                <div class="dropdown-divider"></div>
                <a href="#" data-action="chat:clearSummary" class="is-destructive"><span class="material-symbols-outlined">layers_clear</span> Clear Summary Context</a>
            `),e.classList.toggle("open")}),n.addEventListener("click",o=>{const s=o.target.closest("[data-action]");if(s){switch(o.preventDefault(),s.dataset.action){case"open-composer":u.bus.publish("ui:toggleComposer");break;case"chat:summarize":u.bus.publish("chat:summarize");break;case"chat:contextDebugger":an();break;case"upload-file":document.getElementById("file-input")?.click();break;case"knowledge:upload":u.bus.publish("knowledge:upload");break;case"chat:clearSummary":u.bus.publish("chat:clearSummaryContext",{index:-1});break}e.classList.remove("open")}}),document.addEventListener("click",o=>{e.classList.contains("open")&&!e.contains(o.target)&&e.classList.remove("open")}))}function Ce(){const{totalTokens:e,agent:t,agentNameForDisplay:n,model:o}=gt(),s=Re(),r=o&&o!=="N/A"?o:"N/A",a=document.getElementById("model-count-status"),i=document.getElementById("active-agent-status"),l=document.getElementById("token-count-status");if(a&&(a.textContent=`${s.length} Models`),i){const c=`Active: ${t.icon||""} ${n} â€¢ ${r}`;i.textContent!==c&&(i.textContent=c)}l&&(l.textContent=`~${e.toLocaleString()} Tokens`),ue()}function V(e){const t=e?.dataTransfer;if(!t)return!1;const n=Array.from(t.types||[]);return n.includes("Files")||n.includes("application/x-moz-file")}function Ho(){const e=document.getElementById("dropzone-overlay"),t=document.querySelector(".chat-input-wrapper .input-container-seamless");if(!e||!t)return;e.parentElement!==t&&t.appendChild(e);let n=0;const o=()=>{e.classList.add("active")},s=()=>{e.classList.remove("active")},r=()=>{n=0,s()};t.addEventListener("dragenter",a=>{V(a)&&(a.preventDefault(),a.stopPropagation(),n++,n===1&&o())}),t.addEventListener("dragover",a=>{V(a)&&(a.preventDefault(),a.stopPropagation(),a.dataTransfer&&(a.dataTransfer.dropEffect="copy"),e.classList.contains("active")||o())}),t.addEventListener("dragleave",a=>{V(a)&&(a.preventDefault(),a.stopPropagation(),n=Math.max(0,n-1),n===0&&s())}),t.addEventListener("drop",a=>{if(!V(a))return;a.preventDefault(),a.stopPropagation(),r();const i=a.dataTransfer?.files;i&&i.length>0&&u.bus.publish("chat:filesSelected",i)}),window.addEventListener("dragover",a=>{V(a)&&a.preventDefault()}),window.addEventListener("drop",a=>{V(a)&&(a.preventDefault(),t.contains(a.target)||r())})}function Fr(){const e=document.getElementById("chatInput"),t=document.getElementById("file-input"),n=document.getElementById("file-preview-container");if(e){e.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),u.bus.publish("chat:sendMessage"))});const s=Zn(()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px",oe()},500);e.addEventListener("input",s),e.addEventListener("dragover",r=>{V(r)&&r.preventDefault()}),e.addEventListener("drop",r=>{V(r)&&r.preventDefault()})}document.getElementById("sendBtn")?.addEventListener("click",()=>u.bus.publish("chat:sendMessage")),document.getElementById("stopBtn")?.addEventListener("click",()=>u.bus.publish("chat:stopGeneration")),document.getElementById("context-inspector-trigger-btn")?.addEventListener("click",an),document.querySelector("#context-inspector-modal .btn-secondary")?.addEventListener("click",zo),document.getElementById("context-debugger-back-btn")?.addEventListener("click",Mt),document.getElementById("context-debugger-refresh-btn")?.addEventListener("click",ln),document.getElementById("context-debugger-turn-list")?.addEventListener("click",s=>{const r=s.target.closest(".context-debugger-turn-item[data-turn-index]");!r||!pe||(fe=Number(r.dataset.turnIndex),pt(pe))}),document.addEventListener("keydown",s=>{s.key==="Escape"&&sn()&&Mt()}),t&&t.addEventListener("change",s=>{u.bus.publish("chat:filesSelected",s.target.files)}),n&&n.addEventListener("click",s=>{if(s.target.matches(".remove-file-btn")){const r=parseInt(s.target.dataset.index,10);u.bus.publish("chat:removeFile",{index:r})}}),Ko(),u.bus.subscribe("session:loaded",Ce),u.bus.subscribe("session:loaded",Q),u.bus.subscribe("entity:selected",Ce),u.bus.subscribe("user:settingsUpdated",Ce),u.bus.subscribe("user:modelsLoaded",Ce),u.bus.subscribe("world:dataChanged",()=>Q()),u.bus.subscribe("project:stateChanged",()=>Q()),u.bus.subscribe("world:bookAgentAutoProposeResult",({bookId:s,createdCount:r=0}={})=>{const a=u.getProject(),l=a?.chatSessions?.find?.(c=>c?.id===a?.activeSessionId)?.bookAgentBookId||null;!s||!l||l!==s||r<=0||(tn=Date.now(),Q())}),Ce(),Q(),u.bus.subscribe("ui:renderMessages",ee),u.bus.subscribe("ui:renderFilePreviews",({files:s})=>qo(s)),u.bus.subscribe("ui:updateChatTitle",({title:s})=>mn(s)),u.bus.subscribe("ui:toggleLoading",({isLoading:s})=>{document.getElementById("sendBtn")?.classList.toggle("hidden",s),document.getElementById("stopBtn")?.classList.toggle("hidden",!s)}),document.getElementById("agent-selector-bar")?.addEventListener("click",s=>{const r=s.target.closest(".agent-select-btn");r&&u.bus.publish("group:manualSelectAgent",{agentName:r.dataset.agentName})}),u.bus.subscribe("entity:selected",Tt),u.bus.subscribe("ui:renderAgentSelector",Tt),Ho(),console.log("âœ… Chat UI Initialized.")}function Or(){const e=document.getElementById("toggle-right-sidebar-btn"),t=document.getElementById("studio-panel"),n=document.getElementById("right-sidebar-overlay"),o=document.querySelector(".app-wrapper");!e||!t||(e.addEventListener("click",()=>{window.innerWidth<=900?(t.classList.add("open"),n?.classList.add("active"),document.body.style.overflow="hidden"):(t.classList.toggle("collapsed"),o?.classList.toggle("with-right-collapsed",t.classList.contains("collapsed")))}),n?.addEventListener("click",()=>{t.classList.remove("open"),n.classList.remove("active"),document.body.style.overflow=""}),window.addEventListener("resize",()=>{window.innerWidth>900&&(t.classList.remove("open"),n?.classList.remove("active"),document.body.style.overflow="")}))}function jo(e){const t=document.querySelector(`.message-turn-wrapper[data-message-id='${e.id}']`);if(!t){console.warn(`finalizeMessageBubble: Could not find bubble with ID ${e.id}. Forcing a full re-render.`),ee();return}const n=un(e,parseInt(t.dataset.index),null);t.parentNode.replaceChild(n,t)}function Tt(){const e=u.getProject(),t=e.chatSessions.find(r=>r.id===e.activeSessionId),n=document.getElementById("agent-selector-bar");if(!n)return;if(!t||!e.activeEntity||e.activeEntity.type!=="group"){n.classList.add("hidden");return}const o=e.agentGroups[e.activeEntity.name],s=o?.flowType==="manual"&&t.groupChatState?.awaitsUserInput===!0;n.innerHTML="",n.classList.toggle("hidden",!s),s&&(o.agents||[]).filter(a=>a!==o.moderatorAgent).forEach(a=>{const i=e.agentPresets[a],l=document.createElement("button");l.className="agent-select-btn",l.innerHTML=`${i?.icon||"ðŸ¤–"}`,l.title=a,l.dataset.agentName=a,n.appendChild(l)})}async function ft(e,t,n){t.groupChatState={isRunning:!0,awaitsUserInput:!1,turnQueue:[],currentJob:null,error:null},u.bus.publish("ui:toggleLoading",{isLoading:!0}),n.flowType!=="manual"?(Go(t,n),await Jo(e,t,n)):(t.groupChatState.awaitsUserInput=!0,u.bus.publish("ui:renderAgentSelector"),u.bus.publish("status:update",{message:"Please select the next agent to speak.",state:"connected"}),u.bus.publish("ui:toggleLoading",{isLoading:!1}))}function Go(e,t){if(t.flowType==="round-robin"){const n=(t.agents||[]).filter(o=>o!==t.moderatorAgent);for(let o=0;o<(t.maxTurns||1);o++)n.forEach(s=>e.groupChatState.turnQueue.push({type:"agent_turn",agentName:s}))}else t.flowType==="auto-moderator"&&e.groupChatState.turnQueue.push({type:"moderator_turn",agentName:t.moderatorAgent,turnNumber:1})}async function Jo(e,t,n){for(t.groupChatState.isRunning=!0;t.groupChatState.isRunning&&t.groupChatState.turnQueue.length>0;){const o=t.groupChatState.turnQueue.shift();t.groupChatState.currentJob=o;try{await Yo(e,t,n,o)}catch(s){s.name==="AbortError"?console.log("Group chat job aborted."):(console.error("Error in group chat job:",s),t.groupChatState.error=s.message,R(`Group Chat Error: ${s.message}`,"Error")),t.groupChatState.isRunning=!1}finally{t.groupChatState.currentJob=null}}t.groupChatState.isRunning=!1,n.flowType==="manual"?(t.groupChatState.awaitsUserInput=!0,u.bus.publish("ui:renderAgentSelector"),u.bus.publish("status:update",{message:"Please select the next agent.",state:"connected"})):(u.bus.publish("ui:toggleLoading",{isLoading:!1}),u.bus.publish("status:update",{message:"Group chat finished.",state:"connected"}))}async function Yo(e,t,n,o){if(o.type==="agent_turn")await Qo(e,t,o.agentName);else if(o.type==="moderator_turn"){const s=await Vo(e,t,n,o);if(s){t.groupChatState.turnQueue.unshift({type:"agent_turn",agentName:s});const r=n.maxTurns||1;o.turnNumber<r&&t.groupChatState.turnQueue.push({...o,turnNumber:o.turnNumber+1})}}}async function Vo(e,t,n,o){const s=e.agentPresets[o.agentName];if(!s)throw new Error(`Moderator agent '${o.agentName}' not found.`);u.bus.publish("status:update",{message:`Moderator '${o.agentName}' is deciding...`,state:"loading"});const r=t.history.map(m=>`${m.speaker||m.role}: ${m.content}`).join(`
`),i=`Based on the conversation, choose the single best agent to speak next from this list: [${n.agents.filter(m=>m!==n.moderatorAgent).join(", ")}]. Respond with ONLY the agent's name. If no one needs to speak, respond with "DONE".

Conversation:
${r}`,l=await Gn(s,[{role:"user",content:i}]),c=n.agents.find(m=>l.content.includes(m));return c&&(t.history.push({role:"system",content:`[Moderator selected ${c} to speak.]`}),u.bus.publish("ui:renderMessages")),c}async function Qo(e,t,n){const o=e.agentPresets[n];if(!o||!o.model)throw new Error(`Agent '${n}' has no model configured.`);u.bus.publish("status:update",{message:`Thinking as ${n}...`,state:"loading"});const s={id:jt(),role:"assistant",content:"",speaker:n,isLoading:!0};t.history.push(s);const r=t.history.length-1;ee(),await new Promise(m=>setTimeout(m,50));const a=document.querySelector(`.message-turn-wrapper[data-message-id='${s.id}']`);if(!a)throw t.history.pop(),new Error(`Could not find UI placeholder for agent ${n}.`);const i=new Ht(a),l={__collect:!0},c=It(t.history.slice(0,-1),n,l);try{const m=await jn(o,c,i.streamChunk),f=i.getFinalContent(),d={...s,content:f,isLoading:!1,timestamp:Date.now(),rag:l.rag||null,folderContext:l.folderContext||null,worldContext:l.worldContext||null};t.history[r]=d,u.updateAndPersistState()}catch(m){m.name!=="AbortError"?(console.error(`Error during ${n}'s turn:`,m),t.history[r]={...s,content:`Error: ${m.message}`,isLoading:!1,isError:!0}):t.history.splice(r,1),u.updateAndPersistState()}finally{ee()}}let U=[];function Ur(){new TurndownService({headingStyle:"atx",codeBlockStyle:"fenced"});const e=document.getElementById("chatMessages");if(!e)return;const t=d=>{const b=d.closest(".message.assistant");if(!b)return;const g=b.querySelector(".message-content");if(g){const h=g.cloneNode(!0);h.querySelectorAll(".code-block-wrapper").forEach(p=>{const y=p.querySelector("pre");y&&p.parentNode.replaceChild(y,p)}),u.bus.publish("composer:append",{content:h.innerHTML}),b.classList.add("sent-to-composer-feedback"),setTimeout(()=>{b.classList.remove("sent-to-composer-feedback")},500)}};let n=null,o=null,s=null;const r=()=>{s&&(clearTimeout(s),s=null),n&&(n.classList.remove("is-visible"),n.setAttribute("aria-hidden","true")),o=null},a=(d=80)=>{s&&clearTimeout(s),s=setTimeout(()=>{s=null,r()},d)},i=()=>{if(n&&document.body.contains(n))return n;const d=document.createElement("div");return d.className="selection-action-bar",d.setAttribute("aria-hidden","true"),d.innerHTML=`
            <div class="selection-action-bar__label">Selected text</div>
            <select class="selection-action-select" data-selection-item-type aria-label="Codex item type">
                <option value="note" selected>Note</option>
                <option value="entity">Entity</option>
                <option value="place">Place</option>
                <option value="rule">Rule</option>
                <option value="event">Event</option>
            </select>
            <button type="button" class="selection-action-btn" data-selection-action="to-composer">Send to Composer</button>
            <button type="button" class="selection-action-btn" data-selection-action="to-codex-verbatim">Add to Codex</button>
        `,d.addEventListener("mouseenter",()=>{s&&(clearTimeout(s),s=null)}),d.addEventListener("mouseleave",()=>{a(140)}),d.addEventListener("mousedown",b=>{b.target.closest(".selection-action-btn")&&b.preventDefault()}),d.addEventListener("click",b=>{const g=b.target.closest("[data-selection-action]");if(!g||!o?.text)return;const h=o.text,p=g.dataset.selectionAction;if(p==="to-composer"){u.bus.publish("composer:append",{content:h}),r();return}if(p==="to-codex-verbatim"){const y=d.querySelector("[data-selection-item-type]"),S=String(y?.value||"note").trim().toLowerCase()||"note";u.bus.publish("world:addSelectionVerbatim",{text:h,type:S,sourceKind:"chat",sessionId:o.sessionId||null,messageId:o.messageId||null}),r()}}),document.body.appendChild(d),n=d,d},l=()=>{const d=window.getSelection();if(!d||d.rangeCount===0||d.isCollapsed)return null;const b=String(d.toString()||"").trim();if(!b)return null;const g=d.getRangeAt(0),h=g.commonAncestorContainer instanceof Element?g.commonAncestorContainer:g.commonAncestorContainer?.parentElement;if(!h||!e.contains(h))return null;const p=h.closest(".message");if(!p||!e.contains(p))return null;const y=g.getBoundingClientRect();return!y||!y.width&&!y.height?null:{text:b,rect:y,sessionId:u.getProject()?.activeSessionId||null,messageId:p.dataset.messageId||null}},c=d=>{if(!d?.text||!d?.rect){r();return}const b=i();o=d,s&&(clearTimeout(s),s=null),b.classList.add("is-visible"),b.setAttribute("aria-hidden","false");const g=8,h=d.rect,p=b.offsetWidth||260,y=b.offsetHeight||42;let S=h.left+h.width/2-p/2;S=Math.max(10,Math.min(S,window.innerWidth-p-10));let v=h.top-y-g;v<10&&(v=h.bottom+g),v=Math.max(10,Math.min(v,window.innerHeight-y-10)),b.style.left=`${Math.round(S)}px`,b.style.top=`${Math.round(v)}px`},m=()=>{const d=l();if(!d){a();return}c(d)},f=(d,b)=>{d.type==="contextmenu"&&d.preventDefault();const g=window.getSelection(),h=g.toString().trim(),p=h&&g.containsNode(b,!0),y=[{label:"Send to Composer",action:()=>t(d.target)}];p&&y.push({label:"Send Selection to Composer",action:()=>{u.bus.publish("composer:append",{content:h})}}),as(y,d)};e.addEventListener("contextmenu",d=>{if(d.shiftKey)return;const b=d.target.closest(".message.assistant");b&&(d.preventDefault(),f(d,b))}),e.addEventListener("dblclick",d=>{const b=d.target.closest(".message.assistant");b&&f(d,b)}),e.addEventListener("mouseup",()=>{setTimeout(m,0)}),e.addEventListener("keyup",()=>{setTimeout(m,0)}),e.addEventListener("scroll",()=>r(),{passive:!0}),document.addEventListener("selectionchange",()=>{if(n&&n.contains(document.activeElement))return;const d=window.getSelection();if(!d||d.rangeCount===0){r();return}const b=d.getRangeAt(0),g=b.commonAncestorContainer instanceof Element?b.commonAncestorContainer:b.commonAncestorContainer?.parentElement;if(!g||!e.contains(g)){r();return}setTimeout(m,0)}),window.addEventListener("resize",()=>r(),{passive:!0})}function j(e){return typeof e!="string"||!e?0:Math.round(e.length/4)}function Xo(e,t){return!e||!t||!t.type||!t.name?!1:t.type==="agent"?!!e.agentPresets?.[t.name]:t.type==="group"?!!e.agentGroups?.[t.name]:!1}function Zo(e){const t=Object.keys(e?.agentPresets||{})[0];if(t)return{type:"agent",name:t};const n=Object.keys(e?.agentGroups||{})[0];return n?{type:"group",name:n}:null}function es(e,t){const o=[t?.linkedEntity,e?.activeEntity,Zo(e)].find(a=>Xo(e,a));if(!o)return{entity:null,changed:!1};const s={type:o.type,name:o.name};let r=!1;return(!t.linkedEntity||t.linkedEntity.type!==s.type||t.linkedEntity.name!==s.name)&&(t.linkedEntity={...s},r=!0),(!e.activeEntity||e.activeEntity.type!==s.type||e.activeEntity.name!==s.name)&&(e.activeEntity={...s},r=!0),{entity:s,changed:r}}function gt(){const e=u.getProject();if(!e||!e.chatSessions||!e.activeSessionId)return{finalSystemPrompt:"",totalTokens:0,agent:{},agentNameForDisplay:"N/A",model:"N/A"};const t=e.chatSessions.find(c=>c.id===e.activeSessionId);if(!t||!e.activeEntity)return{finalSystemPrompt:"",totalTokens:0,agent:{},agentNameForDisplay:"N/A",model:"N/A"};let n="N/A",o={};if(e.activeEntity.type==="group"&&t.groupChatState?.isRunning&&t.groupChatState.currentJob)n=t.groupChatState.currentJob.agentName,o=e.agentPresets[n]||{};else if(n=e.activeEntity.name,e.activeEntity.type==="agent")o=e.agentPresets[n]||{};else if(e.activeEntity.type==="group"){const c=e.agentGroups[n];n=`Group: ${n} (Moderator)`,o=e.agentPresets[c?.moderatorAgent]||{}}const s=Hn(o.name||n.replace("Group: ","").replace(" (Moderator)","")),r=j(JSON.stringify(t.history||[])),a=j(document.getElementById("chatInput")?.value||""),l=j(s)+r+a;return{finalSystemPrompt:s,totalTokens:l,agent:o,agentNameForDisplay:n,model:o.model||"N/A"}}async function ts(){if(u.isLoading())return;u.newAbortController();const e=u.getProject(),t=document.getElementById("chatInput");if(!t.value.trim()&&U.length===0)return;const o=B();if(o.planStatus==="expired"){R("Your account is suspended. Please refill your credits to continue.","Account Suspended");return}if(o.credits.current<=0&&(o.plan==="free"||o.plan==="pro"&&o.planStatus==="active"))if(o.plan==="pro"){vn();return}else{R("Your trial credits have run out.","Credits Depleted");return}const s=e.chatSessions.find(l=>l.id===e.activeSessionId);if(!s)return;const{entity:r,changed:a}=es(e,s);if(!r){R("No valid Agent or Group is available for this chat session.","Error");return}a&&(u.setProject(e),u.updateAndPersistState(),u.bus.publish("entity:selected",{...r})),u.bus.publish("ui:toggleLoading",{isLoading:!0}),u.bus.publish("status:update",{message:"Processing images...",state:"loading"});let i="image_processing";try{const l=[],c=/(https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp|bmp))/gi;let m=document.getElementById("chatInput").value.trim();const f=m.match(c)||[],d=m.replace(c,"").trim();d&&l.push({type:"text",text:d});for(const y of f)try{const S=await Lt(encodeURI(y));l.push({type:"image_url",url:S})}catch(S){console.warn(`Could not process image from URL: ${y}. Skipping.`,S),l.push({type:"text",text:`(Could not load image: ${y})`})}(await Promise.all(f.map(y=>Lt(encodeURI(y))))).forEach(y=>{l.push({type:"image_url",url:y})}),U.length>0&&U.forEach(y=>{l.push({type:"image_url",url:y.data})});const g=l.some(y=>y.type==="image_url"),h=l.some(y=>y.type==="text");g&&!h&&l.unshift({type:"text",text:""});const p={role:"user",content:l,speaker:"You",timestamp:Date.now()};if(Array.isArray(s.history)||(s.history=[]),p.content&&p.role)s.history.push(p);else throw console.error("Attempted to add invalid message to history:",p),new Error("Cannot add malformed message to chat history");if(s.name==="New Chat"&&s.history.length===1&&ot(s)&&ns(s),t.value="",t.style.height="auto",U=[],u.bus.publish("ui:renderFilePreviews",{files:U}),u.bus.publish("ui:renderMessages"),u.updateAndPersistState(),i="chat_generation",r.type==="agent")await ht(r.name);else if(r.type==="group"){const y=e.agentGroups[r.name];if(!y)throw new Error(`Group "${r.name}" was not found.`);await ft(e,s,y)}else throw new Error("Unsupported session entity type.")}catch(l){if(l.name==="AbortError"){console.log("sendMessage aborted by user during image processing.");return}console.error(`Error during sendMessage (${i}):`,l);const c=`Details: ${l.message}`;let m="Message Could Not Be Sent",f=c;i==="image_processing"&&(m="Image Could Not Be Processed",f=`For best results, please save the image to your device and use the '+' button to upload it directly.

---
${c}`),R(f,m),U=[],u.bus.publish("ui:renderFilePreviews",{files:U}),u.bus.publish("ui:toggleLoading",{isLoading:!1}),u.bus.publish("status:update",{message:"Message send failed",state:"error"})}}async function ht(e=null){const t=u.getProject(),n=t.chatSessions.find(c=>c.id===t.activeSessionId);if(!n)return;const o=e||t.activeEntity.name,s=t.agentPresets[o];if(!s||!s.model)throw new Error(`Agent "${o}" is missing or has no model configured.`);u.bus.publish("status:update",{message:`Responding with ${s.model}...`,state:"loading"}),u.bus.publish("ui:toggleLoading",{isLoading:!0});const r={id:jt(),role:"assistant",content:"",speaker:o,isLoading:!0};n.history.push(r),ee();const a=document.querySelector(`.message-turn-wrapper[data-message-id='${r.id}']`);let i,l=null;if(!a){console.error("Could not find placeholderElement in the DOM immediately after render."),u.bus.publish("ui:toggleLoading",{isLoading:!1});return}try{i=new Ht(a)}catch(c){console.error("UI Error creating LiveMarkdownRenderer:",c.message),u.bus.publish("ui:toggleLoading",{isLoading:!1}),n.history.pop();return}try{const c={__collect:!0};if(en(n)){const y=(t.books||[]).find(v=>v?.id===(n.bookAgentBookId||n.bookId))||null,S=typeof y?.bookAgentConfig?.systemPromptOverride=="string"?y.bookAgentConfig.systemPromptOverride.trim():"";S&&(c.surfaceSystemPromptOverride=["Book Agent Override (Book-specific instruction):",S].join(`
`))}const m=It(n.history.slice(0,-1),o,c),f=await jn(s,m,i.streamChunk),d=wr(s.model,f.usage),b=B();if(b&&b.plan!=="master"){const y={timestamp:Date.now(),model:s.model,promptTokens:f.usage.prompt_tokens||0,completionTokens:f.usage.completion_tokens||0,costUSD:d,duration:f.duration||0,usageIsEstimated:f.usageIsEstimated};An(b.userId,y)}wn(d),Et(f.usage,s.model,f.cost);const g=i.getFinalContent(),h={...r,content:g,speaker:o,isLoading:!1,timestamp:Date.now(),rag:c.rag||null,folderContext:c.folderContext||null,worldContext:c.worldContext||null,stats:{...f.usage,duration:f.duration,speed:f.usage.completion_tokens/(f.duration||1)}},p=n.history.findIndex(y=>y.id===r.id);p>-1&&(n.history[p]=h),jo(h),l={sessionId:n.id,messageId:h.id||null,speaker:o,timestamp:h.timestamp||Date.now()}}catch(c){const m=n.history.findIndex(f=>f.id===r.id);if(c.name!=="AbortError"){const f=`Error: ${c.message}`;console.error("LLM Stream Error:",c),m>-1&&(n.history[m]={...r,content:f,isLoading:!1,isError:!0},ee()),u.bus.publish("status:update",{message:"An error occurred.",state:"error"})}else m>-1&&(n.history.splice(m,1),ee()),console.log("Stream aborted by user.")}finally{if(u.getState().abortController?.signal.aborted){console.log("Stream was manually aborted. UI state is handled by stopGeneration().");return}if(u.getState().abortController?.signal.aborted){console.log("Stream was manually aborted. UI state is handled by stopGeneration().");return}u.bus.publish("ui:toggleLoading",{isLoading:!1}),await Xn(Ze,"readwrite","put",n),u.bus.publish("status:update",{message:"Ready",state:"connected"}),l&&u.bus.publish("chat:assistantTurnCompleted",l)}}function pn(){console.log("STOP button pressed. Aborting current request..."),u.abort();const e=u.getProject();if(e&&e.activeSessionId){const t=e.chatSessions.find(n=>n.id===e.activeSessionId);t&&t.groupChatState&&(t.groupChatState.isRunning=!1)}u.setLoading(!1),u.bus.publish("ui:toggleLoading",{isLoading:!1}),u.bus.publish("status:update",{message:"Generation stopped.",state:"connected"})}window.ChatHandlers={sendMessage:ts,stopGeneration:pn};function Rr({index:e}){U&&U[e]!==void 0&&(U.splice(e,1),u.bus.publish("ui:renderFilePreviews",{files:U}))}function Wr(e){if(e)for(const t of e){if(!t.type.startsWith("image/")){R(`File type not supported: ${t.type}. Please upload images only.`,"Unsupported File");continue}const n=`file_${Date.now()}_${Math.random()}`,o={id:n,name:t.name,type:t.type,data:null};U.push(o);const s=new FileReader;s.onload=r=>{const a=U.findIndex(i=>i.id===n);a!==-1&&(U[a].data=r.target.result,u.bus.publish("ui:renderFilePreviews",{files:U}))},s.readAsDataURL(t)}}function qr(){console.log("ðŸš€ unloadSummaryFromActiveSession handler called!");const e=u.getProject(),t=e.chatSessions.find(n=>n.id===e.activeSessionId);!t||!t.summaryState?.activeSummaryId||(console.log(`Clearing summary context for session: ${t.name}`),t.summaryState.activeSummaryId=null,t.history.push({role:"system",content:"[Summary context has been cleared. The full conversation history is now active.]"}),u.updateAndPersistState(),ee(),u.bus.publish("status:update",{message:"Summary context cleared.",state:"connected"}),R("Summary context cleared successfully.","Success"),u.bus.publish("context:requestData"))}async function zr({index:e,event:t}){t&&t.stopPropagation();const n=t.currentTarget,o=u.getProject(),s=o.chatSessions.find(l=>l.id===o.activeSessionId);if(!s)return;const r=s.history[e];if(!r)return;let a="";typeof r.content=="string"?a=r.content:Array.isArray(r.content)&&(a=r.content.find(l=>l.type==="text")?.text||"");let i="";r.role==="assistant"&&window.marked?i=marked.parse(a,{gfm:!0,breaks:!1}):i=`<p>${a.replace(/\n/g,"<br>")}</p>`;try{const l=new Blob([i],{type:"text/html"}),c=new Blob([a],{type:"text/plain"}),m=new ClipboardItem({"text/html":l,"text/plain":c});if(await navigator.clipboard.write([m]),n){const f=n.querySelector(".material-symbols-outlined");if(f){const d=f.textContent;f.textContent="check",setTimeout(()=>{f.textContent=d},1500)}}}catch(l){console.error("Failed to copy rich text, falling back to plain text:",l),await navigator.clipboard.writeText(a),R("Failed to copy rich text, copied as plain text instead.","Warning")}}async function Kr({index:e,event:t}){t&&t.stopPropagation();const n=u.getProject(),o=n.chatSessions.find(l=>l.id===n.activeSessionId);if(!o)return;const s=o.history[e],r=document.querySelector(`.message-turn-wrapper[data-index='${e}']`);if(!r)return;const a=r.querySelector(".message"),i=a.querySelector(".message-content");if(s.role==="user"){if(a.classList.contains("is-editing"))return;a.classList.add("is-editing"),r.classList.add("is-editing-child"),i&&(i.style.display="none");const l=document.createElement("div");l.className="inline-edit-container";const c=document.createElement("textarea");c.className="inline-edit-textarea";const m=Array.isArray(s.content)?s.content.find(h=>h.type==="text")?.text||"":s.content;c.value=m,c.addEventListener("input",()=>{c.style.height="auto",c.style.height=c.scrollHeight+"px"});const f=document.createElement("div");f.className="inline-edit-actions";const d=document.createElement("button");d.textContent="Save & Regenerate",d.className="btn btn-small";const b=document.createElement("button");b.textContent="Cancel",b.className="btn btn-small btn-secondary";const g=()=>{l.remove(),i&&(i.style.display="block"),a.classList.remove("is-editing"),r.classList.remove("is-editing-child")};d.addEventListener("click",async h=>{h.stopPropagation();const p=c.value.trim(),y=Array.isArray(s.content)?s.content.filter(v=>v.type!=="text"):[],S=[];if(p&&S.push({type:"text",text:p}),S.push(...y),S.length===0){R("Cannot save an empty message.","Warning");return}if(o.history[e].content=S,o.summaryState?.activeSummaryId&&e<o.summaryState.summarizedUntilIndex&&(o.summaryState.activeSummaryId=null,o.summaryState.summarizedUntilIndex=-1,console.log("Summary context has been reset due to a historical message edit."),o.history.splice(e+1,0,{role:"system",content:"[System: Conversation history was edited. Previous summary context has been cleared.]"})),o.history.splice(e+1),u.updateAndPersistState(),u.bus.publish("ui:renderMessages"),n.activeEntity.type==="agent")await ht();else if(n.activeEntity.type==="group"){const v=n.agentGroups[n.activeEntity.name];await ft(n,o,v)}oe()}),b.addEventListener("click",h=>{h.stopPropagation(),g()}),c.addEventListener("keydown",h=>{h.key==="Escape"&&(h.preventDefault(),b.click())}),f.appendChild(b),f.appendChild(d),l.appendChild(c),l.appendChild(f),a.appendChild(l),c.focus(),c.dispatchEvent(new Event("input"))}else if(s.role==="assistant"){if(!i||a.classList.contains("is-editing"))return;a.classList.add("is-editing"),r.classList.add("is-editing-child"),i&&(i.style.display="none");const l=document.createElement("div");l.className="inline-edit-container";const c=document.createElement("textarea");c.className="inline-edit-textarea",c.value=s.content,c.addEventListener("input",()=>{c.style.height="auto",c.style.height=c.scrollHeight+"px"});const m=document.createElement("div");m.className="inline-edit-actions";const f=document.createElement("button");f.textContent="Save",f.className="btn btn-small";const d=document.createElement("button");d.textContent="Cancel",d.className="btn btn-small btn-secondary";const b=()=>{l.remove(),i&&(i.style.display="block"),a.classList.remove("is-editing"),r.classList.remove("is-editing-child")};f.addEventListener("click",g=>{g.stopPropagation(),o.history[e].content=c.value,u.updateAndPersistState(),u.bus.publish("ui:renderMessages")}),d.addEventListener("click",g=>{g.stopPropagation(),b()}),c.addEventListener("keydown",g=>{g.key==="Escape"&&(g.preventDefault(),d.click())}),m.appendChild(d),m.appendChild(f),l.appendChild(c),l.appendChild(m),a.appendChild(l),c.focus(),c.dispatchEvent(new Event("input"))}}async function Hr({index:e}){const t=u.getProject(),n=t.chatSessions.find(o=>o.id===t.activeSessionId);if(!(!n||e>=n.history.length)){if(pn(),n.history.splice(e),u.bus.publish("ui:renderMessages"),t.activeEntity.type==="agent")await ht();else if(t.activeEntity.type==="group"){const o=t.agentGroups[t.activeEntity.name];await ft(t,n,o)}}}function jr({index:e}){if(!confirm("Are you sure you want to delete this single message? This action cannot be undone."))return;const t=u.getProject(),n=t.chatSessions.find(o=>o.id===t.activeSessionId);n&&(n.history.splice(e,1),u.setProject(t),u.updateAndPersistState(),u.bus.publish("ui:renderMessages"),oe())}async function ns(e){if(ot(e)){await new Promise(t=>setTimeout(t,500));try{const n=u.getProject().globalSettings.systemUtilityAgent;if(!n||!n.model){console.warn("Auto-naming skipped: System Utility Agent not configured.");return}const o=e.history.find(c=>c.role==="user"),s=Array.isArray(o.content)?o.content.find(c=>c.type==="text")?.text:o.content;if(!s)return;const r=`Based on the user's initial query, create a concise title (3-5 words) and a single relevant emoji. Respond ONLY with a JSON object like {"title": "your title", "emoji": "ðŸ‘"}.

User's Query: "${s}"`,a=await Gn({...n,temperature:.1},[{role:"user",content:r}]);Et(a.usage,n.model);let i={};try{const c=a.content.match(/{.*}/s);i=JSON.parse(c[0])}catch{console.error("Failed to parse title JSON:",a.content),i={title:s.substring(0,30),emoji:"ðŸ’¬"}}const l=`${i.emoji||"ðŸ’¬"} ${i.title||"New Chat"}`;if(!ot(e)){u.bus.publish("ui:updateChatTitle",{title:Ao(e,{includeAct:!0})});return}u.bus.publish("session:autoRename",{sessionId:e.id,newName:l})}catch(t){console.error("Auto-rename process failed:",t)}}}function Gr({index:e}){const t=u.getProject(),n=t.chatSessions.find(r=>r.id===t.activeSessionId);if(!n)return;const o=n.history[e],s=n.summaryState?.activeSummaryId;s&&o?.summaryLogId===s&&(n.summaryState.activeSummaryId=null,console.log(`Summary context for log ID ${s} has been cleared.`)),n.history.splice(e,1),u.updateAndPersistState(),u.bus.publish("ui:renderMessages"),R("Marker/Context has been removed from this chat.","Info")}async function Lt(e){try{const n=await fetch("https://cors-anywhere.herokuapp.com/"+e);if(!n.ok)throw new Error(`Server responded with status ${n.status} (${n.statusText})`);const o=await n.blob();return new Promise((s,r)=>{const a=new FileReader;a.onloadend=()=>s(a.result),a.onerror=r,a.readAsDataURL(o)})}catch(t){throw console.error(`Could not convert image URL "${e}" to Base64:`,t.message),new Error(`Failed to process image from URL: ${e}. It might be protected (403 Forbidden).`)}}let Ie=null;function ue(){const e=document.getElementById("status-panel"),t=e?.querySelector(".status-right"),n=document.getElementById("active-agent-status");if(!(!e||!t||!n)){if(window.innerWidth>768){n.classList.remove("is-marquee"),n.style.removeProperty("--status-marquee-duration"),n.style.removeProperty("--status-marquee-start"),n.style.removeProperty("--status-marquee-end");return}Ie&&cancelAnimationFrame(Ie),Ie=requestAnimationFrame(()=>{const o=t.clientWidth,s=n.scrollWidth;if(o<20||s<=0){n.classList.remove("is-marquee"),Ie=null;return}const r=s>o+6;if(n.classList.toggle("is-marquee",r),r){const a=o+8,i=s+8,l=a+i,c=Math.min(42,Math.max(12,l/28));n.style.setProperty("--status-marquee-start",`${a}px`),n.style.setProperty("--status-marquee-end",`${i}px`),n.style.setProperty("--status-marquee-duration",`${c}s`)}else n.style.removeProperty("--status-marquee-duration"),n.style.removeProperty("--status-marquee-start"),n.style.removeProperty("--status-marquee-end");Ie=null})}}function oe(e={}){const{message:t,state:n}=e,o=document.getElementById("statusText"),s=document.getElementById("statusDot"),r=document.getElementById("model-count-status");if(o&&s&&r){o.textContent=t||"Ready",s.className="status-dot";const b=n||"connected";b==="connected"?s.classList.add("connected"):b==="error"?s.classList.add("error"):b==="loading"&&s.classList.add("warning");const g=Re();r.textContent=`${g.length} Models`}const{totalTokens:a,agent:i,agentNameForDisplay:l,model:c}=gt(),m=document.getElementById("active-agent-status"),f=document.getElementById("token-count-status"),d=c&&c!=="N/A"?c:"N/A";if(m){const b=`Active: ${i.icon||""} ${l} â€¢ ${d}`;m.textContent!==b&&(m.textContent=b)}f&&(f.textContent=`~${a.toLocaleString()} Tokens`),ue()}function Nt({message:e,state:t}){const n=document.getElementById("statusText"),o=document.getElementById("statusDot");if(n&&o){n.textContent=e||"Ready",o.className="status-dot";const s=t||"connected";s==="connected"?o.classList.add("connected"):s==="error"?o.classList.add("error"):s==="loading"&&o.classList.add("warning")}ue()}function Jr(e){const t=document.createElement("div");t.className="dropdown align-right";const n=document.createElement("button");n.className="btn-icon",n.innerHTML="&#8942;",n.title="More options",n.dataset.action="toggle-menu";const o=document.createElement("div");return o.className="dropdown-content",e.forEach(s=>{const r=document.createElement("a");r.href="#",r.textContent=s.label,s.isDestructive&&r.classList.add("is-destructive"),r.dataset.action=s.action,s.data&&(r.dataset.data=JSON.stringify(s.data)),o.appendChild(r)}),t.append(n,o),t}function Yr(){const e=document.getElementById("settings-modal");e&&(e.style.display="flex")}function Vr(){const e=document.getElementById("settings-modal");e&&(e.style.display="none")}function Qr(){document.getElementById("unsaved-changes-modal").style.display="flex"}function Xr(){document.getElementById("unsaved-changes-modal").style.display="none"}function R(e,t="Notification"){document.getElementById("alert-modal-title").textContent=t,document.getElementById("alert-modal-message").textContent=e,document.getElementById("alert-modal").style.display="flex"}function os(){document.getElementById("alert-modal").style.display="none"}function ss(){document.querySelector(".sidebar").classList.toggle("open"),document.getElementById("mobile-overlay").classList.toggle("active")}function Zr(e){e.stopPropagation();const t=e.target.closest(".dropdown");if(!t)return;const n=t.querySelector(".dropdown-content"),o=t.classList.contains("open");if(document.querySelectorAll(".dropdown.open").forEach(s=>{s!==t&&s.classList.remove("open")}),!o){n.style.visibility="hidden",n.style.display="block";const s=n.offsetHeight;n.style.visibility="",n.style.display="";const r=e.target.closest("button").getBoundingClientRect();window.innerHeight-r.bottom<s&&r.top>s?n.classList.add("opens-up"):n.classList.remove("opens-up")}t.classList.toggle("open")}function ea(){document.addEventListener("click",e=>{const t=document.querySelector(".dropdown.open");t&&!t.contains(e.target)&&t.classList.remove("open");const n=document.querySelector(".searchable-select-wrapper .searchable-select-options:not(.hidden)");if(n){const o=n.closest(".searchable-select-wrapper");o&&!o.contains(e.target)&&n.classList.add("hidden")}})}function rs(){const e=u.getProject();e?.globalSettings?.fontFamilySelect&&document.documentElement.style.setProperty("--main-font-family",e.globalSettings.fontFamilySelect)}function ta(){const e=document.getElementById("app-version");e&&(e.textContent="0.0.1alpha"),u.bus.subscribe("ui:applyFontSettings",rs),u.bus.subscribe("session:loaded",()=>oe()),u.bus.subscribe("entity:selected",()=>oe()),u.bus.subscribe("user:settingsUpdated",()=>oe()),u.bus.subscribe("user:modelsLoaded",()=>oe()),u.bus.subscribe("status:update",Nt),Nt({}),ue(),window.addEventListener("resize",ue),window.addEventListener("orientationchange",ue);const t=document.getElementById("mobile-overlay");t&&t.addEventListener("click",ss);const n=document.querySelector("#alert-modal .btn");n&&n.addEventListener("click",os);const o=document.getElementById("unsaved-changes-modal");if(o){const s=o.querySelector(".btn:not(.btn-secondary):not(.btn-danger)");s&&s.addEventListener("click",()=>u.bus.publish("project:unsavedChangesChoice","save"));const r=o.querySelector(".btn-danger");r&&r.addEventListener("click",()=>u.bus.publish("project:unsavedChangesChoice","discard"));const a=o.querySelector(".btn-secondary");a&&a.addEventListener("click",()=>u.bus.publish("project:unsavedChangesChoice","cancel"))}console.log("Core UI Initialized and Listeners Attached.")}function as(e,t){const n=document.querySelector(".context-menu");n&&n.remove(),t.preventDefault(),t.stopPropagation();const o=document.createElement("div");o.className="context-menu";const s=document.createElement("ul");e.forEach(g=>{const h=document.createElement("li");h.textContent=g.label,g.isDestructive&&h.classList.add("destructive"),h.addEventListener("click",p=>{p.stopPropagation(),g.action()}),s.appendChild(h)}),o.appendChild(s),document.body.appendChild(o);const{clientX:r,clientY:a}=t.touches?t.touches[0]:t,i=o.offsetWidth,l=o.offsetHeight,c=window.innerWidth,m=window.innerHeight;let f=a,d=r;r+i>c&&(d=c-i-10),a+l>m&&(f=m-l-10),o.style.top=`${f}px`,o.style.left=`${d}px`,requestAnimationFrame(()=>{o.style.opacity="1",o.style.transform="scale(1)"});const b=()=>{o.remove(),document.removeEventListener("click",b,!0)};setTimeout(()=>{document.addEventListener("click",b,!0)},0)}function q(e=""){return String(e||"").trim().toLowerCase()}function ae(e=""){return q(e).replace(/[^a-z0-9]+/g,"")}function is(e,t){if(!e)return!0;let n=0,o=0;for(;n<e.length&&o<t.length;)e[n]===t[o]&&(n+=1),o+=1;return n===e.length}function fn(e="",t="",n=1/0){const o=String(e),s=String(t);if(o===s)return 0;if(!o.length)return s.length;if(!s.length)return o.length;if(Math.abs(o.length-s.length)>n)return n+1;let r=Array.from({length:s.length+1},(a,i)=>i);for(let a=1;a<=o.length;a+=1){const i=[a];let l=i[0];for(let c=1;c<=s.length;c+=1){const m=o[a-1]===s[c-1]?0:1,f=Math.min(r[c]+1,i[c-1]+1,r[c-1]+m);i[c]=f,f<l&&(l=f)}if(l>n)return n+1;r=i}return r[s.length]}function ls(e=[]){const t=new Set,n=[];return(Array.isArray(e)?e:[]).forEach(o=>{const s=q(o?.id);if(!s||t.has(s))return;t.add(s);const r=String(o.id).trim(),a=String(o.name||r).trim(),i=String(o.provider||"").trim();n.push({...o,id:r,name:a,provider:i})}),n.sort((o,s)=>{const r=o.name.localeCompare(s.name);return r!==0?r:o.id.localeCompare(s.id)}),n.map((o,s)=>{const r=q(o.id),a=q(o.name),i=q(o.provider),l=r.includes("/")?r.split("/").slice(1).join("/"):r;return{model:o,order:s,idLower:r,nameLower:a,providerLower:i,idTailLower:l,idFolded:ae(r),nameFolded:ae(a),idTailFolded:ae(l)}})}function cs(e,t){const n=q(t),o=ae(t);if(!n&&!o)return e.map(r=>({entry:r,tier:99,detail:r.order}));const s=[];return e.forEach(r=>{let a=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY;const l=r.idLower===n||r.idTailLower===n||r.nameLower===n,c=!!o&&(r.idFolded===o||r.idTailFolded===o||r.nameFolded===o);if(l)a=0,i=0;else if(c)a=1,i=0;else{const m=n&&(r.idLower.startsWith(n)||r.idTailLower.startsWith(n)||r.nameLower.startsWith(n)||r.providerLower.startsWith(n)),f=!!o&&(r.idFolded.startsWith(o)||r.idTailFolded.startsWith(o)||r.nameFolded.startsWith(o));if(m||f){a=2;const d=[r.idLower.indexOf(n),r.idTailLower.indexOf(n),r.nameLower.indexOf(n),r.providerLower.indexOf(n)].filter(b=>b>=0);i=d.length?Math.min(...d):0}else{const d=n&&(r.idLower.includes(n)||r.idTailLower.includes(n)||r.nameLower.includes(n)||r.providerLower.includes(n)),b=!!o&&(r.idFolded.includes(o)||r.idTailFolded.includes(o)||r.nameFolded.includes(o));if(d||b)a=3,i=Math.min(...[r.nameLower.indexOf(n),r.idLower.indexOf(n),r.idTailLower.indexOf(n)].filter(g=>g>=0));else if(o.length>=2){const g=Math.max(1,Math.floor(o.length*.4)),h=[r.idTailFolded,r.nameFolded,r.idFolded];let p=Number.POSITIVE_INFINITY;h.forEach(y=>{if(!y)return;is(o,y)&&(p=Math.min(p,Math.max(1,y.length-o.length)));const S=y.slice(0,Math.max(o.length+2,8)),v=fn(o,S,g);v<=g&&(p=Math.min(p,v))}),Number.isFinite(p)&&(a=4,i=p)}}}Number.isFinite(a)&&s.push({entry:r,tier:a,detail:i})}),s.sort((r,a)=>{if(r.tier!==a.tier)return r.tier-a.tier;if(r.detail!==a.detail)return r.detail-a.detail;const i=r.entry.model.name.localeCompare(a.entry.model.name);return i!==0?i:r.entry.model.id.localeCompare(a.entry.model.id)}),s}function ds(e,t,n=3){const o=q(t),s=ae(t);if(!o&&!s)return[];const r=e.map(i=>{const l=[i.idTailFolded,i.nameFolded,i.idFolded].filter(Boolean);if(!l.length)return{entry:i,score:Number.POSITIVE_INFINITY};let c=Number.POSITIVE_INFINITY;if(o&&(i.idLower.includes(o)||i.idTailLower.includes(o)||i.nameLower.includes(o))&&(c=0),s){const m=Math.max(2,Math.ceil(s.length*.7));l.forEach(f=>{const d=f.slice(0,Math.max(s.length+3,10)),b=fn(s,d,m);c=Math.min(c,b)})}return{entry:i,score:c}}),a=Math.max(2,Math.ceil((s||o).length*.7));return r.filter(i=>Number.isFinite(i.score)&&i.score<=a).sort((i,l)=>{if(i.score!==l.score)return i.score-l.score;const c=i.entry.model.name.localeCompare(l.entry.model.name);return c!==0?c:i.entry.model.id.localeCompare(l.entry.model.id)}).slice(0,n).map(i=>i.entry)}const gn="promptPrimModelPickerPrefs_v1",hn=8,at=24;function us(){try{const e=localStorage.getItem(gn);if(!e)return{};const t=JSON.parse(e);return t&&typeof t=="object"?t:{}}catch(e){return console.warn("Failed to read model picker preferences:",e),{}}}function ms(e){try{localStorage.setItem(gn,JSON.stringify(e))}catch(t){console.warn("Failed to write model picker preferences:",t)}}function Pt(e=[],t=[]){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(e[n]!==t[n])return!1;return!0}function _t(e,t,n=1/0){const o=[],s=new Set;return Array.isArray(e)?(e.forEach(r=>{const a=q(r);if(!a)return;const i=t.get(a);if(!i)return;const l=i.model.id;s.has(l)||(s.add(l),o.push(l))}),o.slice(0,n)):o}function $t(e,t){return{pinnedModelIds:_t(e?.pinnedModelIds,t,at),recentModelIds:_t(e?.recentModelIds,t,hn)}}function Bt(e,{onSelect:t,onTogglePin:n,isPinned:o=!1}={}){const s=document.createElement("div");s.className="searchable-option-item searchable-option-row",s.dataset.value=e.model.id,s.dataset.selectable="true";const r=document.createElement("div");r.className="searchable-option-main";const a=document.createElement("span");a.className="searchable-option-title",a.textContent=e.model.name;const i=document.createElement("small");if(i.textContent=e.model.provider?`${e.model.id} â€¢ ${e.model.provider}`:e.model.id,r.append(a,i),s.append(r),typeof n=="function"){const l=document.createElement("button");l.type="button",l.className=`searchable-option-pin${o?" is-pinned":""}`,l.textContent=o?"Pinned":"Pin",l.title=o?"Unpin model":"Pin model",l.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),n(e)}),s.append(l)}return s.addEventListener("click",()=>{typeof t=="function"&&t(e)}),s}function na(e,t,n){const o=document.getElementById(e);if(!o)return;typeof o.__searchableModelSelectorCleanup=="function"&&o.__searchableModelSelectorCleanup();const s=n!==void 0?n:u.getState().allProviderModels||[],r=ls(s),a=new Map;r.forEach(E=>{a.set(E.idLower,E)});const i=o.querySelector('input[type="text"]'),l=o.querySelector('input[type="hidden"]'),c=o.querySelector(".searchable-select-options");if(!i||!l||!c)return;let m=-1,f=null;const d=[],b=`user:${B()?.userId||"anonymous"}`;let g=us(),h=$t(g[b],a);const p=E=>{const C=$t(E,a);Pt(C.pinnedModelIds,h.pinnedModelIds)&&Pt(C.recentModelIds,h.recentModelIds)||(h=C,g[b]=C,ms(g))},y=E=>h.pinnedModelIds.includes(E),S=(E=[])=>E.map(C=>a.get(q(C))).filter(Boolean),v=E=>{const C=E?.model?.id;if(!C)return;const T=[C,...h.recentModelIds.filter(_=>_!==C)].slice(0,hn);p({...h,recentModelIds:T})},I=(E,C,T,_)=>{E.addEventListener(C,T,_),d.push(()=>E.removeEventListener(C,T,_))},x=()=>Array.from(c.querySelectorAll('.searchable-option-item[data-selectable="true"]')),A=()=>{c.classList.add("hidden"),m=-1},L=()=>{c.classList.remove("hidden")},D=()=>{x().forEach((C,T)=>{C.classList.toggle("active",T===m),T===m&&C.scrollIntoView({block:"nearest"})})},P=(E,{emitChange:C=!0}={})=>{const T=l.value;v(E),f=E,i.value=E.model.name,l.value=E.model.id,A(),C&&T!==E.model.id&&l.dispatchEvent(new Event("change",{bubbles:!0}))},H=()=>{if(!f){i.value="",l.value="";return}i.value=f.model.name,l.value=f.model.id},Jn=E=>{const C=ds(r,E,3);if(!C.length)return;const T=document.createElement("div");T.className="searchable-option-hint",T.textContent="Did you mean",c.appendChild(T),C.forEach(_=>{c.appendChild(Bt(_,{isPinned:y(_.model.id),onTogglePin:ce=>{const J=ce.model.id,Ke=y(J)?h.pinnedModelIds.filter(de=>de!==J):[J,...h.pinnedModelIds.filter(de=>de!==J)].slice(0,at);p({...h,pinnedModelIds:Ke}),ne(i.value),L()},onSelect:ce=>{P(ce)}}))})},ze=E=>{const C=document.createElement("div");return C.className="searchable-option-section-title",C.textContent=E,C},Yn=E=>{const C=E.model.id,T=y(C)?h.pinnedModelIds.filter(_=>_!==C):[C,...h.pinnedModelIds.filter(_=>_!==C)].slice(0,at);p({...h,pinnedModelIds:T}),ne(i.value),L()},Ne=E=>{E.forEach(C=>{c.appendChild(Bt(C,{isPinned:y(C.model.id),onTogglePin:Yn,onSelect:T=>{P(T)}}))})},ne=(E="")=>{c.innerHTML="",m=-1;const C=!!(q(E)||ae(E)),T=cs(r,E);if(T.length===0){const F=document.createElement("div");F.className="searchable-option-item searchable-option-empty",F.dataset.selectable="false",F.textContent="No models found.",c.appendChild(F),Jn(E);return}if(C){Ne(T.map(F=>F.entry));return}const _=S(h.pinnedModelIds),ce=new Set(_.map(F=>F.model.id)),J=S(h.recentModelIds).filter(F=>!ce.has(F.model.id)),Ke=new Set(J.map(F=>F.model.id)),de=T.map(F=>F.entry).filter(F=>!ce.has(F.model.id)&&!Ke.has(F.model.id));_.length>0&&(c.appendChild(ze("Pinned")),Ne(_)),J.length>0&&(c.appendChild(ze("Recent")),Ne(J)),de.length>0&&((_.length>0||J.length>0)&&c.appendChild(ze("All Models")),Ne(de))},wt=()=>{const E=q(i.value),C=ae(i.value);if(!E&&!C){H();return}const T=r.find(_=>_.idLower===E||_.idTailLower===E||_.nameLower===E||C&&(_.idFolded===C||_.idTailFolded===C||_.nameFolded===C));if(T){P(T);return}H()};I(i,"keydown",E=>{if(E.key==="ArrowDown"||E.key==="ArrowUp"){E.preventDefault(),c.classList.contains("hidden")&&(ne(i.value),L());const C=x();if(!C.length)return;E.key==="ArrowDown"?m=(m+1)%C.length:m=(m-1+C.length)%C.length,D();return}if(E.key==="Enter"){E.preventDefault(),E.stopPropagation(),c.classList.contains("hidden")&&(ne(i.value),L());const C=x();if(!C.length){wt(),A();return}const T=m>=0?m:0;C[T].click();return}E.key==="Escape"&&(E.preventDefault(),H(),A())}),I(i,"input",()=>{ne(i.value),L()}),I(i,"focus",()=>{ne(i.value),L()}),I(i,"click",()=>{ne(i.value),L()}),I(i,"blur",()=>{window.setTimeout(()=>{o.contains(document.activeElement)||(wt(),A())},100)});const Pe=r.find(E=>E.idLower===q(t));Pe?(f=Pe,i.value=Pe.model.name,l.value=Pe.model.id,A()):(f=null,i.value="",l.value="",A()),o.__searchableModelSelectorCleanup=()=>{d.forEach(E=>E()),delete o.__searchableModelSelectorCleanup}}const ge="promptPrimUserDatabase_v1",yt="promptPrimAdminBilling_v1",yn="promptPrimMasterPresets_v1",ke="promptPrimActiveUserId",it="promptPrimPendingActiveUserId",z="user_master",ps=Object.freeze({openrouter:!0,ollama:!0,kieai:!0});let w=[],se={},W=null;function lt(e){if(typeof e!="string")return"";const t=e.trim();return t?t.replace(/^"+|"+$/g,""):""}async function fs(){const e=localStorage.getItem(yn);if(e)se=JSON.parse(e),console.log("Loaded master presets from localStorage.");else try{const n=await fetch("/PromptPrim/master-presets.json");if(!n.ok)throw new Error(`Status: ${n.status}`);se=await n.json(),kn(se),console.log("Loaded default master presets from file.")}catch(t){console.error("Failed to load default master presets:",t),se={}}}function ve(e=null){const t=e||B();return t?t.userId===z||t.plan==="master":!1}function Re(){const e=B();if(!e)return[];if(ve(e))return u.getState().userProviderModels||[];const t=u.getState().systemProviderModels||[],n=In();if(e.plan==="pro"&&e.planStatus==="active"&&e.credits.current>0){const o=new Set(n.pro_tier?.modelIds||[]);return t.filter(s=>o.has(s.id))}if(e.plan==="free"&&e.credits.current>0||e.planStatus==="grace_period"){const o=new Set(n.free_tier?.modelIds||[]);return t.filter(s=>o.has(s.id))}return[]}function gs(){const e=localStorage.getItem(ge);if(e){let t=!1;w=JSON.parse(e).map(n=>JSON.parse(JSON.stringify(n))).map(n=>{const o=bn(n);return o.needsSave&&(t=!0),o.user}),Sn()&&(t=!0),t&&localStorage.setItem(ge,JSON.stringify(w)),u.bus.publish("user:settingsUpdated",B()),console.log("Cross-tab sync: In-memory user database reloaded.")}}function we(e,t,n,o,s=0){const r={userId:e,userName:t,email:n,plan:o,planStatus:"active",gracePeriodStartDate:null,credits:{current:s,totalUsage:0,totalRefilledUSD:0,tokenUsage:{prompt:0,completion:0},totalUsedUSD:0},subscriptionEndDate:null,logs:[{timestamp:Date.now(),action:`Account created with ${o} plan.`}],activityLog:[],apiSettings:{openrouterKey:"",ollamaBaseUrl:"http://localhost:11434",kieAiApiKey:"",providerEnabled:{...ps}},appSettings:{activeModelPreset:"my_first_preset"}};return o!=="master"&&(r.modelPresets={my_first_preset:{name:"My First Preset",modelIds:[]}}),r}function he(e){if(typeof e!="string")return"";const t=e.trim();return t?t.replace(/^Bearer\s+/i,"").trim():""}function bt(e){if(typeof e!="string")return"";let t=e.trim();return t?(/^https?:\/\//i.test(t)||(t=`http://${t}`),t.replace(/\/+$/,"")):""}function ye(e){const t=e&&typeof e=="object"?e:{};return{openrouter:t.openrouter!==!1,ollama:t.ollama!==!1,kieai:t.kieai!==!1}}function G(e){const t=e?.apiSettings&&typeof e.apiSettings=="object"?e.apiSettings:{},n=t.ollamaBaseUrl??e?.ollamaBaseUrl;return{openrouterKey:he(t.openrouterKey??e?.openrouterKey??e?.apiKey??""),ollamaBaseUrl:bt(n===void 0?"http://localhost:11434":n),kieAiApiKey:he(t.kieAiApiKey??e?.kieAiApiKey??""),providerEnabled:ye(t.providerEnabled??e?.apiProviderEnabled)}}function We(e){if(!e||typeof e!="object")return!1;let t=!1;(!e.apiSettings||typeof e.apiSettings!="object")&&(e.apiSettings={},t=!0);const n=G(e);e.apiSettings.openrouterKey!==n.openrouterKey&&(e.apiSettings.openrouterKey=n.openrouterKey,t=!0),e.apiSettings.ollamaBaseUrl!==n.ollamaBaseUrl&&(e.apiSettings.ollamaBaseUrl=n.ollamaBaseUrl,t=!0),e.apiSettings.kieAiApiKey!==n.kieAiApiKey&&(e.apiSettings.kieAiApiKey=n.kieAiApiKey,t=!0);const o=ye(e.apiSettings.providerEnabled);return(o.openrouter!==n.providerEnabled.openrouter||o.ollama!==n.providerEnabled.ollama||o.kieai!==n.providerEnabled.kieai)&&(e.apiSettings.providerEnabled=n.providerEnabled,t=!0),t}function bn(e){let t=!1;if(!e||typeof e!="object")return{user:e,needsSave:t};(!e.credits||typeof e.credits!="object")&&(e.credits={current:0,totalUsage:0,totalRefilledUSD:0,tokenUsage:{prompt:0,completion:0},totalUsedUSD:0},t=!0),(!e.credits.tokenUsage||typeof e.credits.tokenUsage!="object")&&(e.credits.tokenUsage={prompt:0,completion:0},t=!0),Array.isArray(e.activityLog)||(e.activityLog=[],t=!0),(!e.apiSettings||typeof e.apiSettings!="object")&&(e.apiKey||e.openrouterKey||e.ollamaBaseUrl||e.kieAiApiKey)&&(e.apiSettings={},t=!0),We(e)&&(t=!0);for(const n of["apiKey","openrouterKey","ollamaBaseUrl","kieAiApiKey","apiProviderEnabled"])Object.prototype.hasOwnProperty.call(e,n)&&(delete e[n],t=!0);return{user:e,needsSave:t}}function He(){w=[we("user_pro","Kaiwan (Pro)","kai@example.com","pro",1e6),we("user_free","Demo User (Free)","demo@example.com","free",5e4),we(z,"Admin (Master)","admin@example.com","master",0)],localStorage.setItem(ge,JSON.stringify(w))}function Sn(){const e=w.find(n=>n?.userId===z);if(!e)return w.push(we(z,"Admin (Master)","admin@example.com","master",0)),!0;let t=!1;return e.plan!=="master"&&(e.plan="master",t=!0),e.planStatus!=="active"&&(e.planStatus="active",t=!0),e.userName||(e.userName="Admin (Master)",t=!0),e.email||(e.email="admin@example.com",t=!0),We(e)&&(t=!0),t}function St(){const e=localStorage.getItem(ge);if(!e){He();return}try{const t=JSON.parse(e);if(!Array.isArray(t)||t.length===0){console.warn("User database is empty or invalid. Rebuilding default users."),He();return}let n=!1;w=t.map(o=>JSON.parse(JSON.stringify(o))).map(o=>{const s=bn(o);return s.needsSave&&(n=!0),s.user}),Sn()&&(n=!0),n&&localStorage.setItem(ge,JSON.stringify(w))}catch(t){console.error("Failed to parse user database. Rebuilding default users.",t),He()}}function Y(){localStorage.setItem(ge,JSON.stringify(w)),u.bus.publish("user:settingsUpdated",B())}function hs(e){w.length===0&&St();const t=lt(e);if(!t)return console.warn("setActiveUserId called with empty userId"),null;if(!(w.find(s=>s?.userId===t)||null))return console.warn(`setActiveUserId could not find user: ${t}`),null;W=t;try{localStorage.setItem(ke,t),localStorage.setItem(it,t)}catch(s){console.error("Failed to persist active user ID to localStorage:",s)}console.log(`ðŸ‘¤ Active user switched to: ${t}`);const o=B();return o&&(u.bus.publish("user:settingsLoaded",o),u.bus.publish("user:settingsUpdated",o)),o}function ys(){return JSON.parse(JSON.stringify(w))}function Ae(e){const t=w.find(n=>n.userId===e);return t?JSON.parse(JSON.stringify(t)):null}function bs(e,t){const n=w.findIndex(o=>o.userId===e);n!==-1&&(t.plan!==void 0&&(w[n].plan=t.plan),t.credits!==void 0&&(w[n].credits=t.credits),t.plan!==void 0&&w[n].planStatus!=="active"&&(w[n].planStatus="active",w[n].gracePeriodStartDate=null),Y())}function Ss(){return B()}function B(){w.length===0&&St();let e=w.find(t=>t.userId===W)||null;return!e&&w.length>0&&(W=w[0].userId,localStorage.setItem(ke,W),e=w[0]),e}async function vs(){await fs(),St();const e=lt(localStorage.getItem(it)),t=lt(localStorage.getItem(ke)),n=[e,t].find(s=>s&&w.some(r=>r.userId===s));if(n?W=n:(!W||!w.some(s=>s.userId===W))&&w.length>0&&(W=w[0].userId),W?localStorage.setItem(ke,W):w.length>0&&(W=w[0].userId,localStorage.setItem(ke,W)),e)try{localStorage.removeItem(it)}catch{}const o=B();return o&&Es(o),console.log("ðŸ‘¤ Current User Profile Initialized:",o),u.bus.publish("user:settingsLoaded",o),o}function vt(e){const t=le();return!t||!t.markupRate||t.markupRate===0?0:e/(t.markupRate*1e6)}function Et(e,t,n=0){const o=B();if(!o||o.plan==="master")return;const r=le().markupRate||1;let a=0;if(n>0)a=n;else if(e&&e.prompt_tokens>0)a=calculateCost(t,e);else{console.warn(`Could not determine cost for model ${t}. No credits were burned.`);return}const i=a*r*1e6;o.credits.current-=i,o.credits.totalUsage+=i,o.credits.current<0&&(o.credits.current=0),o.credits.totalUsedUSD||(o.credits.totalUsedUSD=0),o.credits.totalUsedUSD+=a,o.credits.tokenUsage||(o.credits.tokenUsage={prompt:0,completion:0}),o.credits.tokenUsage.prompt+=e.prompt_tokens||0,o.credits.tokenUsage.completion+=e.completion_tokens||0;const l=vt(o.credits.current);o.logs.push({timestamp:Date.now(),event:"Usage",details:`API Usage on model: ${t}`,amountUSD:-a,balanceAfterUSD:l}),Y()}function vn(){const e=B();!e||e.plan!=="pro"||e.planStatus!=="active"||(e.planStatus="grace_period",e.gracePeriodStartDate=Date.now(),Y(),R("Your Pro credits have run out. You now have 7 days of Free Plan access before your account is suspended. Please refill your credits.","Credits Depleted"))}function Es(e){if(!e||e.planStatus!=="grace_period")return;const t=10080*60*1e3;Date.now()-e.gracePeriodStartDate>t&&(e.planStatus="expired",Y(),R("Your grace period has expired. Please refill your credits to continue using the service.","Account Suspended"))}function ie(){const e=w.find(t=>t.userId===z);return G(e)}function Cs(e){const t=B(),n=w.find(r=>r.userId===z),o=G(t),s=G(n);return ve(t)?o.providerEnabled[e]:s.providerEnabled[e]}function be(e,t={}){const n=String(e||"").toLowerCase(),o=t?.useSystemSettings===!0;return["openrouter","ollama","kieai"].includes(n)?o?ie().providerEnabled[n]!==!1:Cs(n)!==!1:!1}function Is(){if(!be("kieai"))return"";const e=B(),t=w.find(s=>s.userId===z),n=G(e),o=G(t);return ve(e)?n.kieAiApiKey:o.kieAiApiKey||n.kieAiApiKey||""}function En(){if(!be("openrouter"))return"";const e=B(),t=w.find(s=>s.userId===z),n=G(e),o=G(t);return ve(e)?n.openrouterKey:o.openrouterKey||n.openrouterKey||""}function Cn(){if(!be("ollama"))return"";const e=B(),t=w.find(s=>s.userId===z),n=G(e),o=G(t);return ve(e)?n.ollamaBaseUrl:o.ollamaBaseUrl||n.ollamaBaseUrl||""}function ks({openrouter:e,ollamaBaseUrl:t,kieAiApiKey:n,providerEnabled:o}={}){const s=w.find(r=>r.userId===z);if(s){if((!s.apiSettings||typeof s.apiSettings!="object")&&(s.apiSettings={}),e!==void 0&&(s.apiSettings.openrouterKey=he(e)),t!==void 0&&(s.apiSettings.ollamaBaseUrl=bt(t)),n!==void 0&&(s.apiSettings.kieAiApiKey=he(n)),o!==void 0){const r=ye({...ye(s.apiSettings.providerEnabled),...typeof o=="object"?o:{}});s.apiSettings.providerEnabled=r}We(s),Y()}}function ws({openrouterKey:e,ollamaBaseUrl:t,kieAiApiKey:n,providerEnabled:o}={}){const s=B();if(s){if((!s.apiSettings||typeof s.apiSettings!="object")&&(s.apiSettings={}),e!==void 0&&(s.apiSettings.openrouterKey=he(e)),t!==void 0&&(s.apiSettings.ollamaBaseUrl=bt(t)),n!==void 0&&(s.apiSettings.kieAiApiKey=he(n)),o!==void 0){const r=ye({...ye(s.apiSettings.providerEnabled),...typeof o=="object"?o:{}});s.apiSettings.providerEnabled=r}We(s),Me(s)}}function In(){return se}function kn(e){se=e,localStorage.setItem(yn,JSON.stringify(se))}function xs(){return B()?.modelPresets||{}}function As(e){const t=B();t&&(t.modelPresets=e,Y())}function le(){const e=localStorage.getItem(yt);return e?JSON.parse(e):{balanceUSD:10,usedUSD:0,markupRate:2.5}}function Ms(e){const t=le();t.balanceUSD=parseFloat(e.balanceUSD)||0,t.markupRate=parseFloat(e.markupRate)||1,localStorage.setItem(yt,JSON.stringify(t))}function wn(e){if(typeof e!="number"||e<=0)return;const t=le();t.usedUSD+=e,localStorage.setItem(yt,JSON.stringify(t))}function Ts(e,t){const n=Ae(e);if(!n)return;n.plan==="free"&&(n.plan="pro",n.planStatus="active",n.logs.push({timestamp:Date.now(),action:`Upgraded to Pro plan via first refill of $${t.toFixed(2)}.`}),console.log(`User ${e} automatically upgraded to Pro.`));const o=le(),s=t*o.markupRate*1e6;n.credits.current+=s,n.credits.totalRefilledUSD+=t;const r=vt(n.credits.current);if(n.logs.push({timestamp:Date.now(),event:"Refill",details:"Credit Refill",amountUSD:t,balanceAfterUSD:r}),n.plan==="master"){console.warn(`Attempted to refill credits for a Master plan user (${e}). Operation blocked.`);return}n.plan==="pro"&&n.planStatus!=="active"&&(n.planStatus="active",n.logs.push({timestamp:Date.now(),action:"Account status reactivated."})),Me(n)}function Me(e){const t=w.findIndex(n=>n.userId===e.userId);t!==-1&&(w[t]=e,Y())}function Ls(e){const t=Ae(e);if(!t||t.plan!=="master")return;const n=720*60*60*1e3,o=Date.now(),s=t.subscriptionEndDate&&t.subscriptionEndDate>o?t.subscriptionEndDate:o;t.subscriptionEndDate=s+n,t.logs.push({timestamp:o,action:"Subscription extended by 30 days."}),Me(t)}function xn(){const e=`u${Math.floor(Math.random()*900)+100}`;return w.some(t=>t.userId===e)?xn():e}function Ns(e,t){if(!e||!t)return console.error("Username and email are required."),null;const n=xn(),o=we(n,e,t,"free",5e4);return w.push(o),Y(),o}function Ps(e,t){const n=Ae(e);if(!n)return;if(n.userId===z&&t!=="master"){console.warn("Blocked plan change for master profile.");return}const o=n.plan;o!==t&&(n.plan=t,n.planStatus="active",n.gracePeriodStartDate=null,n.logs.push({timestamp:Date.now(),action:`Plan changed from ${o} to ${t}.`}),Y())}function _s(){return w.filter(e=>e.plan==="pro"||e.plan==="free").reduce((e,t)=>e+(t.credits?.current||0),0)}function An(e,t){const n=Ae(e);n&&(Array.isArray(n.activityLog)||(n.activityLog=[]),n.activityLog.push(t),Me(n))}function $s(){const e=le(),t=w.filter(a=>a.plan!=="master"),n=t.reduce((a,i)=>a+(i.credits.totalRefilledUSD||0),0),o=e.usedUSD||0,s=t.reduce((a,i)=>a+(i.credits.tokenUsage?.prompt||0)+(i.credits.tokenUsage?.completion||0),0),r=t.reduce((a,i)=>a+(i.activityLog?.length||0),0);return{grossRevenue:n,totalCosts:o,netProfit:n-o,activeUsers:t.length,totalApiCalls:r,totalTokensProcessed:s}}function Bs(){return w.filter(e=>e.plan!=="master").map(e=>{const t=e.credits.totalRefilledUSD||0,n=e.credits.totalUsedUSD||0;return{userName:e.userName,userId:e.userId,plan:e.plan,totalRefilledUSD:t,totalUsageUSD:n,netValue:t-n}})}const oa=Object.freeze(Object.defineProperty({__proto__:null,ADMIN_USER_ID:z,addNewUser:Ns,burnCreditsForUsage:Et,changeUserPlan:Ps,convertCreditsToUSD:vt,downgradeToGracePeriod:vn,extendMasterSubscription:Ls,getAllUsers:ys,getAllowedModelsForCurrentUser:Re,getApiKey:En,getCurrentUserProfile:B,getFinancialSummary:$s,getKieAiApiKey:Is,getMasterModelPresets:In,getOllamaUrl:Cn,getPerUserFinancials:Bs,getSystemApiSettings:ie,getSystemBillingInfo:le,getTotalCreditsIssued:_s,getUserById:Ae,getUserModelPresets:xs,getUserSettings:Ss,initUserSettings:vs,isApiProviderEnabled:be,isMasterProfile:ve,logSystemApiCost:wn,logUserActivity:An,refillCredits:Ts,reloadDatabaseFromStorage:gs,saveFullUserProfile:Me,saveMasterModelPresets:kn,saveSystemApiSettings:ks,saveSystemBillingInfo:Ms,saveUserModelPresets:As,setActiveUserId:hs,updateApiSettings:ws,updateUser:bs},Symbol.toStringTag,{value:"Module"})),Dt="session_only",Mn="folder_aware",Ds="manual",Fs="modified-desc",Os="modified-asc",Us="created-desc",Rs="created-asc",Ws="name-asc",qs="name-desc",sa=Mn,je={scopeSource:"session",scopeMode:"all",selectedFileIds:[],retrievalTopK:6,maxContextTokens:1800},Ge={autoRetrieve:!0,scopeMode:"all",selectedFileIds:[],retrievalTopK:6,maxContextTokens:1800},Je={autoSharedContext:!0,sharedContextBudgetTokens:900,maxSharedSessions:4},Se=(e,t,n,o)=>{const s=Number(e);return Number.isFinite(s)?Math.min(n,Math.max(t,Math.round(s))):o},Tn=e=>Array.isArray(e)?[...new Set(e.filter(Boolean))]:[],Ft=(e,t)=>Number.isFinite(e)?e:t;function Ln(e){return e===Dt?Dt:Mn}function Nn(e={},t={}){const n={...je,...t||{},...e||{}};return{scopeSource:(n.scopeSource||n.scopeOwner||"session")==="folder"?"folder":"session",scopeMode:n.scopeMode==="selected"?"selected":"all",selectedFileIds:Tn(n.selectedFileIds),retrievalTopK:Se(n.retrievalTopK,1,12,je.retrievalTopK),maxContextTokens:Se(n.maxContextTokens,200,1e4,je.maxContextTokens)}}function Pn(e={}){const t={...Ge,...e||{}};return{autoRetrieve:t.autoRetrieve!==!1,scopeMode:t.scopeMode==="selected"?"selected":"all",selectedFileIds:Tn(t.selectedFileIds),retrievalTopK:Se(t.retrievalTopK,1,12,Ge.retrievalTopK),maxContextTokens:Se(t.maxContextTokens,200,1e4,Ge.maxContextTokens)}}function _n(e={}){const t={...Je,...e||{}};return{autoSharedContext:t.autoSharedContext!==!1,sharedContextBudgetTokens:Se(t.sharedContextBudgetTokens,200,6e3,Je.sharedContextBudgetTokens),maxSharedSessions:Se(t.maxSharedSessions,1,12,Je.maxSharedSessions)}}function zs(e){const t=String(e||"").trim().toLowerCase();switch(t){case Fs:case Os:case Us:case Rs:case Ws:case qs:return t;default:return Ds}}function Ks(){return`fld_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function ra(e=[],t="New Folder"){const n=String(t||"").trim()||"New Folder",o=new Set((e||[]).map(a=>String(a?.name||"").trim().toLowerCase()).filter(Boolean));if(!o.has(n.toLowerCase()))return n;let s=2,r=`${n} ${s}`;for(;o.has(r.toLowerCase());)s+=1,r=`${n} ${s}`;return r}function Hs(e={}){const t=Date.now(),n=String(e?.name||"").trim()||"Folder";return{id:String(e?.id||"").trim()||Ks(),name:n,color:typeof e?.color=="string"?e.color:"",createdAt:Ft(e?.createdAt,t),updatedAt:Ft(e?.updatedAt,t),collapsed:!!e?.collapsed,sessionSortMode:zs(e?.sessionSortMode),ragSettings:Pn(e?.ragSettings),contextPolicy:_n(e?.contextPolicy)}}function js(e){if(!e||typeof e!="object")return;Array.isArray(e.chatFolders)||(e.chatFolders=[]),Array.isArray(e.folderMemoryCards)||(e.folderMemoryCards=[]),Array.isArray(e.chatSessions)||(e.chatSessions=[]),e.chatFolders=e.chatFolders.map(n=>Hs(n)),Gs(e);const t=new Set(e.chatFolders.map(n=>n.id));(!e.activeFolderId||!t.has(e.activeFolderId))&&(e.activeFolderId=null)}function Gs(e){if(!e||!Array.isArray(e.chatSessions))return;const t=new Set((e.chatFolders||[]).map(n=>n.id));e.chatSessions=e.chatSessions.map((n,o)=>{const s={...n};s.pinned===void 0?s.pinned=!!s.isPinned:s.pinned=!!s.pinned;const r=!!s.folderId&&t.has(s.folderId);s.folderId=r?s.folderId:null,s.contextMode=Ln(s.contextMode),s.ragSettings=Nn(s.ragSettings);const a=Number(s.sortIndex);return s.sortIndex=Number.isFinite(a)?Math.round(a):o,!s.folderId&&s.ragSettings.scopeSource==="folder"&&(s.ragSettings.scopeSource="session"),s})}function $n(e,t){return!e||!t?null:(e.chatFolders||[]).find(n=>n.id===t)||null}const Bn=8,Js={entity:"Entities",place:"Places",rule:"Rules",event:"Timeline Events",relationship:"Relationships",note:"Notes",source:"Sources"},Ys=["rule","entity","place","event","relationship","note","source"];function qe(e,t=320){if(e==null)return"";let n="";if(typeof e=="string")n=e;else if(typeof e=="number"||typeof e=="boolean")n=String(e);else try{n=JSON.stringify(e)}catch{n=String(e)}return n=n.replace(/\s+/g," ").trim(),n?n.length<=t?n:`${n.slice(0,t)}...`:""}function Vs(e=""){return[...new Set(String(e||"").toLowerCase().split(/[^a-z0-9_\u0E00-\u0E7F]+/i).map(t=>t.trim()).filter(t=>t.length>=2))]}function Qs(e){return[e?.title,e?.summary,...Array.isArray(e?.tags)?e.tags:[],qe(e?.content,1e3)].filter(Boolean).join(" ").toLowerCase()}function Xs(e,t){if(!e)return 0;if(!Array.isArray(t)||t.length===0){let a=1;return e.status==="canon"&&(a+=2),e.type==="rule"&&(a+=1.5),(e.type==="entity"||e.type==="place")&&(a+=1),a}const n=Qs(e);if(!n)return 0;const o=typeof e.title=="string"?e.title.toLowerCase():"",s=typeof e.summary=="string"?e.summary.toLowerCase():"";let r=0;for(const a of t)a&&(o.includes(a)&&(r+=6),s.includes(a)&&(r+=3),Array.isArray(e.tags)&&e.tags.some(i=>String(i).toLowerCase()===a)&&(r+=4),n.includes(a)&&(r+=1.2));return e.status==="canon"&&(r+=1.5),e.type==="event"&&(r+=.4),r}function Zs(e,t){const n=(t?._score||0)-(e?._score||0);return n!==0?n:(t?.updatedAt||0)-(e?.updatedAt||0)}function Ot(e,t){return!e||!t?null:(e.books||[]).find(n=>n.id===t)||null}function er(e,t){return!e||!t?null:(e.worlds||[]).find(n=>n.id===t)||null}function tr(e,t){if(!e)return null;const n=Ot(e,t?.bookId);return n||Ot(e,e.activeBookId)}function nr(e,t){const n=tr(e,t),o=n?.linkedWorldId||e?.activeWorldId||null,s=er(e,o)||null;return{book:n,world:s}}function or(e){const t=e?.writingMode===X?X:ut,n=Number.isFinite(e?.revealScope?.asOfChapter)?Math.round(e.revealScope.asOfChapter):Number.isFinite(e?.chapterNumber)?Math.round(e.chapterNumber):null;return{mode:t,asOfChapter:n}}function sr(e){if(!Array.isArray(e)||e.length===0)return null;const t=new Set(e.map(n=>String(n||"").trim()).filter(Boolean));return t.size?t:null}function rr(e,t,n={}){Xt(e),Zt(e);const{world:o,book:s}=nr(e,t),r=or(t);if(!o)return{world:null,book:s,access:r,visibleItems:[],hiddenItemCount:0,totalItemCount:0,reason:"no_world"};const a=sr(n.types),i=Array.isArray(o.items)?o.items:[];let l=0;const c=i.filter(m=>{if(a&&!a.has(m.type))return!1;const f=Mo(m,r);return f||(l+=1),f});return{world:o,book:s,access:r,visibleItems:c,hiddenItemCount:l,totalItemCount:i.length,reason:c.length?"ok":"no_visible_items"}}function ar(e,t,n={}){const o=Number.isFinite(n.maxItems)?Math.max(1,Math.round(n.maxItems)):Bn,s=Vs(t),r=(Array.isArray(e)?e:[]).map(a=>({...a,_score:Xs(a,s)})).filter(a=>a._score>0).sort(Zs).slice(0,o);return{items:r.map(({_score:a,...i})=>i),scoredItems:r,queryTokens:s}}function Dn(e){const t=new Map;for(const n of e||[]){const o=n?.type||"note";t.has(o)||t.set(o,[]),t.get(o).push(n)}return t}function Fn(e,t,n,o){const s=[];return n?.name&&s.push(`Book: ${n.name}`),o?.name&&s.push(`World: ${o.name}`),e?.actNumber&&s.push(`Act ${e.actNumber}`),e?.chapterNumber&&s.push(`Chapter ${e.chapterNumber}`),e?.chapterTitle&&s.push(`Chapter Title: ${e.chapterTitle}`),t?.asOfChapter&&s.push(`Reveal Scope (as-of chapter): ${t.asOfChapter}`),s.push(`Mode: ${t?.mode===X?"author":"writing"}`),s}function On(e){const t=e?.constraints;if(!t||typeof t!="object")return[];const n=[];for(const[o,s]of Object.entries(t)){const r=qe(s,280);r&&n.push(`${o}: ${r}`)}return n}function ir(e){const t=e?.title||"Untitled",n=qe(e?.summary||e?.content,220),o=Array.isArray(e?.tags)&&e.tags.length?` [tags: ${e.tags.slice(0,5).join(", ")}]`:"";return n?`- ${t}: ${n}${o}`:`- ${t}${o}`}function lr({session:e,book:t,world:n,access:o,selectedItems:s,diagnostics:r}){if(!n)return"";const a=[];a.push("World Context Pack (Structured, spoiler-safe):"),a.push("Use this as canonical context for consistency. Do not invent facts that contradict it.");const i=Fn(e,o,t,n);i.length>0&&(a.push(""),a.push("Session Context:"),i.forEach(m=>a.push(`- ${m}`)));const l=On(t);l.length>0&&(a.push(""),a.push("Book Constraints:"),l.forEach(m=>a.push(`- ${m}`)));const c=Dn(s);for(const m of Ys){const f=c.get(m);!f||f.length===0||(a.push(""),a.push(`${Js[m]||m}:`),f.forEach(d=>a.push(ir(d))))}return(s||[]).length===0&&(a.push(""),a.push("Relevant Canon Facts:"),a.push("- No visible world items matched the current query/scope.")),Number.isFinite(r?.hiddenItemCount)&&r.hiddenItemCount>0&&(a.push(""),a.push(`Spoiler Guard: ${r.hiddenItemCount} gated item(s) were excluded for this chapter scope.`)),a.join(`
`)}function Ut(e){return{id:e.id,type:e.type,title:e.title,summary:qe(e.summary||e.content,300),status:e.status,visibility:e.visibility,tags:Array.isArray(e.tags)?[...e.tags]:[],sourceRefs:Array.isArray(e.sourceRefs)?[...e.sourceRefs]:[]}}function cr(e,t,n={}){Xt(e),Zt(e);const o=String(n.queryText||"").trim(),s=Number.isFinite(n.maxItems)?Math.max(1,Math.round(n.maxItems)):Bn,r=Array.isArray(n.types)?n.types:null,a=rr(e,t,{types:r});if(!a.world)return{version:1,kind:"world_context_pack",enabled:!1,reason:a.reason||"no_world",diagnostics:{worldLinked:!1,queryText:o,queryTokens:[],maxItems:s},sections:{sessionContext:[],bookConstraints:[],byType:{}},selectedItems:[],contextText:""};const i=ar(a.visibleItems,o,{maxItems:s}),l=i.items,c=Dn(l),m={};for(const[S,v]of c.entries())m[S]=v.map(Ut);const f=a.access,d=a.book,b=a.world,g=Fn(t,f,d,b),h=On(d),p={worldLinked:!0,worldId:b.id,worldName:b.name,bookId:d?.id||null,bookName:d?.name||null,mode:f.mode,asOfChapter:f.asOfChapter,totalItemCount:a.totalItemCount,visibleItemCount:a.visibleItems.length,hiddenItemCount:a.hiddenItemCount,selectedItemCount:l.length,queryText:o,queryTokens:i.queryTokens,maxItems:s},y=lr({session:t,book:d,world:b,access:f,selectedItems:l,diagnostics:p});return{version:1,kind:"world_context_pack",enabled:!0,reason:"ok",world:{id:b.id,name:b.name},book:d?{id:d.id,name:d.name}:null,access:{mode:f.mode,asOfChapter:f.asOfChapter},diagnostics:p,sections:{sessionContext:g,bookConstraints:h,byType:m},selectedItems:l.map(Ut),contextText:y}}const dr={"perplexity/sonar-small-online":{penalties:!1,seed:!1,top_k:!1,tools:!1},"perplexity/sonar-medium-online":{penalties:!1,seed:!1,top_k:!1,tools:!1},"xai/grok-1.5":{penalties:!1,seed:!1}},ur=7e3,Ye=2,mr=9e4,pr=8e3;let Rt="",Wt=0,_e=null,$e=null;function qt(e){return new Promise(t=>setTimeout(t,e))}function Un(e,t="Warning"){const n=String(e||"").trim();if(!n)return;const o=Date.now(),s=`${t}:${n}`;s===Rt&&o-Wt<ur||(Rt=s,Wt=o,R(n,t))}function fr(e){return e===408||e===409||e===425||e===429||e>=500}function ct(e){if(!e)return!1;if(e.name==="AbortError")return!0;const t=String(e.message||"");return/timed?\s*out/i.test(t)||/network/i.test(t)||/failed to fetch/i.test(t)||/load failed/i.test(t)||/not allowed to request resource/i.test(t)||/fetch api cannot load/i.test(t)}function gr(e=""){try{const t=new URL(e);return["localhost","127.0.0.1","::1"].includes(t.hostname)}catch{return!1}}function hr(){return typeof window>"u"||!window.location?!1:["localhost","127.0.0.1","::1"].includes(window.location.hostname)}function yr(e){let t=2166136261;for(let n=0;n<e.length;n+=1)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return t>>>0}function br(e=""){return e.toLowerCase().match(/[\p{L}\p{N}_-]{2,}/gu)||[]}function dt(e,t=128){const n=Array.from({length:t},()=>0),o=br(e);if(o.length===0)return n;for(const r of o){const a=yr(r)%t;n[a]+=1}const s=Math.sqrt(n.reduce((r,a)=>r+a*a,0));return s?n.map(r=>r/s):n}function Rn(e=[],t=[]){if(!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length||e.length===0)return 0;let n=0,o=0,s=0;for(let r=0;r<e.length;r+=1){const a=Number(e[r])||0,i=Number(t[r])||0;n+=a*i,o+=a*a,s+=i*i}return!o||!s?0:n/(Math.sqrt(o)*Math.sqrt(s))}function Wn(e){return typeof e=="string"?e.trim():Array.isArray(e)?e.filter(t=>t?.type==="text"&&t.text).map(t=>t.text).join(`
`).trim():""}function qn(e=[]){for(let t=e.length-1;t>=0;t-=1){const n=e[t];if(!n||n.isLoading||n.isSummary||n.isSummaryMarker||n.role!=="user"&&n.role!=="assistant")continue;const o=Wn(n.content);if(o&&o.length>=4)return o}return""}function Sr(e,t){const n=Nn(t?.ragSettings,{scopeSource:t?.folderId?"folder":"session"}),o=t?.folderId?$n(e,t.folderId):null;return n.scopeSource==="folder"&&o?{...Pn(o.ragSettings),scopeSource:"folder",folderId:o.id,folderName:o.name}:{...n,scopeSource:"session"}}function vr(e){const t=(e?.history||[]).filter(o=>o&&!o.isLoading&&!o.isSummary&&!o.isSummaryMarker&&(o.role==="user"||o.role==="assistant")).slice(-4);if(t.length===0)return"";const n=t.map(o=>{const s=Wn(o.content);return s?`${o.role==="assistant"?o.speaker||"Assistant":"User"}: ${s}`:""}).filter(Boolean);return n.length===0?"":n.join(`
`).slice(0,1400)}function Er(e,t){const n=t?.summaryState?.activeSummaryId;if(n){const s=(e.summaryLogs||[]).find(r=>r.id===n);if(s?.content?.trim())return{source:"summary",text:s.content.trim().slice(0,2200)}}const o=vr(t);return o?{source:"recent_turns",text:o}:null}function Cr(e,t){const n=Ln(t?.contextMode),o={enabled:!1,autoEnabled:!1,mode:n,folderId:t?.folderId||null,folderName:"",maxSharedSessions:0,budgetTokens:0,usedTokens:0,candidateCount:0,usedSessionCount:0,usedSessions:[],contextText:"",reason:"disabled"};if(!t)return{...o,reason:"no_active_session"};if(n==="session_only")return{...o,reason:"session_only"};if(!t.folderId)return{...o,reason:"no_folder"};const s=$n(e,t.folderId);if(!s)return{...o,reason:"missing_folder"};const r=_n(s.contextPolicy);if(r.autoSharedContext===!1)return{...o,mode:n,folderId:s.id,folderName:s.name,maxSharedSessions:r.maxSharedSessions,budgetTokens:r.sharedContextBudgetTokens,reason:"folder_auto_disabled"};const a=qn(t?.history||[]),i=a?dt(a,128):null,l=Math.max(140,Math.floor(r.sharedContextBudgetTokens*.45)),c=(e.chatSessions||[]).filter(g=>g&&g.id!==t.id&&!g.archived&&g.folderId===s.id).sort((g,h)=>(h.updatedAt||0)-(g.updatedAt||0));if(c.length===0)return{...o,enabled:!0,autoEnabled:!0,folderId:s.id,folderName:s.name,maxSharedSessions:r.maxSharedSessions,budgetTokens:r.sharedContextBudgetTokens,reason:"no_related_sessions"};const m=c.map(g=>{const h=Er(e,g);if(!h?.text)return null;const p=l*4,y=h.text.length>p?`${h.text.slice(0,p)}
...[trimmed to fit folder context budget]`:h.text,S=Math.max(1,j(y)),v=i?Rn(i,dt(y,i.length)):0;return{sessionId:g.id,sessionName:g.name||"Untitled",source:h.source,updatedAt:g.updatedAt||g.createdAt||0,tokenEstimate:S,relevanceScore:Number.isFinite(v)?v:0,text:y}}).filter(Boolean).sort((g,h)=>{if(i){const p=h.relevanceScore-g.relevanceScore;if(p!==0)return p}return h.updatedAt-g.updatedAt});if(m.length===0)return{...o,enabled:!0,autoEnabled:!0,folderId:s.id,folderName:s.name,maxSharedSessions:r.maxSharedSessions,budgetTokens:r.sharedContextBudgetTokens,candidateCount:c.length,reason:"no_context_snippets"};const f=[];let d=0;for(const g of m){if(f.length>=r.maxSharedSessions)break;d+g.tokenEstimate>r.sharedContextBudgetTokens||(f.push(g),d+=g.tokenEstimate)}if(f.length===0)return{...o,enabled:!0,autoEnabled:!0,folderId:s.id,folderName:s.name,maxSharedSessions:r.maxSharedSessions,budgetTokens:r.sharedContextBudgetTokens,candidateCount:m.length,reason:"budget_limited"};const b=[`Shared context from sibling sessions in folder "${s.name}".`,"Use this only when relevant to the current request."];return f.forEach((g,h)=>{b.push("");const p=i?`, relevance: ${g.relevanceScore.toFixed(3)}`:"";b.push(`[${h+1}] Session: ${g.sessionName} (source: ${g.source}${p})`),b.push(g.text)}),{enabled:!0,autoEnabled:!0,mode:n,folderId:s.id,folderName:s.name,maxSharedSessions:r.maxSharedSessions,budgetTokens:r.sharedContextBudgetTokens,usedTokens:d,candidateCount:m.length,usedSessionCount:f.length,usedSessions:f.map(g=>({sessionId:g.sessionId,sessionName:g.sessionName,source:g.source,relevanceScore:Number((g.relevanceScore||0).toFixed(3)),tokenEstimate:g.tokenEstimate,updatedAt:g.updatedAt})),contextText:b.join(`
`),reason:"ok"}}function Ir(e,t,n){const o=Sr(t,n),s=o.scopeSource==="folder"&&o.autoRetrieve===!1,r={enabled:!s,queryText:e||"",settings:o,scopeMode:o.scopeMode,totalCandidateChunks:0,totalUsedTokens:0,usedChunks:[],contextText:"",reason:"empty_query"};if(s)return{...r,reason:"folder_rag_disabled"};const a=t?.knowledgeIndex?.chunks;if(!e||!Array.isArray(a)||a.length===0)return{...r,reason:e?"no_index":"empty_query"};const i=new Set(o.selectedFileIds||[]),l=o.scopeMode==="selected"?a.filter(p=>i.has(p.fileId)):a;if(!l.length)return{...r,reason:"scope_has_no_chunks"};const c=Number.isFinite(t?.knowledgeIndex?.dimensions)?t.knowledgeIndex.dimensions:128,m=dt(e,c),f=l.filter(p=>p?.text&&Array.isArray(p.vector)).map(p=>({chunk:p,score:Rn(m,p.vector)})).filter(p=>p.score>0).sort((p,y)=>y.score-p.score).slice(0,o.retrievalTopK);if(f.length===0)return{...r,totalCandidateChunks:l.length,reason:"no_similarity_match"};const d=[];let b=0;for(const p of f){const y=p.chunk.text||"",S=Number.isFinite(p.chunk.tokenEstimate)?p.chunk.tokenEstimate:Math.max(1,Math.round(y.length/4));if(y){if(b+S>o.maxContextTokens)break;d.push(p),b+=S}}if(d.length===0)return{...r,totalCandidateChunks:l.length,reason:"budget_limited",totalUsedTokens:b};const g=["Retrieved knowledge context from uploaded project files:","Use this as supporting context when relevant."];d.forEach((p,y)=>{const S=`${p.chunk.fileName||"Unknown file"} #chunk${(p.chunk.chunkIndex||0)+1}`;g.push(""),g.push(`[${y+1}] ${S} (score: ${p.score.toFixed(3)})`),g.push(p.chunk.text)}),g.push(""),g.push("If you use this context in your answer, cite the source as [source: filename #chunkN].");const h=d.map(p=>({fileId:p.chunk.fileId||"",fileName:p.chunk.fileName||"Unknown file",chunkIndex:Number.isFinite(p.chunk.chunkIndex)?p.chunk.chunkIndex:0,score:Number(p.score.toFixed(3)),tokenEstimate:Number.isFinite(p.chunk.tokenEstimate)?p.chunk.tokenEstimate:Math.max(1,Math.round((p.chunk.text||"").length/4)),charCount:Number.isFinite(p.chunk.charCount)?p.chunk.charCount:(p.chunk.text||"").length,excerpt:(p.chunk.text||"").slice(0,280)}));return{enabled:!0,queryText:e,settings:o,scopeMode:o.scopeMode,totalCandidateChunks:l.length,totalUsedTokens:b,usedChunks:h,contextText:g.join(`
`),reason:"ok"}}function Ve(e,t){if(!e||!e.id)return!1;const n=e.id,o=dr[n];if(o&&o[t]!==void 0)return o[t];switch(t){case"penalties":case"seed":return!n.startsWith("xai/")&&!n.startsWith("perplexity/");case"tools":return!n.startsWith("perplexity/")&&e.supports_tools;default:return!0}}async function zn(e){const t=typeof e=="string"?e.trim().replace(/^Bearer\s+/i,"").trim():"";if(!t)return[];const n={Authorization:`Bearer ${t}`,Accept:"application/json"};let o=null;for(let s=0;s<=Ye;s+=1)try{const r=await Te("https://openrouter.ai/api/v1/models",{headers:n},mr);if(!r.ok){const l=await Le(r),c=l?` Details: ${l.slice(0,240)}`:"";if(fr(r.status)&&s<Ye){await qt(450*(s+1));continue}throw r.status===401?new Error(`OpenRouter returned 401 Unauthorized. Check API key format in Settings.${c}`):new Error(`Could not fetch models from OpenRouter (HTTP ${r.status}).${c}`)}const a=await r.json();return(Array.isArray(a?.data)?a.data:[]).map(l=>({id:l.id,name:l.name||l.id,provider:"openrouter",description:l.description,context_length:l.context_length,pricing:{prompt:l.pricing?.prompt||"0",completion:l.pricing?.completion||"0"},supports_tools:l.architecture?.tool_use===!0}))}catch(r){if(o=r,s<Ye&&ct(r)){await qt(450*(s+1));continue}break}if(o&&ct(o)){const s=o.message?` Details: ${String(o.message).slice(0,240)}`:"";throw new Error(`Could not fetch models from OpenRouter.${s}`)}throw o||new Error("Could not fetch models from OpenRouter.")}async function Kn(e){if(!e)return[];const t=typeof e=="string"?e.trim():"";if(!t)return[];const n=(/^https?:\/\//i.test(t)?t:`http://${t}`).replace(/\/+$/,"");if(!hr()&&gr(n))throw new Error("Skipped Ollama model fetch for localhost while app is hosted remotely. Run PromptPrim on localhost, or expose Ollama via HTTPS reverse proxy with CORS.");try{const o=await Te(`${n}/api/tags`,{},pr);if(!o.ok){const a=await Le(o),i=a?` Details: ${a.slice(0,240)}`:"";throw new Error(`Ollama connection failed (HTTP ${o.status}).${i}`)}const s=await o.json();return(Array.isArray(s?.models)?s.models:[]).map(a=>({id:a.name,name:a.name,provider:"ollama",supports_tools:!1}))}catch(o){throw ct(o)?new Error(`Could not connect to Ollama at ${n}/api/tags. Check that Ollama is running and OLLAMA_ORIGINS allows this app origin.`):o}}async function Te(e,t={},n=12e4){const o=new AbortController,s=setTimeout(()=>o.abort(),n),r=t.signal;let a=o.signal;r&&(typeof AbortSignal<"u"&&typeof AbortSignal.any=="function"?a=AbortSignal.any([r,o.signal]):r.aborted?o.abort(r.reason):typeof r.addEventListener=="function"&&r.addEventListener("abort",()=>o.abort(r.reason),{once:!0}));try{return await fetch(e,{...t,signal:a})}finally{clearTimeout(s)}}async function Le(e){try{return(await e.text()).trim()}catch{return""}}function Ct(e,t,n="",o=""){const s=o.replace(/\s+/g," ").trim().slice(0,240),r=s?` Details: ${s}`:"";if(t===401)return e==="openrouter"?`API Error: 401 Unauthorized from OpenRouter. Check API key in Settings and remove any leading 'Bearer '.${r}`:e==="ollama"?`API Error: 401 Unauthorized from Ollama endpoint. Check Ollama URL and reverse-proxy auth configuration.${r}`:`API Error: 401 Unauthorized.${r}`;const a=n?` ${n}`:"";return`API Error: ${t}${a}${r}`}function zt(e){if(typeof e!="string")return"";const t=e.trim();return t?t.replace(/^Bearer\s+/i,"").trim():""}function Kt(e){if(typeof e!="string")return"";let t=e.trim();return t?(/^https?:\/\//i.test(t)||(t=`http://${t}`),t.replace(/\/+$/,"")):""}function kr({apiKey:e,ollamaBaseUrl:t,isUserKey:n=!1}={}){const o=e!==void 0,s=t!==void 0;if(n){const i=B(),l=i?.apiSettings&&typeof i.apiSettings=="object"?i.apiSettings:{},c=l.providerEnabled||{};return{apiKey:zt(String(o?e||"":l.openrouterKey||"")),ollamaBaseUrl:Kt(String(s?t||"":l.ollamaBaseUrl||"")),providerEnabled:{openrouter:c.openrouter!==!1,ollama:c.ollama!==!1}}}const r=ie(),a=r.providerEnabled||{};return{apiKey:zt(String(o?e||"":r.openrouterKey||"")),ollamaBaseUrl:Kt(String(s?t||"":r.ollamaBaseUrl||"")),providerEnabled:{openrouter:a.openrouter!==!1,ollama:a.ollama!==!1}}}async function aa({apiKey:e,ollamaBaseUrl:t,isUserKey:n=!1}={}){const o=n?_e:$e;if(o)return o;const s=(async()=>{u.bus.publish("status:update",{message:"Loading models...",state:"loading"});const r=kr({apiKey:e,ollamaBaseUrl:t,isUserKey:n});let a=[],i=0,l=0;const c=[];if(r.providerEnabled.openrouter&&r.apiKey){i+=1;try{const d=await zn(r.apiKey);a.push(...d),l+=1}catch(d){console.error("Failed to fetch OpenRouter models:",d),c.push(`OpenRouter: ${d.message||"Unknown error"}`)}}if(r.providerEnabled.ollama&&r.ollamaBaseUrl){i+=1;try{const d=await Kn(r.ollamaBaseUrl);a.push(...d),l+=1}catch(d){console.error("Failed to fetch Ollama models:",d),c.push(`Ollama: ${d.message||"Unknown error"}`)}}c.length>0&&Un(c.join(`

`),"Warning");const m=n?u.getState().userProviderModels||[]:u.getState().systemProviderModels||[];if(l>0||i===0?n?u.setUserModels(a):u.setSystemModels(a):Array.isArray(m)||(n?u.setUserModels([]):u.setSystemModels([])),i===0){u.bus.publish("status:update",{message:"No enabled model providers configured",state:"connected"});return}if(l===0){u.bus.publish("status:update",{message:`Model load failed for ${i} provider(s). Keeping previous model list.`,state:"error"});return}u.bus.publish("status:update",{message:`Models loaded (${a.length})`,state:"connected"})})();return n?(_e=s.finally(()=>{_e=null}),_e):($e=s.finally(()=>{$e=null}),$e)}async function ia(){u.bus.publish("status:update",{message:"Loading all system models...",state:"loading"});const e=ie(),t=e.providerEnabled||{};let n=[],o=0,s=0;const r=[];if(t.openrouter!==!1&&e.openrouterKey){o+=1;try{const a=await zn(e.openrouterKey);n.push(...a),s+=1}catch(a){console.error("Failed to fetch OpenRouter models:",a),r.push(`OpenRouter: ${a.message||"Could not fetch models from OpenRouter. Check key and connection."}`)}}if(t.ollama!==!1&&e.ollamaBaseUrl){o+=1;try{const a=await Kn(e.ollamaBaseUrl);n.push(...a),s+=1}catch(a){console.error("Failed to fetch Ollama models:",a),r.push(`Ollama: ${a.message||"Could not fetch models from Ollama."}`)}}r.length>0&&Un(r.join(`

`),"Warning"),(s>0||o===0)&&u.setSystemModels(n),console.log(`Loaded a total of ${n.length} system models.`),o>0&&s===0?u.bus.publish("status:update",{message:"Failed to load system models. Keeping previous list.",state:"error"}):u.bus.publish("status:update",{message:"Models loaded",state:"connected"})}function Hn(e){const t=u.getProject();if(!t)return"";let n;const o=e;if(o)n=t.agentPresets?.[o];else{const i=t.activeEntity;if(i?.type==="agent")n=t.agentPresets?.[i.name];else if(i?.type==="group"){const l=t.agentGroups?.[i.name];n=t.agentPresets?.[l?.moderatorAgent]}}if(!n)return"";let s=n.systemPrompt||"";const r=n.activeMemories||[];if(r.length===0)return s.trim();const a=r.map(i=>t.memories.find(l=>l.name===i)?.content).filter(Boolean).join(`

`);return a?`${s.trim()}

--- Active Memories ---
${a}`:s.trim()}function It(e,t,n=null){const o=u.getProject();if(!o)return[];js(o);const s=o.agentPresets[t];if(!s)return[];const r=[],a=Hn(t);a&&r.push({role:"system",content:a});const i=typeof n?.surfaceSystemPromptOverride=="string"?n.surfaceSystemPromptOverride.trim():"";i&&r.push({role:"system",content:i});const l=o.chatSessions.find(y=>y.id===o.activeSessionId),c=l?.summaryState?.activeSummaryId;let m=0;if(c){const y=o.summaryLogs?.find(S=>S.id===c);if(y){const S=`This is a summary of the conversation so far. Use this for context:

---
${y.content}
---`;r.push({role:"system",content:S}),m=l.summaryState.summarizedUntilIndex||0}}const f=e.slice(m),d=Cr(o,l);n&&n.__collect===!0&&(n.folderContext=d),d?.contextText&&r.push({role:"system",content:d.contextText});const b=qn(f),g=cr(o,l,{queryText:b});n&&n.__collect===!0&&(n.worldContext=g),g?.enabled&&g?.contextText&&r.push({role:"system",content:g.contextText});const h=Ir(b,o,l);n&&n.__collect===!0&&(n.rag=h),h?.contextText&&r.push({role:"system",content:h.contextText});const p=f.filter(y=>y.role==="assistant"&&y.content&&!y.isLoading).length;return f.forEach((y,S)=>{if(y.isLoading||!y.content||y.isSummary||y.isSummaryMarker)return;let v=y.content;Array.isArray(v)&&([...u.getState().systemProviderModels||[],...u.getState().userProviderModels||[]].find(P=>P.id===s.model)?.provider==="openrouter"?v=v.map(P=>P.type==="image_url"?{type:"image_url",image_url:{url:P.url}}:P):v=v.filter(P=>P.type==="text"&&P.text).map(P=>P.text).join(`
`));const I={role:y.role,content:v},x=S===f.length-1;p>0&&y.role==="assistant"&&x?I.role="user":y.role==="assistant"&&y.speaker&&(I.name=y.speaker.replace(/[^a-zA-Z0-9_-]/g,"_")),r.push(I)}),r}function kt(e,t,n=!1,o=!1){const r=u.getProject()?.globalSettings?.systemUtilityAgent,a=!!(r&&e===r),i=!!(r&&e&&typeof e=="object"&&e.name&&e.model&&e.name===r.name&&e.model===r.model),l=!!(o||a||i),m=(l?u.getState().systemProviderModels||[]:Re()).find(I=>I.id===e.model);if(!m){const I=l?"it might be missing from the system's model list":"it's not allowed in your current plan";throw new Error(`Model '${e.model}' not found or not allowed because ${I}.`)}const f=m.provider||(String(e.model||"").includes("/")?"openrouter":"ollama");let d,b,g;const h={},p=parseFloat(e.temperature);isNaN(p)||(h.temperature=p);const y=parseFloat(e.topP);isNaN(y)||(h.top_p=y);const S=parseInt(e.max_tokens,10);if(!isNaN(S)&&S>0&&(h.max_tokens=S),Ve(m,"top_k")){const I=parseInt(e.topK,10);!isNaN(I)&&I>0&&(h.top_k=I)}if(Ve(m,"penalties")){const I=parseFloat(e.presence_penalty);isNaN(I)||(h.presence_penalty=I);const x=parseFloat(e.frequency_penalty);isNaN(x)||(h.frequency_penalty=x)}if(Ve(m,"seed")){const I=parseInt(e.seed,10);!isNaN(I)&&I!==-1&&(h.seed=I)}const v=e.stop_sequences?e.stop_sequences.split(",").map(I=>I.trim()).filter(Boolean):[];if(v.length>0&&(h.stop=v),f==="openrouter"){if(!be("openrouter",{useSystemSettings:l}))throw new Error("OpenRouter API is disabled in Settings for this scope.");const I=l?ie().openrouterKey:En();if(!I)throw new Error("Required OpenRouter API Key is missing for this operation.");d="https://openrouter.ai/api/v1/chat/completions",b={Authorization:`Bearer ${I}`,"Content-Type":"application/json",Accept:"application/json","HTTP-Referer":"https://sarega.github.io/PromptPrim/","X-Title":"PromptPrim"},g={model:e.model,messages:t,stream:n,...h},e.enableWebSearch&&(e.model.startsWith("perplexity/")||(g.plugins=[{id:"web",max_results:5}]))}else if(f==="ollama"){if(!be("ollama",{useSystemSettings:l}))throw new Error("Ollama API is disabled in Settings for this scope.");const I=l?ie().ollamaBaseUrl:Cn();if(!I)throw new Error("Required Ollama Base URL is missing for this operation.");d=`${I}/api/chat`,b={"Content-Type":"application/json"},g={model:e.model,messages:t,stream:n,options:h}}else throw new Error(`Unsupported model provider '${f}' for model '${e.model}'.`);return{url:d,headers:b,body:g,provider:f}}async function jn(e,t,n){const{url:o,headers:s,body:r,provider:a}=kt(e,t,!0,!1);try{u.bus.publish("status:update",{message:`Responding with ${e.model}...`,state:"loading"});const i=performance.now(),l=await Te(o,{method:"POST",headers:s,body:JSON.stringify(r),signal:u.getState().abortController?.signal});if(!l.ok){const S=await Le(l);throw new Error(Ct(a,l.status,l.statusText,S))}const c=l.body.getReader(),m=new TextDecoder("utf-8");let f="",d="";for(;;){const{value:S,done:v}=await c.read();if(v)break;f+=m.decode(S,{stream:!0});const I=f.split(`
`);f=I.pop();for(const x of I){if(x.trim()===""||x.startsWith(":"))continue;let A="";try{if(a==="openrouter"){if(x.startsWith("data: ")){const L=x.replace(/^data: /,"").trim();if(L==="[DONE]")continue;A=JSON.parse(L).choices?.[0]?.delta?.content||""}}else A=JSON.parse(x).message?.content||""}catch{console.warn("Skipping malformed JSON chunk:",x)}A&&(d+=A,n(A))}}if(f.trim()){let S="";try{if(a==="openrouter"){if(f.startsWith("data: ")){const v=f.replace(/^data: /,"").trim();v!=="[DONE]"&&(S=JSON.parse(v).choices?.[0]?.delta?.content||"")}}else S=JSON.parse(f).message?.content||""}catch{console.warn("Skipping malformed final JSON chunk:",f)}S&&(d+=S,n(S))}const g=(performance.now()-i)/1e3;let h={prompt_tokens:0,completion_tokens:0},p=0,y=!0;if(a==="openrouter"&&l.headers.get("x-openrouter-usage"))try{const S=JSON.parse(l.headers.get("x-openrouter-usage"));h={prompt_tokens:S.prompt_tokens||0,completion_tokens:S.completion_tokens||0},p=S.cost||0,y=!1}catch(S){console.error("Could not parse usage header:",S)}return y&&(h.prompt_tokens=j(JSON.stringify(t)),h.completion_tokens=j(d)),{content:d,usage:h,duration:g,cost:p,usageIsEstimated:y}}catch(i){throw i.name!=="AbortError"&&(console.error("Streaming failed:",i),u.bus.publish("status:update",{message:`Error: ${i.message}`,state:"error"})),i}}async function Gn(e,t,n={}){console.log("ðŸ“¡ [callLLM] received:",{agent:e,messages:t});const o=n?.forceSystemAgentCall===!0,{url:s,headers:r,body:a,provider:i}=kt(e,t,!1,o);try{const l=await Te(s,{method:"POST",headers:r,body:JSON.stringify(a)});if(!l.ok){const g=await Le(l);throw new Error(Ct(i,l.status,l.statusText,g))}const c=await l.json(),m=i==="openrouter"&&c.choices?.length>0?c.choices[0].message.content:c.message?.content;if(m===void 0)throw new Error("Invalid API response structure.");let f=0,d=c.usage||{prompt_tokens:0,completion_tokens:0},b=!0;if(i==="openrouter"&&l.headers.get("x-openrouter-usage"))try{const g=JSON.parse(l.headers.get("x-openrouter-usage"));f=g.cost||0,d.prompt_tokens=g.prompt_tokens||d.prompt_tokens,d.completion_tokens=g.completion_tokens||d.completion_tokens,b=!1}catch(g){console.error("Could not parse usage header in callLLM:",g)}return{content:m,usage:d,cost:f,usageIsEstimated:b}}catch(l){throw console.error("callLLM failed:",l),l}}function wr(e,t){const o=[...u.getState().systemProviderModels||[],...u.getState().userProviderModels||[]].find(a=>a.id===e);if(!o||!o.pricing)return console.warn(`Could not find pricing data for model: ${e}`),0;const s=(t.prompt_tokens||0)*parseFloat(o.pricing.prompt),r=(t.completion_tokens||0)*parseFloat(o.pricing.completion);return s+r}async function la(e,t){const n=ie(),o=n.openrouterKey,s=n.ollamaBaseUrl;if(!o&&!s)throw new Error("System API or Ollama URL is not configured by the admin.");const{url:r,headers:a,body:i,provider:l}=kt(e,t,!1,!0);try{const c=await Te(r,{method:"POST",headers:a,body:JSON.stringify(i)});if(!c.ok){const d=await Le(c);throw new Error(Ct(l,c.status,c.statusText,d))}const m=await c.json(),f=l==="openrouter"&&m.choices?.length>0?m.choices[0].message.content:m.message?.content;if(f===void 0)throw new Error("Invalid API response structure.");return{content:f,usage:m.usage||{}}}catch(c){throw console.error("callSystemLLM failed:",c),c}}function Qe(e){document.body.classList.remove("dark-mode","light-mode");const t=document.getElementById("hljs-light-theme"),n=document.getElementById("hljs-dark-theme");let o=e==="dark";e==="system"&&(o=window.matchMedia("(prefers-color-scheme: dark)").matches),document.body.classList.toggle("dark-mode",o),t&&(t.disabled=o),n&&(n.disabled=!o)}function ca(e){const t=document.getElementById(e);if(!t)return;const n=t.querySelectorAll('input[type="radio"]'),o=localStorage.getItem("theme")||"system";n.forEach(s=>{s.value===o&&(s.checked=!0),s.addEventListener("change",r=>{const a=r.target.value;localStorage.setItem("theme",a),Qe(a)})}),Qe(o),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{(localStorage.getItem("theme")||"system")==="system"&&Qe("system")})}export{la as $,Fs as A,Zt as B,$r as C,mt as D,sa as E,Ds as F,je as G,Oe as H,Fe as I,Pr as J,ra as K,Ks as L,Qn as M,Tr as N,Qr as O,Xr as P,aa as Q,Nr as R,Ze as S,Ss as T,Ar as U,Mr as V,Xt as W,_r as X,Lr as Y,xr as Z,xt as _,As as a,$s as a$,cr as a0,rr as a1,Zr as a2,as as a3,ve as a4,Zn as a5,Vr as a6,na as a7,Yr as a8,Jr as a9,Fr as aA,Ur as aB,gs as aC,mn as aD,ee as aE,Dr as aF,Gr as aG,jr as aH,ts as aI,pn as aJ,Kr as aK,zr as aL,Hr as aM,Wr as aN,Rr as aO,qr as aP,Jo as aQ,In as aR,kn as aS,ks as aT,ia as aU,_s as aV,Ae as aW,Ls as aX,ys as aY,Ns as aZ,Me as a_,wo as aa,X as ab,ut as ac,Mo as ad,ho as ae,Ue as af,Jt as ag,uo as ah,et as ai,go as aj,So as ak,fo as al,ko as am,po as an,De as ao,hs as ap,ca as aq,vt as ar,Ps as as,Ts as at,vs as au,ie as av,oa as aw,ta as ax,Or as ay,ea as az,u as b,Bs as b0,Re as c,Vn as d,Gn as e,Is as f,xs as g,Xn as h,B as i,js as j,ot as k,$n as l,Pn as m,_n as n,Br as o,Ln as p,Nn as q,Ao as r,R as s,zs as t,ws as u,qs as v,Ws as w,Rs as x,Us as y,Os as z};
