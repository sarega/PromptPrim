(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const re="AIChatbotDB_Project_",L="chatSessions",T="projectMetadata",he="projectInfo",B={"agent-name-input":"name","agent-icon-input":"icon","agent-model-select":"model","agent-system-prompt":"systemPrompt","agent-use-markdown":"useMarkdown","agent-temperature":"temperature","agent-topP":"topP","agent-topK":"topK","agent-presence-penalty":"presence_penalty","agent-frequency-penalty":"frequency_penalty","agent-max-tokens":"max_tokens","agent-seed":"seed","agent-stop-sequences":"stop_sequences"},be={Standard:`You are a professional summarizer. Your task is to create a dense, context-rich summary of a conversation. Include all key entities, character names, locations, critical events, and important emotional states. The summary should be detailed enough for another AI to pick up the conversation and understand all necessary context.

Here is the summary of the conversation so far:
--- PREVIOUS SUMMARY ---
\${previousSummary}
--- END PREVIOUS SUMMARY ---

Now, here are the new messages that have occurred since that summary:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide a new, single, cohesive summary that integrates the key points from the new messages into the previous one. Respond with ONLY the new, complete summary text.`,"Literary Analyst":`You are a meticulous literary analyst tasked with creating a detailed narrative digest. Your primary goal is to preserve the story's integrity, character development, and emotional nuances. Do NOT sacrifice important details for the sake of brevity.

Your digest must include:
- Plot Progression: Every significant event and the causal links between them.
- Character Arcs: Any changes in a character's state of mind, motivation, decisions, or relationships.
- Key Dialogue: Capture the essence and subtext of crucial conversations.
- Atmosphere & Setting: Mention key descriptions of the environment if they contribute to the mood or plot.
- New Elements: Note the introduction of any new characters, significant objects, or unresolved questions (foreshadowing).

Here is the narrative digest so far:
--- PREVIOUS DIGEST ---
\${previousSummary}
--- END PREVIOUS DIGEST ---

Now, here are the new scenes and dialogues that have occurred:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide a new, single, cohesive narrative digest that seamlessly integrates the key points from the new messages into the previous one. Write in a third-person, past-tense narrative style. Respond with ONLY the new, complete digest text.`,"Continuity Editor":`You are a continuity editor for a novel series. Your job is to create a 'Previously On...' document that ensures no plot points are ever lost. The output must be extremely detailed, acting as a perfect memory for another AI to continue the story without missing a single beat.

The document must retain:
- All character actions and their immediate consequences.
- The full names of any character or location mentioned.
- The specifics of any plans made or secrets revealed.
- Emotional state of each character at the end of the scene.
- Any objects that were acquired, lost, or noted as important.

The goal is maximum information retention, not summarization. Think of this as expanding upon the previous summary with new, detailed information.

Here is the continuity document so far:
--- PREVIOUS SUMMARY ---
\${previousSummary}
--- END PREVIOUS SUMMARY ---

Now, here are the new events to be added:
--- NEW MESSAGES ---
\${newMessages}
--- END NEW MESSAGES ---

Please provide the updated, complete continuity document, integrating the new events chronologically. Your response should be a single block of text containing only the updated document.`},V={model:"openai/gpt-4o-mini",systemPrompt:"You are a highly efficient assistant that processes user requests and responds in a structured JSON format when required. You are objective and precise.",summarizationPrompt:be.Standard,temperature:.2,topP:1,topK:0,presence_penalty:0,frequency_penalty:0,max_tokens:2048,seed:-1,stop_sequences:""},Ge=[{name:"Code Assistant",content:"You are an expert programmer."},{name:"Creative Writer",content:"You are a creative writing assistant."}],ve={icon:"ðŸ¤–",model:"",systemPrompt:"You are a helpful assistant.",useMarkdown:!0,temperature:1,topP:1,topK:0,presence_penalty:0,frequency_penalty:0,max_tokens:4096,seed:-1,stop_sequences:""},h={currentProject:{},allProviderModels:[],isLoading:!1,isDirtyForAutoSave:!1,abortController:null,editingAgentName:null,editingGroupName:null,stagedEntity:null,pendingFileToOpen:null,pendingActionAfterSave:null},k={events:{},subscribe(t,e){return this.events[t]=this.events[t]||[],this.events[t].push(e),()=>{this.events[t]=this.events[t].filter(n=>e!==n)}},subscribeOnce(t,e){const n=s=>{e(s),this.events[t]=this.events[t].filter(o=>o!==n)};this.subscribe(t,n)},publish(t,e){this.events[t]&&this.events[t].slice().forEach(n=>n(e))}},a={getState:()=>h,getProject:()=>h.currentProject,isLoading:()=>h.isLoading,getStagedEntity:()=>h.stagedEntity,setStagedEntity:(t,e=!0)=>{JSON.stringify(h.stagedEntity)!==JSON.stringify(t)&&(console.log("ðŸŸ  [STATE] Staged entity changing to:",t),h.stagedEntity=t,e&&a.bus.publish("entity:staged",t))},isUserDirty:()=>h.currentProject?.isDirtyForUser||!1,isAutoSaveDirty:()=>h.isDirtyForAutoSave,setState:(t,e)=>{h[t]=e},setProject:t=>{h.currentProject=t,k.publish("project:stateChanged",h.currentProject)},setLoading:t=>{h.isLoading!==t&&(h.isLoading=t,k.publish("loading:changed",t))},setUserDirty:t=>{h.currentProject&&h.currentProject.isDirtyForUser!==t&&(h.currentProject.isDirtyForUser=t,k.publish("userDirty:changed",t))},setAutoSaveDirty:t=>{h.isDirtyForAutoSave!==t&&(h.isDirtyForAutoSave=t,t&&k.publish("autosave:required"))},updateAndPersistState:()=>{a.setUserDirty(!0),a.setAutoSaveDirty(!0)},setAllModels:t=>{h.allProviderModels=t.sort((e,n)=>e.name.localeCompare(n.name)),h.currentProject&&h.currentProject.globalSettings&&(h.currentProject.globalSettings.allModels=h.allProviderModels),k.publish("models:loaded",h.allProviderModels)},newAbortController:()=>(h.abortController=new AbortController,h.abortController),abort:()=>{h.abortController&&(h.abortController.abort(),h.abortController=null)},bus:k},S={};function ze(){S.appWrapper=document.querySelector(".app-wrapper"),S.toggleRightSidebarBtn=document.getElementById("toggle-right-sidebar-btn"),S.sessionsPanel=document.querySelector(".sessions-panel"),S.hamburgerBtn=document.getElementById("hamburger-btn"),S.closeSidebarBtn=document.querySelector('.sessions-panel .mobile-only[title="Close Sidebar"]'),S.mobileOverlay=document.getElementById("mobile-overlay"),S.composerPanel=document.querySelector(".composer-panel"),S.resizerRow=document.getElementById("resizer-row")}function _e(t,e){if(!t||!e)return;let n=0,s=0;const o=c=>{c.preventDefault(),t.classList.add("active"),document.body.style.cursor="row-resize",e.classList.contains("collapsed")&&(e.classList.remove("collapsed"),t.classList.remove("collapsed"),a.bus.publish("composer:visibilityChanged")),n=c.clientY,s=e.getBoundingClientRect().height,document.addEventListener("mousemove",i),document.addEventListener("mouseup",r)},i=c=>{const l=c.clientY-n;let d=s-l;const u=parseInt(getComputedStyle(e).minHeight,10)||50;d<u&&(d=u),e.style.flexBasis=`${d}px`},r=()=>{t.classList.remove("active"),document.body.style.cursor="",document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",r)};t.addEventListener("mousedown",o)}function We(){if(!S.sessionsPanel)return;const t=e=>{e.stopPropagation(),e.preventDefault(),S.sessionsPanel.classList.remove("is-open"),S.mobileOverlay?.classList.remove("active")};S.hamburgerBtn?.addEventListener("click",e=>{window.innerWidth<=1024?(S.sessionsPanel.classList.add("is-open"),S.mobileOverlay?.classList.add("active")):S.appWrapper?.classList.toggle("sidebar-collapsed")}),S.mobileOverlay?.addEventListener("click",t,!0),S.closeSidebarBtn?.addEventListener("click",t,!0)}function Je(){ze(),S.resizerRow&&S.composerPanel&&_e(S.resizerRow,S.composerPanel),We(),Ye(),console.log("Core layout manager initialized.")}function Ye(){!S.toggleRightSidebarBtn||!S.appWrapper||S.toggleRightSidebarBtn.addEventListener("click",()=>{S.appWrapper.classList.toggle("right-sidebar-collapsed"),S.appWrapper.classList.contains("right-sidebar-collapsed")||a.bus.publish("studio:rendered")})}async function Ke(t){const e=await fetch("https://openrouter.ai/api/v1/models",{headers:{Authorization:`Bearer ${t}`}});if(!e.ok)throw new Error("Could not fetch models from OpenRouter");return(await e.json()).data.map(s=>({id:s.id,name:s.name||s.id,provider:"openrouter"}))}async function Ve(t){try{const e=await fetch(`${t}/api/tags`);if(!e.ok)throw new Error(`Could not connect to Ollama (HTTP ${e.status})`);return(await e.json()).models.map(s=>({id:s.name,name:s.name,provider:"ollama"}))}catch(e){throw e instanceof TypeError?new Error("Could not connect to Ollama. Check URL, server status, and CORS settings."):e}}async function Se(t,e={},n=12e4){const s=new AbortController,o=setTimeout(()=>s.abort(),n),i=AbortSignal.any([e.signal,s.signal].filter(Boolean));try{return await fetch(t,{...e,signal:i})}finally{clearTimeout(o)}}async function Ee(){a.bus.publish("status:update",{message:"Loading models...",state:"loading"});const t=JSON.parse(JSON.stringify(a.getProject()));if(!t||!t.globalSettings){a.bus.publish("status:update",{message:"Project not loaded",state:"error"});return}const e=t.globalSettings.apiKey?.trim()||"",n=t.globalSettings.ollamaBaseUrl?.trim()||"";let s=[];try{const r=[];e&&r.push(Ke(e).catch(l=>(console.error("OpenRouter fetch failed:",l),[]))),n&&r.push(Ve(n).catch(l=>(console.error("Ollama fetch failed:",l),[]))),s=(await Promise.all(r)).flat()}catch(r){a.bus.publish("status:update",{message:`Error loading models: ${r.message}`,state:"error"});return}let o=!1;if(s.length>0){const c=["google/gemma-3-27b-it","google/gemma-2-9b-it","openai/gpt-4o-mini","mistralai/mistral-7b-instruct"].find(l=>s.some(d=>d.id===l));if(c){const l=t.globalSettings.systemUtilityAgent;l.model||(l.model=c,o=!0,console.log(`System Utility Agent model set to: ${c}`));const d=t.agentPresets["Default Agent"];d&&!d.model&&(d.model=c,o=!0,console.log(`'Default Agent' model set to: ${c}`))}}a.setAllModels(s),o&&(a.setProject(t),await a.updateAndPersistState());const i=s.length>0?`Loaded ${s.length} models.`:"No models found. Check API Settings.";a.bus.publish("status:update",{message:i,state:"connected"})}async function O(t,e){const s=a.getState().allProviderModels.find(g=>g.id===t.model);if(!s)throw new Error("Model data not found for the agent.");const o=a.getProject(),i=s.provider,r={model:t.model,messages:e,stream:!1},c={temperature:parseFloat(t.temperature),top_p:parseFloat(t.topP),top_k:parseInt(t.topK,10),presence_penalty:parseFloat(t.presence_penalty),frequency_penalty:parseFloat(t.frequency_penalty),max_tokens:parseInt(t.max_tokens,10),seed:parseInt(t.seed,10)};t.stop_sequences&&(c.stop=t.stop_sequences.split(",").map(g=>g.trim()));let l,d;i==="openrouter"?(l="https://openrouter.ai/api/v1/chat/completions",d={Authorization:`Bearer ${o.globalSettings.apiKey}`,"Content-Type":"application/json"},r.tools=[{type:"Google Search"}],Object.assign(r,c)):(l=`${o.globalSettings.ollamaBaseUrl}/api/chat`,d={"Content-Type":"application/json"},r.options=c);const u=await Se(l,{method:"POST",headers:d,body:JSON.stringify(r)});if(!u.ok){const g=await u.text();throw new Error(`API Error: ${g}`)}const m=await u.json();if(i==="openrouter"&&m.choices&&m.choices.length>0)return m.choices[0].message.content;if(i==="ollama"&&m.message)return m.message.content;throw new Error("Invalid API response structure.")}async function we(t,e,n){const s=a.getProject(),i=a.getState().allProviderModels.find(m=>m.id===t.model);if(!i)throw new Error("Model data not found for active agent.");const r=`Responding with ${i?.name||t.model}...`;a.bus.publish("status:update",{message:r,state:"loading"});const c=i.provider;let l,d,u;c==="openrouter"?(l="https://openrouter.ai/api/v1/chat/completions",d={Authorization:`Bearer ${s.globalSettings.apiKey}`,"Content-Type":"application/json"},u={model:t.model,messages:e,stream:!0,tools:[{type:"Google Search"}],...t.parameters}):(l=`${s.globalSettings.ollamaBaseUrl}/api/chat`,d={"Content-Type":"application/json"},u={model:t.model,messages:e,stream:!0,options:t.parameters});try{const m=await Se(l,{method:"POST",headers:d,body:JSON.stringify(u),signal:a.getState().abortController?.signal});if(!m.ok||!m.body)throw new Error(`API Error: ${m.status} ${m.statusText}`);const g=m.body.pipeThrough(new TextDecoderStream).getReader();let y="";for(;;){const{value:p,done:b}=await g.read();if(b)break;const v=p.split(`
`).filter(E=>E.trim()!=="");for(const E of v){let w="";try{if(c==="openrouter"){if(!E.startsWith("data: "))continue;const M=E.replace(/^data: /,"").trim();if(M==="[DONE]")break;w=JSON.parse(M).choices?.[0]?.delta?.content||""}else w=JSON.parse(E).message?.content||""}catch{console.warn("Skipping malformed JSON chunk during stream:",E)}w&&(y+=w,n(w))}}return y}catch(m){throw m.name!=="AbortError"&&(console.error("Streaming failed:",m),a.bus.publish("status:update",{message:`Error: ${m.message}`,state:"error"})),m}}function X(t){const e=document.createElement("div");e.className="dropdown align-right";const n=document.createElement("button");n.className="btn-icon",n.innerHTML="&#8942;",n.title="More options",n.dataset.action="toggle-menu";const s=document.createElement("div");return s.className="dropdown-content",t.forEach(o=>{const i=document.createElement("a");i.href="#",i.textContent=o.label,o.isDestructive&&i.classList.add("is-destructive"),i.dataset.action=o.action,o.data&&(i.dataset.data=JSON.stringify(o.data)),s.appendChild(i)}),e.append(n,s),e}function U(){document.getElementById("settings-panel").classList.toggle("open")}function Pe(){document.getElementById("unsaved-changes-modal").style.display="flex"}function Xe(){document.getElementById("unsaved-changes-modal").style.display="none"}function f(t,e="Notification"){document.getElementById("alert-modal-title").textContent=e,document.getElementById("alert-modal-message").textContent=t,document.getElementById("alert-modal").style.display="flex"}function Qe(){document.getElementById("alert-modal").style.display="none"}function Ze(){document.querySelector(".sidebar").classList.toggle("open"),document.getElementById("mobile-overlay").classList.toggle("active")}function Q(t){t.stopPropagation();const e=t.target.closest(".dropdown");if(!e)return;const n=e.querySelector(".dropdown-content"),s=e.classList.contains("open");if(document.querySelectorAll(".dropdown.open").forEach(o=>{o!==e&&o.classList.remove("open")}),!s){n.style.visibility="hidden",n.style.display="block";const o=n.offsetHeight;n.style.visibility="",n.style.display="";const i=t.target.closest("button").getBoundingClientRect();window.innerHeight-i.bottom<o&&i.top>o?n.classList.add("opens-up"):n.classList.remove("opens-up")}e.classList.toggle("open")}function et(){document.addEventListener("click",t=>{const e=document.querySelector(".dropdown.open");e&&!e.contains(t.target)&&e.classList.remove("open")})}function tt(){const t=a.getProject();t?.globalSettings?.fontFamilySelect&&document.documentElement.style.setProperty("--main-font-family",t.globalSettings.fontFamilySelect)}function nt({message:t,state:e}){const n=document.getElementById("statusText"),s=document.getElementById("statusDot");!n||!s||(n.textContent=t||"Ready",s.className="status-dot",e==="connected"?s.classList.add("connected"):e==="error"?s.classList.add("error"):e==="loading"&&s.classList.add("warning"))}function st(){const t=document.getElementById("app-version");t&&(t.textContent="0.0.0"),a.bus.subscribe("ui:applyFontSettings",tt),a.bus.subscribe("status:update",nt),document.querySelector("#settings-btn").addEventListener("click",U),document.querySelector(".close-settings-btn").addEventListener("click",U);const e=document.getElementById("mobile-overlay");e&&e.addEventListener("click",Ze);const n=document.querySelector("#alert-modal .btn");n&&n.addEventListener("click",Qe);const s=document.getElementById("unsaved-changes-modal");if(s){const o=s.querySelector(".btn:not(.btn-secondary):not(.btn-danger)");o&&o.addEventListener("click",()=>a.bus.publish("project:unsavedChangesChoice","save"));const i=s.querySelector(".btn-danger");i&&i.addEventListener("click",()=>a.bus.publish("project:unsavedChangesChoice","discard"));const r=s.querySelector(".btn-secondary");r&&r.addEventListener("click",()=>a.bus.publish("project:unsavedChangesChoice","cancel"))}console.log("Core UI Initialized and Listeners Attached.")}function ot(t,e){const n=document.querySelector(".context-menu");n&&n.remove(),e.preventDefault(),e.stopPropagation();const s=document.createElement("div");s.className="context-menu";const o=document.createElement("ul");t.forEach(p=>{const b=document.createElement("li");b.textContent=p.label,p.isDestructive&&b.classList.add("destructive"),b.addEventListener("click",v=>{v.stopPropagation(),p.action()}),o.appendChild(b)}),s.appendChild(o),document.body.appendChild(s);const{clientX:i,clientY:r}=e.touches?e.touches[0]:e,c=s.offsetWidth,l=s.offsetHeight,d=window.innerWidth,u=window.innerHeight;let m=r,g=i;i+c>d&&(g=d-c-10),r+l>u&&(m=u-l-10),s.style.top=`${m}px`,s.style.left=`${g}px`,requestAnimationFrame(()=>{s.style.opacity="1",s.style.transform="scale(1)"});const y=()=>{s.remove(),document.removeEventListener("click",y,!0)};setTimeout(()=>{document.addEventListener("click",y,!0)},0)}function at(){document.addEventListener("keydown",t=>{const e=document.querySelector('.modal-overlay[style*="display: flex"]'),n=document.getElementById("settings-panel"),s=n?.classList.contains("visible");if(!(!e&&!s)){if(t.key==="Escape"){if(t.preventDefault(),e){const o=e.querySelector(".btn-secondary")||e.querySelector(".modal-actions .btn");o&&o.click()}else if(s){const o=n.querySelector(".close-settings-btn");o&&o.click()}}if(t.key==="Enter"&&!t.shiftKey){if(t.target.tagName==="TEXTAREA"||t.target.tagName==="BUTTON")return;if(e){t.preventDefault();const o=e.querySelector(".modal-actions .btn:not(.btn-secondary):not(.btn-danger)");if(o)o.click();else{const i=e.querySelector(".modal-actions .btn");i&&i.click()}}}}}),console.log("Global keyboard bindings initialized.")}let P;function it(){return P}async function Z(t){return P&&P.name===`${re}${t}`?Promise.resolve(P):(P&&(P.close(),P=null),new Promise((e,n)=>{const s=indexedDB.open(`${re}${t}`,5);s.onupgradeneeded=o=>{const i=o.target.result;i.objectStoreNames.contains(L)||i.createObjectStore(L,{keyPath:"id"}),i.objectStoreNames.contains(T)||i.createObjectStore(T,{keyPath:"id"})},s.onsuccess=o=>{P=o.target.result,console.log(`IndexedDB '${P.name}' opened successfully.`),e(P)},s.onerror=o=>{console.error("IndexedDB error:",o.target.error),n(o.target.error)}}))}async function I(t,e,n,s){return new Promise((o,i)=>{if(!P)return console.error("dbRequest called before DB was opened."),i("Database is not open.");try{const l=P.transaction(t,e).objectStore(t)[n](s);l.onsuccess=d=>o(d.target.result||(n==="getAll"?[]:null)),l.onerror=d=>i(d.target.error)}catch(r){console.error(`Error performing dbRequest (${n} on ${t}):`,r),i(r)}})}async function Ce(t){return new Promise((e,n)=>{if(!P)return n("Database is not open.");try{const s=P.transaction(t,"readwrite");s.oncomplete=()=>{console.log(`Stores cleared: ${t.join(", ")}`),e()},s.onerror=o=>n(s.error),t.forEach(o=>{P.objectStoreNames.contains(o)&&s.objectStore(o).clear()})}catch(s){n(s)}})}async function rt(t,e,n){a.bus.publish("ui:toggleLoading",{isLoading:!0});try{n.flowType==="round-robin"?await ct(t,e,n):n.flowType==="auto-moderator"&&await Le(t,e,n)}catch(s){s.name!=="AbortError"&&(console.error("Error during group chat turn:",s),f(`An error occurred in the group chat: ${s.message}`,"Error"))}finally{a.bus.publish("ui:toggleLoading",{isLoading:!1}),a.bus.publish("status:update",{message:"Ready",state:"connected"}),await I(L,"readwrite","put",e),a.bus.publish("context:requestData")}}async function ct(t,e,n){const s=n.maxTurns||1,o=(n.agents||[]).filter(i=>i!==n.moderatorAgent);if(o.length===0){f("Round Robin mode requires at least one member who is not the moderator.","Info");return}for(let i=0;i<s;i++){if(s>1){const r={role:"system",content:`--- Round ${i+1} of ${s} ---`};e.history.push(r),se(r,e.history.length-1)}for(const r of o){if(a.getState().abortController?.signal.aborted)return;await Ie(t,e,r)}}}async function Le(t,e,n){const s=(n.timerInSeconds||0)*1e3,o=await lt(t,e,n);s>0&&o&&(e.groupChatState.timerId=setTimeout(()=>{e.groupChatState.isRunning&&Le(t,e,n)},s))}async function lt(t,e,n){if(!t.agentPresets[n.moderatorAgent])throw new Error("Moderator agent not found");return await Ie(t,e,nextAgentName),!0}async function Ie(t,e,n){const s=t.agentPresets[n];if(!s||!s.model){console.warn(`Skipping turn for agent '${n}' because they have no model configured.`);return}const o={role:"assistant",content:"...",speaker:n,isLoading:!0};e.history.push(o);const i=e.history.length-1,c=se(o,i)?.querySelector(".message-content");if(!c){console.error(`Could not create UI placeholder for agent ${n}.`),e.history[i]={...o,content:"UI Error",isLoading:!1,isError:!0};return}const l=Me(e.history.slice(0,-1),n),d=await we(c,s,l);e.history[i]={role:"assistant",content:d,speaker:n,isLoading:!1},D()}let C=[];function dt(){const t=document.getElementById("chatMessages");if(!t)return;const e=s=>{const o=s.closest(".message.assistant");if(!o)return;const i=o.querySelector(".message-content");if(i){const r=i.cloneNode(!0);r.querySelectorAll(".code-block-wrapper").forEach(c=>{const l=c.querySelector("pre");l&&c.parentNode.replaceChild(l,c)}),a.bus.publish("composer:append",{content:r.innerHTML}),o.classList.add("sent-to-composer-feedback"),setTimeout(()=>{o.classList.remove("sent-to-composer-feedback")},500)}},n=(s,o)=>{s.type==="contextmenu"&&s.preventDefault();const i=window.getSelection(),r=i.toString().trim(),c=r&&i.containsNode(o,!0),l=[{label:"Send to Composer",action:()=>e(s.target)}];c&&l.push({label:"Send Selection to Composer",action:()=>{a.bus.publish("composer:append",{content:r})}}),ot(l,s)};t.addEventListener("contextmenu",s=>{if(s.shiftKey)return;const o=s.target.closest(".message.assistant");o&&(s.preventDefault(),n(s,o))}),t.addEventListener("dblclick",s=>{const o=s.target.closest(".message.assistant");o&&n(s,o)})}function F(t){return typeof t!="string"||!t?0:Math.round(t.length/4)}function je(t){const e=a.getProject();if(!e)return"";let n;const s=e.activeEntity,o=t||s?.name,i=t?"agent":s?.type;if(!o)return"";if(i==="agent")n=e.agentPresets?.[o];else if(i==="group"){const u=e.agentGroups?.[o];n=e.agentPresets?.[u?.moderatorAgent]}if(!n)return"";let r=n.systemPrompt||"";const c=n.activeMemories||[];if(c.length===0)return r.trim();const l=c.map(u=>{const m=e.memories.find(g=>g.name===u);return m?m.content:""}).filter(u=>u).join(`

`);return l?`${r.trim()}

--- Active Memories ---
${l}`:r.trim()}function Ae(){const t=a.getProject();if(!t||!t.activeEntity)return{finalSystemPrompt:"",totalTokens:0,agent:{},agentNameForDisplay:"N/A"};const e=je(),n=t.chatSessions.find(d=>d.id===t.activeSessionId),s=n?F(JSON.stringify(n.history||[])):0,o=F(document.getElementById("chatInput")?.value||""),r=F(e)+s+o,c=t.agentPresets[t.activeEntity.name]||{},l=t.activeEntity.name||"N/A";return{finalSystemPrompt:e,totalTokens:r,agent:c,agentNameForDisplay:l,model:c.model||"N/A"}}function Me(t,e,n){if(!a.getProject().agentPresets[e])return[];const i=[],r=je(e);return r&&i.push({role:"system",content:r}),t.forEach(c=>{if(c.isLoading||!c.content)return;let l={role:c.role};typeof c.content=="string"?l.content=c.content:Array.isArray(c.content)&&(l.content=c.content.map(d=>d.type==="image_url"?{type:"image_url",image_url:{url:d.url}}:d)),i.push(l)}),i}async function ke(){if(a.isLoading())return;a.newAbortController();const t=a.getProject(),e=document.getElementById("chatInput"),n=e.value.trim();if(!n&&C.length===0)return;if(!t.activeEntity?.name){f("Please select an Agent or Group.","Error");return}let s;if(t.activeEntity.type==="agent")s=t.agentPresets[t.activeEntity.name];else{const r=t.agentGroups[t.activeEntity.name];s=t.agentPresets[r?.moderatorAgent]}if(!s||!s.model){f("The selected Agent/Moderator has no model configured.","Error");return}const o=t.chatSessions.find(r=>r.id===t.activeSessionId);if(!o)return;let i=[];if(n&&i.push({type:"text",text:n}),C.length>0&&C.forEach(r=>{i.push({type:"image_url",url:r.data})}),o.history.push({role:"user",content:i,speaker:"You"}),o.name==="New Chat"&&o.history.length===1&&Pt(o),e.value="",e.style.height="auto",C=[],a.bus.publish("ui:renderFilePreviews",{files:C}),a.bus.publish("ui:renderMessages"),a.updateAndPersistState(),t.activeEntity.type==="agent")await ee();else{const r=t.agentGroups[t.activeEntity.name];await rt(t,o,r)}}class ut{constructor(e){if(this.contentDiv=e.querySelector(".message-content .streaming-content"),this.accumulatedMarkdown="",this.isInsideCodeBlock=!1,this.renderTimeout=null,this.debounceDelay=40,!this.contentDiv)throw new Error("Target content element for rendering not found.")}streamChunk=e=>{this.accumulatedMarkdown+=e,clearTimeout(this.renderTimeout),this.renderTimeout=setTimeout(this.render,this.debounceDelay)};render=()=>{try{const e=(this.accumulatedMarkdown.match(/```/g)||[]).length%2===1;if(e||this.isInsideCodeBlock){const n=this.accumulatedMarkdown.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");this.contentDiv.innerHTML=`<pre class="streaming-code-preview">${n}</pre>`}else this.contentDiv.innerHTML=marked.parse(this.accumulatedMarkdown,{gfm:!0,breaks:!1});this.isInsideCodeBlock=e}catch{this.contentDiv.textContent=this.accumulatedMarkdown}q()};getFinalContent(){return clearTimeout(this.renderTimeout),this.accumulatedMarkdown}}async function ee(){const t=a.getProject(),e=t.chatSessions.find(l=>l.id===t.activeSessionId);if(!e||t.activeEntity.type!=="agent")return;const n=t.activeEntity.name,s=t.agentPresets[n];a.bus.publish("ui:toggleLoading",{isLoading:!0});const o={role:"assistant",content:"",speaker:n,isLoading:!0},i=e.history.length;e.history.push(o);const r=se(o,i);let c;try{c=new ut(r)}catch(l){console.error("UI Error:",l.message),a.bus.publish("ui:toggleLoading",{isLoading:!1}),a.bus.publish("status:update",{message:"UI Error",state:"error"}),e.history.pop();return}try{const l=Me(e.history.slice(0,-1),n,e);await we(s,l,c.streamChunk);const d=c.getFinalContent();e.history[i]={role:"assistant",content:d,speaker:n,isLoading:!1},console.log("ðŸŸ¢ Assistant final content:",JSON.stringify(d))}catch(l){if(l.name!=="AbortError"){const d=`Error: ${l.message}`;e.history[i].content=d,console.error("LLM Stream Error:",l),a.bus.publish("status:update",{message:"An error occurred.",state:"error"})}else e.history.splice(i,1),console.log("Stream aborted by user.")}finally{a.bus.publish("ui:toggleLoading",{isLoading:!1}),D(),await I(L,"readwrite","put",e),a.getState().abortController?.signal.aborted||a.bus.publish("status:update",{message:"Ready",state:"connected"})}}function te(){a.abort(),a.setLoading(!1),a.bus.publish("ui:toggleLoading",{isLoading:!1})}window.ChatHandlers={sendMessage:ke,stopGeneration:te};function mt({index:t}){C&&C[t]!==void 0&&(C.splice(t,1),a.bus.publish("ui:renderFilePreviews",{files:C}))}function pt(t){const e=t.target.files;if(e){for(const n of e){const s=`file_${Date.now()}_${Math.random()}`,o={id:s,name:n.name,type:n.type,data:null};C.push(o);const i=new FileReader;i.onload=r=>{const c=C.findIndex(l=>l.id===s);c!==-1&&(C[c].data=r.target.result,a.bus.publish("ui:renderFilePreviews",{files:C}))},i.readAsDataURL(n)}t.target.value=""}}async function gt(t){a.bus.publish("status:update",{message:"Summarizing...",state:"loading"});const e=a.getProject(),n=e.globalSettings.systemUtilityAgent;if(!n||!n.model){f("System Utility Model for summarization is not configured in settings.","Error"),a.bus.publish("status:update",{message:"Summarization failed",state:"error"});return}const s=t.summaryState?.summarizedUntilIndex??-1,o=s<0?0:s,i=t.history.slice(o);if(i.length<2){f("Not enough new messages to create a meaningful summary.","Info"),a.bus.publish("status:update",{message:"Ready",state:"connected"});return}try{a.bus.publish("status:update",{message:"Generating summary title...",state:"loading"});const r=`Based on the following conversation, create a very short, descriptive title (5-7 words). Respond with ONLY the title text, nothing else.

CONVERSATION:
${i.map(p=>`${p.speaker||p.role}: ${typeof p.content=="string"?p.content:"[multimodal content]"}`).join(`
`)}`,c=await O(n,[{role:"user",content:r}]);a.bus.publish("status:update",{message:"Generating summary content...",state:"loading"});const l=t.summaryState?.activeSummaryId&&e.summaryLogs.find(p=>p.id===t.summaryState.activeSummaryId)?.content||"This is the beginning of the conversation.",d=n.summarizationPrompt||V.summarizationPrompt,u=i.map(p=>`${p.speaker||p.role}: ${typeof p.content=="string"?p.content:"[multimodal content]"}`).join(`
`),m=d.replace(/\$\{previousSummary\}/g,l).replace(/\$\{newMessages\}/g,u),g=await O(n,[{role:"user",content:m}]),y={id:`sum_${Date.now()}`,summary:c.trim().replace(/"/g,""),content:g,timestamp:Date.now(),sourceSessionId:t.id,summarizedUntilIndex:t.history.length};e.summaryLogs||(e.summaryLogs=[]),e.summaryLogs.push(y),t.summaryState={activeSummaryId:y.id,summarizedUntilIndex:y.summarizedUntilIndex},t.history.push({role:"system",content:`[ System: Conversation summarized under the title: "${y.summary}" ]`}),await I(L,"readwrite","put",t),a.setProject(e),a.updateAndPersistState(),a.bus.publish("ui:renderMessages"),a.bus.publish("summary:listChanged"),f("Conversation summarized successfully!","Success")}catch(r){console.error("Failed to summarize history:",r),f(`Summarization Failed: ${r.message}`,"Error")}finally{a.bus.publish("status:update",{message:"Ready",state:"connected"})}}async function yt(){console.log("âœ… handleManualSummarize handler started. Checking for System Utility Agent...");const t=a.getProject(),e=t.globalSettings?.systemUtilityAgent;if(console.log("Found Utility Agent:",e),!e||!e.model){f("The 'System Utility Agent' has no model configured.","Configuration Required");return}const n=t.chatSessions.find(s=>s.id===t.activeSessionId);if(!n){f("No active session found.","Error");return}confirm("Do you want to use the System Utility Agent to summarize this conversation?")&&await gt(n)}async function ft(t){const e=a.getProject(),n=e.chatSessions.find(i=>i.id===e.activeSessionId),s=e.summaryLogs.find(i=>i.id===t);if(!n||!s)return;n.summaryState.activeSummaryId=s.id,n.summaryState.summarizedUntilIndex=n.history.length;const o={role:"system",content:`[ System: Context loaded from summary: "${s.summary}" ]

---

${s.content}`,isSummary:!0};n.history.push(o),await I(L,"readwrite","put",n),a.setProject(e),a.updateAndPersistState(),a.bus.publish("ui:renderMessages"),a.bus.publish("summary:listChanged")}function ht(){console.log("ðŸš€ unloadSummaryFromActiveSession handler called!");const t=a.getProject(),e=t.chatSessions.find(n=>n.id===t.activeSessionId);!e||!e.summaryState?.activeSummaryId||(console.log(`Clearing summary context for session: ${e.name}`),e.summaryState.activeSummaryId=null,e.history.push({role:"system",content:"[Summary context has been cleared. The full conversation history is now active.]"}),a.updateAndPersistState(),D(),a.bus.publish("status:update",{message:"Summary context cleared.",state:"connected"}),f("Summary context cleared successfully.","Success"),a.bus.publish("context:requestData"))}async function bt(t){if(!confirm("Are you sure you want to permanently delete this summary log? This cannot be undone."))return;const e=a.getProject(),n=e.summaryLogs.findIndex(s=>s.id===t);n>-1&&(e.summaryLogs.splice(n,1),e.chatSessions.forEach(s=>{if(s.summaryState?.activeSummaryId===t&&(s.summaryState.activeSummaryId=null,s.id===e.activeSessionId)){const o={role:"system",content:"[ System: The active summary was deleted. Context has been cleared. ]"};s.history.push(o),a.bus.publish("ui:renderMessages")}}),a.setProject(e),await a.updateAndPersistState(),a.bus.publish("summary:listChanged"))}async function vt({index:t,event:e}){e&&e.stopPropagation();const n=a.getProject(),s=n.chatSessions.find(r=>r.id===n.activeSessionId);if(!s)return;const o=s.history[t];if(!o)return;let i="";typeof o.content=="string"?i=o.content:Array.isArray(o.content)&&(i=o.content.find(r=>r.type==="text")?.text||"");try{await navigator.clipboard.writeText(i),f("Copied to clipboard!")}catch(r){console.error("Failed to copy message:",r),f("Failed to copy message.","Error")}}new TurndownService({headingStyle:"atx",codeBlockStyle:"fenced"});async function St({index:t,event:e}){e&&e.stopPropagation();const n=a.getProject(),s=n.chatSessions.find(l=>l.id===n.activeSessionId);if(!s)return;const o=s.history[t],i=document.querySelector(`.message-turn-wrapper[data-index='${t}']`);if(!i)return;const r=i.querySelector(".message"),c=r.querySelector(".message-content");if(o.role==="user"){if(r.classList.contains("is-editing"))return;r.classList.add("is-editing"),i.classList.add("is-editing-child"),c&&(c.style.display="none");const l=document.createElement("div");l.className="inline-edit-container";const d=document.createElement("textarea");d.className="inline-edit-textarea",d.value=typeof o.content=="string"?o.content:o.content.find(p=>p.type==="text")?.text||"",d.addEventListener("input",()=>{d.style.height="auto",d.style.height=d.scrollHeight+"px"});const u=document.createElement("div");u.className="inline-edit-actions";const m=document.createElement("button");m.textContent="Save & Regenerate",m.className="btn btn-small";const g=document.createElement("button");g.textContent="Cancel",g.className="btn btn-small btn-secondary";const y=()=>{l.remove(),c&&(c.style.display="block"),r.classList.remove("is-editing"),i.classList.remove("is-editing-child")};m.addEventListener("click",async p=>{p.stopPropagation(),d.value.trim()&&(s.history[t].content=[{type:"text",text:d.value.trim()}],s.history.splice(t+1),a.bus.publish("ui:renderMessages"),await ee())}),g.addEventListener("click",p=>{p.stopPropagation(),y()}),d.addEventListener("keydown",p=>{p.key==="Escape"&&(p.preventDefault(),g.click())}),u.appendChild(g),u.appendChild(m),l.appendChild(d),l.appendChild(u),r.appendChild(l),d.focus(),d.dispatchEvent(new Event("input"))}else if(o.role==="assistant"){if(!c||r.classList.contains("is-editing"))return;r.classList.add("is-editing"),i.classList.add("is-editing-child"),c&&(c.style.display="none");const l=document.createElement("div");l.className="inline-edit-container";const d=document.createElement("textarea");d.className="inline-edit-textarea",d.value=o.content,d.addEventListener("input",()=>{d.style.height="auto",d.style.height=d.scrollHeight+"px"});const u=document.createElement("div");u.className="inline-edit-actions";const m=document.createElement("button");m.textContent="Save",m.className="btn btn-small";const g=document.createElement("button");g.textContent="Cancel",g.className="btn btn-small btn-secondary";const y=()=>{l.remove(),c&&(c.style.display="block"),r.classList.remove("is-editing"),i.classList.remove("is-editing-child")};m.addEventListener("click",p=>{p.stopPropagation(),s.history[t].content=d.value,a.updateAndPersistState(),a.bus.publish("ui:renderMessages")}),g.addEventListener("click",p=>{p.stopPropagation(),y()}),d.addEventListener("keydown",p=>{p.key==="Escape"&&(p.preventDefault(),g.click())}),u.appendChild(g),u.appendChild(m),l.appendChild(d),l.appendChild(u),r.appendChild(l),d.focus(),d.dispatchEvent(new Event("input"))}}async function Et({index:t}){const e=a.getProject(),n=e.chatSessions.find(o=>o.id===e.activeSessionId);if(!n||t>=n.history.length)return;te();let s=-1;for(let o=t;o>=0;o--)if(n.history[o].role==="user"){s=o;break}s!==-1&&(n.history.splice(s+1),a.bus.publish("ui:renderMessages"),await ee())}function wt({index:t}){if(!confirm("Are you sure you want to delete this single message? This action cannot be undone."))return;const e=a.getProject(),n=e.chatSessions.find(s=>s.id===e.activeSessionId);n&&(n.history.splice(t,1),a.setProject(e),a.updateAndPersistState(),a.bus.publish("ui:renderMessages"))}async function Pt(t){await new Promise(e=>setTimeout(e,500));try{const n=a.getProject().globalSettings.systemUtilityAgent;if(!n||!n.model){console.warn("Auto-naming skipped: System Utility Agent not configured.");return}const s=t.history.find(d=>d.role==="user"),o=Array.isArray(s.content)?s.content.find(d=>d.type==="text")?.text:s.content;if(!o)return;const i=`Based on the user's initial query, create a concise title (3-5 words) and a single relevant emoji. Respond ONLY with a JSON object like {"title": "your title", "emoji": "ðŸ‘"}.

User's Query: "${o}"`,r=await O({...n,temperature:.1},[{role:"user",content:i}]);let c={};try{const d=r.match(/{.*}/s);c=JSON.parse(d[0])}catch{console.error("Failed to parse title JSON:",r),c={title:o.substring(0,30),emoji:"ðŸ’¬"}}const l=`${c.emoji||"ðŸ’¬"} ${c.title||"New Chat"}`;a.bus.publish("session:autoRename",{sessionId:t.id,newName:l})}catch(e){console.error("Auto-rename process failed:",e)}}function xe(t,e){let n;return function(...o){const i=()=>{clearTimeout(n),t(...o)};clearTimeout(n),n=setTimeout(i,e)}}function Ct(t){if(!t)return"N/A";const e=new Date(t),n=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),c=String(e.getSeconds()).padStart(2,"0");return`${n}-${s}-${o} ${i}:${r}:${c}`}function ne(t){t.querySelectorAll("pre > code").forEach(e=>{if(e.dataset.highlighted==="yes")return;const n=e.parentNode;if(n.parentNode.classList.contains("code-block-wrapper"))return;if(n.parentNode.tagName==="P"){const i=n.parentNode;i.parentNode.insertBefore(n,i),i.textContent.trim()||i.remove()}const s=document.createElement("div");s.className="code-block-wrapper",n.parentNode.insertBefore(s,n),s.appendChild(n);const o=document.createElement("button");o.className="copy-code-btn",o.textContent="Copy",s.appendChild(o),o.addEventListener("click",()=>{navigator.clipboard.writeText(e.textContent).then(()=>{o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy"},2e3)})}),window.hljs&&Array.from(e.classList).some(r=>r.startsWith("language-")&&r!=="language-undefined")&&hljs.highlightElement(e)})}function Lt(t,e){const n=t.split(/\n{2,}/);let s=0;e.innerHTML="";function o(){if(s>=n.length){ne(e.closest(".message-content")),q();return}const i=document.createElement("div");i.innerHTML=marked.parse(n[s]||"",{gfm:!0,breaks:!1}),e.appendChild(i),s++,requestAnimationFrame(()=>{q(),o()})}o()}function It(t,e){const{role:n,content:s,speaker:o,isLoading:i,isError:r,isSummary:c}=t,l=a.getProject(),d=2e3,u=document.createElement("div");u.className=`message-turn-wrapper ${n}-turn`,u.dataset.index=e;const m=document.createElement("div");if(m.className=`message ${n}`,r&&m.classList.add("error"),c&&m.classList.add("system-summary-message"),n==="assistant"&&o){const y=l.agentPresets?.[o],p=y?y.icon:"ðŸ¤–",b=document.createElement("div");b.className="speaker-label-wrapper",b.innerHTML=`<span class="speaker-label">${p} ${o}</span>`,u.appendChild(b)}const g=document.createElement("div");if(g.className="message-content",m.appendChild(g),i)g.innerHTML='<span class="streaming-content"><div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></span>';else{const y=document.createElement("span");y.className="streaming-content",g.appendChild(y);let p="",b=!1;if(c?(b=!0,p=s):n==="user"?(Array.isArray(s)?p=s.filter(v=>v.type==="text").map(v=>v.text).join(`
`):typeof s=="string"&&(p=s),b=p.length>d):n==="assistant"&&(p=s||"",b=p.length>d),b)y.innerHTML='<div class="loading-text">Loading large message...</div>',setTimeout(()=>Lt(p,y),0);else{try{if(n==="assistant")y.innerHTML=marked.parse(s||"",{gfm:!0,breaks:!1});else if(n==="user"){if(Array.isArray(s))s.forEach(v=>{if(v.type==="text"&&v.text){const E=document.createElement("p");E.textContent=v.text,y.appendChild(E)}else if(v.type==="image_url"&&v.url){const E=document.createElement("img");E.src=v.url,E.className="multimodal-image",y.appendChild(E)}});else if(typeof s=="string"){const v=document.createElement("p");v.textContent=s,y.appendChild(v)}}}catch(v){console.error("Content rendering failed:",v),y.textContent="Error displaying content"}ne(g)}}if(!i&&!r&&!c){const y=document.createElement("div");y.className="message-actions";const p='style="font-size: 18px;"',b=document.createElement("button");b.innerHTML=`<span class="material-symbols-outlined" ${p}>edit</span>`,b.title="Edit",b.onclick=w=>a.bus.publish("chat:editMessage",{index:e,event:w}),y.appendChild(b);const v=document.createElement("button");if(v.innerHTML=`<span class="material-symbols-outlined" ${p}>content_copy</span>`,v.title="Copy",v.onclick=w=>a.bus.publish("chat:copyMessage",{index:e,event:w}),y.appendChild(v),n==="assistant"){const w=document.createElement("button");w.innerHTML=`<span class="material-symbols-outlined" ${p}>refresh</span>`,w.title="Regenerate",w.onclick=M=>a.bus.publish("chat:regenerateMessage",{index:e,event:M}),y.appendChild(w)}const E=document.createElement("button");E.innerHTML=`<span class="material-symbols-outlined" ${p}>delete_forever</span>`,E.title="Delete",E.onclick=w=>a.bus.publish("chat:deleteMessage",{index:e,event:w}),y.appendChild(E),m.appendChild(y)}return u.appendChild(m),u}function jt(){const t=document.querySelector(".main-chat-area"),e=document.getElementById("chatMessages"),n=document.getElementById("status-panel");if(!t||!e||!n||e.dataset.scrollListenerAttached)return;e.dataset.scrollListenerAttached="true";let s=0;const o=10,i=40;e.addEventListener("scroll",()=>{if(t.classList.contains("no-autohide")||window.innerWidth>768)return;let r=e.scrollTop;if(e.scrollHeight-r-e.clientHeight<i){t.classList.remove("header-visible"),n.classList.add("is-collapsed"),s=r;return}Math.abs(r-s)<=o||(r>s?(t.classList.remove("header-visible"),n.classList.add("is-collapsed")):(t.classList.add("header-visible"),n.classList.remove("is-collapsed")),s=r<=0?0:r)},{passive:!0})}function se(t,e){const{role:n,content:s,speaker:o,isLoading:i,isError:r}=t,c=a.getProject(),l=document.getElementById("chatMessages"),d=document.createElement("div");d.className=`message-turn-wrapper ${n}-turn`,d.dataset.index=e;const u=document.createElement("div");u.className=`message ${n}`,r&&u.classList.add("error");const m=document.createElement("div");if(m.className="message-content",n==="assistant"&&o){const y=c.agentPresets?.[o],p=y?y.icon:"ðŸ¤–",b=document.createElement("div");b.className="speaker-label-wrapper",b.innerHTML=`<span class="speaker-label">${p} ${o}</span>`,d.appendChild(b)}const g=document.createElement("span");if(g.className="streaming-content",i)g.innerHTML='<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';else{const p=(c.agentPresets?.[o]||{}).useMarkdown!==!1,b=typeof s=="string"?s:s?.find(v=>v.type==="text")?.text||"";g.innerHTML=p&&window.marked?marked.parse(b,{gfm:!0,breaks:!1}):`<p>${b}</p>`,ne(g)}return m.appendChild(g),u.appendChild(m),d.appendChild(u),l.appendChild(d),l.scrollTop=l.scrollHeight,d}function D(){const t=a.getProject(),e=t.chatSessions.find(s=>s.id===t.activeSessionId);if(!e){console.error("[UI] renderMessages: No active session found!");return}const n=document.getElementById("chatMessages");if(!n){console.error("[UI] renderMessages: Chat container not found!");return}console.log("ðŸ“œ [UI] History to be rendered:",JSON.parse(JSON.stringify(e.history))),n.innerHTML="",e.history&&e.history.length>0&&e.history.forEach((s,o)=>{const i=It(s,o);n.appendChild(i)}),q(),window.hljs&&document.querySelectorAll("pre code").forEach(s=>{hljs.highlightElement(s)})}function q(){const t=document.getElementById("chatMessages");t&&(t.scrollTop=t.scrollHeight)}function At(){const t=document.getElementById("chatMessages");t&&(t.innerHTML=""),oe("AI Assistant")}function oe(t){const e=document.getElementById("chat-title");e&&(e.textContent=t||"AI Assistant")}function Mt(t){const e=document.getElementById("file-preview-container");e&&(e.classList.toggle("hidden",!t||t.length===0),e.innerHTML="",!(!t||t.length===0)&&t.forEach((n,s)=>{const o=document.createElement("div");o.className="file-preview-item";let i="";n.type.startsWith("image/")?i=`<img src="${n.data||""}" class="file-preview-thumbnail" alt="${n.name}">`:i='<div class="file-preview-thumbnail file-icon">ðŸ“„</div>',o.innerHTML=`${i}<span class="file-preview-name">${n.name}</span><button class="remove-file-btn" data-action="chat:removeFile" data-index="${s}">&times;</button>`,e.appendChild(o)}))}function R(){const{totalTokens:t,agent:e,agentNameForDisplay:n}=Ae();document.getElementById("active-agent-status").textContent=`Active: ${e.icon||""} ${n}`,document.getElementById("token-count-status").textContent=`~${t.toLocaleString()} Tokens`}function kt(){const{finalSystemPrompt:t,totalTokens:e,agentNameForDisplay:n,model:s}=Ae();document.getElementById("inspector-agent-name").textContent=n,document.getElementById("inspector-agent-model").textContent=s,document.getElementById("inspector-token-count").textContent=`~${e.toLocaleString()}`,document.getElementById("inspector-system-prompt").textContent=t||"(No system prompt or memories active)",document.getElementById("context-inspector-modal").style.display="flex"}function xt(){document.getElementById("context-inspector-modal").style.display="none"}function Bt(){const t=document.getElementById("chat-actions-container"),e=document.getElementById("chat-actions-btn"),n=document.getElementById("chat-actions-menu");!t||!e||!n||(e.addEventListener("click",s=>{s.stopPropagation(),n.innerHTML="",n.innerHTML=`
            <a href="#" data-action="open-composer"><span class="material-symbols-outlined">edit_square</span> Composer</a>
            <a href="#" data-action="chat:summarize"><span class="material-symbols-outlined">psychology</span> Summarize</a>
            <a href="#" data-action="upload-file"><span class="material-symbols-outlined">attach_file</span> Upload files</a>
        `;const o=a.getProject(),i=o.chatSessions.find(r=>r.id===o.activeSessionId);console.log("Checking for active summary. ID:",i?.summaryState?.activeSummaryId),i&&i.summaryState?.activeSummaryId&&(console.log("âœ… Active summary found. Creating 'Clear Summary' button."),n.innerHTML+=`
                <div class="dropdown-divider"></div>
                <a href="#" data-action="chat:clearSummary" class="is-destructive"><span class="material-symbols-outlined">layers_clear</span> Clear Summary Context</a>
            `),t.classList.toggle("open")}),n.addEventListener("click",s=>{const o=s.target.closest("[data-action]");if(o){switch(s.preventDefault(),o.dataset.action){case"open-composer":a.bus.publish("ui:toggleComposer");break;case"chat:summarize":a.bus.publish("chat:summarize");break;case"upload-file":document.getElementById("file-input")?.click();break;case"chat:clearSummary":a.bus.publish("chat:clearSummary");break}t.classList.remove("open")}}),document.addEventListener("click",s=>{t.classList.contains("open")&&!t.contains(s.target)&&t.classList.remove("open")}))}function ce(){const t=document.querySelector('[data-action="open-composer"]');if(!t)return;document.getElementById("composer-panel")?.classList.contains("collapsed")?t.innerHTML=`
            <span class="material-symbols-outlined">edit_square</span> Open Composer
        `:t.innerHTML=`
            <span class="material-symbols-outlined">visibility_off</span> Hide Composer
        `}function Tt(){const t=document.getElementById("chatInput"),e=document.getElementById("file-input"),n=document.getElementById("file-preview-container");if(t){t.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),a.bus.publish("chat:sendMessage"))});const s=xe(()=>{t.style.height="auto",t.style.height=t.scrollHeight+"px",R()},500);t.addEventListener("input",s)}document.getElementById("sendBtn")?.addEventListener("click",()=>a.bus.publish("chat:sendMessage")),document.getElementById("stopBtn")?.addEventListener("click",()=>a.bus.publish("chat:stopGeneration")),document.getElementById("context-inspector-trigger-btn")?.addEventListener("click",kt),document.querySelector("#context-inspector-modal .btn-secondary")?.addEventListener("click",xt),e&&e.addEventListener("change",s=>{a.bus.publish("chat:fileUpload",s)}),n&&n.addEventListener("click",s=>{if(s.target.matches(".remove-file-btn")){const o=parseInt(s.target.dataset.index,10);a.bus.publish("chat:removeFile",{index:o})}}),Bt(),jt(),a.bus.subscribe("session:loaded",()=>R()),a.bus.subscribe("entity:selected",()=>R()),a.bus.subscribe("composer:visibilityChanged",ce),a.bus.subscribe("ui:renderMessages",D),a.bus.subscribe("ui:renderFilePreviews",({files:s})=>Mt(s)),a.bus.subscribe("ui:updateChatTitle",({title:s})=>oe(s)),a.bus.subscribe("ui:toggleLoading",({isLoading:s})=>{document.getElementById("sendBtn")?.classList.toggle("hidden",s),document.getElementById("stopBtn")?.classList.toggle("hidden",!s)}),ce(),console.log("âœ… Chat UI Initialized with a clean structure.")}function Nt(){const t=document.getElementById("toggle-right-sidebar-btn"),e=document.getElementById("studio-panel"),n=document.getElementById("right-sidebar-overlay"),s=document.querySelector(".app-wrapper");!t||!e||(t.addEventListener("click",()=>{window.innerWidth<=900?(e.classList.add("open"),n?.classList.add("active"),document.body.style.overflow="hidden"):(e.classList.toggle("collapsed"),s?.classList.toggle("with-right-collapsed",e.classList.contains("collapsed")))}),n?.addEventListener("click",()=>{e.classList.remove("open"),n.classList.remove("active"),document.body.style.overflow=""}),window.addEventListener("resize",()=>{window.innerWidth>900&&(e.classList.remove("open"),n?.classList.remove("active"),document.body.style.overflow="")}))}function G(t){const e=document.getElementById("project-title");if(e){const n=a.isUserDirty(),s=t||a.getProject()?.name||"Untitled";e.textContent=n?`${s} *`:s}}function Dt(){const t=document.getElementById("save-project-modal"),e=document.getElementById("project-name-input"),n=a.getProject();e.value=n?`${n.name} - Copy`:"Untitled Project",t.style.display="flex",e.focus(),e.select()}function le(){const t=document.getElementById("save-project-modal");t.style.display="none"}function $t(t){t&&t.stopPropagation(),document.getElementById("custom-entity-selector-wrapper").classList.toggle("open")}function Ot(t){const e=t.indexOf("_"),n=t.substring(0,e),s=t.substring(e+1);a.bus.publish("entity:select",{type:n,name:s}),document.getElementById("custom-entity-selector-wrapper").classList.remove("open")}function $(){const t=a.getProject();if(!t||!t.globalSettings)return;const e=document.getElementById("entitySelector"),n=document.getElementById("custom-entity-selector-options"),s=document.getElementById("custom-entity-selector-icon"),o=document.getElementById("custom-entity-selector-text");e.innerHTML="",n.innerHTML="";const i=(l,d,u,m)=>{const g=`${l}_${d}`,y=document.createElement("div");y.className="custom-select-option",y.innerHTML=`<span class="item-icon">${u}</span> <span>${d}</span>`,y.addEventListener("click",()=>Ot(g)),m.appendChild(new Option(`${u} ${d}`,g)),n.appendChild(y)},r=t.agentPresets||{};if(Object.keys(r).length>0){const l=document.createElement("optgroup");l.label="Agent Presets",e.appendChild(l);const d=document.createElement("div");d.className="custom-select-group",d.textContent="Agent Presets",n.appendChild(d),Object.keys(r).forEach(u=>{i("agent",u,r[u].icon||"ðŸ¤–",l)})}const c=t.agentGroups||{};if(Object.keys(c).length>0){const l=document.createElement("optgroup");l.label="Agent Groups",e.appendChild(l);const d=document.createElement("div");d.className="custom-select-group",d.textContent="Agent Groups",n.appendChild(d),Object.keys(c).forEach(u=>{i("group",u,"ðŸ¤",l)})}if(t.activeEntity){const{type:l,name:d}=t.activeEntity;e.value=`${l}_${d}`,l==="agent"&&r[d]?(s.textContent=r[d].icon||"ðŸ¤–",o.textContent=d):l==="group"?(s.textContent="ðŸ¤",o.textContent=d):(s.textContent="â”",o.textContent="Select...")}}function Ut(){const t=a.getProject();if(!t||!t.globalSettings)return;const e=document.getElementById("system-utility-summary-preset-select"),n=t.globalSettings.summarizationPromptPresets||{},s=document.getElementById("system-utility-summary-prompt").value;let o=null;e.innerHTML="";for(const i in n)e.add(new Option(i,i)),n[i].trim()===s.trim()&&(o=i);if(o)e.value=o;else{const i=new Option("--- Custom ---","custom",!0,!0);i.disabled=!0,e.add(i),e.value="custom"}}function qt(){a.bus.subscribe("project:loaded",n=>{G(n.projectData.name),$()}),a.bus.subscribe("project:nameChanged",n=>G(n)),a.bus.subscribe("userDirty:changed",()=>{G()}),a.bus.subscribe("entity:selected",$),a.bus.subscribe("agent:listChanged",$),a.bus.subscribe("group:listChanged",$),a.bus.subscribe("ui:renderSummarizationSelector",Ut),a.bus.subscribe("ui:showSaveAsModal",Dt);const t=document.querySelector(".sidebar-bottom-row .dropdown");if(t){const n=t.querySelector("button");n&&n.addEventListener("click",Q),t.addEventListener("click",s=>{const o=s.target.closest("a");if(!o)return;const i=o.dataset.action;if(i){s.preventDefault();const r={newProject:{name:"project:new"},openProject:{name:"project:open"},saveProject:{name:"project:save",data:!1},saveProjectAs:{name:"project:save",data:!0},exportChat:{name:"project:exportChat"}};r[i]&&a.bus.publish(r[i].name,r[i].data),t.classList.remove("open")}})}const e=document.getElementById("save-project-modal");e&&e.addEventListener("click",n=>{if(n.target.matches(".btn:not(.btn-secondary)")){const s=document.getElementById("project-name-input").value.trim();s?(a.bus.publish("project:saveConfirm",{projectName:s}),le()):f("Please enter a project name.")}else(n.target.matches(".btn-secondary")||n.target===e)&&le()}),document.getElementById("load-project-input").addEventListener("change",n=>a.bus.publish("project:fileSelectedForOpen",n)),document.getElementById("custom-entity-selector-trigger").addEventListener("click",$t),console.log("Project UI Initialized.")}function z(t){const e=a.getProject();let n="ðŸ’¬";t.linkedEntity?.type==="agent"&&e.agentPresets[t.linkedEntity.name]?n=e.agentPresets[t.linkedEntity.name].icon||"ðŸ¤–":t.linkedEntity?.type==="group"&&(n="ðŸ¤");const s=document.createElement("div");s.className="item session-item",s.dataset.sessionId=t.id,t.pinned&&s.classList.add("pinned");const o=t.name||"New Chat";return s.innerHTML=`
        <div class="item-header">
            <span class="item-name"><span class="item-icon">${n}</span> ${o}</span>
            <div class="item-actions">
                <div class="dropdown align-right">
                    <button class="btn-icon" data-action="toggle-menu" title="More options">&#8942;</button>
                    <div class="dropdown-content">
                        <a href="#" data-action="pin">${t.pinned?"Unpin":"Pin"} Session</a>
                        <a href="#" data-action="rename">Rename</a>
                        <a href="#" data-action="clone">Clone Session</a>
                        <a href="#" data-action="archive">${t.archived?"Unarchive":"Archive"} Session</a>                        <a href="#" data-action="download">Download Chat</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" data-action="delete" class="is-destructive">
                            <span class="material-symbols-outlined">delete</span> Delete Session
                        </a>                    
                    </div>
                </div>
            </div>
        </div>
    `,s}function Be(t){document.querySelectorAll(".session-item").forEach(n=>{n.classList.toggle("active",n.dataset.sessionId===t)})}function j(){const t=a.getProject();if(!t)return;const e=document.getElementById("pinnedSessionList"),n=document.getElementById("sessionListContainer"),s=document.getElementById("archivedSessionList"),o=document.getElementById("archivedSessionsSection");if(!e||!n||!s||!o)return;e.innerHTML="",n.innerHTML="",s.innerHTML="";const i=t.chatSessions||[],r=i.filter(d=>d.isPinned&&!d.archived),c=i.filter(d=>!d.isPinned&&!d.archived),l=i.filter(d=>d.archived);r.sort((d,u)=>u.updatedAt-d.updatedAt).forEach(d=>{e.appendChild(z(d))}),c.sort((d,u)=>u.updatedAt-d.updatedAt).forEach(d=>{n.appendChild(z(d))}),l.sort((d,u)=>u.updatedAt-d.updatedAt).forEach(d=>{s.appendChild(z(d))}),o.classList.toggle("hidden",l.length===0),Be(t.activeSessionId)}function Ht(){a.bus.subscribe("project:loaded",j),a.bus.subscribe("session:listChanged",j),a.bus.subscribe("session:loaded",()=>Be(a.getProject()?.activeSessionId));const t=document.querySelector(".sessions-panel");t&&t.addEventListener("click",e=>{const n=e.target,s=n.closest("[data-action]"),o=n.closest(".session-item[data-session-id]");if(n.closest("#new-chat-btn")){a.bus.publish("session:new");return}if(!o)return;const i=o.dataset.sessionId;if(s){e.preventDefault(),e.stopPropagation();const r=s.dataset.action;r==="toggle-menu"?Q(e):(a.bus.publish(`session:${r}`,{sessionId:i,event:e}),s.closest(".dropdown.open")?.classList.remove("open"))}else a.getProject().activeSessionId!==i&&A(i)}),console.log("âœ… Session UI and its dedicated event listener initialized.")}const ae=()=>document.querySelector("#composer-editor .composer-content-area");function Te(t){const e=a.getProject(),n=e?.chatSessions.find(s=>s.id===e.activeSessionId);n&&n.composerContent!==t&&(n.composerContent=t,a.updateAndPersistState())}function J(){const t=ae();if(!t)return;const e=a.getProject();if(!e?.activeSessionId){t.innerHTML="";return}const n=e.chatSessions.find(s=>s.id===e.activeSessionId);t.innerHTML=n?.composerContent||""}function Ft({content:t}){const e=ae(),n=document.getElementById("composer-panel");!e||!n||(n.classList.contains("collapsed")&&(n.classList.remove("collapsed"),document.getElementById("resizer-row")?.classList.remove("collapsed"),a.bus.publish("composer:visibilityChanged")),e.textContent.trim()!==""&&(e.innerHTML+="<br><hr><br>"),e.innerHTML+=t,e.scrollTop=e.scrollHeight,Te(e.innerHTML))}function Rt(t){const e=document.createElement("div");return e.innerHTML=t,e.querySelectorAll("*").forEach(n=>{if(n.removeAttribute("style"),n.classList.length>0){const s=[];for(let o=0;o<n.classList.length;o++)n.classList[o].startsWith("hljs-")||s.push(n.classList[o]);s.forEach(o=>n.classList.remove(o))}}),e.innerHTML}function Gt(){const t=ae();if(!t)return;const e=t.innerHTML;if(!e.trim()){f("Composer is empty. Nothing to export.","Info");return}const s=`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Composer Export</title>
            
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
            
            <style>
                /* 2. à¸ªà¹„à¸•à¸¥à¹Œà¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸‚à¸­à¸‡à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¸—à¸µà¹ˆ Export */
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
                    line-height: 1.6; 
                    padding: 20px; 
                    max-width: 800px; 
                    margin: auto; 
                }
                pre {
                    background-color: #f6f8fa; /* à¸ªà¸µà¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡ Code Block à¸ªà¸³à¸«à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆ Export */
                    padding: 16px;
                    border-radius: 6px;
                    overflow-x: auto;
                }
                code {
                    font-family: 'Fira Mono', 'Menlo', monospace;
                }
            </style>
        </head>
        <body>
            ${Rt(e)}
        </body>
        </html>
    `,o=new Blob([s],{type:"text/html;charset=utf-8"}),i=URL.createObjectURL(o),r=document.createElement("a");r.href=i,r.download=`composer-export-${Date.now()}.html`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}function zt(){const t=document.getElementById("color-palette");if(!t)return;const e=["#000000","#E03131","#C2255C","#9C36B5","#6741D9","#3B5BDB","#1971C2","#0C8599","#099268","#2F9E44","#66A80F","#F08C00","#E8590C","#868E96","#495057"];t.innerHTML="",e.forEach(n=>{const s=document.createElement("div");s.className="color-swatch",s.style.backgroundColor=n,s.dataset.color=n,t.appendChild(s)})}function x(){const t=document.querySelector(".composer-tools-area");if(!t)return;let e=!1;const n=document.queryCommandValue("formatBlock").toLowerCase();for(const o of["H1","H2","H3","P"]){const i=t.querySelector(`button[data-value="${o}"]`);i&&(n===`<${o.toLowerCase()}>`?(i.classList.add("is-active"),o!=="P"&&(e=!0)):i.classList.remove("is-active"))}["bold","italic","underline","strikeThrough"].forEach(o=>{const i=t.querySelector(`button[data-command="${o}"]`);if(i){const r=o==="bold"&&e?!1:document.queryCommandState(o);i.classList.toggle("is-active",r)}})}function _t(t){const e=document.querySelector("#composer-editor .composer-content-area");e&&(e.innerHTML="")}function Wt(){const t=document.getElementById("composer-panel"),n=document.getElementById("composer-editor")?.querySelector(".composer-content-area"),s=document.querySelector(".composer-tools-area"),o=document.getElementById("composer-collapse-btn"),i=document.getElementById("composer-expand-btn"),r=document.getElementById("export-composer-btn");if(!t||!n){console.error("Composer UI cannot initialize: Core elements not found.");return}const c=()=>{t.classList.toggle("collapsed"),document.getElementById("resizer-row")?.classList.toggle("collapsed"),a.bus.publish("composer:visibilityChanged")};a.bus.subscribe("project:loaded",J),a.bus.subscribe("session:loaded",J),a.bus.subscribe("composer:append",Ft),a.bus.subscribe("ui:toggleComposer",c),n.addEventListener("focus",()=>{document.execCommand("formatBlock",!1,"p"),x()}),["click","keyup","focus"].forEach(m=>{n.addEventListener(m,()=>{setTimeout(x,1)})}),document.addEventListener("selectionchange",()=>{document.activeElement===n&&x()});const d=xe(()=>Te(n.innerHTML),500);n.addEventListener("input",d),["keyup","mouseup"].forEach(m=>n.addEventListener(m,x)),document.addEventListener("selectionchange",()=>{document.activeElement===n&&x()}),s&&(zt(),s.addEventListener("mousedown",m=>{m.preventDefault();const g=m.target.closest("button, .color-swatch");if(g){if(n.focus(),g.id==="color-picker-btn"){g.parentElement.classList.toggle("open");return}if(g.classList.contains("color-swatch"))document.execCommand("foreColor",!1,g.dataset.color),g.closest(".dropdown")?.classList.remove("open");else{const y=g.dataset.command;if(y){let p=g.dataset.value||null;y==="formatBlock"&&p&&(p=`<${p}>`),document.execCommand(y,!1,p)}}x()}})),r&&r.addEventListener("click",Gt),o&&o.addEventListener("click",c),i&&i.addEventListener("click",()=>{const m=t.style.flexBasis&&parseInt(t.style.flexBasis,10)>window.innerHeight*.5;t.style.flexBasis=m?"35vh":"90vh"}),console.log("âœ… Composer UI Initialized with definitive patches.")}const Ne=(t="sid")=>`${t}_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,N=()=>a.getProject(a.activeProjectId);function De(){const t=N(),e=t?.activeEntity;if(!t||!e){f("Please create or select an agent/group first.","Error");return}const n={id:Ne(),name:"New Chat",history:[],composerContent:"",createdAt:Date.now(),updatedAt:Date.now(),pinned:!1,archived:!1,linkedEntity:{...e},summaryState:{activeSummaryId:null,summarizedUntilIndex:-1}};t.chatSessions.unshift(n),t.activeSessionId=n.id,a.updateAndPersistState(t),A(n.id)}function A(t){const e=a.getProject();if(!e)return;if(!t){e.activeSessionId=null,a.setProject(e),a.bus.publish("session:cleared");return}const n=e.chatSessions.find(s=>s.id===t);if(!n){console.warn(`Session with ID ${t} not found. Loading most recent as fallback.`);const s=[...e.chatSessions].filter(o=>!o.archived).sort((o,i)=>i.updatedAt-o.updatedAt)[0];A(s?s.id:null);return}e.activeSessionId=t,n.linkedEntity&&(e.activeEntity={...n.linkedEntity}),a.setProject(e),a.updateAndPersistState(),a.bus.publish("session:loaded",{session:n})}function Jt(t,e){if(e?.stopPropagation(),!confirm("Are you sure you want to delete this chat session?"))return;const n=N();if(!n)return;const s=n.chatSessions.findIndex(o=>o.id===t);if(s!==-1)if(n.chatSessions.splice(s,1),n.activeSessionId===t){const o=[...n.chatSessions].filter(i=>!i.archived).sort((i,r)=>r.updatedAt-i.updatedAt)[0];n.activeSessionId=o?o.id:null,a.updateAndPersistState(n),A(n.activeSessionId)}else a.updateAndPersistState(n),j()}function Yt(t,e){e?.stopPropagation();const n=N(),s=n?.chatSessions.find(o=>o.id===t);s&&(s.pinned=!s.pinned,s.updatedAt=Date.now(),a.updateAndPersistState(n),j())}function Kt(t,e){e?.stopPropagation();const n=N(),s=n?.chatSessions.find(i=>i.id===t);if(!s){f("Error: Could not find session to clone.","Error");return}const o=JSON.parse(JSON.stringify(s));o.id=Ne(),o.name=`${s.name} (Copy)`,o.createdAt=Date.now(),o.updatedAt=Date.now(),o.pinned=!1,o.archived=!1,n.chatSessions.unshift(o),n.activeSessionId=o.id,a.updateAndPersistState(n),A(o.id)}function Vt(t,e){e?.stopPropagation();const n=N(),s=n?.chatSessions.find(o=>o.id===t);if(s)if(s.archived=!s.archived,s.archived&&(s.pinned=!1),s.updatedAt=Date.now(),n.activeSessionId===t&&s.archived){const o=n.chatSessions.find(i=>!i.archived);n.activeSessionId=o?o.id:null,a.updateAndPersistState(n),A(n.activeSessionId)}else a.updateAndPersistState(n),j()}async function $e(t){const e=t||N()?.chatSessions;if(!e)return;const n=it();if(!n){console.error("[SaveAllSessions] Cannot save, DB not available.");return}const s=n.transaction(L,"readwrite"),o=s.objectStore(L);for(const i of e)o.put(i);return new Promise((i,r)=>{s.oncomplete=()=>i(),s.onerror=()=>r(s.error)})}function Xt(t){try{const e=a.getProject();if(!e)throw new Error("Project not found.");const n=t?.sessionId||e.activeSessionId;if(!n)throw new Error("No session is active or selected for download.");console.log(`Attempting to download session with ID: ${n}`);const s=e.chatSessions.find(u=>u.id===n);if(!s)throw new Error(`Session with ID ${n} could not be found.`);let o=`Chat Session: ${s.name||"Untitled Session"}
`;o+=`Exported on: ${new Date().toLocaleString()}
`,s.linkedEntity&&(o+=`Associated Entity: ${s.linkedEntity.name} (${s.linkedEntity.type})
`),o+=`============================================

`;const i=s.history||[];i.length===0?o+="[This session has no messages.]":i.forEach(u=>{const m=u.timestamp?Ct(u.timestamp):"No Timestamp",g=(u.speaker||u.role||"unknown").toUpperCase(),y=Array.isArray(u.content)?u.content.find(p=>p.type==="text")?.text||"[multimodal content]":u.content;o+=`[${m}] ${g}:
${y}

--------------------------------

`}),console.log(`Final text content length: ${o.length}`);const r=new Blob([o],{type:"text/plain;charset=utf-8"}),c=URL.createObjectURL(r),l=document.createElement("a"),d=(s.name||"untitled").replace(/[^a-z0-9]/gi,"_").toLowerCase();l.download=`session-export-${d}.txt`,l.href=c,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),URL.revokeObjectURL(c),console.log("Download initiated and cleanup complete.")},100)}catch(e){console.error("Download Chat Session failed:",e),f(`Failed to download chat: ${e.message}`,"Error")}}function Qt({height:t}){const e=a.getProject(),n=e?.chatSessions.find(s=>s.id===e.activeSessionId);n&&t&&(n.composerHeight=t)}async function Zt(){const t=a.getProject(),e=t?.chatSessions.find(n=>n.id===t.activeSessionId);if(!e){console.warn("[AutoSave] Could not find active session to save.");return}try{await I(L,"readwrite","put",e)}catch(n){console.error(`[AutoSave] Failed to save active session (${e.id}):`,n)}}function en({sessionId:t,newName:e}){const n=a.getProject();if(!n)return;const s=n.chatSessions.find(o=>o.id===t);!s||s.name!=="New Chat"||(s.name=e,s.updatedAt=Date.now(),a.updateAndPersistState(),a.bus.publish("session:listChanged"),n.activeSessionId===t&&a.bus.publish("ui:updateChatTitle",{title:e}))}async function tn(){const t=a.getProject();if(!t||!t.id)return console.warn("[AutoSave] Aborted: Project not available for saving."),!1;console.log("[AutoSave] Persisting essential data to IndexedDB...");try{return await ie(),await Zt(),console.log("[AutoSave] Essential project state successfully persisted."),!0}catch(e){return console.error("[AutoSave] Failed to persist project state:",e),!1}}function nn(){let t;a.bus.subscribe("autosave:required",()=>{clearTimeout(t),t=setTimeout(async()=>{a.isAutoSaveDirty()&&await tn()&&a.setAutoSaveDirty(!1)},2e3)})}function sn(){a.isUserDirty()?(a.setState("pendingActionAfterSave",()=>{document.getElementById("load-project-input").click()}),Pe()):document.getElementById("load-project-input").click()}function on(){const t=`proj_${Date.now()}`,e="Default Agent";return{id:t,name:"Untitled Project",isDirtyForUser:!1,activeEntity:{type:"agent",name:e},agentPresets:{[e]:{...ve,model:"",activeMemories:[]}},agentGroups:{},memories:JSON.parse(JSON.stringify(Ge)),chatSessions:[],activeSessionId:null,summaryLogs:[],globalSettings:{fontFamilySelect:"'Sarabun', sans-serif",apiKey:"",ollamaBaseUrl:"http://localhost:11434",systemUtilityAgent:{...V},summarizationPromptPresets:JSON.parse(JSON.stringify(be))}}}async function Y(){console.log("Proceeding with creating a new project...");try{const t=on();await Z(t.id),await Ce([L,T]),await H(t,!0)}catch(t){console.error("Failed to proceed with creating a new project:",t),f("Could not create a new project.","Error")}}function K(){a.isUserDirty()?(a.setState("pendingActionAfterSave",Y),Pe()):Y()}function an(t){const e=t.target.files[0];if(!e)return;console.log(`[OpenProject] File selected: ${e.name}. Reading file...`);const n=new FileReader;n.onload=async s=>{try{const o=s.target.result;console.log("[OpenProject] File read complete. Parsing JSON...");const i=JSON.parse(o);if(!i.id||!i.name)throw new Error("Invalid project file format.");console.log(`[OpenProject] JSON parsed successfully for project: ${i.name}. Loading data...`),await H(i,!0)}catch(o){console.error("[OpenProject] Failed to load project:",o),f(`Error loading project: ${o.message}`,"Error")}},n.onerror=()=>{console.error("[OpenProject] FileReader error."),f("Failed to read the selected file.","Error")},n.readAsText(e),t.target.value=""}function rn(){try{const t=a.getState().pendingFileToOpen;if(!t)return;dn(t),a.setState("pendingFileToOpen",null)}catch(t){console.error("Failed to proceed with opening project:",t),f("Could not open the project file.","Error")}}async function Oe(t=!1){const e=a.getProject();t||e.name==="Untitled Project"?a.bus.publish("ui:showSaveAsModal"):await Ue(e.name)}async function Ue(t){const e=t?.trim();if(!e)return f("Please enter a project name."),!1;const n=a.getProject();n.name=e,a.bus.publish("project:nameChanged",e),a.setUserDirty(!1);let s=JSON.parse(JSON.stringify(a.getProject()));s=qe(s);try{const o=JSON.stringify(s,null,2),i=new Blob([o],{type:"application/json"}),r=URL.createObjectURL(i),c=document.createElement("a");return c.href=r,c.download=`${e.replace(/\s+/g,"_")}.json`,document.body.appendChild(c),c.click(),URL.revokeObjectURL(r),document.body.removeChild(c),a.bus.publish("ui:hideSaveAsModal"),a.setAutoSaveDirty(!1),await pn(),a.getState().pendingActionAfterSave&&await ln(),!0}catch(o){return console.error("Failed to save project:",o),f("Failed to save project file.","Error"),a.setUserDirty(!0),!1}}async function cn(t){Xe();const e=a.getState().pendingActionAfterSave;switch(a.setState("pendingActionAfterSave",null),t){case"save":await Oe(!1);break;case"discard":typeof e=="function"&&await e();break}}async function ln(){const t=a.getState().pendingActionAfterSave;a.setState("pendingActionAfterSave",null),t==="open"?await rn():t==="new"&&await Y()}async function dn(t){const e=new FileReader;e.onload=async n=>{try{const s=JSON.parse(n.target.result);if(s&&s.id&&s.name&&s.agentPresets)await H(s,!0),f(`Project '${s.name}' loaded successfully!`,"Project Loaded");else throw new Error("Invalid project file format.")}catch(s){f(`Error loading project: ${s.message}`,"Error"),console.error(s)}},e.readAsText(t)}async function un(t){if(!t)throw new Error("Cannot load last project: Project ID is missing.");await Z(t);const e=await I(T,"readonly","get",he);if(e&&e.data&&e.data.id===t){const n=e.data,s=await I(L,"readonly","getAll"),o={...n,chatSessions:s||[]};await H(o,!1),console.log("Successfully loaded the last active project from IndexedDB.")}else throw new Error("Project data in DB is invalid or mismatched with last known ID.")}async function H(t,e=!1){const n=qe(t);await Z(n.id),e&&(n.isDirtyForUser=!1,await mn(n)),a.setProject(n),await gn(),a.bus.publish("userDirty:changed",a.isUserDirty()),a.setAutoSaveDirty(!1),(n.globalSettings.apiKey||n.globalSettings.ollamaBaseUrl)&&await Ee();const s=(n.chatSessions||[]).filter(o=>!o.archived);if(s.length===0)await De();else{const o=n.activeSessionId,i=s.find(r=>r.id===o)||s.sort((r,c)=>c.updatedAt-r.updatedAt)[0];await A(i.id)}a.bus.publish("project:loaded",{projectData:n}),localStorage.setItem("lastActiveProjectId",n.id)}async function mn(t){await Ce([L,T]),await ie(t),await $e(t.chatSessions),console.log("Database has been rewritten with new project data.")}async function ie(t){const e=t||a.getProject();if(!e||!e.id){console.warn("Cannot persist metadata: project or project ID is missing.");return}const n={...e};delete n.chatSessions,await I(T,"readwrite","put",{id:he,data:n})}async function pn(){const t=a.getProject();if(!t||!t.id)return!1;console.log("[AutoSave] Persisting project to IndexedDB...");try{return await ie(),await $e(),console.log("[AutoSave] Project state successfully persisted."),!0}catch(e){return console.error("[AutoSave] Failed to persist project state:",e),!1}}async function gn(){const t=a.getProject();if(!t||!t.globalSettings)return;const e=t.globalSettings;document.getElementById("apiKey").value=e.apiKey||"",document.getElementById("ollamaBaseUrl").value=e.ollamaBaseUrl||"",a.bus.publish("ui:applyFontSettings");const n=e.systemUtilityAgent||V;document.getElementById("system-utility-model-select").value=n.model||"",document.getElementById("system-utility-prompt").value=n.systemPrompt||"",document.getElementById("system-utility-summary-prompt").value=n.summarizationPrompt||"",document.getElementById("system-utility-temperature").value=n.temperature??1,document.getElementById("system-utility-topP").value=n.topP??1,a.bus.publish("ui:renderSummarizationSelector")}function yn(t){const e=a.getProject();e.globalSettings.fontFamilySelect=t,a.setProject(e),a.updateAndPersistState(),a.bus.publish("ui:applyFontSettings")}function fn(t){const e=a.getProject();e.globalSettings.apiKey=t,a.setProject(e),a.updateAndPersistState(),a.bus.publish("api:loadModels")}function hn(){const t=a.getProject();if(!t.globalSettings)return;const e=t.globalSettings.systemUtilityAgent;e.model=document.getElementById("system-utility-model-select").value,e.systemPrompt=document.getElementById("system-utility-prompt").value,e.summarizationPrompt=document.getElementById("system-utility-summary-prompt").value,e.temperature=parseFloat(document.getElementById("system-utility-temperature").value),e.topP=parseFloat(document.getElementById("system-utility-topP").value),a.setProject(t),a.updateAndPersistState(),a.bus.publish("ui:renderSummarizationSelector")}function qe(t){if(t.isDirtyForUser===void 0&&(t.isDirtyForUser=!0),t.agentGroups)for(const e in t.agentGroups){const n=t.agentGroups[e];n&&!Array.isArray(n.agents)&&(n.agents=[])}return t}async function bn(t,e){a.setStagedEntity(null,!1);const n=a.getProject();n.activeEntity={type:t,name:e};const s=n.chatSessions.find(o=>o.id===n.activeSessionId);s&&(s.groupChatState&&(s.groupChatState.isRunning=!1),s.linkedEntity={...n.activeEntity},s.updatedAt=Date.now()),a.setProject(n),a.updateAndPersistState(),a.bus.publish("entity:selected",{type:t,name:e}),a.bus.publish("session:listChanged")}function vn({type:t,name:e}){const n={type:t,name:e},s=a.getStagedEntity(),o=a.getProject().activeEntity;if(s&&s.name===e&&s.type===t){a.bus.publish("entity:select",n);return}if(o&&o.name===e&&o.type===t){a.setStagedEntity(null);return}a.setStagedEntity(n)}function Sn(){console.log("ðŸš€ Initializing Settings UI...");const t=a.bus;document.getElementById("settings-btn")?.addEventListener("click",U),document.querySelector(".close-settings-btn")?.addEventListener("click",U);const e=(s,o,i,r=c=>c.target.value)=>{const c=document.getElementById(s);c&&c.addEventListener(o,l=>{t.publish(i,r(l))})};e("fontFamilySelect","change","settings:fontChanged"),e("apiKey","change","settings:apiKeyChanged"),e("ollamaBaseUrl","change","settings:ollamaUrlChanged"),e("load-models-btn","click","api:loadModels",()=>{}),["system-utility-model-select","system-utility-prompt","system-utility-summary-prompt","system-utility-temperature","system-utility-topP"].forEach(s=>{const o=document.getElementById(s);o&&o.addEventListener("change",()=>t.publish("settings:systemAgentChanged"))}),e("system-utility-summary-preset-select","change","settings:summaryPresetChanged"),e("save-summary-preset-btn","click","settings:saveSummaryPreset",()=>{}),console.log("âœ… Settings UI and all its listeners are correctly initialized.")}function En(t,e){const s=a.getProject().activeEntity,o=a.getStagedEntity(),i=document.createElement("div");return i.className="item agent-item",i.dataset.agentName=t,s?.type==="agent"&&s.name===t?i.classList.add("active"):o?.type==="agent"&&o.name===t&&i.classList.add("staged"),i.innerHTML=`
    <div class="item-header">
        <span class="item-name"><span class="item-icon">${e.icon||"ðŸ¤–"}</span> ${t}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="agent:edit" title="Edit Agent">
                <span class="material-symbols-outlined">edit</span>
            </button>             
            <button class="btn-icon danger" data-action="agent:delete" title="Delete Agent">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,i}function wn(t){if(!t)return;const e=a.getProject();if(!e||!e.agentPresets)return;t.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>ðŸ¤– Agent Presets</h3>
                <button class="btn-icon" data-action="agent:create" title="Create New Agent">+</button>
            </summary>
            <div class="section-box">
                <div id="agentPresetList" class="item-list"></div>
            </div>
        </details>
    `);const s=t.querySelector("#agentPresetList:last-of-type");if(!s)return;const o=e.agentPresets;for(const i in o)s.appendChild(En(i,o[i]))}function He(){const t=a.getState().allProviderModels||[],e=a.getProject(),n=[document.getElementById("agent-model-select"),document.getElementById("system-utility-model-select")];if(n.some(i=>!i)||!e.globalSettings)return;const s=document.createElement("optgroup");s.label="OpenRouter";const o=document.createElement("optgroup");o.label="Ollama",t.forEach(i=>{const r=new Option(i.name,i.id);(i.provider==="openrouter"?s:o).appendChild(r)}),n.forEach(i=>{const r=i.value;if(i.innerHTML='<option value="">-- Select a Model --</option>',s.childElementCount>0&&i.appendChild(s.cloneNode(!0)),o.childElementCount>0&&i.appendChild(o.cloneNode(!0)),i.id==="system-utility-model-select")i.value=e.globalSettings.systemUtilityAgent?.model||"";else if(i.id==="agent-model-select"){const c=a.getState().editingAgentName;c&&e.agentPresets[c]?i.value=e.agentPresets[c].model:i.value=r}})}function de(t=!1,e=null){a.setState("editingAgentName",t?e:null);const n=a.getProject(),s=a.getState().allProviderModels,o=n.globalSettings.systemUtilityAgent,i=s.find(r=>r.id===o.model);if(document.getElementById("agent-modal-title").textContent=t?`Edit Agent: ${e}`:"Create New Agent",document.getElementById("enhancer-model-name").textContent=i?.name||o.model||"Not Configured",t&&e){const r=n.agentPresets[e];if(!r){f("Agent not found.");return}document.getElementById("agent-name-input").value=e,Object.keys(B).forEach(c=>{const l=document.getElementById(c);if(l&&c!=="agent-name-input"){const d=r[B[c]];l[l.type==="checkbox"?"checked":"value"]=d!==void 0?d:""}})}else document.getElementById("agent-name-input").value="",Object.keys(B).forEach(r=>{const c=document.getElementById(r);if(c&&r!=="agent-name-input"){const l=ve[B[r]];c[c.type==="checkbox"?"checked":"value"]=l!==void 0?l:""}}),document.getElementById("enhancer-prompt-input").value="";He(),document.getElementById("agent-editor-modal").style.display="flex"}function ue(){document.getElementById("agent-editor-modal").style.display="none",a.setState("editingAgentName",null)}function Pn(){const t=document.getElementById("agent-editor-modal");t&&t.addEventListener("click",e=>{const n=e.target;n.matches(".modal-actions .btn:not(.btn-secondary)")?a.bus.publish("agent:save"):n.closest("#generate-agent-profile-btn")?a.bus.publish("agent:generateProfile"):(n.matches(".btn-secondary")||n.closest(".modal-close-btn"))&&ue()}),a.bus.subscribe("agent:profileGenerated",e=>{console.log("ðŸŽ‰ 'agent:profileGenerated' event received. Populating form...",e),document.getElementById("agent-name-input").value=e.agent_name||"",document.getElementById("agent-icon-input").value=e.agent_icon||"ðŸ¤–",document.getElementById("agent-system-prompt").value=e.system_prompt||"",document.getElementById("agent-temperature").value=e.temperature??1,document.getElementById("agent-topP").value=e.top_p??1,document.getElementById("agent-topK").value=e.top_k??0,document.getElementById("agent-presence-penalty").value=e.presence_penalty??0,document.getElementById("agent-frequency-penalty").value=e.frequency_penalty??0}),a.bus.subscribe("agent:enhancerStatus",({text:e,color:n})=>{const s=document.getElementById("enhancer-status");s&&(s.textContent=e,s.style.color=n||"var(--text-dark)")}),a.bus.subscribe("models:loaded",He),a.bus.subscribe("agent:editorShouldClose",ue),console.log("âœ… Agent UI Initialized (Conflicting studio listener removed).")}function Cn(t){const n=a.getProject().activeEntity,s=a.getStagedEntity(),o=document.createElement("div");return o.className="item group-item",o.dataset.groupName=t,n?.type==="group"&&n.name===t?o.classList.add("active"):s?.type==="group"&&s.name===t&&o.classList.add("staged"),o.innerHTML=`
     <div class="item-header">
        <span class="item-name"><span class="item-icon">ðŸ¤</span> ${t}</span>
        <div class="item-actions">
            <button class="btn-icon" data-action="group:edit" title="Edit Group">
                <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="btn-icon danger" data-action="group:delete" title="Delete Group">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </div>`,o}function Ln(t){if(!t)return;const e=a.getProject();if(!e||!e.agentGroups)return;t.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>ðŸ¤ Agent Groups</h3>
                <button class="btn-icon" data-action="group:create" title="Create New Group">+</button>
            </summary>
            <div class="section-box">
                <div id="agentGroupList" class="item-list"></div>
            </div>
        </details>
    `);const s=t.querySelector("#agentGroupList:last-of-type");if(!s)return;const o=e.agentGroups;for(const i in o)s.appendChild(Cn(i))}function Fe(){const t=document.getElementById("group-flow-select").value,e=document.getElementById("group-rounds-control"),n=document.getElementById("group-timer-control");!e||!n||(t==="round-robin"?(e.classList.remove("hidden"),n.classList.add("hidden")):(e.classList.add("hidden"),n.classList.remove("hidden")))}function me(t=!1,e=null){a.setState("editingGroupName",t?e:null);const n=a.getProject(),s=t?n.agentGroups[e]:null;document.getElementById("agent-group-modal-title").textContent=t?`Edit Group: ${e}`:"Create New Agent Group",document.getElementById("group-name-input").value=t?e:"";const o=document.getElementById("group-member-list");o.innerHTML="";const i=s?s.agents||[]:[],r=Object.keys(n.agentPresets),c=s?[...i]:[];r.forEach(l=>{c.includes(l)||c.push(l)}),c.forEach(l=>{const d=i.includes(l),u=document.createElement("div");u.className="agent-sortable-item",u.dataset.agentName=l,u.dataset.id=l;const m=`agent-cb-${l.replace(/\s+/g,"-")}`;u.innerHTML=`
            <input type="checkbox" id="${m}" ${d?"checked":""}>
            <label for="${m}">${l}</label>
            <span class="drag-handle">&#x2630;</span>
        `,u.querySelector('input[type="checkbox"]').addEventListener("change",()=>ge(null)),o.appendChild(u)}),window.groupSortable&&window.groupSortable.destroy(),window.groupSortable=new Sortable(o,{animation:150,handle:".drag-handle"}),ge(s?.moderatorAgent),document.getElementById("group-flow-select").value=s?.flowType||"auto-moderator",document.getElementById("group-max-turns-input").value=s?.maxTurns||1,document.getElementById("group-timer-input").value=s?.timerInSeconds||0,document.getElementById("group-summarization-threshold-input").value=s?.summarizationTokenThreshold??3e3,Fe(),document.getElementById("agent-group-editor-modal").style.display="flex"}function pe(){window.groupSortable&&(window.groupSortable.destroy(),window.groupSortable=null),document.getElementById("agent-group-editor-modal").style.display="none",a.setState("editingGroupName",null)}function ge(t=null){const e=document.getElementById("group-moderator-select"),n=document.querySelectorAll("#group-member-list .agent-sortable-item"),s=Array.from(n).filter(i=>i.querySelector('input[type="checkbox"]').checked).map(i=>i.dataset.agentName),o=e.value;e.innerHTML='<option value="">-- Select Moderator --</option>',s.forEach(i=>{e.add(new Option(i,i))}),t&&s.includes(t)?e.value=t:s.includes(o)&&(e.value=o)}function In(){a.bus.subscribe("group:editorShouldClose",pe);const t=document.getElementById("agent-group-editor-modal");t&&(t.addEventListener("click",e=>{e.target.matches(".modal-actions .btn:not(.btn-secondary)")?a.bus.publish("group:save"):(e.target.matches(".btn-secondary")||e.target.closest(".modal-close-btn"))&&pe()}),t.addEventListener("click",e=>{if(e.target.matches(".stepper-btn")){const n=e.target.parentElement.querySelector('input[type="number"]');if(!n)return;let s=parseInt(n.value,10)+parseInt(e.target.dataset.step,10);s=Math.max(n.min,Math.min(n.max,s)),n.value=s}})),document.getElementById("group-flow-select")?.addEventListener("change",Fe),console.log("âœ… Group UI Initialized (Studio listener removed).")}let _=null;function jn(t,e,n){const s=document.createElement("div");s.className=`item memory-item ${e?"":"inactive"}`,s.dataset.name=t.name,s.dataset.memoryIndex=n;const i=X([{label:"Edit...",action:"memory:edit",data:{index:n}},{label:"Delete",action:"memory:delete",data:{index:n},isDestructive:!0}]),r=document.createElement("div");r.className=`memory-toggle ${e?"active":""}`,r.title=`Click to ${e?"deactivate":"activate"}`,r.dataset.action="memory:toggle";const c=document.createElement("span");c.className="item-name",c.textContent=t.name;const l=document.createElement("div");return l.className="item-header",l.appendChild(r),l.appendChild(c),l.appendChild(i),s.appendChild(l),s}function An(t){if(!t)return;const e=a.getProject();if(!e)return;const n=document.createElement("details");n.className="collapsible-section memory-section",n.open=!0;const s=document.createElement("summary");s.className="section-header",s.innerHTML="<h3>ðŸ§  Command Memories</h3>";const o=[{label:"New Memory...",action:"memory:create"},{label:"Export Package...",action:"memory:exportPackage"},{label:"Import Package...",action:"memory:importPackage"}];s.appendChild(X(o)),n.appendChild(s);const i=document.createElement("div");i.className="section-box",n.appendChild(i);const r=e.agentPresets?.[e.activeEntity?.name];if(!r)i.innerHTML='<p class="no-items-message">Select an Agent to see memories.</p>';else{i.innerHTML=`
            <details id="active-memories-details" open><summary>Active Memories</summary><div id="activeMemoriesList" class="item-list"></div></details>
            <details id="inactiveMemoriesSection" open><summary>Inactive Memories</summary><div id="inactiveMemoriesList" class="item-list"></div></details>
        `;const c=i.querySelector("#activeMemoriesList"),l=i.querySelector("#inactiveMemoriesList"),d=r.activeMemories||[];(e.memories||[]).forEach((m,g)=>{const y=d.includes(m.name);(y?c:l).appendChild(jn(m,y,g))}),_&&_.destroy(),_=new Sortable(c,{animation:150,onEnd:m=>{const g=a.getProject().agentPresets[a.getProject().activeEntity.name];if(!g)return;const y=m.item.dataset.name;g.activeMemories.splice(m.oldDraggableIndex,1),g.activeMemories.splice(m.newDraggableIndex,0,y),a.bus.publish("studio:contentShouldRender")}})}t.appendChild(n)}function Mn(){a.bus.subscribe("memory:editorShouldClose",fe);const t=document.getElementById("memory-editor-modal");t&&t.addEventListener("click",e=>{const n=e.target;n.matches(".modal-actions .btn:not(.btn-secondary)")&&a.bus.publish("memory:save"),(n.matches(".btn-secondary")||n.closest(".modal-close-btn")||n===t)&&fe()}),console.log("âœ… Memory UI Initialized (Studio listener removed).")}function ye(t=null){const e=a.getProject(),n=document.getElementById("memory-editor-modal");if(n){if(t!==null&&e.memories[t]){const s=e.memories[t];n.querySelector("#memory-modal-title").textContent="Edit Memory",n.querySelector("#memory-name-input").value=s.name,n.querySelector("#memory-content-input").value=s.content,n.querySelector("#memory-edit-index").value=t}else n.querySelector("#memory-modal-title").textContent="Create New Memory",n.querySelector("#memory-name-input").value="",n.querySelector("#memory-content-input").value="",n.querySelector("#memory-edit-index").value="";n.style.display="flex"}}function fe(){document.getElementById("memory-editor-modal").style.display="none"}function kn(t){const e=document.createElement("div");e.className="item summary-log-item",e.dataset.logId=t.id;const n=a.getProject(),s=n.chatSessions.find(u=>u.id===n.activeSessionId);s&&s.summaryState?.activeSummaryId===t.id&&e.classList.add("active");const o=new Date(t.timestamp).toLocaleString("th-TH",{dateStyle:"short",timeStyle:"short"}),r=X([{label:"View",action:"summary:view"},{label:"Load to Context",action:"summary:load"},{label:"Delete",action:"summary:delete",isDestructive:!0}]),c=document.createElement("div");c.className="item-header";const l=document.createElement("span");l.className="item-name",l.innerHTML=`<span class="item-icon">ðŸ’¡</span> ${t.summary}`,l.title=`${t.summary}
Created: ${o}`;const d=document.createElement("div");return d.className="item-actions",d.appendChild(r),c.appendChild(l),c.appendChild(d),e.appendChild(c),e}function xn(t){if(!t||typeof t.insertAdjacentHTML!="function")return;const e=a.getProject();if(!e||!e.summaryLogs)return;t.insertAdjacentHTML("beforeend",`
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>ðŸ’¡ Summary Logs</h3>
            </summary>
            <div class="section-box">
                <div id="summaryLogList" class="item-list"></div>
            </div>
        </details>
    `);const s=t.querySelector("#summaryLogList");if(!s)return;const o=e.summaryLogs.reduce((i,r)=>{const c=r.sourceSessionId;if(c){const l=e.chatSessions.find(d=>d.id===c);i[c]||(i[c]={name:l?l.name:"Unknown Session",logs:[]}),i[c].logs.push(r)}return i},{});if(Object.keys(o).length===0){s.innerHTML='<p class="no-items-message">No summaries have been generated yet.</p>';return}for(const i in o){const r=o[i],c=r.logs.sort((u,m)=>m.timestamp-u.timestamp),l=document.createElement("details");l.className="collapsible-section";const d=document.createElement("summary");d.textContent=`For: ${r.name}`,l.appendChild(d),c.forEach(u=>{l.appendChild(kn(u))}),i===e.activeSessionId&&c.length>0&&(l.open=!0),s.appendChild(l)}}function Re(t){const n=a.getProject().summaryLogs.find(o=>o.id===t);if(!n)return;const s=document.getElementById("view-summary-modal");s&&(s.querySelector("#view-summary-title").textContent=n.summary,s.querySelector("#view-summary-content").textContent=n.content,s.style.display="flex")}function Bn(){const t=document.getElementById("studio-panel");t&&(t.addEventListener("click",e=>{const n=e.target.closest(".summary-log-item a");if(!n)return;e.preventDefault();const s=n.closest(".summary-log-item").dataset.logId,o=n.dataset.action;o==="view"?a.bus.publish("summary:view",{logId:s}):o==="load"?a.bus.publish("summary:load",{logId:s}):o==="delete"&&a.bus.publish("summary:delete",{logId:s})}),document.querySelector("#view-summary-modal .btn-secondary")?.addEventListener("click",()=>{document.getElementById("view-summary-modal").style.display="none"}),a.bus.subscribe("summary:view",({logId:e})=>Re(e)),console.log("Summary UI Initialized."))}function W(){const t=document.querySelector("#studio-panel .studio-assets-container");t&&(t.innerHTML="",wn(t),Ln(t),An(t),xn(t))}function Tn(){const t=document.getElementById("studio-panel");t&&(t.addEventListener("click",e=>{const n=e.target,s=n.closest("[data-action]"),o=n.closest(".item");if(s){e.preventDefault(),e.stopPropagation();const i=s.dataset.action;let r={...s.dataset,...o?.dataset};i==="toggle-menu"?Q(e):(a.bus.publish(i,r),s.closest(".dropdown.open")?.classList.remove("open"));return}if(o){e.preventDefault();const i=o.dataset.agentName,r=o.dataset.groupName;i?a.bus.publish("studio:itemClicked",{type:"agent",name:i}):r&&a.bus.publish("studio:itemClicked",{type:"group",name:r});return}a.setStagedEntity(null)}),a.bus.subscribe("entity:selected",W),a.bus.subscribe("studio:contentShouldRender",W),a.bus.subscribe("entity:staged",W))}async function Nn(){const t=document.getElementById("enhancer-prompt-input").value.trim();if(!t){f("Please describe the agent you want to create.","Error");return}console.log("ðŸ§  generateAgentProfile handler received event. Enhancer Prompt:",t),a.bus.publish("agent:enhancerStatus",{text:"Generating profile...",color:"var(--text-dark)"});const e=a.getProject().globalSettings.systemUtilityAgent;if(!e||!e.model){a.bus.publish("agent:enhancerStatus",{text:"Error: System Utility Model not configured.",color:"var(--error-color)"});return}const n=`You are an expert in designing LLM agent profiles. Based on the user's request, create a complete agent profile. Your response MUST be a single, valid JSON object with the following keys: "agent_name" (a creative and fitting name for the agent), "agent_icon" (a single, relevant emoji for the agent), "system_prompt" (string), "temperature" (number), "top_p" (number), "top_k" (number), "presence_penalty" (number), "frequency_penalty" (number). For the parameters, choose values that are optimal for the requested task (e.g., creative tasks need higher temperature). User's Request: "${t}"`;try{const s=await O(e,[{role:"user",content:n}]);console.log("ðŸ¤– Raw response from LLM:",s);const o=s.match(/{.*}/s);if(!o)throw new Error("LLM did not return a valid JSON object.");const i=JSON.parse(o[0]);a.bus.publish("agent:profileGenerated",i),a.bus.publish("agent:enhancerStatus",{text:"Profile generated successfully!",color:"var(--success-color)"})}catch(s){console.error("Agent Profile Generation Error:",s),a.bus.publish("agent:enhancerStatus",{text:`Error: ${s.message}`,color:"var(--error-color)"})}finally{setTimeout(()=>a.bus.publish("agent:enhancerStatus",{text:""}),5e3)}}function Dn(){const e=document.getElementById("agent-name-input").value.trim();if(!e){f("Please enter a name for the agent.","Error");return}const n=a.getProject(),s=a.getState().editingAgentName;if(s!==e&&n.agentPresets[e]){f(`An agent named '${e}' already exists.`,"Error");return}const o={};if(Object.keys(B).forEach(i=>{const r=B[i];if(r==="name")return;const c=document.getElementById(i);c&&(o[r]=c.type==="checkbox"?c.checked:c.type==="number"?parseFloat(c.value):c.value)}),o.icon||(o.icon="ðŸ¤–"),s&&s!==e){const i=n.agentPresets[s];delete n.agentPresets[s],n.agentPresets[e]={...i,...o},n.chatSessions.forEach(r=>{r.linkedEntity?.type==="agent"&&r.linkedEntity.name===s&&(r.linkedEntity.name=e)}),Object.values(n.agentGroups).forEach(r=>{const c=r.agents.indexOf(s);c>-1&&(r.agents[c]=e),r.moderatorAgent===s&&(r.moderatorAgent=e)}),n.activeEntity.type==="agent"&&n.activeEntity.name===s&&(n.activeEntity.name=e)}else s?n.agentPresets[s]={...n.agentPresets[s],...o}:(o.activeMemories=[],n.agentPresets[e]=o,n.activeEntity={type:"agent",name:e});a.setProject(n),a.updateAndPersistState(),a.bus.publish("studio:contentShouldRender"),a.bus.publish("agent:editorShouldClose")}function $n(t){const e=a.getProject();if(!t||Object.keys(e.agentPresets).length<=1){f("Cannot delete the last agent.","Error");return}confirm(`Are you sure you want to delete the agent '${t}'? This action cannot be undone.`)&&(delete e.agentPresets[t],Object.values(e.agentGroups).forEach(n=>{n.agents=n.agents.filter(s=>s!==t),n.moderatorAgent===t&&(n.moderatorAgent=n.agents[0]||"")}),e.chatSessions.forEach(n=>{n.linkedEntity?.type==="agent"&&n.linkedEntity.name===t&&(n.linkedEntity={type:"agent",name:Object.keys(e.agentPresets)[0]})}),e.activeEntity.type==="agent"&&e.activeEntity.name===t&&(e.activeEntity={type:"agent",name:Object.keys(e.agentPresets)[0]}),a.setProject(e),a.updateAndPersistState(),a.bus.publish("agent:listChanged"),a.bus.publish("entity:selected",e.activeEntity))}function On(){const t=a.getProject(),e=a.getState().editingGroupName,n=document.getElementById("group-name-input").value.trim();if(!n){f("Group name cannot be empty.","Error");return}if(n!==e&&t.agentGroups[n]){f(`A group named "${n}" already exists.`,"Error");return}const s=window.groupSortable?window.groupSortable.toArray():[],o=document.querySelectorAll("#group-member-list .agent-sortable-item"),i=Array.from(o).filter(l=>l.querySelector('input[type="checkbox"]').checked).map(l=>l.dataset.agentName),c={agents:s.filter(l=>i.includes(l)),moderatorAgent:document.getElementById("group-moderator-select").value,flowType:document.getElementById("group-flow-select").value,maxTurns:parseInt(document.getElementById("group-max-turns-input").value,10),timerInSeconds:parseInt(document.getElementById("group-timer-input").value,10),summarizationTokenThreshold:parseInt(document.getElementById("group-summarization-threshold-input").value,10)};e&&e!==n&&(delete t.agentGroups[e],t.chatSessions.forEach(l=>{l.linkedEntity?.type==="group"&&l.linkedEntity?.name===e&&(l.linkedEntity.name=n)})),t.agentGroups[n]=c,a.setProject(t),a.updateAndPersistState(),a.bus.publish("group:editorShouldClose"),f(`Group "${n}" saved successfully.`,"Success"),a.bus.publish("studio:contentShouldRender")}function Un({groupName:t}){if(!confirm(`Are you sure you want to delete the group "${t}"? This cannot be undone.`))return;const e=a.getProject();delete e.agentGroups[t],a.setProject(e),a.updateAndPersistState(),a.bus.publish("group:listChanged"),f(`Group "${t}" has been deleted.`,"Success")}function qn({name:t}){const e=a.getProject();if(e.activeEntity?.type!=="agent")return;const n=e.agentPresets[e.activeEntity.name];if(!n)return;n.activeMemories=n.activeMemories||[];const s=n.activeMemories.indexOf(t);s>-1?n.activeMemories.splice(s,1):n.activeMemories.push(t),a.updateAndPersistState(),a.bus.publish("studio:contentShouldRender")}function Hn(){const t=a.getProject(),e=document.getElementById("memory-name-input").value.trim(),n=document.getElementById("memory-content-input").value,s=document.getElementById("memory-edit-index").value;if(!e){f("Memory name cannot be empty.","Error");return}if(s!==""){const o=t.memories[s].name;t.memories[s]={name:e,content:n},Object.values(t.agentPresets).forEach(i=>{const r=i.activeMemories.indexOf(o);r>-1&&(i.activeMemories[r]=e)})}else{if(t.memories.some(o=>o.name===e)){f(`A memory named "${e}" already exists.`,"Error");return}t.memories.push({name:e,content:n})}a.setProject(t),a.updateAndPersistState(),a.bus.publish("memory:editorShouldClose"),a.bus.publish("studio:contentShouldRender"),f(`Memory "${e}" saved successfully.`,"Success")}function Fn({index:t}){const e=a.getProject();if(!e.memories[t])return;const n=e.memories[t].name;e.memories.splice(t,1),Object.values(e.agentPresets).forEach(s=>{if(s.activeMemories){const o=s.activeMemories.indexOf(n);o>-1&&s.activeMemories.splice(o,1)}}),a.updateAndPersistState(),a.bus.publish("studio:contentShouldRender")}function Rn(){const e=document.getElementById("system-utility-summary-preset-select").value;if(e==="custom")return;const s=a.getProject().globalSettings.summarizationPromptPresets;if(s&&s[e]){const o=s[e];document.getElementById("system-utility-summary-prompt").value=o,a.bus.publish("settings:systemAgentChanged")}}function Gn(){const t=document.getElementById("system-utility-summary-prompt").value.trim();if(!t){f("Prompt template cannot be empty.","Error");return}const e=prompt("Enter a name for this new preset:","");if(!e||!e.trim())return;const n=a.getProject(),s=e.trim();n.globalSettings.summarizationPromptPresets[s]&&!confirm(`A preset named '${s}' already exists. Do you want to overwrite it?`)||(n.globalSettings.summarizationPromptPresets[s]=t,a.setProject(n),a.updateAndPersistState().then(()=>{a.bus.publish("ui:renderSummarizationSelector"),document.getElementById("system-utility-summary-preset-select").value=s,f(`Preset '${s}' saved successfully!`,"Success")}))}function zn(){const t=a.bus;t.subscribe("project:new",K),t.subscribe("project:open",sn),t.subscribe("project:fileSelectedForOpen",an),t.subscribe("project:save",e=>Oe(e)),t.subscribe("project:saveConfirm",({projectName:e})=>Ue(e)),t.subscribe("project:unsavedChangesChoice",cn),t.subscribe("session:new",De),t.subscribe("session:loaded",({session:e})=>{oe(e.name),D(),J(),j(),a.bus.publish("entity:selected",e.linkedEntity)}),t.subscribe("session:cleared",()=>{At(),_t(),j()}),t.subscribe("session:autoRename",en),t.subscribe("session:clone",({sessionId:e,event:n})=>Kt(e,n)),t.subscribe("session:archive",({sessionId:e,event:n})=>Vt(e,n)),t.subscribe("session:pin",({sessionId:e,event:n})=>Yt(e,n)),t.subscribe("session:delete",({sessionId:e,event:n})=>Jt(e,n)),t.subscribe("session:download",({sessionId:e})=>Xt({sessionId:e})),t.subscribe("agent:create",()=>de(!1)),t.subscribe("agent:save",Dn),t.subscribe("agent:edit",({agentName:e})=>de(!0,e)),t.subscribe("agent:delete",({agentName:e})=>$n(e)),t.subscribe("agent:generateProfile",Nn),t.subscribe("group:create",()=>me(!1)),t.subscribe("group:save",On),t.subscribe("group:edit",({groupName:e})=>me(!0,e)),t.subscribe("group:delete",({groupName:e})=>Un({groupName:e})),t.subscribe("memory:create",()=>ye(null)),t.subscribe("memory:save",Hn),t.subscribe("memory:edit",({index:e})=>ye(e)),t.subscribe("memory:delete",({index:e})=>Fn({index:e})),t.subscribe("memory:toggle",({name:e})=>qn({name:e})),t.subscribe("studio:itemClicked",vn),t.subscribe("summary:view",({logId:e})=>Re(e)),t.subscribe("summary:load",({logId:e})=>ft(e)),t.subscribe("summary:delete",({logId:e})=>bt(e)),t.subscribe("entity:select",({type:e,name:n})=>bn(e,n)),t.subscribe("chat:sendMessage",ke),t.subscribe("chat:stopGeneration",te),t.subscribe("chat:editMessage",({index:e})=>St({index:e})),t.subscribe("chat:deleteMessage",({index:e})=>wt({index:e})),t.subscribe("chat:copyMessage",({index:e,event:n})=>vt({index:e,event:n})),t.subscribe("chat:regenerateMessage",({index:e})=>Et({index:e})),t.subscribe("chat:fileUpload",e=>pt(e)),t.subscribe("chat:removeFile",({index:e})=>mt({index:e})),t.subscribe("open-composer",()=>{a.bus.publish("ui:toggleComposer")}),t.subscribe("composer:heightChanged",Qt),t.subscribe("chat:summarize",yt),t.subscribe("chat:clearSummary",ht),t.subscribe("upload-file",()=>{document.getElementById("file-input")?.click()}),t.subscribe("api:loadModels",Ee),t.subscribe("settings:apiKeyChanged",fn),t.subscribe("settings:ollamaUrlChanged",void 0),t.subscribe("settings:fontChanged",yn),t.subscribe("settings:systemAgentChanged",hn),t.subscribe("settings:summaryPresetChanged",Rn),t.subscribe("settings:saveSummaryPreset",Gn),console.log("âœ… Central Event Bus ready.")}function _n(){const t=document.getElementById("theme-switcher");if(!t)return;const e=t.querySelectorAll('input[type="radio"]'),n=localStorage.getItem("theme")||"system",s=document.getElementById("hljs-light-theme"),o=document.getElementById("hljs-dark-theme"),i=r=>{document.body.classList.remove("dark-mode","light-mode");let c=r==="dark";r==="system"&&(c=window.matchMedia("(prefers-color-scheme: dark)").matches),document.body.classList.add(c?"dark-mode":"light-mode"),s&&(s.disabled=c),o&&(o.disabled=!c)};e.forEach(r=>{r.value===n&&(r.checked=!0),r.addEventListener("change",c=>{const l=c.target.value;localStorage.setItem("theme",l),i(l)})}),i(n),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{(localStorage.getItem("theme")||"system")==="system"&&i("system")})}function Wn(){_n(),st(),at(),Je(),Nt(),et(),qt(),Ht(),Tt(),Sn(),Wt(),Tn(),Pn(),In(),Mn(),Bn(),dt(),console.log("âœ… All UI modules initialized.")}document.addEventListener("DOMContentLoaded",async()=>{const t=document.getElementById("loading-overlay");try{console.log("ðŸš€ Application starting..."),Wn(),zn(),nn();const e=localStorage.getItem("lastActiveProjectId");if(e){console.log(`Attempting to load last project with ID: ${e}`);try{await un(e)}catch(n){console.error(`[RECOVERY] Failed to load last project (ID: ${e}). This is likely due to corrupted data.`,n),alert("Could not load your last project due to an error. A new project will be created."),localStorage.removeItem("lastActiveProjectId"),console.log("[RECOVERY] Creating a new project as a fallback."),await K()}}else await K();t?.classList.remove("active"),console.log("ðŸŽ‰ Application initialized successfully.")}catch(e){console.error("[FATAL STARTUP ERROR]",e),t.querySelector("p").textContent=`A critical error occurred: ${e.message}`}});
